<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>DongWei&#39;s Blog</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.wei-dong.top/"/>
  <updated>2019-11-24T10:08:27.722Z</updated>
  <id>http://www.wei-dong.top/</id>
  
  <author>
    <name>Mr-Vincent</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>æµ®ç”Ÿä¸€è®°</title>
    <link href="http://www.wei-dong.top/2019/11/14/%E6%B5%AE%E7%94%9F%E4%B8%80%E8%AE%B0/"/>
    <id>http://www.wei-dong.top/2019/11/14/æµ®ç”Ÿä¸€è®°/</id>
    <published>2019-11-14T08:33:18.000Z</published>
    <updated>2019-11-24T10:08:27.722Z</updated>
    
    <content type="html"><![CDATA[<p>æœ‰äº›æ—¥å­æ²¡æœ‰æ›´æ–°äº†ã€‚æœ€è¿‘è¿™æ®µæ—¥å­ä¹Ÿä¸ç®—å¤ªå¿™ï¼Œå› ä¸ºåŒ11çš„è¿ç»­ä¸Šç­ä¸¤å‘¨ï¼Œæ€»æ˜¯è§‰å¾—ä¼¼ä¹æ²¡æœ‰ä¼‘æ¯å¥½ã€‚</p>
<p>è™½è¯´ä¸å¿™ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸å¼€å¿ƒçš„äº‹æƒ…ã€‚æ•´ä¸ªè¡Œä¸šçš„ä¸æ™¯æ°”ï¼Œè®¸å¤šå…¬å¸åœ¨ä¼˜åŒ–ï¼Œæˆ‘ä»¬å…¬å¸ä¹Ÿä¸ä¾‹å¤–ã€‚å‰æ®µæ—¶é—´é¢†å¯¼çªç„¶è¯·åƒé¥­ï¼Œæˆ‘å°±çŸ¥é“äº‹æƒ…æ²¡é‚£ä¹ˆç®€å•ã€‚æœä¸å…¶ç„¶åœ¨é¥­æ¡Œä¸Šå…¬å¸ƒä¼˜åŒ–äººå‘˜çš„æ¶ˆæ¯ï¼Œæ°”æ°›å˜å¾—å‡é‡èµ·æ¥ã€‚ä½†æ˜¯æ—©è¯´è¦æ¯”æ™šè¯´è¦å¥½ï¼Œæ¯•ç«Ÿç•™ä¸‹äº†æ›´å¤šçš„å¿ƒç†ç¼“å†²æ—¶é—´ã€‚é¥­æ¡Œä¸Šæ¯”æˆ‘å‡ å²çš„é¢†å¯¼æ²¡æ§åˆ¶ä½æƒ…ç»ªï¼Œå¤±å£°å“­äº†èµ·æ¥ã€‚æ¢ä¸ºæ€è€ƒä¸€ä¸‹ï¼Œä¹Ÿèƒ½ç†è§£ä»–è¿™ç§æƒ…ç»ªã€‚å½“æ—¶å›¢é˜Ÿä»4-5ä¸ªäººæ‰©å¤§åˆ°11ä¸ªäººï¼Œè¿™ä¸€è·¯èµ°æ¥è¿˜æ˜¯ä¸å®¹æ˜“çš„ï¼Œç°åœ¨ä¸Šå±‚è¯´ä¼˜åŒ–å°±ä¼˜åŒ–ï¼Œä½œä¸ºé¢†å¯¼å´æ²¡åŠæ³•äº‰å–ç‚¹ä»€ä¹ˆã€‚å¯¹æˆ‘è€Œè¨€ä¹Ÿæ˜¯æœ‰ç‚¹éš¾è¿‡çš„ï¼Œå› ä¸ºæˆ‘çš„é‚£ä¸ªå°teamä¹Ÿæ˜¯å¾ˆä¸é”™çš„ï¼Œè¦èµ°ä¸€åŠä¹Ÿæ˜¯å¾ˆä¸èˆå¾—çš„ã€‚</p>
<p>åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬çš„å›¢å»ºç»è´¹éƒ½ä¸‹å‘åˆ°ä¸¤ä¸ªå°teamã€‚æˆ‘æ‰€åœ¨çš„å°teamæ²¡æœ‰å¥½çš„æƒ³æ³•ï¼Œå°±ç›´æ¥äº¤ç»™è¡¨å“¥ä»–ä»¬é‚£è¾¹äº†ã€‚ä»–ä»¬å†³å®šä¸€èµ·å»è‡ªé©¾æ¸¸ã€‚éšç€åŒ11è¿ç»­çš„ä¸¤å‘¨ä¸Šç­ç»“æŸï¼Œæˆ‘ä»¬å¦‚æœŸè¿›è¡Œäº†æˆ‘ä»¬çš„å°tripã€‚</p>
<p>è¿™æ¬¡çš„ç›®çš„åœ°æ˜¯å¤§é¹ï¼Œç¦»å¸‚åŒºå·®ä¸å¤šè¿‘100å…¬é‡Œã€‚ä¸€ä½åŒäº‹è‡ªå·±æœ‰è½¦ï¼Œæ­¤å¤–æˆ‘ä»¬è¿˜ç§Ÿäº†ä¸€è¾†è½¦ã€‚åœ¨ä¸€ä¸ªé˜³å…‰æ˜åªšçš„æ—©æ™¨æˆ‘ä»¬å‡ºå‘äº†ã€‚<br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0389.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0362.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0404.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0410.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0376.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0411.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0377.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0363.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0405.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0388.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0375.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0407.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0361.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0406.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0360.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0374.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0412.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0358.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0370.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0364.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0402.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0365.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0403.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0417.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0371.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0359.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0398.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0401.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0367.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0373.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0372.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0414.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0366.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0399.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0380.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0394.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0425.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0357.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0419.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0418.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0356.jpg?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0424.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0395.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0381.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0397.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0383.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0368.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0369.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0382.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0396.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0392.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0379.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0422.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0378.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0393.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0385.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0391.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0408.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0409.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0390.JPG?raw=true" alt="image"><br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/go-around/IMG_0384.JPG?raw=true" alt="image"></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ‰äº›æ—¥å­æ²¡æœ‰æ›´æ–°äº†ã€‚æœ€è¿‘è¿™æ®µæ—¥å­ä¹Ÿä¸ç®—å¤ªå¿™ï¼Œå› ä¸ºåŒ11çš„è¿ç»­ä¸Šç­ä¸¤å‘¨ï¼Œæ€»æ˜¯è§‰å¾—ä¼¼ä¹æ²¡æœ‰ä¼‘æ¯å¥½ã€‚&lt;/p&gt;
&lt;p&gt;è™½è¯´ä¸å¿™ï¼Œä½†æ˜¯ä¹Ÿæœ‰ä¸å¼€å¿ƒçš„äº‹æƒ…ã€‚æ•´ä¸ªè¡Œä¸šçš„ä¸æ™¯æ°”ï¼Œè®¸å¤šå…¬å¸åœ¨ä¼˜åŒ–ï¼Œæˆ‘ä»¬å…¬å¸ä¹Ÿä¸ä¾‹å¤–ã€‚å‰æ®µæ—¶é—´é¢†å¯¼çªç„¶è¯·åƒé¥­ï¼Œæˆ‘å°±çŸ¥é“äº‹æƒ…æ²¡é‚£ä¹ˆç®€å•ã€‚æœä¸å…¶ç„¶åœ¨é¥­æ¡Œä¸Šå…¬å¸ƒä¼˜åŒ–äººå‘˜çš„æ¶ˆ
    
    </summary>
    
      <category term="ç©" scheme="http://www.wei-dong.top/categories/%E7%8E%A9/"/>
    
    
      <category term="ç”Ÿæ´»" scheme="http://www.wei-dong.top/tags/%E7%94%9F%E6%B4%BB/"/>
    
  </entry>
  
  <entry>
    <title>ä¸ºä»€ä¹ˆè¦å†™ä½œ</title>
    <link href="http://www.wei-dong.top/2019/04/20/why_writting/"/>
    <id>http://www.wei-dong.top/2019/04/20/why_writting/</id>
    <published>2019-04-20T08:14:23.000Z</published>
    <updated>2019-04-20T08:47:04.358Z</updated>
    
    <content type="html"><![CDATA[<p>æœ‰ä¸€å¤©ï¼Œå¤©ä¸€åŒå­¦çªç„¶é—®æˆ‘ä¸€ä¸ªé—®é¢˜ï¼šä½ çš„åšå®¢æ˜¯ä¸æ‰“ç®—æ›´æ–°äº†ä¹ˆï¼Ÿä¸€æ—¶é—´æˆ‘ä¸çŸ¥é“æ€ä¹ˆå›ç­”ï¼Œå› ä¸ºæˆ‘ä¹Ÿä¸ç¡®å®šå›ç­”æ˜¯æˆ–è€…å¦ã€‚</p>
<p>ç„¶åæ¥ä¸‹æ¥å¥½å‡ å¤©éƒ½åœ¨æƒ³è¿™ä¸ªé—®é¢˜ã€‚å³ä½¿å¤©ä¸€åŒå­¦ä¸æåˆ°ï¼Œæˆ‘ä¹Ÿæ„è¯†åˆ°å¾ˆä¹…æ²¡æœ‰æ›´æ–°æ–‡ç« äº†ã€‚ç„¶åå›æƒ³ä¸€ä¸‹ï¼Œè‡ªä»æ¢äº†å·¥ä½œåˆ°äº‘é›†å·¥ä½œåå°±å†ä¹Ÿæ²¡æœ‰æ›´æ–°åšå®¢äº†ã€‚å°±è¿githubä¹Ÿæ²¡æ€ä¹ˆæ›´æ–°è¿‡ã€‚åŸå…ˆä¹°çš„3å¹´æœŸçš„åŸŸåï¼Œæœ¬æ‰“ç®—åœ¨è¿™æ®µæ—¶é—´ç»™è‡ªå·±ç•™ä¸‹ç‚¹ä»€ä¹ˆï¼Œä»”ç»†ç¿»äº†ç¿»ä»¥å¾€å†™çš„ä¸œè¥¿ï¼Œå¯èƒ½çœŸçš„è¦åŠé€”è€ŒåºŸäº†ã€‚</p>
<p>æ‹¿åŠé€”è€ŒåºŸæ¥å½¢å®¹æ˜¯ä¸å‡†ç¡®çš„ï¼Œæ¯•ç«Ÿè¿™ä¸ªåŸŸåè¿˜æ²¡åˆ°æœŸï¼Œä»…ä»…åºŸäº†ä¸€åŠã€‚é‚£å°±å¥½å¥½åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆæ²¡æƒ³åˆ°å»å†™æ–‡ç« äº†ï¼Œæ€»ç»“ä¸€ä¸ªå­—â€“æ‡’ï¼ç°åœ¨å·¥ä½œè¿˜æ˜¯æœ‰å‹åŠ›çš„ï¼Œä¸šä½™æ—¶é—´éƒ½æ”¾æ¾ç©å»äº†ï¼Œå‹æ ¹æ²¡æƒ³åˆ°è¦å†™ç‚¹ä»€ä¹ˆè®°å½•ä¸€ä¸‹ã€‚å…¶æ¬¡å°±æ˜¯å¯¹æŠ€æœ¯çš„çƒ­çˆ±æ²¡æœ‰é‚£ä¹ˆå¼ºçƒˆäº†ã€‚ä»¥å‰çœ‹åˆ°ä¸€äº›æ¯”è¾ƒå‰å®³çš„æºç æ€»æ˜¯æœ‰é‚£ä¹ˆä¸€ç‚¹å°æ¿€åŠ¨å’Œå…´å¥‹ï¼Œæ€»æƒ³ç€å»å­¦ä¹ ä¸€ä¸‹è®°å½•è¿™ä¸ªè¿‡ç¨‹ã€‚è€Œç°åœ¨è¿™ç§æƒ³æ³•ä¸æ˜¯é‚£ä¹ˆå¼ºçƒˆï¼Œæƒ³ç€åˆ°æ—¶å€™éœ€è¦çš„æ—¶å€™å†æ¥ç ”ç©¶ã€‚é‚£å°±ä¸å¾—ä¸è¯´ï¼Œç°åœ¨å¯¹ä»€ä¹ˆå…´è¶£æ¯”è¾ƒå¼ºçƒˆã€‚ç°åœ¨å¯¹ç»˜ç”»ã€ä¹¦æ³•ä¹‹ç±»çš„æ¯”è¾ƒæ„Ÿå…´è¶£ã€‚ç©ºé—²æ—¶é—´éƒ½ä¼šå»bç«™çœ‹çœ‹ï¼Œæ€»æƒ³ç€æœ‰ä¸€å¤©æˆ‘ä¹Ÿä¼šè¿™äº›ä¸œè¥¿ï¼Œè€Œä¸ä»…ä»…åªä¼šå†™ä»£ç ã€‚æˆ‘æƒ³è¿™ç§æƒ³æ³•ä¸ä»…ä»…æˆ‘ä¸€ä¸ªäººæœ‰è¿‡ï¼Œå¾ˆå¤šäººéƒ½æƒ³è¿‡ã€‚åŒæ—¶ä¹Ÿä¼šå…³æ³¨ä¸€ä¸‹é‚£äº›æŠ€æœ¯åšä¸»çš„å…³äºç¼–ç ä¹‹å¤–çš„æ–‡ç« ï¼Œæ¯”æ–¹è¯´ç”Ÿæ´»çäº‹ä¹‹ç±»çš„ã€‚å¤§æ¦‚æ˜¯å› ä¸ºè‡ªå·±ä»äº‹è¿™ä¸ªè¡Œä¸šæ—¶é—´ä¹…äº†ï¼Œå†…å¿ƒä¸–ç•Œååˆ†è´«ç˜ ï¼Œæ€»æ˜¯ä¸€äº›æ¯ç‡¥çš„ä»£ç ã€‚é•¿ä¹…ä»¥æ¥ï¼Œæˆ‘è§‰å¾—æŠ€æœ¯ä¹‹ä¸­ä¹Ÿå­˜åœ¨ç€æŸç§è‰ºæœ¯ä»¥åŠè®¾è®¡å“²å­¦ï¼Œå› æ­¤æ›´åŠ æƒ³å»æ‰¾åˆ°è¿™ä¸¤è€…ä¹‹é—´çš„è”ç³»ã€‚</p>
<p>é™¤äº†æ‡’ï¼Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„åŸå› ã€‚è§‰å¾—è‡ªå·±çš„è¯­è¨€ç»„ç»‡èƒ½åŠ›ä¸è¶³ï¼Œä¸è¶³ä»¥å°†ä¸€ä»¶äº‹æƒ…è¡¨è¾¾æ¸…æ¥šï¼Œæˆ–è€…æ–‡ç¬”ä¸å¤Ÿå¥½ï¼Œæ‹…å¿ƒå†™å‡ºæ¥çš„ä¸œè¥¿å¤ªlowï¼Œå…¥ä¸äº†çœ¼ã€‚å› æ­¤å°±æ›´ä¸æ„¿æ„å†™ï¼Œå¦‚æ­¤å¾€å¤æ¶æ€§å¾ªç¯ã€‚ä½†æ˜¯è¿™ä¸ªç†ç”±æ˜¯ç«™ä¸ä½è„šçš„ã€‚è‡ªå·±å†™çš„æ–‡ç« ä»…ä»…æ˜¯ç”¨æ¥å–æ‚¦è‡ªå·±è€Œä¸æ˜¯å–æ‚¦ä»–äººï¼Œå¹²å˜›æœ‰è¿™ä¹ˆå¤šå¿ƒç†è´Ÿæ‹…ï¼Œåˆä¸æ˜¯ä¸Šå­¦é‚£ä¼šè®©å†™ä¸ªä½œæ–‡è¿˜å¾—æ‰“åˆ†ã€‚å› æ­¤è¿˜æ˜¯ä¸€ä¸ªå­—æ‡’å¯¼è‡´çš„ã€‚</p>
<p>è¿˜å‘ç°ä¸€ä¸ªç°è±¡ï¼Œéšç€å¹´é¾„çš„å¢åŠ ï¼Œè¶Šæ¥è¶Šå¤šçš„äººéƒ½ä¸æ„¿æ„åœ¨ç¤¾äº¤ç½‘ç»œä¸Šè¡¨è¾¾è‡ªå·±äº†ã€‚æˆ‘æ›¾è®°å¾—ä»¥å‰æ€»æ˜¯åœ¨å¾®åšç›†å‹åœˆä¸Šå‘è¡¨ä¸€äº›æƒ³æ³•æ„Ÿå—ï¼Œè€Œç°åœ¨å´å¾ˆå°‘äº†ã€‚è¯´ä¸æ¸…ä¸ºä»€ä¹ˆï¼Œå¤§è‡´è§‰å¾—ç”Ÿæ´»æ— éå°±æ˜¯è¿™æ ·ï¼Œç¨€ç–å¹³å¸¸çš„äº‹æƒ…ä¹Ÿæ²¡å¿…è¦å»æŠ±æ€¨æˆ–è€…å»â€œæ™’â€å§ã€‚æˆ–è€…æ˜¯è¯´æˆå¹´äººçš„ä¸–ç•Œæ¯”è¾ƒå¤æ‚ï¼Ÿ</p>
<p>é€šç¯‡ä¸‹æ¥ï¼Œéƒ½æ˜¯åœ¨è®²æˆ‘ä¸ºä»€ä¹ˆæ²¡ç»§ç»­å†™ä½œäº†ï¼Œä½†ä¸æ¯«æ²¡è¯´ä¸ºä»€ä¹ˆè¦å†™ä½œã€‚</p>
<p>ä¸ºäº†ç•™ä¸‹ç‚¹ä»€ä¹ˆï¼Œä¸ºäº†ä¸è¢«å¿˜è®°ï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ‰ä¸€å¤©ï¼Œå¤©ä¸€åŒå­¦çªç„¶é—®æˆ‘ä¸€ä¸ªé—®é¢˜ï¼šä½ çš„åšå®¢æ˜¯ä¸æ‰“ç®—æ›´æ–°äº†ä¹ˆï¼Ÿä¸€æ—¶é—´æˆ‘ä¸çŸ¥é“æ€ä¹ˆå›ç­”ï¼Œå› ä¸ºæˆ‘ä¹Ÿä¸ç¡®å®šå›ç­”æ˜¯æˆ–è€…å¦ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶åæ¥ä¸‹æ¥å¥½å‡ å¤©éƒ½åœ¨æƒ³è¿™ä¸ªé—®é¢˜ã€‚å³ä½¿å¤©ä¸€åŒå­¦ä¸æåˆ°ï¼Œæˆ‘ä¹Ÿæ„è¯†åˆ°å¾ˆä¹…æ²¡æœ‰æ›´æ–°æ–‡ç« äº†ã€‚ç„¶åå›æƒ³ä¸€ä¸‹ï¼Œè‡ªä»æ¢äº†å·¥ä½œåˆ°äº‘é›†å·¥ä½œåå°±å†ä¹Ÿæ²¡æœ‰æ›´æ–°åšå®¢äº†ã€‚å°±è¿
    
    </summary>
    
      <category term="å†™ä½œ" scheme="http://www.wei-dong.top/categories/%E5%86%99%E4%BD%9C/"/>
    
    
      <category term="ç¼–ç ä¹‹å¤–" scheme="http://www.wei-dong.top/tags/%E7%BC%96%E7%A0%81%E4%B9%8B%E5%A4%96/"/>
    
  </entry>
  
  <entry>
    <title>Nettyä¸­çš„çº¿ç¨‹æ¨¡å‹ä¹‹OIO</title>
    <link href="http://www.wei-dong.top/2018/09/12/Netty%E4%B8%AD%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%9E%8B%E4%B9%8BOIO/"/>
    <id>http://www.wei-dong.top/2018/09/12/Nettyä¸­çš„çº¿ç¨‹æ¨¡å‹ä¹‹OIO/</id>
    <published>2018-09-12T09:17:23.000Z</published>
    <updated>2018-09-12T09:07:20.764Z</updated>
    
    <content type="html"><![CDATA[<p>å’Œé«˜æ€§èƒ½NIOç›¸æ¯”ï¼Œä¸ªäººè®¤ä¸ºOIOçš„å®ç°ç›¸å¯¹è¦ç®€å•ä¸€ç‚¹ï¼Œé€‰æ‹©è¿™ä¸ªéš¾åº¦ç¨å¾®ä½ä¸€ç‚¹çš„å®ç°æ¥è‚¯å¯¹ç›®å‰çš„èœé¸¡æˆ‘è€Œè¨€æ›´ç°å®ã€‚</p>
<p>æœ¬è´¨ä¸Šè€Œè¨€ï¼Œeventloopgroupå°±æ˜¯çº¿ç¨‹æ± ã€‚</p>
<p><img src="http://7xsfwn.com1.z0.glb.clouddn.com/OioEventLoopGroup.png" alt="image"></p>
<p>Nettyé’ˆå¯¹JDKçš„å®ç°åšäº†è¿›ä¸€æ­¥çš„åŠ å¼ºã€‚</p>
<p>å¯¹äºOIOçš„ç¬¬ä¸€ååº”æ˜¯ã€Œé˜»å¡ã€ï¼Œã€Œæ€§èƒ½å·®ã€ï¼Œã€Œè€—èµ„æºã€ã€‚äº‹å®ä¸Šç¡®å®å¦‚æ­¤ï¼Œä½†ä¸ºä»€ä¹ˆè¿˜è¦å†™ä¸€ç¯‡æ–‡ç« ï¼ˆç¬”è®°ï¼‰æ¥å¯¹å®ƒè¿›è¡Œæè¿°å‘¢ï¼Ÿåœ¨ä¹‹å‰ï¼Œæˆ‘ä»¥ä¸ºNettyå¹¶æ²¡æœ‰æä¾›OIOçš„å®ç°ï¼Œå¤©çœŸçš„è®¤ä¸ºNettyä»…ä»…æ˜¯å¯¹NIOè¿›è¡Œäº†å°è£…ã€‚ç›´åˆ°æŸä¸€å¤©ä½¿ç”¨åˆ°äº†OIOï¼Œæƒ³å°†OIOçš„çº¿ç¨‹æ¨¡å‹å’ŒNettyä¸­çš„å®ç°ç±»ä¼¼ï¼šä¸€ä¸ªçº¿ç¨‹è´Ÿè´£è¿æ¥ï¼Œåˆ«çš„çº¿ç¨‹è´Ÿè´£IOã€‚æƒ³äº†è®¸ä¹…æ²¡æœ‰ä¸‹æ–‡ï¼Œæœºç¼˜å·§åˆçœ‹åˆ°äº†Nettyçš„æ–‡æ¡£ï¼Œå…¶ä¸­æœ‰å¯¹OIOçš„å°è£…ï¼Œæ°å¥½å’Œæˆ‘å¿ƒä¸­æƒ³çš„ä¸€æ¨¡ä¸€æ ·ï¼Œè€Œä¸”å¯¹å¤–æä¾›çš„APIä¸å˜ã€‚è¿™ç§æŠ½è±¡è®¾è®¡è®©æˆ‘æƒ³æ·±å…¥å…¶ä¸­ï¼Œçœ‹çœ‹åˆ°åº•æ˜¯å¦‚ä½•åšåˆ°çš„ã€‚æˆ‘æƒ³å€Ÿé‰´å…¶ä¸­çš„è®¾è®¡æ¥å®ç°ä¸€ä¸ªæ¯”è¾ƒç®€å•å¯¹OIOçš„å°è£…ã€‚</p>
<blockquote>
<p>EventLoopGroup which is used to handle OIO Channelâ€™s. Each Channel will be handled by its own EventLoop to not block others.</p>
</blockquote>
<p>æ–‡æ¡£ä¸­çš„è§£é‡Šå¾ˆç®€å•ï¼ŒEventLoopGroupç”¨æ¥å¤„ç†è¿æ¥ï¼Œæ¯ä¸ªè¿æ¥ç”±å®ƒè‡ªå·±çš„EventLoopå¤„ç†ã€‚</p>
<p>è¿™æ®µè§£é‡Šä¸ç¦è”æƒ³åˆ°äº†é’ˆå¯¹OIOçš„ç¼–ç¨‹ï¼šæ¯ä¸ªè¿æ¥ç”±æ–°å¼€çš„çº¿ç¨‹å¤„ç†ï¼Œæœ‰å¤šå°‘ä¸ªè¿æ¥å°±æœ‰å¤šå°‘ä¸ªçº¿ç¨‹ã€‚è¿™é‡Œçš„Channelå°±æ˜¯è¿æ¥çš„æŠ½è±¡ï¼ŒEventLoopå¯ä»¥ç†è§£ä¸ºçº¿ç¨‹ã€‚</p>
<h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">OioEventLoopGroup</span><span class="params">(<span class="keyword">int</span> maxChannels, ThreadFactory threadFactory)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(maxChannels, threadFactory);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">ThreadPerChannelEventLoopGroup</span><span class="params">(<span class="keyword">int</span> maxChannels, ThreadFactory threadFactory, Object... args)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(maxChannels, <span class="keyword">new</span> ThreadPerTaskExecutor(threadFactory), args);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPerTaskExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadFactory threadFactory;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadPerTaskExecutor</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (threadFactory == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"threadFactory"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.threadFactory = threadFactory;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</div><div class="line">        threadFactory.newThread(command).start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ„é€ å™¨ä¸­ä¸¤ä¸ªå‚æ•°ï¼ŒmaxChannelsä¸ºæœ€å¤§è¿æ¥æ•°ã€‚æ³¨æ„ï¼Œè¿™ä¸ªæ˜¯æ¯”è¾ƒè®²ç©¶çš„ï¼Œåœ¨Nettyçº¿ç¨‹æ¨¡å‹ä¸­æœ‰bosså’Œworkerçº¿ç¨‹ä¹‹åˆ†ã€‚å¦‚æœåªæŒ‡å®šä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯bosså°±æ˜¯workeré‚£ä¹ˆè¿™ä¸ªå€¼å¦‚æœä¸º1é‚£ä¹ˆä»»ä½•å®¢æˆ·ç«¯æ— æ³•è¿è¿›æ¥ï¼Œå¦‚æœä¸º2åˆ™åªå…è®¸1ä¸ªå®¢æˆ·ç«¯è¿è¿›æ¥ï¼Œä¾æ¬¡ç±»æ¨ã€‚é»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…è®¸æ— é™å¤šå®¢æˆ·ç«¯æ¥å…¥ï¼ˆç†è®ºä¸Šï¼‰ã€‚å½“æœ‰workerçš„æ—¶å€™ï¼Œbossçš„maxChannelsæŒ‡å®šå¤šå°‘æ— æ‰€è°“ï¼Œworkerä¸­çš„maxChannelså€¼ä¸ºå¤šå°‘å°±æ„å‘³ç€å…è®¸å¤šå°‘å®¢æˆ·ç«¯æ¥å…¥ï¼ŒåŒç†0ä»£è¡¨æ— é™å¤šã€‚ç¬¬äºŒä¸ªå‚æ•°ä¸ºçº¿ç¨‹å·¥å‚ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯JDKçš„é»˜è®¤å®ç°ï¼šExecutors.defaultThreadFactory()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">ThreadPerChannelEventLoopGroup</span><span class="params">(<span class="keyword">int</span> maxChannels, Executor executor, Object... args)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (maxChannels &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</div><div class="line">                <span class="string">"maxChannels: %d (expected: &gt;= 0)"</span>, maxChannels));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (executor == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"executor"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (args == <span class="keyword">null</span>) &#123;</div><div class="line">        childArgs = EmptyArrays.EMPTY_OBJECTS;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        childArgs = args.clone();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.maxChannels = maxChannels;</div><div class="line">    <span class="keyword">this</span>.executor = executor;</div><div class="line"></div><div class="line">    tooManyChannels = ThrowableUtil.unknownStackTrace(</div><div class="line">            <span class="keyword">new</span> ChannelException(<span class="string">"too many channels (max: "</span> + maxChannels + <span class="string">')'</span>),</div><div class="line">            ThreadPerChannelEventLoopGroup.class, <span class="string">"nextChild()"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„ä¸€äº›æˆå‘˜å˜é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPerChannelEventLoopGroup</span> <span class="keyword">extends</span> <span class="title">AbstractEventExecutorGroup</span> <span class="keyword">implements</span> <span class="title">EventLoopGroup</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] childArgs;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxChannels;</div><div class="line">    <span class="comment">// ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line">    <span class="keyword">final</span> Executor executor;</div><div class="line">    <span class="comment">// æ´»è·ƒçš„çº¿ç¨‹é›†åˆ</span></div><div class="line">    <span class="keyword">final</span> Set&lt;EventLoop&gt; activeChildren =</div><div class="line">            Collections.newSetFromMap(PlatformDependent.&lt;EventLoop, Boolean&gt;newConcurrentHashMap());</div><div class="line">    <span class="comment">// ç©ºé—²çš„çº¿ç¨‹é›†åˆ</span></div><div class="line">    <span class="keyword">final</span> Queue&lt;EventLoop&gt; idleChildren = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;EventLoop&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelException tooManyChannels;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> shuttingDown;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Promise&lt;?&gt; terminationFuture = <span class="keyword">new</span> DefaultPromise&lt;Void&gt;(GlobalEventExecutor.INSTANCE);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FutureListener&lt;Object&gt; childTerminationListener = <span class="keyword">new</span> FutureListener&lt;Object&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(Future&lt;Object&gt; future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            <span class="comment">// Inefficient, but works.</span></div><div class="line">            <span class="keyword">if</span> (isTerminated()) &#123;</div><div class="line">                terminationFuture.trySuccess(<span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>EventLoopGroupçš„åˆå§‹åŒ–å°±è¿™æ ·ç»“æŸäº†ã€‚ä½†æ˜¯è¦æ¢ç´¢å…¶ä¸­çš„å·¥ä½œæœºåˆ¶è¿˜å¾—ä»ä¸€ä¸ªServer çš„å¯åŠ¨å¼€å§‹ã€‚</p>
<h3 id="ServerBootstrapçš„å¯åŠ¨"><a href="#ServerBootstrapçš„å¯åŠ¨" class="headerlink" title="ServerBootstrapçš„å¯åŠ¨"></a>ServerBootstrapçš„å¯åŠ¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">        ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap(); <span class="comment">// (2)</span></div><div class="line">        b.group(bossGroup, workerGroup)</div><div class="line">         .channel(OioServerSocketChannel.class) <span class="comment">// (3)</span></div><div class="line">         .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123; <span class="comment">// (4)</span></div><div class="line">             <span class="meta">@Override</span></div><div class="line">             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                 ch.pipeline().addLast(<span class="keyword">new</span> DiscardServerHandler());</div><div class="line">             &#125;</div><div class="line">         &#125;)</div><div class="line">         .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)          <span class="comment">// (5)</span></div><div class="line">         .childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>); <span class="comment">// (6)</span></div><div class="line">    </div><div class="line">        <span class="comment">// Bind and start to accept incoming connections.</span></div><div class="line">        ChannelFuture f = b.bind(port).sync(); <span class="comment">// (7)</span></div><div class="line">    </div><div class="line">        <span class="comment">// Wait until the server socket is closed.</span></div><div class="line">        <span class="comment">// In this example, this does not happen, but you can do that to gracefully</span></div><div class="line">        <span class="comment">// shut down your server.</span></div><div class="line">        f.channel().closeFuture().sync();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        workerGroup.shutdownGracefully();</div><div class="line">        bossGroup.shutdownGracefully();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æœ€æ ¸å¿ƒçš„æ˜¯bindæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress)</span> </span>&#123;</div><div class="line">    validate();</div><div class="line">    <span class="keyword">if</span> (localAddress == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"localAddress"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> doBind(localAddress);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> ChannelFuture <span class="title">doBind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress)</span> </span>&#123;</div><div class="line">	 <span class="comment">// æ ¸å¿ƒæ˜¯regFutureçš„è·å–ï¼Œæœ‰äº†è¿™ä¸ªåé¢ä¸€åˆ‡éƒ½å¥½è¯´</span></div><div class="line">    <span class="keyword">final</span> ChannelFuture regFuture = initAndRegister();</div><div class="line">    <span class="keyword">final</span> Channel channel = regFuture.channel();</div><div class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> regFuture;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (regFuture.isDone()) &#123;</div><div class="line">        <span class="comment">// At this point we know that the registration was complete and successful.</span></div><div class="line">        ChannelPromise promise = channel.newPromise();</div><div class="line">        doBind0(regFuture, channel, localAddress, promise);</div><div class="line">        <span class="keyword">return</span> promise;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Registration future is almost always fulfilled already, but just in case it's not.</span></div><div class="line">        <span class="keyword">final</span> PendingRegistrationPromise promise = <span class="keyword">new</span> PendingRegistrationPromise(channel);</div><div class="line">        regFuture.addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                Throwable cause = future.cause();</div><div class="line">                <span class="keyword">if</span> (cause != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// Registration on the EventLoop failed so fail the ChannelPromise directly to not cause an</span></div><div class="line">                    <span class="comment">// IllegalStateException once we try to access the EventLoop of the Channel.</span></div><div class="line">                    promise.setFailure(cause);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// Registration was successful, so set the correct executor to use.</span></div><div class="line">                    <span class="comment">// See https://github.com/netty/netty/issues/2586</span></div><div class="line">                    promise.registered();</div><div class="line"></div><div class="line">                    doBind0(regFuture, channel, localAddress, promise);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> promise;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">final</span> ChannelFuture <span class="title">initAndRegister</span><span class="params">()</span> </span>&#123;</div><div class="line">    Channel channel = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">    	 <span class="comment">// å®ä¾‹åŒ–OioServerSocketChannel</span></div><div class="line">        channel = channelFactory.newChannel();</div><div class="line">        init(channel);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        <span class="keyword">if</span> (channel != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// channel can be null if newChannel crashed (eg SocketException("too many open files"))</span></div><div class="line">            channel.unsafe().closeForcibly();</div><div class="line">            <span class="comment">// as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DefaultChannelPromise(channel, GlobalEventExecutor.INSTANCE).setFailure(t);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultChannelPromise(<span class="keyword">new</span> FailedChannel(), GlobalEventExecutor.INSTANCE).setFailure(t);</div><div class="line">    &#125;</div><div class="line">	 <span class="comment">// æ ¸å¿ƒæ˜¯è¿™æ®µé€»è¾‘config().group()è¿”å›çš„å°±æ˜¯æˆ‘ä»¬è®¾ç½®çš„bossï¼šOioEventLoopGroup</span></div><div class="line">    ChannelFuture regFuture = config().group().register(channel);</div><div class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (channel.isRegistered()) &#123;</div><div class="line">            channel.close();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            channel.unsafe().closeForcibly();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> regFuture;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¿½ç•¥æ‰æ— å…³çš„é€»è¾‘ï¼ˆå®åœ¨æ˜¯å¾ˆå¤æ‚ï¼‰ï¼Œå…³é”®ç‚¹åˆ°äº†è¿™ä¸ªOioEventLoopGroupçš„registeræ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">register</span><span class="params">(Channel channel)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (channel == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"channel"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        EventLoop l = nextChild();</div><div class="line">        <span class="comment">// å°†channelåŒ…è£…äº†ä¸€ä¸‹--&gt; DefaultChannelPromise</span></div><div class="line">        <span class="keyword">return</span> l.register(<span class="keyword">new</span> DefaultChannelPromise(channel, l));</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FailedChannelFuture(channel, GlobalEventExecutor.INSTANCE, t);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªChannelå°±æ˜¯OioServerSocketChannelï¼Œå¯¹åº”åœ¨OIOåŸç”ŸAPIä¸­å°±æ˜¯ServerSocketã€‚æ ¹æ®ä»£ç çš„å­—é¢æ„å¯ä»¥è¿™æ ·è§£é‡Šï¼šå°†OioServerSocketChannelæ³¨å†Œåˆ°EventLoopGroupã€‚</p>
<p>æœ€ç»ˆæ˜¯é€šè¿‡EventLoopå»æ³¨å†Œçš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> EventLoop <span class="title">nextChild</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (shuttingDown) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="string">"shutting down"</span>);</div><div class="line">    &#125;</div><div class="line">	 <span class="comment">// ä»ç©ºé—²é˜Ÿåˆ—ä¸­å–EventLoop</span></div><div class="line">    EventLoop loop = idleChildren.poll();</div><div class="line">    <span class="keyword">if</span> (loop == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (maxChannels &gt; <span class="number">0</span> &amp;&amp; activeChildren.size() &gt;= maxChannels) &#123;</div><div class="line">            <span class="keyword">throw</span> tooManyChannels;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// æ²¡æœ‰å°±æ–°å»ºä¸€ä¸ª å‚æ•°æ²¡ç”¨</span></div><div class="line">        loop = newChild(childArgs);</div><div class="line">        loop.terminationFuture().addListener(childTerminationListener);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// æ–°å»ºçš„æ”¾åˆ°æ´»è·ƒé˜Ÿåˆ—ä¸­</span></div><div class="line">    activeChildren.add(loop);</div><div class="line">    <span class="keyword">return</span> loop;</div><div class="line">&#125;</div><div class="line"><span class="comment">// æ–°å»ºçš„ä¸€ä¸ªEventLoopä¸ºThreadPerChannelEventLoopå®ä¾‹ï¼Œå‚æ•°ä¸ºEventLoopGroup ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªEventLoopè¯´ç”±å“ªä¸ªgroupäº§ç”Ÿçš„</span></div><div class="line"><span class="function"><span class="keyword">protected</span> EventLoop <span class="title">newChild</span><span class="params">(@SuppressWarnings(<span class="string">"UnusedParameters"</span>)</span> Object... args) <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ThreadPerChannelEventLoop(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¹ˆä¸€æ¥ï¼ŒçœŸæ­£çš„æ³¨å†Œé€»è¾‘å°±äº¤ç»™äº†ThreadPerChannelEventLoopå»å®ç°äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPerChannelEventLoop</span><span class="params">(ThreadPerChannelEventLoopGroup parent)</span> </span>&#123;</div><div class="line">	 <span class="comment">// æ³¨æ„ è¿™é‡Œçš„parent.executorä¸ºThreadPerTaskExecutorå®ä¾‹</span></div><div class="line">    <span class="keyword">super</span>(parent, parent.executor, <span class="keyword">true</span>);</div><div class="line">    <span class="keyword">this</span>.parent = parent;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">register</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.register(promise).addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            <span class="keyword">if</span> (future.isSuccess()) &#123;</div><div class="line">                ch = future.channel();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                deregister();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"><span class="comment">// çˆ¶ç±»çš„</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">register</span><span class="params">(<span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">    ObjectUtil.checkNotNull(promise, <span class="string">"promise"</span>);</div><div class="line">    promise.channel().unsafe().register(<span class="keyword">this</span>, promise);</div><div class="line">    <span class="keyword">return</span> promise;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»ˆäºè¦çœ‹åˆ°å¸Œæœ›äº†ï¼Œè¿™ä¸€å±‚ä¸€å±‚çš„è°ƒç”¨å®åœ¨å¾ˆç¹çï¼Œä¼šæŠŠäººçœ‹æ™•ï¼Œå»ºè®®å¤šçœ‹å‡ éå°±ä¸æ™•äº†ğŸ˜‚ã€‚</p>
<p>promise.channel()è¿”å›çš„å°±æ˜¯æˆ‘ä»¬è®¾ç½®çš„OioServerSocketChannelã€‚è€Œunsafeæ–¹æ³•åˆ™æ˜¯ç»§æ‰¿è‡ªå®ƒçš„ã€Œå¤ªçˆ·çˆ·ã€ã€‚<br>å…¶å…·ä½“å®ç°åˆ™æ˜¯ç”±å®ƒã€Œçˆ·çˆ·ã€æ¥å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> AbstractUnsafe <span class="title">newUnsafe</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultOioUnsafe();</div><div class="line">&#125;</div><div class="line"><span class="comment">// è¿™æ˜¯å®ƒçš„ä¸€ä¸ªå†…éƒ¨ç±»</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultOioUnsafe</span> <span class="keyword">extends</span> <span class="title">AbstractUnsafe</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(</span></span></div><div class="line">            <span class="keyword">final</span> SocketAddress remoteAddress,</div><div class="line">            <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise) &#123;</div><div class="line">        <span class="keyword">if</span> (!promise.setUncancellable() || !ensureOpen(promise)) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">boolean</span> wasActive = isActive();</div><div class="line">            doConnect(remoteAddress, localAddress);</div><div class="line"></div><div class="line">            <span class="comment">// Get the state as trySuccess() may trigger an ChannelFutureListener that will close the Channel.</span></div><div class="line">            <span class="comment">// We still need to ensure we call fireChannelActive() in this case.</span></div><div class="line">            <span class="keyword">boolean</span> active = isActive();</div><div class="line"></div><div class="line">            safeSetSuccess(promise);</div><div class="line">            <span class="keyword">if</span> (!wasActive &amp;&amp; active) &#123;</div><div class="line">                pipeline().fireChannelActive();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            safeSetFailure(promise, annotateConnectException(t, remoteAddress));</div><div class="line">            closeIfClosed();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è™½ç„¶å¿«çœ‹åˆ°å¸Œæœ›çš„æ›™å…‰äº†ï¼Œä½†æ˜¯çœ¼å‰å´ä¾æ—§æ˜¯ä¸€ç‰‡é»‘æš—ã€‚ğŸ˜«ï¼ï¼ï¼äº²çˆ±çš„registerä½ åˆ°åº•åœ¨å“ªé‡Œï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractUnsafe ä¹Ÿæ˜¯å†…éƒ¨ç±» tmd nettyçœŸä¼šæŠ˜è…¾</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(EventLoop eventLoop, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (eventLoop == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"eventLoop"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isRegistered()) &#123;</div><div class="line">        promise.setFailure(<span class="keyword">new</span> IllegalStateException(<span class="string">"registered to an event loop already"</span>));</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!isCompatible(eventLoop)) &#123;</div><div class="line">        promise.setFailure(</div><div class="line">                <span class="keyword">new</span> IllegalStateException(<span class="string">"incompatible event loop type: "</span> + eventLoop.getClass().getName()));</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    AbstractChannel.<span class="keyword">this</span>.eventLoop = eventLoop;</div><div class="line">	 <span class="comment">// å…³é”®ç‚¹ å…¶ä»–ä¸ç®¡ è¿™é‡Œä¸€å®šæ˜¯æœ€åä¸€æ­¥äº†</span></div><div class="line">    <span class="keyword">if</span> (eventLoop.inEventLoop()) &#123;</div><div class="line">        register0(promise);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">        	  <span class="comment">// è¿™é‡Œå¤§æœ‰ç„æœº</span></div><div class="line">            eventLoop.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    register0(promise);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            logger.warn(</div><div class="line">                    <span class="string">"Force-closing a channel whose registration task was not accepted by an event loop: &#123;&#125;"</span>,</div><div class="line">                    AbstractChannel.<span class="keyword">this</span>, t);</div><div class="line">            closeForcibly();</div><div class="line">            closeFuture.setClosed();</div><div class="line">            safeSetFailure(promise, t);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// è¿™æ®µä»£ç çœ‹ä¸æ‡‚ å…ˆæ”¾è¿™ä¸ªåœ°æ–¹ çœ‹æ‡‚äº†å†æ¥è§£è¯»</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register0</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// check if the channel is still open as it could be closed in the mean time when the register</span></div><div class="line">        <span class="comment">// call was outside of the eventLoop</span></div><div class="line">        <span class="keyword">if</span> (!promise.setUncancellable() || !ensureOpen(promise)) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">boolean</span> firstRegistration = neverRegistered;</div><div class="line">        <span class="comment">// OIOç‰ˆæœ¬ä¸­ä»€ä¹ˆéƒ½ä¸åš</span></div><div class="line">        doRegister();</div><div class="line">        neverRegistered = <span class="keyword">false</span>;</div><div class="line">        registered = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Ensure we call handlerAdded(...) before we actually notify the promise. This is needed as the</span></div><div class="line">        <span class="comment">// user may already fire events through the pipeline in the ChannelFutureListener.</span></div><div class="line">        pipeline.invokeHandlerAddedIfNeeded();</div><div class="line"></div><div class="line">        safeSetSuccess(promise);</div><div class="line">        pipeline.fireChannelRegistered();</div><div class="line">        <span class="comment">// Only fire a channelActive if the channel has never been registered. This prevents firing</span></div><div class="line">        <span class="comment">// multiple channel actives if the channel is deregistered and re-registered.</span></div><div class="line">        <span class="keyword">if</span> (isActive()) &#123;</div><div class="line">            <span class="keyword">if</span> (firstRegistration) &#123;</div><div class="line">                pipeline.fireChannelActive();</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config().isAutoRead()) &#123;</div><div class="line">                <span class="comment">// This channel was registered before and autoRead() is set. This means we need to begin read</span></div><div class="line">                <span class="comment">// again so that we process inbound data.</span></div><div class="line">                <span class="comment">//</span></div><div class="line">                <span class="comment">// See https://github.com/netty/netty/issues/4805</span></div><div class="line">                beginRead();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        <span class="comment">// Close the channel directly to avoid FD leak.</span></div><div class="line">        closeForcibly();</div><div class="line">        closeFuture.setClosed();</div><div class="line">        safeSetFailure(promise, t);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>eventLoop.executeæ–¹æ³•ä¸­ä¸ä»…ä»…åªæ‰§è¡Œä¸€ä¸ªRunnableå°±å®Œäº†ï¼Œå› ä¸ºNettyè¿™ä¸ªç‹—é€¼æ²¡æœ‰ä½¿ç”¨é»˜è®¤å®ç° è€Œæ˜¯è‡ªå·±å®ç°çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// SingleThreadEventExecutorçš„å®ç°</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable task)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"task"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> inEventLoop = inEventLoop();</div><div class="line">    <span class="comment">// è¿™ä¸ªtaskå°±æ˜¯register0çš„å…·ä½“é€»è¾‘ è¿™ä¸ªé€»è¾‘æš‚æ—¶ä¸ç®¡ï¼ˆå› ä¸ºçœ‹ä¸æ‡‚ğŸ˜‚ï¼‰</span></div><div class="line">    <span class="keyword">if</span> (inEventLoop) &#123;</div><div class="line">    	  <span class="comment">// æ”¾åˆ°é˜Ÿåˆ—ä¸­</span></div><div class="line">        addTask(task);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">    	 <span class="comment">// ç»ˆäºéœ²å‡ºé©¬è„šäº† å¼€çº¿ç¨‹äº†å§</span></div><div class="line">        startThread();</div><div class="line">        addTask(task);</div><div class="line">        <span class="keyword">if</span> (isShutdown() &amp;&amp; removeTask(task)) &#123;</div><div class="line">            reject();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!addTaskWakesUp &amp;&amp; wakesUpForTask(task)) &#123;</div><div class="line">        wakeup(inEventLoop);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// å¼€ä¸ªçº¿ç¨‹éƒ½ç©è¿™ä¹ˆèŠ±</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startThread</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (state == ST_NOT_STARTED) &#123;</div><div class="line">        <span class="keyword">if</span> (STATE_UPDATER.compareAndSet(<span class="keyword">this</span>, ST_NOT_STARTED, ST_STARTED)) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                doStartThread();</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable cause) &#123;</div><div class="line">                STATE_UPDATER.set(<span class="keyword">this</span>, ST_NOT_STARTED);</div><div class="line">                PlatformDependent.throwException(cause);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doStartThread</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">assert</span> thread == <span class="keyword">null</span>;</div><div class="line">    <span class="comment">// è¿™ä¸ªexecutorå°±æ˜¯ThreadPerTaskExecutor </span></div><div class="line">    executor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            thread = Thread.currentThread();</div><div class="line">            <span class="keyword">if</span> (interrupted) &#123;</div><div class="line">                thread.interrupt();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</div><div class="line">            updateLastExecutionTime();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">            		<span class="comment">// è¿™ä¸ªç‹—é€¼ç©çš„æ˜¯çœŸèŠ± è¿˜å»è°ƒåˆ«äººçš„run å®é™…ä¸Šæ˜¯ThreadPerChannelEventLoopçš„å®ç°</span></div><div class="line">                SingleThreadEventExecutor.<span class="keyword">this</span>.run();</div><div class="line">                success = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                logger.warn(<span class="string">"Unexpected exception from an event executor: "</span>, t);</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            	<span class="comment">// å¤ªå¤š ä¸çœ‹äº†          </span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ThreadPerChannelEventLoop</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">	 <span class="comment">// æ­»å¾ªç¯</span></div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">    	 <span class="comment">// è¿™é‡Œçš„taskå°±æ˜¯AbstractUnsafe#register0çš„é€»è¾‘ å½“ç„¶ä¹Ÿæœ‰å¯èƒ½æ˜¯å…¶ä»–çš„</span></div><div class="line">        Runnable task = takeTask();</div><div class="line">        <span class="keyword">if</span> (task != <span class="keyword">null</span>) &#123;</div><div class="line">            task.run();</div><div class="line">            updateLastExecutionTime();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Channel ch = <span class="keyword">this</span>.ch;</div><div class="line">        <span class="keyword">if</span> (isShuttingDown()) &#123;</div><div class="line">            <span class="keyword">if</span> (ch != <span class="keyword">null</span>) &#123;</div><div class="line">                ch.unsafe().close(ch.unsafe().voidPromise());</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (confirmShutdown()) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (ch != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// Handle deregistration</span></div><div class="line">                <span class="keyword">if</span> (!ch.isRegistered()) &#123;</div><div class="line">                    runAllTasks();</div><div class="line">                    deregister();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ•´äº†è¿™ä¹ˆå¤šï¼Œä¾æ—§æ²¡æœ‰ææ˜ç™½è¿™ä¸ªregisteråˆ°åº•åœ¨åšä»€ä¹ˆã€‚ä½†æ˜¯æ˜ç™½äº†ä¸€ä»¶äº‹ï¼šæ‰¾åˆ°äº†å¯åŠ¨å…¥å£ã€‚</p>
<h3 id="æ³¨å†Œé€»è¾‘"><a href="#æ³¨å†Œé€»è¾‘" class="headerlink" title="æ³¨å†Œé€»è¾‘"></a>æ³¨å†Œé€»è¾‘</h3><p>åœ¨åŸç”ŸOIOç½‘ç»œç¼–ç¨‹ä¸­ï¼Œå®ç°ä¸€ä¸ªæœåŠ¡å™¨éœ€è¦åšè¿™å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>åˆ›å»ºServerSocketå¯¹è±¡ç»‘å®šç›‘å¬ç«¯å£ã€‚</li>
<li>é€šè¿‡accept()æ–¹æ³•ç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</li>
<li>å»ºç«‹è¿æ¥åï¼Œé€šè¿‡è¾“å…¥è¾“å‡ºæµè¯»å–å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä¿¡æ¯ã€‚</li>
<li>é€šè¿‡è¾“å‡ºæµå‘å®¢æˆ·ç«¯å‘é€è¯·æ±‚ä¿¡æ¯ã€‚</li>
<li>å…³é—­ç›¸å…³èµ„æºã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    ServerSocket server=<span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span>&#123;</div><div class="line">        server=<span class="keyword">new</span> ServerSocket(<span class="number">5209</span>);</div><div class="line">        <span class="comment">//b)æŒ‡å®šç»‘å®šçš„ç«¯å£ï¼Œå¹¶ç›‘å¬æ­¤ç«¯å£ã€‚</span></div><div class="line">        System.out.println(<span class="string">"æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ"</span>);</div><div class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªServerSocketåœ¨ç«¯å£5209ç›‘å¬å®¢æˆ·è¯·æ±‚</span></div><div class="line">    &#125;<span class="keyword">catch</span>(Exception e) &#123;</div><div class="line">            System.out.println(<span class="string">"æ²¡æœ‰å¯åŠ¨ç›‘å¬ï¼š"</span>+e);</div><div class="line">            <span class="comment">//å‡ºé”™ï¼Œæ‰“å°å‡ºé”™ä¿¡æ¯</span></div><div class="line">    &#125;</div><div class="line">    Socket socket=<span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span>&#123;</div><div class="line">        socket=server.accept();</div><div class="line">        <span class="comment">//2ã€è°ƒç”¨accept()æ–¹æ³•å¼€å§‹ç›‘å¬ï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ </span></div><div class="line">        <span class="comment">//ä½¿ç”¨accept()é˜»å¡ç­‰å¾…å®¢æˆ·è¯·æ±‚ï¼Œæœ‰å®¢æˆ·</span></div><div class="line">        <span class="comment">//è¯·æ±‚åˆ°æ¥åˆ™äº§ç”Ÿä¸€ä¸ªSocketå¯¹è±¡ï¼Œå¹¶ç»§ç»­æ‰§è¡Œ</span></div><div class="line">    &#125;<span class="keyword">catch</span>(Exception e) &#123;</div><div class="line">        System.out.println(<span class="string">"Error."</span>+e);</div><div class="line">        <span class="comment">//å‡ºé”™ï¼Œæ‰“å°å‡ºé”™ä¿¡æ¯</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>åœ¨Nettyä¸­çš„å®ç°åŸºæœ¬å¦‚æ­¤ï¼Œåªä¸è¿‡ä»£ç ç»“æ„æ¯”è¾ƒå¤æ‚ç½¢äº†ã€‚è¿™æ®µä»£ç åœ¨Nettyä¸­çš„çš„å®ç°åœ¨OioServerSocketChannelä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBind</span><span class="params">(SocketAddress localAddress)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    socket.bind(localAddress, config.getBacklog());</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doReadMessages</span><span class="params">(List&lt;Object&gt; buf)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (socket.isClosed()) &#123;</div><div class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Socket s = socket.accept();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            buf.add(<span class="keyword">new</span> OioSocketChannel(<span class="keyword">this</span>, s));</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            logger.warn(<span class="string">"Failed to create a new channel from an accepted socket."</span>, t);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                s.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t2) &#123;</div><div class="line">                logger.warn(<span class="string">"Failed to close a socket."</span>, t2);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (SocketTimeoutException e) &#123;</div><div class="line">        <span class="comment">// Expected</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…ˆç»‘å®šç«¯å£ï¼Œå†æ¥å—è¿æ¥ã€‚è¿™ä¸ªæ¥å—è¿æ¥æ˜¯ä¼ªéé˜»å¡çš„ã€‚å› ä¸ºç”¨äºè¿æ¥çš„çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œæ²¡æœ‰å®¢æˆ·ç«¯è¿è¿›æ¥çš„æ—¶å€™ä¸èƒ½å°†å…¶é˜»å¡è°ƒã€‚å®¢æˆ·ç«¯è¿è¿›æ¥äº†å°±å°†è¿™ä¸ªã€Œè¿æ¥ã€äº¤ç»™åˆ«çš„çº¿ç¨‹å¤„ç†ï¼Œæ¯ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™æ ·å°±åšåˆ°äº†è¿æ¥å’Œioå¤„ç†ä¸å†²çªã€‚</p>
<p>å½“ç„¶ï¼Œæœ€åçš„æ‰§è¡Œè‚¯å®šæ˜¯åˆ°è¿™ä¸€æ­¥ï¼Œä½†æ˜¯å…·ä½“çš„æ‰§è¡Œè°ƒç”¨è¿‡ç¨‹å¯ç§°å¾—ä¸Šå›°éš¾é‡é‡ã€‚ä»”ç»†å›å¤´çœ‹è¿™ä¸ªregister0çš„å¤„ç†é€»è¾‘ï¼Œå‘ç°å¥½åƒä»…ä»…å¯åŠ¨äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œç”¨äºä¸æ–­ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡æ‰§è¡Œçš„æ­»å¾ªç¯è€Œå·²ã€‚ä¼¼ä¹æ²¡æœ‰ç›´æ¥è¡¨ç°å‡ºåƒç»‘å®šç«¯å£ï¼Œæ¥å—è¿æ¥çš„è¿¹è±¡ã€‚ä¸èƒ½æ…Œï¼Œè¿™ä¸ªè€béšè—å¾—å¾ˆæ·±ã€‚å›åˆ°æœ€å¼€å§‹çš„åœ°æ–¹ï¼Œè¿™ä¸ªä»…ä»…æ˜¯registerï¼Œå§‘ä¸”å°±åˆ°è¿™é‡Œï¼Œå…ˆç»§ç»­å¾€ä¸‹çœ‹ï¼Œçœ‹åˆ°åº•åˆæœ‰ä»€ä¹ˆæ–°å‘ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ChannelFuture <span class="title">doBind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> ChannelFuture regFuture = initAndRegister();</div><div class="line">    <span class="keyword">final</span> Channel channel = regFuture.channel();</div><div class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> regFuture;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (regFuture.isDone()) &#123;</div><div class="line">        <span class="comment">// At this point we know that the registration was complete and successful.</span></div><div class="line">        ChannelPromise promise = channel.newPromise();</div><div class="line">        doBind0(regFuture, channel, localAddress, promise);</div><div class="line">        <span class="keyword">return</span> promise;</div><div class="line">    &#125; </div><div class="line">    <span class="comment">// çœç•¥ã€‚ã€‚ã€‚</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>initAndRegisteræ–¹æ³•ç»å†åƒå±±ä¸‡æ°´ç»ˆäºå¯åŠ¨äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œç›®çš„å°±æ˜¯è¿”å›ä¸€ä¸ªChannelFutureï¼Œå…ˆä¸ç®¡è¿™ä¸ªChannelFutureåˆ°åº•æ˜¯ä»€ä¹ˆé¬¼ï¼Œå…ˆå°†å…¶ç†è§£ä¸ºJDKä¸­çš„Futureçš„å¢å¼ºå®ç°ã€‚ä¸€æ—¦è¿™ä¸ªFutureå®Œæˆäº†ï¼Œè°ƒç”¨doBind0:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doBind0</span><span class="params">(</span></span></div><div class="line">            <span class="keyword">final</span> ChannelFuture regFuture, <span class="keyword">final</span> Channel channel,</div><div class="line">            <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise) &#123;</div><div class="line">    <span class="comment">// This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up</span></div><div class="line">    <span class="comment">// the pipeline in its channelRegistered() implementation.</span></div><div class="line">    channel.eventLoop().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (regFuture.isSuccess()) &#123;</div><div class="line">                channel.bind(localAddress, promise).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                promise.setFailure(regFuture.cause());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœ‹åˆ°äº†å§ï¼Œè¿™ä¸ªé¬¼åˆå‘é˜Ÿåˆ—ä¸­æ·»åŠ äº†ä¸€ä¸ªä»»åŠ¡ã€‚è¿™ä¸ªä»»åŠ¡æ ¸å¿ƒå°±æ˜¯å»ç»‘å®šã€‚æƒ³éƒ½ä¸ç”¨æƒ³ï¼Œè¿™ä¸ªç»‘å®šä¸€å®šæ˜¯AbstractChannelä¸­çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pipeline.bind(localAddress, promise);</div><div class="line">&#125;</div><div class="line"><span class="comment">// pipelineçš„bindæœ‰æ˜¯å…¶é»˜è®¤å®ç°ç±»ä¸­çš„å­ç±»TailContextä¸­çš„å®ç°</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> tail.bind(localAddress, promise);</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="comment">// çœç•¥ã€‚ã€‚ã€‚</span></div><div class="line">    <span class="keyword">final</span> AbstractChannelHandlerContext next = findContextOutbound();</div><div class="line">    EventExecutor executor = next.executor();</div><div class="line">    <span class="keyword">if</span> (executor.inEventLoop()) &#123;</div><div class="line">        next.invokeBind(localAddress, promise);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        safeExecute(executor, <span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                next.invokeBind(localAddress, promise);</div><div class="line">            &#125;</div><div class="line">        &#125;, promise, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> promise;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€åçš„bindæ˜¯æœ€ç»ˆçš„æ ¸å¿ƒé€»è¾‘ã€‚å…ˆæ‰¾OutboundContextï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> AbstractChannelHandlerContext <span class="title">findContextOutbound</span><span class="params">()</span> </span>&#123;</div><div class="line">    AbstractChannelHandlerContext ctx = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        ctx = ctx.prev;</div><div class="line">    &#125; <span class="keyword">while</span> (!ctx.outbound);</div><div class="line">    <span class="keyword">return</span> ctx;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ˜¯tailï¼Œå…³äºpipelineçš„ç»“æ„æœ‰å¿…è¦äº†è§£ä¸€ä¸‹ã€‚<img src="https://segmentfault.com/img/bVEPxn?w=2387&amp;h=584" alt="image"></p>
<p>æˆ‘ä»¬åœ¨è¿™ä¸ªServeråˆå§‹åŒ–çš„æ—¶å€™æ·»åŠ äº†handlerï¼Œæ¯”å¦‚LoggingHandlerç­‰ã€‚è¿™äº›handleréƒ½ä¼šè¢«æ·»åŠ åˆ°tailå’Œheadä¹‹é—´ã€‚å³ä½¿ä½ ä¸æ·»åŠ ä»»ä½•handlerï¼Œnettyä¹Ÿä¼šæŠŠè‡ªå·±å†…éƒ¨çš„handleræ·»åŠ è¿›å»ã€‚handleråˆåˆ†ä¸ºinå’Œoutï¼Œåˆ†åˆ«ä»£è¡¨å…¥ç«™å’Œå‡ºç«™ã€‚è¿™æ®µä»£ç å°±æ˜¯æ‰¾å‡ºç«™çš„(åªæœ‰outçš„æ‰æœ‰bindæ–¹æ³•)ï¼Œä¸€ç›´å‘headæ–¹å‘æ‰¾ï¼ˆåºŸè¯ï¼Œè‡ªå·±éƒ½æ˜¯tailäº†åªèƒ½å¾€å‰æ‰¾ï¼Œåé¢æ²¡æœ‰äº†ï¼‰ã€‚æ‰¾åˆ°ä¸€ä¸ªå°±ç®—æ•°ï¼Œç›´æ¥è¿”å›è¿™ä¸ªcontextã€‚æ¥ç€å°±æ˜¯è°ƒç”¨invokeBindæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeBind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (invokeHandler()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ((ChannelOutboundHandler) handler()).bind(<span class="keyword">this</span>, localAddress, promise);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            notifyOutboundHandlerException(t, promise);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        bind(localAddress, promise);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆçš„bindæ–¹æ³•åœ¨ifåˆ†æ”¯ä¸­ã€‚å…·ä½“çš„æ‰§è¡Œé€»è¾‘ä¸ºå®ç°äº†outçš„handlerï¼Œä¾‹å¦‚LoggingHandlerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) &#123;</div><div class="line">        logger.log(internalLevel, format(ctx, <span class="string">"BIND"</span>, localAddress));</div><div class="line">    &#125;</div><div class="line">    ctx.bind(localAddress, promise);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ˜¾ç„¶è¿™ä¸ªhandlerä»…ä»…åªæ˜¯æ¥æ‰“å°logçš„ï¼Œå®Œäº‹ä¹‹ååˆäº¤ç»™çˆ¶ç±»å»æ‰§è¡Œã€‚è€Œçˆ¶ç±»ä¾ç„¶æ˜¯é‚£æ®µã€‚å› ä¸ºä¹‹å‰æ˜¯æ‰¾åˆ°ç¬¬ä¸€ä¸ªå®ç°outçš„handlerå°±ç®—æ•°ï¼Œè¿™é‡Œåˆå›åˆ°äº†è¿™ä¸ªpipelineä¸­ï¼Œç»§ç»­å¾€å‰æ‰¾ï¼Œæœ€ç»ˆä¼šæ‰¾åˆ°headï¼ˆheadä¸ä»…æ˜¯outè€Œä¸”è¿˜æ˜¯inï¼Œå°±æ˜¯è¿™ä¹ˆå±Œï¼‰ã€‚æœ€ç»ˆè°ƒç”¨çš„æ˜¯headcontextä¸­çš„bindï¼Œè€Œå®ƒçš„bindå´æ˜¯ä½¿ç”¨çš„æ˜¯unsafeçš„bindï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(</span></span></div><div class="line">        ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</div><div class="line">        <span class="keyword">throws</span> Exception &#123;</div><div class="line">    unsafe.bind(localAddress, promise);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">    assertEventLoop();</div><div class="line">    <span class="keyword">if</span> (!promise.setUncancellable() || !ensureOpen(promise)) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// See: https://github.com/netty/netty/issues/576</span></div><div class="line">    <span class="keyword">if</span> (Boolean.TRUE.equals(config().getOption(ChannelOption.SO_BROADCAST)) &amp;&amp;</div><div class="line">        localAddress <span class="keyword">instanceof</span> InetSocketAddress &amp;&amp;</div><div class="line">        !((InetSocketAddress) localAddress).getAddress().isAnyLocalAddress() &amp;&amp;</div><div class="line">        !PlatformDependent.isWindows() &amp;&amp; !PlatformDependent.maybeSuperUser()) &#123;</div><div class="line">        <span class="comment">// Warn a user about the fact that a non-root user can't receive a</span></div><div class="line">        <span class="comment">// broadcast packet on *nix if the socket is bound on non-wildcard address.</span></div><div class="line">        logger.warn(</div><div class="line">                <span class="string">"A non-root user can't receive a broadcast packet if the socket "</span> +</div><div class="line">                <span class="string">"is not bound to a wildcard address; binding to a non-wildcard "</span> +</div><div class="line">                <span class="string">"address ("</span> + localAddress + <span class="string">") anyway as requested."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// è¿™ä¸ªé€»è¾‘æ˜¯æœ‰æ„æ€çš„ è¿”å›å€¼ä¸º !socket.isClosed()&amp;&amp; socket.isBound()</span></div><div class="line">    <span class="comment">// æ²¡å…³ä¸”ç»‘å®šäº†æ‰ä¸ºtrue è¿™é‡Œä¸€å®šä¸ºfalse å› ä¸ºè‚¯å®šæ²¡ç»‘å®š</span></div><div class="line">    <span class="keyword">boolean</span> wasActive = isActive();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">    	 <span class="comment">// çœ‹åˆ°è¿™è¡Œä»£ç å°±å¤Ÿäº† å…¶ä»–ä¸ç®¡</span></div><div class="line">        doBind(localAddress);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        safeSetFailure(promise, t);</div><div class="line">        closeIfClosed();</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">	 <span class="comment">// ç»‘å®šå®Œäº†isActive()è‚¯å®šä¸ºtrue</span></div><div class="line">    <span class="keyword">if</span> (!wasActive &amp;&amp; isActive()) &#123;</div><div class="line">        <span class="comment">// è¿™æ®µä»£ç ä¹Ÿå¾—çœ‹</span></div><div class="line">        invokeLater(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                pipeline.fireChannelActive();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    safeSetSuccess(promise);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœ‹åˆ°doBindå°±çŸ¥é“æ€ä¹ˆå›äº‹äº†ï¼Œè¿™å°±æ˜¯ä¹‹å‰æ‰€è¯´çš„OioServerSocketChannelçš„doBindã€‚ç»ˆäºå®Œæˆäº†ç¬¬ä¸€æ­¥ï¼šç»‘å®šç«¯å£ã€‚<br>æ¥ä¸‹æ¥å°±æ˜¯ç›‘å¬å®¢æˆ·ç«¯è¿æ¥ï¼Œåœ¨invokeLaterä¸­å°†å…¶å®ç°äº†ï¼Œä¸€æ¢ç©¶ç«Ÿï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeLater</span><span class="params">(Runnable task)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        eventLoop().execute(task);</div><div class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</div><div class="line">        logger.warn(<span class="string">"Can't invoke task later as EventLoop rejected it"</span>, e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœç„¶ï¼Œä¾æ—§æŠŠè¿™ä¸ªä»»åŠ¡æ”¾åˆ°çº¿ç¨‹ä¸­å»æ‰§è¡Œäº†ã€‚è¿™ä¸ªä»»åŠ¡åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œå¾ˆé‡è¦ã€‚ä»£ç ä¸­åªç»™äº†ä¸€æ®µ<code>pipeline.fireChannelActive()</code>.çœ‹çœ‹å…·ä½“å®ç°å§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireChannelActive</span><span class="params">()</span> </span>&#123;</div><div class="line">    AbstractChannelHandlerContext.invokeChannelActive(head);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// contextä¸ºhead åˆäº¤ç»™äº†EventExecutorå»æ‰§è¡Œ</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeChannelActive</span><span class="params">(<span class="keyword">final</span> AbstractChannelHandlerContext next)</span> </span>&#123;</div><div class="line">    EventExecutor executor = next.executor();</div><div class="line">    <span class="keyword">if</span> (executor.inEventLoop()) &#123;</div><div class="line">        next.invokeChannelActive();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        executor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                next.invokeChannelActive();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// è°ƒç”¨çš„æ˜¯headçš„å®ç°</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeChannelActive</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (invokeHandler()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ((ChannelInboundHandler) handler()).channelActive(<span class="keyword">this</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            notifyHandlerException(t);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        fireChannelActive();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// headçš„channelActive è¿™é‡Œçš„å¥—è·¯å’Œä¹‹å‰çš„ä¸€æ ·ï¼Œå…ˆè°ƒç”¨çˆ¶ç±»çš„ ç»§ç»­æ‰¾pipelineä¸­çš„handleråªä¸è¿‡æ–¹å‘ç›¸åï¼ˆä»headåˆ°tailï¼‰ ä¾æ¬¡ç±»æ¨ å¦‚æœæŸä¸ªhandlerä¸å»è°ƒç”¨ctxäº†ï¼Œé‚£ä¹ˆäº‹ä»¶å°±åˆ°æ­¤ä¸ºæ­¢ä¸ä¼šä¼ é€’ä¸‹å»äº†</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    ctx.fireChannelActive();</div><div class="line">	 <span class="comment">// è¿™æ®µä»£ç æ˜¯é‡ç‚¹</span></div><div class="line">    readIfIsAutoRead();</div><div class="line">&#125;</div><div class="line"><span class="comment">// çˆ¶ç±»çš„fireChannelActive</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelHandlerContext <span class="title">fireChannelActive</span><span class="params">()</span> </span>&#123;</div><div class="line">    invokeChannelActive(findContextInbound());</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆï¼Œä¸€å®šä¸€å®šæ˜¯è¦åšæˆ‘ä»¬åœ¨OIOåŸç”Ÿç¼–ç¨‹ä¸­çš„ç¬¬äºŒæ­¥äº†ï¼šæ¥å—è¿æ¥äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readIfIsAutoRead</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (channel.config().isAutoRead()) &#123;</div><div class="line">        channel.read();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// OioSocketChannelçš„read å®é™…ä¸Šæ˜¯çˆ¶ç±»çš„</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Channel <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line">    pipeline.read();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// è°ƒç”¨çš„æ˜¯pipelineçš„read</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line">    tail.read();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// tailçš„read</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelHandlerContext <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> AbstractChannelHandlerContext next = findContextOutbound();</div><div class="line">    EventExecutor executor = next.executor();</div><div class="line">    <span class="keyword">if</span> (executor.inEventLoop()) &#123;</div><div class="line">        next.invokeRead();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Runnable task = next.invokeReadTask;</div><div class="line">        <span class="keyword">if</span> (task == <span class="keyword">null</span>) &#123;</div><div class="line">            next.invokeReadTask = task = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    next.invokeRead();</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">        &#125;</div><div class="line">        executor.execute(task);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœ‹åˆ°è¿™é‡Œæˆ‘åˆæ‰“è„¸äº†ï¼Œè¿˜æœ‰è¿™ä¹ˆå¤šå±‚çš„è°ƒç”¨ï¼ä½†æ˜¯ä¸è¦æ…Œï¼Œå› ä¸ºé€»è¾‘æ˜¯ç±»ä¼¼çš„ã€‚éƒ½æ˜¯åœ¨pipelineè¿™æ¡é“¾ä¸Šæ‰¾handleræ¥è°ƒç”¨ï¼Œçˆ±è°ƒä¸è°ƒçš„æ€æƒ³ã€‚è¿™é‡Œçš„é¡ºåºæ˜¯ä»tailåˆ°headã€‚å¦‚æœè¿™ä¸ªé“¾ä¸­æœ‰å“ªä¸ªä¸é•¿çœ¼çš„æ²¡æœ‰å°†äº‹ä»¶ä¼ é€’ä¸‹å»ï¼Œé‚£ä¹ˆæœ€ç»ˆå°±åˆ°ä¸äº†headã€‚æ­£å¸¸æƒ…å†µä¸‹æ˜¯ä¸€å®šè¦åˆ°headçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">    unsafe.beginRead();</div><div class="line">&#125;</div><div class="line"><span class="comment">// ä»€ä¹ˆéƒ½å¾—è€ƒunsafe</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">beginRead</span><span class="params">()</span> </span>&#123;</div><div class="line">    assertEventLoop();</div><div class="line">    <span class="keyword">if</span> (!isActive()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        doBeginRead();</div><div class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</div><div class="line">        invokeLater(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                pipeline.fireExceptionCaught(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        close(voidPromise());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// æœ€ç»ˆè¿˜æ˜¯å°†å…¶ä¸¢ç»™äº†eventLoopå»æ‰§è¡Œ readTaskæ˜¯æ ¸å¿ƒ</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBeginRead</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (readPending) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    readPending = <span class="keyword">true</span>;</div><div class="line">    eventLoop().execute(readTask);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªreadTaskå…ˆå°†å…¶å®šä¹‰å¥½äº†ï¼Œæ²¡æœ‰ç›´æ¥ä½¿ç”¨åŒ¿åå†…éƒ¨ç±»ã€‚ä¸€è‚¡æ¸…æµå•Šï¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable readTask = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        doRead();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªdoReadæœ‰2ä¸ªå®ç°AbstractOioByteChannelå’ŒAbstractOioMessageChannelçœ‹åå­—éƒ½èƒ½çŸ¥é“åŒºåˆ«ï¼Œä¸€ä¸ªæ˜¯è¯»å­—èŠ‚ä¸€ä¸ªæ˜¯è¯»å¯¹è±¡ã€‚æœ€å¤§çš„åŒºåˆ«æ˜¯OioByteStreamChannelæ˜¯OioSocketChannelçš„çˆ¶ç±»è€ŒAbstractOioMessageChannelæ˜¯OioServerSocketChannelçš„çˆ¶ç±»ã€‚è¿™é‡Œä½¿ç”¨çš„å®ç°ä¸ç”¨è¯´ä¹ŸçŸ¥é“äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRead</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// å¤ªå¤šçœç•¥ä¸çœ‹</span></div><div class="line">    <span class="keyword">final</span> ChannelConfig config = config();</div><div class="line">    <span class="keyword">final</span> ChannelPipeline pipeline = pipeline();</div><div class="line">    <span class="keyword">final</span> RecvByteBufAllocator.Handle allocHandle = unsafe().recvBufAllocHandle();</div><div class="line">    allocHandle.reset(config);</div><div class="line">    <span class="keyword">boolean</span> closed = <span class="keyword">false</span>;</div><div class="line">    Throwable exception = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            <span class="comment">// Perform a read. å…³é”®ç‚¹</span></div><div class="line">            <span class="keyword">int</span> localRead = doReadMessages(readBuf);</div><div class="line">            <span class="keyword">if</span> (localRead == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (localRead &lt; <span class="number">0</span>) &#123;</div><div class="line">                closed = <span class="keyword">true</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            allocHandle.incMessagesRead(localRead);</div><div class="line">        &#125; <span class="keyword">while</span> (allocHandle.continueReading());</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        exception = t;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ä¸çœ‹</span></div><div class="line">    <span class="comment">// è¿™é‡Œè¿˜çœç•¥äº†ä¸€ä¸ªå…³é”®ä»£ç  ä¸€ç›´æƒ³ä¸æ˜ç™½çš„ä¸€ä¸ªé—®é¢˜æ˜¯è¿™æ®µä»£ç æ˜¯æ€ä¹ˆèƒ½å¤Ÿä¸€åªrunä¸‹å»çš„</span></div><div class="line">    <span class="comment">// å› ä¸ºeventloopä¸­æœ‰ä¸ªæ­»å¾ªç¯ï¼Œå–çš„æ˜¯ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å»æ‰§è¡Œçš„ï¼Œå–çš„æ–¹å¼æ˜¯takeï¼Œä¹Ÿå°±æ˜¯å–å‡ºæ¥å°±ç§»é™¤æ‰</span></div><div class="line">    <span class="comment">// è€Œä¸‹é¢è¿™æ®µä»£ç åˆ™æ˜¯å°†å…¶ç»§ç»­åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œåªè¦æ²¡è¯»åˆ°æ•°æ®å°±ç»§ç»­å°†è¿™ä¸ªtaskæ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ— è¿™æ ·å°±èƒ½ä¸€ç›´æ­»å¾ªç¯ä¸‹å»</span></div><div class="line">    <span class="comment">// Reading 0 bytes could mean there is a SocketTimeout and no data was actually read, so we</span></div><div class="line">    <span class="comment">// should execute read() again because no data may have been read.</span></div><div class="line">    read();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆè¿™ä¸ªdoReadMessageså°±æ˜¯OioServerSocketChannelçš„å®ç°ã€‚å°†ç›‘å¬å®¢æˆ·ç«¯è¿æ¥ä¹Ÿæ”¾åˆ°äº†ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè®©çº¿ç¨‹å»è½®è¯¢ã€‚è‡³äºæ€ä¹ˆå»æŠŠæ¶ˆæ¯è¯»å‡ºæ¥ä»¥åŠè¿™ä¸ªè¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Œè¿™æ˜¯ä»¥åçš„äº‹æƒ…ã€‚å› ä¸ºè¿™æ¬¡åŸºæœ¬ä¸Šå°†æ•´ä¸ªnettyçš„æ ¸å¿ƒç»„ä»¶éƒ½æ¥è§¦åˆ°äº†ã€‚æ¥ä¸‹æ¥çš„æºç è§£è¯»ä¼šç¨å¾®è½»æ¾ç‚¹ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>NettyçœŸå±Œï¼Œä¸æ¥å—åé©³ğŸ˜‚ï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å’Œé«˜æ€§èƒ½NIOç›¸æ¯”ï¼Œä¸ªäººè®¤ä¸ºOIOçš„å®ç°ç›¸å¯¹è¦ç®€å•ä¸€ç‚¹ï¼Œé€‰æ‹©è¿™ä¸ªéš¾åº¦ç¨å¾®ä½ä¸€ç‚¹çš„å®ç°æ¥è‚¯å¯¹ç›®å‰çš„èœé¸¡æˆ‘è€Œè¨€æ›´ç°å®ã€‚&lt;/p&gt;
&lt;p&gt;æœ¬è´¨ä¸Šè€Œè¨€ï¼Œeventloopgroupå°±æ˜¯çº¿ç¨‹æ± ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://7xsfwn.com1.z0.glb.cl
    
    </summary>
    
      <category term="ä¸€èµ·è¯»æºç " scheme="http://www.wei-dong.top/categories/%E4%B8%80%E8%B5%B7%E8%AF%BB%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="Netty" scheme="http://www.wei-dong.top/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€èµ·å­¦RPC(å››)</title>
    <link href="http://www.wei-dong.top/2018/08/31/%E4%B8%80%E8%B5%B7%E5%AD%A6RPC(%E5%9B%9B)/"/>
    <id>http://www.wei-dong.top/2018/08/31/ä¸€èµ·å­¦RPC(å››)/</id>
    <published>2018-08-31T08:17:23.000Z</published>
    <updated>2018-08-31T08:26:41.343Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è®²åˆ°äº†providerä¸­é’ˆå¯¹consumerçš„è¯·æ±‚æ¶ˆæ¯å°è£…<code>MessageTask</code>çš„éƒ¨åˆ†ç»†èŠ‚ã€‚ç•™ä¸‹äº†æœ€æ ¸å¿ƒçš„å¤„ç†æ¶ˆæ¯çš„ç»†èŠ‚<code>process</code>æ–¹æ³•æ²¡æœ‰è¯´ã€‚</p>
<p>åœ¨ç»§ç»­å¯¹æ‰€è°“çš„æ ¸å¿ƒé€»è¾‘æ¢³ç†ä¹‹å‰ï¼Œå…ˆæ•´ä½“çš„æ‹ä¸€æ‹ä¹‹å‰æ–‡ç« çš„è¡Œæ–‡æ€è·¯ã€‚</p>
<p>consumerçš„clientå‘é€ä¸€ä¸ªè¯·æ±‚æŠ¥æ–‡ï¼Œè¿™ä¸ªæŠ¥æ–‡åŒ…å«headerå¤´ä»¥åŠè¯·æ±‚ä½“ï¼Œé€šè¿‡providerçš„è§£ç å™¨å°†å…¶è¿›è¡Œè§£ç ï¼Œè§£ç åçš„å¯¹è±¡ä¸º<code>JRequestPayload</code>æˆ–è€…<code>JResponsePayload</code>ã€‚è¿™äº›è§£ç åçš„å¯¹è±¡è¿˜ä¸å±äºä¸šåŠ¡å±‚çš„ï¼Œä»…ä»…åªæ˜¯å¯¹æ•°æ®åŒ…è¿›è¡Œäº†ç¬¬ä¸€å±‚çš„å°è£…ã€‚è§£ç å®Œæˆåï¼Œç»è¿‡ç¬¬ä¸€å±‚åŒ…è£…çš„æ¶ˆæ¯è¿›å…¥å…·ä½“å¤„ç†æ¶ˆæ¯çš„handlerï¼Œè€Œè¿™ä¸ªhandlerå¹¶ä¸å…è®¸å¤„ç†å¤ªå¤šä¸šåŠ¡é€»è¾‘ï¼Œå› ä¸ºè¿™æ˜¯IOçº¿ç¨‹ï¼Œå¤„ç†å¤šäº†ä¼šç´¯æ­»ï¼Œæ¶ˆè€—æ€§èƒ½ï¼Œå½±å“åˆ«çš„è¯·æ±‚ã€‚handlerå°†æ¶ˆæ¯ä¸¢ç»™äº†processoræ¥å¤„ç†ã€‚ç„¶è€Œprocessoræ˜¯ä¸€ä¸ªä»»åŠ³ä»»æ€¨çš„è€å¤§å“¥ï¼Œä»–ä¹Ÿå¾ˆèªæ˜ï¼Œå«æ¥äº†<code>CloseableExecutor</code>å¤§ä½¬ï¼Œä¹Ÿå°±æ˜¯<code>Executor</code>å®¶æ—çš„ä¸€å‘˜æ¥å¸®å¿™å¤„ç†è¿™äº›æ¶ˆæ¯ã€‚ä½†æ˜¯è¿™ä¸ªå¤§ä½¬åªèƒ½å¤„ç†ç‰¹å®šçš„æ¶ˆæ¯ï¼Œé’ˆå¯¹è¿™äº›â€œä¸è®¤è¯†â€çš„æ¶ˆæ¯æœ‰ç‚¹æ‡µé€¼ï¼Œäºæ˜¯å°†è¿™äº›æ¶ˆæ¯åšäº†ä¸€äº›åŠ å·¥ï¼Œè½¬åŒ–æˆ<code>MessageTask</code>ï¼Œè¿™æ ·å­å¤§ä½¬ä»¬å°±å¼€å¿ƒå¿«ä¹çš„å»å¹²æ´»äº†ã€‚ç„¶è€Œå®é™…ä¸Šå¤§ä½¬ä¸ä¼šäº²è‡ªå»å¹²æ´»ï¼Œä»–åªâ€œå®‰æ’â€å°å¼Ÿå»å¹²ï¼Œè€Œå…·ä½“åšä»€ä¹ˆéƒ½åœ¨<code>MessageTask</code>é‡Œé¢è£…ç€ï¼Œå°†è¦åšçš„äº‹æƒ…å…¨éƒ¨å®‰æ’åœ¨<code>run</code>æ–¹æ³•ä¸­ã€‚æ¥ä¸‹æ¥å°±æ˜¯å¯¹è¿™äº›æ¶ˆæ¯è¿›è¡Œå¤„ç†äº†ã€‚</p>
<p>è¿™é‡Œè¦åšæœ€é‡è¦çš„ä¸€æ­¥å°±æ˜¯å°†payloadä¸­çš„å­—èŠ‚æ ¹æ®headerä¸­çš„åºåˆ—åŒ–è§„åˆ™è¿›è¡Œè§£ç ï¼ˆååºåˆ—åŒ–ï¼‰ï¼Œè¿™ä¹Ÿå¯ä»¥ç®—æ˜¯ç¬¬äºŒæ¬¡å°è£…äº†ã€‚ä¸ºå•¥è¦åœ¨è¿™é‡Œå¤„ç†è€Œä¸æ˜¯åœ¨è§£ç å™¨å¤„ç†ï¼Œè¿˜æ˜¯å› ä¸ºä¸èƒ½å½±å“IOçº¿ç¨‹ï¼Œé‚£ä¸ªå®¶ä¼™å¨‡è´µçš„å¾ˆï¼Œç´¯ä¸å¾—ã€‚ç»è¿‡ååºåˆ—åŒ–åçš„å¯¹è±¡å«åš<code>MessageWrapper</code>.è¿™ä¸ªå®¶ä¼™å¾ˆçœŸå®ï¼Œå› ä¸ºå®Œå…¨æ˜¯å±äºä¸šåŠ¡å±‚çš„åŒ…ã€‚æ— éå°±æ˜¯consumerçš„è¯‰æ±‚ç½¢äº†ï¼šæˆ‘è¦è°ƒç”¨å“ªä¸ªæ¥å£ï¼Œå‚æ•°æ˜¯ä»€ä¹ˆï¼Œå¾—æ˜¯ä»€ä¹ˆç‰ˆæœ¬çš„blablaä¸€ç³»åˆ—ä¿¡æ¯ã€‚è¿™äº›ä¿¡æ¯å…¨éƒ¨éƒ½æ”¾åœ¨ä¼ è¾“å±‚çš„bodyé‡Œé¢ï¼Œç°åœ¨é€šè¿‡ååºåˆ—åŒ–çœŸçœŸå®å®çš„ç«™åœ¨å¤§ä½¬é¢å‰ã€‚é‚£ä¹ˆå¦‚ä½•æ¥å¤„ç†consumerå‘é€è¿‡æ¥çš„è¯·æ±‚å‘¢ï¼Ÿå‰ææ˜¯å¾—çŸ¥é“consumerç«¯åˆ°åº•è¦ä»€ä¹ˆã€‚ä¹‹å‰è¯´è¿‡ï¼Œconsumerå°†è¯·æ±‚æŠ¥æ–‡å…¨éƒ¨å°è£…åˆ°<code>MessageWrapper</code>ä¸­ï¼Œè€Œå…¶ä¸­æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„ä¿¡æ¯ï¼š<code>ServiceMetadata</code>ã€‚è¿™ä¸ªå¯¹è±¡æ˜¯ä¸€ä¸ªâ€œåœ°å€â€ï¼Œé€šè¿‡è¿™ä¸ªç©æ„providerå°±èƒ½æ‰¾åˆ°consumeréœ€è¦çš„è°ƒç”¨å¯¹è±¡ä»¥åŠå…¶ä»–ç›¸å…³çš„ä¿¡æ¯ã€‚åŸç†ä¹Ÿå¾ˆç®€å•ï¼Œåœ¨providerå‘å¸ƒçš„æ—¶å€™å°†è¿™ä¸ªâ€œåœ°å€â€åœ¨æœ¬åœ°åšä¸€ä»½æ˜ å°„ä¸å°±å®Œäº†ã€‚åŒæ—¶å°†è¿™ä¸ªåœ°å€å‘é€åˆ°æ³¨å†Œä¸­å¿ƒå»ã€‚è¿™æ ·consumeråˆ°æ³¨å†Œä¸­å¿ƒæ‹¿åˆ°è¿™ä¸ªåœ°å€ç„¶åå‘providerå‘é€è¯·æ±‚çš„æ—¶å€™ï¼Œproviderä¹Ÿå°±èƒ½åšå‡ºå›åº”äº†â€“æ‰¾åˆ°å¯¹åº”çš„â€œæœåŠ¡â€ï¼ˆæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªbeanï¼‰ï¼Œé€šè¿‡consumerçš„è¯·æ±‚å‚æ•°ï¼Œinvokeä¸€ä¸‹ï¼Œçˆ±è¿”å›ç»“æœå°±è¿”å›ç»“æœï¼Œæ²¡æœ‰è¿”å›çš„æ‹‰å€’ã€‚å½“ç„¶æœ‰ç»“æœè¿”å›çš„æƒ…å†µåˆæ¶‰åŠä¸€æ¬¡ç½‘ç»œè¯·æ±‚äº†â€“providerå‘consumerå‘é€å“åº”æ•°æ®ã€‚</p>
<p>å¦‚æ­¤ï¼Œrpcçš„å‰åŠä¸ªè¿‡ç¨‹å°±å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æœ€æœ€æœ€ä¼¤è„‘ç­‹çš„éƒ¨åˆ†â€“è°ƒç”¨ã€‚ä¹Ÿå°±æ˜¯ä¸Šæ–‡æœªå…·ä½“è¯´åˆ°çš„éƒ¨åˆ†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(ServiceWrapper service)</span> </span>&#123;</div><div class="line">        <span class="comment">// stack copy</span></div><div class="line">        <span class="keyword">final</span> JRequest _request = request;</div><div class="line"></div><div class="line">        Context invokeCtx = <span class="keyword">new</span> Context(service);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (TracingUtil.isTracingNeeded()) &#123;</div><div class="line">            setCurrentTraceId(_request.message().getTraceId());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Object invokeResult = Chains.invoke(_request, invokeCtx)</div><div class="line">                    .getResult();</div><div class="line"></div><div class="line">            ResultWrapper result = <span class="keyword">new</span> ResultWrapper();</div><div class="line">            result.setResult(invokeResult);</div><div class="line">            <span class="keyword">byte</span> s_code = _request.serializerCode();</div><div class="line">            Serializer serializer = SerializerFactory.getSerializer(s_code);</div><div class="line"></div><div class="line">            JResponsePayload responsePayload = <span class="keyword">new</span> JResponsePayload(_request.invokeId());</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (CodecConfig.isCodecLowCopy()) &#123;</div><div class="line">                OutputBuf outputBuf =</div><div class="line">                        serializer.writeObject(channel.allocOutputBuf(), result);</div><div class="line">                responsePayload.outputBuf(s_code, outputBuf);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">byte</span>[] bytes = serializer.writeObject(result);</div><div class="line">                responsePayload.bytes(s_code, bytes);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            responsePayload.status(Status.OK.value());</div><div class="line"></div><div class="line">            handleWriteResponse(responsePayload);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            <span class="keyword">if</span> (INVOKE_ERROR == t) &#123;</div><div class="line">                <span class="comment">// handle biz exception</span></div><div class="line">                handleException(invokeCtx.getExpectCauseTypes(), invokeCtx.getCause());</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                processor.handleException(channel, _request, Status.SERVER_ERROR, t);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (TracingUtil.isTracingNeeded()) &#123;</div><div class="line">                TracingUtil.clearCurrent();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ä¸­æœ€é‡è¦çš„ä¸€è¡Œæ˜¯è·å–è°ƒç”¨ç»“æœ<code>invokeResult</code>ã€‚è¿™é‡Œä½¿ç”¨<code>Context</code>å°†<code>ServiceWrapper</code>è¿›è¡Œå°è£…äº†ä¸€ä¸‹ï¼Œç„¶åä½¿ç”¨<code>Chains#invoke</code>è¿›è¡Œè°ƒç”¨ã€‚å…¶ä¸­å°±æ¶‰åŠåˆ°äº†ä¸€ç§è®¾è®¡æ¨¡å¼â€“è´£ä»»é“¾ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Chains</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> JFilterChain headChain;</div><div class="line"></div><div class="line">        <span class="keyword">static</span> &#123;</div><div class="line">            JFilterChain invokeChain = <span class="keyword">new</span> DefaultFilterChain(<span class="keyword">new</span> InvokeFilter(), <span class="keyword">null</span>);</div><div class="line">            JFilterChain interceptChain = <span class="keyword">new</span> DefaultFilterChain(<span class="keyword">new</span> InterceptorsFilter(), invokeChain);</div><div class="line">            headChain = JFilterLoader.loadExtFilters(interceptChain, JFilter.Type.PROVIDER);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">static</span> &lt;T extends JFilterContext&gt; <span class="function">T <span class="title">invoke</span><span class="params">(JRequest request, T invokeCtx)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            headChain.doFilter(request, invokeCtx);</div><div class="line">            <span class="keyword">return</span> invokeCtx;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™ç‚¹ä»£ç å¾ˆç®€å•ï¼Œé¦–å…ˆåœ¨staticä»£ç å—ä¸­åˆå§‹åŒ–äº†å‡ ä¸ªchainã€‚<code>headChain</code>ä¸ºç¬¬ä¸€ä¸ªchainï¼Œé€šè¿‡spiæœºåˆ¶å»åŠ¨æ€åŠ è½½<code>META-INF/services/</code>ç›®å½•ä¸‹çš„é…ç½®æ–‡ä»¶æ¥å®ä¾‹åŒ–<code>JFilterChain</code>.å½“ç„¶åªä¼šå»æ‰¾ç±»å‹ä¸ºproviderçš„chainï¼ŒåŒæ—¶å°†ä¸‹ä¸€ä¸ªchainæ”¾è¿›å»ã€‚è€Œä¸‹ä¸€ä¸ªchainå«åš<code>interceptChain</code>ï¼Œä¹Ÿæ˜¯é¢„å…ˆè¢«åˆå§‹åŒ–äº†ï¼Œå…¶ä¸­çš„filterçš„å®ç°ä¸º<code>InterceptorsFilter</code>,æœ€åä¸€ä¸ªfilterChainä¸º<code>invokeChain</code>ï¼Œé€šè¿‡å‘½åå°±çŸ¥é“è¿™ä¸ªchainæ˜¯çœŸæ­£ç”¨æ¥æ‰§è¡Œå…·ä½“ä¸šåŠ¡å¤„ç†çš„ã€‚ä»–æ²¡æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p>
<p>å…·ä½“çš„è°ƒç”¨é¡ºåºæ˜¯headChainè°ƒç”¨doFilterï¼Œå†…éƒ¨å…¶å®æ˜¯headChainæŒæœ‰çš„filterå®ä¾‹æ¥è°ƒç”¨doFilter,åŒæ—¶å°†headChainæŒæœ‰çš„å®ä¾‹nextChainä½œä¸ºå‚æ•°ä¼ é€’è¿›å»ã€‚å¦‚æœheadChainçš„filterå¤„ç†ä¸äº†ï¼Œå°±è°ƒç”¨nextçš„doFilterï¼Œè€Œnextä¹Ÿæ˜¯åŒæ ·çš„ç»“æ„ï¼Œä¹Ÿèƒ½åšå‡ºåŒæ ·çš„å¤„ç†ï¼Œè¿™æ ·ä¸€å±‚ä¸€å±‚çš„è°ƒç”¨ç›´åˆ°chainçš„å°¾å·´ï¼Œå¾—åˆ°ç»“æœåå†ä¸€å±‚ä¸€å±‚è¿”å›ã€‚</p>
<p>è¿™ç§è®¾è®¡æ€æƒ³éå¸¸å…¸å‹ï¼Œå¾ˆå¤šæ¡†æ¶ä¸­éƒ½æœ‰è´£ä»»é“¾æ¨¡å¼çš„èº«å½±ã€‚è€Œæˆ‘ä»¬è®¨è®ºçš„æ ¸å¿ƒåœ¨invokeChainè¿™ä¸€å±‚ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokeFilter</span> <span class="keyword">implements</span> <span class="title">JFilter</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> Type <span class="title">getType</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> Type.PROVIDER;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="keyword">public</span> &lt;T extends JFilterContext&gt; <span class="function"><span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(JRequest request, T filterCtx, JFilterChain next)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">            MessageWrapper msg = request.message();</div><div class="line">            Context invokeCtx = (Context) filterCtx;</div><div class="line"></div><div class="line">            Object invokeResult = MessageTask.invoke(msg, invokeCtx);</div><div class="line"></div><div class="line">            invokeCtx.setResult(invokeResult);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒdoFilteræ–¹æ³•ä¸­å¹¶æ²¡æœ‰è°ƒç”¨nextï¼Œä¹Ÿè¯å®äº†ä¸€ç‚¹ï¼šè¿™æ˜¯chainçš„å°¾å·´äº†ã€‚å¿…é¡»å¤„ç†ï¼Œä¸å¤„ç†å°±æ²¡äººå¤„ç†äº†ã€‚è€Œè¿™é‡Œå…·ä½“å¤„ç†é€»è¾‘å´åˆå›åˆ°äº†<code>MessageTask#invoke</code>,å…œå…œè½¬è½¬åˆæ˜¯ä¸€åœˆã€‚æœ€ç»ˆå°†è¿”å›çš„ç»“æœä½¿ç”¨<code>Context#setResult</code>è¿›è¡Œå¡«å……ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">invoke</span><span class="params">(MessageWrapper msg, Context invokeCtx)</span> <span class="keyword">throws</span> Signal </span>&#123;</div><div class="line">        ServiceWrapper service = invokeCtx.getService();</div><div class="line">        <span class="comment">// å¾—åˆ°å…·ä½“çš„å®ä¾‹</span></div><div class="line">        Object provider = service.getServiceProvider();</div><div class="line">        <span class="comment">// æ–¹æ³•å</span></div><div class="line">        String methodName = msg.getMethodName();</div><div class="line">        <span class="comment">// æ–¹æ³•å‚æ•°</span></div><div class="line">        Object[] args = msg.getArgs();</div><div class="line"></div><div class="line">		 <span class="comment">// metrics api ç”¨äºç»Ÿè®¡æ•°æ®</span></div><div class="line">        Timer.Context timerCtx = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (METRIC_NEEDED) &#123;</div><div class="line">            timerCtx = Metrics.timer(msg.getOperationName()).time();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Class&lt;?&gt;[] expectCauseTypes = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            List&lt;Pair&lt;Class&lt;?&gt;[], Class&lt;?&gt;[]&gt;&gt; methodExtension = service.getMethodExtension(methodName);</div><div class="line">            <span class="keyword">if</span> (methodExtension == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodException(methodName);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// æ ¹æ®JLSæ–¹æ³•è°ƒç”¨çš„é™æ€åˆ†æ´¾è§„åˆ™æŸ¥æ‰¾æœ€åŒ¹é…çš„æ–¹æ³•parameterTypes</span></div><div class="line">            Pair&lt;Class&lt;?&gt;[], Class&lt;?&gt;[]&gt; bestMatch = Reflects.findMatchingParameterTypesExt(methodExtension, args);</div><div class="line">            Class&lt;?&gt;[] parameterTypes = bestMatch.getFirst();</div><div class="line">            expectCauseTypes = bestMatch.getSecond();</div><div class="line"></div><div class="line">            <span class="keyword">return</span> Reflects.fastInvoke(provider, methodName, parameterTypes, args);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            invokeCtx.setCauseAndExpectTypes(t, expectCauseTypes);</div><div class="line">            <span class="keyword">throw</span> INVOKE_ERROR;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">if</span> (METRIC_NEEDED) &#123;</div><div class="line">                timerCtx.stop();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç æœ‰ç‚¹æ™¦æ¶©éš¾æ‡‚ã€‚å°¤å…¶æ˜¯ä½¿ç”¨é™æ€åˆ†æ´¾è¿™å—é€»è¾‘éå¸¸æ¨¡ç³Šã€‚å»çœ‹ä¸€ä¸‹åå°„è°ƒç”¨çš„ç›¸å…³apiå°±çŸ¥é“ï¼Œä½¿ç”¨åå°„ç”¨åˆ°çš„å‚æ•°å¾—æœ‰æ–¹æ³•åï¼Œæ–¹æ³•å‚æ•°ï¼Œå‚æ•°ç±»å‹ä»¥åŠè°ƒç”¨æ–¹æ³•çš„å¯¹è±¡ã€‚åœ¨<code>ServiceWrapper</code>å®ä¾‹ä¸­å·²ç»æœ‰äº†æ–¹æ³•åï¼Œå‚æ•°ï¼Œè¦è°ƒç”¨çš„æ–¹æ³•å¯¹è±¡å¾ˆæ˜¾ç„¶å°±æ˜¯ä»–è‡ªå·±ï¼Œå°±å‰©ä¸‹ä¸€ä¸ªå‚æ•°ç±»å‹ä¸çŸ¥é“äº†ã€‚å½“ç„¶åœ¨rpcä¸­è¯·æ±‚ç«¯ä¹Ÿæ²¡æ³•å§å‚æ•°ç±»å‹ç»™ä½ ä¼ è¿‡æ¥ï¼Œè¿™é‡Œéœ€è¦è‡ªå·±å»åˆ¤æ–­äº†ã€‚è€Œ<code>Reflects.findMatchingParameterTypesExt</code>å°±æ˜¯æ ¹æ®å‚æ•°æ¥åˆ¤æ–­å‚æ•°ç±»å‹åˆ°åº•æ˜¯ä»€ä¹ˆã€‚æœ€ç»ˆä½¿ç”¨<code>Reflects.fastInvoke(provider, methodName, parameterTypes, args);</code>æ¥å®Œæˆè°ƒç”¨ã€‚ä»è¿™é‡Œçœ‹åˆ°å‚æ•°ç¡®å®æ˜¯åˆšæ‰æåˆ°çš„å››ä¸ªå‚æ•°ï¼Œç¼ºä¸€ä¸å¯ã€‚ç„¶è€Œè¿™é‡Œå¹¶æ²¡æœ‰å»ä½¿ç”¨åå°„è°ƒç”¨çš„ï¼Œè€Œæ˜¯ä½¿ç”¨å­—èŠ‚ç ç›´æ¥ç”Ÿæˆå­ç±»ï¼ˆä½†æ˜¯åå°„çš„æœ¬è´¨ä¸å°±æ˜¯ç”Ÿæˆå­ç±»å—ï¼Ÿæœ‰ç‚¹æ‡µé€¼ï¼‰ã€‚å…¶å®è¿˜æ˜¯æœ‰ä¸€ç‚¹åŒºåˆ«çš„ï¼Œåœ¨ä½¿ç”¨åå°„çš„æ—¶å€™ï¼Œä»¥jdkåå°„ä¸ºä¾‹ï¼Œæ¯ä»£ç†ä¸€ä¸ªæ–¹æ³•å°±ä¼šç”Ÿæˆä¸€ä¸ªä»£ç†ç±»ï¼Œåœ¨éœ€è¦å¾ˆå¤šä»£ç†æ–¹æ³•éœ€è¦è¢«è°ƒç”¨çš„æ—¶å€™å°±å›ç”Ÿæˆå¾ˆå¤šä¸ªä»£ç†ç±»ï¼Œè¿™æ ·å°±å¾ˆæ¶ˆè€—æ€§èƒ½ã€‚è€Œè¿™é‡Œä½¿ç”¨çš„æ˜¯é€šè¿‡å­—èŠ‚ç å·¥å…·è‡ªå·±ç”Ÿæˆä¸€ä¸ªå­ç±»ï¼Œå¹¶ä¸”ç¼“å­˜ä¸‹æ¥ï¼Œè¿™æ ·èŠ‚çœå¾ˆå¤šæ€§èƒ½ã€‚åœ¨benchmarkä¸­è·‘çš„ç»“æœç¡®å®æ¯”jdkåå°„æ€§èƒ½è¦å¥½å¾ˆå¤šã€‚å…·ä½“çš„ä»£ç å®ç°å°±ä¸å»çº ç»“äº†ï¼Œåæ­£ä¹Ÿçœ‹ä¸æ˜ç™½ï¼Œè¿™é‡Œå°±å½“ä½œæ˜¯åå°„è°ƒç”¨å°±è¡Œäº†ã€‚å…³äºJavaè¯­è¨€çš„è¿™ç§â€œåŠ¨æ€â€ç‰¹æ€§æˆ‘ä¸å¾—ä¸åæ§½ä¸€ä¸‹ï¼Œè™½è¯´æä¾›äº†ä¸€ç§åŸºäºè¿è¡Œæ—¶çš„ä¿®æ”¹ç¨‹åºçš„è¡Œä¸ºæœºåˆ¶ï¼Œä½†æ˜¯çœŸçš„æ˜¯å¾ˆéº»çƒ¦ï¼Œå…‰çœ‹apiéƒ½ä¼šæŠŠäººç»™ææ™•ï¼Œéå¸¸ä¸å‹å¥½ã€‚è€Œç°åœ¨å¾ˆå¤šåŠ¨æ€è¯­è¨€å°±å¾ˆäººæ€§åŒ–ï¼Œæƒ³æ”¹å°±æ”¹ï¼Œéå¸¸è½»æ¾ã€‚å…¶å®æˆ‘è¿˜æ˜¯å¾ˆå–œæ¬¢Javascriptçš„ã€‚</p>
<p>æœ€ç»ˆï¼Œæ•´ä¸ªè°ƒç”¨çš„é€»è¾‘éƒ½å®Œå®Œå…¨å…¨èµ°é€šäº†ã€‚å½“ç„¶ï¼Œè¿™åªæ˜¯åŸºäºæ­£å¸¸çš„è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰å‡ºç°å¼‚å¸¸çš„æƒ…å†µã€‚å¦‚æœå‡ºç°äº†å¼‚å¸¸æƒ…å†µæ”¹æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿæ¯”å¦‚è¯´ç©ºæŒ‡é’ˆï¼Œé™¤æ•°ä¸º0ç­‰æƒ…å†µã€‚åœ¨invokeçš„é€»è¾‘ä¸­ï¼Œç›´æ¥å°†<code>Throwable</code>æ•è·åˆ°ï¼Œå¡è¿›<code>Context</code>ä¸­ï¼Œæœ€åæŠ›å‡ºå¼‚å¸¸ã€‚åœ¨processé€»è¾‘ä¹Ÿé‡Œä¼šæœ‰æ•è·åŠ¨ä½œï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleException</span><span class="params">(Class&lt;?&gt;[] exceptionTypes, Throwable failCause)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (exceptionTypes != <span class="keyword">null</span> &amp;&amp; exceptionTypes.length &gt; <span class="number">0</span>) &#123;</div><div class="line">            Class&lt;?&gt; failType = failCause.getClass();</div><div class="line">            <span class="keyword">for</span> (Class&lt;?&gt; eType : exceptionTypes) &#123;</div><div class="line">                <span class="comment">// å¦‚æœæŠ›å‡ºå£°æ˜å¼‚å¸¸çš„å­ç±», å®¢æˆ·ç«¯å¯èƒ½ä¼šå› ä¸ºä¸å­˜åœ¨å­ç±»ç±»å‹è€Œæ— æ³•åºåˆ—åŒ–, ä¼šåœ¨å®¢æˆ·ç«¯æŠ›å‡ºæ— æ³•ååºåˆ—åŒ–å¼‚å¸¸</span></div><div class="line">                <span class="keyword">if</span> (eType.isAssignableFrom(failType)) &#123;</div><div class="line">                    <span class="comment">// é¢„æœŸå†…çš„å¼‚å¸¸</span></div><div class="line">                    processor.handleException(channel, request, Status.SERVICE_EXPECTED_ERROR, failCause);</div><div class="line">                    <span class="keyword">return</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// é¢„æœŸå¤–çš„å¼‚å¸¸</span></div><div class="line">        processor.handleException(channel, request, Status.SERVICE_UNEXPECTED_ERROR, failCause);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è™½ç„¶è¿™æ®µä»£ç æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯æ ¸å¿ƒå°±åªæœ‰ä¸€ç‚¹ï¼Œå¤„ç†å¼‚å¸¸æ¶ˆæ¯ã€‚è€Œæ­£çœŸåšè¿™ä»¶äº‹äº¤ç»™äº†processorï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doHandleException</span><span class="params">(</span></span></div><div class="line">            JChannel channel, <span class="keyword">long</span> invokeId, <span class="keyword">byte</span> s_code, <span class="keyword">byte</span> status, Throwable cause, <span class="keyword">boolean</span> closeChannel) &#123;</div><div class="line"></div><div class="line">        ResultWrapper result = <span class="keyword">new</span> ResultWrapper();</div><div class="line">        <span class="comment">// æˆªæ–­cause, é¿å…å®¢æˆ·ç«¯æ— æ³•æ‰¾åˆ°causeç±»å‹è€Œæ— æ³•åºåˆ—åŒ–</span></div><div class="line">        cause = ThrowUtil.cutCause(cause);</div><div class="line">        result.setError(cause);</div><div class="line"></div><div class="line">        Serializer serializer = SerializerFactory.getSerializer(s_code);</div><div class="line"></div><div class="line">        JResponsePayload response = <span class="keyword">new</span> JResponsePayload(invokeId);</div><div class="line">        response.status(status);</div><div class="line">        <span class="keyword">if</span> (CodecConfig.isCodecLowCopy()) &#123;</div><div class="line">            OutputBuf outputBuf =</div><div class="line">                    serializer.writeObject(channel.allocOutputBuf(), result);</div><div class="line">            response.outputBuf(s_code, outputBuf);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">byte</span>[] bytes = serializer.writeObject(result);</div><div class="line">            response.bytes(s_code, bytes);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (closeChannel) &#123;</div><div class="line">            channel.write(response, JChannel.CLOSE);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            channel.write(response, <span class="keyword">new</span> JFutureListener&lt;JChannel&gt;() &#123;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationSuccess</span><span class="params">(JChannel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    logger.debug(<span class="string">"Service error message sent out: &#123;&#125;."</span>, channel);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationFailure</span><span class="params">(JChannel channel, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</div><div class="line">                        logger.warn(<span class="string">"Service error message sent failed: &#123;&#125;, &#123;&#125;."</span>, channel, stackTrace(cause));</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æ— éå°±æ˜¯å°†å¼‚å¸¸å¯¹è±¡å†™å‡ºå»ï¼Œå½“ç„¶ä¹Ÿä¸ä¸€å®šæ˜¯å¼‚å¸¸å¯¹è±¡ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ­£å¸¸å¯¹è±¡ï¼Œç®¡ä»–å‘¢ï¼Œåæ­£éƒ½æ˜¯å¯¹è±¡ï¼Œå®¢æˆ·ç«¯èƒ½å¤Ÿé€šè¿‡statusè‡ªè¡Œå»åˆ¤æ–­åˆ°åº•æ˜¯ä»€ä¹ˆç±»å‹ã€‚è¿™æ ·å­ï¼Œå®¢æˆ·ç«¯è°ƒç”¨ä¸€ä¸ªrpcæ–¹æ³•å°±åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ï¼Œä¹Ÿå¯ä»¥æ‰“å°æ­£å¸¸çš„å¼‚å¸¸æ ˆä¿¡æ¯ï¼Œä½†æ˜¯åªèƒ½çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆå¼‚å¸¸ï¼Œæ²¡åŠæ³•å»å®šä½åˆ°å“ªä¸€è¡Œæœ‰é—®é¢˜ï¼Œè¿™æ˜¯å¾ˆå°´å°¬çš„ã€‚å½“ç„¶å®é™…ç”Ÿæˆä¸­è¿™å’Œä½ è°ƒç”¨æ–¹å…³ç³»ä¸å¤§ï¼Œåªéœ€è¦éµå¾ªä¸€ä¸ªåŸåˆ™ï¼šè°å†™çš„bugè°å»æ”¹ã€‚è½»æ¾ç”©é”…ã€‚</p>
<p>ç»ˆäºï¼Œproviderçš„æ ¸å¿ƒåŸºæœ¬ä¸Šå†™å®Œäº†ï¼Œè¿˜æœ‰å¾ˆå¤šç»†èŠ‚éœ€è¦æ…¢æ…¢åœ°ç†ä¸€éï¼Œæ¯•ç«Ÿæ¶‰åŠåˆ°å¾ˆå¤šçŸ¥è¯†ç›²åŒºï¼Œéœ€è¦æ—¶é—´æ…¢æ…¢æ¶ˆåŒ–ã€‚å†™åˆ°è¿™é‡Œæˆ‘æ‰å‘ç°è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå…³é”®çš„ç‚¹æ²¡æœ‰æ¶‰åŠåˆ°ï¼Œé‚£å°±æ˜¯æœåŠ¡çš„å‘å¸ƒã€‚æ¥ä¸‹æ¥çš„ä¸€ç¯‡æ–‡ç« ä¼šç®€å•æ¦‚è¿°provideræ˜¯æ€ä¹ˆâ€œå‘å¸ƒâ€å‡ºå»çš„ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è®²åˆ°äº†providerä¸­é’ˆå¯¹consumerçš„è¯·æ±‚æ¶ˆæ¯å°è£…&lt;code&gt;MessageTask&lt;/code&gt;çš„éƒ¨åˆ†ç»†èŠ‚ã€‚ç•™ä¸‹äº†æœ€æ ¸å¿ƒçš„å¤„ç†æ¶ˆæ¯çš„ç»†èŠ‚&lt;code&gt;process&lt;/code&gt;æ–¹æ³•æ²¡æœ‰è¯´ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ç»§ç»­å¯¹æ‰€è°“çš„æ ¸å¿ƒé€»è¾‘æ¢³ç†ä¹‹å‰ï¼Œå…ˆæ•´ä½“çš„æ‹ä¸€æ‹
    
    </summary>
    
      <category term="ä¸€èµ·è¯»æºç " scheme="http://www.wei-dong.top/categories/%E4%B8%80%E8%B5%B7%E8%AF%BB%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="Jupiter" scheme="http://www.wei-dong.top/tags/Jupiter/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€èµ·å­¦RPC(ä¸‰)</title>
    <link href="http://www.wei-dong.top/2018/08/21/%E4%B8%80%E8%B5%B7%E5%AD%A6RPC(%E4%B8%89)/"/>
    <id>http://www.wei-dong.top/2018/08/21/ä¸€èµ·å­¦RPC(ä¸‰)/</id>
    <published>2018-08-21T08:17:23.000Z</published>
    <updated>2018-08-21T08:24:45.776Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è®²åˆ°jupiterçš„ä¼ è¾“æ¨¡å—transportä¸­çš„ç¼–è§£ç å™¨çš„å®ç°ã€‚å¯¹serveræ¥è¨€ï¼Œç¼–è§£ç å™¨æ‰®æ¼”ç€ä¸€å¤´ä¸€å°¾çš„é—¨å«è§’è‰²ï¼Œä¿è¯è¿›æ¥çš„äººæ˜¯å¹²å‡€çš„ï¼Œä¹Ÿå¾—ä¿è¯å‡ºå»çš„äººä¹Ÿæ˜¯å¹²å‡€çš„ã€‚å½“ç„¶è¿™ä¹ˆæ¯”å–»å¾ˆä¸æ°å½“ï¼Œä½†æ˜¯ä¹Ÿæƒ³ä¸åˆ°åˆ«çš„æ¯”å–»äº†ã€‚</p>
<p>ç¼–è§£ç å™¨å›ºç„¶é‡è¦ï¼Œä½†æ˜¯æ²¡æœ‰æ ¸å¿ƒçš„ä¸šåŠ¡å¤„ç†å™¨ä¹Ÿæ²¡å¤šå¤§æ„ä¹‰ã€‚æœ¬æ–‡çš„é‡ç‚¹å°±æ˜¯æ ¸å¿ƒå¤„ç†å™¨ï¼š<code>AcceptorHandler</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ChannelHandler</span>.Sharable</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AcceptorHandler</span> <span class="keyword">extends</span> <span class="title">ChannelInboundHandlerAdapter</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> ProviderProcessor processor;</div><div class="line">	<span class="comment">// ...</span></div><div class="line">	<span class="function"><span class="keyword">public</span> ProviderProcessor <span class="title">processor</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> processor;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processor</span><span class="params">(ProviderProcessor processor)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.processor = processor;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¦å®ç°ä¸€ä¸ªhandlerå¾ˆå®¹æ˜“ï¼Œç›´æ¥ç»§æ‰¿<code>ChannelInboundHandlerAdapter</code>å°±è¡Œäº†ã€‚å½“ç„¶è¿™æ˜¯é’ˆå¯¹serveræ¥è¯´çš„ã€‚æ ¹æ®ç±»åæ¥çœ‹ï¼Œæ­£å¸¸æƒ…å†µä¸‹é¦–å…ˆä¼šè”æƒ³åˆ°è‚¯å®šä¼šæœ‰ä¸ªä¸ä¹‹å¯¹åº”çš„ã€‚é’ˆå¯¹serveræ¥è¯´ï¼Œè¦å¤„ç†çš„å°±æ˜¯å…¥ç«™æ•°æ®ï¼Œä½¿ç”¨inboundå°±è¡Œäº†ã€‚å¦‚æœæœ‰æ›´åŠ å¤æ‚çš„é€»è¾‘å¤„ç†ï¼Œå¯ä»¥å»çœ‹çœ‹å®˜æ–¹æ–‡æ¡£ä¸­å…¶ä»–çš„æ´¾ç”Ÿç±»ã€‚åŒæ—¶ï¼Œè¿™ä¸ªå®ä¾‹ä¹Ÿæ˜¯èƒ½å¤Ÿè¢«å…±äº«çš„ï¼Œé“ç†ä¹Ÿå¾ˆç®€å•ï¼šæ²¡æœ‰çŠ¶æ€ã€‚ä¹Ÿè®¸ä½ ä¼šé—®ï¼šè¿™é‡Œåˆ†æ˜æ˜¯æœ‰æˆå‘˜å˜é‡çš„å‘€ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªæˆå‘˜å˜é‡æ˜¯ä¸ä¼šè¢«æ”¹å˜çš„ã€‚å¦‚æœå‘ç”Ÿäº†å˜åŒ–ï¼Œè¿™ä¸ªç¨‹åºè®¾è®¡ä¸Šå°±æœ‰é—®é¢˜ã€‚ç†è®ºä¸Šæ˜¯ç»å¯¹ä¸å…è®¸æ”¹å˜çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       Channel ch = ctx.channel();</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> JRequestPayload) &#123;</div><div class="line">           JChannel jChannel = NettyChannel.attachChannel(ch);</div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               processor.handleRequest(jChannel, (JRequestPayload) msg);</div><div class="line">           &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">               processor.handleException(jChannel, (JRequestPayload) msg, Status.SERVER_ERROR, t);</div><div class="line">           &#125;</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           logger.warn(<span class="string">"Unexpected message type received: &#123;&#125;, channel: &#123;&#125;."</span>, msg.getClass(), ch);</div><div class="line"></div><div class="line">           ReferenceCountUtil.release(msg);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       <span class="keyword">int</span> count = channelCounter.incrementAndGet();</div><div class="line"></div><div class="line">       logger.info(<span class="string">"Connects with &#123;&#125; as the &#123;&#125;th channel."</span>, ctx.channel(), count);</div><div class="line"></div><div class="line">       <span class="keyword">super</span>.channelActive(ctx);</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       <span class="keyword">int</span> count = channelCounter.getAndDecrement();</div><div class="line"></div><div class="line">       logger.warn(<span class="string">"Disconnects with &#123;&#125; as the &#123;&#125;th channel."</span>, ctx.channel(), count);</div><div class="line"></div><div class="line">       <span class="keyword">super</span>.channelInactive(ctx);</div><div class="line">   &#125;</div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelWritabilityChanged</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       Channel ch = ctx.channel();</div><div class="line">       ChannelConfig config = ch.config();</div><div class="line"></div><div class="line">       <span class="comment">// é«˜æ°´ä½çº¿: ChannelOption.WRITE_BUFFER_HIGH_WATER_MARK</span></div><div class="line">       <span class="comment">// ä½æ°´ä½çº¿: ChannelOption.WRITE_BUFFER_LOW_WATER_MARK</span></div><div class="line">       <span class="keyword">if</span> (!ch.isWritable()) &#123;</div><div class="line">           <span class="comment">// å½“å‰channelçš„ç¼“å†²åŒº(OutboundBuffer)å¤§å°è¶…è¿‡äº†WRITE_BUFFER_HIGH_WATER_MARK</span></div><div class="line">           <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</div><div class="line">               logger.warn(<span class="string">"&#123;&#125; is not writable, high water mask: &#123;&#125;, the number of flushed entries that are not written yet: &#123;&#125;."</span>,</div><div class="line">                       ch, config.getWriteBufferHighWaterMark(), ch.unsafe().outboundBuffer().size());</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           config.setAutoRead(<span class="keyword">false</span>);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">// æ›¾ç»é«˜äºé«˜æ°´ä½çº¿çš„OutboundBufferç°åœ¨å·²ç»ä½äºWRITE_BUFFER_LOW_WATER_MARKäº†</span></div><div class="line">           <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</div><div class="line">               logger.warn(<span class="string">"&#123;&#125; is writable(rehabilitate), low water mask: &#123;&#125;, the number of flushed entries that are not written yet: &#123;&#125;."</span>,</div><div class="line">                       ch, config.getWriteBufferLowWaterMark(), ch.unsafe().outboundBuffer().size());</div><div class="line">           &#125;</div><div class="line"></div><div class="line">           config.setAutoRead(<span class="keyword">true</span>);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>AcceptorHandler</code>é‡å†™äº†å‡ ä¸ªæ–¹æ³•ã€‚æ³¨æ„ï¼Œé‡å†™<code>channelRead()</code>æ–¹æ³•çš„æ—¶å€™è®°å¾—è°ƒç”¨<code>ReferenceCountUtil.release(msg)</code>ã€‚</p>
<p>å…¶ä¸­æœ€æ ¸å¿ƒçš„é€»è¾‘åœ¨<code>channelRead()</code>ä¸­å¤„ç†ã€‚æ— éå°±æ˜¯å°†è§£ç å™¨ä¸­ååºåˆ—åŒ–åçš„å¯¹è±¡è¿›è¡Œå¤„ç†ç½¢äº†ã€‚å½“ç„¶è¿™é‡Œæ¥å—çš„ä»…ä»…æ˜¯<code>JRequestPayload</code>ç±»å‹ã€‚ç„¶åå°†Nettyçš„åŸç”Ÿ<code>Channel</code>è½¬åŒ–ä¸ºè‡ªå®šä¹‰çš„<code>JChannel</code>ç±»å‹ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†å°†apiç»Ÿä¸€ï¼Œæ–¹ä¾¿æ¥å…¥å…¶ä»–ç½‘ç»œåº“å®ç°ã€‚ä¹Ÿå°±è¯´å¦‚æœè¦æ¢åˆ«çš„ç½‘ç»œæ¡†æ¶å¦‚minaï¼Œä¸éœ€è¦å»æ”¹åŠ¨æˆ‘ä¸šåŠ¡çš„ä»£ç ï¼Œåªéœ€é’ˆå¯¹åˆ«çš„ç½‘ç»œåº“çš„apiè¿›è¡Œç¼–ç å³å¯ã€‚ç„¶åä½¿ç”¨<code>ProviderProcessor</code>æ¥å¤„ç†å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚è¿™ä¸ªæ¥å£ä¸­æä¾›äº†ä¸¤ä¸ªæ“ä½œï¼š<code>handleRequest</code>å’Œ <code>handleException</code>.å› æ­¤å…·ä½“çš„ä¸šåŠ¡é€»è¾‘å¤„ç†å…¨éƒ¨éƒ½ä¼ é€’ç»™<code>ProviderProcessor</code>å®ç°äº†ã€‚</p>
<p>è€Œ<code>channelWritabilityChanged</code>æ–¹æ³•åœ¨å¯å†™çŠ¶æ€å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ä¼šè¢«è°ƒç”¨ã€‚å¯ä»¥é€šè¿‡<code>Channel#isWritable()</code>æ–¹æ³•æ¥è·å–çŠ¶æ€ã€‚è€Œè¿™é‡Œå¯¹å…¶é‡å†™æ˜¯ä¸ºäº†åˆ¤æ–­OutboundBufferçš„å¤§å°æœ‰æ²¡æœ‰è¶…è¿‡é«˜æ°´ä½çº¿ï¼Œè¿™é‡Œçš„æ°´ä½çº¿æ˜¯åœ¨<code>ChannelConfig</code>ä¸­è®¾ç½®çš„ï¼Œserveråˆå§‹åŒ–çš„æ—¶å€™ã€‚è¶…è¿‡é«˜æ°´ä½çº¿å°±ä¸å…è®¸è‡ªåŠ¨å»è¯»æ•°æ®äº†ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹ç–‘æƒ‘ï¼Œä¸æ¸…æ¥šä¸ºä»€ä¹ˆéœ€è¦è°ƒç”¨<code>config.setAutoRead(false)</code>ã€‚ä¸€ä¸ªæ¯”è¾ƒæ¨¡ç³Šçš„æ¦‚å¿µæ˜¯Nettyçš„å†™åŠ¨ä½œå¹¶ä¸æ˜¯ç›´æ¥å‘socketä¸­å†™ï¼Œè€Œæ˜¯å†™åˆ°Nettyä¸­çš„ç¼“å†²åŒºä¸­ï¼Œè¿™ä¸ªç¼“å†²åŒºå«åš<code>ChannelOutboundBuffer</code>ï¼Œè€Œè¿™ä¸ªbufferçš„å®ç°æ˜¯ä½¿ç”¨çš„æ— ç•Œé“¾è¡¨ï¼Œå¦‚æœå¯¹æ–¹çš„æ¥å—å¤ªæ…¢ï¼Œå°±ä¼šå¯¼è‡´è¿™ä¸ªé“¾è¡¨æ— é™å¤§ï¼Œæœ€åæƒ…å†µä¼šå¯¼è‡´OOMã€‚å› æ­¤æä¾›ä¸€ç§æœºåˆ¶ï¼šè®¾ç½®æ°´ä½çº¿ã€‚å¦‚æœè¶…è¿‡æ°´ä½çº¿å°±è®©ç”¨æˆ·æ¥è‡ªå·±å†³å®šæ€ä¹ˆå¤„ç†ï¼Œå…·ä½“åšæ³•å°±æ˜¯è°ƒç”¨<code>channelWritabilityChanged</code>æ–¹æ³•ã€‚è¿™é‡Œçš„è¿™ä¸ªæ–¹æ³•å°†è‡ªåŠ¨è¯»å…³é—­äº†ï¼Œè¿™é‡Œé¢å¤§æœ‰ç„æœºã€‚å…¶å®æ˜¯åˆ©ç”¨äº†TCPçš„æ»‘åŠ¨çª—å£æ¥æ§åˆ¶çš„ã€‚</p>
<blockquote>
<p>æ¯”å¦‚å’±ä¿©å–é…’, ä½ å–å®Œä¸€æ¯æˆ‘å°±ç«‹åˆ»ç»™ä½ æ»¡ä¸Š, æœ€ç»ˆä½ å–ä¸åŠ¨äº† ,<br>ä¸å†ä¸¾èµ·æ¯å­â€¦. ä½ çš„æ¯å­ä¸€ç›´æ˜¯æ»¡çš„, æˆ‘ä¹Ÿæ²¡æ³•ç»§ç»­ç»™ä½ å€’é…’</p>
</blockquote>
<p>è¿™ä¸ªæ —å­å¾ˆå½¢è±¡åœ°è§£é‡Šäº†æ»‘åŠ¨çª—å£ã€‚ç»“åˆè¿™ä¸ª<a href="https://media.pearsoncmg.com/aw/ecs_kurose_compnetwork_7/cw/content/interactiveanimations/selective-repeat-protocol/index.html" target="_blank" rel="external">åŠ¨ç”»</a>æ›´ç›´è§‚ã€‚</p>
<p><a href="http://www.cnblogs.com/rainy-shurun/p/5213086.html" target="_blank" rel="external">è¿™é‡Œ</a>æœ‰ä¸€ç¯‡æ–‡ç« å€¼å¾—å‚è€ƒã€‚</p>
<p><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/water-2018-08-06-10-52-13.jpg?raw=true" alt="image"></p>
<p>æ¥ä¸‹æ¥è¦è®¨è®ºçš„æ˜¯è¿™ä¸ª<code>processor</code>åˆ°åº•æ˜¯æ€ä¹ˆå¤„ç†æ¶ˆæ¯çš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> InternalLogger logger = InternalLoggerFactory.getInstance(DefaultProviderProcessor.class);</div><div class="line"></div><div class="line">   <span class="keyword">private</span> <span class="keyword">final</span> CloseableExecutor executor;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">DefaultProviderProcessor</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>(ProviderExecutors.executor());</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">DefaultProviderProcessor</span><span class="params">(CloseableExecutor executor)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>.executor = executor;</div><div class="line">   &#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRequest</span><span class="params">(JChannel channel, JRequestPayload requestPayload)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       MessageTask task = <span class="keyword">new</span> MessageTask(<span class="keyword">this</span>, channel, <span class="keyword">new</span> JRequest(requestPayload));</div><div class="line">       <span class="keyword">if</span> (executor == <span class="keyword">null</span>) &#123;</div><div class="line">           task.run();</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           executor.execute(task);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>å…¶å®ä¸éš¾æƒ³åˆ°ï¼Œ<code>handleRequest</code>æ–¹æ³•ä¸­å°†æ¥å—åˆ°çš„æ•°æ®åšäº†ä¸€å±‚å°è£…ï¼Œç„¶åä¸¢ç»™çº¿ç¨‹æ± å»å¤„ç†ã€‚åœ¨Nettyä¸­ï¼Œä¸šåŠ¡å¤„ç†é€»è¾‘ç»å¯¹ä¸èƒ½æ”¾åœ¨IOçº¿ç¨‹ä¸­æ‰§è¡Œã€‚IOçº¿ç¨‹åªè´Ÿè´£è¯»å–/å‘é€æ•°æ®ï¼Œä¸èƒ½è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚è¿™æ˜¯å› ä¸ºå¦‚æœä¸šåŠ¡é€»è¾‘ä¸­æœ‰è€—æ—¶çš„æ“ä½œå°±ä¼šå°†IOçº¿ç¨‹é˜»å¡ä½ï¼Œè¿™æ ·æ­£å¸¸çš„è¯·æ±‚ä¹Ÿå°±è¢«é˜»å¡äº†ï¼Œå½±å“åº”ç”¨çš„æ€§èƒ½ã€‚è€Œè¿™é‡Œçš„çº¿ç¨‹æ± ä¹Ÿè¢«è‡ªå®šä¹‰äº†ã€‚</p>
<p><code>CloseableExecutor</code>æ˜¯ä¸€ä¸ªæ¥å£ç±»å‹ï¼Œæ­£çœŸçš„å®ç°ç±»æ˜¯é€šè¿‡SPIæœºåˆ¶ç”±å·¥å‚åˆ›å»ºå‡ºæ¥çš„ã€‚å…³äºSPIæœºåˆ¶è¿™é‡Œä¸ä¼šå±•å¼€ï¼Œå°†å•ç‹¬å»æ•´ç†ä¸€ç¯‡æ–‡ç« æ¥è¯´æ˜ã€‚è¿™ç§æœºåˆ¶åœ¨å¾ˆå¤šæ¡†æ¶ä¸­éƒ½æœ‰ä½“ç°ã€‚</p>
<p>è€ŒåŒ…è£…ç±»<code>MessageTask</code>çš„å®ç°å°±å¾ˆå…³é”®äº†ã€‚æ—¢ç„¶è¿™ä¸ªå¯¹è±¡èƒ½æ”¾åˆ°çº¿ç¨‹æ± ä¸­ï¼Œé‚£ä¹ˆä¸€å®šæ˜¯ä¸€ä¸ª<code>Runnable</code>æˆ–è€…<code>Callable</code>çš„å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="comment">// stack copy</span></div><div class="line">       <span class="keyword">final</span> DefaultProviderProcessor _processor = processor;</div><div class="line">       <span class="keyword">final</span> JRequest _request = request;</div><div class="line"></div><div class="line">       <span class="comment">// å…¨å±€æµé‡æ§åˆ¶</span></div><div class="line">       ControlResult ctrl = _processor.flowControl(_request);</div><div class="line">       <span class="keyword">if</span> (!ctrl.isAllowed()) &#123;</div><div class="line">           rejected(Status.APP_FLOW_CONTROL, <span class="keyword">new</span> JupiterFlowControlException(String.valueOf(ctrl)));</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       MessageWrapper msg;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           JRequestPayload _requestPayload = _request.payload();</div><div class="line"></div><div class="line">           <span class="keyword">byte</span> s_code = _requestPayload.serializerCode();</div><div class="line">           Serializer serializer = SerializerFactory.getSerializer(s_code);</div><div class="line"></div><div class="line">           <span class="comment">// åœ¨ä¸šåŠ¡çº¿ç¨‹ä¸­ååºåˆ—åŒ–, å‡è½»IOçº¿ç¨‹è´Ÿæ‹…</span></div><div class="line">           <span class="keyword">if</span> (CodecConfig.isCodecLowCopy()) &#123;</div><div class="line">               InputBuf inputBuf = _requestPayload.inputBuf();</div><div class="line">               msg = serializer.readObject(inputBuf, MessageWrapper.class);</div><div class="line">           &#125; <span class="keyword">else</span> &#123;</div><div class="line">               <span class="keyword">byte</span>[] bytes = _requestPayload.bytes();</div><div class="line">               msg = serializer.readObject(bytes, MessageWrapper.class);</div><div class="line">           &#125;</div><div class="line">           _requestPayload.clear();</div><div class="line"></div><div class="line">           _request.message(msg);</div><div class="line">       &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">           rejected(Status.BAD_REQUEST, <span class="keyword">new</span> JupiterBadRequestException(<span class="string">"reading request failed"</span>, t));</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// æŸ¥æ‰¾æœåŠ¡</span></div><div class="line">       <span class="keyword">final</span> ServiceWrapper service = _processor.lookupService(msg.getMetadata());</div><div class="line">       <span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</div><div class="line">           rejected(Status.SERVICE_NOT_FOUND, <span class="keyword">new</span> JupiterServiceNotFoundException(String.valueOf(msg)));</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// providerç§æœ‰æµé‡æ§åˆ¶</span></div><div class="line">       FlowController&lt;JRequest&gt; childController = service.getFlowController();</div><div class="line">       <span class="keyword">if</span> (childController != <span class="keyword">null</span>) &#123;</div><div class="line">           ctrl = childController.flowControl(_request);</div><div class="line">           <span class="keyword">if</span> (!ctrl.isAllowed()) &#123;</div><div class="line">               rejected(Status.PROVIDER_FLOW_CONTROL, <span class="keyword">new</span> JupiterFlowControlException(String.valueOf(ctrl)));</div><div class="line">               <span class="keyword">return</span>;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="comment">// processing</span></div><div class="line">       Executor childExecutor = service.getExecutor();</div><div class="line">       <span class="keyword">if</span> (childExecutor == <span class="keyword">null</span>) &#123;</div><div class="line">           process(service);</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">// providerç§æœ‰çº¿ç¨‹æ± æ‰§è¡Œ</span></div><div class="line">           childExecutor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">               <span class="meta">@Override</span></div><div class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                   process(service);</div><div class="line">               &#125;</div><div class="line">           &#125;);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç ååˆ†ç®€æ´ã€‚é¦–å…ˆå°†å…¨å±€å˜é‡èµ‹å€¼ä¸ºå±€éƒ¨å˜é‡ï¼Œæˆ‘ä¾ç¨€è®°å¾—åœ¨ä¸€ä¸ªè€å¤–çš„ä»£ç ä¸­çœ‹åˆ°è¿‡ï¼Œç›®çš„å¤§æ¦‚æ˜¯ä¸ºäº†èŠ‚çœæ€§èƒ½ã€‚æ¥ä¸‹æ¥å°±æ˜¯å…¨å±€æµé‡æ§åˆ¶ï¼Œæ‰€è°“çš„æµé‡æ§åˆ¶ç®€å•ç†è§£ä¸ºé˜²æ­¢è¯·æ±‚å¤ªçŒ›å¯¼è‡´æœåŠ¡å®æ‰ã€‚æœ‰å…¨å±€çš„å°±ä¸€å®šæœ‰å±€éƒ¨çš„ã€‚è€Œå±€éƒ¨çš„æ§åˆ¶æ˜¯é’ˆå¯¹rpcä¸­å¯¹å¤–æš´éœ²æŸä¸ªæœåŠ¡ã€‚å…¶ç²’åº¦æ›´å°ä¸€ç‚¹ã€‚ç„¶åå°±æ˜¯ååºåˆ—åŒ–äº†ï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨ç¼–è§£ç å™¨ä¸­ä¹Ÿèƒ½å®Œæˆï¼Œä½†æ˜¯ä½œè€…å¹¶æ²¡æœ‰è¿™ä¹ˆåšã€‚ç›®çš„ä¹Ÿå¾ˆç®€å•ï¼Œæ¯•ç«Ÿåºåˆ—åŒ–æ˜¯æ¯”è¾ƒè€—æ€§èƒ½çš„ï¼Œå†è¯´äº†ï¼Œç¼–è§£ç å™¨å®é™…ä¸Šä¹Ÿæ˜¯åœ¨IOçº¿ç¨‹ä¸­å¤„ç†çš„ã€‚è¿™ä¹ˆåšä¹Ÿæ˜¯ä¸ºäº†å‡è½»IOçº¿ç¨‹è´Ÿæ‹…ã€‚ç´§æ¥ç€å°±æ˜¯å°†åºåˆ—åŒ–åçš„å¯¹è±¡ä¸­çš„<code>ServiceMetadata</code>å–å‡ºæ¥ ï¼Œé€šè¿‡è¿™ä¸ªå¯¹è±¡å»æœ¬åœ°å®¹å™¨ä¸­æ‰¾<code>ServiceWrapper</code>ã€‚æœ¬åœ°å®¹å™¨å°±æ˜¯rpcçš„provideråœ¨å‘å¸ƒä¸€ä¸ªæœåŠ¡åˆ°æ³¨å†Œä¸­å¿ƒçš„æ—¶å€™æœ¬åœ°ä¹Ÿä¿å­˜ä¸€ä¸ªè¿™ä¸ªæœåŠ¡çš„ç›¸å…³ä¿¡æ¯ã€‚æ‰€è°“çš„æœåŠ¡ç®€å•ç†è§£ä¸ºå°±æ˜¯ä¸€ä¸ªservice beanã€‚è€Œè¿™ä¸ªå®¹å™¨ç®€å•ç†è§£ä¸ºå°±æ˜¯ä¸€ä¸ªmapæ˜ å°„ï¼Œ<code>ServiceMetadata</code>ä¸ºkeyï¼Œ<code>ServiceWrapper</code>ä¸ºvalueã€‚æ‰¾åˆ°è¿™ä¸ª<code>ServiceWrapper</code>åå°±å¾ˆå¥½åŠäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨è¿™ä¸ªserviceäº†ã€‚ä½†æ˜¯è¿™ä¸ª<code>ServiceWrapper</code>ä¸ä»…ä»…æ˜¯ä¸€ä¸ªserviceï¼Œé‡Œé¢æœ‰å¾ˆå¤šé¢å¤–çš„åŠŸèƒ½ï¼Œæ¯”æ–¹å¯ä»¥æœ‰ä¸€ä¸ªç§æœ‰çš„çº¿ç¨‹æ± ã€‚å¦‚æœæœ‰ï¼Œé‚£ä¹ˆåœ¨å…·ä½“è°ƒç”¨è¿™ä¸ªserviceçš„æ—¶å€™ä¼šä½¿ç”¨è¿™ä¸ªç§æœ‰çš„çº¿ç¨‹æ± ã€‚è¿™ç§åœºæ™¯æˆ‘åæ­£æ²¡è§è¿‡ï¼Œä½†ä¸æ’é™¤æœ‰è¿™ç§æƒ…å†µã€‚å¦‚æœæ²¡æœ‰é‚£å°±å¾ˆç®€å•äº†ï¼Œç›´æ¥å¤„ç†ã€‚è¿™ä¸ªå¤„ç†è¿‡ç¨‹ä¹Ÿå¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œæ— éå°±æ˜¯å°†è¦è°ƒç”¨çš„serviceæ‰§è¡Œä¸€éï¼Œå°†ç»“æœåºåˆ—åŒ–ï¼Œå†å†™å‡ºå»ã€‚ç„¶è€Œé‡Œé¢çš„ä»£ç å®ç°å¯æ²¡æœ‰é‚£ä¹ˆç®€å•ã€‚</p>
<p>å…·ä½“çš„å¤„ç†é€»è¾‘å…¨éƒ¨éƒ½åœ¨<code>process</code>æ–¹æ³•ä¸­ã€‚å½“ç„¶ï¼Œåœ¨çœ‹å…·ä½“å®ç°ä¹‹å‰å¾ˆæœ‰å¿…è¦å¯¹å…¶ä¸­å‡ ä¸ªæ ¸ç±»å¦‚<code>ServiceWrapper</code>å’Œ<code>MessageWrapper</code>è¿›è¡Œè§£è¯»ã€‚</p>
<p><code>MessageWrapper</code>å¯ä»¥ç®€å•ç†è§£ä¸ºè°ƒç”¨è€…å‘é€çš„æ•°æ®ã€‚åŒ…å«è¦è°ƒç”¨çš„å¯¹è±¡ï¼Œå¯¹è±¡çš„æ–¹æ³•ï¼Œæ–¹æ³•çš„å‚æ•°ã€‚å½“ç„¶å®é™…ä¸Šæ¯”è¿™äº›å†…å®¹è¦å¤æ‚å¾ˆå¤šï¼Œæ¯”å¦‚é“¾è·¯è¿½è¸ªidç­‰ã€‚æœ‰ä¸ªæœ€é‡è¦çš„å‚æ•°<code>ServiceMetadata</code>ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceMetadata</span> <span class="keyword">extends</span> <span class="title">Directory</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8908295634641380163L</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String group;               <span class="comment">// æœåŠ¡ç»„åˆ«</span></div><div class="line">    <span class="keyword">private</span> String serviceProviderName; <span class="comment">// æœåŠ¡åç§°</span></div><div class="line">    <span class="keyword">private</span> String version;             <span class="comment">// æœåŠ¡ç‰ˆæœ¬å·</span></div><div class="line">	<span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>Directory</code>æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ã€‚è¿™ä¸ªå‘½åä¹Ÿå¾ˆå®¹æ˜“ç†è§£ï¼Œé¡¾åæ€ä¹‰Directoryæ˜¯ç›®å½•çš„æ„æ€ã€‚å¯¹äºæŸä¸ªæœåŠ¡æ¥è¯´ï¼Œå•çº¯çš„çŸ¥é“æœåŠ¡åå°±è¶³çŸ£å®Œæˆè°ƒç”¨ã€‚ä½†æ˜¯åœ¨å¤æ‚çš„åœºæ™¯ä¸‹ï¼Œæœ‰æˆç™¾ä¸Šåƒä¸ªæœåŠ¡ï¼Œè¦åšåˆ°å‡†ç¡®è°ƒç”¨å°±å¾—å¯¹å…¶è¿›è¡Œåˆ†ç±»äº†ã€‚è€Œä¸”æœ‰æ—¶å€™è¿˜æœ‰åŒä¸€ä¸ªæœåŠ¡ç‰ˆæœ¬ä¹Ÿä¸ä¸€æ ·çš„æƒ…å½¢ï¼Œå› æ­¤ç‰ˆæœ¬å·ä¹Ÿå¾—ä½œä¸ºè¿™ä¸ªç›®å½•ä¸­çš„æŸä¸ªå±‚çº§ã€‚ä¸ºä»€ä¹ˆæˆä¸ºmetadataå‘¢ï¼Ÿè¿™ä¸ªå±æ€§åœ¨<code>ServiceWrapper</code>å¯¹è±¡ä¸­ä¹Ÿæœ‰ã€‚å¯ä»¥çŒœåˆ°äº†ï¼Œä¸€å®šæ˜¯ä¸€ä¸€å¯¹åº”èµ·æ¥çš„ã€‚é€šä¿—è§£é‡Šæ¥è¯´<code>ServiceWrapper</code>æ˜¯å±äºæœåŠ¡ç«¯çš„ã€‚ä¹Ÿå°±æ˜¯è¯´providerå‘å¸ƒæœ¬åœ°æœåŠ¡åˆ°æ³¨å†Œä¸­å¿ƒçš„åŒæ—¶ï¼Œä»…ä»…æ˜¯å°†å…ƒæ•°æ®å‘å‡ºå»äº†ï¼Œæ³¨å†Œä¸­å¿ƒæœ‰äº†è¿˜ä¸èƒ½å®Œäº‹ï¼Œè‡ªå·±æœ¬åœ°å¾—ç¡®å®å­˜åœ¨å‘€ï¼Œä¸ç„¶consumerä»æ³¨å†Œä¸­å¿ƒä¸­æ‹¿åˆ°æœåŠ¡å…ƒæ•°æ®äº†å»provideré‡Œæ‰¾ä¸åˆ°è¿™ä¸ªæœåŠ¡ï¼Œè¿™éå¾—éª‚å¨˜ä¸å¯ã€‚è€ŒServiceWrapperæ­£æ˜¯å°†éœ€è¦æš´éœ²å‡ºå»çš„æœåŠ¡åœ¨æœ¬åœ°å­˜èµ·æ¥ã€‚ä»…æ­¤è€Œå·²ã€‚å…¶ä¸­æœ€é‡è¦çš„å±æ€§å°±æ˜¯æœåŠ¡å¯¹è±¡<code>serviceProvider</code>äº†ï¼Œå¯¹äºrpcæ¥è¯´ï¼ŒconsumerçŸ¥é“çš„ä»…ä»…æ˜¯æ¥å£ï¼Œæ­£çœŸå»å¹²æ´»çš„è¿˜æ˜¯å®ç°ç±»ã€‚è€Œå…¶ä½™çš„èŠ±é‡Œèƒ¡å“¨çš„ä¸œè¥¿è¿˜æ˜¯æœ‰ç‚¹ç”¨çš„ï¼Œå¾—åˆ†åœºæ™¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceWrapper</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6690575889849847348L</span>;</div><div class="line"></div><div class="line">    <span class="comment">// æœåŠ¡å…ƒæ•°æ®</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServiceMetadata metadata;</div><div class="line">    <span class="comment">// æœåŠ¡å¯¹è±¡</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object serviceProvider;</div><div class="line">    <span class="comment">// æœåŠ¡æ‹¦æˆªå™¨</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ProviderInterceptor[] interceptors;</div><div class="line">    <span class="comment">// key:     method name</span></div><div class="line">    <span class="comment">// value:   pair.first:  æ–¹æ³•å‚æ•°ç±»å‹(ç”¨äºæ ¹æ®JLSè§„åˆ™å®ç°æ–¹æ³•è°ƒç”¨çš„é™æ€åˆ†æ´¾)</span></div><div class="line">    <span class="comment">//          pair.second: æ–¹æ³•æ˜¾å¼å£°æ˜æŠ›å‡ºçš„å¼‚å¸¸ç±»å‹</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, List&lt;Pair&lt;Class&lt;?&gt;[], Class&lt;?&gt;[]&gt;&gt;&gt; extensions;</div><div class="line"></div><div class="line">    <span class="comment">// æƒé‡ hashCode() ä¸ equals() ä¸æŠŠweightè®¡ç®—åœ¨å†…</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> weight = JConstants.DEFAULT_WEIGHT;</div><div class="line">    <span class="comment">// providerç§æœ‰çº¿ç¨‹æ± </span></div><div class="line">    <span class="keyword">private</span> Executor executor;</div><div class="line">    <span class="comment">// providerç§æœ‰æµé‡æ§åˆ¶å™¨</span></div><div class="line">    <span class="keyword">private</span> FlowController&lt;JRequest&gt; flowController;</div><div class="line">    <span class="comment">// ...</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è€Œå…·ä½“çš„æ ¸å¿ƒå¤„ç†é€»è¾‘<code>process</code>ä»¥åå†æ…¢æ…¢çœ‹ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è®²åˆ°jupiterçš„ä¼ è¾“æ¨¡å—transportä¸­çš„ç¼–è§£ç å™¨çš„å®ç°ã€‚å¯¹serveræ¥è¨€ï¼Œç¼–è§£ç å™¨æ‰®æ¼”ç€ä¸€å¤´ä¸€å°¾çš„é—¨å«è§’è‰²ï¼Œä¿è¯è¿›æ¥çš„äººæ˜¯å¹²å‡€çš„ï¼Œä¹Ÿå¾—ä¿è¯å‡ºå»çš„äººä¹Ÿæ˜¯å¹²å‡€çš„ã€‚å½“ç„¶è¿™ä¹ˆæ¯”å–»å¾ˆä¸æ°å½“ï¼Œä½†æ˜¯ä¹Ÿæƒ³ä¸åˆ°åˆ«çš„æ¯”å–»äº†ã€‚&lt;/p&gt;
&lt;p&gt;ç¼–è§£ç å™¨å›ºç„¶é‡è¦ï¼Œä½†æ˜¯æ²¡æœ‰æ ¸
    
    </summary>
    
      <category term="ä¸€èµ·è¯»æºç " scheme="http://www.wei-dong.top/categories/%E4%B8%80%E8%B5%B7%E8%AF%BB%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="Jupiter" scheme="http://www.wei-dong.top/tags/Jupiter/"/>
    
  </entry>
  
  <entry>
    <title>å°ç™½æ¢ç´¢å¤§å‰ç«¯--ä½¿ç”¨vueå®ç°ç®€å•è½®æ’­å›¾</title>
    <link href="http://www.wei-dong.top/2018/08/15/%E5%B0%8F%E7%99%BD%E6%8E%A2%E7%B4%A2%E5%A4%A7%E5%89%8D%E7%AB%AF--%E4%BD%BF%E7%94%A8vue%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E8%BD%AE%E6%92%AD%E5%9B%BE/"/>
    <id>http://www.wei-dong.top/2018/08/15/å°ç™½æ¢ç´¢å¤§å‰ç«¯--ä½¿ç”¨vueå®ç°ç®€å•è½®æ’­å›¾/</id>
    <published>2018-08-15T09:17:23.000Z</published>
    <updated>2018-08-15T10:04:51.119Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘çœ‹å®Œäº†ã€ŠVueå®æˆ˜ã€‹è¿™æœ¬ä¹¦ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡å®Œæ•´çš„çœ‹å®Œçš„ä¸€æœ¬å…³äºå‰ç«¯çš„ä¹¦ç±ï¼ˆç°åœ¨è¿˜åœ¨çœ‹çš„æ˜¯ã€ŠCSSä¸–ç•Œã€‹ï¼Œæœ‰ç‚¹æƒ³æ”¾å¼ƒäº†ï¼‰ã€‚ç…§ç€ä¹¦ä¸­çš„demoéƒ½å†™äº†ä¸€éï¼Œè™½ç„¶å¾ˆå¤šæ —å­éå¸¸ç®€å•ï¼Œä½†æ˜¯å€¼å¾—å­¦ä¹ çš„åœ°æ–¹è¿˜æ˜¯æŒºå¤šçš„ã€‚å½“ç„¶ä¹Ÿä¸å¾—ä¸åæ§½å¾ˆå¤šç”¨æ³•éƒ½æœ‰ç‚¹è¿‡æ—¶ï¼Œå°¤å…¶æ˜¯å…³äºwebpackçš„é…ç½®ã€‚ä¸è¿‡ç°åœ¨çš„å‰ç«¯å‘å±•å¾ˆå¿«ï¼Œå„ç§å·¥å…·ç‰ˆæœ¬ä¸æ–­æ›´æ–°ï¼Œä»£ç è¿‡æ—¶ä¹Ÿæ˜¯èƒ½å¤Ÿç†è§£çš„ã€‚å¯¹äºå­¦ä¹ è€…æ¥è¯´å½“ç„¶å¾—å­¦ä¹ æœ€æ–°çš„ä¸œè¥¿ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯ç”¨æ¥è®°å½•åœ¨è‡ªå·±å®ç°ä¸€ä¸ªã€çŸ¥ä¹æ—¥æŠ¥ç§»åŠ¨ç‰ˆã€‘çš„è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€ä¸ªå‘ï¼Œè¯´å‘ä¹Ÿç®—ä¸ä¸Šï¼Œåªèƒ½å«åšåå·ä¹‹è·¯å§ã€‚å› ä¸ºä¹¦ä¸­ç»™çš„å®æˆ˜demoæ˜¯ä¸€ä¸ªpcç‰ˆçš„ï¼Œè‡ªå·±è·Ÿç€å†™äº†ä¸€éï¼Œè§‰å¾—æ²¡æœ‰ä»€ä¹ˆéš¾åº¦ã€‚ç„¶ååœ¨githubä¸Šæ‰¾äº†ä¸€ä¸‹ï¼Œå‘ç°ç”¨çŸ¥ä¹æ—¥æŠ¥æ¥ç»ƒæ‰‹çš„é¡¹ç›®å¾ˆå¤šï¼ŒåŸå› ä¹Ÿå¾ˆç®€å•â€“apiæ˜¯ç°æˆçš„ã€‚äºæ˜¯æˆ‘ä¹Ÿè ¢è ¢æ¬²åŠ¨ï¼Œå†³å®šä½¿ç”¨vueäº²è‡ªæ’¸ä¸€ä¸ªã€çŸ¥ä¹dailyã€‘ã€‚</p>
<p>è™½ç„¶gayhubå¾ˆå¤šç°æˆçš„é¡¹ç›®ï¼Œä½†æ˜¯æˆ‘å¹¶ä¸æ‰“ç®—å»æŠ„ä¸€éã€‚æˆ‘åœ¨æ‰‹æœºä¸Šä¸‹è½½äº†ä¸€ä¸ªçŸ¥ä¹æ—¥æŠ¥çš„APPï¼ŒæŒ‰ç…§ä¸åŒåŠŸèƒ½æˆªå±æ¥ä¸€ä¸€å®ç°ã€‚æ²¡åŠæ³•ï¼Œè¿™å°±æ˜¯å·¥(zhuang)åŒ (bi)æƒ…(xin)æ€€(tai).</p>
<p>å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæ•´ä½“çš„æ¡†æ¶åŠŸèƒ½ä¸ŠåŸºæœ¬æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œè¯¥è‡ªå·±å†™ç»„ä»¶å°±è‡ªå·±å†™ï¼Œç»æ²¡æœ‰å·æ‡’ã€‚ä¹Ÿé‡åˆ°å¾ˆå¤šé—®é¢˜ï¼Œæ¯”å¦‚å¼€å‘ç¯å¢ƒä¸‹çš„æ¥å£ä»£ç†ã€çŸ¥ä¹å›¾ç‰‡çš„åŒæºç­–ç•¥ç­‰ã€‚è¿™äº›é—®é¢˜è‚¯å®šéš¾ä¸å€’æˆ‘ï¼Œéƒ½ä¸å€¼ä¸€æã€‚è®©æˆ‘è§‰å¾—éš¾å—çš„è¿˜æ˜¯é¦–é¡µçš„è½®æ’­å›¾å®ç°ã€‚è¿™ä¸ªé—®é¢˜å›°æ‰°äº†æˆ‘2å¤©ï¼ˆå‡†ç¡®æ—¶é—´æ˜¯ä¸€å¤©åŠï¼Œè¿˜æœ‰åŠå¤©åœ¨å·¥ä½œï¼šé€ƒï¼‰ã€‚</p>
<p>é‡åˆ°è¿™ä¸ªåŠŸèƒ½çš„æ—¶å€™ç¬¬ä¸€ååº”æ˜¯ä½¿ç”¨ä¸€ä¸ªå¼€æºåº“ï¼Œåˆ†åˆ†é’Ÿå°±æå®šäº†ã€‚ä½†æ˜¯ç»è¿‡10sçš„æ€æƒ³æ–—äº‰ï¼Œå·¥åŒ æƒ…æ€€ç»ˆäºæˆ˜èƒœäº†ç†æ™ºï¼Œä¸‹å®šå†³å¿ƒæ‰“ç®—è‡ªå·±æ‰‹åŠ¨å®ç°ã€‚ç„¶è€Œï¼Œå¸¦æ¥çš„ç»“æœå°±æ˜¯å¡é¡¿äº†åŠå¤©ï¼Œæ²¡ä»»ä½•è¿›å±•ã€‚ç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šæ•™ç¨‹ï¼Œä¹Ÿæ˜¯å¾ˆç®€å•çš„ï¼Œå¯ä»¥è¯´æ˜¯åŸºç¡€æ“ä½œäº†ã€‚å¯æƒœæˆ‘è¢«ä¸€ç¯‡æ–‡ç« å¸¦åäº†ï¼Œèµ°äº†ä¸€ç‚¹å¼¯è·¯ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« çš„æ€è·¯å¾ˆå¸¸è§„ï¼Œå¾ˆæœ‰é“ç†ã€‚é¦–å…ˆå°†ä¸€ä¸ªæ¡†æ¡†ç”¨æ¥è£…ä½ è¦æ˜¾ç¤ºçš„å›¾ç‰‡ï¼Œä»…ä»…åªèƒ½æ˜¾ç¤ºè¿™ä¸ªæ¡†æ¡†ï¼Œè€Œå›¾ç‰‡å‘¢å°±æ”¾åé¢æ’æ’åï¼Œé€šè¿‡å®šæ—¶å™¨å»ç§»åŠ¨å›¾ç‰‡ï¼Œå°±åƒä¸€æ ¼æ ¼çš„èƒ¶å·ä¸€æ ·ï¼Œè½®åˆ°è°è°å°±è¢«çœ‹åˆ°äº†ã€‚</p>
<p>æˆ‘ä¸€å¼€å§‹å°±æ˜¯æŒ‰ç…§è¿™ç§æ€è·¯å»æ•´ï¼Œç»“æœæ€ä¹ˆæ•´éƒ½å®ç°ä¸äº†ï¼ˆåœ¨ç§»åŠ¨ç«¯ï¼‰ã€‚åœ¨ä¸€ç­¹è«å±•ä¹‹é™…ï¼Œå‘ç°äº†ä¸€ä¸ªæ›´åŠ å±Œçš„æ€è·¯ã€‚è¿™ä¸ªæ€è·¯å’Œä¹‹å‰çš„ä¸ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äºåé¢çš„å›¾ç‰‡ä¸æ˜¯æ’æ’åå¥½ï¼Œè€Œæ˜¯å åŠ åˆ°ä¸€å—å»ã€‚ä¸‹é¢é€šè¿‡ä»£ç å»ä¸€æ¢ç©¶ç«Ÿã€‚</p>
<p>é¦–å…ˆå¾—æ•´ä¸€ä¸ªçª—å£ï¼Œç®€å•æ¥è¯´å°±æ˜¯ç”¨æ¥æ˜¾ç¤ºä¸€å¼ å›¾ç‰‡çš„å®¹å™¨ï¼Œå®ƒçš„å®½åº¦å¯¹ç§»åŠ¨ç«¯è€Œè¨€å°±æ˜¯å±å¹•å®½åº¦ã€‚ä»–å¾—æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„å±æ€§<code>overflowï¼šhidden</code>ï¼Œå½“å­å…ƒç´ å°ºå¯¸è¶…è¿‡å…¶çˆ¶äº²çš„å¤§å°å¤šä½™å†…å®¹å°±ä¼šè¢«éšè—ã€‚è¿™é‡Œç”¨<code>ul</code>æ ‡ç­¾æ¥è£…å›¾ç‰‡ï¼Œå…¶å®ä½¿ç”¨<code>div</code>ä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ã€‚å…ƒç´ <code>li</code>çš„<code>position</code>å±æ€§å¾—è®¾ç½®ä¸º<code>absolute</code>.å› ä¸ºä½¿ç”¨è¿™ä¸ªå±æ€§å°±èƒ½è„±ç¦»æ–‡æ¡£æµï¼Œä¹Ÿå°±ä¸ä¼šâ€œæ’æ’åâ€äº†ï¼Œè€Œæ˜¯å åŠ åˆ°ä¸€èµ·äº†ï¼Œå½“ç„¶ï¼Œæœ€åçš„è‚¯å®šå åœ¨æœ€ä¸Šé¢ï¼Œå‰ææ˜¯æ²¡æœ‰æ˜¾ç¤ºçš„è®¾ç½®<code>z-index</code>å±æ€§ã€‚è¿˜æœ‰å¾ˆé‡è¦çš„ä¸€ç‚¹ï¼Œå­å…ƒç´ å®šä½è®¾ç½®ä¸º<code>absolute</code>çˆ¶å…ƒç´ è®°å¾—ä¹Ÿè®¾ç½®ä¸€ä¸‹å®šä½å±æ€§ï¼Œå› ä¸ºå­å…ƒç´ çš„ç›¸å¯¹ä½ç½®æ˜¯æŒ‰ç…§ç¬¬ä¸€ä¸ªç¥–å…ˆå…ƒç´ ä¸ä¸º<code>static</code>çš„å…ƒç´ æ¥çš„ï¼Œä¸ç„¶ä¼šç²—å¤§äº‹ã€‚ htmlä»£ç ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"window"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"container"</span> <span class="attr">ref</span>=<span class="string">"imagesWrapper"</span>&gt;</span></div><div class="line">       </div><div class="line">       <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"(e,i) in imgs"</span> <span class="attr">:key</span>=<span class="string">"i"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">"e.image"</span> <span class="attr">:alt</span>=<span class="string">"e.title"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"desc"</span>&gt;</span>&#123;&#123;e.title&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">       </div><div class="line">     <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div><div class="line"></div><div class="line">     <span class="tag">&lt;<span class="name">ol</span> <span class="attr">class</span>=<span class="string">"point-wrap"</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">li</span> <span class="attr">:class</span>=<span class="string">"&#123;active:i==currentIndex&#125;"</span> <span class="attr">v-for</span>=<span class="string">"(e,i) in imgs"</span> <span class="attr">:key</span>=<span class="string">"i"</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">     <span class="tag">&lt;/<span class="name">ol</span>&gt;</span></div><div class="line"></div><div class="line">   <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">* &#123;</div><div class="line">  <span class="attribute">padding</span>: <span class="number">0</span>;</div><div class="line">  <span class="attribute">margin</span>: <span class="number">0</span>;</div><div class="line">  <span class="attribute">list-style-type</span>: none;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-tag">img</span> &#123;</div><div class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</div><div class="line">&#125;</div><div class="line"><span class="selector-class">.container</span> &#123;</div><div class="line">  <span class="attribute">position</span>: relative;</div><div class="line">  <span class="attribute">min-height</span>: <span class="number">100%</span>;</div><div class="line">&#125;</div><div class="line"><span class="selector-class">.container</span> <span class="selector-tag">li</span> &#123;</div><div class="line">  <span class="attribute">width</span>: <span class="number">100%</span>;</div><div class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</div><div class="line">  <span class="attribute">position</span>: absolute;</div><div class="line">  <span class="attribute">top</span>: <span class="number">0</span>;</div><div class="line">  <span class="attribute">left</span>: <span class="number">0</span>;</div><div class="line">  <span class="attribute">transform</span>: <span class="built_in">translateX</span>(100%);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="selector-class">.window</span> &#123;</div><div class="line">  <span class="attribute">position</span>: relative;</div><div class="line">  <span class="attribute">height</span>: <span class="number">100%</span>;</div><div class="line">  <span class="attribute">margin</span>: <span class="number">0</span> auto;</div><div class="line">  <span class="attribute">overflow</span>: hidden;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªå°æŠ€å·§ï¼Œåœ¨é™æ€æ ·å¼ä¸­å¹¶æ²¡æœ‰å°†å›¾ç‰‡ç›´æ¥å±•ç¤ºå‡ºæ¥ï¼Œè€Œæ˜¯å°†æ‰€æœ‰å›¾ç‰‡å‘å³åç§»ä¸€ä¸ªçª—å£å®½åº¦ã€‚è¿™æ˜¯æœ‰ç„æœºçš„ã€‚</p>
<p>è¯´äº†è¿™ä¹ˆå¤šï¼Œè¿˜æ²¡è°ˆåˆ°vueçš„éƒ¨åˆ†ã€‚åœ¨<code>container</code>å®¹å™¨ä¸­æœ‰ä¸€ä¸ª<code>ref</code>æ ‡ç­¾ã€‚è¿™æ˜¯åœ¨vueä¸­ç”¨æ¥è·å–domå…ƒç´ çš„ã€‚ä¹Ÿè®¸åœ¨vueä¸­æ“ä½œdomæ˜¯ä¸è¢«æ¨èçš„ï¼Œä½†æ˜¯å¯¹äºè¿™ç§åŠ¨æ€ç”Ÿæˆçš„<code>li</code>å…ƒç´ æˆ‘æ‰¾ä¸åˆ°æ€ä¹ˆå»åŠ¨æ€ç»‘å®šå…¶æ ·å¼ã€‚å› æ­¤é‡‡ç”¨äº†è¿™ç§æ¯”è¾ƒlowçš„åŠæ³•ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">init() &#123;</div><div class="line">     <span class="keyword">let</span> wrappers = <span class="keyword">this</span>.$refs.imagesWrapper;</div><div class="line">     <span class="keyword">let</span> children = wrappers.children;</div><div class="line">     <span class="keyword">let</span> total = <span class="keyword">this</span>.imgs.length;</div><div class="line">     <span class="comment">// çº¯jsæ“ä½œ åªéœ€è¦å…ˆå°†ä¸‰å¼ å›¾ç‰‡ä½ç½®ç¡®å®šå¥½</span></div><div class="line">     <span class="comment">// æœ€å·¦è¾¹æŒ‰é“ç†è¯´æ˜¯æ²¡æœ‰å›¾ç‰‡çš„ ä½†æ˜¯ä¸ºäº†æ— é™æ»šåŠ¨æ•ˆæœ è¿™é‡Œå°†å…¶ç½®ä¸ºæœ€åä¸€å¼ </span></div><div class="line">     <span class="keyword">let</span> left = total - <span class="number">1</span>;</div><div class="line">     <span class="keyword">let</span> center = <span class="number">0</span>;</div><div class="line">     <span class="keyword">let</span> right = <span class="number">1</span>;</div><div class="line"></div><div class="line">     <span class="comment">// åˆå§‹åŒ–çš„æ—¶å€™å°†liå·¦ç§»åŠ¨äº†ä¸€ä¸ªå±å¹•å®½åº¦ï¼Œå°±æ˜¯ä¸ºäº†é˜²æ­¢å åŠ çš„å…ƒç´ æŒ¡ä½è¦æ˜¾ç¤ºçš„å›¾</span></div><div class="line">     <span class="comment">// ç°åœ¨ç¬¬ä¸€å¼ æ˜¾ç¤ºçš„å›¾ç‰‡å®é™…æ˜¯æœ€åä¸€å¼  3å¼ è½®æ’­èµ·æ¥å°±è¡Œäº† æ²¡å¿…è¦å¯¹æ¯ä¸ªå›¾ç‰‡è¿›è¡Œä½ç½®è®¡ç®—</span></div><div class="line">     <span class="comment">// leftå¤„äºæœ€å·¦è¾¹çš„ä½ç½® ä¸æ˜¾ç¤º</span></div><div class="line">     children[left].style.transform = <span class="string">"translateX("</span> + -<span class="keyword">this</span>.distance + <span class="string">"px)"</span>;</div><div class="line">     <span class="comment">// centerå¤„äºä¸­é—´ä½ç½® æ˜¾ç¤º</span></div><div class="line">     children[center].style.transform = <span class="string">"translateX("</span> + <span class="number">0</span> + <span class="string">"px)"</span>;</div><div class="line">     <span class="comment">// rightå¤„äºå³è¾¹ ä¸æ˜¾ç¤º</span></div><div class="line">     children[right].style.transform = <span class="string">"translateX("</span> + <span class="keyword">this</span>.distance + <span class="string">"px)"</span>;</div><div class="line">     <span class="keyword">this</span>.sliderItem = children;</div><div class="line">     <span class="comment">// this.play();</span></div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆå°±æ˜¯åˆå§‹åŒ–æ˜¾ç¤ºçš„å†…å®¹ï¼Œä¹‹å‰åœ¨é™æ€cssæ ·å¼ä¸­å°†å›¾ç‰‡ç§»åŠ¨åˆ°å³è¾¹çœ‹ä¸åˆ°çš„åœ°æ–¹å»äº†ï¼Œç°åœ¨å°±å¾—æ‰‹åŠ¨æ“ä½œè®©å…¶å¯è§ã€‚åˆšå¼€å§‹æˆ‘ä»¥ä¸ºç›´æ¥å°†è¿™äº›å›¾ç‰‡å…¨éƒ¨â€œé“ºå¼€â€ï¼Œç„¶åæ»šåŠ¨ï¼Œåæ¥å‘ç°è¿™ä¹ˆåšå¾ˆç¬¨ã€‚ç›´æ¥æ“ä½œä¸‰å¼ å°±è¡Œäº†ï¼ä¸ºäº†å®ç°æ— é™æ»šåŠ¨çš„æ•ˆæœï¼Œç¬¬ä¸€å¼ çš„é€»è¾‘ä¸Šçš„å‰ä¸€å¼ æ˜¯æœ€åä¸€å¼ ï¼Œå› æ­¤å°†ç¬¬ä¸€å¼ çš„â€œä¸Šä¸€å¼ â€ç»™æ”¾åˆ°å±å¹•å·¦è¾¹ï¼Œä¸‹ä¸€å¼ æ”¾åˆ°å±å¹•å³è¾¹ï¼Œè¦æ˜¾ç¤ºçš„ä¹Ÿå°±æ˜¯ç¬¬ä¸€å¼ ï¼ˆä¸‹æ ‡ä¸º0ï¼‰å½’ä½åˆ°çª—å£ï¼Œè¿™å’Œä¹‹å‰è®¾ç½®çš„å…¨å±€çš„æ ·å¼<code>transform: translateX(100%)</code>å¯¹åº”èµ·æ¥äº†ã€‚</p>
<p>å¦‚æ­¤ä»¥æ¥ï¼Œåˆå§‹åŒ–çš„ä¸‰å¼ å›¾ç‰‡å°±å®šä½å¥½äº†ï¼Œé€»è¾‘ä¸Šä¹Ÿæ˜¯æ²¡ä»€ä¹ˆé—®é¢˜çš„ã€‚å…¶ä½™çš„æ”¹ä¸æ˜¾ç¤ºè¿˜æ˜¯æ˜¾ç¤ºä¸äº†ï¼Œä¹Ÿä¸ä¼šå‚ä¸ç§»åŠ¨ã€‚ä¸‹é¢çœ‹çœ‹æ€ä¹ˆâ€œæ»šâ€ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">next() &#123;</div><div class="line">     this.currentIndex++;</div><div class="line">     // è¾¹ç•Œåˆ¤æ–­</div><div class="line">     if (this.currentIndex &gt; this.imgs.length - 1) &#123;</div><div class="line">       this.currentIndex = 0;</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     // center ä¸ºæ˜¾ç¤ºçš„å›¾ç‰‡</div><div class="line">     let center = this.currentIndex;</div><div class="line">     // å·¦è¾¹çš„ å¦‚æœä¸ºè´Ÿæ•° å°±å–æœ€åä¸€å¼ å›¾ç‰‡ä¸‹æ ‡</div><div class="line">     let left = center - 1 &lt; 0 ? this.imgs.length - 1 : center - 1;</div><div class="line">     // å³è¾¹çš„ å¦‚æœè¶…è¿‡äº†æœ€å¤§å›¾ç‰‡æ•°é‡ å–ç¬¬ä¸€å¼ å›¾ç‰‡ä¸‹æ ‡</div><div class="line">     let right = center + 1 == this.imgs.length ? 0 : center + 1;</div><div class="line"></div><div class="line">     let children = this.sliderItem;</div><div class="line">     // ç»™å…ƒç´ æ·»åŠ è¿‡æ¸¡</div><div class="line">     children[center].style.transition = "transform .5s";</div><div class="line">     children[left].style.transition = "transform .5s";</div><div class="line">     // å³è¾¹çš„å›¾ç‰‡æ˜¯æ›¿è¡¥å›¾ç‰‡ï¼Œä¸éœ€è¦èµ°è¿‡æ¸¡</div><div class="line">     children[right].style.transition = "none";</div><div class="line">     // 3å¼ å›¾ç‰‡åŒæ—¶ç§»åŠ¨</div><div class="line">     children[left].style.transform = "translateX(" + -this.distance + "px)";</div><div class="line">     children[center].style.transform = "translateX(0px)";</div><div class="line">     children[right].style.transform = "translateX(" + this.distance + "px)";</div><div class="line">   &#125;,</div></pre></td></tr></table></figure>
<p><code>currentIndex</code>ä¸ºå…¨å±€å˜é‡ï¼ŒæŒ‡å½“å‰æ˜¾ç¤ºçš„å›¾ç‰‡ä¸‹æ ‡ï¼Œæ¯æ¬¡è°ƒç”¨<code>next</code>ä¼šå­å¢ï¼Œåˆ°ä¸Šé™åä¼šå›å½’åˆ°0ï¼Œè¿™äº›éƒ½æ˜¯å¾ˆå¸¸è§„çš„æ“ä½œã€‚æ¥ä¸‹æ¥å°±æ˜¯è®¡ç®—ä¸Šä¸€å¼ ï¼Œä¸‹ä¸€å¼ å›¾ç‰‡çš„ä¸‹æ ‡ï¼Œä¹Ÿæ˜¯å¾ˆå®¹æ˜“ç†è§£ï¼Œæ— éå¤šäº†ä¸€ç‚¹åˆ¤æ–­ï¼Œåœ¨æœ€åä¸€å¼ æ˜¾ç¤ºçš„æ—¶å€™ä¸‹ä¸€å¼ çš„ä¸‹æ ‡å¾—ç½®ä¸º0ï¼Œä¸Šä¸€å¼ ä¹Ÿæ˜¯åŒç†ï¼Œä¸ç„¶å°±å›â€ç©ºæŒ‡é’ˆâ€äº†ã€‚æ¥ä¸‹æ¥å°±æ˜¯é’ˆå¯¹è¿™ä¸‰å¼ å›¾ç‰‡æ”¹å˜æ ·å¼ï¼ŒåŸåˆ™å°±æ˜¯ç§»åŠ¨åˆ°å“ªä¸ªä¸‹æ ‡å°±æ˜¾ç¤ºå“ªä¸ªå›¾ç‰‡ï¼Œä¸Šä¸€å¼ å°±ç§»åˆ°å·¦è¾¹ï¼Œä¸‹ä¸€ç«™ç§»åŠ¨åˆ°å³è¾¹ï¼Œé¡ºä¾¿ç»™åŠ ä¸ªåŠ¨ç”»æ•ˆæœã€‚å¦‚æ­¤è€Œå·²ï¼</p>
<p>æœ€åå°±æ˜¯è‡ªåŠ¨æ’­æ”¾çš„é€»è¾‘ï¼Œä¹Ÿæ˜¯éå¸¸ç®€å•ï¼Œä¸€ä¸ªå®šæ—¶å™¨å°±æå®šï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">play() &#123;</div><div class="line">     <span class="keyword">if</span> (<span class="keyword">this</span>.timer) &#123;</div><div class="line">       <span class="built_in">window</span>.clearInterval(<span class="keyword">this</span>.timer);</div><div class="line">       <span class="keyword">this</span>.timer = <span class="literal">null</span>;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">this</span>.timer = <span class="built_in">window</span>.setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">       <span class="keyword">this</span>.next();</div><div class="line">     &#125;, <span class="keyword">this</span>.interval);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨é’©å­å‡½æ•°ä¸­å°†è¿™æ–¹æ³•åŠ ä¸Šå»å°±å®Œäº‹äº†ã€‚ä¸€ä¸ªè‡ªåˆ¶çš„è½®æ’­ç»„ä»¶å°±å†™å®Œäº†ã€‚ç®€é™‹ä½†æ˜¯ç®€å•ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªä¸å¤ªé‡è¦çš„ç»†èŠ‚ï¼Œé’ˆå¯¹çª—å£å˜åŒ–çš„æ—¶å€™å¾—åŠ¨æ€æ”¹å˜åç§»é‡ã€‚</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// çª—å£å˜åŒ– é‡æ–°åˆå§‹åŒ–</span></div><div class="line">   windowChange() &#123;</div><div class="line">     <span class="keyword">const</span> that = <span class="keyword">this</span>;</div><div class="line">     <span class="built_in">window</span>.onresize = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">       <span class="keyword">return</span> <span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</div><div class="line">         <span class="built_in">window</span>.screenWidth = <span class="built_in">document</span>.body.clientWidth;</div><div class="line">         that.distance = <span class="built_in">window</span>.screenWidth;</div><div class="line">         <span class="keyword">this</span>.init();</div><div class="line">       &#125;)();</div><div class="line">     &#125;;</div><div class="line">   &#125;,</div></pre></td></tr></table></figure>
<p>è¿™æ ·åœ¨pcç«¯ä¸‹ä¹Ÿèƒ½æ­£å¸¸â€œæ»šâ€åŠ¨äº†ã€‚</p>
<p>æœ€åï¼Œåšä¸€ä¸‹å°å°çš„æ€»ç»“ã€‚è¿™ä¸ªç»„ä»¶è™½ç„¶ç®€å•ï¼Œä½†æ˜¯ä¹ŸèŠ±äº†ä¸€å®šæ—¶é—´ï¼Œæ¯•ç«Ÿè¸©å‘çš„è·¯æ˜¯ä¸èƒ½è·³è¿‡çš„ã€‚å…¶ä¸­èŠ±äº†å¾ˆå¤šæ—¶é—´çº ç»“å¸ƒå±€å’Œæ ·å¼ï¼Œå¾ˆæ˜¯éš¾å—ï¼Œéƒ½æ€ªæˆ‘æ²¡æœ‰æŠŠã€ŠCSSä¸–ç•Œã€‹çœ‹å®Œã€‚è™½ç„¶ç®€å•ï¼Œä½†æ˜¯åŠŸèƒ½ä¹Ÿå¾ˆå±€é™ï¼Œæ¯”å¦‚æ²¡æœ‰å®ç°æ‰‹åŠ¨å»æ»‘åŠ¨ã€‚APPä¸Šæ˜¯æœ‰è¿™ä¸ªåŠŸèƒ½çš„ï¼Œé‚£æ˜¯å› ä¸ºæˆ‘è¿˜æ²¡å­¦ä¼šæ€ä¹ˆåœ¨vueä¸‹ä½¿ç”¨touchäº‹ä»¶ï¼ˆå®é™…ä¸Šæ˜¯æ‡’ï¼‰ã€‚æ¯”å¦‚æ²¡æœ‰ä»£ç ä¼˜åŒ–ç­‰ç­‰ï¼Œæ€»ä¸èƒ½è¦æ±‚ä¸€ä¸ªæ–°æ‰‹æ¥é€ ä¸€ä¸ªå®Œç¾çš„è½®å­å§ï¼ˆç»™è‡ªå·±ä¸€ç‚¹ä¸Šå‡çš„ç©ºé—´å’¯ï¼‰ã€‚é€ è½®å­ä¸æ˜¯ç›®çš„ï¼Œç†è§£å…¶ä¸­çš„æ‰€ä»¥ç„¶æ‰æ˜¯ç›®çš„ï¼Œç°æˆçš„åº“æœ‰å¾ˆå¤šï¼Œå®ŒæˆåŠŸèƒ½ä¹Ÿå¾ˆå®¹æ˜“ï¼Œä½†æ˜¯ä¸èƒ½ä»…ä»…æ»¡è¶³äºæ­¤ï¼Œæˆ‘è§‰å¾—ä½œä¸ºæ‰‹è‰ºäººå¾—æœ‰ä¸€ç§æ ¼(xi)ç‰©(huan)è‡´(zhuang)çŸ¥(B)çš„ç²¾ç¥ã€‚</p>
<p><img src="https://upload-images.jianshu.io/upload_images/3117395-0a23d3aadd128f5f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/662" alt="image"></p>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="http://web.jobbole.com/94701/" target="_blank" rel="external">CSSæ·±å…¥ç†è§£ä¹‹relativeå®šä½</a></p>
<p><a href="https://segmentfault.com/a/1190000011013572#articleHeader2" target="_blank" rel="external">å‡ ç§åŸç”Ÿjsè½®æ’­å›¾</a></p>
<p><a href="https://github.com/Mr-Vincent/zhihu-daily-app" target="_blank" rel="external">æºç åœ°å€</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘çœ‹å®Œäº†ã€ŠVueå®æˆ˜ã€‹è¿™æœ¬ä¹¦ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ç¬¬ä¸€æ¬¡å®Œæ•´çš„çœ‹å®Œçš„ä¸€æœ¬å…³äºå‰ç«¯çš„ä¹¦ç±ï¼ˆç°åœ¨è¿˜åœ¨çœ‹çš„æ˜¯ã€ŠCSSä¸–ç•Œã€‹ï¼Œæœ‰ç‚¹æƒ³æ”¾å¼ƒäº†ï¼‰ã€‚ç…§ç€ä¹¦ä¸­çš„demoéƒ½å†™äº†ä¸€éï¼Œè™½ç„¶å¾ˆå¤šæ —å­éå¸¸ç®€å•ï¼Œä½†æ˜¯å€¼å¾—å­¦ä¹ çš„åœ°æ–¹è¿˜æ˜¯æŒºå¤šçš„ã€‚å½“ç„¶ä¹Ÿä¸å¾—ä¸åæ§½å¾ˆå¤šç”¨æ³•éƒ½æœ‰ç‚¹è¿‡æ—¶ï¼Œå°¤å…¶æ˜¯å…³äºwebpackçš„é…ç½®ã€‚
    
    </summary>
    
      <category term="å‰ç«¯" scheme="http://www.wei-dong.top/categories/%E5%89%8D%E7%AB%AF/"/>
    
    
      <category term="VUE" scheme="http://www.wei-dong.top/tags/VUE/"/>
    
      <category term="Javascript" scheme="http://www.wei-dong.top/tags/Javascript/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€èµ·å­¦RPC(äºŒ)</title>
    <link href="http://www.wei-dong.top/2018/08/09/%E4%B8%80%E8%B5%B7%E5%AD%A6RPC(%E4%BA%8C)/"/>
    <id>http://www.wei-dong.top/2018/08/09/ä¸€èµ·å­¦RPC(äºŒ)/</id>
    <published>2018-08-09T10:17:23.000Z</published>
    <updated>2018-08-09T10:02:11.780Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¸Šä¸€ç¯‡ä¸­ä»‹ç»åˆ°å…³äºjupiterçš„åº•å±‚é€šä¿¡æ¨¡å—transportçš„éƒ¨åˆ†å®ç°ã€‚ä»…ä»…åªæ˜¯è®¨è®ºäº†æ•´ä¸ªserverçš„åˆå§‹åŒ–ä»¥åŠå¯åŠ¨æµç¨‹ã€‚å¾ˆå¤šç»†ææœ«èŠ‚å…¶å®è¿˜æ²¡æœ‰æ¶‰åŠåˆ°ï¼Œä¾‹å¦‚tcpå‚æ•°è®¾ç½®ï¼Œè¶…æ—¶æœºåˆ¶ï¼Œç¼–è§£ç å™¨ç­‰ç­‰å®ç°ç»†èŠ‚ã€‚è¿™äº›ä¸œè¥¿å°†ä¼šé€æ­¥è¢«æ¶ˆåŒ–åˆ†è§£ã€‚è€Œæœ¬æ–‡çš„ä¸»é¢˜æ˜¯jupiterçš„ä¸šåŠ¡ç¼–è§£ç å™¨çš„å®ç°ã€‚</p>
<p>åœ¨jupiterä¸­æœ‰ä¸€å¼ å›¾ï¼Œè¿™å¼ å›¾æ¸…æ™°åœ°æè¿°äº†æ•´ä¸ªserverçš„æ•°æ®æµå‘ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">* *********************************************************************</div><div class="line"> *            I/O Request                       I/O Response</div><div class="line"> *                 â”‚                                 â–³</div><div class="line"> *                                                   â”‚</div><div class="line"> *                 â”‚</div><div class="line"> * â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”¼ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€</div><div class="line"> * â”‚               â”‚                                                  â”‚</div><div class="line"> *                                                   â”‚</div><div class="line"> * â”‚  â”Œ â”€ â”€ â”€ â”€ â”€ â”€â–½â”€ â”€ â”€ â”€ â”€ â”€ â”       â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”   â”‚</div><div class="line"> *     IdleStateChecker#inBound          IdleStateChecker#outBound</div><div class="line"> * â”‚  â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜       â”” â”€ â”€ â”€ â”€ â”€ â”€â–³â”€ â”€ â”€ â”€ â”€ â”€ â”˜   â”‚</div><div class="line"> *                 â”‚                                 â”‚</div><div class="line"> * â”‚                                                                  â”‚</div><div class="line"> *                 â”‚                                 â”‚</div><div class="line"> * â”‚  â”Œ â”€ â”€ â”€ â”€ â”€ â”€â–½â”€ â”€ â”€ â”€ â”€ â”€ â”                                     â”‚</div><div class="line"> *     AcceptorIdleStateTrigger                      â”‚</div><div class="line"> * â”‚  â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜                                     â”‚</div><div class="line"> *                 â”‚                                 â”‚</div><div class="line"> * â”‚                                                                  â”‚</div><div class="line"> *                 â”‚                                 â”‚</div><div class="line"> * â”‚  â”Œ â”€ â”€ â”€ â”€ â”€ â”€â–½â”€ â”€ â”€ â”€ â”€ â”€ â”       â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”   â”‚</div><div class="line"> *          ProtocolDecoder                   ProtocolEncoder</div><div class="line"> * â”‚  â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜       â”” â”€ â”€ â”€ â”€ â”€ â”€â–³â”€ â”€ â”€ â”€ â”€ â”€ â”˜   â”‚</div><div class="line"> *                 â”‚                                 â”‚</div><div class="line"> * â”‚                                                                  â”‚</div><div class="line"> *                 â”‚                                 â”‚</div><div class="line"> * â”‚  â”Œ â”€ â”€ â”€ â”€ â”€ â”€â–½â”€ â”€ â”€ â”€ â”€ â”€ â”                                     â”‚</div><div class="line"> *          AcceptorHandler                          â”‚</div><div class="line"> * â”‚  â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜                                     â”‚</div><div class="line"> *                 â”‚                                 â”‚</div><div class="line"> * â”‚                    â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”                     â”‚</div><div class="line"> *                 â–½                                 â”‚</div><div class="line"> * â”‚               â”€ â”€ â–·â”‚       Processor       â”œ â”€ â”€â–·                â”‚</div><div class="line"> *</div><div class="line"> * â”‚                    â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜                     â”‚</div><div class="line"> * â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€</div><div class="line"> *</div></pre></td></tr></table></figure>
<p>å®é™…ä¸Šè¿™ä¸ªå›¾ä»…ä»…æ˜¯é’ˆå¯¹Netty apiçš„æè¿°ï¼Œå’Œrpcæ²¡æœ‰å¤ªå¤šç›´æ¥çš„å…³ç³»ã€‚å¦‚æœæ¢åšåˆ«çš„é€šä¿¡æ¡†æ¶è¿™ä¸ªå›¾å°±æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰äº†ã€‚é‰´äºNettyä¾æ—§æ˜¯ç›®å‰Javaç½‘ç»œå¼€å‘ä¸­æœ€æµè¡Œçš„æ¡†æ¶ï¼Œæ‹¿å‡ºæ¥è®¨è®ºä¹Ÿæ˜¯å¾ˆæœ‰æ„ä¹‰çš„ã€‚</p>
<p>è¿™ä¸ªå›¾ä¸­æœ‰å‡ ä¸ªæ ¸å¿ƒçš„æ¦‚å¿µï¼šdecodeã€encodeã€IdleStateCheckerå’Œhandlerã€‚åœ¨ç¼–å†™ä¸€ä¸ªç½‘ç»œåº”ç”¨çš„æ—¶å€™é¦–å…ˆå¿…é¡»å®šä¹‰çš„æ˜¯é€šä¿¡åè®®ã€‚æ¯”å¦‚ä¸Šä¼ ä¸‹è½½æ–‡ä»¶ä½¿ç”¨ftpï¼Œå³æ—¶èŠå¤©ä½¿ç”¨xmppï¼Œæµè§ˆç½‘é¡µä½¿ç”¨httpâ€¦å½“ç„¶è‡ªå·±å†™ä¸€ä¸ªrpcæ¡†æ¶ä¹Ÿå¾—å®šä¹‰è‡ªå·±çš„é€šä¿¡åè®®ã€‚ä¸ºä»€ä¹ˆè¦å®šä¹‰åè®®è¿™ä¸ªé—®é¢˜å¯¹äºå¼€å‘çš„è€æ‰‹æ¥è¯´æ²¡æœ‰å¿…è¦å»è§£é‡Šï¼Œä¸è¿‡æˆ‘è¿˜æ˜¯å¾—å•°å—¦ä¸€ä¸‹ã€‚åœ¨ç½‘ç»œåº”ç”¨ç¨‹åºä¸­ï¼Œæ‰€æœ‰çš„æ•°æ®åœ¨ç½‘ç»œä¸Šçš„ä¼ è¾“éƒ½æ˜¯äºŒè¿›åˆ¶æ ¼å¼ï¼Œä¹Ÿå°±æ˜¯0101010è¿™æ ·çš„æœºå™¨ç ã€‚å½“ç„¶ä¹Ÿæœ‰äººä¼šåé©³ï¼šä¸æ˜¯æœ‰åŸºäºå­—ç¬¦çš„æ•°æ®å—ï¼Ÿæˆ‘çš„ç†è§£æ˜¯åœ¨å®è§‚ä¸Šæ¥è¯´ç¡®å®å­˜åœ¨ï¼Œé‚£æ˜¯å› ä¸ºä¸Šå±‚çš„åè®®å·²ç»å°†ä»£è¡¨å­—ç¬¦ä¸²çš„01010è§£ç æˆäº†å¯è¯»çš„å­—ç¬¦ä¸²ã€‚ä½†æ˜¯åœ¨åº•å±‚çš„ä¼ è¾“ï¼Œä¹Ÿå°±æ˜¯åœ¨ç‰©ç†å±‚æ¯”å¦‚ç½‘çº¿ã€ç”µç£æ³¢ä¸­çš„ä¼ è¾“ä¾æ—§è¿˜æ˜¯0101ã€‚å½“ç„¶ç”¨0101æ¥æ¯”å–»ä¹Ÿæ˜¯ä¸æ°å½“ï¼Œæ›´å‡†ç¡®çš„è¯´æ³•åº”è¯¥æ˜¯ç”µå¹³ä¿¡å·ã€‚è€Œåè®®çš„ä½œç”¨æ˜¯å°†é€šä¿¡åŒæ–¹çš„å†…å®¹è¿›è¡Œè§„èŒƒã€‚å°±åƒä»¥å‰å†™ä¹¦ä¿¡çš„æ—¶å€™ï¼Œå¼€å¤´å¾—æœ‰ç§°è°“ï¼Œç„¶åå†™æ­£æ–‡ï¼Œæœ€åæ˜¯è½æ¬¾è¿™æ ·ä¸€ç§æ ¼å¼ã€‚åˆ«äººæ”¶åˆ°åå°±çŸ¥é“ï¼Œå—¯ï¼Œè¿™æ˜¯ä¸€å°ä¿¡è€Œä¸æ˜¯ä¸€ç¯‡æ•£æ–‡æˆ–è€…è‡ªä¼ ã€‚å½“ç„¶è¿™ä¸ªæ¯”å–»ä¸æ˜¯å¾ˆæ°å½“ï¼Œä½†æ˜¯å°±è¿™æ ·å§ï¼Œä¸æƒ³åºŸè¯äº†ã€‚</p>
<p>æ—¢ç„¶å®šä¹‰äº†åè®®ï¼Œé‚£ä¹ˆå°±å¾—å»å¤„ç†åè®®ã€‚Nettyä¸­æä¾›äº†å¾ˆå¤šå†…ç½®çš„åè®®è§£æçš„ç±»ã€‚é€šå¸¸è¢«ç§°ä½œç¼–è§£ç å™¨ã€‚é¡¾åæ€ä¹‰ä¹Ÿå°±æ˜¯å°†äºŒè¿›åˆ¶è½¬åŒ–ä¸ºæˆ‘ä»¬æƒ³è¦çš„æ•°æ®ç»“æ„ï¼Œè¿™æ ·æ–¹ä¾¿ç»Ÿä¸€å¤„ç†ã€‚è¿™å¼ å›¾ä¸­çš„å…·ä½“ä½“ç°å°±æ˜¯å…ˆè§£ç ï¼Œç„¶åå†å¤„ç†ï¼Œæœ€åå°†å¤„ç†ç»“æœç¼–ç åå‘é€å‡ºå»ã€‚ç¼–è§£ç å™¨å°†æ˜¯æœ¬æ–‡è®¨è®ºçš„é‡ç‚¹ã€‚ç„¶è€Œè¿˜æœ‰åˆ«çš„å‡ ä¸ªç»„ä»¶å¦‚ç©ºé—²é“¾è·¯æ£€æŸ¥<code>IdleStateChecker</code>å’Œä¸šåŠ¡å¤„ç†<code>AcceptorHandler</code>ç»„ä»¶ï¼Œè¿™äº›æ”¾åœ¨åé¢è®¨è®ºã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">boot.childHandler(<span class="keyword">new</span> ChannelInitializer&lt;Channel&gt;() &#123;</div><div class="line"></div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                ch.pipeline().addLast(</div><div class="line">                        <span class="keyword">new</span> IdleStateChecker(timer, JConstants.READER_IDLE_TIME_SECONDS, <span class="number">0</span>, <span class="number">0</span>),</div><div class="line">                        idleStateTrigger,</div><div class="line">                        CodecConfig.isCodecLowCopy() ? <span class="keyword">new</span> LowCopyProtocolDecoder() : <span class="keyword">new</span> ProtocolDecoder(),</div><div class="line">                        encoder,</div><div class="line">                        handler);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç å°±æ˜¯åˆå§‹åŒ–ç¼–è§£ç å™¨ç­‰ç»„ä»¶ã€‚å¯ä»¥çœ‹åˆ°handlerä½œä¸ºä¸šåŠ¡æ ¸å¿ƒå¤„ç†å™¨æ”¾åœ¨äº†æœ€åã€‚è¿™æ˜¯Nettyçš„æœºåˆ¶æ‰€å†³å®šçš„ã€‚å…³äºNettyçš„ä¸€äº›è®¾è®¡å¯ä»¥çœ‹çœ‹<a href="http://ifeve.com/netty-in-action-1/" target="_blank" rel="external">è¿™æœ¬ä¹¦</a>ä½œä¸ºåŸºç¡€å…¥é—¨ã€‚</p>
<p>çœ‹åˆ°è§£ç å™¨å’Œç¼–ç å™¨è¿˜æœ‰ç‚¹ä¸ä¸€æ ·ã€‚è§£ç å™¨æ˜¯ç›´æ¥newçš„æ–¹å¼æ·»åŠ åˆ°pipelineä¸­çš„ï¼Œè€Œç¼–ç å™¨æ˜¯newå¥½äº†å†æ·»åŠ åˆ°pipelineä¸­ã€‚å…¶å®å…·ä½“å·®åˆ«å°±åœ¨äºè§£ç å™¨ä¸èƒ½å…±äº«ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtocolDecoder</span> <span class="keyword">extends</span> <span class="title">ReplayingDecoder</span>&lt;<span class="title">ProtocolDecoder</span>.<span class="title">State</span>&gt; </span>&#123;</div><div class="line">	<span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@ChannelHandler</span>.Sharable</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProtocolEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">PayloadHolder</span>&gt; </span>&#123;</div><div class="line">	<span class="comment">// ...</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰€è°“çš„èƒ½å…±äº«ï¼Œå°±æ˜¯æ„å‘³ç€æ¯æ¬¡éƒ½èƒ½ä½¿ç”¨è¿™ä¸ªç¼–ç å™¨è€Œä¸éœ€è¦æ¯æ¬¡ç”¨å°±å¾—å®ä¾‹åŒ–å‡ºæ¥ã€‚è€Œè§£ç å™¨ä¸èƒ½è¢«å…±äº«ä¹Ÿæ˜¯æœ‰åŸå› çš„ã€‚å› ä¸ºè§£ç å™¨è§£ç çš„æ•°æ®å…¨éƒ¨æ¥è‡ªäºç½‘ç»œè¯·æ±‚ï¼Œç½‘ç»œé€šå¸¸è€Œè¨€æ˜¯ä¸å¯é çš„ï¼Œä¸èƒ½ä¿è¯æ¯æ¬¡éƒ½èƒ½å‘é€å®Œæ•´çš„æ•°æ®åŒ…ä¹Ÿæœ‰å¯èƒ½éœ€è¦çš„æ•°æ®è¿˜æ²¡æ”¶åˆ°ã€‚é‚£ä¹ˆå¦‚ä½•ä¿è¯æ¥å—åˆ°çš„æ•°æ®æ˜¯å®Œæ•´çš„å‘¢ï¼Ÿå®é™…ä¸Šæ˜¯æ²¡æ³•ä¿è¯ï¼Œåªèƒ½å¤Ÿâ€œå‡è£…â€æ˜¯å®Œæ•´çš„ã€‚æ‰€ä»¥decoderæ˜¯ç»§æ‰¿è‡ª<code>ReplayingDecoder</code>ã€‚è¿™ä¸ªç±»çš„ä½œç”¨ç®€å•é€šä¿—æ¥ç†è§£å°±æ˜¯å¦‚æœç½‘ç»œä¸Šçš„æ•°æ®è¿˜æ²¡å‘å®Œï¼Œæˆ‘å°±ç»§ç»­æ¥æ”¶ï¼Œç›´åˆ°æ”¶å®Œä¸ºæ­¢ã€‚å…·ä½“çš„å·¥ä½œåŸç†å¯ä»¥å‚è€ƒapiæ–‡æ¡£æˆ–è€…æºç ï¼Œè¿™é‡Œä¸å†è¿‡å¤šæ¢è®¨ã€‚ä¸ºä»€ä¹ˆç»§æ‰¿è¿™ä¸ªç±»åå°±ä¸èƒ½å…±äº«å‘¢ï¼Ÿè¿™ä¸ªç±»æ˜¯ä¸ªæ³›å‹ï¼Œå‚æ•°æ˜¯ä¸€ä¸ªstateçš„å­—çœ¼ã€‚çœ‹åˆ°è¿™é‡Œå¤§æ¦‚å¯ä»¥è”æƒ³åˆ°è¿™ä¸ªç±»è‚¯å®šå’ŒçŠ¶æ€æœ‰å…³ç³»ã€‚è¿™æ ·å°±å¾ˆå®¹æ˜“ç†è§£äº†ï¼Œæœ‰çŠ¶æ€çš„å¯¹è±¡é€šå¸¸ä¸èƒ½è¢«å…±äº«ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œçº¿ç¨‹Aå°†è¿™ä¸ªçŠ¶æ€æ”¹ä¸º1çº¿ç¨‹Bè¿™æ—¶å€™æ‹¿åˆ°æ‰§è¡ŒæƒåˆæŠŠè¿™ä¸ªçŠ¶æ€æ”¹ä¸º2ï¼Œç„¶åçº¿ç¨‹Aåˆè¦ä½¿ç”¨è¿™ä¸ªçŠ¶æ€å˜é‡äº†ï¼Œè¿™æ—¶å€™å°±ä¸æ˜¯ä»–åˆšå¼€å§‹æ”¹å˜çš„çŠ¶æ€äº†ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œå…¨éƒ¨ä¹±å¥—äº†ã€‚è¿™äº›éƒ½æ˜¯å¹¶å‘åŸºç¡€ç›¸å…³çš„å†…å®¹ï¼Œæœ‰å…´è¶£å¯ä»¥å»è°·æ­Œã€‚è¿™é‡Œä¸å†è¿‡å¤šæè¿°ã€‚è€Œencodeåˆ™æ²¡æœ‰çŠ¶æ€å˜é‡ï¼Œéœ€è¦ç¼–ç çš„æ•°æ®ä¸€å®šæ˜¯ç¡®å®šçš„ï¼Œä¸å­˜åœ¨è§£ç å™¨ä¸­æ•°æ®ä¸å®Œæ•´çš„æƒ…å†µã€‚å› æ­¤ä½¿ç”¨å…±äº«å®ä¾‹æ²¡ä»€ä¹ˆé—®é¢˜ã€‚å…·ä½“å¯ä»¥çœ‹çœ‹å…¶ä¸­çš„ä»£ç å®ç°ï¼š<a href="https://github.com/Mr-Vincent/Jupiter/blob/master/jupiter-transport/jupiter-transport-netty/src/main/java/org/jupiter/transport/netty/handler/ProtocolDecoder.java" target="_blank" rel="external">ProtocolDecoder</a>  <a href="https://github.com/Mr-Vincent/Jupiter/blob/master/jupiter-transport/jupiter-transport-netty/src/main/java/org/jupiter/transport/netty/handler/ProtocolEncoder.java" target="_blank" rel="external">ProtocolEncoder</a></p>
<p>è§£é‡Šå®Œè¿™äº›é¸¡æ¯›è’œçš®çš„ç»†èŠ‚ï¼Œæ¥ä¸‹æ¥å¼€å§‹åˆ†æä¸€ä¸‹è¿™ä¸ªåè®®çš„å®šä¹‰ä»¥åŠè§£æã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">* **************************************************************************************************</div><div class="line">*                                          Protocol</div><div class="line">*  â”Œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”</div><div class="line">*       2   â”‚   1   â”‚    1   â”‚     8     â”‚      4      â”‚</div><div class="line">*  â”œ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”¤</div><div class="line">*           â”‚       â”‚        â”‚           â”‚             â”‚</div><div class="line">*  â”‚  MAGIC   Sign    Status   Invoke Id    Body Size                    Body Content              â”‚</div><div class="line">*           â”‚       â”‚        â”‚           â”‚             â”‚</div><div class="line">*  â”” â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”˜</div><div class="line">*</div><div class="line">* æ¶ˆæ¯å¤´16ä¸ªå­—èŠ‚å®šé•¿</div><div class="line">* = 2 // magic = (short) 0xbabe</div><div class="line">* + 1 // æ¶ˆæ¯æ ‡å¿—ä½, ä½åœ°å€4ä½ç”¨æ¥è¡¨ç¤ºæ¶ˆæ¯ç±»å‹request/response/heartbeatç­‰, é«˜åœ°å€4ä½ç”¨æ¥è¡¨ç¤ºåºåˆ—åŒ–ç±»å‹</div><div class="line">* + 1 // çŠ¶æ€ä½, è®¾ç½®è¯·æ±‚å“åº”çŠ¶æ€</div><div class="line">* + 8 // æ¶ˆæ¯ id, long ç±»å‹, æœªæ¥jupiterå¯èƒ½å°†idé™åˆ¶åœ¨48ä½, ç•™å‡ºé«˜åœ°å€çš„16ä½ä½œä¸ºæ‰©å±•å­—æ®µ</div><div class="line">* + 4 // æ¶ˆæ¯ä½“ body é•¿åº¦, int ç±»å‹</div><div class="line">*</div></pre></td></tr></table></figure>
<p>ä½œè€…åœ¨ä»£ç ä¸­å°†åè®®æ ¼å¼å®Œå…¨æ ‡æ³¨å‡ºæ¥äº†:16å­—èŠ‚çš„æ¶ˆæ¯å¤´+æ¶ˆæ¯ä½“ã€‚æ¶ˆæ¯å¤´ä¸­çš„MAGICå­—æ®µä»…ä»…æ˜¯ä¸ºäº†æ ‡è¯†è¿™ä¸ªæ•°æ®åŒ…æ˜¯å±äºjupiterã€‚å°±åƒjava classæ–‡ä»¶ä»¥<code>0xCAFEBABE</code>å¼€å¤´ä¸€æ ·ã€‚æ²¡æœ‰å®é™…çš„æ„ä¹‰ï¼Œä»…ä»…åšä¸ªæ ‡è¯†è€Œå·²ã€‚å…¶ä»–çš„å­—æ®µä¹Ÿå°±æ²¡ä»€ä¹ˆå¯è¯´çš„äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> USE_COMPOSITE_BUF = SystemPropertyUtil.getBoolean(<span class="string">"jupiter.io.decoder.composite.buf"</span>, <span class="keyword">false</span>);</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ProtocolDecoder</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">super</span>(State.MAGIC);</div><div class="line">       <span class="keyword">if</span> (USE_COMPOSITE_BUF) &#123;</div><div class="line">           setCumulator(COMPOSITE_CUMULATOR);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">   <span class="keyword">enum</span> State &#123;</div><div class="line">       MAGIC,</div><div class="line">       SIGN,</div><div class="line">       STATUS,</div><div class="line">       ID,</div><div class="line">       BODY_SIZE,</div><div class="line">       BODY</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>è§£ç å™¨çš„æ„é€ å‡½æ•°ä¸­ç›´æ¥è°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼Œå°†æšä¸¾ç±»å‹<code>State</code>ä¼ å…¥ã€‚è¿™ä¸ªæšä¸¾ç±»å‹æ‰€ä»£è¡¨çš„å°±æ˜¯è¦è§£æåè®®æ•°æ®ä¸­çš„ä½ç½®ï¼ˆä¸‹æ ‡ï¼‰ã€‚å› æ­¤æ„é€ å™¨ä¸­ä¼ å…¥çš„å½“ç„¶æ˜¯åè®®çš„ç¬¬ä¸€ä¸ªå­—æ®µï¼Œä¹Ÿå°±è¡¨ç¤ºä»ç¬¬ä¸€ä¸ªä½ç½®å¼€å§‹è§£æã€‚ç„¶åæœ‰ä¸€ä¸ªå¸ƒå°”æ ‡è¯†ï¼Œè¿™ä¸ªå˜é‡ä»ç³»ç»Ÿå˜é‡ä¸­è·å–ï¼Œç”¨æ¥å†³å®šæ˜¯å¦ä½¿ç”¨<code>COMPOSITE_CUMULATOR</code>ã€‚é»˜è®¤çš„CUMULATORæ˜¯<code>MERGE_CUMULATOR</code>.åŒºåˆ«å¯èƒ½åœ¨æ€§èƒ½ä¸Šæœ‰ç‚¹å·®è·å§ã€‚å…·ä½“å·®å¼‚å¾—å»ç ”ç©¶æºç ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> JProtocolHeader header = <span class="keyword">new</span> JProtocolHeader();</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (state()) &#123;</div><div class="line">            <span class="keyword">case</span> MAGIC:</div><div class="line">                checkMagic(in.readShort());         <span class="comment">// MAGIC</span></div><div class="line">                checkpoint(State.SIGN);</div><div class="line">            <span class="keyword">case</span> SIGN:</div><div class="line">                header.sign(in.readByte());         <span class="comment">// æ¶ˆæ¯æ ‡å¿—ä½</span></div><div class="line">                checkpoint(State.STATUS);</div><div class="line">            <span class="keyword">case</span> STATUS:</div><div class="line">                header.status(in.readByte());       <span class="comment">// çŠ¶æ€ä½</span></div><div class="line">                checkpoint(State.ID);</div><div class="line">            <span class="keyword">case</span> ID:</div><div class="line">                header.id(in.readLong());           <span class="comment">// æ¶ˆæ¯id</span></div><div class="line">                checkpoint(State.BODY_SIZE);</div><div class="line">            <span class="keyword">case</span> BODY_SIZE:</div><div class="line">                header.bodySize(in.readInt());      <span class="comment">// æ¶ˆæ¯ä½“é•¿åº¦</span></div><div class="line">                checkpoint(State.BODY);</div><div class="line">            <span class="keyword">case</span> BODY:</div><div class="line">                <span class="keyword">switch</span> (header.messageCode()) &#123;</div><div class="line">                    <span class="keyword">case</span> JProtocolHeader.HEARTBEAT:</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="keyword">case</span> JProtocolHeader.REQUEST: &#123;</div><div class="line">                        <span class="keyword">int</span> length = checkBodySize(header.bodySize());</div><div class="line">                        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</div><div class="line">                        in.readBytes(bytes);</div><div class="line"></div><div class="line">                        JRequestPayload request = <span class="keyword">new</span> JRequestPayload(header.id());</div><div class="line">                        request.timestamp(SystemClock.millisClock().now());</div><div class="line">                        request.bytes(header.serializerCode(), bytes);</div><div class="line"></div><div class="line">                        out.add(request);</div><div class="line"></div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">case</span> JProtocolHeader.RESPONSE: &#123;</div><div class="line">                        <span class="keyword">int</span> length = checkBodySize(header.bodySize());</div><div class="line">                        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</div><div class="line">                        in.readBytes(bytes);</div><div class="line"></div><div class="line">                        JResponsePayload response = <span class="keyword">new</span> JResponsePayload(header.id());</div><div class="line">                        response.status(header.status());</div><div class="line">                        response.bytes(header.serializerCode(), bytes);</div><div class="line"></div><div class="line">                        out.add(response);</div><div class="line"></div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">default</span>:</div><div class="line">                        <span class="keyword">throw</span> IoSignals.ILLEGAL_SIGN;</div><div class="line">                &#125;</div><div class="line">                checkpoint(State.MAGIC);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æ­£çœŸçš„è§£æé€»è¾‘å…¨éƒ¨åœ¨<code>decode</code>æ–¹æ³•ä¸­ã€‚è¿™é‡Œçš„æ¯ä¸ªcaseå¹¶æ²¡æœ‰breakï¼Œé“ç†å¾ˆç®€å•ï¼Œæ¯è§£æä¸€æ®µæ•°æ®åå¾—æ¥ç€ç»§ç»­å¾€ä¸‹è§£æï¼Œå¦‚æœbreakæ‰äº†åé¢çš„æ•°æ®ä¸å…¨éƒ½æ”¾å¼ƒè§£æäº†å—ï¼Ÿæ¯å½“è§£æåˆ°ä¸€ä¸ªä½ç½®ï¼Œéƒ½å°†è¿™ä¸ªä½ç½®ä¸Šè¯»å–çš„æ•°æ®æ”¾åˆ°<code>header</code>å˜é‡ä¸­ï¼ŒåŒæ—¶å°†æ¥ä¸‹æ¥éœ€è¦è§£æçš„ä½ç½®è®°å½•ä¸‹æ¥ï¼ˆé€šè¿‡<code>checkpoint(...)</code>æ–¹æ³•ï¼‰ã€‚ä¹‹æ‰€ä»¥è¦è®°å½•ä¸‹æ¥ï¼Œä¸‡ä¸€æŸä¸ªä½ç½®è§£æå‡ºé”™ï¼Œä¸‹æ¬¡å°±ä¸ç”¨ä»å¤´å†æ¥äº†ï¼Œç›´æ¥ä¸Šæ¬¡å‡ºé”™çš„ä½ç½®æ¥ç€æ¥å°±è¡Œäº†ï¼Œä¹Ÿæ˜¯ä¸ºäº†æé«˜æ€§èƒ½ã€‚ç„¶è€Œè§£æåˆ°bodyéƒ¨åˆ†çš„æ—¶å€™ï¼Œheaderé‡Œé¢å†…å®¹éƒ½å·²ç»å…¨éƒ¨å¡«å……å¥½äº†ã€‚æ¥ä¸‹æ¥å°±æ˜¯æ ¹æ®æ¶ˆæ¯ç±»å‹æ¥å¤„ç†bodyé‡Œçš„å†…å®¹ã€‚å¦‚æœæ˜¯å¿ƒè·³åŒ…ï¼Œé‚£ä¹ˆä»€ä¹ˆéƒ½ä¸åšç›´æ¥è¿”å›ï¼Œå› ä¸ºbodyé‡Œè‚¯å®šæ˜¯æ²¡æœ‰æ•°æ®çš„ã€‚å¦‚æœæ˜¯è¯·æ±‚åŒ…(<code>REQUEST</code>ç±»å‹)ï¼Œå…ˆä»headeré‡Œè¯»å–è¿™ä¸ªbodyåˆ°åº•æœ‰å¤šé•¿ï¼Œç„¶åå†å»è¯»è¿™ä¹ˆé•¿çš„æ•°æ®ï¼Œæœ€åé€šè¿‡<code>JRequestPayload</code>å¯¹è±¡å°†è¿™ä¸ªbodyæ•°æ®å°è£…èµ·æ¥ï¼ŒåŒæ—¶å°†æ¶ˆæ¯idå’Œåºåˆ—åŒ–ç±»å‹codeä¹Ÿå°è£…è¿›å»äº†ã€‚å“åº”åŒ…ç±»å‹é€»è¾‘ä¸ä¹‹ç±»ä¼¼ã€‚æ•´ä¸ªè§£ç å™¨è§£æé€»è¾‘å°±å®Œæˆäº†ã€‚</p>
<p>ä¸ä¹‹å¯¹åº”çš„å°±æ˜¯ç¼–ç å™¨äº†ï¼Œç¼–ç å™¨é€»è¾‘æ›´ç®€å•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, PayloadHolder msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> JRequestPayload) &#123;</div><div class="line">            doEncodeRequest((JRequestPayload) msg, out);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> JResponsePayload) &#123;</div><div class="line">            doEncodeResponse((JResponsePayload) msg, out);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(Reflects.simpleClassName(msg));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doEncodeRequest</span><span class="params">(JRequestPayload request, ByteBuf out)</span> </span>&#123;</div><div class="line">        <span class="keyword">byte</span> sign = JProtocolHeader.toSign(request.serializerCode(), JProtocolHeader.REQUEST);</div><div class="line">        <span class="keyword">long</span> invokeId = request.invokeId();</div><div class="line">        <span class="keyword">byte</span>[] bytes = request.bytes();</div><div class="line">        <span class="keyword">int</span> length = bytes.length;</div><div class="line"></div><div class="line">        out.writeShort(JProtocolHeader.MAGIC)</div><div class="line">                .writeByte(sign)</div><div class="line">                .writeByte(<span class="number">0x00</span>)</div><div class="line">                .writeLong(invokeId)</div><div class="line">                .writeInt(length)</div><div class="line">                .writeBytes(bytes);</div><div class="line">    &#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doEncodeResponse</span><span class="params">(JResponsePayload response, ByteBuf out)</span> </span>&#123;</div><div class="line">        <span class="keyword">byte</span> sign = JProtocolHeader.toSign(response.serializerCode(), JProtocolHeader.RESPONSE);</div><div class="line">        <span class="keyword">byte</span> status = response.status();</div><div class="line">        <span class="keyword">long</span> invokeId = response.id();</div><div class="line">        <span class="keyword">byte</span>[] bytes = response.bytes();</div><div class="line">        <span class="keyword">int</span> length = bytes.length;</div><div class="line"></div><div class="line">        out.writeShort(JProtocolHeader.MAGIC)</div><div class="line">                .writeByte(sign)</div><div class="line">                .writeByte(status)</div><div class="line">                .writeLong(invokeId)</div><div class="line">                .writeInt(length)</div><div class="line">                .writeBytes(bytes);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å’Œè§£ç å™¨ç›¸åï¼Œç¼–ç å™¨å°±æ˜¯å°†å¯¹è±¡ä¸­çš„æ•°æ®æŒ‰åè®®ä¸­çš„å®šä¹‰æŒ¨ä¸ªå†™åˆ°bufä¸­ã€‚</p>
<p>ä»¥ä¸Šï¼Œjupiterä¸­çš„æ¶ˆæ¯ç¼–è§£ç å™¨çš„å®ç°å°±å…¨éƒ¨æ•´ç†å®Œäº†ã€‚å½“ç„¶è¿˜æœ‰ç©ºé—²é“¾è·¯æ£€æµ‹éƒ¨åˆ†ï¼Œå› æ­¤æˆ‘å†³å®šæš‚æ—¶æ”¾å¼ƒè¿™éƒ¨åˆ†ï¼Œå¤ªå¤æ‚äº†ï¼Œç­‰æ‰€æœ‰é€»è¾‘æ•´ç†å®Œæ¯•åå†æ¥ç€å¡«å‘ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ä¸Šä¸€ç¯‡ä¸­ä»‹ç»åˆ°å…³äºjupiterçš„åº•å±‚é€šä¿¡æ¨¡å—transportçš„éƒ¨åˆ†å®ç°ã€‚ä»…ä»…åªæ˜¯è®¨è®ºäº†æ•´ä¸ªserverçš„åˆå§‹åŒ–ä»¥åŠå¯åŠ¨æµç¨‹ã€‚å¾ˆå¤šç»†ææœ«èŠ‚å…¶å®è¿˜æ²¡æœ‰æ¶‰åŠåˆ°ï¼Œä¾‹å¦‚tcpå‚æ•°è®¾ç½®ï¼Œè¶…æ—¶æœºåˆ¶ï¼Œç¼–è§£ç å™¨ç­‰ç­‰å®ç°ç»†èŠ‚ã€‚è¿™äº›ä¸œè¥¿å°†ä¼šé€æ­¥è¢«æ¶ˆåŒ–åˆ†è§£ã€‚è€Œæœ¬æ–‡çš„ä¸»é¢˜æ˜¯jupiterçš„ä¸šåŠ¡
    
    </summary>
    
      <category term="ä¸€èµ·è¯»æºç " scheme="http://www.wei-dong.top/categories/%E4%B8%80%E8%B5%B7%E8%AF%BB%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="Jupiter" scheme="http://www.wei-dong.top/tags/Jupiter/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€èµ·å­¦RPC(ä¸€)</title>
    <link href="http://www.wei-dong.top/2018/08/08/%E4%B8%80%E8%B5%B7%E5%AD%A6RPC(%E4%B8%80)/"/>
    <id>http://www.wei-dong.top/2018/08/08/ä¸€èµ·å­¦RPC(ä¸€)/</id>
    <published>2018-08-08T08:17:23.000Z</published>
    <updated>2018-08-08T08:33:13.567Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¸Šä¸€ç¯‡ä¸­åºŸè¯äº†å¾ˆå¤šâ€œå¤§æ¦‚â€ä¸ç›¸å…³çš„ä¸œè¥¿ã€‚è€Œè¿™ç¯‡å°±è¦è®¤è®¤çœŸçœŸçš„å¼€å§‹è®²å¹²è´§äº†(ä¹Ÿæœ‰å¯èƒ½æ˜¯æ°´è´§ï¼Œè°çŸ¥é“å‘¢)ã€‚</p>
<p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†ä¸rpcä¸­é—´ä»¶ç›¸å…³çš„ä½†è”ç³»ä¸æ˜¯å¾ˆå¤§çš„spring xmlæ ‡ç­¾çš„è‡ªå®šä¹‰å®ç°ã€‚å¯ä»¥è¯´æ˜¯æ²¡æœ‰å¤ªå¤šæ ¸å¿ƒçš„ä¸œè¥¿ï¼Œå…¨æ–‡ä¸­çš„å…³é”®å­—å°±æ˜¯â€œæŠ„â€ã€‚æ²¡é”™ï¼Œåªè¦æœ‰å®˜æ–¹æ–‡æ¡£ï¼Œä»€ä¹ˆéƒ½èƒ½ç…§ç€æŠ„ã€‚å®åœ¨ä¸è¡Œï¼Œå¯¹ç€æºç çš„å®ç°ä¹Ÿèƒ½æŠ„ä¸€æŠŠã€‚è”ç³»åˆ°ç›®å‰çš„å·¥ä½œä¸­ï¼Œä¹Ÿæ˜¯å¤åˆ¶ç²˜è´´ä¸€æŠŠæ¢­ã€‚ä¸å¾—ä¸è¯´ç°åœ¨çš„ç¼–ç è¦æ±‚æ˜¯è¶Šæ¥è¶Šä½äº†ã€‚</p>
<p>æ€»æ‰€å‘¨çŸ¥ï¼Œrpcé¡¾åæ€ä¹‰æ˜¯è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼Œæ‰€è°“çš„è¿œç¨‹å°±æ˜¯ä¸åœ¨ä¸€ä¸ªæœºå™¨ä¸Šã€‚å› æ­¤æœºå™¨ä¸æœºå™¨ä¹‹é—´çš„å¯é é€šä¿¡å¯ä»¥è¯´æ˜¯rpcçš„åŸºç¡€è®¾æ–½äº†ã€‚é‚£ä¹ˆæœ¬æ–‡çš„é‡ç‚¹å°±æ˜¯æ·±å…¥å‰–æè¿™ä¸ªåŸºç¡€è®¾æ–½çš„å…·ä½“å®ç°ï¼ˆçš„å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œå…¶ä½™çš„è¿˜æ²¡è®¤çœŸçœ‹ï¼‰ã€‚</p>
<p>åœ¨jupiterä¸­ï¼Œå¯¹è¿™äº›åŸºç¡€è®¾æ–½çš„è®¾è®¡å¯ç®—æ˜¯ä¸‹äº†ä¸€ç•ªåŠŸå¤«çš„ã€‚è‡³å°‘æˆ‘çœ‹æ˜ç™½èŠ±äº†ä¸€ç‚¹æ—¶é—´çš„ã€‚åœ¨jupiterçš„ä»£ç ç»„ç»‡ä¸­ï¼Œå°†ç½‘ç»œä¼ è¾“è¿™ä¸€å—å•ç‹¬æ•´æˆä¸€ä¸ªæ¨¡å—ã€‚å¾ˆå¤šå¼€æºé¡¹ç›®ä¹Ÿæ˜¯è¿™æ ·åšçš„ï¼Œç®—æ˜¯ä¸­è§„ä¸­çŸ©äº†ã€‚</p>
<p><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/structure-2018-08-01-15-55-21.jpg?raw=true" alt="image"></p>
<p>åŒæ—¶ï¼Œä¸ºäº†ä»¥åçš„æ‹“å±•ï¼Œä¼ è¾“å±‚è¿˜å®šä¹‰äº†ä¸€ä¸ªé«˜å±‚æ¬¡çš„æŠ½è±¡æ¨¡å—apiã€‚ç„¶åæ ¹æ®è‡ªå·±çš„å–œå¥½å¯ä»¥è‡ªç”±å»åˆ‡æ¢ä¼ è¾“å±‚å®ç°ã€‚è¿™é‡Œé»˜è®¤åªæœ‰åŸºäºNettyçš„å®ç°ã€‚å¦‚æœæƒ³æ·»åŠ Minaçš„å®ç°ä¹Ÿå¾ˆå®¹æ˜“ï¼Œæ·»åŠ Minaä¾èµ–ç„¶åå®ç°apiä¸­çš„æ¥å£å°±è¡Œäº†ã€‚</p>
<p>æ¥ä¸‹æ¥å°±ä»”ç»†æ¢ç´¢ä¸€ä¸‹åŸºäºNettyçš„æœåŠ¡ç«¯çš„å®ç°ç»†èŠ‚ã€‚</p>
<h2 id="æŠ½è±¡æ¥å£"><a href="#æŠ½è±¡æ¥å£" class="headerlink" title="æŠ½è±¡æ¥å£"></a>æŠ½è±¡æ¥å£</h2><p>jupiterçš„æœåŠ¡ç«¯å±‚æ¬¡ç»“æ„ååˆ†ç®€å•ã€‚ç»§æ‰¿å…³ç³»ä¹Ÿå¾ˆæ¸…æ™°ã€‚è¿™å¼ å›¾å¾ˆæ¸…æ™°çš„æè¿°äº†ç»§æ‰¿å…³ç³»ï¼š<br><img src="https://github.com/Mr-Vincent/pic-bed/blob/master/images/acceptor-2018-08-01-15-50-40.jpg?raw=true" alt="image"></p>
<p>é€šè¿‡å‘½åå¯ä»¥ä½“ç°å‡ºæ¥è¿™äº›æŠ½è±¡ç±»æˆ–æ¥å£çš„å«ä¹‰ã€‚æˆ‘æƒ³å†™ä»£ç çš„æœ€é«˜å¢ƒç•Œå°±æ˜¯èƒ½åšåˆ°å˜é‡åèƒ½æ°å¦‚å…¶åˆ†çš„è¡¨è¾¾å…¶åŠŸç”¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transporter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Returns the transport protocol</div><div class="line">     */</div><div class="line">    <span class="function">Protocol <span class="title">protocol</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ä¼ è¾“å±‚åè®®.</div><div class="line">     */</div><div class="line">    <span class="keyword">enum</span> Protocol &#123;</div><div class="line">        TCP,</div><div class="line">        DOMAIN  <span class="comment">// Unix domain socket</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€é«˜å±‚æ¬¡çš„æ¥å£ä»…ä»…åªå®šä¹‰äº†ä¸€ä¸ªæ–¹æ³•ï¼Œè¿”å›åˆ°åº•ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆåè®®ã€‚è¿™é‡Œå¯é€‰çš„åªæœ‰TCPæˆ–è€…DOMAINã€‚å…³äºtcpæ— éœ€å¤šè¨€ï¼Œä½†æ˜¯è¿™ä¸ªunix domain socketå°±ä¸æ˜¯é‚£ä¹ˆå¸¸è§äº†ã€‚ç®€å•æ¥è®²å°±æ˜¯ç”¨äºæœºå™¨å†…çš„é€šä¿¡ï¼Œä¸æ˜¯æœºå™¨é—´çš„é€šä¿¡ã€‚å…·ä½“ä½¿ç”¨åœºæ™¯æˆ‘é—®äº†ä¸€ä¸‹ä½œè€…feng.jcï¼Œä»–å›å¤äº†ä¸€ä¸ªè¯ï¼šservice mesh.ç„¶åå°±æ²¡æœ‰ç„¶åäº†ã€‚å¯¹æ­¤å’±æš‚ä¸”ä¸ç®¡ã€‚</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯æ¯”è¾ƒç»†åŒ–çš„ä¸€ä¸ªæ¥å£äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">JAcceptor</span> <span class="keyword">extends</span> <span class="title">Transporter</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç»‘å®šçš„åœ°å€</div><div class="line">     */</div><div class="line">    <span class="function">SocketAddress <span class="title">localAddress</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * ç»‘å®šçš„ç«¯å£.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">boundPort</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Acceptor options [parent, child].</div><div class="line">     */</div><div class="line">    <span class="function">JConfigGroup <span class="title">configGroup</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è¿”å›rpcå¤„ç†å™¨ </div><div class="line">     */</div><div class="line">    <span class="function">ProviderProcessor <span class="title">processor</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è®¾ç½®ProviderProcessor ä¹Ÿå°±æ˜¯å®é™…çš„ä¸šåŠ¡é€»è¾‘å…¨éƒ¨ç”±è¿™ä¸ªä¸œè¥¿å¤„ç†</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">withProcessor</span><span class="params">(ProviderProcessor processor)</span></span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Start the server and wait until the server socket is closed.</div><div class="line">     * é»˜è®¤è°ƒç”¨start(true)</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Start the server.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">boolean</span> sync)</span> <span class="keyword">throws</span> InterruptedException</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Shutdown the server gracefully.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">shutdownGracefully</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ¥å£ä¹Ÿå¾ˆæ¸…æ™°ç®€å•ã€‚ç¬¦åˆä¸€èˆ¬çš„æ€è·¯ã€‚æ¥ä¸‹æ¥å°±æ˜¯è¿™äº›æ¥å£çš„æŠ½è±¡å®ç°ã€‚</p>
<h2 id="æŠ½è±¡å®ç°"><a href="#æŠ½è±¡å®ç°" class="headerlink" title="æŠ½è±¡å®ç°"></a>æŠ½è±¡å®ç°</h2><p>åœ¨èµ°è¯»æŠ½è±¡å®ç°é€»è¾‘ä¹‹å‰ï¼Œæœ‰å¿…è¦çœ‹çœ‹å¦‚æœè¦ç›´æ¥å¯åŠ¨è¿™ä¸ªtransporterè¯¥æ€ä¹ˆåšã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        JAcceptor acceptor = <span class="keyword">new</span> JNettyTcpAcceptor(<span class="number">9999</span>);</div><div class="line">        acceptor.start();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä¸å¾—ä¸è¯´æ˜¯éå¸¸ç®€å•ã€‚ä½†æ˜¯èƒŒåçš„å·¥ä½œå¯è°“æ˜¯éå¸¸å¤šã€‚</p>
<p><code>JNettyTcpAcceptor</code>æ˜¯æœ€åº•å±‚çš„å®ç°ç±»ã€‚åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ä¼šä¼ å…¥å‚æ•°ç«¯å£å·ï¼Œè¿™ç‚¹æ— å¯åšéæ¯«æ— äº‰è®®ã€‚ä¸ä¼ ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå› ä¸ºæ„é€ å™¨æœ‰é‡è½½ï¼Œä¼šä¼ å…¥é»˜è®¤ç«¯å£å·18090ã€‚è€Œå®é™…ä¸Šæ˜¯å»è°ƒç”¨çš„çˆ¶ç±»çš„æ„é€ å™¨ã€‚çˆ¶ç±»æ„é€ å™¨çš„é‡è½½æ–¹æ³•å¾ˆå¤šï¼Œå°±è´´å‡ºä¸€ä¸ªå…¨å‚æ•°çš„é‡è½½å®ç°,å…¶ä½™çš„è¯·è‡ªè¡Œè„‘è¡¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyTcpAcceptor</span><span class="params">(SocketAddress localAddress, <span class="keyword">int</span> nBosses, <span class="keyword">int</span> nWorkers, <span class="keyword">boolean</span> isNative)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(Protocol.TCP, localAddress, nBosses, nWorkers);</div><div class="line">        <span class="keyword">this</span>.isNative = isNative;</div><div class="line">        init();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ç„¶è€Œæ¶å¿ƒå¿ƒçš„æ˜¯è¿™ä¸ªæ„é€ å™¨ä¹Ÿå»è°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ã€‚å¯¹äºèªæ˜çš„äººæ¥è¯´è¿™éƒ½ä¸æ˜¯äº‹å„¿ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyAcceptor</span><span class="params">(Protocol protocol, SocketAddress localAddress, <span class="keyword">int</span> nBosses, <span class="keyword">int</span> nWorkers)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.protocol = protocol;</div><div class="line">        <span class="keyword">this</span>.localAddress = localAddress;</div><div class="line">        <span class="keyword">this</span>.nBosses = nBosses;</div><div class="line">        <span class="keyword">this</span>.nWorkers = nWorkers;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>å€¼å¾—ä¸€æçš„ä»…ä»…åªæœ‰åé¢ä¸¤ä¸ªå‚æ•°ã€‚é¡¾åæ€ä¹‰ä»£è¡¨çš„æ˜¯bossçš„çº¿ç¨‹æ•°å’Œworkerçš„çº¿ç¨‹æ•°ã€‚å¦‚æœå¯¹nettyå¾ˆç†Ÿæ‚‰è¿™ç‚¹å°±ä¸éœ€è¦è§£é‡Šå¤ªå¤šã€‚ç„¶åå°±æ˜¯<code>init()</code>æ–¹æ³•äº†ã€‚è¿™ä¸ªinitæ–¹æ³•çš„æ ¸å¿ƒå®ç°å®é™…ä¸Šæ˜¯åœ¨é¡¶å±‚çˆ¶ç±»ä¸­å®Œæˆçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        ThreadFactory bossFactory = bossThreadFactory(<span class="string">"jupiter.acceptor.boss"</span>);</div><div class="line">        ThreadFactory workerFactory = workerThreadFactory(<span class="string">"jupiter.acceptor.worker"</span>);</div><div class="line">        boss = initEventLoopGroup(nBosses, bossFactory);</div><div class="line">        worker = initEventLoopGroup(nWorkers, workerFactory);</div><div class="line"></div><div class="line">        bootstrap = <span class="keyword">new</span> ServerBootstrap().group(boss, worker);</div><div class="line"></div><div class="line">        <span class="comment">// parent options</span></div><div class="line">        JConfig parent = configGroup().parent();</div><div class="line">        parent.setOption(JOption.IO_RATIO, <span class="number">100</span>);</div><div class="line"></div><div class="line">        <span class="comment">// child options</span></div><div class="line">        JConfig child = configGroup().child();</div><div class="line">        child.setOption(JOption.IO_RATIO, <span class="number">100</span>);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç åšäº†3ä»¶äº‹ã€‚åˆ›å»ºäº†bosså’Œworkerï¼›å®ä¾‹åŒ–äº†ServerBootstrapï¼›æŠŠå‚æ•°é…ç½®èµ·æ¥äº†ã€‚ä»…ä»…åªåšäº†è¿™äº›äº‹æƒ…ï¼Œå¾ˆç¬¦åˆæŠ½è±¡ç±»çš„é£æ ¼ã€‚éœ€è¦ç»†åŒ–çš„æ“ä½œè¯·ç»§æ‰¿ï¼Œç„¶åè‡ªå®šä¹‰å®ç°ï¼Œçˆ±å’‹å’‹åœ°ã€‚åæ­£æœ€åè‚¯å®šä¼šå»è°ƒç”¨çš„å­ç±»å®ç°ï¼Œå‰ææ˜¯åˆ«æŠŠæˆ‘å…¨éƒ¨è¦†ç›–æ‰ï¼Œå¢é‡å»æ‹“å±•å°±è¡Œã€‚</p>
<p>è¯´äº†è¿™ä¹ˆå¤šï¼Œå®é™…ä¸ŠæŠ½è±¡å®ç°å°±æ˜¯å¯¹serverçš„â€œå¤§è‡´â€å®ç°ã€‚å…·ä½“çš„å®šåˆ¶å¾—äº¤ç»™å­ç±»å®Œæˆã€‚</p>
<h2 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h2><p>åœ¨ä¸Šé¢çš„demoä¸­å®ä¾‹åŒ–çš„ä¸€å®šæ˜¯ä¸€ä¸ªå…·ä½“å­ç±»ã€‚å­ç±»é€šè¿‡ä¸€ç³»åˆ—çˆ¶ç±»ä¸­çš„åˆå§‹åŒ–æ–¹æ³•å®Œæˆäº†å‰æœŸçš„å‡†å¤‡å·¥ä½œï¼štcpå‚æ•°è®¾ç½®ã€bosså’Œworkerçš„è®¾ç½®ç­‰ã€‚è€Œæ­£çœŸå¼€å¯ä¸€ä¸ªserverçš„æ–¹æ³•æ˜¯<code>start()</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">       start(<span class="keyword">true</span>);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">boolean</span> sync)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">       <span class="comment">// wait until the server socket is bind succeed.</span></div><div class="line">       ChannelFuture future = bind(localAddress).sync();</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</div><div class="line">           logger.info(<span class="string">"Jupiter TCP server start"</span> + (sync ? <span class="string">", and waits until the server socket closed."</span> : <span class="string">"."</span>)</div><div class="line">                   + JConstants.NEWLINE + <span class="string">" &#123;&#125;."</span>, toString());</div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (sync) &#123;</div><div class="line">           <span class="comment">// wait until the server socket is closed.</span></div><div class="line">           future.channel().closeFuture().sync();</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p><code>start()</code>æ–¹æ³•åªæ˜¯å…¥å£ï¼Œæ ¸å¿ƒæ˜¯<code>bind()</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress)</span> </span>&#123;</div><div class="line">       ServerBootstrap boot = bootstrap();</div><div class="line"></div><div class="line">       initChannelFactory();</div><div class="line"></div><div class="line">       boot.childHandler(<span class="keyword">new</span> ChannelInitializer&lt;Channel&gt;() &#123;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(Channel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">               ch.pipeline().addLast(</div><div class="line">                       <span class="keyword">new</span> IdleStateChecker(timer, JConstants.READER_IDLE_TIME_SECONDS, <span class="number">0</span>, <span class="number">0</span>),</div><div class="line">                       idleStateTrigger,</div><div class="line">                       CodecConfig.isCodecLowCopy() ? <span class="keyword">new</span> LowCopyProtocolDecoder() : <span class="keyword">new</span> ProtocolDecoder(),</div><div class="line">                       encoder,</div><div class="line">                       handler);</div><div class="line">           &#125;</div><div class="line">       &#125;);</div><div class="line"></div><div class="line">       setOptions();</div><div class="line"></div><div class="line">       <span class="keyword">return</span> boot.bind(localAddress);</div><div class="line">   &#125;</div><div class="line">   </div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannelFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">       SocketChannelProvider.SocketType socketType = socketType();</div><div class="line">       <span class="keyword">switch</span> (socketType) &#123;</div><div class="line">           <span class="keyword">case</span> NATIVE_EPOLL:</div><div class="line">               bootstrap().channelFactory(SocketChannelProvider.NATIVE_EPOLL_ACCEPTOR);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> NATIVE_KQUEUE:</div><div class="line">               bootstrap().channelFactory(SocketChannelProvider.NATIVE_KQUEUE_ACCEPTOR);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">case</span> JAVA_NIO:</div><div class="line">               bootstrap().channelFactory(SocketChannelProvider.JAVA_NIO_ACCEPTOR);</div><div class="line">               <span class="keyword">break</span>;</div><div class="line">           <span class="keyword">default</span>:</div><div class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid socket type: "</span> + socketType);</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>ä¸å¾—ä¸è¯´ï¼Œbindæ–¹æ³•å±‚æ¬¡ä¹Ÿå¾ˆæ¸…æ™°ã€‚å…¶ä¸­è°ƒç”¨äº†ä¸€ä¸ª<code>initChannelFactory()</code>æ–¹æ³•ï¼Œå…¶å®æ²¡æœ‰ä»€ä¹ˆé«˜æ·±è«æµ‹çš„åœ°æ–¹ã€‚ç®€å•ç†è§£ä¸ºå’Œä¸‹é¢çš„ä»£ç ç±»ä¼¼ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</div><div class="line">b.group(bossGroup, workerGroup).channel(NioServerSocketChannel.class)</div></pre></td></tr></table></figure>
<p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæ•´ä¸ªserverçš„å¯åŠ¨æµç¨‹å°±ç»“æŸäº†ã€‚æ•´ä¸ªæµç¨‹ååˆ†å¹²å‡€ï¼Œæ²¡æœ‰ä»»ä½•æ¶‰åŠåˆ°ä¸šåŠ¡çš„åœ°æ–¹ã€‚å¯èƒ½ç¨å¾®æœ‰ä¸€ç‚¹å’Œä¸šåŠ¡æ²¾è¾¹çš„åœ°æ–¹å°±æ˜¯ç¼–è§£ç å™¨ã€‚è¿™ä¸ªçš„ç¡®æ˜¯å®Œå…¨è€¦åˆåˆ°è¿™ä¸ªacceptorä¸­å»çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœä½ æƒ³å•çº¯çš„å»ç”¨è¿™ä¸ªacceptoræ˜¯ä¸è¡Œçš„ã€‚å› ä¸ºåªèƒ½é’ˆå¯¹ç‰¹å®šçš„ç½‘ç»œæ•°æ®æ ¼å¼è¿›è¡Œå¤„ç†ã€‚ä½†æ˜¯é’ˆå¯¹è¿™ä¸ªé¡¹ç›®è€Œè¨€æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ï¼Œæˆ‘æƒ³ä¹Ÿæ²¡æœ‰äººä¼šä»…ä»…å»ç”¨å…¶ä¸­çš„acceptorï¼Œå†è¯´ä¹Ÿä¸æ˜¯æä¾›ç»™å¼€å‘è€…ç”¨çš„ï¼Œè¿™æ˜¯ç»™è‡ªå·±ç”¨çš„ã€‚</p>
<p>å½“ç„¶ï¼Œå…¶ä¸­çš„æ¯”è¾ƒæ ¸å¿ƒçš„ä¸œè¥¿æ²¡æœ‰å»åˆ†æã€‚å› ä¸ºå®åœ¨æ˜¯å¾ˆå¤æ‚ã€‚æˆ‘æ‰“ç®—é‡‡ç”¨æŠ½ä¸å‰¥èŒ§çš„æ–¹å¼å°†å…¶é€æ­¥ç»†åŒ–ï¼Œæ¯•ç«Ÿå®³æ€•è´ªå¤šåš¼ä¸çƒ‚ã€‚æ¥ä¸‹æ¥è¦è®¨è®ºçš„æ˜¯jupiterçš„ä¸šåŠ¡ç¼–è§£ç å™¨çš„å®ç°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ä¸Šä¸€ç¯‡ä¸­åºŸè¯äº†å¾ˆå¤šâ€œå¤§æ¦‚â€ä¸ç›¸å…³çš„ä¸œè¥¿ã€‚è€Œè¿™ç¯‡å°±è¦è®¤è®¤çœŸçœŸçš„å¼€å§‹è®²å¹²è´§äº†(ä¹Ÿæœ‰å¯èƒ½æ˜¯æ°´è´§ï¼Œè°çŸ¥é“å‘¢)ã€‚&lt;/p&gt;
&lt;p&gt;ä¸Šä¸€ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†ä¸rpcä¸­é—´ä»¶ç›¸å…³çš„ä½†è”ç³»ä¸æ˜¯å¾ˆå¤§çš„spring xmlæ ‡ç­¾çš„è‡ªå®šä¹‰å®ç°ã€‚å¯ä»¥è¯´æ˜¯æ²¡æœ‰å¤ªå¤šæ ¸å¿ƒçš„ä¸œè¥¿ï¼Œå…¨æ–‡ä¸­çš„å…³é”®å­—å°±æ˜¯â€œæŠ„â€ã€‚æ²¡é”™ï¼Œ
    
    </summary>
    
      <category term="ä¸€èµ·è¯»æºç " scheme="http://www.wei-dong.top/categories/%E4%B8%80%E8%B5%B7%E8%AF%BB%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="Jupiter" scheme="http://www.wei-dong.top/tags/Jupiter/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€èµ·å­¦RPC(é›¶)</title>
    <link href="http://www.wei-dong.top/2018/08/06/%E4%B8%80%E8%B5%B7%E5%AD%A6RPC(%E9%9B%B6)/"/>
    <id>http://www.wei-dong.top/2018/08/06/ä¸€èµ·å­¦RPC(é›¶)/</id>
    <published>2018-08-06T08:17:23.000Z</published>
    <updated>2018-08-06T05:55:33.640Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘åˆé‡æ–°å¼€å§‹çœ‹jupiterçš„æºç ã€‚è¿™ä¸ªå¼€æºé¡¹ç›®æ˜¯é˜¿é‡Œçš„ä¸€ä½å¤§ç¥å†™çš„ï¼Œæ¯”èµ·ç°åœ¨è¾ƒä¸ºæµè¡Œçš„dubboã€motanç­‰ç”Ÿäº§ä¸Šçš„å¼€æºè½¯ä»¶æ¥è¯´è½»é‡å¾ˆå¤šï¼Œä¹Ÿæ¯”è¾ƒå®¹æ˜“å…¥é—¨å­¦ä¹ ã€‚æœ¬æ¥æƒ³çœ‹çœ‹dubboçš„æºç çš„ï¼Œæ— å¥ˆç¬¬ä¸€æ­¥éƒ½æ²¡å–å‡ºå»ï¼Œè¢«extensionæœºåˆ¶ç»™éš¾ä½äº†ã€‚è™½è¯´ç›®å‰dubboå·²ç»æˆä¸ºapacheçš„å­µåŒ–é¡¹ç›®äº†ï¼Œå¯¹äºç ”ç©¶æºç çš„æ¸£æ¸£æˆ‘æ¥è¯´è¿˜æ˜¯æœ‰ä¸€å®šçš„éš¾åº¦çš„ã€‚äºæ˜¯é€€è€Œæ±‚å…¶æ¬¡ï¼Œjupiterå°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®¹æ˜“å…¥æ‰‹çš„é€‰æ‹©ã€‚ä¸ºä»€ä¹ˆè¯´è¿™ä¸ªjupiteræ¯”è¾ƒå®¹æ˜“å…¥é—¨å‘¢ï¼Ÿé¦–å…ˆä»£ç æ¯”è¾ƒå°‘ï¼Œä¸æ˜¯å¾ˆå¤šï¼Œå¯¹é˜…è¯»æ¥è¯´ä¸ä¼šæœ‰å¾ˆå¤šç»•çš„åœ°æ–¹ã€‚å…¶æ¬¡è¿™ä¸ªé¡¹ç›®æœ‰å¾ˆå¤šçƒ­å¿ƒçš„ç½‘å‹ä¹Ÿåœ¨ä¸€èµ·è¯»ï¼Œå¯ä»¥æœ‰å¾ˆå¤šäº¤æµçš„åœ°æ–¹ï¼Œæœ‰ä¸€ä¸ªä¸“é—¨è®¨è®ºjupiterçš„äº¤æµç¾¤ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„å’Œå„è·¯å¤§ç¥äº¤æµå­¦ä¹ ã€‚</p>
<p>å› ä¸ºjupiteræºç æˆ‘æ²¡æœ‰å®Œå…¨è¯»å®Œï¼Œåªèƒ½çœ‹ä¸€ç‚¹å†™ä¸€ç‚¹ã€‚è¯´ä¸å®šç­‰çœ‹å®Œæºç åå†é‡æ–°æ•´ç†ä¸€ä¸‹è¡Œæ–‡ç»“æ„å‘¢ï¼Œä¹Ÿè¯´ä¸å®šæ”¾å¼ƒäº†å‘¢ï¼Œè°çŸ¥é“å‘¢ï¼Ÿ</p>
<p>æŒ‰ç…§å¸¸è§„æ€è·¯æ¥è¯´è‚¯å®šæ˜¯ä»ä¸€ä¸ªdemoæ¥å…¥é—¨ï¼Œä½†æ˜¯æˆ‘ä¸å†³å®šè¿™ä¹ˆåšï¼Œå› ä¸ºå¦‚æœå¯¹rpcç†Ÿæ‚‰çš„ä¼™è®¡ä¸€å®šçŸ¥é“æ€ä¹ˆå»ç©ï¼Œä¸çŸ¥é“æ€ä¹ˆå»ç©çš„ç°åœ¨å¯ä»¥å…³æ‰æµè§ˆå™¨æ‰“lolæˆ–è€…åƒé¸¡å»äº†ï¼Œå› ä¸ºä½ ä¸é…ã€‚æ²¡é”™ï¼Œå°±æ˜¯è¿™ä¹ˆå‚²å¨‡ã€‚</p>
<p>çœ‹äº†è¿™ä¹ˆå¤šjava rpcçš„æ¡†æ¶æ¯”å¦‚motanã€dubboå’Œjupiterï¼Œéƒ½æœ‰ä¸€ä¸ªå…±åŒçš„åœ°æ–¹ï¼Œä»–ä»¬éƒ½ä½¿ç”¨springä½œä¸ºå®¹å™¨æ¥é›†æˆã€‚è¿™æ ·ä¹Ÿæ˜¯æƒ…æœ‰å¯åŸï¼Œæˆ‘ç›¸ä¿¡javaåº”ç”¨ä¸­æ²¡æœ‰ä¸ä½¿ç”¨springçš„å§ã€‚å› æ­¤éƒ½é€‰æ‹©è¿™æ ·å»åšå¤§æ¦‚æ˜¯å› ä¸ºè¿™æ ·å¾ˆå®¹æ˜“å»é›†æˆåˆ°è‡ªå·±çš„é¡¹ç›®ä¸­ã€‚å½“ç„¶ï¼Œè¿™ç±»rpcæ¡†æ¶å¹¶ä¸æ˜¯ä¸€å®šå¾—å’Œspringé›†æˆã€‚æŠŠä»–ä»¬ç§°ä¸ºâ€œæ¡†æ¶â€å…¶å®å¹¶ä¸æ˜¯å¾ˆå‡†ç¡®ã€‚æ›´å‡†ç¡®çš„åº”è¯¥ç§°ä¸ºâ€œä¸­é—´ä»¶â€ã€‚æˆ‘çš„ç†è§£æ˜¯å› ä¸ºä»–ä»¬è™½ç„¶æ˜¯é›†æˆåˆ°è‡ªå·±çš„é¡¹ç›®ä»£ç ä¸­ï¼Œä½†æ˜¯ä»–ä»¬å´å ç”¨ç‹¬ç«‹çš„ç«¯å£ã€‚</p>
<p>springç›®å‰åœ¨javaå¼€å‘ä¸­çš„åœ°ä½å¾ˆé«˜ï¼Œä½¿ç”¨springæ¥ç®¡ç†beanæ˜¯éå¸¸æµè¡Œçš„åšæ³•ã€‚æ›´é‡è¦çš„æ˜¯éå¸¸æ–¹ä¾¿ã€‚å¯¹äºä¸­é—´ä»¶æ¥è¯´ï¼Œé€šè¿‡å¯¥å¯¥å‡ è¡Œxmlçš„æè¿°å°±èƒ½å°†ä¸€ä¸ªå¤æ‚çš„beanå®ä¾‹åŒ–å‡ºæ¥ï¼Œè€Œä¸”è€¦åˆåº¦å¾ˆä½ï¼Œä½•ä¹è€Œä¸ä¸ºå‘¢ï¼Ÿçœ‹ä¸€ä¸ªsonsumerçš„é…ç½®ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"globalInterceptor1"</span> <span class="attr">class</span>=<span class="string">"org.jupiter.example.spring.interceptor.consumer.MyGlobalConsumerInterceptor1"</span> /&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"globalInterceptor2"</span> <span class="attr">class</span>=<span class="string">"org.jupiter.example.spring.interceptor.consumer.MyGlobalConsumerInterceptor2"</span> /&gt;</span></div><div class="line"></div><div class="line">   <span class="tag">&lt;<span class="name">jupiter:client</span> <span class="attr">id</span>=<span class="string">"jupiterClient"</span> <span class="attr">registryType</span>=<span class="string">"default"</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">jupiter:property</span> <span class="attr">registryServerAddresses</span>=<span class="string">"127.0.0.1:20001"</span> /&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">jupiter:property</span> <span class="attr">globalConsumerInterceptors</span>=<span class="string">"globalInterceptor1,globalInterceptor2"</span> /&gt;</span></div><div class="line">       <span class="comment">&lt;!-- å¯é€‰é…ç½® --&gt;</span></div><div class="line">       <span class="comment">&lt;!--</span></div><div class="line">           String registryServerAddresses                          // æ³¨å†Œä¸­å¿ƒåœ°å€ [host1:port1,host2:port2....]</div><div class="line">           String providerServerAddresses                          // IPç›´è¿åˆ°providers [host1:port1,host2:port2....]</div><div class="line">           ConsumerInterceptor[] globalConsumerInterceptors;       // å…¨å±€æ‹¦æˆªå™¨</div><div class="line">       --&gt;</div><div class="line"></div><div class="line">       <span class="comment">&lt;!-- ç½‘ç»œå±‚é…ç½®é€‰é¡¹ --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">jupiter:netOptions</span>&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">jupiter:childOption</span> <span class="attr">SO_RCVBUF</span>=<span class="string">"8192"</span> /&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">jupiter:childOption</span> <span class="attr">SO_SNDBUF</span>=<span class="string">"8192"</span> /&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">jupiter:childOption</span> <span class="attr">ALLOW_HALF_CLOSURE</span>=<span class="string">"false"</span> /&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">jupiter:netOptions</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">jupiter:client</span>&gt;</span></div><div class="line"></div><div class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"interceptor1"</span> <span class="attr">class</span>=<span class="string">"org.jupiter.example.spring.interceptor.consumer.MyConsumerInterceptor1"</span> /&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"interceptor2"</span> <span class="attr">class</span>=<span class="string">"org.jupiter.example.spring.interceptor.consumer.MyConsumerInterceptor2"</span> /&gt;</span></div><div class="line"></div><div class="line">   <span class="comment">&lt;!-- consumer --&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">jupiter:consumer</span> <span class="attr">id</span>=<span class="string">"serviceTest"</span> <span class="attr">client</span>=<span class="string">"jupiterClient"</span> <span class="attr">interfaceClass</span>=<span class="string">"org.jupiter.example.ServiceTest"</span>&gt;</span></div><div class="line">       <span class="comment">&lt;!-- ä»¥ä¸‹éƒ½é€‰é¡¹å¯ä¸å¡« --&gt;</span></div><div class="line">       <span class="comment">&lt;!-- æœåŠ¡ç‰ˆæœ¬å·, é€šå¸¸åœ¨æ¥å£ä¸å…¼å®¹æ—¶ç‰ˆæœ¬å·æ‰éœ€è¦å‡çº§ --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">jupiter:property</span> <span class="attr">version</span>=<span class="string">"1.0.0.daily"</span> /&gt;</span></div><div class="line">       <span class="comment">&lt;!-- åºåˆ—åŒ–/ååºåˆ—åŒ–ç±»å‹: (proto_stuff, hessian, kryo, java)å¯é€‰, é»˜è®¤proto_stuff --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">jupiter:property</span> <span class="attr">serializerType</span>=<span class="string">"proto_stuff"</span> /&gt;</span></div><div class="line">       <span class="comment">&lt;!-- è½¯è´Ÿè½½å‡è¡¡ç±»å‹[random, round_robin] --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">jupiter:property</span> <span class="attr">loadBalancerType</span>=<span class="string">"round_robin"</span> /&gt;</span></div><div class="line">       <span class="comment">&lt;!-- æ´¾å‘æ–¹å¼: (round, broadcast)å¯é€‰, é»˜è®¤round(å•æ’­) --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">jupiter:property</span> <span class="attr">dispatchType</span>=<span class="string">"round"</span> /&gt;</span></div><div class="line">       <span class="comment">&lt;!-- è°ƒç”¨æ–¹å¼: (sync, async)å¯é€‰, é»˜è®¤sync(åŒæ­¥è°ƒç”¨) --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">jupiter:property</span> <span class="attr">invokeType</span>=<span class="string">"sync"</span> /&gt;</span></div><div class="line">       <span class="comment">&lt;!-- é›†ç¾¤å®¹é”™ç­–ç•¥: (fail_fast, fail_over, fail_safe)å¯é€‰, é»˜è®¤fail_fast(å¿«é€Ÿå¤±è´¥) --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">jupiter:property</span> <span class="attr">clusterStrategy</span>=<span class="string">"fail_over"</span> /&gt;</span></div><div class="line">       <span class="comment">&lt;!-- åœ¨fail_overç­–ç•¥ä¸‹çš„å¤±è´¥é‡è¯•æ¬¡æ•° --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">jupiter:property</span> <span class="attr">failoverRetries</span>=<span class="string">"2"</span> /&gt;</span></div><div class="line">       <span class="comment">&lt;!-- è¶…æ—¶æ—¶é—´è®¾ç½® --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">jupiter:property</span> <span class="attr">timeoutMillis</span>=<span class="string">"3000"</span> /&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">jupiter:methodSpecials</span>&gt;</span></div><div class="line">           <span class="comment">&lt;!-- æ–¹æ³•çš„å•ç‹¬é…ç½® --&gt;</span></div><div class="line">           <span class="tag">&lt;<span class="name">jupiter:methodSpecial</span> <span class="attr">methodName</span>=<span class="string">"sayHello"</span> <span class="attr">timeoutMillis</span>=<span class="string">"5000"</span> <span class="attr">clusterStrategy</span>=<span class="string">"fail_fast"</span> /&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">jupiter:methodSpecials</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">jupiter:property</span> <span class="attr">consumerInterceptors</span>=<span class="string">"interceptor1,interceptor2"</span> /&gt;</span></div><div class="line">       <span class="comment">&lt;!-- å¯é€‰é…ç½® --&gt;</span></div><div class="line">       <span class="comment">&lt;!--</span></div><div class="line">           SerializerType serializerType                   // åºåˆ—åŒ–/ååºåˆ—åŒ–æ–¹å¼</div><div class="line">           LoadBalancerType loadBalancerType               // è½¯è´Ÿè½½å‡è¡¡ç±»å‹[random, round_robin]</div><div class="line">           long waitForAvailableTimeoutMillis = -1         // å¦‚æœå¤§äº0, è¡¨ç¤ºé˜»å¡ç­‰å¾…ç›´åˆ°è¿æ¥å¯ç”¨å¹¶ä¸”è¯¥å€¼ä¸ºç­‰å¾…æ—¶é—´</div><div class="line">           InvokeType invokeType                           // è°ƒç”¨æ–¹å¼ [åŒæ­¥, å¼‚æ­¥]</div><div class="line">           DispatchType dispatchType                       // æ´¾å‘æ–¹å¼ [å•æ’­, å¹¿æ’­]</div><div class="line">           long timeoutMillis                              // è°ƒç”¨è¶…æ—¶æ—¶é—´è®¾ç½®</div><div class="line">           List&lt;MethodSpecialConfig&gt; methodSpecialConfigs; // æŒ‡å®šæ–¹æ³•çš„å•ç‹¬é…ç½®, æ–¹æ³•å‚æ•°ç±»å‹ä¸åšåŒºåˆ«å¯¹å¾…</div><div class="line">           ConsumerInterceptor[] consumerInterceptors      // æ¶ˆè´¹è€…ç«¯æ‹¦æˆªå™¨</div><div class="line">           String providerAddresses                        // provideråœ°å€åˆ—è¡¨, é€—å·åˆ†éš”(IPç›´è¿)</div><div class="line">           ClusterInvoker.Strategy clusterStrategy;        // é›†ç¾¤å®¹é”™ç­–ç•¥</div><div class="line">           int failoverRetries                             // fail_overçš„é‡è¯•æ¬¡æ•°</div><div class="line">       --&gt;</div><div class="line">   <span class="tag">&lt;/<span class="name">jupiter:consumer</span>&gt;</span></div></pre></td></tr></table></figure>
<p>å¯¹äºä¸€ä¸ªç›¸å¯¹æ¯”è¾ƒæˆç†Ÿçš„rpcä¸­é—´ä»¶æ¥è¯´ï¼Œæ ¸å¿ƒçš„beané…ç½®æ˜¯æ¯”è¾ƒå¤æ‚çš„ã€‚ä½ çœ‹çœ‹å…¶ä¸­çš„å‚æ•°å°±çŸ¥é“ã€‚é€šè¿‡springçš„è¿™ç§xmlæè¿°æ–‡ä»¶èµ·ç èƒ½å¤Ÿç¨å¾®å®¹æ˜“åœ°ç†è§£åˆ°ä¸€ä¸ªbeanéœ€è¦å“ªäº›å‚æ•°ï¼Œå“ªäº›å¯ä»¥ä¸è¦ï¼ŒåŒæ—¶æ ¹æ®xsdçš„çº¦æŸèƒ½å¤Ÿè®©å¼€å‘è€…æ›´æ¸…æ¥šçš„çŸ¥é“è‡ªå·±çš„é…ç½®æœ‰ä»€ä¹ˆé—®é¢˜ã€‚å¦‚æœä¸ç»™apiæ–‡æ¡£çš„æƒ…å†µä¸‹å¹²å·´å·´çš„ç»™ä½ ä¸€ä¸ªç±»ï¼Œè®©ä½ å»å®ä¾‹åŒ–è¿™ä¸ªå¤æ‚çš„classï¼Œæˆ‘ç›¸ä¿¡å¾ˆå¤šäººéƒ½ä¼šæŠ“ç‹‚ã€‚åœ¨è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸­å¾ˆå®¹æ˜“çš„çœ‹å‡ºè¦æœ‰2ä¸ªèŠ‚ç‚¹ï¼šclientå’Œconsumerã€‚å­èŠ‚ç‚¹çš„å†…å®¹å°±æ˜¯å‚æ•°ã€‚consumerä¼šå»å¼•ç”¨clientå»æ‰§è¡Œä¸€ä¸ªè¯·æ±‚ã€‚è€Œæˆ‘ä»¬çš„ä¸šåŠ¡ä¸­ç›´æ¥å»è°ƒç”¨consumerå°±å®Œäº‹äº†ã€‚å¦‚æ­¤è€Œå·²ï¼Œç®€å•ç›´è§‚ã€‚</p>
<p>è¿™é‡Œçš„spring xmlé…ç½®ä½¿ç”¨çš„æ˜¯è‡ªå®šä¹‰çš„æ ‡ç­¾ï¼Œç®—æ˜¯å¯¹springçš„æ‹“å±•ã€‚ä¸ä»…æ˜¯jupiterï¼ŒåŸºæœ¬ä¸Šå¤§å¤šæ•°rpcä¸­é—´ä»¶éƒ½å®ç°äº†è‡ªå·±çš„ä¸€å¥—æ ‡ç­¾ï¼Œä¼¼ä¹ä¸å»è‡ªå·±å®ç°ä¸€å¥—è‡ªå®šä¹‰æ ‡ç­¾éƒ½ä¸å¥½æ„æ€å¼€æºã€‚æ¯”å¦‚dubboçš„è‡ªå®šä¹‰æ ‡ç­¾å°±æ˜¯<code>&lt;dubbo:xxx&gt;</code>ï¼Œmotanç±»ä¼¼å¦‚æ­¤ã€‚ç„¶è€Œå®é™…ä¸Šä¹Ÿä¸æ˜¯å¿…é¡»å¾—å®ç°è‡ªå®šä¹‰æ ‡ç­¾ï¼Œä½¿ç”¨springçš„beanä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œåªä¸è¿‡æ˜¾å¾—å¾ˆè‡ƒè‚¿ï¼Œä¸æ˜¯é‚£ä¹ˆç›´è§‚ç½¢äº†ã€‚</p>
<p>å¯¹äºä¸€ä¸ªæ–°æ‰‹æ¥è®²ï¼Œè¿™äº›ä¸œè¥¿æ˜¾å¾—æ ¼å¤–çš„é«˜å¤§ä¸Šã€‚å…¶å®é‡Œé¢æ²¡æœ‰ä»€ä¹ˆé»‘é­”æ³•ï¼Œåœ¨springçš„referenceä¸­å¯¹è‡ªå®šä¹‰æ ‡ç­¾æœ‰ä»‹ç»ã€‚æ„Ÿå…´è¶£çš„å»çœ‹çœ‹è¿™ä¸ªå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://docs.spring.io/spring/docs/4.3.19.BUILD-SNAPSHOT/spring-framework-reference/htmlsingle/#xml-custom" target="_blank" rel="external">spring xml extension</a>.</p>
<p>è¦å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„spring xmlæ ‡ç­¾éœ€è¦åšä¸€ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>å®šä¹‰ä¸€ä¸ªçº¦æŸæ–‡ä»¶ï¼Œç”¨æ¥è§„èŒƒxmlçš„å†…å®¹ã€‚ç°åœ¨éƒ½æµè¡Œä½¿ç”¨xsdå»ç¼–å†™çº¦æŸæ–‡ä»¶ï¼Œdtdå·²ç»æˆä¸ºè€å¤è‘£äº†ã€‚<a href="http://www.w3school.com.cn/schema/schema_intro.asp" target="_blank" rel="external">xsdäº†è§£ä¸€ä¸‹</a>.</li>
<li>è‡ªå®šä¹‰ä¸€ä¸ª<code>NamespaceHandler</code>çš„å®ç°ã€‚å®é™…ä¸Šæ˜¯å»å®ç°è¿™ä¸ªæ¥å£ã€‚éå¸¸å®¹æ˜“ï¼Œå¤åˆ¶ç²˜è´´ä¸€æŠŠæ¢­ã€‚</li>
<li>å†™ä¸€ä¸ªæˆ–è€…å¤šä¸ª<code>BeanDefinitionParser</code>çš„å®ç°ã€‚ä¹Ÿæ˜¯å»å®ç°æ¥å£ï¼Œå½“ç„¶ç»§æ‰¿æŠ½è±¡ç±»ä¹Ÿæ˜¯okçš„ã€‚è¿™ä¸ªæ˜¯æœ€æ ¸å¿ƒçš„å†…å®¹ã€‚</li>
<li>å°†ä¸Šé¢æ‰€å®šä¹‰çš„å…¨éƒ¨æ³¨å†Œåˆ°springä¸­ï¼Œè®©springçŸ¥é“æœ‰è¿™äº›ç©æ„å„¿ã€‚ä¹Ÿå°±æ˜¯åœ¨<code>META-INF</code>æ–‡ä»¶å¤¹ä¸‹æ–°å¢ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼š<code>spring.handlers</code>å’Œ<code>spring.schemas</code></li>
</ul>
<p>ä¸‹é¢å°±ç»“åˆjupiterä¸­è‡ªå®šä¹‰çš„springæ ‡ç­¾æ¥è°ˆè°ˆä»–æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<p>é¦–å…ˆå¾—å®šä¹‰xsdçº¦æŸæ–‡ä»¶,å®Œæ•´çš„å®šä¹‰åœ¨<a href="https://github.com/Mr-Vincent/Jupiter/blob/master/jupiter-spring-support/src/main/resources/jupiter.xsd" target="_blank" rel="external">è¿™é‡Œ</a>.è¿™ä¸ªæ²¡ä»€ä¹ˆå¥½è¯´çš„ï¼Œæ¯ç‡¥çš„xmlå®šä¹‰ç½¢äº†ã€‚æ— éå°±æ˜¯å®šä¹‰æœ‰å“ªäº›å…ƒç´ ï¼Œå“ªäº›å…ƒç´ ä¸‹æœ‰å“ªäº›å±æ€§ï¼Œå…¶ä¸­æœ‰æ²¡æœ‰å­å…ƒç´ ï¼Œå±æ€§ç±»å‹æ˜¯ä»€ä¹ˆï¼Œæ˜¯ä¸æ˜¯å¿…å¡«çš„ç­‰ç­‰ã€‚</p>
<p>æ¥ä¸‹æ¥å°±æ˜¯é…ç½®ä¸€ä¸ª<code>handler</code>ã€‚è¿™ä¸ªhandlerç”¨æ¥è§£æè‡ªå®šä¹‰çš„æ ‡ç­¾ã€‚ç”¨è¿‡springéƒ½çŸ¥é“ï¼Œé™¤äº†æœ€å¸¸è§çš„beanæ ‡ç­¾è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æ ‡ç­¾ï¼Œæ¯”å¦‚<code>&lt;context:component-scan&gt;</code>ã€<code>&lt;aop:aspectj-autoproxy proxy-target-class=&quot;true&quot; /&gt;</code>ä»¥åŠ<code>&lt;mvc:annotation-driven/&gt;</code>ç­‰ã€‚è¿™äº›æ ‡ç­¾å’Œbeanæ ‡ç­¾çš„ä¸åŒä¹‹å¤„åœ¨äºéƒ½æœ‰ä¸€ä¸ªå‰ç¼€ã€‚æˆ‘ä»¬ç§°è¿™ä¸ªå«åšå‘½åç©ºé—´ã€‚ç„¶è€Œè‡ªå®šä¹‰çš„å½“ç„¶ä¹Ÿå¾—åŠ ä¸Šå‘½åç©ºé—´ã€‚è™½è¯´ä¸èƒ½å’Œbeanå¹³èµ·å¹³åï¼Œä½†æ˜¯å’Œaopã€contextè¿™æ ·çš„æ ‡ç­¾è¿˜æ˜¯å¯ä»¥ä¸€è§†åŒä»çš„ã€‚</p>
<p>åŸºäºè¿™ç§æ€è·¯ï¼Œé‚£å°±å¾ˆå®¹æ˜“æ¥è‡ªå®šä¹‰è‡ªå·±çš„æ ‡ç­¾äº†ã€‚éš¾æ€ªæ–‡æ¡£ä¸­å¯¹è¿™ä¸ªæ­¥éª¤åŠ äº†ä¸€ä¸ªè¯´æ˜ï¼š</p>
<blockquote>
<p>Coding a custom NamespaceHandler implementation (this is an easy step, donâ€™t worry).</p>
</blockquote>
<p>çš„ç¡®å¦‚æ­¤ï¼Œå¸¸äººçš„æ€è·¯å°±æ˜¯ç…§ç€springçš„å®ç°æŠ„ä¸€æŠŠã€‚å¦‚æ­¤ç®€å•ï¼</p>
<p>è€Œæ¯”è¾ƒå¤æ‚çš„å°±æ˜¯å¯¹<code>BeanDefinitionParser</code>çš„å®ç°äº†ã€‚è¿™ä¸ªæ˜¯æœ€æ ¸å¿ƒçš„æ­¥éª¤ã€‚æ ¹æ®æ–‡æ¡£ä¸­çš„æè¿°ï¼Œè¿™ä¸ªå¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªã€‚ä½†æ˜¯åœ¨jupiterä¸­åªå®šä¹‰äº†ä¸€ä¸ªå®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JupiterNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        registerBeanDefinitionParser(<span class="string">"server"</span>, <span class="keyword">new</span> JupiterBeanDefinitionParser(JupiterSpringServer.class));</div><div class="line">        registerBeanDefinitionParser(<span class="string">"client"</span>, <span class="keyword">new</span> JupiterBeanDefinitionParser(JupiterSpringClient.class));</div><div class="line">        registerBeanDefinitionParser(<span class="string">"provider"</span>, <span class="keyword">new</span> JupiterBeanDefinitionParser(JupiterSpringProviderBean.class));</div><div class="line">        registerBeanDefinitionParser(<span class="string">"consumer"</span>, <span class="keyword">new</span> JupiterBeanDefinitionParser(JupiterSpringConsumerBean.class));</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>springçš„<code>TaskNamespaceHandler</code>ä¸­å°±ä½¿ç”¨äº†å¤šä¸ªpaserï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskNamespaceHandler</span> <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.registerBeanDefinitionParser(<span class="string">"annotation-driven"</span>, <span class="keyword">new</span> AnnotationDrivenBeanDefinitionParser());</div><div class="line">		<span class="keyword">this</span>.registerBeanDefinitionParser(<span class="string">"executor"</span>, <span class="keyword">new</span> ExecutorBeanDefinitionParser());</div><div class="line">		<span class="keyword">this</span>.registerBeanDefinitionParser(<span class="string">"scheduled-tasks"</span>, <span class="keyword">new</span> ScheduledTasksBeanDefinitionParser());</div><div class="line">		<span class="keyword">this</span>.registerBeanDefinitionParser(<span class="string">"scheduler"</span>, <span class="keyword">new</span> SchedulerBeanDefinitionParser());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªpaserç”¨é€šä¿—çš„è¯æ¥è§£é‡Šå°±æ˜¯å°†åœ¨xmlçš„é…ç½®å‚æ•°ç»™setåˆ°ç›¸åº”çš„å®ä¾‹ä¸­å»ã€‚ä¸¾ä¸ªæ —å­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleDateFormatBeanDefinitionParser</span> <span class="keyword">extends</span> <span class="title">AbstractSingleBeanDefinitionParser</span> </span>&#123; </div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> Class <span class="title">getBeanClass</span><span class="params">(Element element)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> SimpleDateFormat.class; </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, BeanDefinitionBuilder bean)</span> </span>&#123;</div><div class="line">        <span class="comment">// this will never be null since the schema explicitly requires that a value be supplied</span></div><div class="line">        String pattern = element.getAttribute(<span class="string">"pattern"</span>);</div><div class="line">        bean.addConstructorArg(pattern);</div><div class="line"></div><div class="line">        <span class="comment">// this however is an optional property</span></div><div class="line">        String lenient = element.getAttribute(<span class="string">"lenient"</span>);</div><div class="line">        <span class="keyword">if</span> (StringUtils.hasText(lenient)) &#123;</div><div class="line">            bean.addPropertyValue(<span class="string">"lenient"</span>, Boolean.valueOf(lenient));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ —å­æ˜¯ç»§æ‰¿è‡ª<code>AbstractSingleBeanDefinitionParser</code>å¹¶æ²¡æœ‰å»å®ç°<code>BeanDefinitionParser</code>æ¥å£ã€‚é“ç†éƒ½çŸ¥é“ï¼Œæ²¡æœ‰å¿…è¦å»å®ç°ä¸€ä¸ªè¦å•¥æ²¡å•¥çš„æ¥å£ï¼Œåƒç°æˆçš„å°±å¥½ã€‚é‡å†™çˆ¶ç±»çš„<code>getBeanClass</code>æ–¹æ³•ï¼Œå°†éœ€è¦çº³å…¥springç®¡ç†çš„å¯¹è±¡è¿”å›æ‰ã€‚è¿™é‡Œä¸ä»…ä»…å¯ä»¥é‡å†™è¿™ä¸ªæ–¹æ³•ï¼Œè¿˜æœ‰å…¶ä»–ä¾‹å¦‚<code>getBeanClassName</code>ä¹Ÿè¡Œã€‚å€¼å¾—æ³¨æ„çš„æ˜¯å¦‚æœé‡‡ç”¨ç»§æ‰¿æŠ½è±¡ç±»çš„æ–¹å¼ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•å¿…é¡»é€‰æ‹©ä¸€ä¸ªæ¥é‡å†™ã€‚è¿™ä¸ªä¹Ÿéå¸¸å®¹æ˜“ç†è§£ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•è¿”å›çš„classå®ä¾‹æˆ–è€…ç±»çš„å…¨è·¯å¾„åå°±æ˜¯ç”¨æ¥å®ä¾‹åŒ–çš„å¯¹è±¡ã€‚å¦‚æœé€šè¿‡å®ç°æ¥å£çš„æ–¹å¼æ¥å®šä¹‰paserå°±ä¸éœ€è¦è€ƒè™‘è¿™ä¸ªè§„åˆ™äº†ï¼Œåªéœ€è¦åˆ›å»ºå‡º<code>BeanDefinition</code>çš„å®ä¾‹å³å¯ã€‚jupiterä¸­å°±æ˜¯é‡‡ç”¨å®ç°æ¥å£çš„æ–¹å¼ï¼Œå› ä¸ºç»§æ‰¿æŠ½è±¡ç±»æœ‰ä¸€å®šçš„å±€é™æ€§ï¼Œå®ç°æ¥å£ä¼šæœ‰æ›´å¤šçš„çµæ´»æ€§ã€‚</p>
<p>æœ‰äº†è¦ç…®é¥­çš„é”…ï¼Œå°±å·®ä¸‹é”…çš„ç±³äº†ã€‚è¿™ä¸ªæ —å­ä¸­é‡å†™çˆ¶ç±»çš„<code>doParser</code>æ–¹æ³•ã€‚ä»ä»£ç çš„è¡¨ç°ä¸Šæ¥çœ‹å®é™…ä¸Šå°±æ˜¯å°†xmlé…ç½®æ–‡ä»¶ä¸­çš„å±æ€§è·å–åˆ°ï¼Œç„¶ååšä¸€ä¸‹æ£€æŸ¥æ”¾åˆ°å®ä¾‹åŒ–çš„å¯¹è±¡ä¸­å»ã€‚å½“ç„¶è¿™é‡Œæ²¡æœ‰é‚£ä¹ˆç›´æ¥ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯<code>BeanDefinitionBuilder</code>æ¥æ“ä½œçš„ã€‚è¿™åªæ˜¯æœ€ç®€å•çš„å®ç°ã€‚</p>
<p>å¤æ‚çš„parseréƒ½æ˜¯è‡ªå·±å»å®ç°æ¥å£çš„ã€‚æ¯”å¦‚jupiterï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JupiterBeanDefinitionParser</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionParser</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; beanClass;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JupiterBeanDefinitionParser</span><span class="params">(Class&lt;?&gt; beanClass)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.beanClass = beanClass;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> BeanDefinition <span class="title">parse</span><span class="params">(Element element, ParserContext parserContext)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (beanClass == JupiterSpringServer.class) &#123;</div><div class="line">            <span class="keyword">return</span> parseJupiterServer(element, parserContext);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (beanClass == JupiterSpringClient.class) &#123;</div><div class="line">            <span class="keyword">return</span> parseJupiterClient(element, parserContext);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (beanClass == JupiterSpringProviderBean.class) &#123;</div><div class="line">            <span class="keyword">return</span> parseJupiterProvider(element, parserContext);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (beanClass == JupiterSpringConsumerBean.class) &#123;</div><div class="line">            <span class="keyword">return</span> parseJupiterConsumer(element, parserContext);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BeanDefinitionValidationException(<span class="string">"Unknown class to definition: "</span> + beanClass.getName());</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>jupiterçš„è‡ªå®šä¹‰parserä¸­éœ€è¦çº³å…¥springç®¡ç†çš„bean classå¯¹è±¡æ˜¯é€šè¿‡æ„é€ å™¨ä¼ è¿›æ¥çš„ã€‚æ ¹æ®ä¸åŒçš„classæ¥ä½œä¸åŒçš„å¤„ç†ã€‚å…¶ä¸­å…·ä½“çš„é€»è¾‘å¾ˆæ¯ç‡¥æ— å‘³ï¼Œå°±ä¸å†ç»†ç»†æ¢è®¨äº†ã€‚ä¸è¿‡æˆ‘åœ¨çœ‹æºç çš„è¿‡ç¨‹ä¸­å‘ç°äº†ä¸€ä¸ªç»†èŠ‚çš„åœ°æ–¹ï¼Œä¹Ÿæ˜¯å€¼å¾—æ³¨æ„çš„åœ°æ–¹ã€‚</p>
<p><code>JupiterSpringConsumerBean</code>ä¸ä»…ä»…å’Œå…¶ä»–(å¦‚<code>JupiterSpringServer</code>ç­‰)å®ç°<code>InitializingBean</code>ï¼Œè¿˜å®ç°äº†ä¸€ä¸ªå«åš<code>FactoryBean</code>çš„æ¥å£ã€‚è¿™è¯´æ˜äº†ä¸€ä¸ªé—®é¢˜ï¼Œè¿™ä¸ªbeanä¸æ˜¯æ™®é€šçš„beanï¼Œè€Œæ˜¯ä¸€ä¸ªfactory beanã€‚ç›¸ä¿¡å¾ˆå¤šäººéƒ½ä¼šç–‘æƒ‘factory bean å’Œbean factoryæœ‰ä»€ä¹ˆåŒºåˆ«ã€‚è¦æˆ‘è¯´ä¸¤è€…éƒ½æ²¡æœ‰ç›´æ¥çš„è”ç³»ï¼Œå¦‚æœåœ¨é¢è¯•çš„æ—¶å€™æœ‰äººé—®æˆ‘è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä¸€å®šç›´æ¥æ€¼å›å»ï¼šé›·é”‹å’Œé›·å³°å¡”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿè¨€å½’æ­£ä¼ ï¼Œè¿™ä¸ªfactory beanæœ¬è´¨ä¸Šä¹Ÿæ˜¯beanï¼Œä½†æ˜¯ä¸å…¶ä»–beanä¸åŒçš„æ˜¯è¿™ä¸ªbeanåœ¨springå®¹å™¨ä¸­è·å–çš„æ–¹å¼å’Œåˆ«çš„ä¸ä¸€æ ·ã€‚é€šå¸¸åœ¨springä¸­è·å–ä¸€ä¸ªbeané‡‡ç”¨<code>ctx.getBean(xxx.class)</code>æ–¹æ³•ã€‚é€šè¿‡è¿™ä¸ªæ–¹æ³•è·å–çš„factory beanå¹¶ä¸æ˜¯ä»–è‡ªå·±ï¼Œè€Œæ˜¯å®ƒçš„æŸä¸ªæˆå‘˜ã€‚å¯ä»¥çœ‹çœ‹è¿™ä¸ªæ¥å£çš„å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FactoryBean</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="function">T <span class="title">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line"></div><div class="line">    Class&lt;?&gt; getObjectType();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isSingleton</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´è¿”å›çš„å¯¹è±¡æ˜¯<code>getObject()</code>è¿”å›å€¼ã€‚é‚£ä¹ˆè¿™ä¸ªæ¥å£å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä¹Ÿä¸å¤åˆ¶ç²˜è´´äº†ï¼Œè§‰ç€<a href="https://www.jianshu.com/p/6f0a59623090" target="_blank" rel="external">è¿™ç¯‡æ–‡ç« </a>å†™å¾—å¾ˆä¸é”™ï¼Œæµ…æ˜¾æ˜“æ‡‚ã€‚é‚£ä¹ˆå¦‚ä½•è·å–è¿™ä¸ªbeanæœ¬èº«å‘¢ï¼Ÿå¹²å˜›æƒ³ç€è·å–å®ƒæœ¬èº«ï¼Œç®€ç›´æ˜¯æ— èŠï¼ä¹Ÿæœ‰æ–¹æ³•ï¼ŒåŠ ä¸ªå‰ç¼€â€&amp;â€å°±è¡Œäº†(<code>ctx.getBean(&quot;&amp;sb&quot;)</code>)ã€‚</p>
<p>æœ€åå‘¢ï¼Œå°±æ˜¯ç…§ç€springçš„å®˜æ–¹æ–‡æ¡£æŠ„ä¸€ä¸‹é…ç½®æ–‡ä»¶ã€‚ä¾è‘«èŠ¦ç”»ç“¢ï¼Œéå¸¸ç®€å•ã€‚</p>
<p>å®Œæˆäº†ä»¥ä¸Šçš„å‡ ä¸ªæ­¥éª¤ï¼Œè‡ªå®šä¹‰çš„spring xmlæ ‡ç­¾å°±å¤§åŠŸå‘Šæˆäº†ã€‚æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯å»ä½¿ç”¨è‡ªå®šä¹‰çš„æ ‡ç­¾ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">    <span class="attr">xmlns:myns</span>=<span class="string">"http://www.mycompany.com/schema/myns"</span></div><div class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span></div><div class="line">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</div><div class="line">        http://www.mycompany.com/schema/myns http://www.mycompany.com/schema/myns/myns.xsd"&gt;</div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- as a top-level bean --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">myns:dateformat</span> <span class="attr">id</span>=<span class="string">"defaultDateFormat"</span> <span class="attr">pattern</span>=<span class="string">"yyyy-MM-dd HH:mm"</span> <span class="attr">lenient</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"jobDetailTemplate"</span> <span class="attr">abstract</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dateFormat"</span>&gt;</span></div><div class="line">            <span class="comment">&lt;!-- as an inner bean --&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">myns:dateformat</span> <span class="attr">pattern</span>=<span class="string">"HH:mm MM-dd-yyyy"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<p>è¿™é‡Œæ˜¯æŠ„çš„å®˜æ–¹æ–‡æ¡£çš„æ —å­ã€‚æ ‡ç­¾<code>myns:dateformat</code>å®é™…ä¸Šå®šä¹‰äº†ä¸€ä¸ª<code>SimpleDateFormat</code>çš„beanå®ä¾‹ã€‚åœ¨springå®¹å™¨åŠ è½½çš„æ—¶å€™è¿™ä¸ªå®ä¾‹å°±å›è¢«åˆå§‹åŒ–ã€‚åœ¨ä½¿ç”¨è‡ªå®šä¹‰çš„æ ‡ç­¾çš„æ—¶å€™ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å¾—å£°æ˜å¥½å‘½åç©ºé—´å’ŒæŒ‡å®šlocationï¼Œä¸ç„¶ä¼šæŠ¥æ— æ³•æ‰¾åˆ°è¿™ä¸ªæ ‡ç­¾çš„é”™è¯¯ã€‚å…¶å®è¿™äº›ä¸œè¥¿ç…§ç€æŠ„å°±è¡Œäº†ï¼Œåªæ˜¯ä¸è¦å¿˜è®°äº†æˆ–è€…æŠ„é”™äº†ã€‚</p>
<p>è‡ªå®šä¹‰spring xmlæ ‡ç­¾å¦‚æ­¤ç®€å•ã€‚æ— éå°±æ˜¯ç…§ç€æ–‡æ¡£æŠ„ä¸€æŠŠï¼Œè‡ªå·±å†æ”¹å§æ”¹å§ä¸‡äº‹å°±å¤§å‰äº†ã€‚å¯¹äºå…¶ä¸­æ ¸å¿ƒçš„ä¸œè¥¿å®é™…ä¸Šè¿˜æ˜¯ä¸€çŸ¥åŠè§£ï¼Œæ¯”æ–¹è¯´<code>BeanDefinition</code>çš„å…·ä½“å®ç°åŸç†ç­‰ã€‚ä¸Šå±‚çš„å°è£…å¤ªæŠ½è±¡äº†ï¼Œç•™ç»™å¼€å‘è€…çš„ä»…ä»…åªæ˜¯ä¸€ä¸ªéœ€è¦å®ç°çš„æ–¹æ³•ã€‚è¦æƒ³çŸ¥é“ä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Œè¿˜å¾—å»ç ”ç©¶springçš„æºç ã€‚</p>
<p>rpcä¸­çš„æœ€ç®€å•çš„ä¸€ä¸ªå¯é€‰æ¨¡å—å°±è¿™æ ·ç®€å•çš„å®ç°äº†ã€‚è¿™æ˜¯ä¸€å°æ­¥ï¼Œä¹Ÿæ˜¯ä¸€å¤§æ­¥ã€‚æ¥ä¸‹æ¥ä¼šç»§ç»­æ¢ç´¢ç¨å¾®æ ¸å¿ƒä¸€ç‚¹çš„jupiterå®ç°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘åˆé‡æ–°å¼€å§‹çœ‹jupiterçš„æºç ã€‚è¿™ä¸ªå¼€æºé¡¹ç›®æ˜¯é˜¿é‡Œçš„ä¸€ä½å¤§ç¥å†™çš„ï¼Œæ¯”èµ·ç°åœ¨è¾ƒä¸ºæµè¡Œçš„dubboã€motanç­‰ç”Ÿäº§ä¸Šçš„å¼€æºè½¯ä»¶æ¥è¯´è½»é‡å¾ˆå¤šï¼Œä¹Ÿæ¯”è¾ƒå®¹æ˜“å…¥é—¨å­¦ä¹ ã€‚æœ¬æ¥æƒ³çœ‹çœ‹dubboçš„æºç çš„ï¼Œæ— å¥ˆç¬¬ä¸€æ­¥éƒ½æ²¡å–å‡ºå»ï¼Œè¢«extensionæœºåˆ¶ç»™éš¾ä½äº†ã€‚è™½è¯´ç›®å‰dubboå·²ç»æˆ
    
    </summary>
    
      <category term="ä¸€èµ·è¯»æºç " scheme="http://www.wei-dong.top/categories/%E4%B8%80%E8%B5%B7%E8%AF%BB%E6%BA%90%E7%A0%81/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="Jupiter" scheme="http://www.wei-dong.top/tags/Jupiter/"/>
    
  </entry>
  
  <entry>
    <title>æµ…æJDKä¸­çš„å®šæ—¶å™¨Timerå®ç°</title>
    <link href="http://www.wei-dong.top/2018/04/21/Timer/"/>
    <id>http://www.wei-dong.top/2018/04/21/Timer/</id>
    <published>2018-04-21T08:17:23.000Z</published>
    <updated>2018-05-17T06:30:16.624Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨jdkä¸­å¤„ç†å®šæ—¶ä»»åŠ¡å·¥å…·ç±»ä¸­æœ‰2ç§ï¼šTimerå’ŒScheduledExecutorServiceã€‚å‰è€…æ˜¯åœ¨java.utilåŒ…ä¸­ï¼Œä»1.3ç‰ˆæœ¬å¼€å§‹ï¼Œå±äºæ¯”è¾ƒè€çš„å·¥å…·ç±»äº†ã€‚è€ŒScheduledExecutorServiceå±äºjava.util.concurrentåŒ…ï¼Œä½œè€…æ˜¯è€çˆ·å­Doug Leaï¼Œ1.5ç‰ˆæœ¬å¼€å§‹æ‰æœ‰ã€‚è™½ç„¶ç°åœ¨å¤§å¤šä½¿ç”¨ScheduledExecutorServiceï¼Œä½†æ˜¯æˆ‘è§‰å¾—å¾ˆæœ‰å¿…è¦å¯¹å…¶â€œåŒå®—â€Timerçš„å®ç°è¿›è¡Œè§£è¯»ã€‚</p>
<h4 id="ä¸¾ä¸ªæ —å­"><a href="#ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h4><p>å®˜æ–¹æ–‡æ¡£ä¸­çš„è§£é‡Šæ˜¯è¿™æ ·çš„ï¼š</p>
<blockquote>
<p>A facility for threads to schedule tasks for future execution in a background thread. Tasks may be scheduled for one-time execution, or for repeated execution at regular intervals.</p>
</blockquote>
<p>çº¿ç¨‹çš„å·¥å…·ï¼Œç”¨äºåœ¨åå°çº¿ç¨‹ä¸­å®‰æ’å°†æ¥æ‰§è¡Œçš„ä»»åŠ¡ã€‚ å¯ä»¥å®‰æ’ä¸€æ¬¡æ€§æ‰§è¡Œä»»åŠ¡ï¼Œæˆ–å®šæœŸé‡å¤æ‰§è¡Œä»»åŠ¡ã€‚</p>
<blockquote>
<p>This class is thread-safe: multiple threads can share a single Timer object without the need for external synchronization.<br>This class does not offer real-time guarantees: it schedules tasks using the Object.wait(long) method.<br>Java 5.0 introduced the java.util.concurrent package and one of the concurrency utilities therein is the ScheduledThreadPoolExecutor which is a thread pool for repeatedly executing tasks at a given rate or delay. It is effectively a more versatile replacement for the Timer/TimerTask combination, as it allows multiple service threads, accepts various time units, and doesnâ€™t require subclassing TimerTask (just implement Runnable). Configuring ScheduledThreadPoolExecutor with one thread makes it equivalent to Timer.</p>
</blockquote>
<p>è¿™ä¸ªç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†ä¸èƒ½ä¿è¯æ˜¯å®æ—¶çš„ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯waitæ–¹æ³•æ¥è°ƒåº¦ä»»åŠ¡ã€‚æ–‡æ¡£è¿˜è¯´äº†å»ºè®®ä½¿ç”¨JUCä¸‹çš„ScheduledThreadPoolExecutorï¼ˆScheduledExecutorServiceçš„å®ç°ï¼‰ç±»æ¥å¤„ç†å®šæ—¶ä»»åŠ¡ï¼Œè¿™ä¸ªç±»æä¾›çš„åŠŸèƒ½æ›´å¤šï¼Œå‚æ•°æ›´çµæ´»ï¼Œè€Œä¸”æ˜¯å¤šçº¿ç¨‹çš„ã€‚å½“çº¿ç¨‹æ± sizeæŒ‡å®šä¸ºä¸€é‚£å°±å’ŒTimerä¸€ä¸ªæ ·äº†ã€‚</p>
<p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªdemoæ¥å±•ç¤ºä¸€ä¸‹ç›¸å…³apiçš„ç”¨æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkTimerDemo</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Timer timer = <span class="keyword">new</span> Timer(<span class="string">"timer-demo"</span>);</div><div class="line">        MyTask[] tasks = <span class="keyword">new</span> MyTask[<span class="number">20</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tasks.length; i++) &#123;</div><div class="line">            tasks[i] = <span class="keyword">new</span> MyTask(i);</div><div class="line">            System.out.println(<span class="string">"time no "</span> + i + <span class="string">" task start at "</span> + <span class="keyword">new</span> Date());</div><div class="line">            timer.schedule(tasks[i], <span class="number">2</span> * <span class="number">1000</span>, <span class="number">3</span> * <span class="number">1000</span>);</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"timer started at: "</span> + <span class="keyword">new</span> Date());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> timeNo;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyTask</span><span class="params">(<span class="keyword">int</span> timeNo)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.timeNo = timeNo;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * å¦‚æœä»»åŠ¡å‡ºç°å¼‚å¸¸ä¸è¢«æ•è·ï¼Œå…¶ä»–ä»»åŠ¡ä¸ä¼šè¢«æ‰§è¡Œ</div><div class="line">         */</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (timeNo == <span class="number">8</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"boom"</span>);</div><div class="line">            &#125;</div><div class="line">            System.out.println(<span class="string">"time no "</span> + timeNo);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªdemoå±•ç¤ºä¸€ä¸ªTimerçš„å¼Šç«¯ã€‚å½“ä»»åŠ¡ä¸­å‡ºç°æœªè¢«æ•è·çš„å¼‚å¸¸ï¼Œæ¥ä¸‹æ¥çš„ä»»åŠ¡éƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼Œå®šæ—¶å™¨crashæ‰ã€‚è¿™ä¸ªdemoä¸­å®šä¹‰äº†20ä¸ªtaskäº¤ç»™timerè°ƒåº¦ï¼Œtimerå¯åŠ¨2ç§’åå¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼Œæ¯éš”3ç§’æ‰§è¡Œä¸€æ¬¡ã€‚æ¥ä¸‹æ¥å°±è·Ÿç€demoä¸€æ­¥ä¸€æ­¥çœ‹çœ‹å…¶ä¸­çš„å®ç°åŸç†ã€‚</p>
<h4 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h4><p>é¦–å…ˆçœ‹çœ‹æ„é€ å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Timer</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    thread.setName(name);</div><div class="line">    thread.start();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Timer</span><span class="params">(String name, <span class="keyword">boolean</span> isDaemon)</span> </span>&#123;</div><div class="line">    thread.setName(name);</div><div class="line">    thread.setDaemon(isDaemon);</div><div class="line">    thread.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ„é€ å™¨çš„å‚æ•°ä»£è¡¨ç€timerçš„åå­—å’Œè¿™ä¸ªtimeræ˜¯å¦æ˜¯åå°è¿è¡Œçš„ï¼ˆtimeræœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼‰ã€‚ä¸€æ—¦å®ä¾‹åŒ–å°±å°†è¿™ä¸ªçº¿ç¨‹ç»™å¯åŠ¨äº†ã€‚è¿™ä¸ªçº¿ç¨‹æ˜¯æ ¸å¿ƒã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> TimerThread thread = <span class="keyword">new</span> TimerThread(queue);</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæˆå‘˜å±æ€§TimerThreadå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªqueueã€‚è¿™ä¸ªqueueä¸Šä»€ä¹ˆç¨åå†è®²ã€‚</p>
<p>å®ä¾‹åŒ–ç»“æŸåå°±å¾—è°ƒç”¨å®ƒçš„scheduleæ–¹æ³•äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">(TimerTask task, <span class="keyword">long</span> delay, <span class="keyword">long</span> period)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (delay &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Negative delay."</span>);</div><div class="line">    <span class="keyword">if</span> (period &lt;= <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Non-positive period."</span>);</div><div class="line">    sched(task, System.currentTimeMillis()+delay, -period);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// æ ¸å¿ƒçš„æ˜¯è¿™æ®µé€»è¾‘</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sched</span><span class="params">(TimerTask task, <span class="keyword">long</span> time, <span class="keyword">long</span> period)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (time &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal execution time."</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Constrain value of period sufficiently to prevent numeric</span></div><div class="line">    <span class="comment">// overflow while still being effectively infinitely large.</span></div><div class="line">    <span class="comment">// é˜²æ­¢æº¢å‡º å¦‚æœå‘¨æœŸæ¯”æœ€å¤§å€¼çš„ä¸€åŠè¿˜å¤§ é‚£å°±å°†å…¶é™¤ä»¥2 é“ç†ä½•åœ¨ï¼Ÿ</span></div><div class="line">    <span class="keyword">if</span> (Math.abs(period) &gt; (Long.MAX_VALUE &gt;&gt; <span class="number">1</span>))</div><div class="line">        period &gt;&gt;= <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span>(queue) &#123;</div><div class="line">        <span class="keyword">if</span> (!thread.newTasksMayBeScheduled)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Timer already cancelled."</span>);</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span>(task.lock) &#123;</div><div class="line">            <span class="comment">// å¦‚æœä»»åŠ¡çŠ¶æ€ä¸ä¸ºæ–°åˆ›å»ºçš„ ç›´æ¥æŠ›å¼‚å¸¸</span></div><div class="line">            <span class="keyword">if</span> (task.state != TimerTask.VIRGIN)</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</div><div class="line">                    <span class="string">"Task already scheduled or cancelled"</span>);</div><div class="line">            <span class="comment">// è®¾ç½®ä»»åŠ¡ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ æ‰§è¡Œå‘¨æœŸ ä»¥åŠ çŠ¶æ€</span></div><div class="line">            task.nextExecutionTime = time;</div><div class="line">            task.period = period;</div><div class="line">            task.state = TimerTask.SCHEDULED;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">		  <span class="comment">// ä»»åŠ¡å®é™…ä¸Šæ˜¯æ”¾åœ¨é˜Ÿåˆ—ä¸­ å¹¶ä¸æ˜¯ç›´æ¥æ‰§è¡Œçš„ </span></div><div class="line">        queue.add(task);</div><div class="line">        <span class="comment">// ä¸ºä»€ä¹ˆéœ€è¦queue.getMin() == taskæ—¶æ‰è°ƒç”¨notifyæ–¹æ³•å‘¢ï¼Ÿ</span></div><div class="line">        <span class="keyword">if</span> (queue.getMin() == task)</div><div class="line">            queue.notify();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç çœ‹ä¼¼ç®€å•ï¼Œä½†ä¹Ÿæ˜¯æœ‰ç‚¹é—¨é“çš„ã€‚åœ¨è®¾ç½®ä»»åŠ¡å±æ€§çš„æ—¶å€™é‡‡ç”¨åŠ é”ï¼Œé¿å…å¹¶å‘ä¸‹æŠŠä¸åŒä»»åŠ¡çš„æ‰§è¡Œå‘¨æœŸç­‰å‚æ•°ææ··ä¹±äº†ã€‚æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—ä¸­ä¹Ÿä½¿ç”¨äº†åŠ é”ï¼Œå®é™…ä¸Šæ˜¯é’ˆå¯¹addæ–¹æ³•åŠ çš„é”ã€‚ä¿è¯addä»»åŠ¡ä¸å‡ºä¹±ï¼ˆè¿™ä¸ªé˜Ÿåˆ—ä¸æ˜¯å®‰å…¨çš„é˜Ÿåˆ—ï¼‰ã€‚æœ€åæœ‰ä¸ªåˆ¤æ–­ï¼Œä¸ºä»€ä¹ˆéœ€è¦queue.getMin() == taskæ—¶æ‰è°ƒç”¨notifyæ–¹æ³•å‘¢ï¼Ÿå› ä¸ºåªæœ‰æ–°åŠ å…¥çš„taskæ˜¯æ‰€æœ‰Taskä¸­è¦è¢«æœ€æ—©æ‰§è¡Œçš„taskæ—¶ï¼Œæ‰ä¼šéœ€è¦æ‰“æ–­TimeThreadçš„ç­‰å¾…çŠ¶æ€ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå½“å‰é˜Ÿåˆ—ä¸­æœ‰ä¸¤ä¸ªtaskï¼Œåˆ†åˆ«æ˜¯Aï¼ˆ3åˆ†é’Ÿååˆ°æ—¶é—´ï¼‰ã€Bï¼ˆ5åˆ†é’Ÿååˆ°æ—¶é—´ï¼‰ï¼Œæ­¤æ—¶TimerThreadæ­£åœ¨ç­‰å¾…Açš„æ—¶é—´åˆ°æ¥ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨queue.wait(3min)ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œé˜Ÿåˆ—ä¸­æ–°å¢ä¸€ä¸ªä»»åŠ¡Cï¼ˆ1åˆ†é’Ÿååˆ°æ—¶ï¼‰ï¼Œå¦‚æœä¸æ‰“æ–­queue.wait(3min)ï¼Œé‚£å½“wait(3min)è‡ªç„¶ç»“æŸæ—¶ï¼ŒCä»»åŠ¡å·²ç»è¿‡æœŸäº†â€¦ ä½†æ˜¯å¦‚æœæ–°åŠ å…¥çš„Cä»»åŠ¡æ˜¯éœ€è¦åœ¨4åˆ†é’Ÿåæ‰§è¡Œï¼Œé‚£å°±æ²¡å¿…è¦æ‰“æ–­wait(3min)çš„çŠ¶æ€ï¼Œå› ä¸ºå°±ç®—wait(3min)è‡ªç„¶ç»“æŸæ—¶ï¼ŒCä¹Ÿè¿˜æ²¡åˆ°æ—¶é—´.</p>
<h5 id="ä»»åŠ¡æ˜¯ä»€ä¹ˆ"><a href="#ä»»åŠ¡æ˜¯ä»€ä¹ˆ" class="headerlink" title="ä»»åŠ¡æ˜¯ä»€ä¹ˆ"></a>ä»»åŠ¡æ˜¯ä»€ä¹ˆ</h5><p>è¯´äº†è¿™ä¹ˆä¹…ï¼Œè¿˜æ²¡å¼„æ¸…æ¥šè¿™ä¸ªä»»åŠ¡æ˜¯ä¸ªä»€ä¹ˆç©æ„ï¼ŸæŒ‰ç…§ç›´è§‰è¯´åˆ°ä»»åŠ¡ç¬¬ä¸€æƒ³åˆ°å°±æ˜¯Runnableå¯¹è±¡ï¼Œä½†æ˜¯ä¹Ÿæœ‰å…¶ä»–æƒ…å†µä¸‹ä¸æ˜¯è¿™æ ·çš„ã€‚ç„¶è€Œè¿™ä¸ªä»»åŠ¡ç¡®å®æ˜¯ä¸ªRunnableå¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TimerTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="comment">// å¯¹è±¡é”</span></div><div class="line">    <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</div><div class="line">   </div><div class="line">    <span class="comment">// ä»»åŠ¡çŠ¶æ€ æ–°å»º å·²è°ƒåº¦ å·²æ‰§è¡Œ å·²å–æ¶ˆ</span></div><div class="line">    <span class="comment">// é»˜è®¤æ˜¯æ–°å»º</span></div><div class="line">    <span class="keyword">int</span> state = VIRGIN;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VIRGIN = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SCHEDULED   = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXECUTED    = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED   = <span class="number">3</span>;</div><div class="line">	 <span class="comment">// ä¸‹æ¬¡æ‰§è¡Œçš„æ—¶é—´</span></div><div class="line">    <span class="keyword">long</span> nextExecutionTime;</div><div class="line">	 <span class="comment">// å‘¨æœŸ</span></div><div class="line">    <span class="keyword">long</span> period = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">TimerTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span>(lock) &#123;</div><div class="line">            <span class="keyword">boolean</span> result = (state == SCHEDULED);</div><div class="line">            state = CANCELLED;</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">scheduledExecutionTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span>(lock) &#123;</div><div class="line">            <span class="keyword">return</span> (period &lt; <span class="number">0</span> ? nextExecutionTime + period</div><div class="line">                               : nextExecutionTime - period);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>TimeTaskå¯¹Runnableè¿›è¡Œç®€å•å°è£…ã€‚æš´éœ²å‡ºæŠ½è±¡çš„runæ–¹æ³•è®©ç”¨æˆ·çš„å…·ä½“å®ç°ç±»å»å®Œæˆã€‚åŒæ—¶æä¾›äº†å–æ¶ˆä»»åŠ¡çš„æ–¹æ³•ã€‚å’ŒJUCä¸­ä¸åŒçš„æ˜¯è¿™é‡ŒçŠ¶æ€çš„è½¬åŒ–éå¸¸ç®€å•ï¼Œæ²¡æœ‰JUCä¸­åŠ¨ä¸åŠ¨å°±ç”¨CASçš„éªšæ“ä½œã€‚è€ç‰ˆæœ¬çš„ä»£ç å°±æ˜¯å¥½ç†è§£äº›ã€‚</p>
<h5 id="ä»»åŠ¡çš„è°ƒåº¦ï¼ˆå®šæ—¶å™¨çš„æ ¸å¿ƒï¼‰"><a href="#ä»»åŠ¡çš„è°ƒåº¦ï¼ˆå®šæ—¶å™¨çš„æ ¸å¿ƒï¼‰" class="headerlink" title="ä»»åŠ¡çš„è°ƒåº¦ï¼ˆå®šæ—¶å™¨çš„æ ¸å¿ƒï¼‰"></a>ä»»åŠ¡çš„è°ƒåº¦ï¼ˆå®šæ—¶å™¨çš„æ ¸å¿ƒï¼‰</h5><p>æ—¢ç„¶éƒ½çŸ¥é“ä»»åŠ¡æ˜¯ä»€ä¹ˆäº†ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ˜¯æ€ä¹ˆè¢«å–å‡ºæ¥å’Œæ‰§è¡Œçš„ã€‚é¦–å…ˆå¾—çœ‹çœ‹è¿™ä¸ªçº¿ç¨‹æ˜¯ä¸ªä»€ä¹ˆæ ·å­çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">    <span class="comment">// æ ‡è®°è¿™ä¸ªçº¿ç¨‹æ˜¯ä¸æ˜¯è¦è¢«æŒ‚èµ·</span></div><div class="line">    <span class="keyword">boolean</span> newTasksMayBeScheduled = <span class="keyword">true</span>;</div><div class="line">	 <span class="comment">// ç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ— ç”¨äºå­˜æ”¾ä»»åŠ¡çš„é˜Ÿåˆ—</span></div><div class="line">    <span class="keyword">private</span> TaskQueue queue;</div><div class="line"></div><div class="line">    TimerThread(TaskQueue queue) &#123;</div><div class="line">        <span class="keyword">this</span>.queue = queue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mainLoop();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="comment">// Someone killed this Thread, behave as if Timer cancelled</span></div><div class="line">            <span class="keyword">synchronized</span>(queue) &#123;</div><div class="line">                newTasksMayBeScheduled = <span class="keyword">false</span>;</div><div class="line">                queue.clear();  <span class="comment">// Eliminate obsolete references</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// å…·ä½“æ‰§è¡Œæ ¸å¿ƒé€»è¾‘ å¼€æ­»å¾ªç¯è·‘</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mainLoop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                TimerTask task;</div><div class="line">                <span class="keyword">boolean</span> taskFired;</div><div class="line">                <span class="keyword">synchronized</span>(queue) &#123;</div><div class="line">                    <span class="comment">// Wait for queue to become non-empty</span></div><div class="line">                    <span class="comment">// å¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡ï¼Œè€Œä¸”å®šæ—¶å™¨æ²¡æœ‰è¢«å–æ¶ˆï¼ˆé»˜è®¤ä¸ºtrueï¼Œåªæœ‰å°†timerå–æ¶ˆcancelæ–¹æ³•è°ƒç”¨çš„æ—¶å€™å°†å…¶ç½®ä¸ºfalseï¼Œè¿˜æœ‰ä¸€ä¸ªåœ°æ–¹ï¼‰ å°±å¾—å°†è¿™ä¸ªçº¿ç¨‹æŒ‚èµ· ä¸ç„¶å°±é€ æˆäº†æ­»å¾ªç¯ cpuç›´æ¥ä¸Š100%</span></div><div class="line">                    <span class="comment">// è€Œå”¤èµ·çš„åœ°æ–¹åªæœ‰cancelæ–¹æ³•å’ŒthreadReaper</span></div><div class="line">                    <span class="keyword">while</span> (queue.isEmpty() &amp;&amp; newTasksMayBeScheduled)</div><div class="line">                        queue.wait();</div><div class="line">                    <span class="comment">// ä»»åŠ¡é˜Ÿåˆ—ç©ºäº† å®šæ—¶å™¨å–æ¶ˆäº† è·³å‡ºå¾ªç¯ çº¿ç¨‹ç»“æŸ</span></div><div class="line">                    <span class="keyword">if</span> (queue.isEmpty())</div><div class="line">                        <span class="keyword">break</span>; <span class="comment">// Queue is empty and will forever remain; die</span></div><div class="line"></div><div class="line">                    <span class="comment">// Queue nonempty; look at first evt and do the right thing</span></div><div class="line">                    <span class="keyword">long</span> currentTime, executionTime;</div><div class="line">                    <span class="comment">// ä»é˜Ÿåˆ—ä¸­å–å‡ºæœ€delayæ—¶é—´æœ€å°çš„ä»»åŠ¡ å¾—æœ€æ—©æ‰§è¡Œçš„ä»»åŠ¡</span></div><div class="line">                    task = queue.getMin();</div><div class="line">                    <span class="keyword">synchronized</span>(task.lock) &#123;</div><div class="line">                    	 <span class="comment">// ä»»åŠ¡å–æ¶ˆäº†ï¼Œå°†å…¶ç§»å‡ºé˜Ÿåˆ— ç»§ç»­å–ä¸‹ä¸€ä¸ª</span></div><div class="line">                        <span class="keyword">if</span> (task.state == TimerTask.CANCELLED) &#123;</div><div class="line">                            queue.removeMin();</div><div class="line">                            <span class="keyword">continue</span>;  <span class="comment">// No action required, poll queue again</span></div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">// currentTimeMillis()è¿”å›ä»¥æ¯«ç§’ä¸ºå•ä½çš„å½“å‰æ—¶é—´ï¼Œè¿”å›çš„æ˜¯å½“å‰æ—¶é—´ä¸1970 å¹´ 1 æœˆ 1 æ—¥åˆå¤œä¹‹é—´çš„æ—¶é—´å·®</span></div><div class="line">                        currentTime = System.currentTimeMillis();</div><div class="line">                        executionTime = task.nextExecutionTime;</div><div class="line">                        <span class="comment">// å¦‚æœç»™å®šçš„åˆ°æœŸæ—¶é—´å°äºå½“å‰æ—¶é—´ï¼ˆ1970-01-01åˆ°ç°åœ¨çš„å·®å€¼ï¼‰è¯´æ˜ä»»åŠ¡åˆ°æœŸäº† éœ€è¦è¢«æ‰§è¡Œ æŠŠtaskFiredç½®ä¸ºtrue</span></div><div class="line">                        <span class="keyword">if</span> (taskFired = (executionTime&lt;=currentTime)) &#123;</div><div class="line">                            <span class="keyword">if</span> (task.period == <span class="number">0</span>) &#123; <span class="comment">// Non-repeating, remove</span></div><div class="line">                            	  <span class="comment">// ä¸æ˜¯å‘¨æœŸæ‰§è¡Œçš„ä»»åŠ¡ ç›´æ¥ä»é˜Ÿåˆ—ä¸­ç§»é™¤æ‰ å°†ä»»åŠ¡çŠ¶æ€ç½®ä¸ºå·²æ‰§è¡Œ</span></div><div class="line">                                queue.removeMin();</div><div class="line">                                task.state = TimerTask.EXECUTED;</div><div class="line">                            &#125; <span class="keyword">else</span> &#123; <span class="comment">// Repeating task, reschedule</span></div><div class="line">                                <span class="comment">// æ˜¯å‘¨æœŸä»»åŠ¡ é‡æ–°è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œçš„æ—¶é—´ å³å½“å‰æ—¶é—´+é—´éš”æ—¶é—´ä¸ºä¸‹æ¬¡ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´</span></div><div class="line">                                <span class="comment">// è¿™é‡Œæ˜¯â–å› ä¸ºä¹‹å‰ä¼ è¿›æ¥çš„æ˜¯ä¸€ä¸ªè´Ÿå€¼</span></div><div class="line">                                queue.rescheduleMin(</div><div class="line">                                  task.period&lt;<span class="number">0</span> ? currentTime   - task.period</div><div class="line">                                                : executionTime + task.period);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// å¦‚æœæ²¡åˆ°æœŸ å°±ç­‰ä¸€ä¸ªdelayé•¿çš„æ—¶é—´</span></div><div class="line">                    <span class="comment">// executionTime  = System.currentTimeMillis()+delay</span></div><div class="line">                    <span class="keyword">if</span> (!taskFired) <span class="comment">// Task hasn't yet fired; wait</span></div><div class="line">                        queue.wait(executionTime - currentTime);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// ä»»åŠ¡å¯åŠ¨ æ‰§è¡Œä¸šåŠ¡é€»è¾‘</span></div><div class="line">                <span class="keyword">if</span> (taskFired)  <span class="comment">// Task fired; run it, holding no locks</span></div><div class="line">                    task.run();</div><div class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="å°ç–‘æƒ‘"><a href="#å°ç–‘æƒ‘" class="headerlink" title="å°ç–‘æƒ‘"></a>å°ç–‘æƒ‘</h5><p>æ•´ä¸ªå®šæ—¶å™¨çš„æ ¸å¿ƒé€»è¾‘åœ¨ä»£ç æ³¨é‡Šä¸­éƒ½ä¸€ä¸€è§£é‡Šäº†ã€‚å…¶ä¸­ä¸€ä¸ªç»†èŠ‚ï¼šå˜é‡newTasksMayBeScheduledç”¨æ¥åšä»€ä¹ˆçš„ã€‚<br>é¦–å…ˆå¾—çœ‹çœ‹å®ƒçš„å€¼è¢«ç½®ä¸ºfalseçš„æƒ…å½¢åœ¨å“ªäº›åœ°æ–¹å‡ºç°ã€‚</p>
<ul>
<li>Timer#cancelæ–¹æ³•</li>
<li>TimerThreadçš„mainloopæ‰§è¡Œå®Œäº†finallyå—ä¸­</li>
<li>Timerçš„æˆå‘˜å±æ€§threadReaperçš„finalizeæ–¹æ³•ä¸­</li>
</ul>
<p>å‰ä¸¤è€…éƒ½ä¸å¿…å¤šè§£é‡Šï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯æœ€åä¸€ç§æƒ…å†µã€‚è¿™ç§å†™æ³•æˆ‘è¿˜æ˜¯ç¬¬ä¸€æ¬¡è§ï¼Œè¿˜ä¸æ˜ç™½å…¶ä¸­çš„ç„æœºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * This object causes the timer's task execution thread to exit</div><div class="line"> * gracefully when there are no live references to the Timer object and no</div><div class="line"> * tasks in the timer queue.  It is used in preference to a finalizer on</div><div class="line"> * Timer as such a finalizer would be susceptible to a subclass's</div><div class="line"> * finalizer forgetting to call it.</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object threadReaper = <span class="keyword">new</span> Object() &#123;</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span>(queue) &#123;</div><div class="line">            thread.newTasksMayBeScheduled = <span class="keyword">false</span>;</div><div class="line">            queue.notify(); <span class="comment">// In case queue is empty.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å½“queueä¸ºç©ºï¼Œå¹¶ä¸”æ²¡äººè°ƒç”¨addæˆ–cancelæ–¹æ³•æ—¶ï¼ŒTimerThreadæ°¸è¿œéƒ½ä¸ä¼šstopï¼Œé‚£ä¹ˆè¿˜æœ‰åˆ«çš„å¯èƒ½å—ï¼Ÿ</p>
<p>ä¸Šè¿°çš„åšæ³•å°±æä¾›äº†å¦å¤–çš„æ€è·¯ã€‚å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡çš„æ—¶å€™ï¼ŒTimerThreadä¼šwaitï¼Œå¦‚æœä¸æ‰‹åŠ¨è°ƒç”¨cancelè¿™ä¸ªçº¿ç¨‹ä¸€ç›´ä¼šæŒ‚èµ·ã€‚èªæ˜çš„jdkå°±æä¾›äº†ä¸Šè¿°çš„æ–¹æ³•ã€‚å½“åœ¨GCçš„æ—¶å€™ä¼šè§¦å‘finalizeæ–¹æ³•è°ƒç”¨ï¼Œé‚£ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘GCå‘¢ï¼Ÿå½“Timerå¯¹è±¡æ²¡æœ‰è¢«ä»»ä½•å¯¹è±¡å¼•ç”¨çš„æ—¶å€™å¦‚æœæœ‰GCé‚£ä¹ˆè¿™æ®µä»£ç è¢«è°ƒç”¨ï¼šnewTasksMayBeScheduledç½®ä¸ºfalseåŒæ—¶å°†æŒ‚èµ·çš„TimerThreadå”¤é†’ï¼Œè¿™æ—¶å€™mainloopæ­»å¾ªç¯å°±è·³å‡ºäº†ï¼ŒTimerThreadçº¿ç¨‹ç»“æŸï¼</p>
<p>å…·ä½“éªŒè¯å¯ä»¥ä½¿ç”¨Jprofileè¿™ä¸ªå·¥å…·ã€‚äº‹å®ä¸Šç¡®å®å¯è¡Œã€‚ä½†æ˜¯é€šè¿‡è¿™æ®µä»£ç è®©æˆ‘è”æƒ³åˆ°ä¸€ä¸ªè¿™ä¸ªå®šæ—¶å™¨çš„å¼Šç«¯ï¼šæ²¡åšåˆ°åƒExecutorServiceèƒ½å¤Ÿç­‰åˆ°ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæˆåå†å°†å…¶å…³é—­ã€‚æ‰‹åŠ¨å…³é—­åªèƒ½é€šè¿‡cancelè¿™ç§ç²—æš´çš„æ–¹å¼,è¿˜å¥½jdkå·¥ç¨‹å¸ˆæä¾›è¿™æ ·ä¸€ä¸ªâ€œåé—¨â€ï¼Œäº¤ç»™jvmæ¥ç®¡ç†ã€‚è¿™ä¹Ÿä¸å¤±ä¸ºä¸€ç§è¡¥æ•‘æªæ–½ï¼Œä½†æ˜¯å¯¹äºä¹‹åçš„JUCè€Œè¨€ï¼Œè¿™ç§åšæ³•æ˜¾å¾—æœ‰ç‚¹â€œå°å„¿ç§‘â€äº†ã€‚ä½†æ˜¯å¯¹äºå­¦ä¹ è€…è€Œè¨€ï¼Œè¿™ç§ä»£ç ç»„ç»‡æ˜¾å¾—æ›´å®¹æ˜“è¯»æ‡‚ï¼Œè®¾è®¡æ€æƒ³å¾ˆå®¹æ˜“å‘ˆç°åœ¨æˆ‘ä»¬é¢å‰ã€‚æ—¶ä»£ä¸æ–­è¿›æ­¥ï¼Œæ€»ä¼šæœ‰å¥½çš„è®¾è®¡æ¥å–ä»£è€çš„æ—§çš„ä¸œè¥¿ã€‚å¹¶ä¸æ˜¯æ„å‘³ç€è€çš„æ—§çš„çœŸæ­£è¢«å–ä»£ï¼Œè€Œæ˜¯ä»¥å¦å¤–ä¸€ç§ä»·å€¼å‘ˆç°åœ¨æˆ‘ä»¬åæ¥äººé¢å‰ã€‚é€šè¿‡æ¯”è¾ƒï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæ›´åŠ ç†è§£ä»€ä¹ˆæ˜¯å¥½çš„è®¾è®¡ã€‚</p>
<h5 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h5><p>æ•´ä¸ªTimerå®šæ—¶ä»»åŠ¡çš„æ ¸å¿ƒé€»è¾‘å°±æ¢³ç†å®Œäº†ã€‚å…¶ä¸­æœ‰ä¸€äº›ç»†èŠ‚è¢«å¿½ç•¥æ‰äº†ï¼Œæ¯”å¦‚è¿™ä¸ªä»»åŠ¡é˜Ÿåˆ—queueçš„å…·ä½“å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * This class represents a timer task queue: a priority queue of TimerTasks,</div><div class="line"> * ordered on nextExecutionTime.  Each Timer object has one of these, which it</div><div class="line"> * shares with its TimerThread.  Internally this class uses a heap, which</div><div class="line"> * offers log(n) performance for the add, removeMin and rescheduleMin</div><div class="line"> * operations, and constant time performance for the getMin operation.</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskQueue</span> </span>&#123;</div><div class="line">    <span class="comment">// ç»´æŠ¤ä¸€ä¸ªé•¿åº¦ä¸º128çš„æ•°ç»„</span></div><div class="line">    <span class="keyword">private</span> TimerTask[] queue = <span class="keyword">new</span> TimerTask[<span class="number">128</span>];</div><div class="line"></div><div class="line">    <span class="comment">// é˜Ÿåˆ—é•¿åº¦</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> size;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Adds a new task to the priority queue.</div><div class="line">     * å½“å‰é˜Ÿåˆ—é•¿åº¦ä¸ºæœ€å¤§é•¿åº¦-1çš„æ—¶å€™å°±è¿›è¡Œæ‰©å®¹ æ–°é˜Ÿåˆ—é•¿åº¦ä¸ºå½“å‰2å€</div><div class="line">     * ä¸ºä»€ä¹ˆè¦åœ¨æœ€å¤§é•¿åº¦-1çš„æ—¶å€™æ‰©å®¹å‘¢ï¼Ÿå› ä¸ºä¸æå‰æ‰©å®¹å½“å‰çš„å…ƒç´ åŠ ä¸è¿›å»ğŸ˜‚</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(TimerTask task)</span> </span>&#123;</div><div class="line">        <span class="comment">// Grow backing store if necessary</span></div><div class="line">        <span class="keyword">if</span> (size + <span class="number">1</span> == queue.length)</div><div class="line">            queue = Arrays.copyOf(queue, <span class="number">2</span>*queue.length);</div><div class="line"></div><div class="line">        queue[++size] = task;</div><div class="line">        fixUp(size);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–ç¬¬ä¸€ä¸ªå…ƒç´  åˆ°æœŸæ—¶é—´æœ€è¿‘çš„</div><div class="line">     */</div><div class="line">    <span class="function">TimerTask <span class="title">getMin</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> queue[<span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ä¸‹æ ‡ä»1å¼€å§‹å–</span></div><div class="line">    <span class="function">TimerTask <span class="title">get</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> queue[i];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** </span></div><div class="line">     * ç§»é™¤ç¬¬ä¸€ä¸ªå…ƒç´  åˆ°æœŸæ—¶é—´æœ€è¿‘çš„</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removeMin</span><span class="params">()</span> </span>&#123;</div><div class="line">        queue[<span class="number">1</span>] = queue[size];</div><div class="line">        queue[size--] = <span class="keyword">null</span>;  <span class="comment">// Drop extra reference to prevent memory leak</span></div><div class="line">        fixDown(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">quickRemove</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        <span class="keyword">assert</span> i &lt;= size;</div><div class="line"></div><div class="line">        queue[i] = queue[size];</div><div class="line">        queue[size--] = <span class="keyword">null</span>;  <span class="comment">// Drop extra ref to prevent memory leak</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// æ”¹ç¬¬ä¸€ä¸ªå…ƒç´ çš„åˆ°æœŸæ—¶é—´å±æ€§</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rescheduleMin</span><span class="params">(<span class="keyword">long</span> newTime)</span> </span>&#123;</div><div class="line">        queue[<span class="number">1</span>].nextExecutionTime = newTime;</div><div class="line">        fixDown(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> size==<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Null out task references to prevent memory leak</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;=size; i++)</div><div class="line">            queue[i] = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        size = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Establishes the heap invariant (described above) assuming the heap</div><div class="line">     * satisfies the invariant except possibly for the leaf-node indexed by k</div><div class="line">     * (which may have a nextExecutionTime less than its parent's).</div><div class="line">     *</div><div class="line">     * This method functions by "promoting" queue[k] up the hierarchy</div><div class="line">     * (by swapping it with its parent) repeatedly until queue[k]'s</div><div class="line">     * nextExecutionTime is greater than or equal to that of its parent.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fixUp</span><span class="params">(<span class="keyword">int</span> k)</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (k &gt; <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">int</span> j = k &gt;&gt; <span class="number">1</span>;</div><div class="line">            <span class="keyword">if</span> (queue[j].nextExecutionTime &lt;= queue[k].nextExecutionTime)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            TimerTask tmp = queue[j];  queue[j] = queue[k]; queue[k] = tmp;</div><div class="line">            k = j;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Establishes the heap invariant (described above) in the subtree</div><div class="line">     * rooted at k, which is assumed to satisfy the heap invariant except</div><div class="line">     * possibly for node k itself (which may have a nextExecutionTime greater</div><div class="line">     * than its children's).</div><div class="line">     *</div><div class="line">     * This method functions by "demoting" queue[k] down the hierarchy</div><div class="line">     * (by swapping it with its smaller child) repeatedly until queue[k]'s</div><div class="line">     * nextExecutionTime is less than or equal to those of its children.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fixDown</span><span class="params">(<span class="keyword">int</span> k)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> j;</div><div class="line">        <span class="keyword">while</span> ((j = k &lt;&lt; <span class="number">1</span>) &lt;= size &amp;&amp; j &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (j &lt; size &amp;&amp;</div><div class="line">                queue[j].nextExecutionTime &gt; queue[j+<span class="number">1</span>].nextExecutionTime)</div><div class="line">                j++; <span class="comment">// j indexes smallest kid</span></div><div class="line">            <span class="keyword">if</span> (queue[k].nextExecutionTime &lt;= queue[j].nextExecutionTime)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            TimerTask tmp = queue[j];  queue[j] = queue[k]; queue[k] = tmp;</div><div class="line">            k = j;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Establishes the heap invariant (described above) in the entire tree,</div><div class="line">     * assuming nothing about the order of the elements prior to the call.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">heapify</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = size/<span class="number">2</span>; i &gt;= <span class="number">1</span>; i--)</div><div class="line">            fixDown(i);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªé˜Ÿåˆ—æ˜¯ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—ï¼Œä»¥taskçš„åˆ°æœŸæ—¶é—´æ¥æ’åºï¼Œæ—¶é—´è¶Šå°è¶Šé å‰ã€‚è¿™ä¸ªé˜Ÿåˆ—æ˜¯ç”¨å †ç»“æ„å®ç°çš„ï¼ˆåºŸè¯ï¼Œä¼˜å…ˆé˜Ÿåˆ—æœ¬èº«å°±æ˜¯å †ï¼‰ï¼Œå®é™…ä¸Šå †æœ¬è´¨ä¸Šå°±æ˜¯å®Œå…¨äºŒå‰æ ‘ã€‚å¯¹äºadd removeæ“ä½œçš„å¤æ‚åº¦ä¸ºlog(n)ã€‚æœ€æ ¸å¿ƒçš„æ“ä½œå°±æ˜¯fixDown fixUpã€‚å †ä¹Ÿåˆ†ä¸ºå¤§æ ¹å †å’Œå°æ ¹å †ï¼Œè¿™æ˜¯ä¸€ä¸ªå°æ ¹å †ï¼Œæœ€å°çš„æ”¾åˆ°æœ€ä¸Šé¢ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ ‡ä¸º1çš„ä½ç½®ï¼ˆåªæ˜¯Timerä¸­çš„å®ç°å°†ä¸‹æ ‡ä¸º0çš„ä½ç½®ç»™å¼ƒç”¨äº†ï¼‰ã€‚æ¯æ¬¡æ·»åŠ å…ƒç´ éƒ½å¾—è°ƒæ•´å †ç»“æ„ï¼ŒåŒç†ç§»é™¤çš„æ—¶å€™ä¹Ÿå¾—è¿™æ ·åšã€‚</p>
<p>æœ¬æ–‡ä¸­çš„<a href="https://github.com/Mr-Vincent/simple-rpc/blob/a570c16128062b14ac0f0fa75e769d76060d3ad2/simple-example/src/main/java/top/weidong/example/netty/nettyinpractice/timer/JdkTimerDemo.java#L95-L94" target="_blank" rel="external">demo</a>ã€‚</p>
<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><ul>
<li>æºç è¯»èµ·æ¥æ²¡é‚£ä¹ˆéš¾å—ï¼Œä»”ç»†æ¨æ•²è¿˜æ˜¯å¾ˆæœ‰æ„æ€çš„ã€‚</li>
<li>ç›¸æ¯”è€çˆ·å­Doug Leaçš„éªšä»£ç ï¼Œè¿™ç§ä¸­è§„ä¸­çŸ©çš„å†™æ³•çœ‹èµ·æ¥æ›´è®©äººå®¹æ˜“ç†è§£ã€‚</li>
<li>å»ºè®®ä½¿ç”¨ScheduledExecutorServiceï¼Œæ¯•ç«ŸTimerçš„é€‚ç”¨åœºæ™¯å¾ˆå±€é™ã€‚</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨jdkä¸­å¤„ç†å®šæ—¶ä»»åŠ¡å·¥å…·ç±»ä¸­æœ‰2ç§ï¼šTimerå’ŒScheduledExecutorServiceã€‚å‰è€…æ˜¯åœ¨java.utilåŒ…ä¸­ï¼Œä»1.3ç‰ˆæœ¬å¼€å§‹ï¼Œå±äºæ¯”è¾ƒè€çš„å·¥å…·ç±»äº†ã€‚è€ŒScheduledExecutorServiceå±äºjava.util.concurrentåŒ…ï¼Œä½œè€…
    
    </summary>
    
      <category term="JDK SOURCE" scheme="http://www.wei-dong.top/categories/JDK-SOURCE/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="JDK" scheme="http://www.wei-dong.top/tags/JDK/"/>
    
  </entry>
  
  <entry>
    <title>å†™ç»™2017</title>
    <link href="http://www.wei-dong.top/2017/12/31/my%202017/"/>
    <id>http://www.wei-dong.top/2017/12/31/my 2017/</id>
    <published>2017-12-31T09:42:35.000Z</published>
    <updated>2018-01-01T10:44:55.854Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©æ˜¯2018å¹´ä¸€æœˆä¸€å·ï¼Œ2018å¹´çš„ç¬¬ä¸€å¤©ã€‚èƒ¡æ–æ—©ä¸Šå»HKä¹°æ‰‹æœºåˆ°ç°åœ¨è¿˜æ²¡å›æ¥ï¼Œé˜¿ååˆšåˆšå‡ºå»çº¦ä¼šå»äº†ã€‚ç°åœ¨å°±å‰©ä¸‹æˆ‘ä¸€ä¸ªäººåœ¨å®¶ï¼Œååœ¨æ²™å‘ä¸Šæ€é‡ç€è¿™ç¯‡æ–‡ç« è¯¥æ€ä¹ˆå»å†™ã€‚å‚æ™šäº†ï¼Œä½™æ™–æ¸æ¸è¤ªã€‚å’Œå¾€å¸¸ä¸åŒçš„æ˜¯ä»Šå¤©çš„å¤©é™…çº¿è¾¹æ²¡æœ‰å¾€æ—¥é‚£æ ·çº¢äº†ã€‚æ›¾å‡ ä½•æ—¶ï¼Œå¤šå°‘ä¸ªé»„æ˜ååˆ†ï¼Œæˆ‘å°±ååœ¨æ²™å‘ä¸Šï¼Œé™é™ç­‰ç€ï¼Œç­‰ç€å¤ªé˜³è½å±±ï¼Œç­‰ç€æ™šéœæ˜ çº¢å¤©é™…çº¿ã€‚æ¯åˆ°é‚£ä¸ªç‚¹å„¿ï¼Œæ€»æœ‰é£æœºé£è¿‡ï¼Œåœ¨æ™šéœçš„æ˜ è¡¬ä¸‹ï¼Œç¼“ç¼“åœ°åˆ’è¿‡å»ï¼Œä¸€æ¶åˆä¸€æ¶ã€‚é‚£æ˜¯å»å¹´å¹´åº•çš„æ—¶å€™ã€‚</p>
<p>12æœˆä»½ï¼Œè¢«å…¬å¸åŠé€€ã€‚å½“æ—¶èµ°çš„æ—¶å€™å¿ƒé‡Œåˆ«æå¤šé«˜å…´äº†ï¼Œç»ˆäºå¯ä»¥ä¸ç”¨ä¸Šç­äº†ï¼Œç»ˆäºä¸ç”¨å¤©å¤©åšä¸€äº›æ— èŠåˆæ²¡æœ‰æ„ä¹‰çš„äº‹æƒ…äº†ã€‚æ²¡æœ‰é©¬ä¸Šå»æ‰¾å·¥ä½œï¼Œè€Œæ˜¯ä»€ä¹ˆéƒ½ä¸å¹²ï¼Œç©ä»–ä¹ˆ2ä¸ªæ˜ŸæœŸå†è¯´ã€‚æœçœŸç©äº†ä¸€ä¸ªæ˜ŸæœŸï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰å»æƒ³ï¼Œå®‰å®‰é™é™çš„çœ‹çœ‹ä¹¦ï¼Œçœ‹çœ‹ç”µè§†å‰§ï¼Œç¡ç¡è§‰ã€‚é‚£æ—¶å€™è§‰å¾—ä¸ç”¨å·¥ä½œçœŸçš„æ˜¯å¾ˆå¹¸ç¦çš„ä¸€ä»¶äº‹æƒ…ã€‚ç¬¬äºŒå‘¨æŠŠç®€å†éšä¾¿å†™äº†å†™ï¼Œåˆéšä¾¿æŠ•äº†æŠ•ï¼Œæ²¡ä»€ä¹ˆå›åº”ã€‚ä¹Ÿä¸åœ¨ä¹ï¼Œåæ­£ä¹Ÿä¸æƒ³ä¸Šç­ï¼Œç»§ç»­ç©å‘—ã€‚ä¹¦ä¹Ÿçœ‹çš„å·®ä¸å¤šäº†ï¼Œå¾—æ‰¾äº›æ›´åŠ æœ‰æ„æ€çš„äº‹æƒ…æ¥åšã€‚åœ¨ç½‘æ˜“äº‘è¯¾å ‚ä¸ŠæŠ¥äº†ä¸€ä¸ªç´ æç­ï¼Œå¼€å§‹å­¦ä¹ ç”»ç”»ã€‚è™½ç„¶ç°åœ¨éƒ½æ²¡æ€ä¹ˆåŠ¨ç¬”å»ç”»äº†ï¼Œä½†æ˜¯æˆ‘å¯¹ç´ æçš„çƒ­æƒ…è¿˜æ˜¯æ²¡æœ‰è¤ªå»ã€‚ä¹°äº†å¥½å‡ æœ¬ä¹¦è¿˜æ²¡å¼€å§‹çœ‹ï¼Œæˆ‘çŸ¥é“æ€»ä¼šçœ‹çš„ï¼Œæ€»ä¼šå»åšæŒä¸‹å»ï¼Œæ€»ä¼šå®è·µå‡ºæ¥ã€‚ä»”ç»†å›æƒ³è¿‡å»ï¼Œå¯¹äºæ¯å¤©çš„æ¯ç‡¥æ— èŠçš„codingå’ŒåŠ ç­ï¼Œæ˜¯æ—¶å€™è¯¥é—®é—®è‡ªå·±åˆ°åº•æƒ³è¦ä»€ä¹ˆï¼Œæƒ³è¾¾åˆ°ä¸€ä¸ªä»€ä¹ˆæ ·çš„å±‚æ¬¡ã€‚åŸ¹å…»ä¸€ç§å…´è¶£çˆ±å¥½å¯¹äºæˆ‘ä»¬è¿™ç§ç”Ÿæ´»å•è°ƒæ— èŠçš„äººæ¥è¯´å¾ˆé‡è¦ã€‚ä¸å…‰ä»…ä»…å­¦ç´ æï¼Œè¿˜æ—¶ä¸æ—¶å»è°ˆè°ˆå‰ä»–ï¼Œè™½ç„¶æ‰‹ä¸Šçš„èŒ§éƒ½æ¶ˆåœ°å·®ä¸å¤šäº†ï¼Œä½†æ˜¯çƒ­æƒ…è¿˜åœ¨ã€‚</p>
<p>æ²¡ä¸Šç­çš„æ—¥å­æˆ‘æƒ³è¿‡å¾ˆå¤šã€‚ç›®å‰è¿™ä¸ªèŒä¸šæˆ‘æƒ³æˆ‘ä¸ä¼šä¸€ç›´èµ°ä¸‹å»ï¼Œä¸‡ä¸€èµ°ä¸ä¸‹å»äº†æˆ‘å¾—ç»™è‡ªå·±æ‰¾æ¡åè·¯ã€‚ä½†ä¸è®ºæ€ä¹ˆè¯´ï¼Œç›®å‰è¿˜æ˜¯å¾—èµ°ä¸‹å»ï¼Œè¿˜æ˜¯å¾—ä¸æ–­å»å­¦ä¹ ã€‚</p>
<p>æ€»è§‰å¾—æœ‰å¾ˆå¤šæ—¶å€™ï¼Œèƒ½ä¸€ä¸ªäººç‹¬å¤„æ˜¯ä¸€ä»¶å¤šä¹ˆæ„‰å¿«çš„äº‹æƒ…ã€‚å±‹å­é‡Œå°±æˆ‘ä¸€ä¸ªäººï¼Œå¿ƒæ²¡æœ‰é‚£ä¹ˆæµ®èºã€‚ä¸ä¼šå»çœ‹é˜¿åæ‰“æ¸¸æˆï¼Œä¸ä¼šæ‰¾èƒ¡æ–æ‰¯æ·¡ã€‚å¯ä»¥çœ‹ä¹¦ï¼Œå¯ä»¥å†™ç‚¹ä¸œè¥¿â€¦</p>
<p>æ€»æ˜¯å°†çœ‹ä¹¦ä½œä¸ºä¸€ä»¶å¾ˆé‡è¦çš„äº‹æƒ…ã€‚ç¦»å¼€æ ¡å›­ï¼Œè¸å…¥ç¤¾ä¼šå‚åŠ å·¥ä½œï¼Œå¯èƒ½æ²¡æœ‰æœºä¼šå»ç¢°ä¹¦ã€‚å› æ­¤è¯»ä¹¦å°±æ˜¾å¾—ååˆ†å¯è´µã€‚æ„Ÿè§¦æœ€æ˜æ˜¾çš„æ—¶å€™å°±æ˜¯å’Œåˆ«äººäº¤æµçš„æ—¶å€™ï¼Œæœ‰æ—¶å€™è§‰å¾—å¯¹æ–¹è¯´çš„è‡ªå·±éƒ½æ²¡åŠæ³•æ¥ã€‚å»å¹´æˆ‘ä¹Ÿè¯»äº†éƒ¨åˆ†ä¹¦ï¼Œä»…ä»…åªæ˜¯è¯»è¿‡ï¼Œè¿˜æ²¡æœ‰ä»€ä¹ˆæ·±åˆ»è®¤è¯†ã€‚å°è±¡ä¸­è€—æ—¶æœ€é•¿çš„æ˜¯ã€Šç™½é¹¿åŸã€‹ã€‚ä»¥å‰ä¸Šä¸‹ç­åœ¨åœ°é“ä¸Šå°±æ‹¿ç€æ‰‹æœºçœ‹ï¼Œæ¯å¤©éƒ½èƒ½çœ‹ä¸€ç‚¹ã€‚ç°åœ¨æ²¡æœ‰é‚£ä¹ˆå¤šå¤§æŠŠå¤§æŠŠçš„æ—¶é—´äº†ã€‚é›¶ç¢çš„æ—¶é—´ä¹Ÿä¸çŸ¥é“è¯¥æ€ä¹ˆåˆ©ç”¨ã€‚æ”¶è·æœ€å¤§çš„ä¸€æœ¬ä¹¦æ˜¯ã€ŠHow Tomcat Worksã€‹ã€‚è¿™æœ¬ä¹¦æœ¬èº«å°±å†™å¾—ä¸é”™ï¼Œæµ…æ˜¾æ˜“æ‡‚ã€‚å¾ˆä¹…ä»¥æ¥ï¼Œæˆ‘è¯»ä¹¦éƒ½æ²¡æœ‰è®°ç¬”è®°çš„ä¹ æƒ¯ã€‚ä½†æ˜¯è¯»è¿™æœ¬ä¹¦æˆ‘ç”¨çº¸ç¬”å°†å…¶ä¸­æœ‰æ„æ€çš„å†…å®¹è®°ä¸‹æ¥äº†ã€‚ä»¥å‰ä¸€ç›´è®¤ä¸ºä¸ä¼šçš„æˆ–è€…å¿˜è®°äº†çš„å»ç™¾åº¦è°·æ­Œå°±å¥½äº†ã€‚ç°åœ¨åˆ™æ˜¯è§‰å¾—æœ‰å¿…è¦å°±å¯ä»¥ç”¨ç¬”è®°ä¸‹æ¥ï¼Œç”»ä¸€ä¸‹ä¹Ÿè¡Œï¼Œè¿™æ ·å®¹æ˜“å¸®åŠ©ç†è§£å’Œè®°å¿†ã€‚è™½ç„¶ç°åœ¨çš„å„ç§è½¯ä»¶APPéƒ½å¾ˆå¤šå¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯æœ‰æ—¶å€™å°±æ˜¯è®°ä¸‹æ¥å°±å¾ˆå°‘å»çœ‹äº†ã€‚èµ°è¿‡ä¸€é­ï¼Œæ€»å¾—ç•™ä¸‹ç‚¹ä»€ä¹ˆå§ã€‚</p>
<p>å‰äº›æ—¥å­ï¼ŒæŠŠç©äº†å·®ä¸å¤š2å¹´çš„æ¸¸æˆç‹è€…å†œè¯å¸è½½äº†ã€‚ä»¥åä¸å†è¿™ä¸Šé¢æµªè´¹æ—¶é—´äº†ã€‚ç„¶è€Œå¯è€»çš„æ˜¯å¼€å§‹äº†åƒé¸¡ã€‚æˆ‘æƒ³æˆ‘ä¹Ÿä¸ä¼šæ²‰è¿·äºåƒé¸¡å¤ªä¹…ï¼Œæ¯”è¾ƒä¸€ä¸ªäººç©ä¹Ÿæ²¡å¤šå¤§æ„æ€ã€‚ç©ç€ç©ç€å¯èƒ½å°±æ— èŠäº†ã€‚å¯èƒ½ä¼šå°†æ³¨æ„åŠ›è½¬ç§»åˆ°å†™ä½œæˆ–è€…ç´ æä¸Šæ¥ã€‚å»å¹´å±¯çš„ä¹¦ä¹Ÿè¿˜ä¸€æœ¬æ²¡çœ‹å®Œï¼Œæ€»å¾—ç»™è‡ªå·±ä¸€ç‚¹äº¤ä»£å§ã€‚</p>
<p>å‡ºæ¥å·¥ä½œè¿™ä¹ˆä¹…äº†ï¼Œéš¾è¿‡çš„æ˜¯ä¸€ä¸ªæ–°æœ‹å‹éƒ½æ²¡æœ‰äº¤åˆ°ã€‚å¾ˆå¤šè€æœ‹å‹å´æ²¡ä»€ä¹ˆè”ç³»äº†ã€‚æœ‰æ—¶å€™å°±è§‰å¾—äººæƒ…è–„å¦‚çº¸ã€‚åœˆå­ä¸åŒäº†ï¼Œå¯èƒ½è®¤çŸ¥ä¹Ÿä¸å¤ªä¸€æ ·äº†ã€‚ä»…ä»…åªæ˜¯æˆ‘è¿˜åœ¨åŸåœ°è¸æ­¥è€Œå·²ï¼Œå´æ€»æš—ç¤ºè‡ªå·±è¦å‘å‰èµ°ã€‚å³ä½¿å¦‚æ­¤é‚£åˆæ€æ ·ï¼Ÿæˆ‘åˆå¿ƒä¸æ”¹ï¼Œæˆ‘ä¾æ—§æ˜¯é‚£ä¸ªæˆ‘ã€‚è™½ä¸å­¤ç‹¬ä¸ºä¼´ï¼Œä½†æ˜¯å†…å¿ƒä¾æ—§ä¸°å¯Œã€‚ä»æ­¤å†ä¹Ÿä¸å§”å±ˆè‡ªå·±ï¼Œä¸å†çƒ­è„¸è´´å†·å±è‚¡ã€‚æˆ‘ä¹Ÿæœ‰æˆ‘è‡ªå·±çš„ä¸–ç•Œã€‚</p>
<p>æ¯å½“å›é¦–è¿‡å»çš„æ—¶å€™ï¼Œæ€»æ˜¯è§‰å¾—è®¸å¤šæ—¥å­éƒ½è™šåº¦äº†ã€‚æœ‰äº›äº‹æƒ…ï¼Œåšå¥½è§„åˆ’è¿˜æ˜¯å¾ˆæœ‰å¿…è¦ï¼Œå‰ææ˜¯å‘€æœ‰è¶³å¤Ÿçš„è‡ªå¾‹ï¼Œå¦åˆ™å…¶ä»–éƒ½æ˜¯çæ‰¯æ·¡ã€‚</p>
<p>ä¸è®ºè¿‡å»æœ‰æ€æ ·çš„æ‡Šæ‚”å’Œä¸æ»¡ï¼Œè·¯è¿˜é•¿ï¼Œæ€»å¾—å¾€å‰èµ°ã€‚åªå¸Œæœ›åœ¨ä¸‹ä¸ªè·¯æ ‡å›å¤´çš„æ—¶å€™ï¼Œæˆ‘èƒ½ä¾ç„¶è®°å¾—æ­¤æ—¶çš„æˆ‘å¯¹è‡ªå·±çš„æœŸè®¸ã€‚</p>
<p>2018ï¼Œæˆ‘å·²å‡†å¤‡å¥½ï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»Šå¤©æ˜¯2018å¹´ä¸€æœˆä¸€å·ï¼Œ2018å¹´çš„ç¬¬ä¸€å¤©ã€‚èƒ¡æ–æ—©ä¸Šå»HKä¹°æ‰‹æœºåˆ°ç°åœ¨è¿˜æ²¡å›æ¥ï¼Œé˜¿ååˆšåˆšå‡ºå»çº¦ä¼šå»äº†ã€‚ç°åœ¨å°±å‰©ä¸‹æˆ‘ä¸€ä¸ªäººåœ¨å®¶ï¼Œååœ¨æ²™å‘ä¸Šæ€é‡ç€è¿™ç¯‡æ–‡ç« è¯¥æ€ä¹ˆå»å†™ã€‚å‚æ™šäº†ï¼Œä½™æ™–æ¸æ¸è¤ªã€‚å’Œå¾€å¸¸ä¸åŒçš„æ˜¯ä»Šå¤©çš„å¤©é™…çº¿è¾¹æ²¡æœ‰å¾€æ—¥é‚£æ ·çº¢äº†ã€‚æ›¾å‡ ä½•æ—¶ï¼Œå¤šå°‘ä¸ªé»„æ˜ååˆ†ï¼Œæˆ‘å°±ååœ¨æ²™å‘ä¸Šï¼Œé™
    
    </summary>
    
      <category term="beyound coding" scheme="http://www.wei-dong.top/categories/beyound-coding/"/>
    
    
      <category term="æ‰€æƒ³" scheme="http://www.wei-dong.top/tags/%E6%89%80%E6%83%B3/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠHow Tomcat Worksã€‹è¯»ä¹¦ç¬”è®°</title>
    <link href="http://www.wei-dong.top/2017/12/06/%E3%80%8AHow%20Tomcat%20Works%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    <id>http://www.wei-dong.top/2017/12/06/ã€ŠHow Tomcat Worksã€‹è¯»ä¹¦ç¬”è®°/</id>
    <published>2017-12-06T04:37:23.000Z</published>
    <updated>2017-12-06T04:39:19.177Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æœ¬ä¹¦çœ‹äº†è¿™ä¹ˆä¹…ï¼Œå·®ä¸å¤šå¯ä»¥ç®—æ˜¯çœ‹å®Œäº†ã€‚å‡†ç¡®æ¥è®²æ˜¯è¿˜å‰©ä¸¤ä¸ªç« èŠ‚æ²¡æœ‰è¯»å®Œã€‚æœ€åé‚£ä¸¤ä¸ªç« èŠ‚çš„çš„ç¡®ç¡®æ˜¯å¾ˆä¸å¾—åŠ²ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯è‡ªå·±å¼€å§‹æµ®èºèµ·æ¥äº†ã€‚æˆ‘çœ‹çš„æ˜¯ä¸­æ–‡ç¿»è¯‘çš„ï¼Œå¯æ°”çš„æ˜¯ä¸­æ–‡ç¿»è¯‘å¾ˆå¤šé”™åˆ«å­—ä¸è¯´ï¼Œå±…ç„¶æœ‰äº›åœ°æ–¹æ ¹æœ¬å°±æ²¡æœ‰ç¿»è¯‘åˆ°ï¼Œâ€œç¼ºæ–¤å°‘ä¸¤â€å¾ˆå¯æ°”ã€‚ç„¶ååˆæ‰¾åŸç‰ˆå¯¹ç…§ç€çœ‹ï¼Œé¿å…è¢«â€œè¯¯å…¥æ­§é€”â€ã€‚<br><a id="more"></a><br>å·®ä¸å¤šâ€œè¯»å®Œâ€åï¼Œæœ‰é‚£ä¹ˆä¸€ç‚¹å°æ”¶è·ï¼š</p>
<ul>
<li>è§‚å¯Ÿè€…æ¨¡å¼</li>
<li>è´£ä»»é“¾æ¨¡å¼</li>
<li>é—¨é¢æ¨¡å¼</li>
<li>æƒ³åˆ°äº†å†å†™</li>
</ul>
<h3 id="è§‚å¯Ÿè€…æ¨¡å¼"><a href="#è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h3><p>è¿™ä¸ªæ¨¡å¼æ˜¯æˆ‘å°è±¡æœ€æ·±åˆ»çš„ï¼Œä¹Ÿæ˜¯æˆ‘æœ€æƒ³å­¦ä¹ çš„ã€‚å°¤å…¶æ˜¯çœ‹åˆ°äº†Tomcatæºç ä¸­çš„é‚£äº›éªšæ“ä½œã€‚å½“ç„¶ä¸ä»…ä»…æ˜¯åœ¨Tomcatä¸­æœ‰è¿™ç§è®¾è®¡ï¼Œ<br>æˆ‘åœ¨çœ‹Springæºç çš„æ—¶å€™ä¹Ÿç•™æ„åˆ°äº†ä¹Ÿæœ‰è¿™ç§è®¾è®¡æ€æƒ³ï¼Œå†…å¿ƒä¸ç¦å‘å‡ºä¸€ä¸ªä¿¡å·ï¼šæ•™ç»ƒæˆ‘ä¹Ÿæƒ³å­¦ã€‚</p>
<p>æ¥ä¸‹æ¥å°±é’ˆå¯¹Tomcatä¸­çš„æºç æ¥å¯¹è§‚å¯Ÿè€…æ¨¡å¼è¿›è¡Œç®€å•çš„æ•´ç†ã€‚Tomcatä¸­è®¸å¤šç»„ä»¶éƒ½æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œå…¶å®ä¸æ­¢Tomcatï¼Œå¾ˆå¤šå…¶ä»–åœ°æ–¹ä¹Ÿæœ‰ç”Ÿå‘½å‘¨æœŸçš„æ¦‚å¿µï¼šSpringç”Ÿå‘½å‘¨æœŸï¼ŒServletç”Ÿå‘½å‘¨æœŸç­‰ç­‰ã€‚ç”Ÿå‘½å‘¨æœŸå°±æ˜¯è§‚å¯Ÿè€…æ¨¡å¼æœ€å¥½çš„ä½“ç°ã€‚ä¸¾ä¸ªæ —å­ï¼ŒServiceç»„ä»¶ï¼š<code>StandardService</code>å°±æœ‰ç”Ÿå‘½å‘¨æœŸï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardService</span></span></div><div class="line">    <span class="keyword">implements</span> <span class="title">Lifecycle</span>, <span class="title">Service</span> &#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The set of Connectors associated with this Service.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Connector connectors[] = <span class="keyword">new</span> Connector[<span class="number">0</span>];</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The Container associated with this Service.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Container container = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The debugging detail level for this component.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> debug = <span class="number">0</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Descriptive information about this component implementation.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String info =</div><div class="line">        <span class="string">"org.apache.catalina.core.StandardService/1.0"</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Has this component been initialized?</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> initialized = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The name of this service.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String name = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The lifecycle event support for this component.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> LifecycleSupport lifecycle = <span class="keyword">new</span> LifecycleSupport(<span class="keyword">this</span>);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The string manager for this package.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> StringManager sm =</div><div class="line">        StringManager.getManager(Constants.Package);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The &lt;code&gt;Server&lt;/code&gt; that owns this Service, if any.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Server server = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Has this component been started?</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The property change support for this component.</div><div class="line">     */</div><div class="line">    <span class="keyword">protected</span> PropertyChangeSupport support = <span class="keyword">new</span> PropertyChangeSupport(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="comment">// ------------------------------------------------------ Lifecycle Methods</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Add a LifecycleEvent listener to this component.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> listener The listener to add</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</div><div class="line"></div><div class="line">        lifecycle.addLifecycleListener(listener);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Get the lifecycle listeners associated with this lifecycle. If this </div><div class="line">     * Lifecycle has no listeners registered, a zero-length array is returned.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> LifecycleListener[] findLifecycleListeners() &#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> lifecycle.findLifecycleListeners();</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Remove a LifecycleEvent listener from this component.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> listener The listener to remove</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</div><div class="line"></div><div class="line">        lifecycle.removeLifecycleListener(listener);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Prepare for the beginning of active use of the public methods of this</div><div class="line">     * component.  This method should be called before any of the public</div><div class="line">     * methods of this component are utilized.  It should also send a</div><div class="line">     * LifecycleEvent of type START_EVENT to any registered listeners.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</div><div class="line">     *  that prevents this component from being used</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// Validate and update our current component state</span></div><div class="line">        <span class="keyword">if</span> (started) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException</div><div class="line">                (sm.getString(<span class="string">"standardService.start.started"</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Notify our interested LifecycleListeners</span></div><div class="line">        lifecycle.fireLifecycleEvent(BEFORE_START_EVENT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        System.out.println</div><div class="line">            (sm.getString(<span class="string">"standardService.start.name"</span>, <span class="keyword">this</span>.name));</div><div class="line">        lifecycle.fireLifecycleEvent(START_EVENT, <span class="keyword">null</span>);</div><div class="line">        started = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Start our defined Container first</span></div><div class="line">        <span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (container) &#123;</div><div class="line">                <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Lifecycle) &#123;</div><div class="line">                    ((Lifecycle) container).start();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Start our defined Connectors second</span></div><div class="line">        <span class="keyword">synchronized</span> (connectors) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; connectors.length; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (connectors[i] <span class="keyword">instanceof</span> Lifecycle)</div><div class="line">                    ((Lifecycle) connectors[i]).start();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Notify our interested LifecycleListeners</span></div><div class="line">        lifecycle.fireLifecycleEvent(AFTER_START_EVENT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Gracefully terminate the active use of the public methods of this</div><div class="line">     * component.  This method should be the last one called on a given</div><div class="line">     * instance of this component.  It should also send a LifecycleEvent</div><div class="line">     * of type STOP_EVENT to any registered listeners.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</div><div class="line">     *  that needs to be reported</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// Validate and update our current component state</span></div><div class="line">        <span class="keyword">if</span> (!started) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException</div><div class="line">                (sm.getString(<span class="string">"standardService.stop.notStarted"</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Notify our interested LifecycleListeners</span></div><div class="line">        lifecycle.fireLifecycleEvent(BEFORE_STOP_EVENT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        lifecycle.fireLifecycleEvent(STOP_EVENT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        System.out.println</div><div class="line">            (sm.getString(<span class="string">"standardService.stop.name"</span>, <span class="keyword">this</span>.name));</div><div class="line">        started = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Stop our defined Connectors first</span></div><div class="line">        <span class="keyword">synchronized</span> (connectors) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; connectors.length; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (connectors[i] <span class="keyword">instanceof</span> Lifecycle)</div><div class="line">                    ((Lifecycle) connectors[i]).stop();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Stop our defined Container second</span></div><div class="line">        <span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (container) &#123;</div><div class="line">                <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Lifecycle) &#123;</div><div class="line">                    ((Lifecycle) container).stop();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Notify our interested LifecycleListeners</span></div><div class="line">        lifecycle.fireLifecycleEvent(AFTER_STOP_EVENT, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Invoke a pre-startup initialization. This is used to allow connectors</div><div class="line">     * to bind to restricted ports under Unix operating environments.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span></span></div><div class="line">    <span class="keyword">throws</span> LifecycleException &#123;</div><div class="line">        <span class="keyword">if</span> (initialized)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException (</div><div class="line">                sm.getString(<span class="string">"standardService.initialize.initialized"</span>));</div><div class="line">        initialized = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Initialize our defined Connectors</span></div><div class="line">        <span class="keyword">synchronized</span> (connectors) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; connectors.length; i++) &#123;</div><div class="line">                    connectors[i].initialize();</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­åªä¿ç•™äº†æœ‰å…³<code>Lifecycle</code>æ¥å£çš„æ–¹æ³•å®ç°ã€‚çœ‹çœ‹<code>Lifecycle</code>æ¥å£çš„å®šä¹‰ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Lifecycle</span> </span>&#123;</div><div class="line">    <span class="comment">// ----------------------------------------------------- Manifest Constants</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The LifecycleEvent type for the "component start" event.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String START_EVENT = <span class="string">"start"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The LifecycleEvent type for the "component before start" event.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEFORE_START_EVENT = <span class="string">"before_start"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The LifecycleEvent type for the "component after start" event.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AFTER_START_EVENT = <span class="string">"after_start"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The LifecycleEvent type for the "component stop" event.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String STOP_EVENT = <span class="string">"stop"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The LifecycleEvent type for the "component before stop" event.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEFORE_STOP_EVENT = <span class="string">"before_stop"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The LifecycleEvent type for the "component after stop" event.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AFTER_STOP_EVENT = <span class="string">"after_stop"</span>;</div><div class="line">    <span class="comment">// --------------------------------------------------------- Public Methods</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Add a LifecycleEvent listener to this component.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> listener The listener to add</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLifecycleListener</span><span class="params">(LifecycleListener listener)</span></span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Get the lifecycle listeners associated with this lifecycle. If this </div><div class="line">     * Lifecycle has no listeners registered, a zero-length array is returned.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> LifecycleListener[] findLifecycleListeners();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Remove a LifecycleEvent listener from this component.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> listener The listener to remove</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeLifecycleListener</span><span class="params">(LifecycleListener listener)</span></span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Prepare for the beginning of active use of the public methods of this</div><div class="line">     * component.  This method should be called before any of the public</div><div class="line">     * methods of this component are utilized.  It should also send a</div><div class="line">     * LifecycleEvent of type START_EVENT to any registered listeners.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</div><div class="line">     *  that prevents this component from being used</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Gracefully terminate the active use of the public methods of this</div><div class="line">     * component.  This method should be the last one called on a given</div><div class="line">     * instance of this component.  It should also send a LifecycleEvent</div><div class="line">     * of type STOP_EVENT to any registered listeners.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</div><div class="line">     *  that needs to be reported</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>é™¤äº†å®šä¹‰ä¸¤ä¸ªåŠ¨ä½œ<code>start</code>å’Œ<code>stop</code>å¤–ï¼Œè¿˜å®šä¹‰äº†ä¸€ç³»åˆ—å¸¸é‡ã€‚å½“ç„¶è¿˜æœ‰å¯¹ç›‘å¬å™¨çš„æ“ä½œï¼šæ·»åŠ ã€æŸ¥æ‰¾å’Œç§»é™¤ã€‚ç›‘å¬å™¨å¯ä»¥è¯´æ˜¯è§‚å¯Ÿè€…æ¨¡å¼ä¸­çš„è®¢é˜…è€…ï¼Œå®ƒå‘æ„Ÿå…´è¶£çš„äº‹ä»¶æ³¨å†Œï¼Œç­‰äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™å®ƒè·å¾—é€šçŸ¥ã€‚è¿™ä¸ªæ¨¡å‹åœ¨Tomcatä¸­å¯ä»¥è¿™æ ·è§£é‡Šï¼šæŸä¸ªç›‘å¬å™¨å¯¹<code>start</code>äº‹ä»¶æ„Ÿå…´è¶£ï¼Œå› æ­¤å¯¹æŸä¸ªç”Ÿå‘½å‘¨æœŸç»„ä»¶æ³¨å†Œäº†ï¼Œå½“<code>start</code>äº‹ä»¶å‘ç”Ÿäº†ï¼Œè¿™ä¸ªç›‘å¬å™¨è·å¾—é€šçŸ¥ï¼Œå“åº”çš„ä»£ç è¢«æ‰§è¡Œã€‚å¯èƒ½ç”¨è¯­è¨€ä¸å¥½è§£é‡Šæ¸…æ¥šï¼Œçœ‹ä»£ç æ˜¯æœ€å¥½ç†è§£çš„äº†ã€‚<br>å•ç‹¬å»çœ‹çœ‹<code>StandardService</code>ä¸­çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•<code>start()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Prepare for the beginning of active use of the public methods of this</div><div class="line">     * component.  This method should be called before any of the public</div><div class="line">     * methods of this component are utilized.  It should also send a</div><div class="line">     * LifecycleEvent of type START_EVENT to any registered listeners.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</div><div class="line">     *  that prevents this component from being used</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// Validate and update our current component state</span></div><div class="line">        <span class="keyword">if</span> (started) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException</div><div class="line">                (sm.getString(<span class="string">"standardService.start.started"</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Notify our interested LifecycleListeners</span></div><div class="line">        lifecycle.fireLifecycleEvent(BEFORE_START_EVENT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        System.out.println</div><div class="line">            (sm.getString(<span class="string">"standardService.start.name"</span>, <span class="keyword">this</span>.name));</div><div class="line">        lifecycle.fireLifecycleEvent(START_EVENT, <span class="keyword">null</span>);</div><div class="line">        started = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Start our defined Container first</span></div><div class="line">        <span class="comment">// è°ƒç”¨å­ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</span></div><div class="line">        <span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (container) &#123;</div><div class="line">                <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Lifecycle) &#123;</div><div class="line">                    ((Lifecycle) container).start();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Start our defined Connectors second</span></div><div class="line">        <span class="keyword">synchronized</span> (connectors) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; connectors.length; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (connectors[i] <span class="keyword">instanceof</span> Lifecycle)</div><div class="line">                    ((Lifecycle) connectors[i]).start();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Notify our interested LifecycleListeners</span></div><div class="line">        lifecycle.fireLifecycleEvent(AFTER_START_EVENT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>æˆ‘æƒ³è¿™æ®µä»£ç ä¸­æœ€æƒ¹äººæ³¨æ„çš„åœ°æ–¹è‚¯å®šæ˜¯<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">lifecycle.fireLifecycleEvent(BEFORE_START_EVENT, <span class="keyword">null</span>);</div><div class="line">lifecycle.fireLifecycleEvent(START_EVENT, <span class="keyword">null</span>);</div><div class="line">lifecycle.fireLifecycleEvent(AFTER_START_EVENT, <span class="keyword">null</span>);</div></pre></td></tr></table></figure></p>
<p>æˆ‘è§‰å¾—å…¶ä»–çš„éƒ½å¯ä»¥å¿½ç•¥ï¼Œä»…ä»…å…³å¿ƒè¿™ä¸‰è¡Œå°±å¤Ÿäº†ã€‚æ­£å¦‚<code>Lifecycle</code>æ¥å£ä¸­å¸¸é‡æè¿°çš„ä¸€æ ·ï¼Œ<code>start</code>å¯¹åº”å¼€å§‹å‰ï¼Œå¼€å§‹å’Œå¼€å§‹åä¸‰ä¸ªçŠ¶æ€ã€‚å› æ­¤åœ¨è°ƒç”¨<code>start</code>çš„æ—¶å€™å°†è¿™ä¸ªä¸‰ä¸ªäº‹ä»¶é¡ºåºè§¦å‘ï¼Œé‚£ä¹ˆè°å»æ¥æ”¶è¿™å‡ ä¸ªäº‹ä»¶å‘¢ï¼Ÿè¿™å°±å¾—é—®é—®æˆ‘ä»¬ä¹‹å‰è¯´çš„ç›‘å¬å™¨äº†ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç»†èŠ‚å€¼å¾—æ³¨æ„ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> LifecycleSupport lifecycle = <span class="keyword">new</span> LifecycleSupport(<span class="keyword">this</span>);</div></pre></td></tr></table></figure></p>
<p>è¿™ä¹Ÿæ˜¯ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„ç›´æ¥è°ƒç”¨è€…ã€‚ç”±æ­¤å¼•å‡ºä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ç›´æ¥å®ç°äº†<code>Lifecycle</code>æ¥å£ä¸å°±å®Œäº†ï¼Œé‡Œé¢çš„æ–¹æ³•è‡ªå·±å®ç°å°±è¡Œäº†ï¼Œå¹²å˜›è¿˜å¾—å¼•å…¥è¿™ä¸ªä¸œè¥¿å†å»è°ƒç”¨ä¸€æ¬¡ï¼Ÿè¿™ä¸ªå°±ä½“ç°ä¸€ç§è®¾è®¡æ€æƒ³ï¼šè®¾æƒ³ä¸€ä¸‹ï¼ŒåŠ å…¥æ¯ä¸ªç»„ä»¶éƒ½è‡ªå·±å»å®ç°ä¸€æ¬¡ï¼Œä½†æ˜¯å¾ˆå¤šä»£ç éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œè¿™æ ·å°±é€ æˆäº†å¾ˆå¤šå†—ä½™ä»£ç ï¼Œç»´æŠ¤èµ·æ¥å¾ˆè¦å‘½ã€‚ä¸ä¿¡å¯ä»¥çœ‹çœ‹è¿™ä¸ª<code>LifecycleSupport</code>å…·ä½“å®ç°ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleSupport</span> </span>&#123;</div><div class="line">    <span class="comment">// ----------------------------------------------------------- Constructors</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Construct a new LifecycleSupport object associated with the specified</div><div class="line">     * Lifecycle component.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> lifecycle The Lifecycle component that will be the source</div><div class="line">     *  of events that we fire</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LifecycleSupport</span><span class="params">(Lifecycle lifecycle)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        <span class="keyword">this</span>.lifecycle = lifecycle;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ----------------------------------------------------- Instance Variables</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The source component for lifecycle events that we will fire.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Lifecycle lifecycle = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The set of registered LifecycleListeners for event notifications.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> LifecycleListener listeners[] = <span class="keyword">new</span> LifecycleListener[<span class="number">0</span>];</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// --------------------------------------------------------- Public Methods</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Add a lifecycle event listener to this component.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> listener The listener to add</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</div><div class="line"></div><div class="line">      <span class="keyword">synchronized</span> (listeners) &#123;</div><div class="line">          LifecycleListener results[] =</div><div class="line">            <span class="keyword">new</span> LifecycleListener[listeners.length + <span class="number">1</span>];</div><div class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; listeners.length; i++)</div><div class="line">              results[i] = listeners[i];</div><div class="line">          results[listeners.length] = listener;</div><div class="line">          listeners = results;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Get the lifecycle listeners associated with this lifecycle. If this </div><div class="line">     * Lifecycle has no listeners registered, a zero-length array is returned.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> LifecycleListener[] findLifecycleListeners() &#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> listeners;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Notify all lifecycle event listeners that a particular event has</div><div class="line">     * occurred for this Container.  The default implementation performs</div><div class="line">     * this notification synchronously using the calling thread.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> type Event type</div><div class="line">     * <span class="doctag">@param</span> data Event data</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireLifecycleEvent</span><span class="params">(String type, Object data)</span> </span>&#123;</div><div class="line"></div><div class="line">        LifecycleEvent event = <span class="keyword">new</span> LifecycleEvent(lifecycle, type, data);</div><div class="line">        LifecycleListener interested[] = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">synchronized</span> (listeners) &#123;</div><div class="line">            interested = (LifecycleListener[]) listeners.clone();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interested.length; i++)</div><div class="line">            interested[i].lifecycleEvent(event);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Remove a lifecycle event listener from this component.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> listener The listener to remove</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span> (listeners) &#123;</div><div class="line">            <span class="keyword">int</span> n = -<span class="number">1</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (listeners[i] == listener) &#123;</div><div class="line">                    n = i;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (n &lt; <span class="number">0</span>)</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            LifecycleListener results[] =</div><div class="line">              <span class="keyword">new</span> LifecycleListener[listeners.length - <span class="number">1</span>];</div><div class="line">            <span class="keyword">int</span> j = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (i != n)</div><div class="line">                    results[j++] = listeners[i];</div><div class="line">            &#125;</div><div class="line">            listeners = results;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¹Ÿå°±æ˜¯å¯¹<code>Lifecycle</code>çš„éƒ¨åˆ†æ–¹æ³•çš„å®ç°ï¼Œè¿™äº›æ–¹æ³•ä¸€èˆ¬æ˜¯ä¸ä¼šå˜åŒ–çš„ï¼Œå› æ­¤å•ç‹¬æŠ½ç¦»å‡ºæ¥ï¼Œå‡å¦‚ä»¥åæƒ³æ”¹åŠ¨ä¹Ÿä»…ä»…å¯¹è¿™ä¸ªç±»å»æ”¹ï¼Œè€Œä¸æ˜¯é’ˆå¯¹æ¯ä¸ªç”Ÿå‘½å‘¨æœŸç»„ä»¶å»æ”¹ã€‚</p>
<p>æˆ‘è§‰å¾—æœ‰ä¸ªåœ°æ–¹å¾ˆå€¼å¾—å€Ÿé‰´ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</div><div class="line">      <span class="keyword">synchronized</span> (listeners) &#123;</div><div class="line">          LifecycleListener results[] =</div><div class="line">            <span class="keyword">new</span> LifecycleListener[listeners.length + <span class="number">1</span>];</div><div class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; listeners.length; i++)</div><div class="line">              results[i] = listeners[i];</div><div class="line">          results[listeners.length] = listener;</div><div class="line">          listeners = results;</div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å‡å¦‚æ˜¯æˆ‘å»å†™è¿™ä¸ªæ¥å£æˆ‘é¦–å…ˆä¸ä¼šæƒ³åˆ°ç”¨æ•°ç»„å»è£…<code>listeners</code>ï¼Œæˆ‘å¯èƒ½ä¼šä½¿ç”¨ä¸€ä¸ª<code>list</code>å»å­˜ï¼Œè¿™æ ·è¿›è¡Œæ·»åŠ çš„æ—¶å€™ä¸ä¼šæœ‰è¿™ä¹ˆå¤æ‚çš„æ“ä½œã€‚ä½†æ˜¯è¿™é‡Œä½¿ç”¨çš„æ˜¯æ•°ç»„æ¥å¤„ç†ï¼Œå´è¾¾åˆ°äº†åŒæ ·çš„æ•ˆæœã€‚ä¸å¾—ä¸ä½©æœåº•å±‚ä»£ç å¯¹è¿™äº›ç»†èŠ‚çš„è€ƒè™‘ã€‚</p>
<p>ç»§ç»­æ¥ç€é‚£ä¸‰è¡Œä»£ç ï¼Œçœ‹çœ‹å…·ä½“å®ç°ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireLifecycleEvent</span><span class="params">(String type, Object data)</span> </span>&#123;</div><div class="line"></div><div class="line">        LifecycleEvent event = <span class="keyword">new</span> LifecycleEvent(lifecycle, type, data);</div><div class="line">        LifecycleListener interested[] = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">synchronized</span> (listeners) &#123;</div><div class="line">            interested = (LifecycleListener[]) listeners.clone();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interested.length; i++)</div><div class="line">            interested[i].lifecycleEvent(event);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>ä¸€çœ¼å¾€å»ï¼Œæ— éå°±æ˜¯è§¦å‘ç›‘å¬å™¨æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œè€Œä¸”æ˜¯æŒ¨ä¸ªæ¥ã€‚è¿™é‡Œæœ‰ä¸€ä¸ª<code>LifecycleEvent</code>ç±»ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleEvent</span></span></div><div class="line">    <span class="keyword">extends</span> <span class="title">EventObject</span> &#123;</div><div class="line">    <span class="comment">// ----------------------------------------------------------- Constructors</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Construct a new LifecycleEvent with the specified parameters.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> lifecycle Component on which this event occurred</div><div class="line">     * <span class="doctag">@param</span> type Event type (required)</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LifecycleEvent</span><span class="params">(Lifecycle lifecycle, String type)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">this</span>(lifecycle, type, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Construct a new LifecycleEvent with the specified parameters.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> lifecycle Component on which this event occurred</div><div class="line">     * <span class="doctag">@param</span> type Event type (required)</div><div class="line">     * <span class="doctag">@param</span> data Event data (if any)</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LifecycleEvent</span><span class="params">(Lifecycle lifecycle, String type, Object data)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>(lifecycle);</div><div class="line">        <span class="keyword">this</span>.lifecycle = lifecycle;</div><div class="line">        <span class="keyword">this</span>.type = type;</div><div class="line">        <span class="keyword">this</span>.data = data;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ----------------------------------------------------- Instance Variables</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The event data associated with this event.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Object data = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The Lifecycle on which this event occurred.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Lifecycle lifecycle = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The event type this instance represents.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String type = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ------------------------------------------------------------- Properties</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Return the event data of this event.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getData</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.data);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Return the Lifecycle on which this event occurred.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.lifecycle);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Return the event type of this event.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.type);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªç±»ç»§æ‰¿äº†JDKä¸­çš„<code>EventObject</code>ï¼Œä¸ç”¨å»ç®¡å®ƒã€‚ä»æ„é€ å™¨ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªå‚æ•°ï¼šç”Ÿå‘½å‘¨æœŸå¯¹è±¡ï¼Œç±»å‹ä»¥åŠæ•°æ®ã€‚æœ‰äº†è¿™å‡ ä¸ªå±æ€§ï¼Œè¿™ä¸ªç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¯¹è±¡å¯ä»¥æ”¾å¿ƒå»ç©äº†ã€‚å…·ä½“æ€ä¹ˆå»ç©å‘¢ï¼Œå’Œè°ä¸€èµ·ç©å‘¢ï¼Ÿè¿™ä¸ªå¾—é—®é—®ç›‘å¬å™¨äº†ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LifecycleListener</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Acknowledge the occurrence of the specified event.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> event LifecycleEvent that has occurred</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨<code>fireLifecycleEvent(String type, Object data)</code>æ–¹æ³•ä¸­æœ‰è¿™ä¹ˆä¸ªè°ƒç”¨ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">LifecycleListener interested[] = <span class="keyword">null</span>;</div><div class="line">...</div><div class="line">interested[i].lifecycleEvent(event);</div></pre></td></tr></table></figure></p>
<p>äº‹ä»¶ä¼ ç»™ç›‘å¬å™¨äº†ï¼<br>ç›‘å¬å™¨æ‹¿åˆ°ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œç”±äºäº‹ä»¶ä¸­çš„æ•°æ®å…¨éƒ½æœ‰ï¼šå½“å‰ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ã€ç”Ÿå‘½å‘¨æœŸç±»å‹åŠæºå¸¦çš„æ•°æ®ï¼Œå› æ­¤ç›‘å¬å™¨å¯ä»¥æƒ³æ€ä¹ˆç©å°±æ€ä¹ˆç©ã€‚æ¼”ç¤ºä¸€ä¸‹æ€ä¹ˆç©ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleContextConfig</span> <span class="keyword">implements</span> <span class="title">LifecycleListener</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (Lifecycle.START_EVENT.equals(event.getType())) &#123;</div><div class="line">    	System.out.println(<span class="string">"==============START_EVENT================="</span>);</div><div class="line">      Context context = (Context) event.getLifecycle();</div><div class="line">      context.setConfigured(<span class="keyword">true</span>);</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (Lifecycle.BEFORE_START_EVENT.equals(event.getType())) &#123;</div><div class="line">    	System.out.println(<span class="string">"==============BEFORE_START_EVENT================="</span>);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(Lifecycle.BEFORE_STOP_EVENT.equals(event.getType())) &#123;</div><div class="line">    	System.out.println(<span class="string">"==============BEFORE_STOP_EVENT=================="</span>);</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(Lifecycle.STOP_EVENT.equals(event.getType())) &#123;</div><div class="line">    	System.out.println(<span class="string">"==============STOP_EVENT=================="</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥è¯´æ˜¯ç®€å•åˆ°æ— èŠã€‚<br>å¿˜äº†ä¸€ç‚¹ï¼Œäº‹ä»¶ç›‘å¬å¾—æ³¨å†Œä¸Šå»ï¼Œä¸ç„¶äº‹ä»¶å‘ç”Ÿäº†æ²¡æ³•å“åº”ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LifecycleListener listener = <span class="keyword">new</span> ContextConfig();</div><div class="line">((Lifecycle) context).addLifecycleListener(listener);</div></pre></td></tr></table></figure></p>
<p>å¤šæ·»åŠ å‡ ä¸ªä¹Ÿæ— å¦¨ï¼Œåªè¦ä½ æƒ³ã€‚<br>Tomcatä¸­ç»™æˆ‘å°è±¡æœ€æ·±åˆ»çš„ä¹Ÿå°±æ˜¯Lifecycleè§‚å¯Ÿè€…æ¨¡å¼ã€‚ç›¸æ¯”å»æ‰¾ä¸€äº›è®¾è®¡æ¨¡å¼çš„æ —å­å»å­¦ä¹ ï¼Œæˆ‘è§‰å¾—é˜…è¯»ä¼˜ç§€çš„æºç è¦ç†è§£åœ°æ›´é€å½»ä¸€äº›ã€‚é™¤äº†è§‚å¯Ÿè€…æ¨¡å¼è¿˜æœ‰å…¶ä»–çš„è®¾è®¡æ€æƒ³ä¹Ÿå€¼å¾—å­¦ä¹ ï¼Œæ…¢æ…¢æ€»ç»“ï¼Œä¸æ–­æ›´æ–°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™æœ¬ä¹¦çœ‹äº†è¿™ä¹ˆä¹…ï¼Œå·®ä¸å¤šå¯ä»¥ç®—æ˜¯çœ‹å®Œäº†ã€‚å‡†ç¡®æ¥è®²æ˜¯è¿˜å‰©ä¸¤ä¸ªç« èŠ‚æ²¡æœ‰è¯»å®Œã€‚æœ€åé‚£ä¸¤ä¸ªç« èŠ‚çš„çš„ç¡®ç¡®æ˜¯å¾ˆä¸å¾—åŠ²ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯è‡ªå·±å¼€å§‹æµ®èºèµ·æ¥äº†ã€‚æˆ‘çœ‹çš„æ˜¯ä¸­æ–‡ç¿»è¯‘çš„ï¼Œå¯æ°”çš„æ˜¯ä¸­æ–‡ç¿»è¯‘å¾ˆå¤šé”™åˆ«å­—ä¸è¯´ï¼Œå±…ç„¶æœ‰äº›åœ°æ–¹æ ¹æœ¬å°±æ²¡æœ‰ç¿»è¯‘åˆ°ï¼Œâ€œç¼ºæ–¤å°‘ä¸¤â€å¾ˆå¯æ°”ã€‚ç„¶ååˆæ‰¾åŸç‰ˆå¯¹ç…§ç€çœ‹ï¼Œé¿å…è¢«â€œè¯¯å…¥æ­§é€”â€ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Tomcat ç¬”è®°" scheme="http://www.wei-dong.top/categories/Tomcat-%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Tomcat" scheme="http://www.wei-dong.top/tags/Tomcat/"/>
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="http://www.wei-dong.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>Securing Web Applications with Apache Shiro[è¯‘]</title>
    <link href="http://www.wei-dong.top/2017/10/26/Securing%20Web%20Applications%20with%20Apache%20Shiro%5B%E8%AF%91%5D/"/>
    <id>http://www.wei-dong.top/2017/10/26/Securing Web Applications with Apache Shiro[è¯‘]/</id>
    <published>2017-10-26T12:41:23.000Z</published>
    <updated>2017-10-26T12:49:08.000Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« æ˜¯ä»‹ç»ä½¿ç”¨Shiroä¸€æ­¥ä¸€æ­¥ä¿æŠ¤ä½ çš„webåº”ç”¨çš„æ•™ç¨‹ã€‚å®ƒåŒ…å«äº†Shiroçš„çŸ¥è¯†ï¼Œä»¥åŠå’Œæœ€è¿‘ä¸¤ç¯‡æ–‡ç« å¾ˆç›¸ä¼¼ï¼š</p>
<ul>
<li><a href="https://www.infoq.com/articles/apache-shiro" target="_blank" rel="external">Application Security with Apache Shiro</a></li>
<li><a href="http://shiro.apache.org/10-minute-tutorial.html" target="_blank" rel="external">Apache Shiro 10 Minute Tutorial</a><br>è¿™ä¸ªå…¥é—¨æ•™ç¨‹ä¼šèŠ±è´¹å¤§çº¦45åˆ†é’Ÿåˆ°ä¸€ä¸ªå°æ—¶ã€‚å½“ä½ è¯»å®Œåï¼Œä½ å°±ä¼šçŸ¥é“Shiroåœ¨webåº”ç”¨ä¸­æ€ä¹ˆå·¥ä½œäº†çš„ã€‚<a id="more"></a>
<h3 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h3></li>
<li>æ¦‚æ‹¬</li>
<li>è®¾ç½®</li>
<li>ç¬¬ä¸€æ­¥ï¼šå¼€å¯Shiro</li>
<li>ç¬¬äºŒæ­¥ï¼šè¿æ¥åˆ°ç”¨æˆ·å­˜å‚¨</li>
<li>ç¬¬ä¸‰æ­¥ï¼šå¼€å¯ç™»å½•å’Œç™»å‡º</li>
<li>ç¬¬å››æ­¥ï¼šæ”¹å˜ç”¨æˆ·æŒ‡å®šUI</li>
<li>ç¬¬äº”æ­¥ï¼šä»…ä»…å…è®¸è®¤è¯ç”¨æˆ·è®¿é—®</li>
<li>ç¬¬å…­æ­¥ï¼šåŸºäºè§’è‰²è®¿é—®æ§åˆ¶</li>
<li>ç¬¬ä¸ƒæ­¥ï¼šåŸºäºæƒé™è®¿é—®æ§åˆ¶</li>
</ul>
<h3 id="æ¦‚æ‹¬"><a href="#æ¦‚æ‹¬" class="headerlink" title="æ¦‚æ‹¬"></a>æ¦‚æ‹¬</h3><p>è™½ç„¶Shiroè®¾è®¡çš„æ ¸å¿ƒç›®æ ‡å¯ä»¥ç”¨äºä¿æŠ¤ä»»ä½•åŸºäºJVMçš„åº”ç”¨ï¼Œä¾‹å¦‚å‘½ä»¤è¡Œåº”ç”¨ï¼Œåå°æœåŠ¡ï¼Œç½‘é¡µåº”ç”¨ç­‰ã€‚è¿™ç¯‡æ–‡ç« ä¸“æ³¨æœ€å¸¸è§çš„åº”ç”¨ï¼šä¿æŠ¤è·‘åœ¨Servletå®¹å™¨ä¸Šçš„webåº”ç”¨ï¼Œä¾‹å¦‚Tomcaæˆ–è€…Jettyã€‚</p>
<h4 id="å…ˆå†³æ¡ä»¶"><a href="#å…ˆå†³æ¡ä»¶" class="headerlink" title="å…ˆå†³æ¡ä»¶"></a>å…ˆå†³æ¡ä»¶</h4><p>ä¸‹é¢çš„å·¥å…·æ˜¯è¦å®‰è£…åˆ°ä½ æœ¬åœ°å¼€å‘æœºå™¨ä¸Šçš„ï¼Œä»¥ä¾¿éµå¾ªæœ¬æ•™ç¨‹ã€‚</p>
<ul>
<li>Git (tested w/ 1.7)</li>
<li>Java SDK 7</li>
<li>Maven 3</li>
<li>ä½ è‡ªå·±å–œæ¬¢çš„ç¼–è¾‘å™¨ï¼ŒIDEAæˆ–è€…Eclipseéƒ½è¡Œï¼Œç”šè‡³æ–‡æœ¬ç¼–è¾‘å™¨ä¹Ÿè¡Œã€‚</li>
</ul>
<h4 id="æ•™ç¨‹æ ¼å¼"><a href="#æ•™ç¨‹æ ¼å¼" class="headerlink" title="æ•™ç¨‹æ ¼å¼"></a>æ•™ç¨‹æ ¼å¼</h4><p>è¿™æ˜¯ä¸€æ­¥æ¥ç€ä¸€æ­¥çš„æ•™ç¨‹ã€‚è¯¥æ•™ç¨‹å’Œæ‰€æœ‰æ­¥éª¤éƒ½åœ¨GITä»“åº“ä¸­å­˜ç€ã€‚å½“ä½ clone gitä»“åº“ï¼Œmasteråˆ†æ”¯å°±æ˜¯ä½ çš„èµ·ç‚¹ã€‚åœ¨è¿™ä¸ªæ•™ç¨‹ä¸­çš„æ¯ä¸ªæ­¥éª¤éƒ½æ˜¯å•ç‹¬çš„åˆ†æ”¯ã€‚ä½ å¯ä»¥é€šè¿‡æ£€å‡ºä½ æ­£åœ¨çœ‹çš„æ•™ç¨‹æ­¥éª¤çš„gitåˆ†æ”¯æ¥è¯»è¿™ä¸ªæ•™ç¨‹ï¼ˆå°±æ˜¯è¾¹çœ‹ä»£ç è¾¹è¯»è¿™ä¸ªæ•™ç¨‹çš„æ„æ€ï¼‰ã€‚</p>
<h4 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h4><p>æˆ‘ä»¬å°†æ„å»ºçš„Webåº”ç”¨ç¨‹åºæ˜¯ä¸€ä¸ªè¶…çº§webappï¼Œå¯ä»¥ä½œä¸ºä½ è‡ªå·±çš„åº”ç”¨ç¨‹åºçš„èµ·ç‚¹ã€‚å®ƒå°†æ¼”ç¤ºç”¨æˆ·ç™»å½•ï¼Œæ³¨é”€ï¼Œç”¨æˆ·ç‰¹å®šçš„æ¬¢è¿æ¶ˆæ¯ï¼Œå¯¹Webåº”ç”¨ç¨‹åºçš„æŸäº›éƒ¨åˆ†çš„è®¿é—®æ§åˆ¶ä»¥åŠä¸å¯æ’æ‹”å®‰å…¨æ•°æ®å­˜å‚¨çš„é›†æˆã€‚</p>
<p>æˆ‘ä»¬å°†é¦–å…ˆè®¾ç½®é¡¹ç›®ï¼ŒåŒ…æ‹¬æ„å»ºå·¥å…·å’Œå£°æ˜ä¾èµ–å…³ç³»ï¼Œä»¥åŠé…ç½®servlet web.xmlæ–‡ä»¶ä»¥å¯åŠ¨Webåº”ç”¨ç¨‹åºå’ŒShiroç¯å¢ƒã€‚</p>
<p>å®Œæˆè®¾ç½®åï¼Œæˆ‘ä»¬å°†åˆ†å±‚å•ç‹¬çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä¸å®‰å…¨æ•°æ®å­˜å‚¨é›†æˆï¼Œç„¶åå¯ç”¨ç”¨æˆ·ç™»å½•ï¼Œæ³¨é”€å’Œè®¿é—®æ§åˆ¶ã€‚</p>
<h3 id="è®¾ç½®"><a href="#è®¾ç½®" class="headerlink" title="è®¾ç½®"></a>è®¾ç½®</h3><p>æˆ‘ä»¬å·²ç»åœ¨gitä»“åº“ä¸­è®¾ç½®å®Œæˆäº†ï¼Œå› æ­¤ä½ ä¸å¿…æ‰‹åŠ¨å»è®¾ç½®ç›®å½•ç»“æ„åˆå§‹åŒ–æ–‡ä»¶ç­‰ã€‚</p>
<h4 id="1-Fork-the-tutorial-project"><a href="#1-Fork-the-tutorial-project" class="headerlink" title="1. Fork the tutorial project"></a>1. Fork the tutorial project</h4><p>åœ¨githubä¸­è®¿é—®<a href="https://github.com/lhazlewood/apache-shiro-tutorial-webapp" target="_blank" rel="external">è¿™ä¸ª</a>ï¼Œç‚¹å‡»<code>fork</code>æŒ‰é’®ã€‚</p>
<h4 id="2-Clone-your-tutorial-repository"><a href="#2-Clone-your-tutorial-repository" class="headerlink" title="2. Clone your tutorial repository"></a>2. Clone your tutorial repository</h4><p>ç°åœ¨ä½ æŠŠé‚£ä¸ªä»“åº“forkåˆ°ä½ è‡ªå·±çš„è´¦å·ä¸­å»äº†ï¼Œcloneåˆ°ä½ è‡ªå·±çš„æœºå™¨ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">clone</span> git@github.com:<span class="variable">$YOUR_GITHUB_USERNAME</span>/apache-shiro-tutorial-webapp.git</div></pre></td></tr></table></figure></p>
<h4 id="3-Review-project-structure"><a href="#3-Review-project-structure" class="headerlink" title="3. Review project structure"></a>3. Review project structure</h4><p>å®Œæˆcloneåï¼Œä½ å½“å‰çš„<code>master</code>åˆ†æ”¯å°†æœ‰ä¸‹é¢çš„ç»“æ„ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">apache-shiro-tutorial-webapp/</div><div class="line">     |-- src/</div><div class="line">     |  |-- main/</div><div class="line">     |    |-- resources/</div><div class="line">     |      |-- logback.xml</div><div class="line">     |    |-- webapp/</div><div class="line">     |      |-- WEB-INF/</div><div class="line">     |        |-- web.xml</div><div class="line">     |      |-- home.jsp</div><div class="line">     |      |-- include.jsp</div><div class="line">     |      |-- index.jsp</div><div class="line">     |-- .gitignore</div><div class="line">     |-- .travis.yml</div><div class="line">     |-- LICENSE</div><div class="line">     |-- README.md</div><div class="line">     |-- pom.xml</div></pre></td></tr></table></figure></p>
<p>è¿™äº›æ˜¯æ¯ä¸ªæ–‡ä»¶è¡¨ç¤ºçš„å«ä¹‰ï¼š</p>
<ul>
<li>pom.xml ä¸è§£é‡Š</li>
<li>README.md æè¿°æ–‡ä»¶</li>
<li>LICENSE è¯ä¹¦</li>
<li>.travis.yml CIçš„é…ç½®æ–‡ä»¶ï¼Œå‡å¦‚ä½ æƒ³æŒç»­é›†æˆ</li>
<li>.gitignore å¿½ç•¥æ–‡ä»¶ï¼ŒåŒ…å«åç¼€ã€‚ä½ ä¸æƒ³åŠ å…¥ç‰ˆæœ¬æ§åˆ¶çš„éƒ½èƒ½å†™è¿™é‡Œ</li>
<li>src/main/resources/logback.xml ç®€å•çš„Logbacké…ç½®æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©SELF4Jä½œä¸ºæ—¥å¿—APIï¼ŒLogbackä½œä¸ºå®ç°ã€‚è¿™ä¸ªæ¯”Log4Jå’ŒJULç®€å•ã€‚</li>
<li>src/main/webapp/WEB-INF/web.xml webé…ç½®æ–‡ä»¶</li>
<li>src/main/webapp/include.jsp  å…¬ç”¨çš„JSPæ–‡ä»¶ï¼Œç”¨äºå¯¼å…¥å’Œå£°æ˜ã€‚æ–¹ä¾¿åœ¨ä¸€ä¸ªåœ°æ–¹ç®¡ç†ã€‚</li>
<li>src/main/webapp/home.jsp é»˜è®¤çš„homepage</li>
<li>src/main/webapp/index.jsp é»˜è®¤ä¸»é¡µï¼Œä»…ä»…æ˜¯å°†è¯·æ±‚æŒ‡å‘home.jsp</li>
</ul>
<h4 id="4-Run-the-webapp"><a href="#4-Run-the-webapp" class="headerlink" title="4. Run the webapp"></a>4. Run the webapp</h4><p>ç°åœ¨ä½ å°†å·¥ç¨‹å…‹éš†åˆ°æœ¬åœ°äº†ï¼Œä½ å¯ä»¥é€šè¿‡ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤æ¥è·‘è¿™ä¸ªwebåº”ç”¨ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mvn jetty:run</div></pre></td></tr></table></figure></p>
<p>ç„¶åæ‰“å¼€ä½ çš„æµè§ˆå™¨ï¼Œè¾“å…¥ localhost:8080 ä½ å¯ä»¥çœ‹åˆ°ä¸»é¡µæ˜¾ç¤ºçš„Helloï¼ŒWorldï¼æŒ‰ctl-cåœæ­¢webã€‚</p>
<h3 id="Step-1-Enable-Shiro"><a href="#Step-1-Enable-Shiro" class="headerlink" title="Step 1: Enable Shiro"></a>Step 1: Enable Shiro</h3><p>æˆ‘ä»¬åˆå§‹åŒ–ä»“åº“masteråˆ†æ”¯ä»…ä»…æ˜¯ä¸€ä¸ªç®€å•é€šç”¨çš„å¯ç”¨äºä»»ä½•åº”ç”¨çš„æ¨¡æ¿çš„webåº”ç”¨ã€‚Letâ€™s add the bare minimum to enable Shiro in the web app next(è¿™å¥è¯ä¸çŸ¥é“æ€ä¹ˆç¿»è¯‘)ã€‚</p>
<p>æ‰§è¡Œä¸‹é¢çš„gitæ£€å‡ºå‘½ä»¤åŠ è½½step1çš„åˆ†æ”¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step1</div></pre></td></tr></table></figure></p>
<p>æ£€å‡ºåä½ ä¼šå‘ç°ä¸¤ä¸ªå˜åŒ–ï¼š</p>
<ol>
<li>å¤šäº†<code>src/main/webapp/WEB-INF/shiro.ini</code>è¿™ä¸ªæ–‡ä»¶</li>
<li><code>src/main/webapp/WEB-INF/web.xml</code>è¢«æ”¹äº†</li>
</ol>
<h4 id="æ·»åŠ shiro-iniæ–‡ä»¶"><a href="#æ·»åŠ shiro-iniæ–‡ä»¶" class="headerlink" title="æ·»åŠ shiro.iniæ–‡ä»¶"></a>æ·»åŠ shiro.iniæ–‡ä»¶</h4><p>åœ¨webåº”ç”¨ä¸­æ²¹å¾ˆå¤šç§æ–¹å¼é…ç½®Shiroï¼Œè¿™å–å†³äºä½ ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆwebæ¡†æ¶ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡Springã€Guiceã€Tapestryç­‰é…ç½®Shiroã€‚</p>
<p>ç°åœ¨ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨Shiroé»˜è®¤çš„é…ç½®,<a href="http://shiro.apache.org/configuration.html" target="_blank" rel="external">åŸºäºiniçš„é…ç½®</a>ã€‚</p>
<p>å¦‚æœä½ æ£€å‡ºäº†step1çš„åˆ†æ”¯ï¼Œä½ å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–°çš„é…ç½®æ–‡ä»¶<code>src/main/webapp/WEB-INF/shiro.ini</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[main]</div><div class="line"></div><div class="line"># Let&apos;s use some in-memory caching to reduce the number of runtime lookups against a remote user store.</div><div class="line"># A real application might want to use a more robust caching solution (e.g. ehcache or a</div><div class="line"># distributed cache).  When using such caches, be aware of your cache TTL settings: too high</div><div class="line"># a TTL and the cache won&apos;t reflect any potential changes in Stormpath fast enough.  Too low</div><div class="line"># and the cache could evict too often, reducing performance.</div><div class="line">cacheManager = org.apache.shiro.cache.MemoryConstrainedCacheManager</div><div class="line">securityManager.cacheManager = $cacheManager</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªinié…ç½®æ–‡ä»¶åŒ…å«ä¸€ä¸ª<code>[main]</code>çš„æœ€å°é…ç½®ã€‚</p>
<ul>
<li>å®šä¹‰äº†ä¸€ä¸ª<code>cacheManager</code>å®ä¾‹ã€‚ç¼“å­˜åœ¨Shiroæ¶æ„ä¸­æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„éƒ¨åˆ†ã€‚å®ƒå‡å°‘äº†é‡å¤çš„æ•°æ®äº¤äº’ã€‚è¿™ä¸ªä¾‹å­ä½¿ç”¨<code>MemoryConstrainedCacheManager</code>ï¼Œä»…ä»…å¯¹å•ä¸ªJVMåº”ç”¨å¾ˆæ£’ã€‚å¦‚æœä½ çš„åº”ç”¨éƒ¨ç½²åœ¨å¤šä¸ªä¸»æœºï¼Œä½ æœ€å¥½ä½¿ç”¨é›†ç¾¤çš„CacheManager å®ç°ã€‚</li>
<li>å®ƒåœ¨Shiro securityManagerä¸Šé…ç½®æ–°çš„cacheManagerå®ä¾‹ã€‚Shiro SecurityManagerå®ä¾‹å§‹ç»ˆå­˜åœ¨ï¼Œå› æ­¤ä¸éœ€è¦æ˜ç¡®å®šä¹‰ã€‚</li>
</ul>
<h4 id="åœ¨web-xmlä¸­å¼€å¯Shiro"><a href="#åœ¨web-xmlä¸­å¼€å¯Shiro" class="headerlink" title="åœ¨web.xmlä¸­å¼€å¯Shiro"></a>åœ¨web.xmlä¸­å¼€å¯Shiro</h4><p>è™½ç„¶æˆ‘ä»¬æœ‰shiro.inié…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯æˆ‘ä»¬ç¡®å®éœ€è¦æŠŠå®ƒåŠ è½½è¿›å»ç„¶åå¼€å¯Shiroç¯å¢ƒè®©webåº”ç”¨èƒ½å¤Ÿä½¿ç”¨å®ƒã€‚</p>
<p>æˆ‘ä»¬åœ¨<code>src/main/webapp/WEB-INF/web.xml</code>é…ç½®æ–‡ä»¶ä¸­æ·»åŠ è¿™äº›ä¸œè¥¿ï¼š<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.apache.shiro.web.env.EnvironmentLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ShiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.shiro.web.servlet.ShiroFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ShiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>REQUEST<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>FORWARD<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>INCLUDE<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>&lt;listener&gt;</code>å£°æ˜å®šä¹‰äº†ä¸€ä¸ª<code>ServletContextListener</code>ç”¨äºåœ¨webç”¨äºå¯åŠ¨çš„æ—¶å€™åˆ›å»ºä¸€ä¸ªShiroç¯å¢ƒã€‚é»˜è®¤è¿™ä¸ªlistenerä¼šå»è‡ªåŠ¨æ‰¾<code>WEB-INF/shiro.ini</code>é…ç½®æ–‡ä»¶ã€‚</li>
<li><code>&lt;filter&gt;</code>å®šä¹‰äº†ä¸€ä¸ªä¸»è¦çš„<code>ShiroFilter</code>ã€‚è¿™ä¸ªè¿‡æ»¤å™¨ä¼šå»è¿‡æ»¤æ‰€æœ‰çš„è¯·æ±‚ï¼Œè¿™æ ·Shiroèƒ½å¤Ÿåœ¨å…è®¸è¯·æ±‚åˆ°è¾¾åº”ç”¨ç¨‹åºä¹‹å‰æ‰§è¡Œå¿…è¦çš„èº«ä»½å’Œè®¿é—®æ§åˆ¶æ“ä½œã€‚</li>
</ul>
<h4 id="è·‘èµ·æ¥"><a href="#è·‘èµ·æ¥" class="headerlink" title="è·‘èµ·æ¥"></a>è·‘èµ·æ¥</h4><p>æ‹‰å»äº†åˆ†æ”¯åï¼Œç»§ç»­è·‘èµ·æ¥ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mvn jetty:run</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªæ—¶å€™ï¼Œä½ ä¼šçœ‹åˆ°ä¸‹é¢ç†Ÿæ‚‰çš„è¾“å‡ºï¼Œè¿™è¡¨ç¤ºShiroç¡®å®åœ¨ä½ çš„webåº”ç”¨ä¸­è·‘èµ·æ¥äº†ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">16:04:19.807 [main] INFO  o.a.shiro.web.env.EnvironmentLoader - Starting Shiro environment initialization.</div><div class="line">16:04:19.904 [main] INFO  o.a.shiro.web.env.EnvironmentLoader - Shiro environment initialized in 95 ms.</div></pre></td></tr></table></figure></p>
<h3 id="Step-2-Connect-to-a-User-Store"><a href="#Step-2-Connect-to-a-User-Store" class="headerlink" title="Step 2: Connect to a User Store"></a>Step 2: Connect to a User Store</h3><p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ£€å‡ºstep2çš„ä»£ç ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step2</div></pre></td></tr></table></figure></p>
<p>ç°åœ¨æˆ‘ä»¬å°†Shiroé›†æˆå¹¶è¿è¡Œåœ¨webappä¸­.ä½†æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰å‘Šè¯‰Shiroè¦åšä»€ä¹ˆäº‹æƒ…ã€‚</p>
<p>åœ¨æˆ‘ä»¬ç™»å½•ï¼Œé€€å‡ºæˆ–æ‰§è¡ŒåŸºäºè§’è‰²æˆ–æƒé™çš„è®¿é—®æ§åˆ¶æˆ–ä»»ä½•å…¶ä»–å®‰å…¨ç›¸å…³ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç”¨æˆ·ï¼</p>
<p>æˆ‘ä»¬éœ€è¦é…ç½®Shiroæ¥è®¿é—®æŸç§ç±»å‹çš„ç”¨æˆ·å­˜å‚¨ï¼Œè¿™æ ·å®ƒå¯ä»¥æŸ¥æ‰¾ç”¨æˆ·åšç™»å½•æ“ä½œæˆ–è€…æ£€æŸ¥è§’è‰²ç­‰ç­‰ã€‚æœ‰è®¸å¤šç±»å‹çš„ç”¨æˆ·å­˜å‚¨ï¼Œä»»ä½•åº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦è®¿é—®ï¼šä¹Ÿè®¸ä½ å°†ç”¨æˆ·å­˜åœ¨MySqlæ•°æ®åº“ä¸­ï¼Œæˆ–è€…MongoDBï¼Œæˆ–è€…LDAPï¼Œæˆ–è€…Active Directoryï¼Œæˆ–è€…ç®€å•çš„æ–‡ä»¶ä¸­ã€‚</p>
<p>Shiroå°†è¿™å«åš<code>Realm</code>.æ¥è‡ªShiroçš„æ–‡æ¡£ï¼š</p>
<blockquote>
<p>Realms act as the â€˜bridgeâ€™ or â€˜connectorâ€™ between Shiro and your applicationâ€™s security data. When it comes time to actually interact with security-related data like user accounts to perform authentication (login) and authorization (access control), Shiro looks up many of these things from one or more Realms configured for an application.<br>In this sense a Realm is essentially a security-specific DAO: it encapsulates connection details for data sources and makes the associated data available to Shiro as needed. When configuring Shiro, you must specify at least one Realm to use for authentication and/or authorization. The SecurityManager may be configured with multiple Realms, but at least one is required.<br>Shiro provides out-of-the-box Realms to connect to a number of security data sources (aka directories) such as LDAP, relational databases (JDBC), text configuration sources like INI and properties files, and more. You can plug-in your own Realm implementations to represent custom data sources if the default Realms do not meet your needs.</p>
</blockquote>
<p>å› æ­¤æˆ‘ä»¬éœ€è¦é…ç½®ä¸€ä¸ª<code>realm</code>è¿™æ ·æˆ‘ä»¬å°±èƒ½å¤Ÿå¾—åˆ°ç”¨æˆ·äº†ã€‚</p>
<h4 id="Set-up-Stormpath"><a href="#Set-up-Stormpath" class="headerlink" title="Set up Stormpath"></a>Set up Stormpath</h4><p>æœ¬ç€è¶Šç®€å•è¶Šå¥½çš„åŸåˆ™ï¼Œæ²¡æœ‰ä»‹ç»Shiroçš„å¤æ‚æ€§ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæœ€ç®€å•çš„realmçš„å®ç°ï¼šStormpath realmã€‚</p>
<p>Stormpath æ˜¯ä¸€ä¸ªäº‘å¹³å°ä¸Šçš„ç”¨æˆ·ç®¡ç†æœåŠ¡ã€‚å¯¹å¼€å‘è€…å…è´¹ã€‚è¿™æ„å‘³ç€ä½¿ç”¨äº†Stormpathä»¥åï¼Œå¸®ä½ åšäº†åšä»¥ä¸‹çš„äº‹æƒ…ï¼š</p>
<ul>
<li>ä¸€ä¸ªç”¨äºç®¡ç†åº”ç”¨ï¼Œç›®å½•ã€è´¦æˆ·ã€å’Œç»„çš„æ¥å£ã€‚Shiroæ ¹æœ¬ä¸æä¾›è¿™äº›ä¸œè¥¿ï¼Œå› æ­¤å½“ä½ æµè§ˆè¿™ç¯‡æ•™ç¨‹çš„æ—¶å€™èƒ½å¤ŸèŠ‚çº¦æ—¶é—´ï¼Œè¿™æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚</li>
<li>ä¸€ä¸ªä¸ºç”¨æˆ·å­˜å‚¨å¯†ç çš„å®‰å…¨æœºåˆ¶ã€‚ä½ çš„åº”ç”¨ä¸å¿…æ‹…å¿ƒå¯†ç å®‰å…¨ï¼Œå¯†ç æ¯”è¾ƒæˆ–å­˜å‚¨å¯†ç ã€‚è™½ç„¶Shiroèƒ½åšè¿™äº›äº‹æƒ…ï¼Œä½†æ˜¯ä½ æœ‰å¿…è¦å»é…ç½®ä¸€ä¸‹ï¼Œç„¶åæ³¨æ„ä¸€ä¸‹åŠ å¯†çš„æ¦‚å¿µã€‚ Stormpathè‡ªåŠ¨çš„å¯¹å¯†ç è¿›è¡Œä¿æŠ¤ï¼Œå› æ­¤ä½ ä¸å¿…æ‹…å¿ƒè¿™äº›ä¸œè¥¿ã€‚</li>
<li>å®‰å…¨çš„å·¥ä½œæµï¼Œç±»ä¼¼äºé‚®ç®±éªŒè¯å¯†ç é‡ç½®ã€‚Shiroå¯¹æ­¤æ²¡æœ‰ä»»ä½•æ”¯æŒï¼Œå› ä¸ºè¿™æ˜¯åº”ç”¨ç¨‹åºæ¥æŠŠæ§çš„ã€‚</li>
<li>ä¸»æœºæ‰˜ç®¡æ€»æ˜¯åœ¨åŸºç¡€è®¾æ–½ä¸Šçš„ï¼ˆäº‘å¹³å°ï¼‰ï¼Œä½ æ²¡æœ‰å¿…è¦æ¥ç»´æŠ¤è¿™äº›ä¸œè¥¿ã€‚</li>
</ul>
<p>ä¸ºäº†æœ¬æ•™ç¨‹çš„ç›®çš„ï¼ŒStormpathæ¯”è®¾ç½®å•ç‹¬çš„RDBMSæœåŠ¡å™¨è¦ç®€å•å¾—å¤šï¼Œå¹¶ä¸”æ‹…å¿ƒSQLæˆ–å¯†ç åŠ å¯†é—®é¢˜ã€‚</p>
<p>å½“ç„¶ï¼ŒStormpathåªæ˜¯Shiroå¯ä»¥è¿›è¡Œæ²Ÿé€šçš„è®¸å¤šåç«¯æ•°æ®å­˜å‚¨ä¹‹ä¸€ã€‚ ç¨åå°†ä»‹ç»æ›´å¤æ‚çš„æ•°æ®å­˜å‚¨å’Œåº”ç”¨ç¨‹åºç‰¹å®šçš„é…ç½®ã€‚</p>
<h5 id="Sign-up-for-Stormpath"><a href="#Sign-up-for-Stormpath" class="headerlink" title="Sign up for Stormpath"></a>Sign up for Stormpath</h5><p>blablaâ€¦..</p>
<h5 id="Get-a-Stormpath-API-Key"><a href="#Get-a-Stormpath-API-Key" class="headerlink" title="Get a Stormpath API Key"></a>Get a Stormpath API Key</h5><p>Stormpath API Keyå¯¹äºStormpathæ¥è¯´æ˜¯å¿…é¡»çš„ã€‚å¯ä»¥è¿™æ ·è·å–ï¼š</p>
<ol>
<li>ç™»å½•åˆ°Stormpathä¸­ï¼ˆè¿™ä¸ªç½‘ç«™å…³äº†ï¼Œåˆå¹¶åˆ°oktaï¼‰ã€‚</li>
<li>é¡µé¢çš„å³è¾¹ï¼Œè®¿é—®API KEYï¼šManage API KEY</li>
<li><p>åœ¨è´¦å·è¯¦æƒ…é¡µé¢ï¼Œç‚¹å‡»Create API Keyã€‚æ­¤æ—¶ä¼šç”Ÿæˆä½ çš„API keyï¼Œç„¶åä¸‹è½½åˆ°ä½ çš„ç”µè„‘ã€‚å¦‚æœä½ æ‰“å¼€çœ‹çœ‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">apiKey.id = 144JVZINOF5EBNCMG9EXAMPLE</div><div class="line">apiKey.secret = lWxOiKqKPNwJmSldbiSkEbkNjgh2uRSNAb+AEXAMPLE</div></pre></td></tr></table></figure>
</li>
<li><p>ä¿å­˜åˆ°ä¸€ä¸ªå®‰å…¨çš„åœ°æ–¹ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$HOME/.stormpath/apiKey.properties</div></pre></td></tr></table></figure>
</li>
<li><p>å½“ç„¶ä¹Ÿå¯ä»¥æ”¹ä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶çš„æƒé™ã€‚ä¾‹å¦‚åœ¨*nixä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ chmod go-rwx <span class="variable">$HOME</span>/.stormpath/apiKey.properties</div><div class="line">$ chmod u-w <span class="variable">$HOME</span>/.stormpath/apiKey.properties</div></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="Retrieve-the-default-Stormpath-Application"><a href="#Retrieve-the-default-Stormpath-Application" class="headerlink" title="Retrieve the default Stormpath Application"></a>Retrieve the default Stormpath Application</h5><p>å½“ä½ ç™»å½•åˆ°Stormpathï¼Œè‡ªåŠ¨çš„åˆ›å»ºäº†ä¸€ä¸ªç©ºçš„åº”ç”¨ï¼Œåå­—å«åšï¼š<code>My Application</code></p>
<p>æˆ‘ä»¬å¿…é¡»ä½¿ç”¨Strompathæ³¨å†Œæˆ‘ä»¬çš„webåº”ç”¨ï¼Œè¿™æ ·å°±èƒ½ä½¿ç”¨Strompathæ¥ç®¡ç†æˆ‘ä»¬çš„ç”¨æˆ·å’Œå¯¹ç”¨æˆ·æˆæƒã€‚ä¸ºäº†ä½¿ç”¨æˆ‘çš„åº”ç”¨ç¨‹åºStormpathåº”ç”¨ç¨‹åºæ³¨å†Œæˆ‘ä»¬çš„Webåº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€äº›ä¿¡æ¯ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Stormpath APIæ¥æ£€ç´¢è¿™äº›ä¿¡æ¯ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -i --user <span class="variable">$YOUR_API_KEY_ID</span>:<span class="variable">$YOUR_API_KEY_SECRET</span> \</div><div class="line"><span class="string">'https://api.stormpath.com/v1/tenants/current'</span></div></pre></td></tr></table></figure></p>
<p>ä½ èƒ½å¾—åˆ°è¿™äº›è¿”å›ä¿¡æ¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 302 Found</div><div class="line">Date: Fri, 28 Aug 2015 18:34:51 GMT</div><div class="line">Location: https://api.stormpath.com/v1/tenants/sOmELoNgRaNDoMIdHeRe</div><div class="line">Server: Apache</div><div class="line">Set-Cookie: rememberMe=deleteMe; Path=/; Max-Age=0; Expires=Thu, 27-Aug-2015 18:34:52 GMT</div><div class="line">Strict-Transport-Security: max-age=31536000; includeSubDomains; preload</div><div class="line">Content-Length: 0</div><div class="line">Connection: keep-alive</div></pre></td></tr></table></figure></p>
<p>æ³¨æ„åˆ°<code>Location</code>ï¼Œè¿™ä¸ªå°±æ˜¯ä½ çš„Stormpath tenant.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl -u <span class="variable">$API_KEY_ID</span>:<span class="variable">$API_KEY_SECRET</span> \</div><div class="line">     -H <span class="string">"Accept: application/json"</span> \</div><div class="line">     <span class="string">'$TENANT_HREF/applications?name=My%20Application'</span></div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªå›åº”æœ‰å¾ˆå¤šçš„ä¿¡æ¯ã€‚ è¿™æ˜¯ä¸€ä¸ªä»å“åº”ä¸­æ‘˜å½•çš„ä¾‹å­.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    "href": "https://api.stormpath.com/v1/applications/aLoNGrAnDoMAppIdHeRe",</div><div class="line">    "name": "My Application",</div><div class="line">    "description": "This application was automatically created for you in Stormpath for use with our Quickstart guides(https://docs.stormpath.com). It does apply to your subscription's number of reserved applications and can be renamed or reused for your own purposes.",</div><div class="line">    "status": "ENABLED",</div><div class="line">    "tenant": &#123;</div><div class="line">        "href": "https://api.stormpath.com/v1/tenants/sOmELoNgRaNDoMIdHeRe"</div><div class="line">    &#125;,</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»ä¸Šé¢æ³¨æ„ä½ çš„æœ€ä¸Šé¢çš„<code>href</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†åœ¨shiro.inié…ç½®ä¸­ä½¿ç”¨è¿™ä¸ª<code>href</code>ã€‚</p>
<h5 id="Create-an-application-test-user-account"><a href="#Create-an-application-test-user-account" class="headerlink" title="Create an application test user account"></a>Create an application test user account</h5><p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å°†è¦ä¸ºè¯¥åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªç¤ºä¾‹/æµ‹è¯•ç”¨æˆ·ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">curl --request POST --user <span class="variable">$YOUR_API_KEY_ID</span>:<span class="variable">$YOUR_API_KEY_SECRET</span> \</div><div class="line">    -H <span class="string">"Accept: application/json"</span> \</div><div class="line">    -H <span class="string">"Content-Type: application/json"</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'&#123;</span></div><div class="line">           "givenName": "Jean-Luc",</div><div class="line">           "surname": "Picard",</div><div class="line">           "username": "jlpicard",</div><div class="line">           "email": "capt@enterprise.com",</div><div class="line">           "password":"Changeme1"</div><div class="line">        &#125;' \</div><div class="line"> <span class="string">"<span class="variable">$YOUR_APPLICATION_HREF</span>/accounts"</span></div></pre></td></tr></table></figure></p>
<h4 id="Configure-the-Realm-in-shiro-ini"><a href="#Configure-the-Realm-in-shiro-ini" class="headerlink" title="Configure the Realm in shiro.ini"></a>Configure the Realm in shiro.ini</h4><p>æŒ‰ç…§Shiroçš„è¦æ±‚ï¼Œä½ é€‰æ‹©è‡³å°‘ä¸€ä¸ªç”¨æˆ·å­˜å‚¨çš„è¿æ¥ï¼Œæˆ‘ä»¬å°†éœ€è¦é…ç½®ä¸€ä¸ªè¡¨ç¤ºè¯¥æ•°æ®å­˜å‚¨çš„åŸŸï¼Œç„¶åå‘Šè¯‰Shiro SecurityManagerã€‚</p>
<p>å¦‚æœä½ æ£€å‡ºstep2çš„åˆ†æ”¯ï¼Œä½ ä¼šçœ‹åˆ°<code>src/main/webapp/WEB-INF/shiro.ini</code>ä¸­çš„[main]éƒ¨åˆ†ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># Configure a Realm to connect to a user datastore.  In this simple tutorial, we&apos;ll just point to Stormpath since it</div><div class="line"># takes 5 minutes to set up:</div><div class="line">stormpathClient = com.stormpath.shiro.client.ClientFactory</div><div class="line">stormpathClient.cacheManager = $cacheManager</div><div class="line"></div><div class="line"># (Optional) If you put your apiKey.properties in the non-default location, you set the location here</div><div class="line">#stormpathClient.apiKeyFileLocation = $HOME/.stormpath/apiKey.properties</div><div class="line"></div><div class="line">stormpathRealm = com.stormpath.shiro.realm.ApplicationRealm</div><div class="line">stormpathRealm.client = $stormpathClient</div><div class="line"></div><div class="line"># Find this URL in your Stormpath console for an application you create:</div><div class="line"># Applications -&gt; (choose application name) --&gt; Details --&gt; REST URL</div><div class="line"># (Optional) If you only have one Application</div><div class="line">#stormpathRealm.applicationRestUrl = https://api.stormpath.com/v1/applications/$STORMPATH_APPLICATION_ID</div><div class="line"></div><div class="line">stormpathRealm.groupRoleResolver.modeNames = name</div><div class="line">securityManager.realm = $stormpathRealm</div></pre></td></tr></table></figure></p>
<p>æ³¨æ„çœ‹å¯é€‰çš„é‚£è¡Œï¼š</p>
<ul>
<li>å¦‚æœä½ å·²ç»ä½¿ç”¨Stormpathä¸€æ®µæ—¶é—´ï¼Œå¹¶ä¸”ä½ æœ‰æ›´å¤šçš„Stormpathåº”ç”¨ç¨‹åºï¼Œ<code>stormpathRealm.applicationRestUrl</code>è¿™ä¸ªå±æ€§å¿…é¡»è¢«è®¾ç½®ã€‚</li>
</ul>
<h4 id="Run-the-webapp"><a href="#Run-the-webapp" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>åœ¨å®Œæˆä¸Šé¢çš„æ”¹åŠ¨åï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥è·‘ä¸€ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mvn jetty:run</div></pre></td></tr></table></figure></p>
<p>è¿™æ—¶å€™å°±ä¼šçœ‹åˆ°ç†Ÿæ‚‰çš„è¾“å‡ºï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">16:08:25.466 [main] INFO  o.a.shiro.web.env.EnvironmentLoader - Starting Shiro environment initialization.</div><div class="line">16:08:26.201 [main] INFO  o.a.s.c.IniSecurityManagerFactory - Realms have been explicitly set on the SecurityManager instance - auto-setting of realms will not occur.</div><div class="line">16:08:26.201 [main] INFO  o.a.shiro.web.env.EnvironmentLoader - Shiro environment initialized in 731 ms.</div></pre></td></tr></table></figure></p>
<h3 id="Step-3-Enable-Login-and-Logout"><a href="#Step-3-Enable-Login-and-Logout" class="headerlink" title="Step 3: Enable Login and Logout"></a>Step 3: Enable Login and Logout</h3><p>ç°åœ¨æˆ‘ä»¬æœ‰ç”¨æˆ·ï¼Œè€Œä¸”æˆ‘ä»¬èƒ½å¾ˆå®¹æ˜“çš„æ·»åŠ ï¼Œç§»é™¤å’Œç¦ç”¨ä»–ä»¬ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­å¼€å§‹å¯ç”¨ç™»å½•/æ³¨é”€å’Œè®¿é—®æ§åˆ¶ç­‰åŠŸèƒ½ã€‚</p>
<p>æ£€å‡ºstep3çš„åˆ†æ”¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step3</div></pre></td></tr></table></figure></p>
<p>æ·»åŠ äº†2ä¸ªä¸œè¥¿:</p>
<ul>
<li><code>src/main/webapp/login.jsp</code>ä¸­åŠ äº†ä¸€ä¸ªç®€å•çš„ç™»å½•è¡¨å•ï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒç™»å½•ã€‚</li>
<li><code>shiro.ini</code>æ–‡ä»¶å·²æ›´æ–°ï¼Œä»¥æ”¯æŒWebï¼ˆURLï¼‰ç‰¹å®šåŠŸèƒ½ã€‚</li>
</ul>
<h4 id="Enable-Shiro-form-login-and-logout-support"><a href="#Enable-Shiro-form-login-and-logout-support" class="headerlink" title="Enable Shiro form login and logout support"></a>Enable Shiro form login and logout support</h4><p>step3ä¸­<code>src/main/webapp/WEB-INF/shiro.ini</code>æ·»åŠ äº†ä¸‹é¢2ä¸ªä¸œè¥¿ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[main]</div><div class="line"></div><div class="line">shiro.loginUrl = /login.jsp</div><div class="line"></div><div class="line"># Stuff we&apos;ve configured here previously is omitted for brevity</div><div class="line"></div><div class="line">[urls]</div><div class="line">/login.jsp = authc</div><div class="line">/logout = logout</div></pre></td></tr></table></figure></p>
<p>åœ¨[main]è¿™ä¸ªéƒ¨åˆ†å¤šäº†ä¸€è¡Œï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shiro.loginUrl = /login.jsp</div></pre></td></tr></table></figure></p>
<p>è¿™æ˜¯ä¸€ä¸ªå‘Šè¯‰Shiroçš„ç‰¹æ®Šé…ç½®æŒ‡ä»¤:â€å¯¹äºä»»ä½•å…·æœ‰loginUrlå±æ€§çš„Shiroçš„é»˜è®¤è¿‡æ»¤å™¨ï¼Œæˆ‘å¸Œæœ›è¯¥å±æ€§å€¼è®¾ç½®ä¸º/login.jspã€‚â€</p>
<p>è¿™ä¸ªå°±æ˜¯è®©Shiroçš„é»˜è®¤è®¤è¯è¿‡æ»¤å™¨ï¼ˆé»˜è®¤çš„æ˜¯FormAuthenticationFilterï¼‰çŸ¥é“ç™»å½•é¡µé¢æ˜¯å“ªä¸ªã€‚è¿™ä¸ªè®©FormAuthenticationFilteræ­£ç¡®çš„å·¥ä½œæ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚</p>
<p>[urls]éƒ¨åˆ†å…è®¸ä½ ä½¿ç”¨éå¸¸ç®€æ´çš„é”®å€¼å¯¹è¯­æ³•æ¥å‘Šè¯‰Shiroæ€ä¹ˆæ ·å»è¿‡æ»¤ç»™å®šçš„urlè¯·æ±‚ã€‚urlsä¸­çš„æ‰€æœ‰è·¯å¾„éƒ½æ˜¯ç›¸å¯¹äºWebåº”ç”¨ç¨‹åºçš„HttpServletRequest.getContextPath()çš„å€¼.</p>
<p>è¿™äº›é”®å€¼å¯¹æä¾›ä¸€ä¸ªæå…¶å¼ºå¤§çš„æ–¹å¼æ¥è¿‡æ»¤è¯·æ±‚ï¼Œå…è®¸å„ç§å„æ ·çš„å®‰å…¨è§„åˆ™ã€‚URLå’Œè¿‡æ»¤å™¨é“¾çš„æ›´æ·±å…¥çš„è¦†ç›–èŒƒå›´è¶…å‡ºäº†æœ¬æ–‡æ¡£çš„èŒƒå›´ï¼Œä½†å¦‚æœä½ æœ‰å…´è¶£ï¼Œè¯·è¯¦ç»†é˜…è¯»ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/login.jsp = authc</div><div class="line">/logout = logout</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬ä¸€è¡ŒæŒ‡å‡ºä¸è®ºShiroä»€ä¹ˆæ—¶å€™é‡åˆ°è¯·æ±‚<code>/login.jsp</code>çš„urlï¼Œåœ¨è¯·æ±‚ä¸­å¼€å¯authcè¿‡æ»¤å™¨ã€‚</li>
<li>ç¬¬äºŒè¡Œè¡¨ç¤ºä¸è®ºShiroé‡åˆ°<code>/login.jsp</code>çš„urlï¼Œåœ¨è¯·æ±‚ä¸­å¼€å¯logout è¿‡æ»¤å™¨ã€‚</li>
</ul>
<p>è¿™ä¸¤ä¸ªè¿‡æ»¤å™¨éƒ½æœ‰ä¸€ç‚¹ç‰¹æ®Šçš„åœ°æ–¹ï¼Œä»–ä»¬éƒ½ä¸éœ€è¦åœ¨èƒŒåè¿›è¡Œé¢å¤–çš„å¤„ç†ã€‚å®ƒä»¬å®é™…ä¸Šåªæ˜¯å®Œå…¨å¤„ç†è¯·æ±‚ï¼Œè€Œä¸æ˜¯è¿‡æ»¤ã€‚è¿™æ„å‘³ç€ä½ å¯¹è¿™äº›URLçš„è¯·æ±‚æ²¡æœ‰ä»»ä½•è¦æ±‚ï¼Œä¸éœ€è¦å†™ä»»ä½•controllerã€‚Shiroå°†æ ¹æ®éœ€è¦å¤„ç†è¿™äº›è¯·æ±‚ã€‚</p>
<h4 id="Add-a-login-page"><a href="#Add-a-login-page" class="headerlink" title="Add a login page"></a>Add a login page</h4><p>åœ¨ä¸Šä¸ªæ­¥éª¤ä¸­æˆ‘ä»¬å¼€å¯äº†å¯¹ç™»å½•å’Œç™»å‡ºçš„æ”¯æŒã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦ä¿è¯æœ‰ä¸€ä¸ª<code>/login.jsp</code>é¡µé¢æ¥æ˜¾ç¤ºç™»å½•è¡¨å•ã€‚</p>
<p>step3çš„åˆ†æ”¯ä¸­åŒ…å«<code>src/main/webapp/login.jsp</code>é¡µé¢ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„bootstrapä¸»é¢˜çš„ç™»å½•é¡µé¢ï¼Œä½†æ˜¯ä¾æ—§æœ‰å››ç‚¹éœ€è¦æ³¨æ„ï¼š</p>
<ul>
<li>è¿™ä¸ªè¡¨å•çš„<code>action</code>å€¼æ˜¯ç©ºçš„å­—ç¬¦ä¸²ã€‚å½“è¡¨å•ä¸­æ²¡æœ‰<code>action</code>å€¼ï¼Œæµè§ˆå™¨å°†æäº¤è¯·æ±‚åˆ°åŒä¸€ä¸ªURLã€‚è¿™å¾ˆå¥½ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šå‘Šè¯‰Shiroé‚£ä¸ªURLå¾ˆçŸ­ï¼Œæ‰€ä»¥Shiroå¯ä»¥è‡ªåŠ¨å¤„ç†ä»»ä½•ç™»å½•æäº¤ã€‚<code>/login.jsp = authc</code>è¿™è¡Œæ˜¯å‘Šè¯‰authcè¿‡æ»¤å™¨å¤„ç†è¿™ä¸ªæäº¤ã€‚</li>
<li>æœ‰ä¸€ä¸ª<code>username</code>å­—æ®µï¼ŒShiro authcè¿‡æ»¤å™¨å°†åœ¨ç™»å½•æäº¤æœŸé—´è‡ªåŠ¨æŸ¥æ‰¾ç”¨æˆ·åè¯·æ±‚å‚æ•°ï¼Œå¹¶å°†å…¶ç”¨ä½œç™»å½•æœŸé—´çš„å€¼ï¼ˆè®¸å¤šåŸŸå…è®¸æ­¤ä¸ºç”µå­é‚®ä»¶æˆ–ç”¨æˆ·åï¼‰ã€‚</li>
<li>æœ‰ä¸€ä¸ª<code>password</code>å­—æ®µï¼ŒShiro authcè¿‡æ»¤å™¨å°†åœ¨ç™»å½•æäº¤æœŸé—´è‡ªåŠ¨æŸ¥æ‰¾å¯†ç è¯·æ±‚å‚æ•°ã€‚</li>
<li>æœ‰ä¸€ä¸ªrememberMeå¤é€‰æ¡†ï¼Œå…¶â€œcheckedâ€çŠ¶æ€å¯ä»¥æ˜¯â€œtrueâ€å€¼ï¼ˆtrueï¼Œtï¼Œ1ï¼Œenabledï¼Œyï¼Œyesæˆ–onï¼‰ã€‚</li>
</ul>
<p>æˆ‘ä»¬çš„login.jspè¡¨å•åªä½¿ç”¨é»˜è®¤çš„ç”¨æˆ·åï¼Œå¯†ç å’ŒrememberMeè¡¨å•å­—æ®µåç§°ã€‚ å¦‚æœæ‚¨æƒ³æ›´æ”¹è¿™äº›åç§°ï¼Œè¿™äº›åç§°æ˜¯å¯é…ç½®çš„ã€‚å‚è§<a href="http://shiro.apache.org/static/1.3.2/apidocs/org/apache/shiro/web/filter/authc/FormAuthenticationFilter.html" target="_blank" rel="external">FormAuthenticationFilter</a>.</p>
<h4 id="Run-the-webapp-1"><a href="#Run-the-webapp-1" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>å†è·‘ä¸€æ¬¡ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mvn jetty:run</div></pre></td></tr></table></figure></p>
<h4 id="Try-to-Login"><a href="#Try-to-Login" class="headerlink" title="Try to Login"></a>Try to Login</h4><p>ä½¿ç”¨æ‚¨çš„Webæµè§ˆå™¨ï¼Œå¯¼èˆªåˆ°localhostï¼š8080 / login.jspï¼Œæ‚¨å°†çœ‹åˆ°æˆ‘ä»¬æ–°çš„ç™»å½•è¡¨å•ã€‚</p>
<p>è¾“å…¥ä½ åœ¨æ­¥éª¤2ç»“æŸæ—¶åˆ›å»ºçš„å¸æˆ·çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œç„¶åç‚¹å‡»â€œç™»å½•â€ã€‚ å¦‚æœç™»å½•æˆåŠŸï¼Œä½ å°†è¢«å¼•å¯¼åˆ°ä¸»é¡µï¼ å¦‚æœç™»å½•å¤±è´¥ï¼Œä½ å°†å†æ¬¡æ˜¾ç¤ºç™»å½•é¡µé¢ã€‚</p>
<p>æç¤ºï¼šå¦‚æœä½ å¸Œæœ›æˆåŠŸç™»å½•å°†ç”¨æˆ·é‡å®šå‘åˆ°ä¸»é¡µï¼ˆä¸Šä¸‹æ–‡è·¯å¾„/ï¼‰ä»¥å¤–çš„å…¶ä»–é¡µé¢ï¼Œåˆ™å¯ä»¥åœ¨INIçš„mainéƒ¨åˆ†ä¸­è®¾ç½®authc.successUrl = / anyã€‚</p>
<h3 id="Step-4-User-specific-UI-changes"><a href="#Step-4-User-specific-UI-changes" class="headerlink" title="Step 4: User-specific UI changes"></a>Step 4: User-specific UI changes</h3><p>é€šå¸¸éœ€è¦æ ¹æ®ç”¨æˆ·æ˜¯è°æ¥æ›´æ”¹webç”¨æˆ·ç•Œé¢ã€‚æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°åšåˆ°è¿™ä¸€ç‚¹ï¼Œå› ä¸ºShiroæ”¯æŒJSPæ ‡ç­¾åº“æ ¹æ®å½“å‰ç™»å½•çš„Subjectï¼ˆç”¨æˆ·ï¼‰è¿›è¡Œæ“ä½œã€‚</p>
<p>æ£€å‡ºstep4çš„åˆ†æ”¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step4</div></pre></td></tr></table></figure></p>
<p>åœ¨<code>home.jsp</code>é¡µé¢ä¸­æ–°å¢äº†ï¼š</p>
<ul>
<li>å½“æµè§ˆè¯¥é¡µé¢çš„å½“å‰ç”¨æˆ·æœªç™»å½•æ—¶ï¼Œä»–ä»¬å°†çœ‹åˆ°ä¸€ä¸ªâ€œæ¬¢è¿è®¿å®¢â€æ¶ˆæ¯ï¼Œå¹¶æŸ¥çœ‹ç™»å½•é¡µé¢çš„é“¾æ¥ã€‚</li>
<li>å½“æµè§ˆè¯¥é¡µé¢çš„å½“å‰ç”¨æˆ·ç™»å½•åï¼Œä»–ä»¬å°†çœ‹åˆ°è‡ªå·±çš„åå­—â€œæ¬¢è¿xxxâ€å’Œä¸€ä¸ªé“¾æ¥ä»¥æ³¨é”€ã€‚</li>
</ul>
<p>è¿™ç§ç±»å‹çš„UIå®šåˆ¶å¯¹äºå¯¼èˆªæ æ˜¯éå¸¸å¸¸è§çš„ï¼Œç”¨æˆ·æ§ä»¶ä½äºå±å¹•çš„å³ä¸Šæ–¹ã€‚</p>
<h4 id="Add-the-Shiro-Tag-Library-Declaration"><a href="#Add-the-Shiro-Tag-Library-Declaration" class="headerlink" title="Add the Shiro Tag Library Declaration"></a>Add the Shiro Tag Library Declaration</h4><p>åœ¨<code>home.jsp</code>é¡¶éƒ¨åŒ…å«äº†è¿™ä¸¤è¡Œï¼š<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">taglib</span> <span class="attr">prefix</span>=<span class="string">"shiro"</span> <span class="attr">uri</span>=<span class="string">"http://shiro.apache.org/tags"</span> %&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">taglib</span> <span class="attr">prefix</span>=<span class="string">"c"</span> <span class="attr">uri</span>=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;</span></div></pre></td></tr></table></figure></p>
<p>è¿™ä¸¤ä¸ªJSPé¡µé¢æŒ‡ä»¤å…è®¸é¡µé¢ä¸­çš„Coreï¼ˆc )å’ŒShiroï¼ˆshiro )æ ‡ç­¾åº“ã€‚</p>
<h4 id="Add-Shiro-Guest-and-User-tags"><a href="#Add-Shiro-Guest-and-User-tags" class="headerlink" title="Add Shiro Guest and User tags"></a>Add Shiro Guest and User tags</h4><p><code>home.jsp</code>æ–‡ä»¶è¿›ä¸€æ­¥ä¿®æ”¹äº†bodyé‡Œçš„å†…å®¹ï¼Œä»¥åŒ…å«<shiroï¼šguest>å’Œ<shiroï¼šuser>æ ‡ç­¾ã€‚<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Hi <span class="tag">&lt;<span class="name">shiro:guest</span>&gt;</span>Guest<span class="tag">&lt;/<span class="name">shiro:guest</span>&gt;</span><span class="tag">&lt;<span class="name">shiro:user</span>&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">%</span></span></div><div class="line">    //<span class="attr">This</span> <span class="attr">should</span> <span class="attr">never</span> <span class="attr">be</span> <span class="attr">done</span> <span class="attr">in</span> <span class="attr">a</span> <span class="attr">normal</span> <span class="attr">page</span> <span class="attr">and</span> <span class="attr">should</span> <span class="attr">exist</span> <span class="attr">in</span> <span class="attr">a</span> <span class="attr">proper</span> <span class="attr">MVC</span> <span class="attr">controller</span> <span class="attr">of</span> <span class="attr">some</span> <span class="attr">sort</span>, <span class="attr">but</span> <span class="attr">for</span> <span class="attr">this</span></div><div class="line">    //<span class="attr">tutorial</span>, <span class="attr">we</span>'<span class="attr">ll</span> <span class="attr">just</span> <span class="attr">pull</span> <span class="attr">out</span> <span class="attr">Stormpath</span> <span class="attr">Account</span> <span class="attr">data</span> <span class="attr">from</span> <span class="attr">Shiro</span>'<span class="attr">s</span> <span class="attr">PrincipalCollection</span> <span class="attr">to</span> <span class="attr">reference</span> <span class="attr">in</span> <span class="attr">the</span></div><div class="line">    //&lt;<span class="attr">c:out</span>/&gt; tag next:</div><div class="line"></div><div class="line">    request.setAttribute("account", org.apache.shiro.SecurityUtils.getSubject().getPrincipals().oneByType(java.util.Map.class));</div><div class="line"></div><div class="line">%&gt;</div><div class="line"><span class="tag">&lt;<span class="name">c:out</span> <span class="attr">value</span>=<span class="string">"$&#123;account.givenName&#125;"</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:user</span>&gt;</span>!</div><div class="line">    ( <span class="tag">&lt;<span class="name">shiro:user</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;c:url value="</span>/<span class="attr">logout</span>"/&gt;</span>"&gt;Log out<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">shiro:user</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:guest</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;c:url value="</span>/<span class="attr">login.jsp</span>"/&gt;</span>"&gt;Log in<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">shiro:guest</span>&gt;</span> )</div><div class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div></pre></td></tr></table></figure></shiroï¼šuser></shiroï¼šguest></p>
<p>ç»™å®šçš„æ ¼å¼æœ‰ç‚¹éš¾ä»¥é˜…è¯»ï¼Œä½†æ˜¯åœ¨è¿™é‡Œä½¿ç”¨äº†ä¸¤ä¸ªæ ‡ç­¾ï¼š</p>
<ul>
<li><code>&lt;shiro:guest&gt;</code>è¿™ä¸ªæ ‡ç­¾ä»…ä»…æ˜¾ç¤ºå®ƒå†…éƒ¨çš„å†…å®¹ï¼Œå‡å¦‚å½“å‰çš„subjectæ˜¯ä¸€ä¸ªè®¿å®¢çš„è¯ã€‚Shiroå°†guestå®šä¹‰ä¸ºæœªç™»å½•åˆ°åº”ç”¨ç¨‹åºçš„ä»»ä½•Subjectï¼Œæˆ–è€…åœ¨ä¹‹å‰ç™»å½•æ²¡æœ‰è¢«è®°ä½çš„ç”¨æˆ·ã€‚</li>
<li><code>&lt;shiro:user&gt;</code>Shiroå°†ç”¨æˆ·å®šä¹‰ä¸ºå½“å‰ç™»å½•åˆ°ï¼ˆè®¤è¯ï¼‰åº”ç”¨ç¨‹åºæˆ–ä»å…ˆå‰ç™»å½•è®°å½•çš„ä¸»é¢˜çš„ä»»ä½•ä¸»é¢˜ã€‚</li>
</ul>
<p>å¦‚æœsubjectæ˜¯è®¿å®¢ï¼Œä¸Šè¿°ä»£ç æ®µå°†å‘ˆç°ä»¥ä¸‹ä»£ç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Hi Guest! (Log in)</div></pre></td></tr></table></figure></p>
<p>å¦‚æœsubjectæ˜¯â€œç”¨æˆ·â€ï¼Œå®ƒå°†å‘ˆç°ä»¥ä¸‹å†…å®¹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Hi jsmith! (Log out)</div></pre></td></tr></table></figure></p>
<p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œæ‚¨å¯ä»¥å…³é—­æ•´ä¸ªé¡µé¢éƒ¨åˆ†ï¼ŒåŠŸèƒ½å’ŒUIç»„ä»¶ã€‚<br>é™¤äº†è¿™ä¸¤ä¸ªæ ‡ç­¾ï¼ŒShiroè¿˜æä¾›å…¶ä»–æ ‡ç­¾ä¾›ä½ æ¥å®šåˆ¶ä½ è‡ªå·±çš„UIã€‚</p>
<h4 id="Run-the-webapp-2"><a href="#Run-the-webapp-2" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>è·‘å§ï¼</p>
<h3 id="Step-5-Allow-Access-to-Only-Authenticated-Users"><a href="#Step-5-Allow-Access-to-Only-Authenticated-Users" class="headerlink" title="Step 5: Allow Access to Only Authenticated Users"></a>Step 5: Allow Access to Only Authenticated Users</h3><p>è™½ç„¶ä½ å¯ä»¥æ ¹æ®subjectçš„çŠ¶æ€æ¥æ”¹å˜å†…å®¹ï¼Œä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹ï¼Œä½ å°†è¦é™åˆ¶webappçš„æ•´ä¸ªéƒ¨åˆ†ï¼Œè¿™å–å†³äºæœ‰äººåœ¨å½“å‰ä¸Webåº”ç”¨ç¨‹åºçš„äº’åŠ¨è¿‡ç¨‹ä¸­æ˜¯å¦å·²è¯æ˜å…¶èº«ä»½ï¼ˆå·²éªŒè¯ï¼‰ã€‚</p>
<p>å¦‚æœwebappçš„ç”¨æˆ·ä¸“åŒºéƒ¨åˆ†æ˜¾ç¤ºæ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¸å•æ˜ç»†æˆ–æ§åˆ¶å…¶ä»–ç”¨æˆ·çš„èƒ½åŠ›ï¼‰ï¼Œè¿™ä¸€ç‚¹å°¤ä¸ºé‡è¦ã€‚</p>
<p>æ£€å‡ºstep5ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step5</div></pre></td></tr></table></figure></p>
<p>Step 5æœ‰3ä¸ªæ›´æ–°ï¼š</p>
<ul>
<li>æ·»åŠ äº†ä¸€ä¸ªæ–°çš„éƒ¨åˆ†ï¼ˆurl pathï¼‰ï¼Œæˆ‘ä»¬è¦é™åˆ¶åªæœ‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ã€‚</li>
<li>æˆ‘ä»¬æ›´æ”¹äº†shiro.iniï¼Œä»¥å‘Šè¯‰Shiroåªå…è®¸ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·è®¿é—®è¯¥Webåº”ç”¨ç¨‹åºçš„è¯¥éƒ¨åˆ†ã€‚</li>
<li>æˆ‘ä»¬ä¿®æ”¹äº†ä¸»é¡µï¼Œæ ¹æ®å½“å‰çš„ä¸»é¢˜æ˜¯å¦è¢«è®¤è¯æ¥æ›´æ”¹å…¶è¾“å‡ºã€‚</li>
</ul>
<h4 id="Add-a-new-restricted-section"><a href="#Add-a-new-restricted-section" class="headerlink" title="Add a new restricted section"></a>Add a new restricted section</h4><p><code>src/main/webapp/account</code>ç›®å½•è¢«æ·»åŠ è¿›æ¥äº†ã€‚æ­¤ç›®å½•ï¼ˆåŠå…¶ä¸‹æ–¹çš„æ‰€æœ‰è·¯å¾„ï¼‰ä¼šæ¨¡æ‹Ÿç½‘ç«™çš„â€œç§æœ‰â€æˆ–â€œä»…éªŒè¯â€éƒ¨åˆ†ï¼Œä½ å¯èƒ½å¸Œæœ›å°†å…¶é™åˆ¶ä¸ºåªèƒ½ç™»å½•ç”¨æˆ·ã€‚<code>src/main/webapp/account/index.jsp</code>æ–‡ä»¶åªæ˜¯æ¨¡æ‹Ÿâ€œä¸»é¡µâ€é¡µé¢çš„å ä½ç¬¦ã€‚</p>
<h4 id="Configure-shiro-ini"><a href="#Configure-shiro-ini" class="headerlink" title="Configure shiro.ini"></a>Configure shiro.ini</h4><p>åœ¨<code>shiro.ini</code>çš„<code>[urls]</code>è¿™ä¸ªç« èŠ‚çš„ç»“å°¾ï¼Œæ·»åŠ äº†ä¸‹é¢çš„ä¸€è¡Œ:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/account/** = authc</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªShiroè¿‡æ»¤å™¨é“¾å®šä¹‰æ„å‘³ç€â€œå¯¹/ accountï¼ˆæˆ–å…¶ä»»ä½•å­è·¯å¾„ï¼‰çš„ä»»ä½•è¯·æ±‚å¿…é¡»è¢«è®¤è¯â€ã€‚<br>ä½†æ˜¯ï¼Œå¦‚æœæœ‰äººå°è¯•è®¿é—®è¯¥è·¯å¾„æˆ–å…¶ä»»ä½•å­è·¯å¾„ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ<br>ä½ è¿˜è®°å¾—åœ¨æ­¥éª¤3ä¸­,å½“æˆ‘ä»¬å°†ä»¥ä¸‹è¡Œæ·»åŠ åˆ°mainéƒ¨åˆ†å—ï¼Ÿ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shiro.loginUrl = /login.jsp</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸€è¡Œè‡ªåŠ¨ä½¿ç”¨æˆ‘ä»¬çš„webappç™»å½•URLé…ç½®authcè¿‡æ»¤å™¨ã€‚<br>åŸºäºè¿™ä¸€è¡Œé…ç½®ï¼Œauthcè¿‡æ»¤å™¨ç°åœ¨è¶³å¤Ÿèªæ˜ï¼Œå¯ä»¥çŸ¥é“å½“è®¿é—®/å¸æˆ·å½“å‰ä¸»é¢˜æœªè¢«éªŒè¯æ—¶ï¼Œå®ƒå°†è‡ªåŠ¨å°†ä¸»é¢˜é‡å®šå‘åˆ°/login.jspé¡µé¢ã€‚æˆåŠŸç™»å½•åï¼Œå®ƒå°†è‡ªåŠ¨å°†ç”¨æˆ·é‡å®šå‘åˆ°ä»–ä»¬è¯•å›¾è®¿é—®çš„é¡µé¢ï¼ˆ/å¸æˆ·ï¼‰ã€‚ å¾ˆæ–¹ä¾¿ï¼</p>
<h4 id="Update-our-home-page"><a href="#Update-our-home-page" class="headerlink" title="Update our home page"></a>Update our home page</h4><p>æ­¥éª¤5çš„æœ€ç»ˆæ›´æ”¹æ˜¯æ›´æ–°/home.jspé¡µé¢ï¼Œè®©ç”¨æˆ·çŸ¥é“ä»–ä»¬å¯ä»¥è®¿é—®ç½‘ç«™çš„æ–°éƒ¨åˆ†ã€‚è¿™äº›è¡Œè¢«æ·»åŠ åˆ°æ¬¢è¿æ¶ˆæ¯ä¸‹:<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">shiro:authenticated</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>Visit your <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;c:url value="</span>/<span class="attr">account</span>"/&gt;</span>"&gt;account page<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">shiro:authenticated</span>&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">shiro:notAuthenticated</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>If you want to access the authenticated-only <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;c:url value="</span>/<span class="attr">account</span>"/&gt;</span>"&gt;account page<span class="tag">&lt;/<span class="name">a</span>&gt;</span>, you will need to log-in first.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">shiro:notAuthenticated</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>å¦‚æœå½“å‰çš„Subjectåœ¨å½“å‰ä¼šè¯æœŸé—´å·²ç»ç™»å½•ï¼ˆè®¤è¯ï¼‰ï¼Œåˆ™<shiroï¼šauthenticated>æ ‡ç­¾å†…çš„å†…å®¹è¢«æ˜¾ç¤ºã€‚è¿™æ˜¯SubjectçŸ¥é“ä»–ä»¬å¯ä»¥å»è®¿é—®ç½‘ç«™çš„æ–°éƒ¨åˆ†ã€‚<br>å¦‚æœå½“å‰Subjectåœ¨å½“å‰ä¼šè¯æœŸé—´å°šæœªéªŒè¯ï¼Œåˆ™<shiroï¼šnotauthenticated>æ ‡ç­¾å†…çš„å†…å®¹è¢«æ˜¾ç¤ºã€‚<br>ä½†æ˜¯ä½ æ³¨æ„åˆ°äº†å—ï¼Œæœªç»èº«ä»½éªŒè¯çš„å†…å®¹ä»ç„¶å…·æœ‰/ accountéƒ¨åˆ†çš„URLï¼Ÿæ²¡å…³ç³» - æˆ‘ä»¬çš„authcè¿‡æ»¤å™¨å°†å¦‚ä¸Šæ‰€è¿°å¤„ç†login-and-then-redirectæµç¨‹ã€‚<br>ç”¨æ–°çš„æ›´æ”¹å¯åŠ¨webappå¹¶å°è¯•ä¸€ä¸‹ï¼</shiroï¼šnotauthenticated></shiroï¼šauthenticated></p>
<h4 id="Run-the-webapp-3"><a href="#Run-the-webapp-3" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>è·‘ä¸€ä¸‹å§ã€‚</p>
<h3 id="Step-6-Role-Based-Access-Control"><a href="#Step-6-Role-Based-Access-Control" class="headerlink" title="Step 6: Role-Based Access Control"></a>Step 6: Role-Based Access Control</h3><p>é™¤äº†åŸºäºèº«ä»½éªŒè¯æ§åˆ¶è®¿é—®ä¹‹å¤–ï¼Œè¿˜ç»å¸¸éœ€è¦æ ¹æ®åˆ†é…ç»™å½“å‰ä¸»ä½“çš„è§’è‰²æ¥é™åˆ¶å¯¹åº”ç”¨ç¨‹åºæŸäº›éƒ¨åˆ†çš„è®¿é—®ã€‚<br>æ£€å‡ºä»£ç ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step6</div></pre></td></tr></table></figure></p>
<h4 id="Add-Roles"><a href="#Add-Roles" class="headerlink" title="Add Roles"></a>Add Roles</h4><p>ä¸ºäº†æ‰§è¡ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦æœ‰è§’è‰²ã€‚<br>åœ¨æœ¬æ•™ç¨‹ä¸­æœ€å¿«çš„æ–¹æ³•æ˜¯åœ¨Stormpathä¸­æ·»åŠ ä¸€äº›ç»„ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œç™»å½•åˆ°UIå¹¶å¯¼èˆªå¦‚ä¸‹ï¼š<br><strong>Directories &gt; My Application Directory &gt; Groups</strong><br>æ·»åŠ ä¸‹é¢ä¸‰ä¸ªç»„ï¼š</p>
<ul>
<li>Captains</li>
<li>Officers</li>
<li>Enlisted</li>
</ul>
<p>åˆ›å»ºç»„åï¼Œå°†Jean-Luc Picardå¸æˆ·æ·»åŠ åˆ°Captainså’ŒOfficersç»„ã€‚æ‚¨å¯èƒ½éœ€è¦åˆ›å»ºä¸€äº›ä¸´æ—¶å¸æˆ·ï¼Œå¹¶å°†å®ƒä»¬æ·»åŠ åˆ°æ‚¨å–œæ¬¢çš„ä»»ä½•ç»„ï¼›ç¡®ä¿æŸäº›å¸æˆ·ä¸é‡å ç»„ï¼Œå› æ­¤ä½ å¯ä»¥åŸºäºåˆ†é…ç»™ç”¨æˆ·å¸æˆ·çš„å•ç‹¬ç»„æŸ¥çœ‹å˜æ›´ã€‚</p>
<h4 id="Role-Based-Access-Control-RBAC-Tags"><a href="#Role-Based-Access-Control-RBAC-Tags" class="headerlink" title="Role Based Access Control (RBAC) Tags"></a>Role Based Access Control (RBAC) Tags</h4><p>æˆ‘ä»¬æ›´æ–°/home.jspé¡µé¢ï¼Œè®©ç”¨æˆ·çŸ¥é“ä»–ä»¬æœ‰ä»€ä¹ˆè§’è‰²ï¼Œå“ªäº›è§’è‰²æ²¡æœ‰ã€‚è¿™äº›æ¶ˆæ¯å°†æ·»åŠ åˆ°ä¸»é¡µçš„æ–°çš„<code>&lt;h2&gt;</code>è§’è‰²<code>&lt;/ h2&gt;</code>éƒ¨åˆ†:<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Roles<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Here are the roles you have and don't have. Log out and log back in under different user</div><div class="line">    accounts to see different roles.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>Roles you have:<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:hasRole</span> <span class="attr">name</span>=<span class="string">"Captains"</span>&gt;</span>Captains<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:hasRole</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:hasRole</span> <span class="attr">name</span>=<span class="string">"Officers"</span>&gt;</span>Bad Guys<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:hasRole</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:hasRole</span> <span class="attr">name</span>=<span class="string">"Enlisted"</span>&gt;</span>Enlisted<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:hasRole</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>Roles you DON'T have:<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:lacksRole</span> <span class="attr">name</span>=<span class="string">"Captains"</span>&gt;</span>Captains<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:lacksRole</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:lacksRole</span> <span class="attr">name</span>=<span class="string">"Officers"</span>&gt;</span>Officers<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:lacksRole</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:lacksRole</span> <span class="attr">name</span>=<span class="string">"Enlisted"</span>&gt;</span>Enlisted<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:lacksRole</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>å¦‚æœå½“å‰ä¸»ä½“è¢«åˆ†é…äº†æŒ‡å®šçš„è§’è‰²ï¼Œ<shiroï¼šhasrole>æ ‡ç­¾å°†æ˜¾ç¤ºå…¶ä¸­çš„å†…å®¹ã€‚<shiroï¼šlacksrole>æ ‡ç­¾åªä¼šåœ¨å½“å‰ä¸»ä½“æœªåˆ†é…æŒ‡å®šè§’è‰²æ—¶æ˜¾ç¤ºå…¶ä¸­çš„å†…å®¹ã€‚</shiroï¼šlacksrole></shiroï¼šhasrole></p>
<h4 id="RBAC-filter-chains"><a href="#RBAC-filter-chains" class="headerlink" title="RBAC filter chains"></a>RBAC filter chains</h4><p>å‘è¯»è€…ç•™ä¸‹çš„ä¸€ä¸ªç»ƒä¹ ï¼ˆä¸æ˜¯ä¸€ä¸ªå®šä¹‰çš„æ­¥éª¤ï¼‰æ˜¯æ ¹æ®åˆ†é…ç»™å½“å‰ç”¨æˆ·çš„è§’è‰²ï¼Œåˆ›å»ºç½‘ç«™çš„ä¸€ä¸ªæ–°çš„éƒ¨åˆ†ï¼Œå¹¶é™åˆ¶URLè®¿é—®è¯¥ç½‘ç«™çš„è¯¥éƒ¨åˆ†ã€‚<br>æç¤ºï¼šä½¿ç”¨ <code>filter chain definition</code>ä¸ºwebappçš„æ–°éƒ¨åˆ†åˆ›å»ºè¿‡æ»¤å™¨é“¾å®šä¹‰ã€‚</p>
<h4 id="Run-the-webapp-4"><a href="#Run-the-webapp-4" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>runä¸€ä¸‹å’¯</p>
<h3 id="Step-7-Permission-Based-Access-Control"><a href="#Step-7-Permission-Based-Access-Control" class="headerlink" title="Step 7: Permission-Based Access Control"></a>Step 7: Permission-Based Access Control</h3><p>åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶å¯¹äºè®¸å¤šæƒ…å†µæ˜¯è¡Œå¾—é€šçš„ï¼Œä½†æ˜¯å®ƒå­˜åœ¨ä¸€ä¸ªä¸»è¦é—®é¢˜ï¼šä½ ä¸èƒ½åœ¨è¿è¡Œæ—¶æ·»åŠ æˆ–åˆ é™¤è§’è‰²ã€‚è§’è‰²æ£€æŸ¥ä½¿ç”¨è§’è‰²åç§°è¿›è¡Œç¡¬ç¼–ç ï¼Œæ‰€ä»¥å¦‚æœä½ æ”¹å˜äº†è§’è‰²åç§°æˆ–è§’è‰²é…ç½®ï¼Œæˆ–æ·»åŠ æˆ–åˆ é™¤è§’è‰²ï¼Œä½ å¿…é¡»å›å»æ›´æ”¹ä»£ç ï¼<br>å› æ­¤ï¼ŒShiroå…·æœ‰å¼ºå¤§çš„åŠŸèƒ½ï¼šå†…ç½®çš„æƒé™æ”¯æŒã€‚<br>åœ¨Shiroï¼Œæƒé™æ˜¯ä¸€ä¸ªåŸå§‹çš„åŠŸèƒ½è¯´æ˜ï¼Œä¾‹å¦‚â€œæ‰“å¼€é—¨â€ï¼Œåˆ›å»ºåšå®¢æ¡ç›®â€œï¼Œâ€åˆ é™¤jsmithç”¨æˆ·â€œç­‰ã€‚æƒé™åæ˜ äº†æ‚¨çš„åº”ç”¨ç¨‹åºçš„åŸå§‹åŠŸèƒ½ï¼Œæ‰€ä»¥åœ¨æ›´æ”¹åº”ç”¨ç¨‹åºçš„åŠŸèƒ½æ—¶ï¼Œæ‚¨åªéœ€è¦æ›´æ”¹æƒé™æ£€æŸ¥ï¼Œè€Œä¸æ˜¯è¦æ›´æ”¹è§’è‰²æˆ–ç”¨æˆ·æ¨¡å‹ã€‚<br>ä¸ºäº†æ¼”ç¤ºè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€äº›æƒé™å¹¶å°†å…¶åˆ†é…ç»™ç”¨æˆ·ï¼Œç„¶åæ ¹æ®ç”¨æˆ·çš„æˆæƒï¼ˆæƒé™ï¼‰è‡ªå®šä¹‰æˆ‘ä»¬çš„Web UIã€‚</p>
<h4 id="Add-Permissions"><a href="#Add-Permissions" class="headerlink" title="Add Permissions"></a>Add Permissions</h4><p>Shiroçš„Realmæ˜¯åªè¯»ç»„ä»¶:æ¯ä¸ªæ•°æ®å­˜å‚¨æ¨¡å‹çš„è§’è‰²ï¼Œç»„ï¼Œæƒé™ï¼Œå¸æˆ·å’Œä»–ä»¬çš„å…³ç³»ä¸åŒ,æ‰€ä»¥Shiroæ²¡æœ‰ä¸€ä¸ªâ€™writeâ€™APIæ¥ä¿®æ”¹è¿™äº›èµ„æºã€‚è¦ä¿®æ”¹æ¨¡å‹å¯¹è±¡çš„åº•å±‚ï¼Œä½ åªéœ€é€šè¿‡ä»»ä½•æ‚¨æƒ³è¦çš„APIç›´æ¥ä¿®æ”¹å®ƒä»¬ã€‚ä½ çš„Shiroçš„Realmç„¶åçŸ¥é“å¦‚ä½•é˜…è¯»è¿™äº›ä¿¡æ¯ï¼Œå¹¶ä»¥Shiroç†è§£çš„æ ¼å¼è¡¨ç¤ºå®ƒã€‚<br>å› æ­¤ï¼Œç”±äºæˆ‘ä»¬åœ¨æ­¤ç¤ºä¾‹åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨Stormpathï¼Œå› æ­¤æˆ‘ä»¬å°†ä»¥ç‰¹å®šäºStormpath APIçš„æ–¹å¼ä¸ºå¸æˆ·å’Œç»„åˆ†é…æƒé™ã€‚<br>è®©æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªcURLè¯·æ±‚ï¼Œä¸ºä»¥å‰åˆ›å»ºçš„Jean-Luc Picardå¸æˆ·æ·»åŠ ä¸€äº›æƒé™ã€‚ ä½¿ç”¨è¯¥å¸æˆ·çš„href URLï¼Œæˆ‘ä»¬å°†é€šè¿‡è‡ªå®šä¹‰æ•°æ®å°†ä¸€äº›apacheShiroPermissionså‘å¸ƒåˆ°è¯¥å¸æˆ·ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">curl -X POST --user <span class="variable">$YOUR_API_KEY_ID</span>:<span class="variable">$YOUR_API_KEY_SECRET</span> \</div><div class="line">    -H <span class="string">"Accept: application/json"</span> \</div><div class="line">    -H <span class="string">"Content-Type: application/json"</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'&#123;</span></div><div class="line">            "apacheShiroPermissions": [</div><div class="line">                "ship:NCC-1701-D:command",</div><div class="line">                "user:jlpicard:edit"</div><div class="line">            ]</div><div class="line">        &#125;' \</div><div class="line"><span class="string">"https://api.stormpath.com/v1/accounts/<span class="variable">$JLPICARD_ACCOUNT_ID</span>/customData"</span></div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­$ JLPICARD_ACCOUNT_IDä¸ä½ åœ¨æœ¬æ•™ç¨‹å¼€å¤´åˆ›å»ºçš„Jean-Luc Picardçš„æ’æ§½ç›¸åŒ¹é…ã€‚<br>è¿™å°†ç›´æ¥å‘Stormpathå¸æˆ·æ·»åŠ ä¸¤ä¸ªæƒé™ï¼š</p>
<ul>
<li>ship:NCC-1701-D:command</li>
<li>user:jlpicard:edit</li>
</ul>
<p>è¿™äº›ä½¿ç”¨Shiroçš„WildcardPermissionè¯­æ³•ã€‚<br>ç¬¬ä¸€ä¸ªåŸºæœ¬ä¸Šæ˜¯æŒ‡ç”¨â€œNCC-1701-Dâ€æ ‡è¯†ç¬¦æ¥â€œå‘½ä»¤â€â€™èˆ¹â€™çš„èƒ½åŠ›ã€‚è¿™æ˜¯å®ä¾‹çº§æƒé™çš„ä¸€ä¸ªç¤ºä¾‹ï¼šæ§åˆ¶å¯¹èµ„æºèˆ¹çš„ç‰¹å®šå®ä¾‹NCC-1701-Dçš„è®¿é—®ã€‚ç¬¬äºŒä¸ªä¹Ÿæ˜¯ä¸€ä¸ªå®ä¾‹çº§æƒé™ï¼ŒæŒ‡å‡ºä½¿ç”¨æ ‡è¯†ç¬¦jlpicardç¼–è¾‘ç”¨æˆ·çš„èƒ½åŠ›ã€‚<br>å¦‚ä½•åœ¨Stormpathä¸­å­˜å‚¨æƒé™ï¼Œä»¥åŠå¦‚ä½•åœ¨Stormpathä¸­è‡ªå®šä¹‰å­˜å‚¨å’Œè®¿é—®é€‰é¡¹è¶…å‡ºæœ¬æ–‡æ¡£çš„èŒƒå›´ï¼Œä½†è¿™æ˜¯åœ¨Shiro Stormpathæ’ä»¶æ–‡æ¡£ä¸­è§£é‡Šçš„ã€‚</p>
<h4 id="Permission-Tags"><a href="#Permission-Tags" class="headerlink" title="Permission Tags"></a>Permission Tags</h4><p>å°±åƒæˆ‘ä»¬æœ‰ç”¨äºè§’è‰²æ£€æŸ¥çš„JSPæ ‡ç­¾ä¸€æ ·ï¼Œè¿˜æœ‰åŒæ ·ç”¨äºæƒé™æ£€æŸ¥çš„æ ‡ç­¾ã€‚æˆ‘ä»¬æ›´æ–°/home.jspé¡µé¢ï¼Œè®©ç”¨æˆ·çŸ¥é“æ˜¯å¦å…è®¸ä½ æ ¹æ®åˆ†é…ç»™ä»–ä»¬çš„æƒé™æ‰§è¡ŒæŸäº›æ“ä½œã€‚è¿™äº›æ¶ˆæ¯å°†æ·»åŠ åˆ°ä¸»é¡µçš„æ–°çš„<code>&lt;h2&gt;</code>æƒé™<code>&lt;/ h2&gt;</code>éƒ¨åˆ†ï¼š<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Permissions<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>You may <span class="tag">&lt;<span class="name">shiro:lacksPermission</span> <span class="attr">name</span>=<span class="string">"ship:NCC-1701-D:command"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>NOT<span class="tag">&lt;/<span class="name">b</span>&gt;</span> <span class="tag">&lt;/<span class="name">shiro:lacksPermission</span>&gt;</span> command the <span class="tag">&lt;<span class="name">code</span>&gt;</span>NCC-1701-D<span class="tag">&lt;/<span class="name">code</span>&gt;</span> Starship!<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>You may <span class="tag">&lt;<span class="name">shiro:lacksPermission</span> <span class="attr">name</span>=<span class="string">"user:$&#123;account.username&#125;:edit"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>NOT<span class="tag">&lt;/<span class="name">b</span>&gt;</span> <span class="tag">&lt;/<span class="name">shiro:lacksPermission</span>&gt;</span> edit the $&#123;account.username&#125; user!<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>å½“ä½ ç¬¬ä¸€æ¬¡è®¿é—®ä¸»é¡µæ—¶ï¼Œåœ¨ç™»å½•ä¹‹å‰ï¼Œä½ å°†çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">You may NOT command the NCC-1701-D Starship!</div><div class="line">You may NOT edit the user!</div></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯ï¼Œåœ¨ä½ ä½¿ç”¨Jean-Luc Picardå¸æˆ·ç™»å½•åï¼Œä½ å°†çœ‹åˆ°è¿™ä¸€ç‚¹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">You may command the NCC-1701-D Starship!</div><div class="line">You may edit the user!</div></pre></td></tr></table></figure></p>
<p>ä½ å¯ä»¥çœ‹åˆ°Shiroè§£å†³äº†ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·å…·æœ‰æƒé™ï¼Œå¹¶ä»¥é€‚å½“çš„æ–¹å¼å‘ˆç°è¾“å‡ºã€‚<br>æ‚¨è¿˜å¯ä»¥ä½¿ç”¨<shiroï¼šhaspermission>æ ‡ç­¾è¿›è¡Œè‚¯å®šæƒé™æ£€æŸ¥ã€‚<br>æœ€åï¼Œæˆ‘ä»¬å°†æ³¨æ„åˆ°æå…¶å¼ºå¤§çš„æƒé™æ£€æŸ¥åŠŸèƒ½ã€‚ ä½ èƒ½çœ‹åˆ°ç¬¬äºŒä¸ªæƒé™æ£€æŸ¥å¦‚ä½•ä½¿ç”¨è¿è¡Œæ—¶ç”Ÿæˆçš„æƒé™å€¼å—ï¼Ÿ<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">shiro:lacksPermission</span> <span class="attr">name</span>=<span class="string">"user:$&#123;account.username&#125;:edit"</span>&gt;</span> ...</div></pre></td></tr></table></figure></shiroï¼šhaspermission></p>
<p><code>${account.username}</code>åœ¨è¿è¡Œçš„æ—¶å€™å°†<code>user:aUsername:edit</code>çš„å€¼ç»„è£…èµ·æ¥ï¼Œæœ€åè¿™ä¸ªæœ€ç»ˆçš„å€¼è¢«ç”¨æ¥æƒé™æ£€æŸ¥ã€‚<br>è¿™ç§è¿è¡Œæ—¶çš„æƒé™æ£€æŸ¥æœºåˆ¶æ˜¯ç”¨æ¥æ„å»ºé«˜åº¦å®šåˆ¶åŒ–å’Œå®‰å…¨çš„åº”ç”¨çš„å¸¸è§„æŠ€æœ¯ã€‚</p>
<h4 id="Run-the-webapp-5"><a href="#Run-the-webapp-5" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>runä¸€runå’¯</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>æˆ‘ä»¬å¸Œæœ›è¿™ç¯‡æŒ‡å—èƒ½å¯¹ä½ ä½¿ç”¨Shiroæ„å»ºwebappæœ‰å¸®åŠ©ã€‚åœ¨ä¸‹ä¸ªç‰ˆæœ¬æˆ‘ä»¬å°†æ¨å‡ºè¿™äº›å†…å®¹ï¼š</p>
<ul>
<li>ä¸åŒç”¨æˆ·æ•°æ®çš„å­˜å‚¨æ’ä»¶ï¼ŒåƒRDBMSæˆ–è€…NoSQLä¹‹ç±»çš„ã€‚</li>
</ul>
<p>åŸæ–‡<a href="http://shiro.apache.org/webapp-tutorial.html" target="_blank" rel="external">Securing Web Applications with Apache Shiro</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™ç¯‡æ–‡ç« æ˜¯ä»‹ç»ä½¿ç”¨Shiroä¸€æ­¥ä¸€æ­¥ä¿æŠ¤ä½ çš„webåº”ç”¨çš„æ•™ç¨‹ã€‚å®ƒåŒ…å«äº†Shiroçš„çŸ¥è¯†ï¼Œä»¥åŠå’Œæœ€è¿‘ä¸¤ç¯‡æ–‡ç« å¾ˆç›¸ä¼¼ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.infoq.com/articles/apache-shiro&quot;&gt;Application Security with Apache Shiro&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://shiro.apache.org/10-minute-tutorial.html&quot;&gt;Apache Shiro 10 Minute Tutorial&lt;/a&gt;&lt;br&gt;è¿™ä¸ªå…¥é—¨æ•™ç¨‹ä¼šèŠ±è´¹å¤§çº¦45åˆ†é’Ÿåˆ°ä¸€ä¸ªå°æ—¶ã€‚å½“ä½ è¯»å®Œåï¼Œä½ å°±ä¼šçŸ¥é“Shiroåœ¨webåº”ç”¨ä¸­æ€ä¹ˆå·¥ä½œäº†çš„ã€‚
    
    </summary>
    
      <category term="Apache" scheme="http://www.wei-dong.top/categories/Apache/"/>
    
    
      <category term="Apache Shiro" scheme="http://www.wei-dong.top/tags/Apache-Shiro/"/>
    
      <category term="ç¿»è¯‘" scheme="http://www.wei-dong.top/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>Java Authorization Guide with Apache Shiro[è¯‘]</title>
    <link href="http://www.wei-dong.top/2017/09/25/Java%20Authorization%20Guide%20with%20Apache%20Shiro%5B%E8%AF%91%5D/"/>
    <id>http://www.wei-dong.top/2017/09/25/Java Authorization Guide with Apache Shiro[è¯‘]/</id>
    <published>2017-09-25T12:05:23.000Z</published>
    <updated>2017-09-25T12:09:26.000Z</updated>
    
    <content type="html"><![CDATA[<p>æˆæƒæˆ–è€…è¯´è®¿é—®æ§åˆ¶æŒ‡çš„æ˜¯ä¸ºèµ„æºåˆ†é…è®¿é—®æƒé™ã€‚æ¢å¥è¯è¯´å°±æ˜¯è°èƒ½å¹²ä»€ä¹ˆã€‚</p>
<p>ä¸¾ä¸ªæˆæƒçš„æ —å­ï¼šç”¨æˆ·å…è®¸çœ‹ç½‘é¡µã€æ”¹æ•°æ®ã€çœ‹æŒ‰é’®æˆ–è€…æ‰“å°å—ï¼Ÿè¿™äº›éƒ½èƒ½å†³å®šç”¨æˆ·èƒ½ä¸èƒ½åšä»€ä¹ˆã€‚<br><a id="more"></a></p>
<h3 id="Elements-of-Authorization"><a href="#Elements-of-Authorization" class="headerlink" title="Elements of Authorization"></a>Elements of Authorization</h3><p>æˆæƒæœ‰ä¸‰ä¸ªæˆ‘ä»¬åœ¨Shiroä¸­ä½¿ç”¨å¾ˆå¤šçš„æ ¸å¿ƒå…ƒç´ â€“æƒé™ã€è§’è‰²å’Œç”¨æˆ·ã€‚</p>
<h3 id="Permissions-Defined"><a href="#Permissions-Defined" class="headerlink" title="Permissions Defined"></a>Permissions Defined</h3><p>æƒé™æ˜¯å®‰å…¨ç­–ç•¥çš„æœ€åŸå­çº§åˆ«ï¼Œå®ƒä»¬æ˜¯åŠŸèƒ½è¯­å¥ã€‚æƒé™å°±æ˜¯åœ¨ä½ çš„åº”ç”¨ä¸­èƒ½åšä»€ä¹ˆã€‚æƒé™æè¿°äº†èµ„æºç±»å‹ä»¥åŠå½“ä½ ä¸è¿™äº›èµ„æºè¿›è¡Œäº¤äº’æ—¶å¯èƒ½é‡‡å–çš„æ“ä½œã€‚ä½ èƒ½å¼€é—¨å—ï¼Ÿä½ èƒ½è¯»å–æ–‡ä»¶å—ï¼Ÿä½ èƒ½åˆ é™¤å®¢æˆ·è®°å½•å—ï¼Ÿä½ èƒ½æŒ‰æŒ‰é’®å—ï¼Ÿ</p>
<p>æ•°æ®ç›¸å…³èµ„æºçš„å¸¸è§æ“ä½œæ˜¯åˆ›å»ºï¼Œè¯»å–ï¼Œæ›´æ–°å’Œåˆ é™¤ï¼Œé€šå¸¸ç§°ä¸ºCRUDã€‚</p>
<p>é‡è¦çš„æ˜¯è¦æ˜ç™½ï¼Œæƒé™ä¸æ˜¯è°èƒ½æ‰§è¡Œçš„æ“ä½œ - å®ƒä»¬åªæ˜¯å¯ä»¥æ‰§è¡Œå“ªäº›æ“ä½œçš„è¯­å¥ã€‚</p>
<h4 id="Levels-of-permission-granularity"><a href="#Levels-of-permission-granularity" class="headerlink" title="Levels of permission granularity"></a>Levels of permission granularity</h4><p>ä»¥ä¸Šæƒé™éƒ½æŒ‡å®šèµ„æºï¼ˆé—¨ï¼Œæ–‡ä»¶ï¼Œå®¢æˆ·è®°å½•ç­‰ï¼‰ä¸Šçš„æ“ä½œï¼ˆæ‰“å¼€ï¼Œè¯»å–ï¼Œåˆ é™¤ç­‰ï¼‰ã€‚åœ¨Shiroï¼Œæ‚¨å¯ä»¥å®šä¹‰ä»»ä½•æ‚¨å–œæ¬¢çš„ç²’åº¦çš„æƒé™ã€‚ä»¥ä¸‹æ˜¯ç²’åº¦é¡ºåºçš„å‡ ä¸ªå¸¸è§æƒé™çº§åˆ«ã€‚</p>
<ul>
<li>èµ„æºçº§åˆ« - è¿™æœ€å¹¿æ³›æœ€ç®€å•æ„å»ºã€‚ ç”¨æˆ·å¯ä»¥ç¼–è¾‘å®¢æˆ·è®°å½•æˆ–æ‰“å¼€é—¨ã€‚ èµ„æºè¢«æŒ‡å®šï¼Œä½†ä¸æ˜¯è¯¥èµ„æºçš„ç‰¹å®šå®ä¾‹ã€‚</li>
<li>å®ä¾‹çº§åˆ« - æƒé™å¯ä»¥æŒ‡å®šèµ„æºçš„å®ä¾‹ã€‚ ç”¨æˆ·å¯ä»¥ç¼–è¾‘IBMçš„å®¢æˆ·è®°å½•æˆ–æ‰“å¼€å¨æˆ¿é—¨ã€‚</li>
<li>å±æ€§çº§åˆ« - æƒé™ç°åœ¨å¯ä»¥æŒ‡å®šå®ä¾‹æˆ–èµ„æºçš„å±æ€§ã€‚ ç”¨æˆ·å¯ä»¥ç¼–è¾‘IBMå®¢æˆ·è®°å½•ä¸Šçš„åœ°å€ã€‚</li>
</ul>
<p>è·å–æ›´å¤šä¿¡æ¯:<a href="http://shiro.apache.org/permissions.html" target="_blank" rel="external">Permissions Documentation</a></p>
<h3 id="Roles-Defined"><a href="#Roles-Defined" class="headerlink" title="Roles Defined"></a>Roles Defined</h3><p>åœ¨æˆæƒçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè§’è‰²å®é™…ä¸Šæ˜¯ç”¨äºç®€åŒ–æƒé™å’Œç”¨æˆ·ç®¡ç†çš„æƒé™é›†åˆã€‚å› æ­¤ï¼Œç”¨æˆ·å¯ä»¥åˆ†é…è§’è‰²ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ†é…æƒé™ï¼Œè¿™å¯èƒ½ä¼šä½¿è¾ƒå¤§çš„ç”¨æˆ·åŸºç¡€å’Œæ›´å¤æ‚çš„åº”ç”¨ç¨‹åºå˜å¾—å¤æ‚ã€‚å› æ­¤ï¼Œä¾‹å¦‚ï¼Œé“¶è¡Œåº”ç”¨ç¨‹åºå¯èƒ½å…·æœ‰ç®¡ç†å‘˜è§’è‰²æˆ–é“¶è¡Œå‡ºçº³å‘˜è§’è‰²ã€‚</p>
<p>æœ‰2ä¸­ç±»å‹çš„è§’è‰²ä½ éœ€è¦çŸ¥é“ï¼ŒShiroåŒæ—¶ä¹Ÿæ”¯æŒã€‚</p>
<h4 id="Implicit-Rolesï¼ˆéšå¼çš„è§’è‰²ï¼‰"><a href="#Implicit-Rolesï¼ˆéšå¼çš„è§’è‰²ï¼‰" class="headerlink" title="Implicit Rolesï¼ˆéšå¼çš„è§’è‰²ï¼‰"></a>Implicit Rolesï¼ˆéšå¼çš„è§’è‰²ï¼‰</h4><p>ä»£ç ä¸­çš„è§’è‰²æ£€æŸ¥é€šå¸¸æ˜¯éšå«è§’è‰²çš„åæ˜ ã€‚ä½ å¯ä»¥æŸ¥çœ‹æ‚£è€…æ•°æ®ï¼Œå› ä¸ºä½ å…·æœ‰ç®¡ç†å‘˜è§’è‰²ã€‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªå¸æˆ·ï¼Œå› ä¸ºä½ æœ‰é“¶è¡Œå‡ºçº³å‘˜è§’è‰²ã€‚äº‹å®ä¸Šè¿™äº›åå­—çš„å­˜åœ¨å’Œè½¯ä»¶å…·ä½“èƒ½åšçš„æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚å¤§å¤šæ•°äººä»¥è¿™ç§æ–¹å¼ä½¿ç”¨è§’è‰²ã€‚è¿™æ˜¯æœ€ç®€å•çš„ï¼Œä½†å®ƒå¯ä»¥ä¸ºæ‰€æœ‰ä½†æœ€ç®€å•çš„åº”ç”¨ç¨‹åºé€ æˆå¤§é‡çš„ç»´æŠ¤å’Œç®¡ç†é—®é¢˜ã€‚</p>
<h4 id="Explicit-Rolesï¼ˆæ˜¾å¼çš„è§’è‰²ï¼‰"><a href="#Explicit-Rolesï¼ˆæ˜¾å¼çš„è§’è‰²ï¼‰" class="headerlink" title="Explicit Rolesï¼ˆæ˜¾å¼çš„è§’è‰²ï¼‰"></a>Explicit Rolesï¼ˆæ˜¾å¼çš„è§’è‰²ï¼‰</h4><p>æ˜¾å¼è§’è‰²å…·æœ‰æ˜ç¡®åˆ†é…ç»™å®ƒçš„æƒé™ï¼Œå› æ­¤æ˜¯æ˜ç¡®çš„æƒé™é›†åˆã€‚ä»£ç ä¸­çš„æƒé™æ£€æŸ¥åæ˜ äº†æ˜ç¡®çš„è§’è‰²ã€‚ä½ å¯ä»¥æŸ¥çœ‹æ‚£è€…çš„æ•°æ®ï¼Œå› ä¸ºä½ å°†æ‚£è€…æ•°æ®è§†å›¾è§†ä¸ºç®¡ç†å‘˜è§’è‰²çš„ä¸€éƒ¨åˆ†ã€‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªå¸æˆ·ï¼Œå› ä¸ºä½ æœ‰åˆ›å»ºå¸æˆ·æƒé™ä½œä¸ºä½ çš„é“¶è¡ŒæŸœå‘˜è§’è‰²çš„ä¸€éƒ¨åˆ†ã€‚ä½ å¯ä»¥æ‰§è¡Œè¿™äº›æ“ä½œï¼Œè€Œä¸æ˜¯å› ä¸ºåŸºäºå­—ç¬¦ä¸²çš„ä¸€äº›éšå¼è§’è‰²åç§°ï¼Œè€Œæ˜¯å› ä¸ºç›¸åº”æƒé™è¢«æ˜ç¡®åˆ†é…ç»™ä½ çš„è§’è‰²ã€‚</p>
<p>æ˜ç¡®è§’è‰²çš„æœ€å¤§å¥½å¤„æ˜¯æ˜“äºç®¡ç†ï¼Œé™ä½äº†åº”ç”¨ç¨‹åºçš„ç»´æŠ¤ã€‚å¦‚æœä½ éœ€è¦æ·»åŠ ï¼Œåˆ é™¤æˆ–æ›´æ”¹è§’è‰²ï¼Œåˆ™å¯ä»¥åœ¨ä¸è§¦æ‘¸æºä»£ç çš„æƒ…å†µä¸‹æ‰§è¡Œæ­¤æ“ä½œã€‚åœ¨Shiroä¸­ï¼Œä½ è¿˜å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ ï¼Œåˆ é™¤æˆ–æ›´æ”¹è§’è‰²ï¼Œå¹¶ä¸”ä½ çš„æˆæƒæ£€æŸ¥å°†å§‹ç»ˆå…·æœ‰æœ€æ–°å€¼ã€‚è¿™æ„å‘³ç€ä½ ä¸å¿…å¼ºåˆ¶ç”¨æˆ·æ³¨é”€å¹¶é‡æ–°ç™»å½•ä»¥è·å–ä»–ä»¬çš„æ–°æƒé™ã€‚</p>
<h3 id="Users-Defined"><a href="#Users-Defined" class="headerlink" title="Users Defined"></a>Users Defined</h3><p>ç”¨æˆ·å°±æ˜¯è°åœ¨ç”¨è¿™ä¸ªåº”ç”¨ç¨‹åºã€‚ç„¶è€Œï¼Œåœ¨Shiroï¼Œç”¨æˆ·çš„æ¦‚å¿µå®é™…ä¸Šæ˜¯Subjectå®ä¾‹ã€‚æˆ‘ä»¬ä½¿ç”¨Subjectè¿™ä¸ªè¯è€Œä¸æ˜¯ç”¨æˆ·ï¼Œå› ä¸ºç”¨æˆ·é€šå¸¸æ„å‘³ç€äººç±»ï¼Œè€Œåœ¨Shiroä¸­ï¼ŒSubjectå¯ä»¥ä¸ä½ çš„åº”ç”¨ç¨‹åºè¿›è¡Œä»»ä½•äº¤äº’ - æ— è®ºæ˜¯äººç±»è¿˜æ˜¯æœåŠ¡ã€‚</p>
<p>ç”¨æˆ·å°±æ˜¯å…è®¸åœ¨ä½ çš„åº”ç”¨ç¨‹åºä¸­é€šè¿‡è§’è‰²æˆ–è€…æƒé™çš„å…³è”æ‰§è¡ŒæŸäº›åŠ¨ä½œã€‚å› æ­¤ä½ å¯ä»¥æ‰“å¼€ä¸€ä¸ªå®¢æˆ·çš„è®°å½•ï¼Œå› ä¸ºä½ å·²ç»è¢«åˆ†é…äº†æ‰“å¼€å®¢æˆ·è®°å½•çš„æƒé™ï¼Œæˆ–è€…ä½ è¢«åˆ†é…äº†å¸¦æœ‰æƒé™çš„è§’è‰²ã€‚</p>
<h3 id="How-to-perform-Authorization-in-Java-with-Shiro"><a href="#How-to-perform-Authorization-in-Java-with-Shiro" class="headerlink" title="How to perform Authorization in Java with Shiro"></a>How to perform Authorization in Java with Shiro</h3><p>åœ¨Shiroä¸­æˆæƒæœ‰å››ç§ï¼š</p>
<ul>
<li>ä»¥ç¼–ç¨‹æ–¹å¼ - ä½ å¯ä»¥åœ¨javaä»£ç ä¸­æ‰§è¡Œæˆæƒæ£€æŸ¥ï¼Œå…¶ç»“æ„å¦‚ifå’Œelseã€‚</li>
<li>JDKæ³¨è§£ - ä½ å¯ä»¥å°†æˆæƒæ³¨è§£é™„åŠ åˆ°Javaæ–¹æ³•ã€‚</li>
<li>JSP / GSP TagLibs  - ä½ å¯ä»¥æ ¹æ®è§’è‰²å’Œæƒé™æ¥æ§åˆ¶jspæˆ–gspé¡µé¢è¾“å‡º</li>
</ul>
<h4 id="Programmatic-Authorization"><a href="#Programmatic-Authorization" class="headerlink" title="Programmatic Authorization"></a>Programmatic Authorization</h4><p>æ£€æŸ¥è§’è‰²å’Œæƒé™ï¼Œåœ¨ä½ çš„ä»£ç ä¸­ä½¿ç”¨ç¼–ç¨‹æ–¹å¼æ˜¯ä¸€ç§ä¼ ç»Ÿæ–¹å¼æ¥å¤„ç†æˆæƒã€‚</p>
<h5 id="Role-Check"><a href="#Role-Check" class="headerlink" title="Role Check"></a>Role Check</h5><p>è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ç¼–ç¨‹æ–¹å¼æ¥æ£€æŸ¥è§’è‰²çš„æ —å­ã€‚æˆ‘ä»¬æƒ³æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ç®¡ç†å‘˜è§’è‰²ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†æ˜¾ç¤ºä¸€ä¸ªç‰¹æ®Šçš„æŒ‰é’®ï¼Œå¦åˆ™æˆ‘ä»¬ä¸ä¼šæ˜¾ç¤ºå®ƒã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬å¾—åˆ°å½“å‰ç”¨æˆ·ï¼Œä¹Ÿå°±æ˜¯Subjectã€‚ç„¶åæˆ‘ä»¬å°†adminä¼ ç»™Subjectçš„<code>hasRole()</code>æ–¹æ³•ã€‚å®ƒä¼šè¿”å›<code>TRUE</code>æˆ–è€… <code>FALSE</code>ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//get the current Subject </span></div><div class="line">Subject currentUser = SecurityUtils.getSubject();</div><div class="line"></div><div class="line"><span class="keyword">if</span> (currentUser.hasRole(<span class="string">"administrator"</span>)) &#123;</div><div class="line">    <span class="comment">//show a special buttonâ€</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">//donâ€™t show the button?)â€</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ç°åœ¨ï¼ŒåŸºäºè§’è‰²çš„æ£€æŸ¥æ˜¯å¿«é€Ÿå’Œå®¹æ˜“å®ç°çš„ï¼Œä½†å®ƒå…·æœ‰ä¸»è¦çš„ç¼ºç‚¹ã€‚ è¿™æ˜¯éšå¼çš„ã€‚</p>
<p>å¦‚æœä½ åªæƒ³ç¨åæ·»åŠ ï¼Œåˆ é™¤æˆ–é‡æ–°å®šä¹‰è§’è‰²æ€ä¹ˆåŠï¼Ÿä½ å¿…é¡»æ‰“å¼€æºä»£ç ï¼Œå¹¶æ›´æ”¹æ‰€æœ‰è§’è‰²æ£€æŸ¥ä»¥åæ˜ ä½ çš„å®‰å…¨æ¨¡å‹çš„å˜åŒ–ã€‚ä½ å¿…é¡»å…³é—­åº”ç”¨ç¨‹åºï¼Œç ´è§£ä»£ç ï¼Œæµ‹è¯•å®ƒï¼Œç„¶åé‡æ–°å¯åŠ¨å®ƒã€‚</p>
<p>åœ¨éå¸¸ç®€å•çš„åº”ç”¨ç¨‹åºä¸­ï¼Œè¿™å¯èƒ½è¶³å¤Ÿå¥½ï¼Œä½†å¯¹äºè¾ƒå¤§çš„åº”ç”¨ç¨‹åºï¼Œè¿™å¯èƒ½æ˜¯åº”ç”¨ç¨‹åºçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­çš„ä¸»è¦é—®é¢˜ï¼Œå¹¶ä¸ºä½ çš„è½¯ä»¶å¸¦æ¥å¤§é‡ç»´æŠ¤æˆæœ¬ã€‚</p>
<h5 id="Permission-Check"><a href="#Permission-Check" class="headerlink" title="Permission Check"></a>Permission Check</h5><p>è¿™æ˜¯ä½ å¦‚ä½•é€šè¿‡æƒé™è¿›è¡Œå®‰å…¨æ£€æŸ¥çš„ç¤ºä¾‹ã€‚æˆ‘ä»¬æƒ³æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒæ‰“å°åˆ°laserjet3000nï¼Œå¦‚æœæ˜¯è¿™æ ·ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†æ˜¾ç¤ºæ‰“å°æŒ‰é’®ï¼Œå¦åˆ™æˆ‘ä»¬ä¸ä¼šæ˜¾ç¤ºã€‚è¿™æ˜¯ä¸€ä¸ªå®ä¾‹çº§æƒé™æˆ–å®ä¾‹çº§æˆæƒçš„ç¤ºä¾‹ã€‚</p>
<p>å†æ¬¡ï¼Œé¦–å…ˆä½ å¯ä»¥è®¿é—®å½“å‰çš„ç”¨æˆ·ï¼ŒSubjectã€‚ç„¶åæ„é€ ä¸€ä¸ªPermissionå¯¹è±¡æˆ–è€…å®ä¾‹æ¥è¡¨ç¤ºä¸€ä¸ªåŠ¨ä½œæˆ–è€…èµ„æºã€‚åœ¨è¿™ä¸ªæ —å­ä¸­è¿™ä¸ªå®ä¾‹å¯ä»¥å‘½åä¸ºprintPermission,èµ„æºæ˜¯laserjet3000nï¼ŒåŠ¨ä½œæ˜¯æ‰“å°ã€‚ç„¶åæˆ‘ä»¬å°†printPermissionä¼ ç»™Subjectçš„<code>.isPermitted()</code>æ–¹æ³•ã€‚å®ƒè¿”å›trueæˆ–è€…falseã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Subject currentUser = SecurityUtils.getSubject();</div><div class="line"></div><div class="line">Permission printPermission = <span class="keyword">new</span> PrinterPermission(<span class="string">"laserjet3000n"</span>,<span class="string">"print"</span>);</div><div class="line"></div><div class="line">If (currentUser.isPermitted(printPermission)) &#123;</div><div class="line">    <span class="comment">//do one thing (show the print button?)â€</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">//donâ€™t show the button?</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="Permission-Check-String-based"><a href="#Permission-Check-String-based" class="headerlink" title="Permission Check (String-based)"></a>Permission Check (String-based)</h5><p>ä½ ä¹Ÿå¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²è€Œä¸æ˜¯permissionç±»åšæƒé™æ£€æŸ¥ã€‚</p>
<p>å› æ­¤ï¼Œå¦‚æœä½ ä¸æƒ³å®ç°æˆ‘ä»¬permission æ¥å£ï¼Œä½ ä»…ä»…ä¼ ä¸€ä¸ªstringå­—ç¬¦ä¸²å°±è¡Œäº†ã€‚åœ¨è¿™ä¸ªæ —å­ä¸­ï¼Œæˆ‘ä»¬ä¼ <code>.isPermitted()</code>ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">String perm = <span class="string">"printer:print:laserjet4400n"</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span>(currentUser.isPermitted(perm))&#123;</div><div class="line">    <span class="comment">//show the print button?</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">//donâ€™t show the button?</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åªè¦ä½ çš„åŸŸçŸ¥é“å¦‚ä½•ä½¿ç”¨å®ƒï¼Œä½ å¯ä»¥æŒ‰ç…§ä½ æƒ³è¦çš„æ–¹å¼æ„å»ºæƒé™å­—ç¬¦ä¸²ã€‚åœ¨è¿™ä¸ªæ —å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Shiroçš„å¯é€‰çš„æƒé™è¯­æ³•ï¼Œ<a href="http://shiro.apache.org/permissions.html" target="_blank" rel="external"> WildCardPermissions</a>.WildCardPermissionsåŠŸèƒ½å¼ºå¤§ç›´è§‚ã€‚</p>
<p>é€šè¿‡ä½¿ç”¨åŸºäºå­—ç¬¦ä¸²çš„æƒé™æ£€æŸ¥ï¼Œä½ å¯ä»¥è·å¾—çš„åŠŸèƒ½å’Œä¹‹å‰çš„æ —å­æ˜¯ä¸€æ ·çš„ã€‚å¥½å¤„æ˜¯ä½ ä¸å¿…å¼ºåˆ¶å®ç°æƒé™æ¥å£ï¼Œä½ å¯ä»¥é€šè¿‡ç®€å•çš„å­—ç¬¦ä¸²æ„é€ æƒé™ã€‚ç¼ºç‚¹æ˜¯ä½ æ²¡æœ‰ç±»å‹å®‰å…¨ï¼Œå¦‚æœä½ éœ€è¦æ›´å¤æ‚çš„è®¸å¯æƒé™ï¼Œè¿™äº›æƒé™è¶…å‡ºäº†è¿™ä¸ªå¤„ç†çš„èŒƒå›´ã€‚æ¥ä¸‹æ¥è®²å¦‚ä½•åŸºäºPermissionæ¥å£å®ç°æƒé™å¯¹è±¡ã€‚</p>
<h4 id="Annotation-Authorization"><a href="#Annotation-Authorization" class="headerlink" title="Annotation Authorization"></a>Annotation Authorization</h4><p>å¦‚æœä½ ä¸æƒ³åœ¨ä»£ç å±‚åšæƒé™æ§åˆ¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨Javaæ³¨è§£ã€‚Shiroæä¾›å¾ˆå¤šæ³¨è§£å¯ä»¥è®©ä½ æ”¾åœ¨æ–¹æ³•ä¸Šé¢ã€‚</p>
<h5 id="Enabling-Annotation-Support"><a href="#Enabling-Annotation-Support" class="headerlink" title="Enabling Annotation Support"></a>Enabling Annotation Support</h5><p>åœ¨ä½ ä½¿ç”¨Javaæ³¨è§£ä¹‹å‰ï¼Œä½ éœ€è¦åœ¨ä½ çš„åº”ç”¨ä¸­å¼€å¯AOPæ”¯æŒã€‚æœ‰å¾ˆå¤šä¸åŒçš„AOPæ¡†æ¶ï¼Œå› æ­¤ä¸å¹¸çš„æ˜¯ï¼Œåœ¨åº”ç”¨ä¸­æ²¡æœ‰ä¸€ä¸ªæ ‡å‡†çš„æ–¹å¼å¼€å¯AOPã€‚</p>
<p>å¯¹AspectJè€Œè¨€ï¼Œçœ‹æ —å­<a href="https://github.com/apache/shiro/tree/master/samples/aspectj" target="_blank" rel="external">AspectJ sample application</a></p>
<p>å¯¹Springè€Œè¨€ï¼Œçœ‹æ —å­<a href="http://shiro.apache.org/spring.html" target="_blank" rel="external"> Spring Integration </a></p>
<p>å¯¹Guiceè€Œè¨€ï¼Œçœ‹æ —å­<a href="http://shiro.apache.org/guice.html" target="_blank" rel="external"> Guice Integration</a></p>
<h5 id="Permission-Check-1"><a href="#Permission-Check-1" class="headerlink" title="Permission Check"></a>Permission Check</h5><p>åœ¨è¿™ä¸ªæ —å­ä¸­ï¼Œæˆ‘ä»¬æƒ³æ£€æŸ¥ä¸€ä¸ªç”¨æˆ·åœ¨è°ƒç”¨<code>openAccount</code>æ–¹æ³•ä¹‹å‰æ˜¯å¦æœ‰<code>account:create</code>æƒé™ã€‚å¦‚æœæœ‰ï¼ŒæŒ‰ç…§æœŸæœ›çš„è°ƒç”¨ï¼Œå¦‚æœæ²¡å¾—ï¼Œé‚£å°±æŠ›å¼‚å¸¸ã€‚</p>
<p>å’Œé€šè¿‡ç¼–ç¨‹æ–¹å¼æ£€æŸ¥æƒé™ä¸€æ ·ï¼Œä½ å¯ä»¥ä½¿ç”¨Permissionå¯¹è±¡æˆ–è€…ç®€å•çš„å­—ç¬¦ä¸²æ–¹å¼ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Will throw an AuthorizationException if none</span></div><div class="line"><span class="comment">//of the callerâ€™s roles imply the Account</span></div><div class="line"><span class="comment">//'create' permission</span></div><div class="line"><span class="meta">@RequiresPermissions</span>(<span class="string">"account:create"</span>)â€</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openAccount</span><span class="params">( Account acct )</span> </span>&#123;</div><div class="line">    <span class="comment">//create the account</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="Role-Check-1"><a href="#Role-Check-1" class="headerlink" title="Role Check"></a>Role Check</h5><p>åœ¨è¿™ä¸ªæ —å­ä¸­ï¼Œæˆ‘ä»¬æƒ³æ£€æŸ¥ä¸€ä¸ªç”¨æˆ·åœ¨æ‰§è¡Œ<code>openAccount</code>æ–¹æ³•å‰æ˜¯å¦æœ‰<code>teller</code>è§’è‰²ã€‚å¦‚æœæœ‰å°±æŒ‰ç…§æœŸæœ›çš„èµ°ä¸‹å»ï¼Œæ²¡æœ‰å°±æŠ›å¼‚å¸¸ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Throws an AuthorizationException if the caller</span></div><div class="line"><span class="comment">//doesnâ€™t have the â€˜tellerâ€™ role:</span></div><div class="line"><span class="meta">@RequiresRoles</span>( <span class="string">"teller"</span> )</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openAccount</span><span class="params">( Account acct )</span> </span>&#123;</div><div class="line">    <span class="comment">//do something in here that only a teller</span></div><div class="line">    <span class="comment">//should do</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="JSP-TagLib-Authorization"><a href="#JSP-TagLib-Authorization" class="headerlink" title="JSP TagLib Authorization"></a>JSP TagLib Authorization</h4><p>å¯¹äºåŸºäºJSP / GSPçš„Webåº”ç”¨ç¨‹åºï¼ŒShiroè¿˜æä¾›äº†ä¸€ä¸ªæ ‡ç­¾åº“ä¾›æ‚¨ä½¿ç”¨ã€‚</p>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†å‘ç”¨æˆ·æ˜¾ç¤ºuser:manageæƒé™,ä¸€ä¸ªæŒ‡å‘â€œç®¡ç†ç”¨æˆ·â€é¡µé¢çš„é“¾æ¥ã€‚å¦‚æœä»–ä»¬æ²¡æœ‰æƒé™ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šç»™ä»–ä»¬ä¸€ä¸ªå‹å¥½çš„æ¶ˆæ¯æç¤ºã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å°†Shiro taglibæ·»åŠ åˆ°æˆ‘ä»¬çš„Webåº”ç”¨ç¨‹åºä¸­ã€‚æ¥ç€æˆ‘ä»¬ä¸ºuser:manageæƒé™æ·»åŠ <shiro:haspermission>æ ‡ç­¾ã€‚åœ¨<shiroï¼šhaspermission>æ ‡ç­¾ä¸­ï¼Œå¦‚æœç”¨æˆ·å…·æœ‰æˆ‘ä»¬æ­£åœ¨æ£€æŸ¥çš„æƒé™ï¼Œæˆ‘ä»¬å°±æ”¾ç½®è¦æ‰§è¡Œçš„ä»£ç ã€‚å¦‚æœæˆ‘ä»¬è¦æ‰§è¡Œä¸€ä¸ªåŠ¨ä½œå‡å¦‚è¿™ä¸ªç”¨æˆ·ç¼ºå°‘æƒé™ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ <shiro:lackspermission> æ ‡ç­¾ï¼Œå†æ¬¡æ£€æŸ¥users:manageæƒé™ã€‚å¦‚æœç”¨æˆ·ç¼ºå°‘æƒé™ï¼Œæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„ä»»ä½•ä»£ç éƒ½éœ€è¦æ”¾åœ¨<shiroï¼šlackspermission>æ ‡ç­¾ä¸­ã€‚<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">taglib</span> <span class="attr">prefix</span>=<span class="string">"shiro"</span> <span class="attr">uri</span>=<span class="string">http://shiro.apache.org/tags</span> %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:hasPermission</span> <span class="attr">name</span>=<span class="string">"users:manage"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"manageUsers.jsp"</span>&gt;</span></div><div class="line">            Click here to manage users</div><div class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">shiro:hasPermission</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:lacksPermission</span> <span class="attr">name</span>=<span class="string">"users:manage"</span>&gt;</span></div><div class="line">        No user management for you!</div><div class="line">    <span class="tag">&lt;/<span class="name">shiro:lacksPermission</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></shiroï¼šlackspermission></shiro:lackspermission></shiroï¼šhaspermission></shiro:haspermission></p>
<p>å½“ç„¶ï¼Œè¿˜æœ‰ç”¨äºæ£€æŸ¥è§’è‰²å’Œå…¶ä»–ç”¨æˆ·æ•°æ®å’ŒçŠ¶æ€çš„æ ‡ç­¾ã€‚</p>
<p>æœ‰å…³JSP / GSPæ ‡ç­¾çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹JSPæ ‡ç­¾åº“ï¼Œä»¥åŠæœ‰å…³å°†åº”ç”¨ç¨‹åºé›†æˆåˆ°Webåº”ç”¨ç¨‹åºä¸­çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»<a href="http://shiro.apache.org/web.html" target="_blank" rel="external">Webé›†æˆæ–‡æ¡£</a>.</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æˆæƒæˆ–è€…è¯´è®¿é—®æ§åˆ¶æŒ‡çš„æ˜¯ä¸ºèµ„æºåˆ†é…è®¿é—®æƒé™ã€‚æ¢å¥è¯è¯´å°±æ˜¯è°èƒ½å¹²ä»€ä¹ˆã€‚&lt;/p&gt;
&lt;p&gt;ä¸¾ä¸ªæˆæƒçš„æ —å­ï¼šç”¨æˆ·å…è®¸çœ‹ç½‘é¡µã€æ”¹æ•°æ®ã€çœ‹æŒ‰é’®æˆ–è€…æ‰“å°å—ï¼Ÿè¿™äº›éƒ½èƒ½å†³å®šç”¨æˆ·èƒ½ä¸èƒ½åšä»€ä¹ˆã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Apache" scheme="http://www.wei-dong.top/categories/Apache/"/>
    
    
      <category term="Apache Shiro" scheme="http://www.wei-dong.top/tags/Apache-Shiro/"/>
    
      <category term="ç¿»è¯‘" scheme="http://www.wei-dong.top/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>Application Security With Apache Shiro[è¯‘]</title>
    <link href="http://www.wei-dong.top/2017/09/21/Application%20Security%20With%20Apache%20Shiro%5B%E8%AF%91%5D/"/>
    <id>http://www.wei-dong.top/2017/09/21/Application Security With Apache Shiro[è¯‘]/</id>
    <published>2017-09-21T04:41:23.000Z</published>
    <updated>2017-09-21T04:46:02.000Z</updated>
    
    <content type="html"><![CDATA[<p>å½“ä½ ä¸ºä½ çš„åº”ç”¨æ·»åŠ å®‰å…¨æªæ–½çš„æ—¶å€™æœ‰æ²¡æœ‰è§‰å¾—å¾ˆå—æŒ«ï¼Ÿä½ æœ‰æ²¡æœ‰è§‰å¾—Javaåœ¨å®‰å…¨è¿™ä¸€å—çš„è§£å†³æ–¹æ¡ˆç”¨èµ·æ¥å¾ˆéš¾ï¼Œè®©ä½ æ›´åŠ è§‰å¾—å›°æƒ‘ï¼Ÿè¿™ç¯‡æ–‡ç« ä»‹ç»<a href="http://shiro.apache.org/" target="_blank" rel="external">Apache Shiro</a>,ä¸€ä¸ªç®€å•åˆå¼ºå¤§ä¸ºä½ åº”ç”¨æä¾›å®‰å…¨çš„Javaæ¡†æ¶ã€‚æœ¬æ–‡å¯¹Apache Shiroçš„æ„¿æ™¯ã€æ¶æ„è®¾è®¡åŠæ€æ ·å»ä½¿ç”¨Shiroæ¥ä¿æŠ¤ä½ çš„åº”ç”¨è¿›è¡Œè§£é‡Šã€‚</p>
<h3 id="Apache-Shiroæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Apache-Shiroæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Apache Shiroæ˜¯ä»€ä¹ˆï¼Ÿ"></a>Apache Shiroæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>Apache Shiroï¼ˆå‘éŸ³ä¸ºâ€œæ­‡è‚‰â€ï¼Œåœ¨æ—¥æœ¬çš„å‘éŸ³æ˜¯åŸå ¡çš„æ„æ€ï¼‰æ˜¯ä¸€ä¸ªå¼ºå¤§åˆå¥½ç”¨çš„Javaå®‰å…¨æ¡†æ¶ï¼Œå®ƒæä¾›è®¤è¯ã€æˆæƒã€åŠ å¯†å’Œä¼šè¯ç®¡ç†ï¼Œå®ƒå¯ä»¥è¢«ç”¨åœ¨ä¿æŠ¤ä»»ä½•åº”ç”¨â€“ä»å‘½ä»¤è¡Œåº”ç”¨ã€ç§»åŠ¨åº”ç”¨åˆ°å¤§å‹çš„webä¼ä¸šçº§åº”ç”¨ã€‚</p>
<p>Shiroä¸ºä»¥ä¸‹å‡ ä¸ªæ–¹é¢æä¾›åº”ç”¨å®‰å…¨çš„APIã€‚</p>
<ul>
<li>è®¤è¯-è¯æ˜ç”¨æˆ·èº«ä»½ï¼Œé€šå¸¸å«åšç™»å½•</li>
<li>æˆæƒ-è®¿é—®æ§åˆ¶</li>
<li>åŠ å¯†-ä¿æŠ¤æˆ–éšè—æ•°æ®ä¸è¢«çª¥è§†</li>
<li>ä¼šè¯ç®¡ç†-æ¯ä¸ªç”¨æˆ·çš„çŠ¶æ€æ˜¯å¯¹æ—¶é—´æ•æ„Ÿçš„</li>
</ul>
<p>Shiroè¿˜æä¾›è¾…åŠ©çš„ç‰¹æ€§ï¼Œæ¯”å¦‚è¯´webå®‰å…¨ï¼Œå•å…ƒæµ‹è¯•ï¼Œå’Œå¤šçº¿ç¨‹çš„æ”¯æŒã€‚è¿™äº›éƒ½æ˜¯ä¸ºäº†åŠ å¼ºä¸Šé¢æåˆ°çš„å‡ ä¸ªç‰¹æ€§ã€‚</p>
<h3 id="Apache-Shiroä¸ºä»€ä¹ˆè¢«å‘æ˜ï¼Ÿ"><a href="#Apache-Shiroä¸ºä»€ä¹ˆè¢«å‘æ˜ï¼Ÿ" class="headerlink" title="Apache Shiroä¸ºä»€ä¹ˆè¢«å‘æ˜ï¼Ÿ"></a>Apache Shiroä¸ºä»€ä¹ˆè¢«å‘æ˜ï¼Ÿ</h3><p>å¯¹äºä¸€ä¸ªæ¡†æ¶è€Œè¨€ï¼Œå®ƒå­˜åœ¨çš„æ„ä¹‰å°±æ˜¯å®ƒæ»¡è¶³ä½ çš„éœ€æ±‚è€Œæ‰¾ä¸åˆ°å…¶ä»–çš„æ›¿ä»£æ–¹æ¡ˆã€‚ä¸ºäº†ç†è§£è¿™äº›ä¸œè¥¿ï¼Œæˆ‘ä»¬æœ‰å¿…è¦ç¿»ä¸€ç•ªShiroçš„å†å²ä»¥åŠå½“æ—¶çš„æ›¿ä»£å“ã€‚</p>
<p>åœ¨2008å¹´åŠ å…¥ASFä¹‹å‰ï¼ŒShiroéƒ½5å²äº†ï¼Œè€Œä¸”å’Œæ—©åœ¨2003å¹´å¼€å§‹çš„JSecurityä¸€æ ·æœ‰åäº†ã€‚åœ¨2003å¹´ï¼Œæ²¡æœ‰å¤ªå¤šä¸ºJavaå¼€å‘è€…æä¾›å¯é€‰çš„å®‰å…¨æ–¹æ¡ˆã€‚æˆ‘ä»¬åšæŒä½¿ç”¨Javaè®¤è¯å’ŒJavaæˆæƒæœåŠ¡ï¼Œç§°ä½œJAASã€‚ç„¶è€ŒJASSæœ‰å¾ˆå¤šç¼ºç‚¹å½“ç„¶è®¤è¯èƒ½åŠ›æ˜¯å¯ä»¥æ¥å—çš„ï¼Œæˆæƒæ–¹é¢è®©äººç”¨èµ·æ¥è§‰å¾—å¾ˆå´©æºƒã€‚JAASå’ŒJVMçº§åˆ«çš„å®‰å…¨å¯†åˆ‡ç›¸å…³ï¼Œæ¯”æ–¹è¯´å†³å®šä¸€ä¸ªclassè¯¥ä¸è¯¥è¢«åŠ è½½åˆ°JVMã€‚ä½œä¸ºä¸€ä¸ªåº”ç”¨å¼€å‘è€…ï¼Œæˆ‘æ›´å…³å¿ƒçš„æ˜¯åº”ç”¨ç¨‹åºç”¨æˆ·èƒ½åšä»€ä¹ˆï¼Œè€Œä¸æ˜¯æˆ‘çš„ä»£ç åœ¨JVMé‡Œèƒ½åšä»€ä¹ˆã€‚</p>
<p>ç”±äºæˆ‘å½“æ—¶ç€æ‰‹çš„å·¥ä½œï¼Œæˆ‘éœ€è¦ä¸€ä¸ªå¹²å‡€çš„å’Œå®¹å™¨æ— å…³çš„ä¼šè¯æœºåˆ¶ã€‚å½“æ—¶åœ¨æ¸¸æˆï¼ˆæˆ‘çŒœä½œè€…çš„å·¥ä½œå°±æ˜¯å†™æ¸¸æˆï¼‰ä¸­å”¯ä¸€çš„é€‰æ‹©å°±æ˜¯HttpSessionï¼Œè¿™ä¸ªç©æ„éœ€è¦ä¸€ä¸ªwebå®¹å™¨æˆ–è€…EJBå®¹å™¨ã€‚æˆ‘éœ€è¦çš„æ˜¯èƒ½å¤Ÿä»å®¹å™¨ä¸­è§£è€¦ï¼Œè€Œä¸”åœ¨ä»»ä½•ç¯å¢ƒä¸‹éƒ½å¥½ç”¨çš„ã€‚</p>
<p>æœ€åæœ‰ä¸€ä¸ªå¯†ç çš„é—®é¢˜ã€‚æœ‰å¾ˆå¤šæƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦åŠ å¯†æ•°æ®ï¼Œä½†æ˜¯JavaåŠ å¯†æ¶æ„é™¤äº†å¯†ç ä¸“å®¶å¤–æ™®é€šäººå¾ˆéš¾ç†è§£ã€‚å®ƒçš„APIåˆ°å¤„éƒ½æ˜¯å¼‚å¸¸æ£€æŸ¥ï¼Œç”¨èµ·æ¥æ„Ÿè§‰å¾ˆç¬¨é‡ã€‚æˆ‘è¿«åˆ‡å¸Œæœ›ä¸€ä¸ªå¹²å‡€çš„å¼€ç®±å³ç”¨çš„å¯ä»¥æ»¡è¶³æˆ‘çš„éœ€æ±‚çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<p>çœ‹äº†ä¸€ä¸‹åœ¨2003å¹´æ—©æœŸçš„å®‰å…¨æ¦‚å†µï¼Œä½ èƒ½å¾ˆå¿«çš„æ„è¯†åˆ°æ²¡æœ‰ä¸€æ¬¾å•ä¸€çš„æ¡†æ¶èƒ½å¤Ÿæ»¡è¶³è¿™äº›éœ€æ±‚ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼ŒJSecurityè¿˜æœ‰åæ¥çš„Shiroè¯ç”Ÿäº†ã€‚</p>
<h3 id="å¦‚ä»Šä½ ä¸ºä½•ç”¨Apache-Shiro"><a href="#å¦‚ä»Šä½ ä¸ºä½•ç”¨Apache-Shiro" class="headerlink" title="å¦‚ä»Šä½ ä¸ºä½•ç”¨Apache Shiro?"></a>å¦‚ä»Šä½ ä¸ºä½•ç”¨Apache Shiro?</h3><p>è‡ª2003å¹´æ¥ï¼Œæ¡†æ¶çš„æ ¼å±€å‘ç”Ÿäº†å¾ˆå¤§çš„å˜åŒ–ï¼Œå› æ­¤ç°åœ¨æœ‰ä¸€ä¸ªè®©äººä¿¡æœçš„ç†ç”±æ¥ä½¿ç”¨Shiroã€‚ç†ç”±å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¥½ç”¨â€“å¥½ç”¨æ˜¯ä¸€ä¸ªé¡¹ç›®æœ€å…³é”®çš„ç›®æ ‡ã€‚åº”ç”¨å®‰å…¨å¯èƒ½æ˜¯éå¸¸è®©äººæ²®ä¸§å’Œå›°æƒ‘ï¼Œå› æ­¤è¢«ç§°ä½œâ€œå¿…è¦çš„ç½ªæ¶â€ã€‚å‡å¦‚ä½ è®©å®ƒå˜å¾—æ–°æ‰‹ç¨‹åºå‘˜éƒ½å®¹æ˜“ä½¿ç”¨ï¼Œé‚£å°±ä¸é‚£ä¹ˆç—›è‹¦äº†ã€‚</li>
<li>å…¨é¢â€“æ²¡æœ‰æ¯”Shiroæ›´å¹¿æ³›çš„å®‰å…¨æ¡†æ¶äº†ï¼Œå› æ­¤å®ƒå¯ä»¥ä¸€ç«™å¼æ»¡è¶³ä½ å¯¹å®‰å…¨çš„éœ€è¦ã€‚</li>
<li>çµæ´»â€“Shiroèƒ½åœ¨ä»»ä½•ç¯å¢ƒä¸‹å·¥ä½œã€‚è™½ç„¶å®ƒåœ¨webã€EJBã€å’ŒioCå®¹å™¨ä¸­å·¥ä½œï¼Œä½†æ˜¯å®ƒä¸ä¾èµ–ä»–ä»¬ã€‚Shiroæ²¡æœ‰å¤ªå¤šçš„è§„å®šï¼Œä¹Ÿæ²¡æœ‰å¤ªå¤šçš„ä¾èµ–ã€‚</li>
<li>æ”¯æŒwebâ€“Shiroå¯¹webåº”ç”¨æœ‰å…¨é¢çš„æ”¯æŒï¼Œä½ å¯ä»¥åˆ›å»ºåŸºäºwebåè®®å’Œurlçš„çµæ´»çš„å®‰å…¨ç­–ç•¥ï¼ŒåŒæ—¶æä¾›ä¸€å¥—æ§åˆ¶é¡µé¢è¾“å‡ºçš„JSPåº“ã€‚</li>
<li>å¯æ’æ‹”â€“Shiroå¹²å‡€çš„APIï¼ˆå¹²å‡€å¯ä»¥ç¿»è¯‘ä¸ºç®€æ´ï¼‰å’Œè®¾è®¡æ€æƒ³å¯ä»¥è®©ä½ å¾ˆå®¹æ˜“åœ°é›†æˆåˆ°å…¶ä»–æ¡†æ¶å’Œåº”ç”¨ã€‚ä½ å¯ä»¥çœ‹åˆ°Shiroå’ŒSpringã€Grailsç­‰æ¡†æ¶æ— ç¼é›†æˆã€‚</li>
<li>æ”¯æŒâ€“Shiroæ˜¯ASFçš„ä¸€éƒ¨åˆ†ã€‚è¿™ä¸ªé¡¹ç›®çš„å¼€å‘å’Œç”¨æˆ·ç¾¤ä¼šå‹å¥½çš„æä¾›å¸®åŠ©ã€‚å¦‚æœéœ€è¦ï¼Œåƒ<a href="https://stormpath.com/" target="_blank" rel="external">Katasoft</a>å•†ä¸šå…¬å¸ä¹Ÿä¼šæä¾›ä¸“ä¸šçš„æ”¯æŒå’ŒæœåŠ¡ã€‚</li>
</ul>
<h3 id="è°åœ¨ç”¨Shiroï¼Ÿ"><a href="#è°åœ¨ç”¨Shiroï¼Ÿ" class="headerlink" title="è°åœ¨ç”¨Shiroï¼Ÿ"></a>è°åœ¨ç”¨Shiroï¼Ÿ</h3><p>Shiroå’Œå®ƒçš„å…ˆé©±JSecurityåœ¨å¾ˆå¤šè¡Œä¸šå¾ˆå¤šå…¬å¸çš„é¡¹ç›®ä¸­ç”¨äº†å¾ˆå¤šå¹´ã€‚åœ¨æˆä¸ºASFé¡¶çº§é¡¹ç›®ä¹‹åï¼Œå®ƒçš„ç½‘ç«™æµé‡å’Œä½¿ç”¨ç‡å¤§å¢ã€‚ä¹Ÿæœ‰è®¸å¤šå¼€æºçš„ç»„ç»‡ä½¿ç”¨Shiroï¼Œæ¯”æ–¹è¯´Spring, Grails, Wicket, Tapestry, Tynamo, Mule, å’Œ Vaadinã€‚</p>
<p>å•†ä¸šå…¬å¸åƒKatasoftã€Sonatypeã€MuleSoftç­‰ä¹Ÿä½¿ç”¨Shiroæ¥ä¿æŠ¤ä»–ä»¬çš„å•†ä¸šè½¯ä»¶å’Œç½‘ç«™ã€‚</p>
<h3 id="æ ¸å¿ƒæ¦‚å¿µï¼šä¸»ä½“ï¼Œå®‰å…¨ç®¡ç†å™¨ï¼ŒåŸŸ"><a href="#æ ¸å¿ƒæ¦‚å¿µï¼šä¸»ä½“ï¼Œå®‰å…¨ç®¡ç†å™¨ï¼ŒåŸŸ" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µï¼šä¸»ä½“ï¼Œå®‰å…¨ç®¡ç†å™¨ï¼ŒåŸŸ"></a>æ ¸å¿ƒæ¦‚å¿µï¼šä¸»ä½“ï¼Œå®‰å…¨ç®¡ç†å™¨ï¼ŒåŸŸ</h3><p>ç›®å‰æˆ‘ä»¬è®²äº†Shiroçš„ä¼˜ç‚¹ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹çœ‹å®ƒçš„APIï¼Œè®©ä½ ç›´æ¥æ„Ÿå—å®ƒã€‚Shiroçš„æ¶æ„æœ‰3ä¸ªæ ¸å¿ƒçš„æ¦‚å¿µâ€“ä¸»ä½“ã€å®‰å…¨ç®¡ç†å™¨å’ŒåŸŸã€‚</p>
<h4 id="Subject-ä¸»ä½“"><a href="#Subject-ä¸»ä½“" class="headerlink" title="Subject(ä¸»ä½“)"></a>Subject(ä¸»ä½“)</h4><p>å½“ä½ è¦å¯¹ä½ çš„åº”ç”¨è¿›è¡Œä¿æŠ¤çš„æ—¶å€™ï¼Œä½ æœ€å¤§çš„å¯èƒ½è¦é—®çš„é—®é¢˜å°±æ˜¯â€œå½“å‰ç”¨æˆ·æ˜¯è°ï¼Ÿâ€æˆ–è€…â€œå½“å‰ç”¨æˆ·å…è®¸åšè¿™ä»¶äº‹å—ï¼Ÿâ€ï¼Œæˆ‘ä»¬é—®è‡ªå·±è¿™äº›é—®é¢˜æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œå°±åƒæˆ‘ä»¬åœ¨å†™ä»£ç æˆ–è€…è®¾è®¡æ¥å£ä¸€æ ·ã€‚åº”ç”¨ç¨‹åºé€šå¸¸æ˜¯åŸºäºç”¨æˆ·æ•…äº‹æ¥æ„å»ºï¼Œè€Œä¸”ä½ æƒ³åŸºäºæ¯ä¸ªç”¨æˆ·æ¥æ„å»ºä½ çš„åŠŸèƒ½ã€‚å› æ­¤ï¼Œä½ è€ƒè™‘åœ¨ä½ åº”ç”¨å®‰å…¨æœ€å¸¸è§„çš„æ€è·¯å°±æ˜¯åŸºäºå½“å‰ç”¨æˆ·ã€‚Shiro APIä¸­çš„ä¸»ä½“æ¦‚å¿µåŸºæœ¬ä¸Šä½“ç°äº†è¿™ç§æ€è·¯ã€‚</p>
<p>ä¸»ä½“æ˜¯å®‰å…¨æœ¯è¯­ä¸­çš„ä¸€ä¸ªåè¯ï¼Œä»£è¡¨çš„æ˜¯å½“å‰æ‰§è¡Œçš„ç”¨æˆ·ã€‚ä¸èƒ½ä»…ä»…åªç§°ä½œâ€œç”¨æˆ·â€å› ä¸ºâ€œç”¨æˆ·â€è¿™ä¸ªè¯é€šå¸¸å’Œäººç±»å…³è”èµ·æ¥ã€‚åœ¨å®‰å…¨é¢†åŸŸï¼Œä¸»ä½“è¿™ä¸ªè¯å¯ä»¥ä»£è¡¨ä¸€ä¸ªäººï¼Œä¹Ÿå¯ä»¥ä»£è¡¨ç¬¬ä¸‰æ–¹è¿›ç¨‹ã€ä¸€ä¸ªåå°è´¦å·æˆ–è€…ç±»ä¼¼çš„ä¸œè¥¿ã€‚ç®€å•æ¥è®²ï¼Œå°±æ˜¯å’Œå½“å‰è½¯ä»¶äº¤äº’çš„ä¸œè¥¿ã€‚ç„¶è€Œå¯¹äºå¤§å¤šæ•°ç›®çš„å’Œç”¨é€”ï¼Œä½ å¯ä»¥æŠŠå®ƒå½“åšShiroç”¨æˆ·çš„æ¦‚å¿µã€‚ä½ èƒ½å¾ˆå®¹æ˜“åœ°åœ¨ä½ çš„ä»£ç ä¸­è·å–Shiroçš„ä¸»ä½“ï¼Œä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">import org.apache.shiro.subject.Subject;</div><div class="line">import org.apache.shiro.SecurityUtils;</div><div class="line">...</div><div class="line">Subject currentUser = SecurityUtils.getSubject();</div></pre></td></tr></table></figure></p>
<p>ä¸€æ—¦ä½ è·å–äº†ä¸»ä½“ï¼Œä½ å°±èƒ½ä½¿ç”¨Shiroä¸ºå½“å‰ç”¨æˆ·æ‹¿åˆ°90%çš„è®¿é—®æƒé™ï¼Œæ¯”å¦‚ç™»å½•ï¼Œé€€å‡ºç™»å½•ï¼Œè·å–sessionï¼Œæ‰§è¡Œæƒé™æ£€æŸ¥ç­‰ã€‚è¿™é‡Œå…³é”®ç‚¹æ˜¯Shiroçš„APIå¤§ä½“ä¸Šæ˜¯å¾ˆç›´è§‚çš„ï¼Œä»ä¸­å¯ä»¥ä½“ç°å¼€å‘è€…åœ¨é’ˆå¯¹æ¯ä¸ªç”¨æˆ·çš„å®‰å…¨æ§åˆ¶ä¸­çš„æ€è·¯ï¼ˆè¿™å¥è¯å®åœ¨æ˜¯ä¸çŸ¥é“æ€ä¹ˆç¿»è¯‘ï¼‰ã€‚åœ¨ä»£ç ä¸­ä»»ä½•åœ°æ–¹è·å–ä¸»ä½“å¾ˆå®¹æ˜“ï¼Œåœ¨éœ€è¦è¿›è¡Œå®‰å…¨æ“ä½œçš„åœ°æ–¹è¿›è¡Œæ§åˆ¶ä¹Ÿå¾ˆå®¹æ˜“ã€‚</p>
<h4 id="SecurityManager-å®‰å…¨ç®¡ç†å™¨"><a href="#SecurityManager-å®‰å…¨ç®¡ç†å™¨" class="headerlink" title="SecurityManager(å®‰å…¨ç®¡ç†å™¨)"></a>SecurityManager(å®‰å…¨ç®¡ç†å™¨)</h4><p>åœ¨ä¸»ä½“èƒŒååä¸ä¹‹é…å¯¹çš„æ˜¯å®‰å…¨ç®¡ç†å™¨ã€‚ä¸»ä½“æä¾›å½“å‰ç”¨æˆ·çš„å®‰å…¨æ“ä½œï¼Œç„¶è€Œå®‰å…¨ç®¡ç†å™¨ä¸ºæ‰€æœ‰ç”¨æˆ·ç®¡ç†ç€å®‰å…¨æ“ä½œã€‚è¿™æ˜¯Shiroæ¶æ„çš„æ ¸å¿ƒï¼Œæœ‰ç±»ä¼¼äºå¾ˆå¤šâ€œä¼â€çš„ä½œç”¨ã€‚è¿™äº›ä¼å†…éƒ¨å¼•ç”¨äº†å¾ˆå¤šåµŒå¥—çš„å®‰å…¨ç»„ä»¶è€Œå½¢æˆä¸€ä¸ªä¼å›¾ï¼ˆç¿»è¯‘å¾ˆæ™¦æ¶©ï¼Œæ„æ€å°±æ˜¯å¾ˆå¤šç»„ä»¶ç»„åˆè€Œæˆï¼‰ã€‚ç„¶è€Œï¼Œä¸€æ—¦å®‰å…¨ç®¡ç†å™¨åŠå†…éƒ¨çš„â€œä¼å›¾â€é…ç½®å¥½äº†ï¼Œåº”ç”¨å¼€å‘è€…å‡ ä¹å°†æ‰€æœ‰æ—¶é—´éƒ½èŠ±åœ¨äº†ä¸»ä½“APIä¸Šï¼Œé€šå¸¸è¿™ä¸ªå®‰å…¨ç®¡ç†å™¨æ˜¯ç‹¬ç«‹çš„ã€‚</p>
<p>åœ¨æ¯ä¸€ä¸ªåº”ç”¨ä¸­æ€»æœ‰ä¸€ä¸ªå®‰å…¨ç®¡ç†å™¨å®ä¾‹ã€‚æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå•ä¾‹åº”ç”¨ï¼ˆè™½ç„¶ä¸å¿…æ˜¯é™æ€å•ä¾‹ï¼‰ã€‚åƒShiroä¸­å…¶ä»–ä¸œè¥¿ä¸€æ ·ï¼Œé»˜è®¤çš„å®‰å…¨ç®¡ç†å™¨çš„å®ç°æ˜¯POJOï¼Œå¯ä»¥é€šè¿‡ä»»ä½•ä¸POJOå…¼å®¹çš„é…ç½®æœºåˆ¶â€“æ™®é€šçš„Javaä»£ç ã€Spring XMLã€YAMLã€.propertieså’Œiniæ–‡ä»¶ç­‰ç­‰ã€‚é€šå¸¸æ¥è®²ï¼Œèƒ½å¤Ÿè¢«å®ä¾‹åŒ–çš„ç±»å’Œèƒ½å¤Ÿè°ƒç”¨JavaBeanå…¼å®¹æ–¹æ³•çš„éƒ½å¯ä»¥ä½¿ç”¨ã€‚</p>
<p>ä¸ºæ­¤ï¼ŒShiroå€ŸåŠ©åŸºäºæ–‡æœ¬çš„INIé…ç½®æä¾›äº†ä¸€ä¸ªç¼ºçœçš„â€œå…¬å…±â€è§£å†³æ–¹æ¡ˆã€‚INIè¯»èµ·æ¥å¾ˆå®¹æ˜“ï¼Œç”¨èµ·æ¥å¾ˆç®€å•ï¼Œè€Œä¸”ä¾èµ–çš„ä¸œè¥¿ä¹Ÿå¾ˆå°‘ã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ç®€å•äº†è§£å¯¹è±¡å›¾å¯¼èˆªï¼ŒINIå¯ä»¥å¾ˆé«˜æ•ˆçš„é…ç½®ç®€å•çš„å¯¹è±¡å›¾,åƒSecurityManagerã€‚æ³¨æ„Shiroä¹Ÿæ”¯æŒSpring XMLé…ç½®åˆå…¶ä»–æ›¿ä»£å“ã€‚æˆ‘ä»¬è¿™é‡Œåªè°ˆINIã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[main]</div><div class="line">cm = org.apache.shiro.authc.credential.HashedCredentialsMatcher</div><div class="line">cm.hashAlgorithm = SHA-512</div><div class="line">cm.hashIterations = 1024</div><div class="line">#Base64 encoding (less text):</div><div class="line">cm.storedCredentialsHexEncoded = false</div><div class="line">iniRealm.credentialsMatcher = $cm</div><div class="line">[users]</div><div class="line">jdoe = TWFuIGlzIGRpc3Rpbmd1aXNoZWQsIG5vdCBvbmx5IGJpcyByZWFzb2</div><div class="line">asmith = IHNpbmd1bGFyIHBhc3Npb24gZnJvbSBvdGhlciBhbXNoZWQsIG5vdCB</div></pre></td></tr></table></figure></p>
<p>åœ¨ä¸Šé¢çš„INIé…ç½®ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°é…ç½®SecurityManager å®ä¾‹ã€‚åœ¨INIé…ç½®ä¸­æœ‰2ä¸ªéƒ¨åˆ†ï¼š[main]å’Œ[users].</p>
<p>[main]éƒ¨åˆ†ç”¨äºé…ç½®SecurityManagerå¯¹è±¡æˆ–è€…è¢«SecurityManager ä½¿ç”¨çš„ä»»ä½•å¯¹è±¡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸¤ä¸ªå¯¹è±¡è¢«é…ç½®ï¼š</p>
<ol>
<li>cmå¯¹è±¡ï¼ŒShiroä¸­çš„HashedCredentialsMatcher ç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚ä½ èƒ½çœ‹åˆ°ï¼Œå¾ˆå¤šcmçš„å±æ€§é€šè¿‡åµŒå¥—çš„ç‚¹çš„è¯­æ³•è¢«é…ç½®ã€‚æ¸…å•3æ‰€ç¤ºçš„IniSecurityManagerFactoryä½¿ç”¨çš„çº¦å®šæ¥è¡¨ç¤ºå¯¹è±¡å›¾å½¢å¯¼èˆªå’Œå±æ€§è®¾ç½®ã€‚</li>
<li>iniRealmå¯¹è±¡ï¼Œå®ƒæ˜¯SecurityManagerç”¨äºè¡¨ç¤ºä»¥INIæ ¼å¼å®šä¹‰çš„ç”¨æˆ·å¸æˆ·çš„ç»„ä»¶ã€‚</li>
</ol>
<p>åœ¨[users]è¿™éƒ¨åˆ†ä¸­ä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªé™æ€çš„ç”¨æˆ·åˆ—è¡¨ï¼Œå¯¹äºç®€å•çš„åº”ç”¨æ˜¯å¾ˆæ–¹ä¾¿æ¥æµ‹è¯•çš„ã€‚</p>
<p>ä»‹ç»è¿™äº›çš„ç›®çš„ä¸æ˜¯å»ç†è§£æ¯ä¸ªéƒ¨åˆ†çš„å¤æ‚æ€§ï¼Œè€Œæ˜¯INIé…ç½®æ–¹å¼æ˜¯ä¸€ç§ç®€å•çš„Shiroé…ç½®ã€‚æ›´å¤šå…³äºINIé…ç½®çš„ç»†èŠ‚ï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒ<a href="http://shiro.apache.org/documentation.html" target="_blank" rel="external">Shiroæ–‡æ¡£</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">import org.apache.shiro.SecurityUtils;</div><div class="line">import org.apache.shiro.config.IniSecurityManagerFactory;</div><div class="line">import org.apache.shiro.mgt.SecurityManager;</div><div class="line">import org.apache.shiro.util.Factory;</div><div class="line">...</div><div class="line">//1. Load the INI configuration</div><div class="line">Factory&lt;SecurityManager&gt; factory = new IniSecurityManagerFactory(&quot;classpath:shiro.ini&quot;);</div><div class="line">//2. Create the SecurityManager SecurityManager securityManager = factory.getInstance();</div><div class="line">//3. Make it accessible</div><div class="line">SecurityUtils.setSecurityManager(securityManager);</div></pre></td></tr></table></figure></p>
<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æœ‰3ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>åŠ è½½é…ç½®SecurityManageråŠå…¶ç»„ä»¶çš„INIé…ç½®æ–‡ä»¶ã€‚</li>
<li>åŸºäºè¿™ä¸ªé…ç½®åˆ›å»ºSecurityManagerå®ä¾‹(ä½¿ç”¨Shiroçš„å·¥å‚æ¦‚å¿µ)ã€‚</li>
<li>æŠŠSecurityManagerå˜æˆå•ä¾‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†å®ƒè®¾ç½®æˆVMé™æ€å•ä¾‹ï¼Œä½†æ˜¯è¿™ä¸æ˜¯å¿…é¡»çš„ã€‚ä½ çš„åº”ç”¨é…ç½®æœºåˆ¶å¯ä»¥å†³å®šä½ è¦ä¸è¦ä½¿ç”¨é™æ€å†…å­˜(è¿™æ®µç¿»è¯‘çœŸçš„ä¸€ç‚¹éƒ½ä¸å®¹æ˜“ç†è§£)ã€‚</li>
</ol>
<h4 id="Realms-åŸŸ"><a href="#Realms-åŸŸ" class="headerlink" title="Realms(åŸŸ)"></a>Realms(åŸŸ)</h4><p>Shiroä¸­ç¬¬ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µå°±æ˜¯åŸŸã€‚åŸŸåœ¨ä½ çš„åº”ç”¨æ•°æ®å’ŒShiroä¸­æ‰¿æ‹…ä¸€ä¸ªæ¡¥æ¢æˆ–è€…è¯´æ˜¯è¿æ¥å™¨çš„è§’è‰²ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å’Œå®‰å…¨ç›¸å…³çš„æ•°æ®äº¤äº’ï¼Œæ¯”æ–¹è¯´è®¤è¯ï¼ˆç™»å½•ï¼‰å’Œæˆæƒï¼ˆè®¿é—®æ§åˆ¶ï¼‰æ—¶ï¼ŒShiroä»ä¸ºåº”ç”¨é…ç½®çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªåŸŸé…ç½®ä¸­å»æ‰¾è¿™äº›ä¸œè¥¿ã€‚</p>
<p>åœ¨æŸç§æ„ä¹‰ä¸Šï¼Œä¸€ä¸ªåŸŸæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå®‰å…¨çš„DAOï¼šå®ƒä¸ºæ•°æ®æºå°è£…äº†è¿æ¥ç»†èŠ‚ä»¥åŠåœ¨éœ€è¦çš„æ—¶å€™è®©Shiroèƒ½å¤Ÿè®¿é—®å…³è”çš„æ•°æ®ã€‚å½“åœ¨é…ç½®Shiroçš„æ—¶å€™ï¼Œä½ å¿…é¡»æŒ‡å®šè‡³å°‘ä¸€ä¸ªåŸŸç”¨æ¥åšè®¤è¯æˆ–è€…æˆæƒã€‚å¯ä»¥é…ç½®å¤šä¸ªï¼Œä½†è‡³å°‘è¦æœ‰ä¸€ä¸ªã€‚</p>
<p>Shiroæä¾›å¼€ç®±å³ç”¨çš„åŸŸæ¥è¿æ¥å„ç§å®‰å…¨çš„æ•°æ®æºï¼Œæ¯”æ–¹è¯´LDAPã€æ•°æ®åº“ç›¸å…³çš„ï¼ˆJDBCï¼‰ã€æ–‡æœ¬æ–‡ä»¶é…ç½®ç±»ä¼¼INIæ–‡ä»¶å’Œpropertiesé…ç½®æ–‡ä»¶ç­‰ã€‚å¦‚æœé»˜è®¤çš„åŸŸä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œä½ ä¹Ÿå¯ä»¥å°†ä½ è‡ªå·±å®ç°çš„åŸŸæ’å…¥åˆ°å…¶ä¸­ã€‚ä¸‹é¢é€šè¿‡INIé…ç½®Shiroçš„ä¾‹å­å°±æ˜¯ç”¨LDAPæ¥ä½œä¸ºåº”ç”¨çš„ä¸€ä¸ªåŸŸå®ç°ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[main]</div><div class="line">ldapRealm = org.apache.shiro.realm.ldap.JndiLdapRealm</div><div class="line">ldapRealm.userDnTemplate = uid=&#123;0&#125;,ou=users,dc=mycompany,dc=com</div><div class="line">ldapRealm.contextFactory.url = ldap://ldapHost:389</div><div class="line">ldapRealm.contextFactory.authenticationMechanism = DIGEST-MD5</div></pre></td></tr></table></figure></p>
<p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†æ€ä¹ˆé…ç½®ä¸€ä¸ªåŸºç¡€çš„Shiroç¯å¢ƒï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¸€èµ·è®¨è®ºä½œä¸ºä¸€ä¸ªå¼€å‘è€…ä½ æ”¹æ€ä¹ˆä½¿ç”¨è¿™ä¸ªæ¡†æ¶ã€‚</p>
<h4 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h4><p>è®¤è¯æ˜¯éªŒè¯ç”¨æˆ·çš„å”¯ä¸€æ€§çš„è¿‡ç¨‹ã€‚å°±æ˜¯è¯´ï¼Œå½“ç”¨æˆ·ä½¿ç”¨åº”ç”¨è¿›è¡Œè®¤è¯çš„æ—¶å€™ï¼Œä»–ä»¬åœ¨è¯æ˜ä»–ä»¬ç¡®å®æ˜¯ä»–ä»¬æ‰€è¯´çš„é‚£ä¸ªäººã€‚é€šå¸¸æœ‰æ—¶å€™æˆ‘ä»¬æŠŠå®ƒç§°ä½œç™»å½•ã€‚å…¸å‹çš„ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>æ”¶é›†ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œä¹Ÿå«ä½œprincipalsï¼Œå¹¶æ”¯æŒèº«ä»½è¯æ˜ï¼Œç§°ä¸ºcredentialsã€‚</li>
<li>æäº¤principalså’Œcredentialsåˆ°ç³»ç»Ÿã€‚</li>
<li>å¦‚æœæäº¤çš„credentialså’Œç³»ç»ŸæœŸæœ›è¯¥ç”¨æˆ·èº«ä»½åŒ¹é…ï¼Œè¿™ä¸ªç”¨æˆ·å°±å¯ä»¥è®¤ä¸ºè®¤è¯é€šè¿‡ã€‚å¦‚æœä¸åŒ¹é…ï¼Œé‚£å°±æ˜¯è®¤è¯ä¸é€šè¿‡ã€‚</li>
</ol>
<p>æ¯ä¸ªäººéƒ½ç†Ÿæ‚‰çš„æœ€å¸¸è§çš„ä¾‹å­å°±æ˜¯ç”¨æˆ·åå’Œå¯†ç çš„ç»„åˆã€‚å½“ç”¨æˆ·ç™»å½•åˆ°ç³»ç»Ÿï¼Œä»–ä»¬é€šå¸¸æä¾›ä»–çš„ç”¨æˆ·åï¼ˆprincipalï¼‰å’Œå¯†ç ï¼ˆcredentialï¼‰ã€‚å¦‚æœå­˜å‚¨åœ¨ç³»ç»Ÿä¸­çš„ å¯†ç å’Œç”¨æˆ·æä¾›çš„ä¸€è‡´ï¼Œä»–å°±è¢«è®¤è¯æˆåŠŸã€‚</p>
<p>Shiroä»¥ç®€å•ç›´è§‚çš„æ–¹å¼æ”¯æŒç±»ä¼¼çš„æµç¨‹ã€‚æ­£å¦‚æˆ‘ä»¬è¯´çš„ï¼ŒShiroæœ‰ä¸€å¥—ä»¥ä¸»ä½“ä¸ºä¸­å¿ƒçš„APIâ€“å‡ ä¹æ‰€æœ‰åœ¨è¿è¡Œæ—¶ä½ å’ŒShiroå…³å¿ƒçš„éƒ½æ˜¯é€šè¿‡ä¸å½“å‰æ‰§è¡Œçš„ä¸»ä½“äº¤äº’å®ç°çš„ã€‚å› æ­¤ï¼Œè¦ç™»å½•ä¸€ä¸ªä¸»ä½“ï¼Œä½ åªéœ€è¦è°ƒç”¨å®ƒçš„ç™»å½•æ–¹æ³•ï¼Œä¼ ä¸€ä¸ªå¸¦æœ‰principals å’Œcredentialsçš„AuthenticationTokenå®ä¾‹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//1. Acquire submitted principals and credentials:</div><div class="line"> AuthenticationToken token = new UsernamePasswordToken(username,password);</div><div class="line">//2. Get the current Subject:</div><div class="line">Subject currentUser = SecurityUtils.getSubject();</div><div class="line"> //3. Login:</div><div class="line"> currentUser.login(token);</div></pre></td></tr></table></figure></p>
<p>å¦‚ä½ æ‰€è§ï¼ŒShiroçš„APiå¾ˆç®€å•çš„è¡¨ç¤ºäº†è¿™ä¸ªæµç¨‹ã€‚ä½ å¯ä»¥å°†è¿™ç§å¯¹æ‰€æœ‰ä¸»ä½“æ“ä½œçš„ç®€å•æ€§ä½œä¸ºä¸€ç§ç‰¹è‰²ã€‚å½“ç™»å½•æ–¹æ³•è¢«è°ƒç”¨ï¼ŒSecurityManagerå°†æ¥æ”¶AuthenticationTokenç„¶åå°†å…¶åˆ†å‘åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªé…ç½®å¥½çš„åŸŸä¸­ç”¨æ¥åšè®¤è¯ã€‚æ¯ä¸ªåŸŸéƒ½æœ‰èƒ½åŠ›æ ¹æ®éœ€è¦å¯¹æäº¤çš„AuthenticationTokenè¿›è¡Œå¤„ç†ã€‚ä½†æ˜¯å‡å¦‚ç™»å½•å¤±è´¥äº†ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿå‡å¦‚ç”¨æˆ·çš„å¯†ç è¾“é”™äº†å‘¢ï¼Ÿä½ å¯ä»¥é€šè¿‡è¿è¡Œæ—¶çš„AuthenticationException æ¥å¤„ç†è¿™äº›å¤±è´¥ï¼Œä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">//3. Login:</div><div class="line">try &#123;</div><div class="line">    currentUser.login(token);</div><div class="line">&#125; catch (IncorrectCredentialsException ice) &#123; â€¦</div><div class="line">&#125; catch (LockedAccountException lae) &#123; â€¦</div><div class="line">&#125;</div><div class="line">â€¦</div><div class="line">catch (AuthenticationException ae) &#123;â€¦</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä½ å¯ä»¥é€‰æ‹©æ•è·AuthenticationExceptionçš„ä¸€ä¸ªå­ç±»æ¥è¿›è¡Œå…·ä½“çš„å¤„ç†ï¼Œæˆ–è€…ç»Ÿä¸€å¤„ç†ä»»ä½•AuthenticationExceptionï¼ˆæ¯”å¦‚è¯´ï¼Œé€šå¸¸æ˜¾ç¤ºâ€œç”¨æˆ·åæˆ–è€…å¯†ç é”™è¯¯â€æ¶ˆæ¯ï¼‰ã€‚è¿™æ˜¯æ ¹æ®ä½ åº”ç”¨çš„éœ€æ±‚æ¥é€‰æ‹©çš„ã€‚</p>
<p>ä¸€ä¸ªä¸»ä½“ç™»å½•æˆåŠŸåï¼Œä»–ä»¬è¢«è®¤ä¸ºè®¤è¯é€šè¿‡ï¼Œé€šå¸¸ä½ å…è®¸ä»–ä»¬ä½¿ç”¨ä½ çš„åº”ç”¨ã€‚ä½†æ˜¯ï¼Œç”±äºç”¨æˆ·ä»…è¯æ˜äº†è‡ªå·±çš„èº«ä»½ä¸ä»£è¡¨ä»–ä»¬åœ¨åº”ç”¨ä¸­èƒ½åšä»»ä½•ä»–ä»¬æƒ³åšçš„äº‹æƒ…ã€‚è¿™å°±æå‡ºäº†ä¸‹ä¸€ä¸ªé—®é¢˜ï¼šâ€œæˆ‘å¦‚ä½•æ§åˆ¶ç”¨æˆ·è¢«å…è®¸åšä»€ä¹ˆï¼Ÿâ€å†³å®šç”¨æˆ·å…è®¸åšä»€ä¹ˆå«åšæˆæƒã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è®¨è®ºShiroæ€ä¹ˆå¯ç”¨æˆæƒã€‚</p>
<h4 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h4><p>æˆæƒæ˜¯åŸºæœ¬çš„è®¿é—®æ§åˆ¶â€“æ§åˆ¶ä½ çš„ç”¨æˆ·åœ¨ä½ çš„åº”ç”¨ä¸­å¯ä»¥è®¿é—®ä»€ä¹ˆï¼Œæ¯”æ–¹è¯´èµ„æºã€webé¡µé¢ç­‰ç­‰ã€‚å¤§å¤šæ•°ç”¨æˆ·é€šè¿‡ä½¿ç”¨è§’è‰²å’Œæƒé™ç­‰æ¦‚å¿µæ¥æ‰§è¡Œè®¿é—®æ§åˆ¶ã€‚å°±æ˜¯è¯´ï¼Œä¸€ä¸ªç”¨æˆ·é€šå¸¸å…è®¸åšä»€ä¹ˆäº‹æˆ–è€…ä¸å…è®¸åšä»€ä¹ˆäº‹æ˜¯åŸºäºä»–ä»¬åˆ†é…çš„è§’è‰²æˆ–è€…æƒé™çš„ã€‚ç„¶åï¼Œä½ çš„åº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®å¯¹è¿™äº›è§’è‰²å’Œæƒé™çš„æ£€æŸ¥æ¥æ§åˆ¶æ˜¾ç¤ºå“ªäº›åŠŸèƒ½ã€‚æ­£å¦‚ä½ æœŸæœ›çš„ï¼Œä¸»ä½“APIå…è®¸ä½ éå¸¸å®¹æ˜“çš„æ‰§è¡Œæƒé™å’Œè§’è‰²æ£€æŸ¥ã€‚ä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if ( subject.hasRole(â€œadministratorâ€) ) &#123;</div><div class="line">    //show the â€˜Create Userâ€™ button</div><div class="line">&#125; else &#123;</div><div class="line">    //grey-out the button?</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¦‚ä½ æ‰€è§ï¼Œä½ çš„åº”ç”¨å¯ä»¥åŸºäºè®¿é—®æ§åˆ¶å¼€å¯æˆ–è€…å…³é—­åŠŸèƒ½ã€‚</p>
<p>æƒé™æ£€æŸ¥æ˜¯å¦ä¸€ç§æ‰§è¡Œæˆæƒçš„æ–¹å¼ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­æ£€æŸ¥æƒé™æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ç¼ºé™·ï¼šä½ ä¸èƒ½å†è¿è¡Œçš„æ—¶å€™æ·»åŠ æˆ–è€…åˆ é™¤è§’è‰²ã€‚ä½ çš„ä»£ç æ˜¯å’Œè§’è‰²åå­—ç¡¬ç¼–ç è¿›å»çš„ï¼Œå› æ­¤å‡å¦‚ä½ æ”¹å˜äº†è§’è‰²åæˆ–è€…é…ç½®ï¼Œä½ çš„ä»£ç å°†ä¼šçˆ†ç‚¸ï¼å‡å¦‚ä½ éœ€è¦å¯ä»¥åœ¨è¿è¡Œæ—¶æ”¹å˜è§’è‰²çš„å«ä¹‰ï¼Œæˆ–è€…æ ¹æ®éœ€è¦æ·»åŠ åˆ é™¤è§’è‰²ï¼Œé‚£ä¹ˆä½ å°±å¿…é¡»ä¾é åˆ«çš„ä¸œè¥¿äº†ã€‚</p>
<p>ä¸ºæ­¤ï¼ŒShiroæ”¯æŒæƒé™çš„æ¦‚å¿µã€‚æƒé™æ˜¯åŸå§‹åŠŸèƒ½çš„è¯´æ˜ï¼Œä¸¾ä¸ªæ —å­ï¼Œâ€˜å¼€é—¨â€™ã€â€˜åˆ›å»ºåšå®¢å®ä½“â€™ã€â€˜åˆ é™¤xxç”¨æˆ·â€™ç­‰ç­‰ã€‚æœ‰æƒé™ä»£è¡¨ä½ æœ‰åº”ç”¨çš„åŸå§‹åŠŸèƒ½ï¼Œå½“ä½ æ›´æ”¹åº”ç”¨ç¨‹åºçš„åŠŸèƒ½æ—¶ï¼Œä½ åªéœ€è¦æ›´æ”¹æƒé™æ£€æŸ¥ã€‚åè¿‡æ¥ï¼Œåœ¨è¿è¡Œæ—¶å¿…è¦çš„æ—¶å€™ä½ å¯ä»¥åˆ†é…æƒé™åˆ°è§’è‰²æˆ–è€…ç”¨æˆ·ã€‚ä¸‹é¢çš„ä»£ç ä½¿ç”¨æƒé™æ£€æŸ¥ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if ( subject.isPermitted(â€œuser:createâ€) ) &#123;</div><div class="line">    //show the â€˜Create Userâ€™ button</div><div class="line">&#125; else &#123;</div><div class="line">    //grey-out the button?</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™æ ·ï¼Œä»»ä½•åˆ†é…äº†â€œuserï¼šcreateâ€æƒé™çš„è§’è‰²æˆ–ç”¨æˆ·å¯ä»¥å•å‡»â€œåˆ›å»ºç”¨æˆ·â€æŒ‰é’®,è€Œä¸”è¿™äº›è§’è‰²å’Œåˆ†é…ç”šè‡³å¯ä»¥åœ¨è¿è¡Œæ—¶æ›´æ”¹ï¼Œç»™ä½ æä¾›äº†ä¸€ç§éå¸¸çµæ´»çš„å®‰å…¨æ¨¡å‹ã€‚</p>
<p>â€œuserï¼šcreateâ€å­—ç¬¦ä¸²æ˜¯éµå®ˆæŸäº›è§£æçº¦å®šçš„æƒé™å­—ç¬¦ä¸²çš„ç¤ºä¾‹ã€‚Shiroé€šè¿‡å…¶WildcardPermissionæ”¯æŒè¿™ä¸ªå¼€ç®±å³ç”¨çš„çº¦å®šã€‚è™½ç„¶è¶…å‡ºæœ¬å¯¼è¨€æ–‡ç« çš„èŒƒå›´ï¼Œä½ å°†çœ‹åˆ°WildcardPermissionåœ¨åˆ›å»ºå®‰å…¨ç­–ç•¥æ—¶å¯ä»¥éå¸¸çµæ´»ï¼Œç”šè‡³æ”¯æŒè¯¸å¦‚å®ä¾‹çº§è®¿é—®æ§åˆ¶ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if ( subject.isPermitted(â€œuser:delete:jsmithâ€) ) &#123;</div><div class="line">    //delete the â€˜jsmithâ€™ user</div><div class="line">&#125; else &#123;</div><div class="line">    //donâ€™t delete â€˜jsmithâ€™</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªä¾‹å­å±•ç¤ºäº†ä½ èƒ½æ§åˆ¶ï¼Œç”šè‡³å¯ä»¥ç»†åŒ–åˆ°æ›´ç»†ç²’åº¦çš„çº§åˆ«ï¼Œå¦‚æœæœ‰éœ€è¦å¯ä»¥è®¿é—®å•ä¸ªèµ„æºã€‚å¦‚æœä½ æƒ³çš„è¯ä½ ä¹Ÿå¯ä»¥å‘æ˜è‡ªå·±çš„æƒé™è¯­æ³•ã€‚å‚è€ƒ<a href="http://shiro.apache.org/permissions.html" target="_blank" rel="external">Shiro Permission</a>è·å–æ›´å¤šè¯¦æƒ…ã€‚æœ€åï¼Œå°±åƒèº«ä»½éªŒè¯ä¸€æ ·ï¼Œä¸Šé¢çš„è°ƒç”¨æœ€ç»ˆä¹Ÿè¿›å…¥äº†SecurityManagerï¼ŒSecurityManagerå°†ä¼šæŸ¥è¯¢ä¸€ä¸ªæˆ–å¤šä¸ªåŸŸï¼Œä»¥ä½œå‡ºè®¿é—®æ§åˆ¶å†³å®šã€‚è¿™å…è®¸é¢†åŸŸæ ¹æ®éœ€è¦å¯¹è®¤è¯å’Œæˆæƒæ“ä½œè¿›è¡Œå“åº”ã€‚</p>
<p>åˆ°æ­¤å°±æ˜¯ä¸€ä¸ªé˜ŸShiroæˆæƒåŠŸèƒ½çš„ä¸€ä¸ªç®€è¦æ¦‚è¿°ã€‚å¾ˆå¤šå®‰å…¨æ¡†æ¶åœ¨è®¤è¯å’Œæˆæƒé¢å‰åœäº†ä¸‹æ¥ï¼Œè€ŒShiroä¸æ­¢äºæ­¤ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¦è®¨è®ºShiroçš„é«˜çº§ä¼šè¯ç®¡ç†åŠŸèƒ½ã€‚</p>
<h4 id="Session-Management"><a href="#Session-Management" class="headerlink" title="Session Management"></a>Session Management</h4><p>Shiroæä¾›å®‰å…¨æ¡†æ¶é‡Œç‹¬ä¸€æ— äºŒçš„ï¼šå¯ç”¨äºä»»ä½•åº”ç”¨å’Œä»»ä½•ç»“æ„å±‚ä¸€è‡´çš„ä¼šè¯APIã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒShiroä¸ºä»»ä½•åº”ç”¨ç¨‹åºå¯ç”¨äº†ä¼šè¯ç¼–ç¨‹èŒƒä¾‹â€“ä»å°çš„åå°åº”ç”¨åˆ°å¤§å‹é›†ç¾¤webåº”ç”¨ã€‚è¿™æ„å‘³ç€å¸Œæœ›ä½¿ç”¨ä¼šè¯çš„åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ä¸å†å¼ºåˆ¶ä½¿ç”¨Servletæˆ–EJBå®¹å™¨ã€‚æˆ–è€…ï¼Œå¦‚æœä½¿ç”¨è¿™äº›å®¹å™¨ï¼Œå¼€å‘äººå‘˜ç°åœ¨å¯ä»¥é€‰æ‹©åœ¨ä»»ä½•å±‚ä¸­ä½¿ç”¨ç»Ÿä¸€å’Œä¸€è‡´çš„ä¼šè¯APIï¼Œè€Œä¸æ˜¯ä½¿ç”¨servletæˆ–EJBç‰¹å®šçš„æœºåˆ¶ã€‚</p>
<p>ä½†æ˜¯æˆ–è®¸ä¸€ä¸ªæœ€é‡è¦çš„å¥½å¤„æ˜¯Shiroä¼šè¯æ˜¯ç‹¬ç«‹äºå®¹å™¨çš„ã€‚è¿™å…·æœ‰å¾®å¦™ä½†éå¸¸å¼ºå¤§çš„å«ä¹‰ã€‚ä¾‹å¦‚æˆ‘ä»¬è€ƒè™‘ä¼šè¯é›†ç¾¤ã€‚æœ‰å¤šå°‘ä»¥æŒ‡å®šå®¹å™¨çš„æ–¹å¼æ¥é›†ç¾¤ä¼šè¯ä»¥è¿›è¡Œå®¹é”™å’Œæ•…éšœè½¬ç§»ï¼ŸTomcatå’ŒJettyåšçš„ä¸ä¸€æ ·ï¼Œå’ŒWebsphereä¹Ÿä¸ä¸€æ ·ã€‚ä½†æ˜¯ä½¿ç”¨Shiro sessionï¼Œä½ å¯ä»¥è·å¾—ä¸€ä¸ªå®¹å™¨æ— å…³çš„é›†ç¾¤è§£å†³æ–¹æ¡ˆã€‚Shiroçš„æ¶æ„å…è®¸å¯æ’æ‹”çš„ä¼šè¯æ•°æ®å­˜å‚¨ï¼Œä¾‹å¦‚ä¼ä¸šçº§ç¼“å­˜ï¼Œå…³ç³»å‹æ•°æ®åº“ã€‚NoSQLç­‰ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ä¸€æ¬¡é…ç½®ä¼šè¯ç¾¤é›†ï¼Œå¹¶ä¸”æ— è®ºä½ çš„éƒ¨ç½²ç¯å¢ƒå¦‚ä½•ï¼Œå®ƒéƒ½å°†ä»¥ç›¸åŒçš„æ–¹å¼å·¥ä½œâ€“Tomcatã€Jettyã€JEE Serveræˆ–è€…ç‹¬ç«‹çš„åº”ç”¨ã€‚å®åœ¨æ˜¯æ²¡ç”¨å¿…è¦æ ¹æ®ä½ æ€ä¹ˆéƒ¨ç½²ä½ çš„åº”ç”¨æ¥é‡æ–°é…ç½®ä½ çš„åº”ç”¨ã€‚</p>
<p>å¦ä¸€ä¸ªShiro sessionçš„å¥½å¤„æ˜¯sessionæ•°æ®å¦‚æœéœ€è¦å¯ä»¥è·¨å®¢æˆ·ç«¯å…±äº«ã€‚ä¸¾ä¸ªæ —å­ï¼Œå¦‚æœéœ€è¦ï¼ŒSwingæ¡Œé¢å®¢æˆ·ç«¯å¯ä»¥å‚ä¸ç›¸åŒçš„Webåº”ç”¨ç¨‹åºä¼šè¯â€“å¦‚æœç»ˆç«¯ç”¨æˆ·åŒæ—¶ä½¿ç”¨ä¸¤è€…ï¼Œåˆ™å¾ˆæœ‰ç”¨ã€‚å› æ­¤ä½ æ€æ ·åœ¨ä»»ä½•ç¯å¢ƒä¸‹è®¿é—®ä¸»ä½“çš„sessionï¼Ÿä¸‹é¢çš„ä»£ç ä¸»ä½“çš„2ä¸ªæ–¹æ³•ä¼šå±•ç¤ºå‡ºæ¥ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Session session = subject.getSession();</div><div class="line">Session session = subject.getSession(boolean create);</div></pre></td></tr></table></figure></p>
<p>å¦‚ä½ æ‰€è§ï¼Œè¿™äº›æ–¹æ³•åœ¨æ¦‚å¿µä¸Šä¸HttpServletRequest APIç›¸åŒã€‚ç¬¬ä¸€ä¸ªæ–¹æ³•å°†ä¼šè¿”å›ä¸»ä½“å­˜åœ¨çš„sessionï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£å°±åˆ›å»ºä¸€ä¸ªå†è¿”å›ã€‚ç¬¬äºŒä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ªboolå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å†³å®šæ˜¯å¦åœ¨sessionä¸å­˜åœ¨çš„æ—¶å€™åˆ›å»ºæ–°çš„sessionã€‚ä¸€æ—¦ä½ è¯·æ±‚ä¸»ä½“çš„sessionï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒå’Œå‡ ä¹ä½¿ç”¨HttpSessionä¸€æ ·ã€‚Shiroå›¢é˜Ÿè€ƒè™‘åˆ°HTTPSessionå¯¹Javaå¼€å‘äººå‘˜å¾ˆå‹å¥½ï¼Œå› æ­¤æˆ‘ä»¬æœ‰è¿™ç§æ„Ÿè§‰ã€‚æœ€å¤§çš„åŒºåˆ«å°±æ˜¯ä½ å¯ä»¥åœ¨ä»»ä½•åº”ç”¨ä¸­ä½¿ç”¨Shiro Sessionï¼Œä¸ä»…é™äºwebåº”ç”¨ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å…¶ç›¸åŒä¹‹å¤„ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Session session = subject.getSession();</div><div class="line">session.getAttribute(â€œkeyâ€, someValue);</div><div class="line">Date start = session.getStartTimestamp();</div><div class="line">Date timestamp = session.getLastAccessTime();</div><div class="line">session.setTimeout(millis);</div></pre></td></tr></table></figure></p>
<h4 id="Cryptography"><a href="#Cryptography" class="headerlink" title="Cryptography"></a>Cryptography</h4><p>å¯†ç å­¦æ˜¯éšè—æˆ–æ··æ·†æ•°æ®çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥çª¥æ¢çœ¼ç›æ— æ³•ç†è§£å®ƒã€‚Shiroåœ¨å¯†ç å­¦ä¸­çš„ç›®æ ‡æ˜¯ç®€åŒ–å’Œä½¿ç”¨JDKçš„åŠ å¯†æ”¯æŒã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€èˆ¬æ¥è¯´å¯†ç å­¦å¯¹äºä¸»ä½“æ¥è¯´ä¸æ˜¯ç‰¹å®šçš„ï¼Œæ‰€ä»¥å®ƒæ˜¯Shiro APIçš„ä¸€ä¸ªé¢†åŸŸï¼Œå’Œä¸»ä½“æ— å…³ã€‚ä½ å¯ä»¥ä½¿ç”¨Shiroçš„åŠ å¯†ç”¨åœ¨ä»»ä½•åœ°æ–¹ï¼Œå³ä½¿ä¸»ä½“æ²¡æœ‰ä½¿ç”¨ã€‚ShiroçœŸæ­£å…³æ³¨çš„ä¸¤ä¸ªé¢†åŸŸä¸€ä¸ªæ˜¯å“ˆå¸ŒåŠ å¯†å’Œå¯†ç åŠ å¯†ã€‚</p>
<h5 id="Hashing"><a href="#Hashing" class="headerlink" title="Hashing"></a>Hashing</h5><p>å¦‚æœä½ ç”¨è¿‡JDKçš„MessageDigestç±»ï¼Œä½ å¾ˆå¿«ä¼šå‘ç°ç”¨èµ·æ¥æœ‰ä¸€ç‚¹ç¬¨é‡ã€‚å®ƒæœ‰ä¸€å¥—åŸºäºå·¥å‚çš„ç¬¨é‡çš„é™æ€æ–¹æ³•APIï¼Œè€Œä¸æ˜¯é¢å‘å¯¹è±¡çš„ï¼Œè€Œä¸”ä½ è¢«è¿«æ•è·é‚£äº›æ°¸è¿œä¸ä¼šè¢«æ•è·çš„å¼‚å¸¸ã€‚å‡å¦‚ä½ éœ€è¦16è¿›åˆ¶æˆ–è€…base64ç¼–ç æ¶ˆæ¯æ‘˜è¦çš„è¾“å‡ºï¼Œä½ å¾—è‡ªå·±å†™â€“æ²¡æœ‰æ ‡å‡†çš„JDKå®ç°ã€‚Shiroä»¥å¹²å‡€ç›´è§‚çš„æ•£åˆ—APIè§£å†³äº†è¿™äº›é—®é¢˜ã€‚</p>
<p>æ‰“ä¸ªæ¯”æ–¹ï¼Œæˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹æ¯”è¾ƒå¸¸è§çš„MD5æ•£åˆ—æ–‡ä»¶å¹¶ç¡®å®šè¯¥å“ˆå¸Œå€¼çš„åå…­è¿›åˆ¶å€¼çš„æƒ…å†µã€‚â€œæ ¡éªŒå’Œâ€ï¼Œè¿™æ˜¯åœ¨æä¾›æ–‡ä»¶ä¸‹è½½æ—¶ç»å¸¸ä½¿ç”¨çš„ - ç”¨æˆ·å¯ä»¥åœ¨ä¸‹è½½çš„æ–‡ä»¶ä¸Šæ‰§è¡Œè‡ªå·±çš„MD5å“ˆå¸Œï¼Œå¹¶å£°æ˜å…¶æ ¡éªŒå’Œä¸ä¸‹è½½ç«™ç‚¹çš„æ ¡éªŒå’ŒåŒ¹é…ã€‚å‡å¦‚åŒ¹é…ï¼Œç”¨æˆ·å¯ä»¥å……åˆ†åœ°å‡è®¾è¯¥æ–‡ä»¶åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ²¡æœ‰è¢«ç¯¡æ”¹ã€‚</p>
<p>åœ¨ä¸ä½¿ç”¨Shiroæƒ…å†µä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼š</p>
<ol>
<li>å°†æ–‡ä»¶è½¬åŒ–ä¸ºå­—èŠ‚æ•°ç»„ã€‚JDKä¸èƒ½å¸®ä½ å®Œæˆï¼Œå› æ­¤ä½ å¾—è‡ªå·±åˆ›å»ºä¸€ä¸ªæ‰“å¼€FileInputStreamçš„æ–¹æ³•ï¼Œä½¿ç”¨å­—èŠ‚ç¼“å†²ï¼Œç„¶åæŠ›å‡ºå¯èƒ½çš„å¼‚å¸¸ç­‰ç­‰ã€‚</li>
<li>ç”¨MessageDigestç±»æ¥å¯¹å­—èŠ‚æ•°ç»„æ±‚å“ˆå¸Œï¼Œå¤„ç†å¼‚å¸¸ã€‚</li>
<li>å¯¹å“ˆå¸Œåçš„å­—èŠ‚æ•°ç»„ç¼–ç æˆ16è¿›åˆ¶ã€‚JDKä¸­ä¹Ÿæ²¡æœ‰ç°æˆçš„å¸®ä½ å®Œæˆï¼Œå› æ­¤ä½ å¾—åˆ›å»ºå¦ä¸€ä¸ªå¸®åŠ©ç±»ï¼Œå¹¶ä¸”å¯èƒ½åœ¨ä½ çš„å®ç°ä¸­ä½¿ç”¨æŒ‰ä½æ“ä½œå’Œä½ç§»ã€‚</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">try &#123;</div><div class="line">    MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);</div><div class="line">    md.digest(bytes);</div><div class="line">    byte[] hashed = md.digest();</div><div class="line">&#125; catch (NoSuchAlgorithmException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹äºè¿™ä¹ˆç®€å•å’Œç›¸å¯¹æ™®éçš„äº‹æƒ…æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆç¹ççš„å·¥ä½œã€‚<br>çœ‹çœ‹Shiroæ€ä¹ˆåšç›¸åŒçš„äº‹æƒ…çš„ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">String hex = new Md5Hash(myFile).toHex();</div></pre></td></tr></table></figure></p>
<p>å½“ä½ ä½¿ç”¨Shiroæ¥ç®€åŒ–æ‰€æœ‰è¿™äº›å·¥ä½œæ—¶ï¼Œè¿™æ˜¯éå¸¸ç®€å•å’Œå®¹æ˜“ç†è§£çš„ã€‚  SHA-512æ•£åˆ—å’ŒBase64ç¼–ç çš„å¯†ç åŒæ ·ç®€å•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String encodedPassword =</div><div class="line">    new Sha512Hash(password, salt, count).toBase64();</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°åœ¨å“ˆå¸Œå’Œç¼–ç ä¸ŠShiroå¸®ä½ ç®€åŒ–äº†å¤šå°‘ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­èŠ‚çœäº†ä½ ä¸å°‘æ—¶é—´ã€‚</p>
<h5 id="Ciphers"><a href="#Ciphers" class="headerlink" title="Ciphers"></a>Ciphers</h5><p>å¯†ç æ˜¯å¯ä»¥ä½¿ç”¨å¯†é’¥å¯é€†åœ°è½¬æ¢æ•°æ®çš„åŠ å¯†ç®—æ³•ã€‚æˆ‘ä»¬é€šå¸¸ç”¨ä½œä¿æŠ¤æ•°æ®å®‰å…¨ï¼Œç‰¹åˆ«åœ¨ä¼ è¾“æˆ–è€…å­˜å‚¨æ•°æ®çš„æ—¶å€™ï¼Œæ•°æ®ç‰¹åˆ«å®¹æ˜“è¢«çª¥æ¢ã€‚</p>
<p>å¦‚æœä½ æ›¾ç»ä½¿ç”¨è¿‡JDKåŠ å¯†APIï¼Œç‰¹åˆ«æ˜¯ javax.crypto.Cipherç±»ï¼Œä½ çŸ¥é“è¿™å¯ä»¥æ˜¯ä¸€ä¸ªéš¾ä»¥ç½®ä¿¡çš„å¤æ‚é‡å…½é©¯æœï¼ˆç¿»è¯‘ä¸ºè¿™æ˜¯ä¸€ä¸ªå¾ˆå›°éš¾çš„è¿‡ç¨‹ï¼‰ã€‚å¯¹äºå…¥é—¨è€…è€Œè¨€ï¼Œæ¯ä¸ªå¯†ç é…ç½®å§‹ç»ˆç”±javax.crypto.Cipherçš„ä¸€ä¸ªå®ä¾‹è¡¨ç¤ºã€‚éœ€è¦å…¬é’¥/ç§é’¥åŠ å¯†å—ï¼Ÿ</p>
<p>ç„¶è€Œæ€ä¹ˆåˆ›å»ºä½ éœ€è¦çš„Cipher å®ä¾‹ï¼Ÿä½ åˆ›å»ºä¸€ä¸ªå¤æ‚çš„ï¼Œéç›´è§‚çš„ä»¤ç‰Œåˆ†éš”çš„å¯†ç é€‰é¡¹å­—ç¬¦ä¸²ï¼Œç§°ä¸ºâ€œè½¬æ¢å­—ç¬¦ä¸²â€ï¼Œå¹¶å°†æ­¤å­—ç¬¦ä¸²ä¼ é€’ç»™Cipher.getInstanceé™æ€å·¥å‚æ–¹æ³•ã€‚ä½¿ç”¨è¿™ç§å¯†ç é€‰é¡¹Stringæ–¹æ³•ï¼Œæ²¡æœ‰ç±»å‹å®‰å…¨æ€§æ¥ç¡®ä¿ä½ ä½¿ç”¨æœ‰æ•ˆçš„é€‰é¡¹ã€‚è¿™ä¹Ÿéšå«æ„å‘³ç€æ²¡æœ‰JavaDocå¸®åŠ©ä½ äº†è§£ç›¸å…³é€‰é¡¹ã€‚è€Œä¸”æ‚¨è¿˜éœ€è¦å¤„ç†æ£€æŸ¥çš„å¼‚å¸¸æƒ…å†µï¼Œä»¥é˜²ä½ çš„Stringé…ç½®ä¸æ­£ç¡®ï¼Œå³ä½¿ä½ çŸ¥é“é…ç½®æ­£ç¡®ã€‚æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œä½¿ç”¨JDKå¯†ç æ˜¯ä¸€é¡¹ç›¸å½“éº»çƒ¦çš„ä»»åŠ¡ã€‚è¿™äº›æŠ€æœ¯æ›¾ç»æ˜¯Java APIåœ¨å¾ˆä¹…ä»¥å‰çš„æ ‡å‡†ï¼Œä½†æ—¶ä»£å·²ç»æ”¹å˜ï¼Œæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªæ›´ç®€å•çš„æ–¹æ³•ã€‚</p>
<p>Shiroå°è¯•é€šè¿‡å¼•å…¥å…¶CipherService APIæ¥ç®€åŒ–åŠ å¯†å¯†ç çš„æ•´ä¸ªæ¦‚å¿µã€‚CipherServiceæ˜¯å¤§å¤šæ•°å¼€å‘äººå‘˜åœ¨ä¿æŠ¤æ•°æ®æ—¶æ‰€éœ€è¦çš„ï¼šä¸€ç§ç®€å•ï¼Œæ— çŠ¶æ€ï¼Œçº¿ç¨‹å®‰å…¨çš„APIï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ä¸­å¯¹æ•°æ®è¿›è¡Œå…¨é¢åŠ å¯†æˆ–è§£å¯†ã€‚æ‰€æœ‰ä½ éœ€è¦åšçš„æ˜¯æä¾›ä½ çš„å¯†é’¥ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡ŒåŠ å¯†æˆ–è§£å¯†ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨256ä½AESåŠ å¯†ï¼š</p>
<blockquote>
<p>AesCipherService cipherService = new AesCipherService();<br>cipherService.setKeySize(256);<br>//create a test key:<br>byte[] testKey = cipherService.generateNewKey();<br>//encrypt a fileâ€™s bytes:<br>byte[] encrypted =<br>    cipherService.encrypt(fileBytes, testKey);</p>
</blockquote>
<p>ä¸JDKçš„Cipher APIç›¸æ¯”ï¼ŒShiroç¤ºä¾‹æ›´ç®€å•:</p>
<ul>
<li>ä½ å¯ä»¥ç›´æ¥å®ä¾‹åŒ–CipherService  - æ²¡æœ‰å¥‡æ€ªæˆ–æ··ä¹±çš„å·¥å‚æ–¹æ³•ã€‚</li>
<li>å¯†ç é…ç½®é€‰é¡¹è¡¨ç¤ºä¸ºä¸JavaBeanså…¼å®¹çš„getterå’Œsetter  - æ²¡æœ‰å¥‡æ€ªå’Œéš¾ä»¥ç†è§£çš„â€œè½¬æ¢å­—ç¬¦ä¸²â€ã€‚</li>
<li>åŠ å¯†å’Œè§£å¯†åœ¨å•ä¸€æ–¹æ³•è°ƒç”¨ä¸­æ‰§è¡Œã€‚</li>
<li>æ²¡æœ‰å¼ºåˆ¶æ£€æŸ¥å¼‚å¸¸ã€‚ å¦‚æœä½ æƒ³è¦çš„è¯ï¼Œå¯ä»¥æ•è·Shiroçš„CryptoExceptionã€‚</li>
</ul>
<p>Shiroçš„CipherService APIè¿˜æœ‰å…¶ä»–ä¼˜ç‚¹ï¼Œä¾‹å¦‚æ”¯æŒåŸºäºå­—èŠ‚æ•°ç»„çš„åŠ å¯†/è§£å¯†ï¼ˆç§°ä¸ºâ€œå—â€æ“ä½œï¼‰ä»¥åŠåŸºäºæµçš„åŠ å¯†/è§£å¯†ï¼ˆä¾‹å¦‚ï¼ŒåŠ å¯†éŸ³é¢‘æˆ–è§†é¢‘ï¼‰çš„èƒ½åŠ›ã€‚</p>
<p>JavaåŠ å¯†æŠ€æœ¯ä¸å¿…å¦‚æ­¤éš¾å—ã€‚<br>Shiroå¯¹å¯†ç çš„æ”¯æŒæ—¨åœ¨ç®€åŒ–ä½ ä¿æŠ¤æ•°æ®å®‰å…¨çš„ä»˜å‡ºã€‚</p>
<h4 id="Web-Support"><a href="#Web-Support" class="headerlink" title="Web Support"></a>Web Support</h4><p>æœ€åï¼Œä½†ä¸æ˜¯ä¸é‡è¦çš„ï¼Œæˆ‘ä»¬ç®€è¦ä»‹ç»Shiroå¯¹webçš„æ”¯æŒã€‚Shiroæ‹¥æœ‰å¼ºå¤§çš„webæ”¯æŒæ¨¡å—ï¼Œæ¥ä¿æŠ¤webåº”ç”¨å®‰å…¨ã€‚ä¸ºä¸€ä¸ªwebåº”ç”¨è®¾ç½®Shiroæ˜¯å¾ˆç®€å•çš„ã€‚ä»…éœ€è¦åœ¨web.xmlä¸­å®šä¹‰ä¸€ä¸ªShiro Servlet Filterã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">    &lt;filter-name&gt;ShiroFilter&lt;/filter-name&gt;</div><div class="line">    &lt;filter-class&gt;</div><div class="line">        org.apache.shiro.web.servlet.IniShiroFilter</div><div class="line">    &lt;/filter-class&gt;</div><div class="line">    &lt;!-- no init-param means load the INI config</div><div class="line">        from classpath:shiro.ini --&gt; </div><div class="line">&lt;/filter&gt;</div><div class="line">&lt;filter-mapping&gt;</div><div class="line">     &lt;filter-name&gt;ShiroFilter&lt;/filter-name&gt;</div><div class="line">     &lt;url-pattern&gt;/*&lt;/url-pattern&gt;</div><div class="line">&lt;/filter-mapping&gt;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªè¿‡æ»¤å™¨èƒ½å¤Ÿè¯»ä¹‹å‰çš„shiro.inié…ç½®æ–‡ä»¶ï¼Œå› æ­¤æ— è®ºåœ¨ä»€ä¹ˆæ ·çš„éƒ¨ç½²ç¯å¢ƒä¸‹ï¼Œé…ç½®éƒ½æ˜¯ä¸€æ ·çš„ã€‚ä¸€æ—¦é…ç½®å¥½äº†ï¼ŒShiro filterå°±ä¼šè¿‡æ»¤ä¸€åˆ‡è¯·æ±‚ï¼Œå¹¶ç¡®ä¿åœ¨è¯·æ±‚æœŸé—´ç‰¹å®šçš„è¯·æ±‚ä¸»ä½“å¯è¢«è®¿é—®ã€‚ç”±äºè¿‡æ»¤æ‰€æœ‰è¯·æ±‚ï¼Œä½ å¯ä»¥æ‰§è¡ŒæŒ‡å®šå®‰å…¨çš„é€»è¾‘ä»£ç ï¼Œä»¥ç¡®ä¿ä»…å…è®¸ç¬¦åˆç‰¹å®šæ¡ä»¶çš„è¯·æ±‚ã€‚</p>
<h4 id="URL-Specific-Filter-Chains"><a href="#URL-Specific-Filter-Chains" class="headerlink" title="URL-Specific Filter Chains"></a>URL-Specific Filter Chains</h4><p>Shiroé€šè¿‡å®ƒç‰¹æœ‰çš„URLé“¾æ¥æ”¯æŒå®‰å…¨çš„è¿‡æ»¤è§„åˆ™ã€‚å®ƒå…è®¸ä½ ä¸ºä»»ä½•åŒ¹é…çš„URLæ¨¡å¼æŒ‡å®šç‰¹æ®Šè¿‡æ»¤å™¨é“¾ã€‚è¿™æ„å‘³ç€åœ¨ä½¿ç”¨Shiroè¿‡æ»¤æœºåˆ¶çš„æ—¶å€™ä½ æœ‰å¾ˆå¤§çš„çµæ´»æ€§â€“æ¯”åœ¨web.xmlä¸­å®šä¹‰çš„è¿‡æ»¤å™¨å¥½å¾ˆå¤šã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[urls]</div><div class="line">/assets/** = anon</div><div class="line">/user/signup = anon</div><div class="line">/user/** = user</div><div class="line">/rpc/rest/** = perms[rpc:invoke], authc</div><div class="line">/** = authc</div></pre></td></tr></table></figure></p>
<p>å¦‚ä½ æ‰€è§ï¼Œæœ‰ä¸€ä¸ªç”¨äºwebåº”ç”¨çš„[urls]éƒ¨åˆ†ã€‚æ¯ä¸€è¡Œç­‰å·çš„å·¦è¾¹è¡¨ç¤ºä¸€ä¸ªä¸Šä¸‹æ–‡ç›¸å…³çš„webåº”ç”¨è·¯å¾„ã€‚ç­‰å·å³è¾¹å®šä¹‰äº†ä¸€ä¸ªè¿‡æ»¤å™¨é“¾â€“æœ‰åºçš„ã€é€—å·åˆ†éš”çš„ä¸ºæŒ‡å®šè·¯å¾„æ‰§è¡Œservletè¿‡æ»¤å™¨åˆ—è¡¨ã€‚æ¯ä¸€ä¸ªè¿‡æ»¤å™¨æ˜¯ä¸€ä¸ªservlet filterï¼Œä½†æ˜¯ä½ åœ¨ä¸Šè¿°çœ‹åˆ°çš„è¿‡æ»¤å™¨æ˜¯ç‰¹æ®Šçš„ï¼Œæ˜¯ä¸å®‰å…¨ç›¸å…³çš„ç”±Shiroæä¾›å¼€ç®±å³ç”¨çš„è¿‡æ»¤å™¨ã€‚ä½ å¯ä»¥ç»„åˆå’ŒåŒ¹é…è¿™äº›å®‰å…¨è¿‡æ»¤å™¨ï¼Œä»¥åˆ›å»ºè‡ªå®šä¹‰çš„å®‰å…¨ä½“éªŒã€‚ä½ è¿˜å¯ä»¥æŒ‡å®šä»»ä½•å…¶ä»–ç°æœ‰çš„å¯èƒ½æ‹¥æœ‰çš„Servletè¿‡æ»¤å™¨ã€‚</p>
<p>ä½¿ç”¨Shiroï¼Œæ›´å®¹æ˜“çœ‹å‡ºä¸ºç»™å®šçš„åŒ¹é…è·¯å¾„æ‰§è¡Œçš„è¿‡æ»¤å™¨é“¾ã€‚åªè¦ä½ æƒ³ï¼Œä½ å¯ä»¥åªåœ¨web.xmlä¸­å®šä¹‰Shiro filterç„¶ååœ¨inié…ç½®æ–‡ä»¶ä¸­å®šä¹‰å…¶ä»–è¿‡æ»¤å™¨å’Œè¿‡æ»¤å™¨é“¾ï¼Œè¿™æ ·æ¯”web.xmlæ›´ç®€æ´ï¼Œæ˜“äºç†è§£çš„è¿‡æ»¤å™¨é“¾å®šä¹‰æœºåˆ¶ã€‚å³ä½¿ä½ æ²¡æœ‰ä½¿ç”¨ä»»ä½•Shiroçš„å®‰å…¨ç‰¹æ€§ï¼Œè¿™ä¸ªå°å°çš„æ–¹ä¾¿è®©Shiroå€¼å¾—ä½¿ç”¨ã€‚</p>
<h4 id="JSP-Tag-Library"><a href="#JSP-Tag-Library" class="headerlink" title="JSP Tag Library"></a>JSP Tag Library</h4><p>Shiroè¿˜æä¾›ä¸€å¥—JSPæ ‡ç­¾æ¥å…è®¸ä½ åŸºäºå½“å‰ä¸»ä½“çš„çŠ¶æ€æ§åˆ¶é¡µé¢è¾“å‡ºã€‚ä¸€ä¸ªå¸¸è§æœ‰ç”¨çš„ä¾‹å­å°±æ˜¯å½“ä¸€ä¸ªç”¨æˆ·ç™»å½•åæ˜¾ç¤ºâ€˜Hello <username>â€™æ–‡æœ¬ã€‚ä½†æ˜¯å‡å¦‚ä»–ä»¬æ˜¯åŒ¿åçš„ï¼Œä½ å°±å¾—æ˜¾ç¤ºç‚¹åˆ«çš„ï¼Œåƒâ€œHello! Register Today!â€ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;%@ taglib prefix=&quot;shiro&quot;</div><div class="line">    uri=&quot;http://shiro.apache.org/tags&quot; %&gt;</div><div class="line">...</div><div class="line">&lt;p&gt;Hello</div><div class="line">&lt;shiro:user&gt;</div><div class="line">    &lt;!-- shiro:principal prints out the Subjectâ€™s main</div><div class="line">        principal - in this case, a username: --&gt;</div><div class="line">    &lt;shiro:principal/&gt;!</div><div class="line">&lt;/shiro:user&gt;</div><div class="line">&lt;shiro:guest&gt;</div><div class="line">    &lt;!-- not logged in - considered a guest. Show</div><div class="line">        the register link: --&gt;</div><div class="line">    ! &lt;a href=â€register.jspâ€&gt;Register today!&lt;/a&gt;</div><div class="line">&lt;/shiro:guest&gt;</div><div class="line">&lt;/p&gt;</div></pre></td></tr></table></figure></username></p>
<p>è¿˜æœ‰å…¶ä»–æ ‡ç­¾åŸºäºç”¨æˆ·æœ‰å“ªäº›è§’è‰²æˆ–è€…æ²¡æœ‰å“ªäº›è§’è‰²ï¼Œåˆ†é…äº†å“ªäº›æƒé™ï¼Œæœ‰æ²¡æœ‰è¢«è®¤è¯ï¼Œâ€œè®°ä½æˆ‘â€äº†çš„ï¼Œæˆ–è€…ä¸€ä¸ªåŒ¿åç”¨æˆ·æ¥å…è®¸ä½ è¾“å‡ºã€‚<br>Shiroæ”¯æŒå¾ˆå¤šwebç‰¹æœ‰çš„featureï¼Œåƒè®°ä½æˆ‘ï¼ŒRESTå’ŒBASICè®¤è¯ï¼Œå½“ç„¶ï¼Œå¦‚æœä½ å¸Œæœ›ä½¿ç”¨Shiroçš„æœ¬åœ°ä¼ä¸šä¼šè¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€æ˜çš„HttpSessionæ”¯æŒã€‚å‚è§<a href="http://shiro.apache.org/web.html" target="_blank" rel="external">Apache Shiro web documentation</a></p>
<h4 id="Web-Session-Management"><a href="#Web-Session-Management" class="headerlink" title="Web Session Management"></a>Web Session Management</h4><p>æœ€åï¼Œæœ‰è¶£çš„æ˜¯æ¢è®¨Shiroåœ¨webç¯å¢ƒä¸­å¯¹sessionçš„æ”¯æŒã€‚</p>
<h5 id="Default-Http-Sessions"><a href="#Default-Http-Sessions" class="headerlink" title="Default Http Sessions"></a>Default Http Sessions</h5><p>å¯¹webåº”ç”¨è€Œè¨€ï¼ŒShiroé»˜è®¤çš„sessionæ¶æ„æ˜¯æˆ‘ä»¬ç°æœ‰å¸¸ä½¿ç”¨çš„Servlet Containerã€‚å½“ä½ è°ƒç”¨<code>subject.getSession()</code>å’Œ<code>subject.getSession(boolean)</code>æ–¹æ³•çš„æ—¶å€™ï¼ŒShiroä¼šè¿”å›ä¸€ä¸ªç”±Servlet å®¹å™¨æ”¯æŒçš„sessionå®ä¾‹ã€‚è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯è°ƒç”¨subject.getSessionï¼ˆï¼‰çš„ä¸šåŠ¡å±‚ä»£ç ä¸Shiro Sessionå®ä¾‹è¿›è¡Œäº¤äº’â€“å®ƒå¹¶ä¸çŸ¥é“æ˜¯å’Œä¸€ä¸ªåŸºäºwebçš„HTTPSessionå¯¹è±¡ä¸€èµ·å·¥ä½œçš„ã€‚åˆ†å±‚æ¶æ„ä¿æŒä»£ç æ•´æ´æ˜¯å¾ˆå¥½çš„åšæ³•ã€‚</p>
<h5 id="Shiroâ€™s-Native-Sessions-in-the-Web-Tier"><a href="#Shiroâ€™s-Native-Sessions-in-the-Web-Tier" class="headerlink" title="Shiroâ€™s Native Sessions in the Web Tier"></a>Shiroâ€™s Native Sessions in the Web Tier</h5><p>å‡å¦‚ä½ åœ¨webåº”ç”¨ä¸­å¼€å¯äº†Shiroçš„æœ¬åœ°sessionç®¡ç†ï¼Œä½ éœ€è¦Shiroçš„ä¼ä¸šsessionç‰¹æ€§ï¼ˆç±»ä¼¼ç‹¬ç«‹äºå®¹å™¨çš„é›†ç¾¤ï¼‰ï¼Œå½“ç„¶ä½ æƒ³<code>HttpServletRequest.getSession()</code> å’Œ<code>HttpSession</code> APIå’Œæœ¬åœ°sessionä¸€èµ·ä½¿ç”¨è€Œä¸æ˜¯servletå®¹å™¨çš„sessionã€‚å¦‚æœä½ è¦é‡æ„ä»»ä½•ä½¿ç”¨HttpServletRequestå’ŒHttpSession APIçš„ä»£ç ï¼Œè€Œä¸æ˜¯ä½¿ç”¨Shiroçš„Session APIï¼Œé‚£å°†æ˜¯éå¸¸ä»¤äººæ²®ä¸§çš„ã€‚Shiroæ°¸è¿œä¸æœŸæœ›ä½ è¿™æ ·åšã€‚ç›¸åï¼ŒShiroå®Œå…¨å®ç°äº†Servletè§„èŒƒçš„Sessionéƒ¨åˆ†ï¼Œä»¥æ”¯æŒWebåº”ç”¨ç¨‹åºä¸­çš„æœ¬æœºä¼šè¯ã€‚è¿™æ„å‘³ç€æ¯å½“ä½ è°ƒç”¨ç›¸åº”çš„HttpServletRequestæˆ–HttpSessionæ–¹æ³•è°ƒç”¨æ—¶ï¼ŒShiroä¼šå°†è¿™äº›è°ƒç”¨å§”æ‰˜ç»™å…¶å†…éƒ¨æœ¬åœ°Session APIã€‚ç»“æœå°±æ˜¯ä½ ä¸éœ€è¦å»æ”¹åŠ¨ä½ çš„ä»£ç ï¼Œå³ä½¿ä½ ä½¿ç”¨Shiroæœ¬åœ°ä¼šè¯ç®¡ç†â€“å®é™…ä¸Šæ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿å’Œå¿…è¦çš„ç‰¹æ€§ã€‚</p>
<h3 id="Additional-Features"><a href="#Additional-Features" class="headerlink" title="Additional Features"></a>Additional Features</h3><p>åœ¨Shiroæ¡†æ¶ä¸­å…¶ä»–ç”¨äºè®©Javaåº”ç”¨å®‰å…¨çš„ç‰¹æ€§ï¼Œä¾‹å¦‚ï¼ˆä¸­æ–‡ç¿»è¯‘å¤ªæ™¦æ¶©ï¼Œè¿˜æ˜¯ç›´æ¥è´´åŸæ–‡çš„ï¼‰ï¼š</p>
<ul>
<li>Threading and Concurrency support for maintaining Subjects across threads (Executor and ExecutorService support)</li>
<li>Callable and Runnable support for executing logic as a specific Subject</li>
<li>â€œRun Asâ€ support for assuming the identity of another Subject (e.g. useful in administrative applications)</li>
<li>Test harness support, making it very easy to have full testing of Shiro secured-code in unit and integration tests</li>
</ul>
<h3 id="Framework-Limitations"><a href="#Framework-Limitations" class="headerlink" title="Framework Limitations"></a>Framework Limitations</h3><p>å°±åƒæˆ‘ä»¬æƒ³è¦çš„é‚£æ ·ï¼ŒApache Shiroä¸æ˜¯ä¸€ä¸ªâ€œé“¶å¼¹â€â€“å®ƒä¸ä¼šè½»æ˜“è§£å†³æ‰€æœ‰å®‰å…¨é—®é¢˜ã€‚Shiroæ²¡æœ‰è§£å†³è¿™äº›äº‹æƒ…:</p>
<ul>
<li>è™šæ‹Ÿæœºçº§åˆ«çš„è€ƒè™‘ï¼šå½“å‰Shiroæ²¡æœ‰è€ƒè™‘è™šæ‹Ÿæœºçº§åˆ«çš„å®‰å…¨ï¼Œæ¯”å¦‚åŸºäºè®¿é—®æ§åˆ¶ç­–ç•¥çš„é˜»æ­¢ç‰¹å®šçš„classåŠ è½½åˆ°ç±»åŠ è½½å™¨ä¸­ã€‚ç„¶è€ŒShiroå’Œç°æœ‰çš„JVMå®‰å…¨æ“ä½œæ•´åˆèµ·æ¥æ˜¯ä¸å¯æ€è®®çš„â€“åªæ˜¯æ²¡æœ‰äººå»ä¸ºè¿™ä¸ªé¡¹ç›®åšè¿™ä»¶äº‹ç½¢äº†ã€‚</li>
<li>å¤šé˜¶æ®µè®¤è¯ï¼šShiroå½“å‰ä¸æ”¯æŒâ€˜å¤šé˜¶æ®µâ€™è®¤è¯ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ä¸€ç§æœºåˆ¶ç™»å½•ï¼Œåªèƒ½è¢«è¦æ±‚ä½¿ç”¨ä¸åŒçš„æœºåˆ¶å†æ¬¡ç™»å½•ã€‚è¿™å·²ç»åœ¨åŸºäºShiroçš„åº”ç”¨ç¨‹åºä¸­å®Œæˆï¼Œä½†åº”ç”¨ç¨‹åºé€šè¿‡åº”ç”¨ç¨‹åºæ”¶é›†æ‰€æœ‰å¿…éœ€çš„ä¿¡æ¯ï¼Œç„¶åä¸Shiroè¿›è¡Œäº¤äº’ã€‚å¾ˆå¯èƒ½åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­ä¼šæœ‰è¿™ç§æ”¯æŒã€‚</li>
<li>å†™åŸŸæ“ä½œï¼šå½“å‰æ‰€æœ‰çš„åŸŸå®ç°æ”¯æŒè¯»æ“ä½œæ¥è·å–è®¤è¯å’Œæˆæƒæ•°æ®ç”¨æ¥æ‰§è¡Œç™»å½•å’Œè®¿é—®æ§åˆ¶ã€‚å†™æ“ä½œï¼Œåƒåˆ›å»ºç”¨æˆ·ï¼Œç»„å’Œè§’è‰²æˆ–è€…å°†ç”¨æˆ·å’Œè§’è‰²ç»„åŠæƒé™å…³è”èµ·æ¥éƒ½æ˜¯ä¸æ”¯æŒçš„ã€‚è¿™æ˜¯å› ä¸ºæ”¯æŒè¿™äº›æ“ä½œçš„æ•°æ®æ¨¡å‹åœ¨åº”ç”¨ç¨‹åºä¸­æœ‰å¾ˆå¤§å·®å¼‚ï¼Œæ‰€ä»¥åœ¨æ‰€æœ‰Shiroç”¨æˆ·ä¸Šæ‰§è¡Œâ€œå†™å…¥â€APIå°†æ˜¯å›°éš¾çš„ã€‚</li>
</ul>
<h3 id="Upcoming-Features"><a href="#Upcoming-Features" class="headerlink" title="Upcoming Features"></a>Upcoming Features</h3><p>Shiroçš„ç¤¾åŒºæ¯å¤©éƒ½å¾ˆæ´»è·ƒï¼ŒShiroçš„ç‰¹æ€§ä¹Ÿåœ¨å˜å¤šã€‚åœ¨æ¥ä¸‹æ¥çš„ç‰ˆæœ¬ä¸­ä½ å°†çœ‹åˆ°:</p>
<ul>
<li>ç®€æ´çš„web filteræœºåˆ¶ï¼Œå…è®¸æ›´å¤šçš„å¯æ’æ‹”çš„è¿‡æ»¤å™¨æ”¯æŒï¼Œè€Œä¸æ˜¯é€šè¿‡å­ç±»ã€‚</li>
<li>æ›´å¤šå¯æ’æ‹”çš„é»˜è®¤æœ‰åˆ©äºç»„åˆç»§æ‰¿çš„åŸŸå®ç°ã€‚ä½ å°†èƒ½å¤Ÿæ’æ‹”æŸ¥æ‰¾èº«ä»½éªŒè¯å’Œæˆæƒæ•°æ®çš„ç»„ä»¶ï¼Œè€Œä¸æ˜¯è¦æ±‚ä½ å¯¹Shiro Realmå®ç°è¿›è¡Œå­ç±»å®ç°ã€‚</li>
<li>å¼ºå¤§çš„OpenIDå’ŒOAuthï¼ˆæˆ–è€…éƒ½æœ‰ï¼‰å®¢æˆ·ç«¯æ”¯æŒ</li>
<li>éªŒè¯ç æ”¯æŒ</li>
<li>100ï¼…æ— çŠ¶æ€åº”ç”¨ç¨‹åºï¼ˆä¾‹å¦‚è®¸å¤šRESTç¯å¢ƒï¼‰æ›´å®¹æ˜“é…ç½®ã€‚</li>
<li>é€šè¿‡è¯·æ±‚/å“åº”åè®®è¿›è¡Œå¤šçº§è®¤è¯ã€‚</li>
<li>é€šè¿‡AuthorizationRequestè¿›è¡Œç²—ç²’åº¦æˆæƒã€‚</li>
<li><a href="http://www.antlr.org/" target="_blank" rel="external">ANTLR</a>è¯­æ³•ç”¨äºå®‰å…¨æ–­è¨€æŸ¥è¯¢ï¼ˆä¾‹å¦‚ï¼ˆâ€™roleï¼ˆadminï¼‰&amp;&amp;ï¼ˆguest ||ï¼groupï¼ˆdeveloperï¼‰ï¼‰â€™ï¼‰</li>
</ul>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>Apache Shiroæ˜¯ä¸€ä¸ªåŠŸèƒ½é½å…¨ï¼ŒåŠŸèƒ½å¼ºå¤§ä¸”é€šç”¨çš„Javaå®‰å…¨æ¡†æ¶ï¼Œå¯ç”¨äºä¿æŠ¤ä½ çš„åº”ç”¨ç¨‹åºã€‚é€šè¿‡ç®€åŒ–åº”ç”¨å®‰å…¨æ€§çš„å››ä¸ªæ–¹é¢ï¼Œå³è®¤è¯ï¼Œæˆæƒï¼Œä¼šè¯ç®¡ç†å’Œå¯†ç ï¼Œåº”ç”¨å®‰å…¨æ€§åœ¨å®é™…åº”ç”¨ä¸­æ›´å®¹æ˜“ç†è§£å’Œå®ç°ã€‚Shiroçš„ç®€å•æ¶æ„å’ŒJavaBeanså…¼å®¹æ€§å…è®¸åœ¨å‡ ä¹ä»»ä½•ç¯å¢ƒä¸­è¿›è¡Œé…ç½®å’Œä½¿ç”¨ã€‚é¢å¤–çš„ç½‘ç»œæ”¯æŒå’Œè¾…åŠ©åŠŸèƒ½ï¼Œå¦‚å¯¹å¤šçº¿ç¨‹å’Œæµ‹è¯•çš„æ”¯æŒï¼Œæ•´åˆæ¡†æ¶ï¼Œä¸ºåº”ç”¨ç¨‹åºå®‰å…¨æ€§æä¾›å¯èƒ½æ˜¯ä½ çš„â€œä¸€ç«™å¼â€æœåŠ¡ã€‚Apache Shiroçš„å¼€å‘å›¢é˜Ÿç»§ç»­å‰è¿›ï¼Œæ”¹è¿›ä»£ç åº“å¹¶æ”¯æŒç¤¾åŒºã€‚éšç€å¼€æºä»£ç å’Œå•†ä¸šåŒ–çš„é‡‡ç”¨ï¼ŒShiroåªä¼šè¶Šæ¥è¶Šå¼ºã€‚</p>
<h3 id="About-the-Author"><a href="#About-the-Author" class="headerlink" title="About the Author"></a>About the Author</h3><p>Les Hazlewoodæ˜¯Shiro PMCä¸»å¸­ï¼ŒKatasoftçš„è”åˆåˆ›å§‹äººå…¼é¦–å¸­æŠ€æœ¯å®˜ï¼Œä¸“æ³¨äºåº”ç”¨ç¨‹åºå®‰å…¨äº§å“å’Œå¯¹Apache Shiroçš„æ”¯æŒã€‚Lesæ‹¥æœ‰10å¹´çš„Javaå¼€å‘å’Œä¼ä¸šæ¶æ„å¸ˆç»éªŒï¼Œæ›¾åœ¨Bloomberg, Delta Airlines, å’Œ JBossæ‹…ä»»è¿‡é«˜çº§èŒåŠ¡ã€‚Lesä¸€ç›´åœ¨ç§¯æå‚ä¸å¼€æºå¼€å‘9å¹´ä»¥ä¸Šï¼Œä¸ºSpring Frameworkï¼ŒHibernateï¼ŒJBossï¼ŒOpenSpacesä»¥åŠApache Shiroçš„å‰èº«JSecurityç­‰é¡¹ç›®æäº¤æˆ–è´¡çŒ®è¿‡ä»£ç ã€‚Lesç›®å‰ä½åœ¨åŠ å·åœ£é©¬ç‰¹å¥¥ï¼Œå¹¶ä¸”åœ¨ä¸ç¼–ç¨‹çš„æ—¶å€™ç»ƒä¹ å‰‘é“å’Œç ”ç©¶æ—¥è¯­ã€‚</p>
<p>æŸ¥çœ‹è‹±æ–‡åŸæ–‡ï¼š <a href="https://www.infoq.com/articles/apache-shiro" target="_blank" rel="external">Application Security With Apache Shiro</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å½“ä½ ä¸ºä½ çš„åº”ç”¨æ·»åŠ å®‰å…¨æªæ–½çš„æ—¶å€™æœ‰æ²¡æœ‰è§‰å¾—å¾ˆå—æŒ«ï¼Ÿä½ æœ‰æ²¡æœ‰è§‰å¾—Javaåœ¨å®‰å…¨è¿™ä¸€å—çš„è§£å†³æ–¹æ¡ˆç”¨èµ·æ¥å¾ˆéš¾ï¼Œè®©ä½ æ›´åŠ è§‰å¾—å›°æƒ‘ï¼Ÿè¿™ç¯‡æ–‡ç« ä»‹ç»&lt;a href=&quot;http://shiro.apache.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Apac
    
    </summary>
    
      <category term="Apache" scheme="http://www.wei-dong.top/categories/Apache/"/>
    
    
      <category term="Apache Shiro" scheme="http://www.wei-dong.top/tags/Apache-Shiro/"/>
    
      <category term="ç¿»è¯‘" scheme="http://www.wei-dong.top/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot Featuresï¼ˆPart â…¡ï¼‰</title>
    <link href="http://www.wei-dong.top/2017/08/10/spring-boot-fatures-2/"/>
    <id>http://www.wei-dong.top/2017/08/10/spring-boot-fatures-2/</id>
    <published>2017-08-10T13:58:23.000Z</published>
    <updated>2017-08-10T13:59:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬ç¯‡ç»§ç»­é’ˆå¯¹ä¸Šä¸€ç¯‡æ–‡ç« å¯¹spring boot æœªä»‹ç»å®Œçš„featureè¿›è¡Œè¡¥å……ã€‚<br><a id="more"></a> </p>
<h3 id="Profiles"><a href="#Profiles" class="headerlink" title="Profiles"></a>Profiles</h3><p>ç”¨è¿‡mavenéƒ½çŸ¥é“ï¼Œmavenä¸­æœ‰ä¸ªprofilesçš„è®¾ç½®ã€‚</p>
<blockquote>
<p>profileä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§å°±æ˜¯å®ƒå¯ä»¥æ ¹æ®ä¸åŒçš„ç¯å¢ƒæ¥æ¿€æ´»ï¼Œæ¯”å¦‚è¯´æ ¹æ®æ“ä½œç³»ç»Ÿçš„ä¸åŒæ¿€æ´»ä¸åŒçš„profileï¼Œä¹Ÿå¯ä»¥æ ¹æ®jdkç‰ˆæœ¬çš„ä¸åŒæ¿€æ´»ä¸åŒçš„profile.<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span>  </div><div class="line">       <span class="tag">&lt;<span class="name">profile</span>&gt;</span>  </div><div class="line">              <span class="tag">&lt;<span class="name">id</span>&gt;</span>profileTest1<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </div><div class="line">              <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>1.5<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span>  </div><div class="line">       <span class="tag">&lt;/<span class="name">profile</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></div></pre></td></tr></table></figure></p>
</blockquote>
<p>ä¸Šé¢çš„é…ç½®å°±æ˜¯å½“JDKç‰ˆæœ¬ä¸º1.5çš„æ—¶å€™æ¿€æ´»profileTest1ã€‚<br>spring bootä¹Ÿæä¾›è¿™ä¹ˆä¸€ç§æœºåˆ¶ã€‚åœ¨ç‰¹å®šçš„ç¯å¢ƒä¸‹ä½¿ç”¨ç‰¹å®šçš„é…ç½®ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@Profile</span>(<span class="string">"production"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductionConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„é…ç½®å°±æ˜¯åœ¨productionç¯å¢ƒä¸‹ç”Ÿæ•ˆã€‚é€šå¸¸åœ¨<code>application.properties</code>è¿™ä¸ªæ–‡ä»¶ä¸‹é…ç½®<code>spring.profiles.active=xxx</code>å±æ€§æ¥æŒ‡å®šä¸åŒçš„profileã€‚å½“ç„¶ä½¿ç”¨å‘½ä»¤è¡Œä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<p>å…¶å®è¿™ä¸ªfeatureä¸ç®—ä»€ä¹ˆç‰¹æ€§ï¼Œå¾ˆä¸€èˆ¬ã€‚</p>
<h3 id="Logging"><a href="#Logging" class="headerlink" title="Logging"></a>Logging</h3><p>spring boot å†…éƒ¨çš„æ—¥å¿—æ˜¯ä½¿ç”¨çš„Common Loggingï¼Œä½†æ˜¯ä¹Ÿæä¾›å¾ˆå¤šå…¶ä»–çš„å®ç°ã€‚é»˜è®¤è¿˜æä¾›JULã€Log4Jå’ŒLogbackã€‚</p>
<p>æ—¥å¿—è¾“å‡ºæ–‡æœ¬çš„é¢œè‰²æ˜¯å¯ä»¥è®¾ç½®çš„ï¼Œå‡å¦‚æ§åˆ¶å°æ”¯æŒANSIçš„è¯ï¼Œç„¶è€Œæˆ‘è§‰å¾—å¹¶æ²¡åµç”¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ—¥å¿—åªä¼šè¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œä¸ä¼šè¾“å‡ºåˆ°æ–‡ä»¶ã€‚åŠ å…¥è¦è¾“å‡ºåˆ°æ–‡ä»¶å°±éœ€è¦åœ¨åŒæ ·åœ¨<code>application.properties</code>æ–‡ä»¶ä¸­é…ç½®ä¸€ä¸‹è¿™å‡ ä¸ªå±æ€§äº†ï¼š<code>logging.file</code> <code>logging.path</code>ã€‚æ–‡ä»¶åä¸å†™çš„è¯é»˜è®¤ä¸º<code>spring.log</code>ï¼Œè·¯å¾„ä¸å†™çš„è¯é»˜è®¤åœ¨å½“å‰è·¯å¾„ä¸‹ã€‚æ—¥å¿—æ–‡ä»¶åˆ°10mçš„æ—¶å€™å°±å›é‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„æ–‡ä»¶ã€‚</p>
<p>ç»™æ—¥å¿—è®¾ç½®çº§åˆ«å°±ä¸å¤šæäº†ï¼Œéƒ½æ˜¯å¾ˆè€æ‰ç‰™çš„ä¸œè¥¿äº†ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">logging.level.root=WARN</div><div class="line">logging.level.org.springframework.web=DEBUG</div><div class="line">logging.level.org.hibernate=ERROR</div></pre></td></tr></table></figure></p>
<p>è‡ªå®šä¹‰æ—¥å¿—ç»„ä»¶ä¹Ÿæ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ï¼Œæ¯ä¸ªæ—¥å¿—æ¡†æ¶éƒ½æœ‰æ‰€ä¸åŒå˜›ã€‚spring bootæä¾›è¿™ç§çƒ­æ’æ‹”å¼çš„é…ç½®ã€‚åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®š<code>logging.config</code>çš„å€¼å³å¯ã€‚è¿™ä¸ªå±æ€§ä»£è¡¨ç€æ—¥å¿—é…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚ä¸åŒçš„æ—¥å¿—ç³»ç»Ÿæœ‰ä¸åŒçš„é…ç½®æ–‡ä»¶ã€‚</p>
<ul>
<li><code>logback-spring.xml</code>, <code>logback-spring.groovy</code>, <code>logback.xml</code> or <code>logback.groovy</code>æ˜¯logbackçš„ã€‚</li>
<li><code>log4j2-spring.xml</code>, <code>log4j2.xml</code>æ˜¯log4j2çš„ã€‚</li>
<li><code>logging.properties</code>æ˜¯JULçš„ã€‚<br>æ—¥å¿—ç³»ç»Ÿæ²¡ä»€ä¹ˆå¯è¯´çš„ï¼Œå¯¹æˆ‘è€Œè¨€ï¼Œä½¿ç”¨é»˜è®¤çš„å°±å®Œäº‹å„¿äº†ã€‚</li>
</ul>
<p>åŸºæœ¬ä¸Šæ ¸å¿ƒfeatureå…¨éƒ¨æ¢³ç†å®Œäº†ã€‚æ¥ä¸‹æ¥çœ‹çœ‹Web Applications Featuresã€‚</p>
<h3 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h3><p>spring bootä¹Ÿé€‚åˆwebå¼€å‘ï¼Œä½¿ç”¨<code>spring-boot-starter-web</code>æ¨¡å—å¾ˆå¿«å°±èƒ½æ­å»ºä¸€ä¸ªHTTPåº”ç”¨ã€‚<br>ä½¿ç”¨è¿‡Spring MVCçš„å¼€å‘è€…æ¥è®²ï¼Œè¿™ä¸ªfeatureä¸€ç‚¹éƒ½ä¸æ–°é²œã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/users"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRestController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;user&#125;"</span>, method=RequestMethod.GET)</div><div class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(@PathVariable Long user)</span> </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;user&#125;/customers"</span>, method=RequestMethod.GET)</div><div class="line">    <span class="function">List&lt;Customer&gt; <span class="title">getUserCustomers</span><span class="params">(@PathVariable Long user)</span> </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;user&#125;"</span>, method=RequestMethod.DELETE)</div><div class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">deleteUser</span><span class="params">(@PathVariable Long user)</span> </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªæ —å­ä½¿ç”¨<code>@RestController</code>æ³¨è§£æ¥è¿”å›JSONæ•°æ®ã€‚<br>è¿˜æœ‰å¾ˆå¤šæ›´è¯¦ç»†çš„å†…å®¹ï¼Œå¯ä»¥å‚è§<a href="http://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/htmlsingle/#mvc" target="_blank" rel="external">spring framework å®˜æ–¹æ–‡æ¡£</a></p>
<h3 id="Working-with-SQL-databases"><a href="#Working-with-SQL-databases" class="headerlink" title="Working with SQL databases"></a>Working with SQL databases</h3><p>spring bootä¸­å¯¹æ•°æ®åº“çš„æ”¯æŒå¯ä»¥è¯´æ˜¯çˆ½ç¿»å¤©ã€‚</p>
<p>é¦–å…ˆå¾—åˆ›å»ºä¸€ä¸ªæ•°æ®æºï¼ŒåºŸè¯ä¸å¤šè¯´ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="meta">@ConfigurationProperties</span>(prefix=<span class="string">"app.datasource"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FancyDataSource();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app.datasource.url=jdbc:h2:mem:mydb</div><div class="line">app.datasource.username=sa</div><div class="line">app.datasource.pool-size=30</div></pre></td></tr></table></figure>
<p>æ„æ€å°±æ˜¯è¿™ä¹ˆä¸ªæ„æ€ï¼Œé…ç½®æ–¹å¼å¤šç§å¤šæ ·ã€‚ä¸ä»…ä»…å¯ä»¥æ”¯æŒå¤–éƒ¨æ•°æ®åº“ï¼Œå†…å­˜æ•°æ®åº“ä¹Ÿæ˜¯æ”¯æŒçš„ã€‚ä¾‹å¦‚H2ã€HSQLå’ŒDerbyï¼Œåœ¨spring bootä¸­åªéœ€è¦æä¾›ä¸€ä¸ªä¾èµ–å¥¹å°±èƒ½è‡ªåŠ¨é…ç½®ï¼Œå°±æ˜¯è¿™ä¹ˆå‰å®³ã€‚<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hsqldb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hsqldb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>åœ¨å¯¹å¤–éƒ¨æ•°æ®åº“çš„è¿æ¥ç®¡ç†ä¸­ï¼Œspring bootä½¿ç”¨çš„æ˜¯æ± åŒ–çš„æ•°æ®æºã€‚å¯¹äºä½¿ç”¨ä½•ç§æ± åŒ–æ–¹å¼ï¼Œç­–ç•¥æ˜¯è¿™æ ·çš„ï¼šTomcatçš„è¿æ¥æ± &gt;HikariCP&gt;DBCP(ä¸æ¨èï¼Œå› ä¸ºæ²¡äººå»ç»´æŠ¤äº†)&gt;DBCP2ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">spring.datasource.url=jdbc:mysql://localhost/test</div><div class="line">spring.datasource.username=dbuser</div><div class="line">spring.datasource.password=dbpass</div><div class="line">spring.datasource.driver-class-name=com.mysql.jdbc.Driver</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­çš„urlæ˜¯ä¸€å®šè¦å†™çš„ï¼Œä¸ç„¶çš„è¯spring bootå»è‡ªåŠ¨å»é…ç½®å†…åµŒçš„æ•°æ®åº“äº†ã€‚driverå¯ä»¥ä¸æŒ‡å®šï¼Œå› ä¸ºå¯ä»¥é€šè¿‡urlå»åˆ¤æ–­driverã€‚</p>
<p>è¯´å®Œæ•°æ®æºï¼Œå†èŠèŠJdbcTemplateã€‚è¿™ä¸ªä¸œè¥¿åœ¨spring bootä¸­ç”¨èµ·æ¥æ˜¯éå¸¸çˆ½ï¼Œç›´æ¥å°±èƒ½ç”¨ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBean</span><span class="params">(JdbcTemplate jdbcTemplate)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jdbcTemplate = jdbcTemplate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»…æ­¤è€Œå·²ï¼</p>
<p>å…³äºspring dataå’ŒJPA çš„ä»‹ç»ä¹Ÿæ²¡æœ‰å¤šè§£é‡Šï¼Œæ–‡æ¡£è¯´å¾ˆå¤šç»†èŠ‚è®©æˆ‘ä»¬å»<a href="https://spring.io/guides/gs/accessing-data-jpa/" target="_blank" rel="external">è¿™é‡Œ</a>çœ‹çœ‹ï¼Œçœ‹æ¥è¿˜æ˜¯æ¯”è¾ƒå¤æ‚ã€‚</p>
<p>åœ¨ä¼ ç»Ÿçš„JPAä¸­entityéœ€è¦åœ¨<code>persistence.xml</code>ä¸­å®šä¹‰ã€‚ä½†åœ¨spring bootä¸­ä¸éœ€è¦è¿™ä¹ˆéº»çƒ¦ï¼Œå› ä¸ºå¥¹èƒ½å¸®ä½ æ‰«æåˆ°ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Entity</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">City</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Id</span></div><div class="line">    <span class="meta">@GeneratedValue</span></div><div class="line">    <span class="keyword">private</span> Long id;</div><div class="line"></div><div class="line">    <span class="meta">@Column</span>(nullable = <span class="keyword">false</span>)</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="meta">@Column</span>(nullable = <span class="keyword">false</span>)</div><div class="line">    <span class="keyword">private</span> String state;</div><div class="line"></div><div class="line">    <span class="comment">// ... additional members, often include @OneToMany mappings</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">City</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// no-args constructor required by JPA spec</span></div><div class="line">        <span class="comment">// this one is protected since it shouldn't be used directly</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">City</span><span class="params">(String name, String state)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.country = country;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getState</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.state;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ... etc</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Spring Data JPA Repositoriesæ˜¯ä¸€ä¸ªå¥½ä¸œè¥¿ï¼ŒJPAæŸ¥è¯¢å¯ä»¥æ ¹æ®ä½ æ–¹æ³•çš„åå­—æ¥ã€‚ä¸¾ä¸ªæ —å­ï¼Œ<code>CityRepository</code>æ¥å£å®šä¹‰ä¸€ä¸ª<code>findAllByState(String state)</code>æ–¹æ³•ï¼Œä½ ä¼ ä¸€ä¸ªstateæ¡ä»¶å®ƒå°±èƒ½æŸ¥å‡ºæ¥ã€‚</p>
<p>ç„¶è€Œè¿™ä»…ä»…åªæ˜¯ä¸€å°éƒ¨åˆ†ï¼Œæ–‡æ¡£æœ‰å¥è¯ç»†æ€ææï¼š</p>
<blockquote>
<p>We have barely scratched the surface of Spring Data JPA.</p>
</blockquote>
<p>spring bootå¯¹NoSQLä¹Ÿæœ‰æ”¯æŒã€‚åƒMongoBDã€Neo4Jã€Elasticsearchã€Solrã€Redisã€ Gemfireã€Cassandraã€Couchbase å’ŒLDAPã€‚</p>
<p>Redis:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> StringRedisTemplate template;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBean</span><span class="params">(StringRedisTemplate template)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.template = template;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨redisé™¤äº†æ·»åŠ <code>spring-boot-starter-data-redis</code>ä¾èµ–å¤–ï¼Œæƒ³ç”¨çš„è¯å¦‚ä¸Šé¢ä»£ç ä¸€æ ·ç®€å•ã€‚</p>
<p>MongoDBï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MongoDbFactory mongo;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBean</span><span class="params">(MongoDbFactory mongo)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mongo = mongo;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">example</span><span class="params">()</span> </span>&#123;</div><div class="line">        DB db = mongo.getDb();</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>mongodbåŒæ ·ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå‡å¦‚ä½ çš„mongoDBé‡‡ç”¨åˆ†ç‰‡çš„è¯ï¼Œè¿™æ ·æŒ‡å®šurlå°±è¡Œï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">spring.data.mongodb.uri=mongodb://user:secret@mongo1.example.com:12345,mongo2.example.com:23456/test</div></pre></td></tr></table></figure></p>
<p>å¦‚æœä½¿ç”¨çš„æ˜¯2.xçš„ç‰ˆæœ¬ï¼Œè¿™æ ·å»é…ç½®ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">spring.data.mongodb.host=mongoserver</div><div class="line">spring.data.mongodb.port=27017</div></pre></td></tr></table></figure></p>
<p>MongoTemplateç”¨èµ·æ¥æ›´åŠ æ–¹ä¾¿ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MongoTemplate mongoTemplate;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBean</span><span class="params">(MongoTemplate mongoTemplate)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mongoTemplate = mongoTemplate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä»–çš„æ–‡æ¡£ä¸­ä¹Ÿæ²¡å¤šå»è§£é‡Šï¼Œä¸¢äº†ä¸ªé“¾æ¥è®©è¯»è€…è‡ªå·±å»çœ‹ã€‚æ‰€ä»¥è¿™é‡Œä¹Ÿä¸å¤šå»å…³æ³¨äº†ã€‚éœ€è¦çš„æ—¶å€™å†æ•´ç†ã€‚</p>
<p>spring bootä¹Ÿæä¾›å¯¹JMSçš„æ”¯æŒï¼Œè¿™ä¹Ÿç®—æ˜¯ä¸€ä¸ªfeatureå§ã€‚</p>
<p>JMSåœ¨Javaä¸­åªå®šä¹‰äº†ä¸€äº›æ¥å£ï¼Œå…·ä½“å®ç°è¿˜æ˜¯ä¾èµ–å„ä¸ªå‚å•†ã€‚å…¶ä¸­ActiveMQå°±æ˜¯ä¸€ä¸ªJMSçš„æ ‡å‡†å®ç°ï¼Œspring bootå¯¹å…¶æœ‰æ¯”è¾ƒå¥½çš„æ”¯æŒã€‚</p>
<p>åŒæ ·çš„ï¼Œåªéœ€è¦æ·»åŠ <code>spring-boot-starter-activemq</code>ä¾èµ–ï¼Œspring bootå°±èƒ½å¸®ä½ è‡ªåŠ¨å»é…ç½®ï¼Œå½“ç„¶å°‘ä¸äº†æœ€åŸºæœ¬çš„é…ç½®ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">spring.activemq.broker-url=tcp://192.168.1.210:9876</div><div class="line">spring.activemq.user=admin</div><div class="line">spring.activemq.password=secret</div></pre></td></tr></table></figure></p>
<p>å½“ç„¶ä½¿ç”¨è¿æ¥æ± ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œæ·»åŠ è¿™ä¸ªä¾èµ–å³å¯ï¼š<code>org.apache.activemq:activemq-pool</code>ï¼ŒåŒæ—¶åšå¦‚ä¸‹é…ç½®ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">spring.activemq.pool.enabled=true</div><div class="line">spring.activemq.pool.max-connections=50</div></pre></td></tr></table></figure></p>
<p>è‡³äºå…·ä½“æ€ä¹ˆå»ä½¿ç”¨è¿™é‡Œä¸å†è¯¦ç»†æè¿°ï¼Œä½¿ç”¨åˆ°çš„æ—¶å€™å†å»<a href="http://docs.spring.io/spring-boot/docs/1.5.6.RELEASE/reference/htmlsingle/#boot-features-jms" target="_blank" rel="external">è¿™é‡Œ</a>ç¿»ç¿»æ–‡æ¡£çœ‹çœ‹ã€‚</p>
<h3 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h3><p>å¯¹äºä¸€ä¸ªæ¡†æ¶æ¥è®²ï¼Œæµ‹è¯•ä¸€å®šæ˜¯å°‘ä¸äº†çš„ã€‚spring bootæä¾›äº†å¾ˆå¤šå·¥å…·è€Œæ³¨è§£æ¥å¸®åŠ©å¼€å‘è€…æµ‹è¯•ä»£ç ã€‚æœ‰ä¸¤ä¸ªæ¨¡å—éœ€è¦ä¾èµ–ï¼š<code>spring-boot-test</code>å’Œ<code>spring-boot-test-autoconfigure</code>ã€‚å‰è€…æä¾›åŸºç¡€æ”¯æŒï¼Œåè€…æä¾›è‡ªåŠ¨é…ç½®ã€‚è®¸å¤šå¼€å‘è€…åªä¼šé€‰æ‹©å‰è€…ï¼Œå‰è€…æä¾›JUnitã€AssertJã€HamcreståŠå…¶ä»–æœ‰ç”¨çš„å·¥å…·åŒ…ã€‚</p>
<p>å½“ä½ æ·»åŠ <code>spring-boot-starter-test</code>ä¾èµ–æ—¶ï¼Œä½ ä¼šå‘ç°å¾ˆå¤šåº“è¢«æ·»åŠ è¿›æ¥äº†ï¼š</p>
<ul>
<li>JUnit</li>
<li>Spring Test</li>
<li>AssertJ</li>
<li>Hamcrest</li>
<li>Mockito</li>
<li>JSONassert</li>
<li>JsonPath<br>ä¾èµ–æ³¨å…¥çš„ä¸€ä¸ªæœ€å¤§çš„å¥½å¤„å°±æ˜¯è®©å•å…ƒæµ‹è¯•å˜å¾—æ›´ç®€å•ã€‚åœ¨spring frameworkçš„æµ‹è¯•æ¡†æ¶ä¸­ï¼Œå¸¸å¸¸ä½¿ç”¨<code>@ContextConfiguration(classes=â€¦â€‹)</code>è¿™æ ·çš„é…ç½®ï¼Œæˆ–è€…åœ¨ä½ çš„æµ‹è¯•ä¸­ä½¿ç”¨åµŒå¥—çš„<code>@Configuration</code>ç±»ã€‚åœ¨spring bootä¸­ä¸éœ€è¦è¿™ä¹ˆéº»çƒ¦ï¼Œ<code>@*Test</code>ä¼šè‡ªåŠ¨å»æ‰¾ä½ çš„é…ç½®ã€‚</li>
</ul>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦è‡ªåŠ¨å»æ‰¾æµ‹è¯•çš„é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ‰‹åŠ¨æŒ‡å®šé…ç½®ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@SpringBootTest</span></div><div class="line"><span class="meta">@Import</span>(MyTestsConfiguration.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTests</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exampleTest</span><span class="params">()</span> </span>&#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è‡³äºå…¶ä»–å†…å®¹éƒ½æ²¡ä»€ä¹ˆå¯è®²çš„ï¼Œæ— éå°±æ˜¯ä¸€äº›annotationçš„ä½¿ç”¨ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>spring bootçš„ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„featureåŸºæœ¬ä¸Šéƒ½æ¢³ç†ä¸€éäº†ï¼Œå½“ç„¶ä¹Ÿæœ‰è®¸å¤šæ²¡æœ‰å¾ˆå…·ä½“æè¿°çš„åœ°æ–¹ã€‚æ•´ä¸ªç¯‡å¹…å¤ªé•¿å¤ªå¤šï¼Œå¾ˆå¤šç»†èŠ‚çš„åœ°æ–¹ä¹Ÿæ²¡æœ‰å¾ˆæ³¨æ„åˆ°ï¼Œæœ‰äº›è¡¨è¿°å’Œæ–‡å­—ç»„ç»‡è¿˜æ˜¯éå¸¸æ¬ ç¼ºï¼Œè¿™éƒ½æ˜¯è‡ªå·±å¯¹è‹±æ–‡ç‰ˆçš„æŠ€æœ¯æ–‡æ¡£æ‹¿æä¸æ˜¯å¾ˆå‡†é€ æˆçš„ã€‚æˆ‘æƒ³æˆ‘æ•´ç†çš„ä¸œè¥¿ä¹Ÿåªæœ‰æˆ‘è‡ªå·±èƒ½çœ‹æ‡‚äº†ã€‚å½“ç„¶ç›®å‰åªæ˜¯ä¸€ä¸ªprofileï¼Œå¾ˆå¤šå‘è¿˜éœ€è¦è‡ªå·±å»è¸©çš„ï¼Œåªèƒ½åœ¨ä»¥åçš„å·¥ä½œåŠå­¦ä¹ ä¸­æ…¢æ…¢æ€»ç»“ï¼Œæˆ‘æƒ³æ²¡æœ‰è°æ˜¯ä»…ä»…é€šè¿‡çœ‹äº†ä¸€ä¸‹æ–‡æ¡£å°±èƒ½å†™å‡ºæ¼‚äº®çš„ä»£ç æ¥å§ã€‚</p>
<p>æ¥ä¸‹æ¥spring bootç³»åˆ—å†…å®¹å¯èƒ½å°±æ›´å…¨é¢ï¼Œå…·ä½“æ•´ç†å“ªäº›ä¸œè¥¿ä»¥åæƒ³åˆ°åœ¨è¯´ã€‚æ¯•ç«Ÿè¿™æ¬¡çš„featureåªæ˜¯è¯•è¯•æ°´ã€‚æˆ‘ä¹Ÿå¸Œæœ›æˆ‘å¯¹è‹±æ–‡æŠ€æœ¯æ–‡æ¡£çš„ç†è§£æœ‰æ›´åŠ è´¨çš„æå‡ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬ç¯‡ç»§ç»­é’ˆå¯¹ä¸Šä¸€ç¯‡æ–‡ç« å¯¹spring boot æœªä»‹ç»å®Œçš„featureè¿›è¡Œè¡¥å……ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Spring Framework" scheme="http://www.wei-dong.top/categories/Spring-Framework/"/>
    
    
      <category term="Spring Boot" scheme="http://www.wei-dong.top/tags/Spring-Boot/"/>
    
      <category term="ç¿»è¯‘&amp;æ•´ç†" scheme="http://www.wei-dong.top/tags/%E7%BF%BB%E8%AF%91-%E6%95%B4%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot Featuresï¼ˆPart Iï¼‰</title>
    <link href="http://www.wei-dong.top/2017/08/05/spring-boot-fatures/"/>
    <id>http://www.wei-dong.top/2017/08/05/spring-boot-fatures/</id>
    <published>2017-08-05T08:59:23.000Z</published>
    <updated>2017-08-05T09:07:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨spring bootå®˜æ–¹æ–‡æ¡£ä¸­ä»‹ç»äº†ä¸å°‘featureï¼Œæˆ‘è§‰å¾—æœ‰å¿…è¦æ•´ç†ä¸€ä¸‹ï¼Œè¿˜æ˜¯æŒºæœ‰æ„æ€çš„ã€‚<br><a id="more"></a> </p>
<p>æ–‡æ¡£ä¸­æ ¹æ®åŠŸèƒ½ä½œå‡ºäº†ä»¥ä¸‹åŒºåˆ†ï¼š</p>
<ul>
<li>Core Featureï¼š SpringApplicationï¼ˆSpringåº”ç”¨ï¼‰| Externalized Configurationï¼ˆå¤–éƒ¨é…ç½®ï¼‰| Profilesï¼ˆè½®å»“ï¼‰| Loggingï¼ˆæ—¥å¿—ï¼‰ </li>
<li>Web Applicationsï¼š MVCï¼ˆä¸è§£é‡Šï¼‰| Embedded Containersï¼ˆå†…åµŒçš„å®¹å™¨ï¼‰</li>
<li>Working with dataï¼šSQL | NO-SQL</li>
<li>Messaging: JMSï¼ˆJavaæ¶ˆæ¯æœåŠ¡ï¼‰</li>
<li>Testing: Boot Applications | Utils ï¼ˆæµ‹è¯•ç›¸å…³ï¼‰</li>
<li>Extending: Auto-configuration | @Conditions ï¼ˆæ‹“å±•ï¼‰</li>
</ul>
<p>ä»¥ä¸Šçš„featureç”¨ä¸­æ–‡ç¿»è¯‘èµ·æ¥å¾ˆä¸å®¹æ˜“ç†è§£ï¼Œè¿™äº›ä¸“ä¸šæœ¯è¯­ç”¨è‹±æ–‡è¡¨ç¤ºæ›´è®©äººè§‰å¾—ç†Ÿæ‚‰ã€‚ç°åœ¨å°±é’ˆå¯¹æŸä¸ªfeatureå•ç‹¬å»ç†è§£ã€‚</p>
<h3 id="SpringApplication"><a href="#SpringApplication" class="headerlink" title="SpringApplication"></a>SpringApplication</h3><p>è¿™ä¸ªç‰¹æ€§å¯ä»¥è¯´æ˜¯spring bootçš„åˆ›æ–°ã€‚åœ¨ä»¥å¾€çš„webç¨‹åºå¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸å°†è‡ªå·±çš„ç¨‹åºéƒ¨ç½²åœ¨tomcatæˆ–è€…weblogicç±»ä¼¼çš„ä¸­é—´ä»¶ä¸Šçš„ï¼Œä½†ä½¿ç”¨spring bootä¸éœ€è¦ä¾è€è¿™æ ·çš„ä¸­é—´ä»¶ã€‚ä½¿ç”¨spring bootå¯åŠ¨ä½ çš„åº”ç”¨å°±åƒå¯åŠ¨ä¸€ä¸ªç®€å•çš„ç¨‹åºä¸€æ ·ï¼Œç±»ä¼¼æˆ‘ä»¬åˆšæ¥è§¦Javaå†™çš„ä¸€ä¸ªä¸ªçš„mainå‡½æ•°ä¸€æ ·ã€‚å®ƒåªéœ€è¦è¿™æ ·çš„ä»£ç å°±èƒ½å¯åŠ¨ä¸€ä¸ªwebåº”ç”¨äº†ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    SpringApplication.run(MySpringConfiguration.class, args);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ­£å¸¸å¯åŠ¨è‚¯å®šæ˜¯æ²¡ä»€ä¹ˆå¯è®²çš„ï¼Œé—®é¢˜æ˜¯å‡ºäº†é—®é¢˜å°±å¾ˆéš¾å—äº†ã€‚æ²¡å…³ç³»ï¼Œspring bootåŒæ ·ä¸ºå¼€å‘è€…æä¾›äº†å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚spring bootæä¾›<code>FailureAnalyzers</code>å¸®åŠ©ä½ ä¿®å¤é—®é¢˜ã€‚æ¯”æ–¹è¯´ï¼Œå‡å¦‚ä½ åœ¨8080ç«¯å£ä¸Šå¯åŠ¨webåº”ç”¨ï¼Œç„¶è€Œè¿™ä¸ªç«¯å£è¢«å ç”¨äº†ï¼Œè¿™æ—¶å€™æ§åˆ¶å°ä¼šæŠ¥å‡ºè¿™æ ·çš„é”™è¯¯ä¿¡æ¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">***************************</div><div class="line">APPLICATION FAILED TO START</div><div class="line">***************************</div><div class="line"></div><div class="line">Description:</div><div class="line"></div><div class="line">Embedded servlet container failed to start. Port 8080 was already in use.</div><div class="line"></div><div class="line">Action:</div><div class="line"></div><div class="line">Identify and stop the process that&apos;s listening on port 8080 or configure this application to listen on another port.</div></pre></td></tr></table></figure></p>
<p>é€šè¿‡æ§åˆ¶å°æ‰“å°å‡ºçš„é”™è¯¯ä¿¡æ¯ï¼Œå¾ˆå®¹æ˜“çŸ¥é“é—®é¢˜å‡ºå“ªé‡Œäº†ï¼ˆè‹±æ–‡æ°´å¹³ä¸è¦å¤ªlowï¼‰ã€‚å½“ç„¶è¿™æ˜¯ä½¿ç”¨é»˜è®¤çš„<code>FailureAnalyzers</code>ï¼Œspring boot ä¹Ÿæä¾›è‡ªå·±å®šä¹‰çš„<code>FailureAnalyzers</code>ã€‚åœ¨<code>META-INF/spring.factories</code>è¿™ä¸ªæ–‡ä»¶ä¸­æœ‰è¿™æ ·çš„å®šä¹‰ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># Failure Analyzers</div><div class="line">org.springframework.boot.diagnostics.FailureAnalyzer=\</div><div class="line">org.springframework.boot.diagnostics.analyzer.BeanCurrentlyInCreationFailureAnalyzer,\</div><div class="line">org.springframework.boot.diagnostics.analyzer.BeanNotOfRequiredTypeFailureAnalyzer,\</div><div class="line">org.springframework.boot.diagnostics.analyzer.BindFailureAnalyzer,\</div><div class="line">org.springframework.boot.diagnostics.analyzer.ConnectorStartFailureAnalyzer,\</div><div class="line">org.springframework.boot.diagnostics.analyzer.NoUniqueBeanDefinitionFailureAnalyzer,\</div><div class="line">org.springframework.boot.diagnostics.analyzer.PortInUseFailureAnalyzer,\</div><div class="line">org.springframework.boot.diagnostics.analyzer.ValidationExceptionFailureAnalyzer</div></pre></td></tr></table></figure></p>
<p>å‘ç°äº†è¿™ä¸ª<code>PortInUseFailureAnalyzer</code>ç±»å—ï¼Ÿè¿™ä¸ªå°±æ˜¯å¤„ç†ç«¯å£ç»‘å®šå¤±è´¥çš„Analyzerã€‚æˆ‘ä»¬å¦‚æœè¦è‡ªå·±å®šä¹‰ä¸€ä¸ªè¿™æ ·çš„Analyzerå¾ˆç®€å•ã€‚åˆ›å»ºä¸€ä¸ªç±»ï¼Œç»§æ‰¿<code>AbstractFailureAnalyzer</code>ï¼Œå…¶ä¸­çš„æ³›å‹å¯ä»¥æ˜¯ä»»ä½•å¼‚å¸¸ã€‚é‡å†™å…¶<code>analyze</code>æ–¹æ³•ï¼Œæ ¹æ®ä¼ å…¥çš„å‚æ•°è¿›è¡Œå¤„ç†ï¼Œå¦‚æœæ²¡åŠæ³•å¤„ç†é‚£å°±è¿”å›ä¸€ä¸ª<code>null</code>,è¿™æ—¶å€™å°†ç”±ä¸‹ä¸€ä¸ªAnalyzerå»å¤„ç†ã€‚å¦‚æœå¯ä»¥å¤„ç†ï¼Œç›´æ¥è¿”å›ä¸€ä¸ª<code>FailureAnalysis</code>å¯¹è±¡å³å¯ã€‚è¿™ä¸ªå¯¹è±¡å’Œ<code>Execption</code>å¾ˆç±»ä¼¼ï¼Œæ— éå°±æ˜¯ä¸€äº›é”™è¯¯ä¿¡æ¯ç½¢äº†ã€‚è¿™ä¸ªæ˜¯æˆ‘å®šä¹‰çš„ä¸€ä¸ªAnalyzerï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleFailureAnalyzer</span> <span class="keyword">extends</span> <span class="title">AbstractFailureAnalyzer</span>&lt;<span class="title">NullPointerException</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleFailureAnalyzer</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        System.out.println(<span class="string">"æˆ‘æ˜¯è‡ªå®šä¹‰çš„FailureAnalyzerï¼Œæˆ‘å¼€å§‹æäº‹æƒ…äº†ï¼"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> FailureAnalysis <span class="title">analyze</span><span class="params">(Throwable rootFailure, NullPointerException cause)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"æ­£åœ¨æäº‹æƒ…ã€‚ã€‚ã€‚"</span>);</div><div class="line">        System.out.println(<span class="string">"è·å–è¿™ä¸ªå¼‚å¸¸:"</span>);</div><div class="line">        String message = cause.getMessage();</div><div class="line">        System.out.println(message);</div><div class="line">        System.out.println(<span class="string">"äº‹æƒ…æå®Œäº†ï¼Œä½†æ˜¯ä¸æƒ³å¤„ç†"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å®šä¹‰è¿™ä¸ªç±»è¿˜æ²¡ç»“æŸï¼Œè¿˜è¦åˆ›å»ºä¸€ä¸ª<code>META-INF/spring.factories</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">org.springframework.boot.diagnostics.FailureAnalyzer=\</div><div class="line">com.dw.simpledemo.failureanalyzer.SimpleFailureAnalyzer</div></pre></td></tr></table></figure></p>
<p>é™¤äº†è¿™ç§æ–¹å¼è¯Šæ–­é—®é¢˜ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è¿™æ ·å»å‘ç°é—®é¢˜ã€‚å¯ä»¥è®¾ç½®æ—¥å¿—çš„çº§åˆ«ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">logging:</div><div class="line">  level:</div><div class="line">    root: WARN</div><div class="line">    org.springframework: DEBUG</div><div class="line">    org.hibernate: ERROR</div></pre></td></tr></table></figure></p>
<p>å‡å¦‚ä½ ä½¿ç”¨çš„æ˜¯Javaå‘½ä»¤è¡Œçš„æ–¹å¼å»å¯åŠ¨ä½ çš„appå¯ä»¥åœ¨å‘½ä»¤ååŠ è¿™æ ·çš„å‚æ•°<code>java -jar myproject-0.0.1-SNAPSHOT.jar --debug</code>ï¼Œä»¥debugçš„æ–¹å¼å»å¯åŠ¨ã€‚ï¼ˆæˆ‘ç›¸ä¿¡è¿™ç§æ–¹å¼ä¼šè®©ä½ çš„æ§åˆ¶å°çˆ†ç‚¸ï¼Œæ»¡å±éƒ½æ˜¯æ—¥å¿—ï¼Œ2333333ã€‚ï¼‰<br>å¯åŠ¨å¤±è´¥çš„é—®é¢˜åˆ†ææˆ‘è§‰å¾—ä¸ç®—ç‰¹åˆ«æœ‰åˆ›æ–°çš„featureï¼Œæ¯•ç«Ÿä¸€èˆ¬æƒ…å†µä¸‹é€šè¿‡æŠ¥é”™ä¹Ÿèƒ½æ‰¾åˆ°é—®é¢˜å‡ºå“ªé‡Œäº†ã€‚</p>
<p>è¿™ä¸ªfeatureæˆ‘è§‰å¾—ç®—æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„ï¼Œè™½ç„¶æˆ‘è§‰å¾—æ²¡ä»€ä¹ˆå±Œç”¨ï¼Œåªèƒ½ç®—ä¸ªå½©è›‹å§23333.<br>åœ¨æˆ‘ä»¬ç‚¹å‡»<code>run</code>çš„æ—¶å€™æ§åˆ¶å°ä¼šæ‰“å°ä¸€ä¸ªASCIIçš„å­—ç¬¦ç”»ã€‚å¼€å§‹ä»¥ä¸ºè¿™ä¸ªæ˜¯spring bootè‡ªå¸¦çš„ï¼Œå…¶å®è¿™ä¸ªä¹Ÿå¯ä»¥è‡ªå®šä¹‰çš„ã€‚<br>åœ¨ç±»è·¯å¾„ä¸‹åˆ›å»ºä¸€ä¸ªbanner.txtæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">$&#123;AnsiColor.BRIGHT_YELLOW&#125;</div><div class="line">////////////////////////////////////////////////////////////////////</div><div class="line">//                          _ooOoo_                               //</div><div class="line">//                         o8888888o                              //</div><div class="line">//                         88&quot; . &quot;88                              //</div><div class="line">//                         (| ^_^ |)                              //</div><div class="line">//                         O\  =  /O                              //</div><div class="line">//                      ____/`---&apos;\____                           //</div><div class="line">//                    .&apos;  \\|     |//  `.                         //</div><div class="line">//                   /  \\|||  :  |||//  \                        //</div><div class="line">//                  /  _||||| -:- |||||-  \                       //</div><div class="line">//                  |   | \\\  -  /// |   |                       //</div><div class="line">//                  | \_|  &apos;&apos;\---/&apos;&apos;  |   |                       //</div><div class="line">//                  \  .-\__  `-`  ___/-. /                       //</div><div class="line">//                ___`. .&apos;  /--.--\  `. . ___                     //</div><div class="line">//              .&quot;&quot; &apos;&lt;  `.___\_&lt;|&gt;_/___.&apos;  &gt;&apos;&quot;&quot;.                  //</div><div class="line">//            | | :  `- \`.;`\ _ /`;.`/ - ` : | |                 //</div><div class="line">//            \  \ `-.   \_ __\ /__ _/   .-` /  /                 //</div><div class="line">//      ========`-.____`-.___\_____/___.-`____.-&apos;========         //</div><div class="line">//                           `=---=&apos;                              //</div><div class="line">//      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^        //</div><div class="line">//            ä½›ç¥–ä¿ä½‘       æ°¸ä¸å®•æœº     æ°¸æ— BUG                  //</div><div class="line">////////////////////////////////////////////////////////////////////</div></pre></td></tr></table></figure></p>
<p>è¿™æ ·ä½ çš„appåœ¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šæ‰“å°è¿™æ ·çš„å­—ç¬¦ç”»äº†ã€‚ä¸ªäººè§‰å¾—é™¤äº†è£…bæ²¡æœ‰ä»»ä½•åµç”¨ã€‚è‡ªå·±å»å®šä¹‰è¿™äº›å­—ç¬¦ç”»çš„ç”Ÿæˆç¨‹åºä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œ<code>org.springframework.boot.Banner</code>è¿™ä¸ªæ¥å£å°±æ˜¯å®šä¹‰æ€ä¹ˆå»å®ç°bannerçš„æ‰“å°çš„ï¼Œå…·ä½“æ€ä¹ˆå¤„ç†å¯ä»¥çœ‹çœ‹å®ƒçš„å®ç°ç±»ã€‚é—²çš„æ²¡äº‹å¯ä»¥å»æŠ˜è…¾è¿™äº›ç©æ„å„¿ï¼å½“ç„¶ä¸æƒ³çœ‹åˆ°è¿™äº›ä¸œè¥¿ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚åœ¨ymlæ–‡ä»¶ä¸­è¿™æ ·é…ç½®ä¸€ä¸‹å°±å®Œäº‹å„¿äº†ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">spring:</div><div class="line">    main:</div><div class="line">        banner-mode: &quot;off&quot;</div></pre></td></tr></table></figure></p>
<p>åŒæ ·çš„é…ç½®å†™æˆ<code>application.properties</code>ä¹Ÿæ˜¯OKçš„ã€‚<br>ç„¶é¹…ï¼Œç¡¬ç¼–ç ä¹Ÿæ˜¯å¯ä»¥çš„ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    SpringApplication app = <span class="keyword">new</span> SpringApplication(MySpringConfiguration.class);</div><div class="line">    app.setBannerMode(Banner.Mode.OFF);</div><div class="line">    app.run(args);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ¥ä¸‹æ¥çš„è¿™ä¸ªfeatureå°±æ¯”è¾ƒå®ç”¨äº†ã€‚æˆ‘ä»¬ç”¨çš„æ˜¯spring bootå½“ç„¶å°‘ä¸äº†æ ¸å¿ƒçš„springçš„ç‰¹æ€§å‘€ï¼Œæ¯•ç«Ÿéƒ½å§“springå˜›2333ï¼</p>
<p>æˆ‘ä»¬æœ‰æ—¶å€™éœ€è¦åœ¨springå®¹å™¨å¯åŠ¨çš„æ—¶å€™æä¸€äº›äº‹æƒ…ï¼Œspring frameworkä¹Ÿæä¾›äº†è¿™æ ·çš„ä¸€ç§æœºåˆ¶å»å¸®åŠ©æˆ‘ä»¬å®Œæˆã€‚å®ƒå®šä¹‰äº†å¾ˆå¤šäº‹ä»¶æ¥æŠ½è±¡å‡ºè¿™äº›æ“ä½œï¼Œæ¯”å¦‚è¯´<code>ContextRefreshedEvent</code>è¿™ä¸ªäº‹ä»¶å°±æ˜¯å½“å®¹å™¨åˆå§‹åŒ–æˆ–è€…è¢«åˆ·æ–°äº†ä¼šè§¦å‘ã€‚</p>
<p>æˆ‘ä»¬æ³¨å†Œä¸€ä¸ªbeanå¯ä»¥é€šè¿‡<code>@Bean</code>å»å®Œæˆï¼Œbeançš„æ³¨å†Œéœ€è¦ä¾èµ–å®¹å™¨è¢«åˆ›å»ºï¼Œä½†æ˜¯åˆ›å»ºä¹‹å‰çš„ä¸€äº›æ“ä½œæˆ‘ä»¬æ²¡åŠæ³•é€šè¿‡<code>@Bean</code>æ¥å®Œæˆã€‚spring bootä¸­å¯ä»¥è¿™æ ·å»è®¾ç½®<code>SpringApplication.addListeners(â€¦â€‹)</code>æˆ–è€…<code>SpringApplicationBuilder.listeners(â€¦â€‹)</code>å»æ·»åŠ ä½ å…³å¿ƒçš„äº‹ä»¶.å½“ç„¶è¿™ç§æ–¹å¼æ˜¯ä½¿ç”¨ç¡¬ç¼–ç å®Œæˆçš„ï¼Œä¸å¤Ÿæ•äº®ä¸å¤Ÿspringã€‚å¯ä»¥åœ¨<code>META-INF/spring.factories</code>æ–‡ä»¶ä¸­å»æŒ‡å®šã€‚è¿™æ˜¯é»˜è®¤é…ç½®ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># Application Listeners</div><div class="line">org.springframework.context.ApplicationListener=\</div><div class="line">org.springframework.boot.ClearCachesApplicationListener,\</div><div class="line">org.springframework.boot.builder.ParentContextCloserApplicationListener,\</div><div class="line">org.springframework.boot.context.FileEncodingApplicationListener,\</div><div class="line">org.springframework.boot.context.config.AnsiOutputApplicationListener,\</div><div class="line">org.springframework.boot.context.config.ConfigFileApplicationListener,\</div><div class="line">org.springframework.boot.context.config.DelegatingApplicationListener,\</div><div class="line">org.springframework.boot.liquibase.LiquibaseServiceLocatorApplicationListener,\</div><div class="line">org.springframework.boot.logging.ClasspathLoggingApplicationListener,\</div><div class="line">org.springframework.boot.logging.LoggingApplicationListener</div></pre></td></tr></table></figure></p>
<p>åŒæ ·ï¼Œè‡ªå·±å»æŒ‰ç…§è¿™æ ·çš„å†™æ³•å»æ•´ä¸€ä¸ªè‡ªå·±å®šä¹‰çš„listenerä¹Ÿæ˜¯okçš„ï¼Œè¿™å¾ˆspringï¼æ–‡æ¡£ä¸­ç»™äº†ä¸€æ®µè¯ï¼šæˆ‘ä»¬é€šå¸¸å¾ˆå°‘å»ç”¨è¿™ä¸ªapplication eventï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“ä»–ä»¬å­˜åœ¨æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚spring boot é€šè¿‡ä»–ä»¬å®Œæˆå¾ˆå¤šä»»åŠ¡ã€‚å…¶å®åœ¨åšæŠ€æœ¯çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿæ˜¯è¿™ä¸ªé“ç†ï¼Œå¾ˆå¤šæ—¶å€™æœ‰äº›ä¸œè¥¿æˆ‘ä»¬ä¸å¸¸ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»çŸ¥é“æœ‰è¿™ä¹ˆä¸ªä¸œè¥¿ï¼Œè¯´ä¸å®šåœ¨ä»€ä¹ˆæ—¶å€™å°±æ´¾ä¸Šç”¨åœºäº†ã€‚</p>
<p>è¿™ä¸ªfeatureæˆ‘è§‰å¾—æ²¡å¤ªå¤šç”¨å¤„ï¼Œæ¯•ç«Ÿæˆ‘ç›®å‰æ¥è§¦åˆ°spring bootä¸æ˜¯å¾ˆæ·±å…¥ã€‚spring bootå¯åŠ¨å…¥å£æ˜¯é€šè¿‡<code>main</code>å‡½æ•°ï¼Œå…¶ä¸­æœ‰<code>String[] args</code>ä½œä¸ºå‚æ•°ä¼ è¿›æ¥ã€‚spring bootæä¾›<code>ApplicationArguments</code>æ¥å£è®©æˆ‘ä»¬ç›´æ¥è·å–ä¼ å…¥çš„å‚æ•°ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBean</span><span class="params">(ApplicationArguments args)</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> debug = args.containsOption(<span class="string">"debug"</span>);</div><div class="line">        List&lt;String&gt; files = args.getNonOptionArgs();</div><div class="line">        <span class="comment">// if run with "--debug logfile.txt" debug=true, files=["logfile.txt"]</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸ªäººè§‰å¾—ä½¿ç”¨è¿™ç§æ–¹å¼å¾ˆlowï¼Œå°†å‚æ•°ç›´æ¥å†™åˆ°é…ç½®æ–‡ä»¶ä¸­å»ï¼Œè®©appå¯åŠ¨æ—¶å€™å»è¯»é…ç½®ä¸å®Œäº†ï¼Ÿ</p>
<p>å¦‚æœä½ éœ€è¦åœ¨SpringApplicationå¯åŠ¨å‰å»åšç‚¹åˆ«çš„äº‹æƒ…ï¼Œspring bootåŒæ ·èƒ½å¤Ÿå®ç°ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</div><div class="line">        <span class="comment">// Do something...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å®ç°<code>ApplicationRunner</code>æ¥å£åŒæ ·ä¹Ÿèƒ½è¾¾åˆ°æ•ˆæœã€‚è¿™ä¸ªæ¥å£ä¸­çš„<code>run</code>æ–¹æ³•å‚æ•°å°±æ˜¯ä¸Šé¢æåˆ°çš„<code>ApplicationArguments</code>ç”¨æ¥è·å–å¯åŠ¨å‚æ•°çš„ã€‚åŒºåˆ«å°±åœ¨äºä¸€ä¸ªåªèƒ½è·å–<code>String</code>æ•°ç»„ç±»å‹çš„å‚æ•°ï¼Œä¸€ä¸ªèƒ½è·å–<code>ApplicationArguments</code>ç±»å‹çš„å‚æ•°ã€‚</p>
<p>è‡³æ­¤ï¼Œå…³äºCore Features: SpringApplication çš„å†…å®¹éƒ½æ¢³ç†å®Œäº†ã€‚ä¸‹ä¸€ä¸ªfeatureè¦è®²çš„æ˜¯Core Features: External Configurationã€‚</p>
<h3 id="Externalized-Configuration"><a href="#Externalized-Configuration" class="headerlink" title="Externalized Configuration"></a>Externalized Configuration</h3><p>è¯´å®è¯ï¼Œè¿™ä¸ªè¯ä¸­æ–‡ç¿»è¯‘çœŸçš„å¾ˆéš¾è¡¨è¾¾å®ƒæƒ³ä¼ è¾¾å‡ºçš„æ„æ€ã€‚ä½œä¸ºåè¯çš„ç›´è¯‘å°±æ˜¯å¤–éƒ¨é…ç½®ï¼Œä½œä¸ºåŠ¨è¯ç¿»è¯‘è¿‡æ¥å°±æ˜¯å¤–éƒ¨åŒ–é…ç½®ã€‚çœŸçš„è®©äººæ‘¸ä¸åˆ°å¤´è„‘ã€‚</p>
<p>ä»”ç»†å»è¯»è¯»å†…å®¹ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ä¸€ä¸ªå…³é”®è¯ï¼šé…ç½®ã€‚é€šè¿‡é…ç½®ï¼Œå¯ä»¥è®©ä½ çš„åº”ç”¨åœ¨ä¸åŒç¯å¢ƒä¸­è·‘åŒä¸€å¥—ä»£ç ã€‚å¯ä»¥ä½¿ç”¨propertiesæ–‡ä»¶ã€YAMLæ–‡ä»¶ã€environmentå˜é‡ã€åŠå‘½ä»¤è¡Œå‚æ•°å»ä½¿ä½ çš„å‚æ•°ç”Ÿæ•ˆã€‚é…ç½®å‚æ•°å¯ä»¥é€šè¿‡ä½¿ç”¨<code>@Value</code>æ³¨è§£ç›´æ¥æ³¨å…¥åˆ°ä½ çš„beanä¸­ã€‚spring bootä¸­çš„é…ç½®å±æ€§æ˜¯éµå¾ªä¸€ä¸ªä¼˜å…ˆçº§çš„ï¼š</p>
<ol>
<li>å…¨å±€é…ç½®ï¼ˆå½“devtoolsç”Ÿæ•ˆçš„æ—¶å€™ ~/.spring-boot-devtools.propertiesæ–‡ä»¶ä½œä¸ºå…¨å±€é…ç½®æ–‡ä»¶ï¼‰ã€‚</li>
<li><code>@TestPropertySource</code>æ³¨è§£é…ç½®åœ¨ä½ çš„æµ‹è¯•ç”¨ä¾‹ä¸­ã€‚</li>
<li><code>@SpringBootTest#properties</code>æ³¨è§£å±æ€§å€¼è¢«è®¾ç½®åœ¨ä½ çš„æµ‹è¯•ç”¨ä¾‹ä¸­ã€‚</li>
<li>å‘½ä»¤è¡Œå‚æ•°ã€‚</li>
<li>environment variable(å¯åŠ¨æ—¶å€™å¯ä»¥è®¾ç½®çš„å‚æ•°ï¼Œç±»ä¼¼äºprogram arguments)æˆ–è€…ç³»ç»Ÿå‚æ•°ã€‚</li>
<li><code>ServletConfig</code>åˆå§‹åŒ–å‚æ•°ã€‚</li>
<li><code>ServletContext</code>åˆå§‹åŒ–å‚æ•°ã€‚</li>
<li><code>java:comp/env</code>JNDIå‚æ•°ã€‚</li>
<li>Java System properties(System.getProperties()).</li>
<li>OS environment variables.</li>
<li>A <code>RandomValuePropertySource</code> that only has properties in random.*.(å•¥å•¥å•¥ï¼Œè¯´å•¥å‘¢)</li>
<li>jaråŒ…å¤–çš„<code>application-{profile}.properties</code>é…ç½®æ–‡ä»¶æˆ–è€…YAMLæ–‡ä»¶ã€‚</li>
<li>jaråŒ…å†…çš„â€¦(åŒä¸Š)ã€‚</li>
<li>jaråŒ…å¤–çš„<code>application.properties</code>æ–‡ä»¶æˆ–è€…YAMLæ–‡ä»¶ã€‚</li>
<li>jaråŒ…å†…çš„â€¦(åŒä¸Š)ã€‚</li>
<li>åœ¨<code>@Configuration</code>æ³¨è§£è¿‡çš„ç±»ä¸Šçš„<code>@PropertySource</code>å±æ€§ï¼ˆè²Œä¼¼è¯»ä¸é€šï¼‰ã€‚</li>
<li>é»˜è®¤å±æ€§ã€‚<br>ä¸€ä¸ªæ —å­ï¼š<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;name&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p><code>application.properties</code>ä¸­æœ‰nameè¿™ä¸ªå±æ€§å°±ä¼šè¢«è‡ªåŠ¨èµ‹å€¼ç»™nameå­—æ®µã€‚<code>java -jar app.jar --name=&quot;Spring&quot;</code>è¿™ç§æ–¹å¼nameå°±æ˜¯ä»å‘½ä»¤è¡Œä¸­å»è¯»å–ã€‚</p>
<p>æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶é™¤äº†<code>application.properties</code>è¿˜æœ‰è¿™ç§å½¢å¼çš„ï¼š<code>application-{profile}.properties</code>è¿™ä¸ªprofileå†³å®šä½ ä»£ç è¿è¡Œçš„ç¯å¢ƒã€‚å¯ä»¥æ˜¯devã€prodç­‰ç­‰ã€‚å…·ä½“å»åŠ è½½å“ªä¸ªé…ç½®æ–‡ä»¶å–å†³äº<code>spring.profiles.active</code>è¿™ä¸ªå±æ€§åˆ°åº•æ˜¯ä»€ä¹ˆã€‚ä¸ä¹‹å¯¹åº”å³å¯ã€‚å¦‚æœæœ‰å¤šä¸ª<code>application-{profile}.properties</code>æ–‡ä»¶å‡ºç°ï¼Œæœ€åå‡ºç°çš„ç”Ÿæ•ˆã€‚</p>
<p>springæ¨èä½¿ç”¨YMALä½œä¸ºé…ç½®æ–‡ä»¶ã€‚å®ƒæ˜¯JSONçš„è¶…é›†ã€‚spring frameworkæä¾›äº†2ä¸ªæ–¹ä¾¿çš„ç±»åŠ è½½YMALæ–‡ä»¶ï¼š<code>YamlPropertiesFactoryBean</code>å’Œ<code>YamlMapFactoryBean</code>ã€‚å‰è€…åŠ è½½æˆä¸€ä¸ª<code>Properties</code>ï¼Œåè€…åŠ è½½æˆä¸€ä¸ª<code>Map</code>ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">my:</div><div class="line">   servers:</div><div class="line">       - dev.bar.com</div><div class="line">       - foo.bar.com</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ConfigurationProperties</span>(prefix=<span class="string">"my"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; servers = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getServers</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.servers;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœ‹ä¸Šå»æœ‰ç§å¾ˆé…¸çˆ½çš„æ„Ÿè§‰ã€‚</p>
<p>åœ¨ä¸€ä¸ªYMALæ–‡ä»¶ä¸­ä¹Ÿå¯ä»¥æŒ‡å®šä¸åŒçš„profileçš„ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">server:</div><div class="line">    address: 192.168.1.100</div><div class="line">---</div><div class="line">spring:</div><div class="line">    profiles: development</div><div class="line">server:</div><div class="line">    address: 127.0.0.1</div><div class="line">---</div><div class="line">spring:</div><div class="line">    profiles: production</div><div class="line">server:</div><div class="line">    address: 192.168.1.120</div></pre></td></tr></table></figure></p>
<p><code>server.address</code>å±æ€§åœ¨ä¸åŒçš„profileä¸­æ˜¯ä¸åŒçš„ã€‚<code>development</code>è¢«æ¿€æ´»äº†ï¼Œå°±ä½¿ç”¨<code>127.0.0.1</code>.å…¶ä»–ç±»ä¼¼ã€‚éƒ½æ²¡æ¿€æ´»å°±ä½¿ç”¨é»˜è®¤çš„<code>192.168.1.100</code>.<br>ç„¶è€Œè¿™ç§æ–¹å¼æœ‰ç¼ºç‚¹ï¼Œä¸èƒ½é€šè¿‡<code>@PropertySource</code>æ³¨è§£ç›´æ¥æ³¨å…¥åˆ°beanå±æ€§ä¸­ã€‚</p>
<p>springé’ˆå¯¹<code>@Value(&quot;${property}&quot;)</code>è¿™ç§æ–¹å¼å»æ³¨å…¥å±æ€§æä¾›ä¸€ä¸ªæ›¿æ¢ã€‚é‚£å°±æ˜¯ä½¿ç”¨<code>@ConfigurationProperties(&quot;foo&quot;)</code>æ¥æ”¾åˆ°ä½ è¦æ³¨å…¥çš„ç±»ä¸­ã€‚å­—æ®µåå¯¹åº”å³å¯ï¼Œå³ä½¿æœ‰é‚£ç§ç»§æ‰¿ç»“æ„ä¹Ÿæ²¡å…³ç³»ã€‚YMALæœ¬èº«å¯¹è¿™ç§ç»§æ‰¿ç»“æ„æ”¯æŒçš„å¾ˆå¥½ã€‚</p>
<p>å…³äºExternalized Configurationçš„æ¢³ç†ä¹Ÿå·®ä¸å¤šäº†ã€‚å„ç§ç‚«é…·å±Œç‚¸å¤©ã€‚</p>
<p>å‰©ä¸‹çš„åœ¨ä»¥åå‡ ç¯‡æ–‡ç« ä¸­ç»§ç»­æ•´ç†ã€‚è¶Šæ¥è¶Šæœ‰è¶£äº†ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨spring bootå®˜æ–¹æ–‡æ¡£ä¸­ä»‹ç»äº†ä¸å°‘featureï¼Œæˆ‘è§‰å¾—æœ‰å¿…è¦æ•´ç†ä¸€ä¸‹ï¼Œè¿˜æ˜¯æŒºæœ‰æ„æ€çš„ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Spring Framework" scheme="http://www.wei-dong.top/categories/Spring-Framework/"/>
    
    
      <category term="Spring Boot" scheme="http://www.wei-dong.top/tags/Spring-Boot/"/>
    
      <category term="ç¿»è¯‘&amp;æ•´ç†" scheme="http://www.wei-dong.top/tags/%E7%BF%BB%E8%AF%91-%E6%95%B4%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>åŠ¨æ€ä»£ç†ç•ªå¤–ç¯‡</title>
    <link href="http://www.wei-dong.top/2017/07/16/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%95%AA%E5%A4%96%E7%AF%87/"/>
    <id>http://www.wei-dong.top/2017/07/16/åŠ¨æ€ä»£ç†ç•ªå¤–ç¯‡/</id>
    <published>2017-07-16T06:55:23.000Z</published>
    <updated>2017-07-16T06:59:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è¯´åˆ°åŠ¨æ€ä»£ç†çš„å®ç°é™¤äº†JDKè¿˜æœ‰ç¬¬ä¸‰æ–¹çš„å®ç°ã€‚ç°åœ¨å°±æ¥ç§ç§JDKä¹‹å¤–çš„åŠ¨æ€ä»£ç†çš„å®ç°ã€‚<a id="more"></a> </p>
<h2 id="Cglib"><a href="#Cglib" class="headerlink" title="Cglib"></a>Cglib</h2><p>è¿™ä¸ªåº“åœ¨Githubä¸Šæœ‰1390é¢—æ˜Ÿæ˜Ÿï¼Œä¸‹é¢æ˜¯å¯¹Cglibçš„æè¿°ã€‚</p>
<blockquote>
<p>cglib is a powerful, high performance and quality Code Generation Library, It is used to extend JAVA classes and implements interfaces at runtime. </p>
</blockquote>
<p>è¯´åˆ°ä½¿ç”¨è¿™ä¸ªåº“çš„æ¡†æ¶ï¼Œå…¶ä¸­å¤§åé¼é¼çš„Hibernateå°±ç”¨åˆ°äº†ï¼Œå½“ç„¶è¿˜æœ‰Springã€‚ Springçš„AOPé»˜è®¤ä½¿ç”¨JDKProxyï¼Œå¦‚æœè¢«ä»£ç†çš„ç±»æ²¡æœ‰å®ç°æ¥å£å°±ä½¿ç”¨Cglibå»ç”ŸæˆåŠ¨æ€ä»£ç†ç±»ã€‚</p>
<p>å®ƒçš„å‡ºç°æ˜¯ä¸ºäº†å¼¥è¡¥JDKåŠ¨æ€ä»£ç†ä¸­ä¸èƒ½å¯¹æœªå®ç°æ¥å£çš„ç±»è¿›è¡Œä»£ç†ã€‚å…¶åŸç†ä¹Ÿå¯æƒ³è€ŒçŸ¥äº†ï¼Œæ— éå°±æ˜¯åŠ¨æ€ç”Ÿæˆä¸€ä¸ªå­ç±»ï¼Œè¿™ä¸ªå­ç±»ç»§æ‰¿äº†è¦ä»£ç†çš„ç±»ï¼Œç„¶åå»é‡å†™çˆ¶ç±»ï¼ˆéœ€è¦ä»£ç†çš„ç±»ï¼‰çš„æ–¹æ³•ã€‚è¿™æ ·çš„è¯ï¼Œä»£ç†ç±»å°±ä¸€å®šä¸èƒ½æ˜¯finalç±»å‹äº†ï¼Œéœ€è¦ä»£ç†çš„æ–¹æ³•ä¹Ÿä¸èƒ½æ˜¯finalã€‚å› ä¸ºJavaä¸å…è®¸ç»§æ‰¿finalç±»ï¼Œä¸å…è®¸é‡å†™finalæ–¹æ³•ã€‚<br>ä¸‹é¢é€šè¿‡ä¸€ä¸ªå®ä¾‹æ¥ä»‹ç»Cglibå®ç°åŠ¨æ€ä»£ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * éœ€è¦è¢«ä»£ç†çš„ç›®æ ‡ç±»</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TargetClass</span>  </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(String name)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"hello ,"</span>+ name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"TargetClass&#123;&#125;"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * ç›®æ ‡å¯¹è±¡æ‹¦æˆªå™¨ï¼Œå®ç°MethodInterceptor</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TargetIncerceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * é‡å†™æ–¹æ³•æ‹¦æˆªåœ¨æ–¹æ³•å‰å’Œæ–¹æ³•ååŠ å…¥ä¸šåŠ¡</div><div class="line">     * <span class="doctag">@param</span> o ä¸ºç›®æ ‡å¯¹è±¡</div><div class="line">     * <span class="doctag">@param</span> method ä¸ºç›®æ ‡æ–¹æ³•</div><div class="line">     * <span class="doctag">@param</span> objects ä¸ºå‚æ•°</div><div class="line">     * <span class="doctag">@param</span> methodProxy CGlibæ–¹æ³•ä»£ç†å¯¹è±¡ </div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@throws</span> Throwable</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"è°ƒç”¨å‰"</span>);</div><div class="line">        Object result = methodProxy.invokeSuper(o, objects);</div><div class="line">        System.out.println(<span class="string">" è°ƒç”¨å"</span>+result);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibCase</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</div><div class="line">        enhancer.setSuperclass(TargetClass.class);</div><div class="line">        enhancer.setCallback(<span class="keyword">new</span> TargetIncerceptor());</div><div class="line">        TargetClass targetClass = (TargetClass) enhancer.create();</div><div class="line"></div><div class="line">        String hello = targetClass.hello(<span class="string">"dw"</span>);</div><div class="line">        System.out.println(hello);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»è¡¨é¢ä¸Šæ¥çœ‹å’ŒJDKçš„ä½¿ç”¨è¿˜æ˜¯æœ‰ç±»ä¼¼çš„åœ°æ–¹çš„ã€‚Cglibä½¿ç”¨<code>Enhancer</code>æ¥å»è£…è½½çˆ¶ç±»ï¼Œå°†æ–¹æ³•æ‹¦æˆªå™¨æ¤å…¥åˆ°ç”Ÿæˆçš„å­ç±»å­—èŠ‚ç ä¸­ï¼Œæœ€ååˆ›å»ºå¯¹è±¡ã€‚Cgilbä¾èµ–ASMå­—èŠ‚ç æ¡†æ¶å»åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç ï¼Œå…·ä½“ç”Ÿæˆå‡ºæ¥çš„å­—èŠ‚ç æ–‡ä»¶å’ŒJDKåŠ¨æ€ä»£ç†ç”Ÿæˆå‡ºæ¥çš„å·®åˆ«å¾ˆå¤§ï¼ŒåŒºåˆ«å°±åœ¨äºCglibç”Ÿæˆçš„ä»£ç†ç±»æ²¡æœ‰ä½¿ç”¨åå°„å»è°ƒç”¨è¦è¢«ä»£ç†çš„æ–¹æ³•ã€‚ä»è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºCglibåœ¨æ‰§è¡Œæ•ˆç‡ä¸Šè¦æ¯”JDKåŠ¨æ€ä»£ç†è¦é«˜ï¼Œæ¯•ç«Ÿåå°„æ•ˆç‡æ˜¯å¾ˆä½çš„ã€‚</p>
<h2 id="Byte-Buddy"><a href="#Byte-Buddy" class="headerlink" title="Byte Buddy"></a>Byte Buddy</h2><p>è¿™ä¸ªç±»åº“æ˜¯æœ€è¿‘çœ‹ä¸€ä¸ªRPCæ¡†æ¶ä»£ç çš„æ—¶å€™å‘ç°çš„ã€‚èµ·å› æ˜¯è‡ªå·±æƒ³å°è¯•ç€å†™ä¸€ä¸ªç®€å•çš„è¿œç¨‹æ–¹æ³•è°ƒç”¨çš„æ ·ä¾‹ç¨‹åºï¼Œåœ¨Githubä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªç®€å•çš„åŸºäºNettyçš„å®ç°ï¼Œå…¶ä¸­åœ¨å¤„ç†åŠ¨æ€ä»£ç†çš„æ—¶å€™é™¤äº†ä½¿ç”¨JDKçš„å®ç°è¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„å®ç°ï¼Œé‚£å°±æ˜¯Byte Buddyã€‚ç„¶åç¨å¾®ç ”ç©¶äº†ä¸€ç•ªï¼Œå‘ç°ä½¿ç”¨è¿™ä¸ªç±»åº“å†™åŠ¨æ€ä»£ç†ç¡®å®å¾ˆæ–¹ä¾¿ã€‚</p>
<p>åºŸè¯ä¸å¤šè®²ï¼Œå…ˆç®€å•çš„çœ‹ä»£ç å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å®šä¹‰æ¥å£</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Hello</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">sayHi</span><span class="params">(String name)</span></span>;</div><div class="line">    <span class="function">String <span class="title">sayHi</span><span class="params">(String name,<span class="keyword">int</span> time)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHi</span><span class="params">(<span class="keyword">int</span> i)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å®ç°ç±»</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloImpl</span> <span class="keyword">implements</span> <span class="title">Hello</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHi</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Hello "</span>+name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHi</span><span class="params">(String name, <span class="keyword">int</span> time)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> time+<span class="string">" Hello "</span>+name ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHi</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"nothing"</span>+i);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteBuddyProxy</span> </span>&#123;</div><div class="line">	<span class="comment">//åˆ›å»ºä»£ç†å¯¹è±¡</span></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getInstance</span><span class="params">(Class&lt;T&gt; clazz,Object handler)</span></span>&#123;</div><div class="line"></div><div class="line">        Class&lt;? extends T&gt; cls = <span class="keyword">new</span> ByteBuddy()</div><div class="line">                .subclass(clazz)</div><div class="line">                .method(ElementMatchers.isDeclaredBy(clazz))</div><div class="line">                .intercept(MethodDelegation.to(handler))</div><div class="line">                .make()</div><div class="line">                .load(clazz.getClassLoader(), ClassLoadingStrategy.Default.INJECTION)</div><div class="line">                .getLoaded();</div><div class="line"></div><div class="line">        T t = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">           t = cls.newInstance();</div><div class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> t;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        ByteBuddyProxy proxy = <span class="keyword">new</span> ByteBuddyProxy();</div><div class="line">        Hello hello = proxy.getInstance(Hello.class, <span class="keyword">new</span> Invoker(HelloImpl.class));</div><div class="line">        hello.sayHi(<span class="number">1</span>);</div><div class="line">        String sayHi = hello.sayHi(<span class="string">"dongwei"</span>,<span class="number">9</span>);</div><div class="line">        System.out.println(sayHi);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æš‚æ—¶ç†è§£ä¸ºå’ŒJDK Proxyä¸­çš„InvocationHandlerä¸€æ ·çš„ä¸œè¥¿å§</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Invoker</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Class&lt;?&gt; clazz;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Invoker</span><span class="params">(Class&lt;?&gt; clazz)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.clazz = clazz;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@RuntimeType</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(@Origin Method method, @AllArguments @RuntimeType Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        Object result = method.invoke(clazz.newInstance(),args);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™åªæ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„å°æ —å­ï¼Œè¿˜æœ‰å¾ˆå¤šå¤æ‚çš„ç‰¹æ€§æ²¡æœ‰æ·±å…¥ç ”ç©¶ã€‚æˆ‘åªèƒ½å¯¹å†™è¿™ä¸ªåº“çš„ä½œè€…è¡¨ç¤ºå¾ˆå´‡é«˜çš„æ•¬ä½©ï¼</p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>å½“ç„¶é™¤äº†æ–‡ç« ä¸­æ‰€ä»‹ç»çš„ç”ŸæˆåŠ¨æ€ä»£ç†çš„å·¥å…·è¿˜æœ‰å¾ˆå¤šæ²¡æœ‰æåŠï¼Œæ¯”æ–¹è¯´javaassitç­‰ã€‚å…¶åŸç†å¤§è‡´ç±»ä¼¼ï¼Œæ— éå°±æ˜¯åœ¨JVMåŠ è½½å­—èŠ‚ç çš„æ—¶å€™å°†å­—èŠ‚ç ç»™æ›¿æ¢äº†æˆ–è€…æ”¹æ‰äº†ï¼Œå¾ˆå¤šéƒ½ä¾èµ–äºASMåº“ï¼Œå¦‚æœå¯¹classå­—èŠ‚ç è§„èŒƒå¾ˆç†Ÿæ‚‰çš„è¯è‡ªå·±ä¹Ÿå¯ä»¥ä½¿ç”¨ASMæ¥å†™ä¸€ä¸ªå­—èŠ‚ç ç”Ÿæˆå·¥å…·ã€‚<br>ä»é˜…è¯»åˆ«äººå†™çš„RPCæ¡†æ¶çš„æºç ä¸­å‘ç°äº†å¾ˆå¤šæœ‰æ„æ€çš„ä¸œè¥¿ï¼Œä»å…¶ä¸­çš„åŠ¨æ€ä»£ç†å¯ä»¥äº†è§£åˆ°å­—èŠ‚ç ç”ŸæˆåŠ è½½ã€‚æ…¢æ…¢æ‰å‘ç°å†™ä»£ç çœŸçš„ä¸æ˜¯æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•çš„ï¼Œå˜åŒ–çš„ä¸œè¥¿å¤ªå¤šäº†ï¼Œä¹Ÿåªæœ‰æ—¶åˆ»ä¿æŒç€å­¦ä¹ çš„æ€åº¦ä¹Ÿæ‰å¯èƒ½è·Ÿå¾—ä¸ŠèŠ‚å¥ï¼Œæ‰ä¸ä¼šè¢«æ·˜æ±°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è¯´åˆ°åŠ¨æ€ä»£ç†çš„å®ç°é™¤äº†JDKè¿˜æœ‰ç¬¬ä¸‰æ–¹çš„å®ç°ã€‚ç°åœ¨å°±æ¥ç§ç§JDKä¹‹å¤–çš„åŠ¨æ€ä»£ç†çš„å®ç°ã€‚
    
    </summary>
    
      <category term="OPEN SOURCE" scheme="http://www.wei-dong.top/categories/OPEN-SOURCE/"/>
    
    
      <category term="å­—èŠ‚ç å·¥å…·" scheme="http://www.wei-dong.top/tags/%E5%AD%97%E8%8A%82%E7%A0%81%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>åŠ¨æ€ä»£ç†ä¹‹JDKå®ç°</title>
    <link href="http://www.wei-dong.top/2017/07/09/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B9%8BJDK%E5%AE%9E%E7%8E%B0/"/>
    <id>http://www.wei-dong.top/2017/07/09/åŠ¨æ€ä»£ç†ä¹‹JDKå®ç°/</id>
    <published>2017-07-09T02:29:23.000Z</published>
    <updated>2017-07-09T02:32:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å‘¢ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªå¼€æºçš„PRC FRAMEWORKï¼Œå½“ç„¶ä¸æ˜¯Dubboã€‚ç„¶åæƒ³å»äº†è§£ä¸€ä¸‹RPCåˆ°åº•æ˜¯æ€ä¹ˆå»å®ç°çš„ã€‚äºæ˜¯ä¹å°±äº†è§£äº†ä¸€ç•ªï¼Œå‘ç°å…¶çµé­‚åœ¨äºåŠ¨æ€ä»£ç†å’Œåå°„ã€‚<a id="more"></a> </p>
<h5 id="Whatâ€™s-Dynamic-Proxy"><a href="#Whatâ€™s-Dynamic-Proxy" class="headerlink" title="Whatâ€™s Dynamic Proxy ?"></a>Whatâ€™s Dynamic Proxy ?</h5><p>åœ¨è®²ä»€ä¹ˆæ˜¯åŠ¨æ€ä»£ç†å‰å…ˆå¾—æ˜ç™½ä»€ä¹ˆæ˜¯ä»£ç†ã€‚åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­çš„ä»£ç†å…¶å®å°±æ˜¯å§”æ‰˜çš„æ„æ€ã€‚å°†äº‹æƒ…äº¤ä»£ç»™å§”æ‰˜å¯¹è±¡å»åšï¼Œè¿™å°±æ˜¯ä»£ç†ã€‚ç¨‹åºä¸­çš„ä»£ç†æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿè¿™é‡Œæ›´å‡†ç¡®çš„è§£é‡Šåº”è¯¥æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼â€“ä»£ç†æ¨¡å¼ï¼ˆProxy)<br><img src="http://img.my.csdn.net/uploads/201211/29/1354197582_1664.PNG" alt="Proxy"><br>ä¸‹é¢ç»™å‡ºä¸€ä¸ªç®€å•çš„å…³äºä»£ç†çš„Javaå®ç°ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Sourceable</span> </span>&#123;  </div><div class="line">	<span class="comment">//ä¸»é¢˜æ¥å£</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span></span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Source</span> <span class="keyword">implements</span> <span class="title">Sourceable</span> </span>&#123;  </div><div class="line">	<span class="comment">//æ¥å£å®ç°</span></div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;  </div><div class="line">        System.out.println(<span class="string">"the original method!"</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä»£ç†ç±»</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Sourceable</span> </span>&#123;  </div><div class="line">	</div><div class="line">    <span class="keyword">private</span> Source source;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Proxy</span><span class="params">()</span></span>&#123;  </div><div class="line">        <span class="keyword">super</span>();  </div><div class="line">        <span class="keyword">this</span>.source = <span class="keyword">new</span> Source();  </div><div class="line">    &#125;  </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;  </div><div class="line">        before();  </div><div class="line">        source.method();  </div><div class="line">        atfer();  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">atfer</span><span class="params">()</span> </span>&#123;  </div><div class="line">        System.out.println(<span class="string">"after proxy!"</span>);  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;  </div><div class="line">        System.out.println(<span class="string">"before proxy!"</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è°ƒç”¨å®¢æˆ·ç«¯</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyTest</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </div><div class="line">        Sourceable source = <span class="keyword">new</span> Proxy();  </div><div class="line">        source.method();  </div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­ä»£ç†ç±»ä¸­å¯¹ä¸»é¢˜æ¥å£è¿›è¡Œäº†å¢å¼ºâ€”åœ¨ä¸»é¢˜æ–¹æ³•è°ƒç”¨å‰åè°ƒç”¨äº†<code>before</code>å’Œ<code>after</code> ã€‚Spring AOPä¸­çš„æ€æƒ³æ­£æ˜¯å¦‚æ­¤ã€‚<br>è¿™å°±æ˜¯Javaä¸­çš„ä»£ç†æ¨¡å¼ï¼Œåªä¸è¿‡ä¸Šé¢çš„ä»£ç å®ç°æ˜¯åŸºäºç¡¬ç¼–ç çš„ï¼Œä¹Ÿå°±æ˜¯æ‰€è¯´çš„<strong>é™æ€ä»£ç†</strong>ã€‚é‚£ä¹ˆåŒºåˆ«äºé™æ€ä»£ç†ï¼Œé‚£å°±ä¸€å®šæœ‰<strong>åŠ¨æ€ä»£ç†äº†</strong>ã€‚<br>é€šè¿‡ä»¥ä¸Šçš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œé™æ€ä»£ç†å°†ä»£ç å†™æ­»ï¼Œæ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå®Œæˆçš„å…·ä½“ä»£ç†ç±»çš„ç»‘å®šã€‚ä½†æ˜¯åŠ¨æ€ä»£ç†ä¸æ˜¯è¿™ä¹ˆåšçš„ï¼Œè€Œæ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶å®Œæˆçš„è¿™æ“ä½œã€‚ä¸‹é¢ä½¿ç”¨åŠ¨æ€ä»£ç†æ–¹å¼å®ç°ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä½¿ç”¨jdkåŠ¨æ€ä»£ç†å®ç°éœ€è¦å®ç°æ¥å£InvocationHandler</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Object targrt;<span class="comment">//ä»£ç†çš„çœŸå®å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æ¥å£çš„å®ç°ç±»</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JdkProxy</span><span class="params">(Object targrt)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.targrt = targrt;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     *</div><div class="line">     * è¯¥æ–¹æ³•è´Ÿè´£é›†ä¸­å¤„ç†åŠ¨æ€ä»£ç†ç±»ä¸Šçš„æ‰€æœ‰æ–¹æ³•è°ƒç”¨ã€‚</div><div class="line">     * è°ƒç”¨å¤„ç†å™¨æ ¹æ®è¿™ä¸‰ä¸ªå‚æ•°è¿›è¡Œé¢„å¤„ç†æˆ–åˆ†æ´¾åˆ°å§”æ‰˜ç±»å®ä¾‹ä¸Šåå°„æ‰§è¡Œ</div><div class="line">     * <span class="doctag">@param</span> proxy ä»£ç†ç±»å®ä¾‹</div><div class="line">     * <span class="doctag">@param</span> method è¢«è°ƒç”¨çš„æ–¹æ³•å¯¹è±¡</div><div class="line">     * <span class="doctag">@param</span> args è°ƒç”¨å‚æ•°</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@throws</span> Throwable</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">//è¿™é‡Œæ¥å¤„ç†ä»£ç†çš„å…·ä½“å·¥ä½œ</span></div><div class="line">        <span class="comment">//å‡è®¾åœ¨æ‰§è¡Œå‰è¿›è¡Œä¸€ä¸ªæ‰“å°æ—¥å¿—çš„å¤„ç†</span></div><div class="line">        before();</div><div class="line">        Object result = method.invoke(targrt, args);</div><div class="line">        <span class="comment">//å‡è®¾æ‰§è¡Œç»“æŸåæ‰“å°ä¸€ä¸ªæ‰§è¡Œå®Œæˆçš„é€šçŸ¥</span></div><div class="line">        atfer();</div><div class="line">        <span class="comment">//å°†æ‰§è¡Œç»“æœè¿”å›å¦‚æœæœ‰çš„è¯</span></div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">atfer</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"after proxy!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"before proxy!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">(Class[] interfaceClass)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),</div><div class="line">                                        interfaceClass,<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å®¢æˆ·ç«¯</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkProxyCase</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Sourceable s = <span class="keyword">new</span> Source();</div><div class="line"></div><div class="line">        JdkProxy proxy = <span class="keyword">new</span> JdkProxy(s);</div><div class="line"></div><div class="line">        Sourceable hello = (Sourceable) proxy.getProxy(<span class="keyword">new</span> Class[]&#123;Sourceable.class&#125;);</div><div class="line">        </div><div class="line">        hello.method();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”±æ­¤å¯è§ï¼Œæˆ‘ä»¬å¯¹ä¸»é¢˜å¯¹è±¡æ‰€æœ‰çš„æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šå˜æˆå¯¹<code>invoke</code>æ–¹æ³•çš„è°ƒç”¨ï¼Œè€Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ·»åŠ ç»Ÿä¸€çš„é€»è¾‘å¤„ç†ã€‚<br>æ‰€ä»¥å¯ä»¥çœ‹å‡ºï¼ŒåŠ¨æ€ä»£ç†çš„å‡ ä¸ªå¥½å¤„ï¼š</p>
<ul>
<li>æ˜“äºç»´æŠ¤ã€‚ç›¸å¯¹äºé™æ€ä»£ç†æ¥è¯´ï¼Œåªè¦åœ¨Proxyç±»ä¸­å›ºå®šå¥½å¤„ç†é€»è¾‘è€Œä¸ç”¨é’ˆå¯¹æ¯ä¸ªæ–¹æ³•å»ç¼–å†™ä»£ç äº†ã€‚æ§åˆ¶äº†ä»£ç é‡ï¼Œä¾¿äºç»´æŠ¤ã€‚</li>
<li>ä½¿AOPç¼–ç¨‹æ›´åŠ å®¹æ˜“ã€‚åœ¨Springçš„å¸®åŠ©ä¸‹è½»æ¾æ·»åŠ ã€ç§»é™¤åŠ¨æ€ä»£ç†ï¼Œä¸”å¯¹æºä»£ç æ²¡æœ‰ä»»ä½•å½±å“ã€‚</li>
<li>è§£è€¦ã€‚å¯ä»¥é€šè¿‡å‚æ•°å°±èƒ½åˆ¤æ–­å…·ä½“å®ç°ç±»ï¼Œä¸éœ€è¦äº‹å…ˆå®ä¾‹åŒ–ï¼Œæ›´åŠ çµæ´»å¤šå˜ã€‚<h5 id="The-Mechanism-of-Dynamic-Proxy"><a href="#The-Mechanism-of-Dynamic-Proxy" class="headerlink" title="The Mechanism of Dynamic Proxy"></a>The Mechanism of Dynamic Proxy</h5>è°ˆå®Œäº†ä»€ä¹ˆæ˜¯åŠ¨æ€ä»£ç†ï¼Œç°åœ¨å°±å¯ä»¥æ¥äº†è§£ä¸€ä¸‹åŠ¨æ€ä»£ç†æ˜¯æ€ä¹ˆå®ç°çš„äº†ã€‚è¦å»çŸ¥é“JdkåŠ¨æ€ä»£ç†æ˜¯æ€ä¹ˆå®ç°çš„è¿˜å¾—å»æºç ä¸­æ‰¾ã€‚<br>çœ‹çœ‹<code>Proxy#newProxyInstance</code>çš„å®ç°ã€‚<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader,Class&lt;?&gt;[] interfaces,InvocationHandler h)</span></span></div><div class="line">        <span class="keyword">throws</span> IllegalArgumentException</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (h == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> SecurityManager sm = System.getSecurityManager();</div><div class="line">        <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</div><div class="line">            checkProxyAccess(Reflection.getCallerClass(), loader, interfaces);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * æ‰¾ç¼“å­˜é‡Œæœ‰æ²¡æœ‰Proxyå¯¹è±¡ï¼Œæ²¡æœ‰å°±ç”Ÿæˆä¸€ä¸ª.</div><div class="line">         */</div><div class="line">        Class&lt;?&gt; cl = getProxyClass0(loader, interfaces);</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Invoke its constructor with the designated invocation handler.</div><div class="line">         * ç”¨æŒ‡å®šçš„handleræ¥è°ƒç”¨æ„é€ æ–¹æ³•</div><div class="line">         */</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);</div><div class="line">            <span class="keyword">final</span> InvocationHandler ih = h;</div><div class="line">            <span class="keyword">if</span> (sm != <span class="keyword">null</span> &amp;&amp; ProxyAccessHelper.needsNewInstanceCheck(cl)) &#123;</div><div class="line">                <span class="comment">// create proxy instance with doPrivilege as the proxy class may</span></div><div class="line">                <span class="comment">// implement non-public interfaces that requires a special permission</span></div><div class="line">                <span class="keyword">return</span> AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Object&gt;() &#123;</div><div class="line">                    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> newInstance(cons, ih);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> newInstance(cons, ih);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e.toString());</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>ä»ä¸Šé¢çš„ä»£ç ä¸­ä¸éš¾çœ‹å‡ºå…¶æ ¸å¿ƒåœ¨äºè·å–ä¸€ä¸ªä»£ç†ç±»å¯¹è±¡ã€‚å¾—åˆ°ç±»å¯¹è±¡åå†é€šè¿‡åå°„å»åˆ›å»ºä»£ç†å¯¹è±¡å®ä¾‹ã€‚çœ‹çœ‹<code>getProxyClass0</code>æ€ä¹ˆå®ç°çš„ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Generate a proxy class.  Must call the checkProxyAccess method</div><div class="line">     * to perform permission checks before calling this.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Class&lt;?&gt; getProxyClass0(ClassLoader loader,</div><div class="line">                                           Class&lt;?&gt;... interfaces) &#123;</div><div class="line">        <span class="keyword">if</span> (interfaces.length &gt; <span class="number">65535</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"interface limit exceeded"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// If the proxy class defined by the given loader implementing</span></div><div class="line">        <span class="comment">// the given interfaces exists, this will simply return the cached copy;</span></div><div class="line">        <span class="comment">// otherwise, it will create the proxy class via the ProxyClassFactory</span></div><div class="line">        <span class="keyword">return</span> proxyClassCache.get(loader, interfaces);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å‘ƒâ€¦å¥½å§ï¼è¿™ä¸ªæ–¹æ³•æ˜¯ä»ä¸€ä¸ªcacheå¯¹è±¡ä¸­å»æ‹¿Proxyç±»å¯¹è±¡çš„ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯ä¸çŸ¥é“ä»£ç†ç±»å¯¹è±¡æ˜¯æ€ä¹ˆäº§ç”Ÿçš„ã€‚ä¸è¿‡è¿™é‡Œæœ‰ä¸€ç‚¹æœ‰ç‚¹æ„æ€ï¼Œå°±æ˜¯ä»£ç†ç±»å®ç°çš„æ¥å£æ•°ä¸èƒ½è¶…è¿‡65535ä¸ªã€‚çœ‹åˆ°è¿™ä¸ªæ•°å­—æ˜¯å¦å¾ˆæƒŠå–œæˆ–è€…ä¹Ÿæœ‰ç‚¹æ„å¤–ï¼Ÿå…³äº65535æˆ‘ç‰¹æ„å»æŸ¥äº†ä¸€ä¸‹<a href="https://en.wikipedia.org/wiki/65535_(number" target="_blank" rel="external">Wiki</a>)ã€‚è¿™æ˜¯Javaè¯­è¨€æœºåˆ¶å¯¼è‡´çš„ã€‚å½“ç„¶æ²¡æœ‰å“ªä¸ªå˜æ€å»å®ç°è¿™ä¹ˆå¤šä¸ªæ¥å£å§ã€‚<br>æ—¢ç„¶ä»cacheä¸­å»æ‰¾ï¼Œé‚£ä¹ˆçœ‹çœ‹è¿™ä¸ªcacheåˆ°åº•æ˜¯ä½•æ–¹ç¥åœ£ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * a cache of proxy classes</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> WeakCache&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;</div><div class="line">        proxyClassCache = <span class="keyword">new</span> WeakCache&lt;&gt;(<span class="keyword">new</span> KeyFactory(), <span class="keyword">new</span> ProxyClassFactory());</div></pre></td></tr></table></figure></p>
<p>å…·ä½“åˆ°è¿™ä¸ªcacheæ˜¯æ€ä¹ˆå®ç°çš„å°±ä¸å»çº ç»“äº†ï¼Œå› ä¸ºçº ç»“ä¹Ÿæ²¡ç”¨ï¼ˆAPIæ–‡æ¡£ä¸­æ²¡æœ‰è¿™ä¸ªç±»çš„è§£é‡Šï¼Œå› ä¸ºè¿™ä¸ªç±»çš„ä¿®é¥°æ˜¯package-privateçš„è€Œä¸æ˜¯publicï¼‰ã€‚ä»”ç»†ä»¥çœ‹æœ‰ä¸€ä¸ª<code>ProxyClassFactory</code>å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ ç»™è¿™ä¸ªcacheäº†ã€‚è¿™ä¸‹è‡ªè²Œä¼¼æœ‰æå¤´äº†ã€‚çœ‹çœ‹è¿™ä¸ªç±»çš„åå­—å°±å¾ˆçˆ½â€”ä»£ç†ç±»å·¥å‚å˜›ã€‚å®é™…ä¸Šè¿™æ˜¯Proxyçš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ã€‚<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line">private static final class ProxyClassFactory</div><div class="line">        implements BiFunction&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;</div><div class="line">    &#123;</div><div class="line">        // ç”Ÿæˆä»£ç†ç±»åç§°çš„å‰ç¼€</div><div class="line">        private static final String proxyClassNamePrefix = "$Proxy";</div><div class="line"></div><div class="line">        // ç”¨äºç”Ÿæˆä»£ç†ç±»åå­—çš„è®¡æ•°å™¨ </div><div class="line">        private static final AtomicLong nextUniqueNumber = new AtomicLong();</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) &#123;</div><div class="line">			//å„ç§éªŒè¯</div><div class="line">            Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = new IdentityHashMap&lt;&gt;(interfaces.length);</div><div class="line">            for (Class&lt;?&gt; intf : interfaces) &#123;</div><div class="line">                /*</div><div class="line">                 * Verify that the class loader resolves the name of this</div><div class="line">                 * interface to the same Class object.</div><div class="line">                 */</div><div class="line">                Class&lt;?&gt; interfaceClass = null;</div><div class="line">                try &#123;</div><div class="line">                    interfaceClass = Class.forName(intf.getName(), false, loader);</div><div class="line">                &#125; catch (ClassNotFoundException e) &#123;</div><div class="line">                &#125;</div><div class="line">                if (interfaceClass != intf) &#123;</div><div class="line">                    throw new IllegalArgumentException(</div><div class="line">                        intf + " is not visible from class loader");</div><div class="line">                &#125;</div><div class="line">                /*</div><div class="line">                 * Verify that the Class object actually represents an</div><div class="line">                 * interface.</div><div class="line">                 */</div><div class="line">                if (!interfaceClass.isInterface()) &#123;</div><div class="line">                    throw new IllegalArgumentException(</div><div class="line">                        interfaceClass.getName() + " is not an interface");</div><div class="line">                &#125;</div><div class="line">                /*</div><div class="line">                 * Verify that this interface is not a duplicate.</div><div class="line">                 */</div><div class="line">                if (interfaceSet.put(interfaceClass, Boolean.TRUE) != null) &#123;</div><div class="line">                    throw new IllegalArgumentException(</div><div class="line">                        "repeated interface: " + interfaceClass.getName());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">			//ä»£ç†ç±»çš„åŒ…å</div><div class="line">            String proxyPkg = null;     // package to define proxy class in</div><div class="line"></div><div class="line">            //å¯¹äºä¸æ˜¯publicä¿®é¥°çš„æ¥å£ï¼Œä»£ç†ç±»çš„åŒ…åå’Œæ¥å£åŒ…åä¸€è‡´</div><div class="line">            for (Class&lt;?&gt; intf : interfaces) &#123;</div><div class="line">                int flags = intf.getModifiers();</div><div class="line">                if (!Modifier.isPublic(flags)) &#123;</div><div class="line">                    String name = intf.getName();</div><div class="line">                    int n = name.lastIndexOf('.');</div><div class="line">                    String pkg = ((n == -1) ? "" : name.substring(0, n + 1));</div><div class="line">                    if (proxyPkg == null) &#123;</div><div class="line">                        proxyPkg = pkg;</div><div class="line">                    &#125; else if (!pkg.equals(proxyPkg)) &#123;</div><div class="line">                        throw new IllegalArgumentException(</div><div class="line">                            "non-public interfaces from different packages");</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">			//publicä¿®é¥°çš„æ¥å£ åŒ…åç»Ÿä¸€ä¸ºcom.sun.proxy</div><div class="line">            if (proxyPkg == null) &#123;</div><div class="line">                // if no non-public proxy interfaces, use com.sun.proxy package</div><div class="line">                proxyPkg = ReflectUtil.PROXY_PACKAGE + ".";</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            /*</div><div class="line">             * Choose a name for the proxy class to generate.</div><div class="line">             */</div><div class="line">            long num = nextUniqueNumber.getAndIncrement();</div><div class="line">            // é»˜è®¤æƒ…å†µä¸‹ï¼Œä»£ç†ç±»çš„å®Œå…¨é™å®šåä¸ºï¼šcom.sun.proxy.$Proxy0ï¼Œcom.sun.proxy.$Proxy1â€¦â€¦ä¾æ¬¡é€’å¢  </div><div class="line">            String proxyName = proxyPkg + proxyClassNamePrefix + num;</div><div class="line"></div><div class="line">            // è¿™é‡Œæ‰æ˜¯çœŸæ­£çš„ç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç çš„åœ°æ–¹  </div><div class="line">            byte[] proxyClassFile = ProxyGenerator.generateProxyClass(</div><div class="line">                proxyName, interfaces);</div><div class="line">            try &#123;</div><div class="line">	            // æ ¹æ®äºŒè¿›åˆ¶å­—èŠ‚ç è¿”å›ç›¸åº”çš„Classå®ä¾‹  </div><div class="line">                return defineClass0(loader, proxyName,</div><div class="line">                                    proxyClassFile, 0, proxyClassFile.length);</div><div class="line">            &#125; catch (ClassFormatError e) &#123;</div><div class="line">                /*</div><div class="line">                 * A ClassFormatError here means that (barring bugs in the</div><div class="line">                 * proxy class generation code) there was some other</div><div class="line">                 * invalid aspect of the arguments supplied to the proxy</div><div class="line">                 * class creation (such as virtual machine limitations</div><div class="line">                 * exceeded).</div><div class="line">                 */</div><div class="line">                throw new IllegalArgumentException(e.toString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å”‰ï¼Œæ„Ÿè§‰çœ‹äº†åŠå¤©å‘ç°åˆè¢«ç»•è¿›å»äº†ã€‚æ²¡åŠæ³•ï¼Œç»§ç»­çœ‹çœ‹<code>ProxyGenerator</code>è¿™ä¸ªç±»æ€ä¹ˆå»å®ç°çš„ã€‚è¿™ä¸ªæ˜¯Jdkç§æœ‰çš„ï¼Œä½†æ˜¯å¯ä»¥åç¼–è¯‘æŸ¥çœ‹ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] generateProxyClass(<span class="keyword">final</span> String var0, Class[] var1) &#123;</div><div class="line">        ProxyGenerator var2 = <span class="keyword">new</span> ProxyGenerator(var0, var1);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] var3 = var2.generateClassFile();</div><div class="line">        <span class="comment">// è¿™é‡Œæ ¹æ®å‚æ•°é…ç½®ï¼Œå†³å®šæ˜¯å¦æŠŠç”Ÿæˆçš„å­—èŠ‚ç ï¼ˆ.classæ–‡ä»¶ï¼‰ä¿å­˜åˆ°æœ¬åœ°ç£ç›˜ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠŠç›¸åº”çš„classæ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°ï¼Œå†åç¼–è¯‘æ¥çœ‹çœ‹å…·ä½“çš„å®ç°ï¼Œè¿™æ ·æ›´ç›´è§‚  </span></div><div class="line">        <span class="keyword">if</span>(saveGeneratedFiles) &#123;</div><div class="line">            AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        FileOutputStream var1 = <span class="keyword">new</span> FileOutputStream(ProxyGenerator.dotToSlash(var0) + <span class="string">".class"</span>);</div><div class="line">                        var1.write(var3);</div><div class="line">                        var1.close();</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException var2) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"I/O exception saving generated file: "</span> + var2);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> var3;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­ï¼Œè¿™ä¸ªå‚æ•°çš„å®šä¹‰æ˜¯é…±ç´«çš„ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> saveGeneratedFiles = ((Boolean)AccessController.doPrivileged(<span class="keyword">new</span> GetBooleanAction(<span class="string">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span>))).booleanValue();</div></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¾ç½®sun.misc.ProxyGenerator.saveGeneratedFilesè¿™ä¸ªç³»ç»Ÿå±æ€§ä¸ºtrueæ¥æŠŠç”Ÿæˆçš„classä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶æ¥æŸ¥çœ‹ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.getProperties().put(<span class="string">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span>, <span class="string">"true"</span>);</div></pre></td></tr></table></figure></p>
<p>åŠ ä¸Šè¿™æ®µä»£ç åæ‰§è¡Œ<code>main</code>ä¼šæŠ¥è¿™æ ·çš„é”™ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Exception in thread &quot;main&quot; java.lang.InternalError: I/O exception saving generated file: java.io.FileNotFoundException: com/sun/proxy/$Proxy0.class (No such file or directory)</div><div class="line">	at sun.misc.ProxyGenerator$1.run(ProxyGenerator.java:336)</div><div class="line">	at sun.misc.ProxyGenerator$1.run(ProxyGenerator.java:327)</div><div class="line">	at java.security.AccessController.doPrivileged(Native Method)</div><div class="line">	at sun.misc.ProxyGenerator.generateProxyClass(ProxyGenerator.java:326)</div><div class="line">	at java.lang.reflect.Proxy$ProxyClassFactory.apply(Proxy.java:671)</div><div class="line">	at java.lang.reflect.Proxy$ProxyClassFactory.apply(Proxy.java:591)</div><div class="line">	at java.lang.reflect.WeakCache$Factory.get(WeakCache.java:244)</div><div class="line">	at java.lang.reflect.WeakCache.get(WeakCache.java:141)</div><div class="line">	at java.lang.reflect.Proxy.getProxyClass0(Proxy.java:454)</div><div class="line">	at java.lang.reflect.Proxy.newProxyInstance(Proxy.java:736)</div><div class="line">	at com.dw.test.JdkProxy.getProxy(JdkProxy.java:45)</div><div class="line">	at com.dw.test.JdkProxyCase.main(JdkProxyCase.java:19)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)</div><div class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</div><div class="line">	at java.lang.reflect.Method.invoke(Method.java:606)</div><div class="line">	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:147)</div></pre></td></tr></table></figure></p>
<p>è§£å†³åŠæ³•æ˜¯åœ¨å·¥ç¨‹æ ¹è·¯å¾„ä¸‹åˆ›å»ºcom/sun/proxyç›®å½•ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª$Proxy0.classæ–‡ä»¶ï¼Œæ‰èƒ½å¤Ÿæ­£å¸¸è¿è¡Œå¹¶ä¿å­˜classæ–‡ä»¶å†…å®¹ã€‚<br>çœ‹çœ‹åç¼–è¯‘åçš„ä»£ç ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> $<span class="title">Proxy0</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Hello</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> $Proxy0(InvocationHandler var1) <span class="keyword">throws</span>  &#123;</div><div class="line">        <span class="keyword">super</span>(var1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object var1)</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> ((Boolean)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m1, <span class="keyword">new</span> Object[]&#123;var1&#125;)).booleanValue();</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</div><div class="line">            <span class="keyword">throw</span> var3;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">sayHello</span><span class="params">(String var1)</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">	        <span class="comment">//è°ƒç”¨çˆ¶ç±»çš„handlerçš„invokeæ–¹æ³• å®é™…ä¸Šå°±æ˜¯è°ƒç”¨æˆ‘ä»¬å®ç°InvocationHandleræ¥å£çš„ç±»çš„invoke æˆ‘ä»¬çš„é€»è¾‘åœ¨è¿™é‡Œå¤„ç†</span></div><div class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m3, <span class="keyword">new</span> Object[]&#123;var1&#125;);</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</div><div class="line">            <span class="keyword">throw</span> var3;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> ((Integer)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m0, (Object[])<span class="keyword">null</span>)).intValue();</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</div><div class="line">            <span class="keyword">throw</span> var2;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m2, (Object[])<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</div><div class="line">            <span class="keyword">throw</span> var2;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            m1 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"equals"</span>, <span class="keyword">new</span> Class[]&#123;Class.forName(<span class="string">"java.lang.Object"</span>)&#125;);</div><div class="line">            m3 = Class.forName(<span class="string">"com.dw.service_api.Hello"</span>).getMethod(<span class="string">"sayHello"</span>, <span class="keyword">new</span> Class[]&#123;Class.forName(<span class="string">"java.lang.String"</span>)&#125;);</div><div class="line">            m0 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"hashCode"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</div><div class="line">            m2 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"toString"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var2) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(var2.getMessage());</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoClassDefFoundError(var3.getMessage());</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>ä»ç”Ÿæˆå‡ºæ¥çš„è¿™ä¸ªç±»ä¸­å¯ä»¥çœ‹åˆ°</p>
<ol>
<li>è¿™ä¸ªç±»ç»§æ‰¿è‡ª<code>Proxy</code>å®ç°äº†ä»£ç†æ¥å£ã€‚æ‰€ä»¥JDKåŠ¨æ€ä»£ç†åªèƒ½å¯¹æ¥å£è¿›è¡Œä»£ç†ï¼Œè€Œä¸èƒ½å¯¹å®ç°ç±»è¿›è¡Œä»£ç†ã€‚è¿™æ˜¯Javaè¯­è¨€ä¸èƒ½å¤šç»§æ‰¿å¯¼è‡´çš„ã€‚</li>
<li>æ„é€ æ–¹æ³•çš„å‚æ•°æ˜¯<code>InvocationHandler</code>ã€‚è¿™ä¸ªå‚æ•°æ˜¯ç”±æˆ‘ä»¬è°ƒç”¨<code>Proxy#newProxyInstance</code>æ–¹æ³•ä¼ è¿›å»çš„ã€‚</li>
<li>é‡å†™äº†Objectç±»çš„<code>equals</code>ã€<code>hashCode</code>ã€<code>toString</code>ï¼Œå®ƒä»¬éƒ½åªæ˜¯ç®€å•çš„è°ƒç”¨äº†<code>InvocationHandler</code>çš„<code>invoke</code>æ–¹æ³•ï¼Œå³å¯ä»¥å¯¹å…¶è¿›è¡Œç‰¹æ®Šçš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´JDKçš„åŠ¨æ€ä»£ç†è¿˜å¯ä»¥ä»£ç†ä¸Šè¿°ä¸‰ä¸ªæ–¹æ³•ã€‚<br>ä»è¿™é‡Œå¯ä»¥è”æƒ³åˆ°Spring AOPçš„æœºåˆ¶å’Œè¿™ä¸ªåŸç†å…¶å®æ˜¯ä¸€æ ·çš„ï¼Œå¯èƒ½å®ç°ä¼šæ¯”è¿™ä¸ªå¤æ‚çš„å¤šã€‚<h5 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h5></li>
<li>ä½¿ç”¨JDKå®ç°åŠ¨æ€ä»£ç†éœ€è¦å®ç°<code>InvacationHandler</code>æ¥å£ï¼Œä½¿ç”¨<code>Proxy#newProxyInstacne</code>è¿”å›ä»£ç†å¯¹è±¡ã€‚</li>
<li>JDKåŠ¨æ€ä»£ç†çš„æœºåˆ¶æ˜¯é€šè¿‡åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€åœ°å»ç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶ï¼Œç„¶ååŠ è½½åˆ°å†…å­˜ç”Ÿæˆå®ä¾‹ã€‚</li>
<li>JDKåŠ¨æ€ä»£ç†åªèƒ½å¯¹æ¥å£è¿›è¡Œä»£ç†ï¼Œä¸èƒ½å¯¹å®ç°ç±»ä»£ç†ã€‚å› ä¸ºJavaè¯­è¨€ä¸æ”¯æŒå¤šç»§æ‰¿ã€‚è¦æƒ³å¯¹å®ç°ç±»è¿›è¡Œä»£ç†å¯ä»¥ä½¿ç”¨Cglibæ¥å®ç°ã€‚</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘å‘¢ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªå¼€æºçš„PRC FRAMEWORKï¼Œå½“ç„¶ä¸æ˜¯Dubboã€‚ç„¶åæƒ³å»äº†è§£ä¸€ä¸‹RPCåˆ°åº•æ˜¯æ€ä¹ˆå»å®ç°çš„ã€‚äºæ˜¯ä¹å°±äº†è§£äº†ä¸€ç•ªï¼Œå‘ç°å…¶çµé­‚åœ¨äºåŠ¨æ€ä»£ç†å’Œåå°„ã€‚
    
    </summary>
    
      <category term="JDK SOURCE" scheme="http://www.wei-dong.top/categories/JDK-SOURCE/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="JDK" scheme="http://www.wei-dong.top/tags/JDK/"/>
    
  </entry>
  
  <entry>
    <title>è‡ªå®šä¹‰Spring Schema</title>
    <link href="http://www.wei-dong.top/2017/07/01/spring%20schema/"/>
    <id>http://www.wei-dong.top/2017/07/01/spring schema/</id>
    <published>2017-07-01T14:18:23.000Z</published>
    <updated>2017-07-01T14:28:27.000Z</updated>
    
    <content type="html"><![CDATA[<h5 id="Whatâ€™s-schema"><a href="#Whatâ€™s-schema" class="headerlink" title="Whatâ€™s schema"></a>Whatâ€™s schema</h5><p>schemaä¸­æ–‡ç¿»è¯‘æ˜¯æ¦‚è¦ã€è®¡åˆ’ã€å›¾è¡¨ã€‚è¿™é‡Œçš„schemaæŒ‡çš„æ˜¯xml schemaï¼Œä¹Ÿå°±æ˜¯å¯¹xmlçš„çº¦æŸã€‚åœ¨xml schemaä¹‹å‰ï¼Œå¯¹xmlè¿›è¡Œçº¦æŸçš„æ˜¯DTDã€‚ç°åœ¨xml schemaå æ®äº†ä¸»æµã€‚å…¶ä¸­spring frameworkä¸­xmlé…ç½®æ–‡ä»¶å°±æ˜¯ä½¿ç”¨çš„æ˜¯xml schemaï¼Œåç¼€åä¸ºxsdã€‚<br><a id="more"></a> </p>
<h5 id="How-to-define-a-xml-schema"><a href="#How-to-define-a-xml-schema" class="headerlink" title="How to define a xml schema"></a>How to define a xml schema</h5><p>åœ¨spring frameworkä¸­çš„applicationContext.xmlæ–‡ä»¶ä¸­è§åˆ°æœ€å¤šçš„å°±æ˜¯<code>&lt;bean&gt;</code>æ ‡ç­¾ã€‚æœ‰æ—¶å€™æƒ³è‡ªå·±ä¹Ÿæ•´ä¸€ä¸ªæ ‡ç­¾æ»¡è¶³è‡ªå·±çš„éœ€æ±‚ï¼ˆè£…é€¼orçœŸçš„æ˜¯éœ€è¦è‡ªå·±å®ç°ï¼‰é‚£å°±å¾—è‡ªå·±å»æŒ‰ç…§springçš„æ ‡å‡†å»å®ç°äº†ï¼Œå°±å¥½æ¯”JDKä¸­çš„SPIæœºåˆ¶ï¼Œè¦æŒ‰ç…§JDKçš„è§„èŒƒå»åšã€‚Springæ˜¯æ€ä¹ˆè¦æ±‚çš„å‘¢ï¼Ÿ<br>ä»¥mavenå·¥ç¨‹ä¸ºä¾‹ï¼Œåœ¨resourcesç›®å½•ä¸‹çš„META_INFä¸‹éœ€è¦è‡ªå·±å®šä¹‰ä¸€ä¸ª.xsdæ–‡ä»¶ã€‚è¿™é‡Œæˆ‘å®šä¹‰äº†ä¸€ä¸ªä»¥dongweiä¸ºåçš„dongwei.xsdæ–‡ä»¶ï¼š<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">xsd:schema</span> <span class="attr">xmlns</span>=<span class="string">"http://www.dongwei.com/schema/dongwei"</span></span></div><div class="line">            <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></div><div class="line">            <span class="attr">xmlns:tool</span>=<span class="string">"http://www.springframework.org/schema/tool"</span></div><div class="line">            <span class="attr">xmlns:beans</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></div><div class="line">            <span class="attr">targetNamespace</span>=<span class="string">"http://www.dongwei.com/schema/dongwei"</span>&gt;</div><div class="line">	<span class="comment">&lt;!-- è¿™é‡Œimportæœ‰å¥½å‡ ä¸ªschema å¯åŒæ—¶å»çº¦æŸè¢«çº¦æŸçš„xml --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsd:import</span> <span class="attr">namespace</span>=<span class="string">"http://www.w3.org/XML/1998/namespace"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsd:import</span> <span class="attr">namespace</span>=<span class="string">"http://www.springframework.org/schema/tool"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsd:import</span> <span class="attr">namespace</span>=<span class="string">"http://www.springframework.org/schema/beans"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"user"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">xsd:complexType</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">xsd:complexContent</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">xsd:extension</span> <span class="attr">base</span>=<span class="string">"beans:identifiedType"</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span>&gt;</span></div><div class="line">						<span class="tag">&lt;<span class="name">xsd:annotation</span>&gt;</span></div><div class="line">							<span class="tag">&lt;<span class="name">xsd:documentation</span>&gt;</span>å§“å<span class="tag">&lt;/<span class="name">xsd:documentation</span>&gt;</span></div><div class="line">						<span class="tag">&lt;/<span class="name">xsd:annotation</span>&gt;</span></div><div class="line">					<span class="tag">&lt;/<span class="name">xsd:attribute</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">xsd:extension</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">xsd:complexContent</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">xsd:element</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xsd:schema</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„xsdæ–‡ä»¶å°±å®šä¹‰äº†ä¸€ä¸ªçº¦æŸã€‚æ¥ä¸‹æ¥è¿˜éœ€è¦åœ¨resources/META_INFä¸‹æ–°å»ºä¸¤ä¸ªæ–‡ä»¶<code>spring.handlers</code>å’Œ<code>spring.schemas</code> å†…å®¹åˆ†åˆ«æ˜¯è¿™æ ·çš„<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http\://www.dongwei.com/schema/dongwei=com.hnisi.springscheme.schema.DongweiNamespaceHandler</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http\://www.dongwei.com/schema/dongwei/dongwei.xsd=META-INF/dongwei.xsd</div></pre></td></tr></table></figure>
<p>handlersçš„å†…å®¹å¯ä»¥æ˜¯å¤šæ¡ï¼Œè¡¨ç¤ºå¯¹è¿™ä¸ªæ ‡ç­¾çš„å¤„ç†å™¨ã€‚schemaè¡¨ç¤ºçš„æ˜¯xsdçš„æ–‡ä»¶ä½ç½®ï¼Œåœ¨urlä¸èƒ½è®¿é—®çš„æ—¶å€™ï¼ˆæ–­ç½‘ï¼‰ç¨‹åºå¯ä»¥å»æœ¬åœ°æ‰¾schemaã€‚</p>
<h5 id="schema-handlers"><a href="#schema-handlers" class="headerlink" title="schema handlers"></a>schema handlers</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DongweiNamespaceHandler</span>  <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">		registerBeanDefinitionParser(<span class="string">"user"</span>, <span class="keyword">new</span> UserBeanDefinitionParser());		</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è‡ªå®šä¹‰çš„handlerå°±æ˜¯é…±ç´«ï¼Œéœ€å®ç°çˆ¶ç±»çš„<code>init</code>æ–¹æ³•ã€‚ä»–å»è°ƒç”¨äº†<code>registerBeanDefinitionParser</code>å»æ³¨å†Œæ ‡ç­¾ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ ‡ç­¾åï¼Œç¬¬äºŒä¸ªæ˜¯å¯¹è¿™ä¸ªæ ‡ç­¾çš„è§£æã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserBeanDefinitionParser</span> <span class="keyword">extends</span>  <span class="title">AbstractSingleBeanDefinitionParser</span>  </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</div><div class="line">		String id = element.getAttribute(<span class="string">"id"</span>);</div><div class="line">		String name = element.getAttribute(<span class="string">"name"</span>);</div><div class="line">		</div><div class="line">		builder.addPropertyValue(<span class="string">"id"</span>, id);</div><div class="line">		builder.addPropertyValue(<span class="string">"name"</span>, name);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">protected</span> Class&lt;?&gt; getBeanClass(Element element) &#123;</div><div class="line">		<span class="keyword">return</span> User.class;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªè§£æå™¨é‡å†™äº†çˆ¶ç±»çš„<code>doParse</code>å’Œ<code>getBeanClass</code>  å…¶ä¸­<code>doParse</code>å¤„ç†çš„å°±æ˜¯xsdä¸­å®šä¹‰çš„å±æ€§ã€‚<br>å½“ç„¶ï¼Œä¹Ÿä¸èƒ½å°‘äº†æˆ‘ä»¬è¦å®šä¹‰çš„æ ‡ç­¾bean<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">	 <span class="keyword">private</span> String id;</div><div class="line">	 <span class="keyword">private</span> String name;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> id;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> name;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"User [id="</span> + id + <span class="string">", name="</span> + name + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line">	 </div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å®é™…ä¸Šè¿™å°±æ˜¯ä¸€ä¸ªbeanï¼Œå’Œåœ¨applicationContext.xmlä¸­é…ç½®çš„<code>&lt;bean&gt;</code>æ˜¯ä¸€ä¸ªæ„æ€ã€‚è¿™æ ·å®šä¹‰æ ‡ç­¾å»å¤„ç†ä¸ªäººè§‰å¾—æ˜¯ä¸ºäº†æ›´åŠ çµæ´»ï¼Œå¯ä»¥åœ¨xmlæ–‡ä»¶ä¸­å»é…ç½®beançš„å±æ€§ï¼Œæƒ³æ”¹å°±æ”¹ã€‚</p>
<h5 id="How-to-use"><a href="#How-to-use" class="headerlink" title="How to use"></a>How to use</h5><p>å†æ¥çœ‹çœ‹applicationContext.xmlä¸­æ€ä¹ˆä½¿ç”¨<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line">&lt;beans xmlns="http://www.springframework.org/schema/beans"</div><div class="line">    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" </div><div class="line">    xmlns:dongwei="http://www.dongwei.com/schema/dongwei"</div><div class="line">    xsi:schemaLocation="http://www.springframework.org/schema/beans </div><div class="line">    http://www.springframework.org/schema/beans/spring-beans-3.1.xsd    </div><div class="line">    http://www.dongwei.com/schema/dongwei</div><div class="line">    http://www.dongwei.com/schema/dongwei/dongwei.xsd"&gt;</div><div class="line">    </div><div class="line">    &lt;dongwei:user id="eric" name="123"/&gt;</div><div class="line">    </div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œçš„dongweiæ˜¯namespaceã€‚æœ¬è´¨ä¸Šæ¥è®²è¿™å°±æ˜¯ä¸€ä¸ªbeanã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSpringSchema</span> </span>&#123;</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSchame</span><span class="params">()</span></span>&#123;</div><div class="line">		ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"classpath:applicationContext.xml"</span>);</div><div class="line">		User bean = context.getBean(User.class);</div><div class="line">		System.out.println(bean);</div><div class="line">		</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="Last-summary"><a href="#Last-summary" class="headerlink" title="Last summary"></a>Last summary</h5><p>è¿™æ˜¯æˆ‘çœ‹åˆ°SOAæ¡†æ¶çš„æ—¶å€™å‘ç°é…ç½®æ–‡ä»¶ä¸­æœ‰å¾ˆå¤šç±»ä¼¼<code>&lt;mango:registry protocol=&quot;zookeeper&quot; address=&quot;localhost:2181&quot; connect-timeout=&quot;5000&quot; /&gt;</code>çš„ä¸œè¥¿ï¼Œçªç„¶è§‰å¾—å¥½å¥‡ç„¶åå»äº†è§£äº†ä¸€ä¸‹ã€‚ä¸ä»…ç¬¬ä¸‰æ–¹æ¡†æ¶ä¸­æœ‰è¿™æ ·çš„è‡ªå®šä¹‰æ ‡ç­¾ï¼Œspring frameworkä¹Ÿæœ‰ï¼š<code>&lt;context:annotation-config/&gt;</code> è¿™å’Œæˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„<code>&lt;bean&gt;</code>é•¿å¾—è¿˜æ˜¯æœ‰ç‚¹ä¸ä¸€æ ·çš„ã€‚ç„¶åå»çœ‹äº†çœ‹æ€ä¹ˆå»è‡ªå®šä¹‰ä¸€ä¸ªè¿™æ ·çš„ä¸œè¥¿ã€‚è¿™åªæ˜¯ä¸€ä¸ªæœ€ç®€å•çš„å®ç°ï¼Œå®é™…ä¸ŠåŠŸèƒ½å¥å…¨çš„å®ç°æ˜¯å¾ˆå¤æ‚çš„ã€‚ä¹Ÿå¯ä»¥æƒ³è±¡spring frameworkæƒ³å¾—è¿˜æ˜¯å¾ˆå‘¨åˆ°çš„ï¼Œæ°´ä¹Ÿå¾ˆæ·±ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;Whatâ€™s-schema&quot;&gt;&lt;a href=&quot;#Whatâ€™s-schema&quot; class=&quot;headerlink&quot; title=&quot;Whatâ€™s schema&quot;&gt;&lt;/a&gt;Whatâ€™s schema&lt;/h5&gt;&lt;p&gt;schemaä¸­æ–‡ç¿»è¯‘æ˜¯æ¦‚è¦ã€è®¡åˆ’ã€å›¾è¡¨ã€‚è¿™é‡Œçš„schemaæŒ‡çš„æ˜¯xml schemaï¼Œä¹Ÿå°±æ˜¯å¯¹xmlçš„çº¦æŸã€‚åœ¨xml schemaä¹‹å‰ï¼Œå¯¹xmlè¿›è¡Œçº¦æŸçš„æ˜¯DTDã€‚ç°åœ¨xml schemaå æ®äº†ä¸»æµã€‚å…¶ä¸­spring frameworkä¸­xmlé…ç½®æ–‡ä»¶å°±æ˜¯ä½¿ç”¨çš„æ˜¯xml schemaï¼Œåç¼€åä¸ºxsdã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Spring Framework" scheme="http://www.wei-dong.top/categories/Spring-Framework/"/>
    
    
      <category term="Spring" scheme="http://www.wei-dong.top/tags/Spring/"/>
    
      <category term="XML" scheme="http://www.wei-dong.top/tags/XML/"/>
    
  </entry>
  
</feed>
