<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>DongWei&#39;s Blog</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.wei-dong.top/"/>
  <updated>2018-05-17T04:36:14.024Z</updated>
  <id>http://www.wei-dong.top/</id>
  
  <author>
    <name>Mr-Vincent</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>æµ…æJDKä¸­çš„å®šæ—¶å™¨Timerå®ç°</title>
    <link href="http://www.wei-dong.top/2018/04/21/Timer/"/>
    <id>http://www.wei-dong.top/2018/04/21/Timer/</id>
    <published>2018-04-21T08:17:23.000Z</published>
    <updated>2018-05-17T04:36:14.024Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨jdkä¸­å¤„ç†å®šæ—¶ä»»åŠ¡å·¥å…·ç±»ä¸­æœ‰2ç§ï¼šTimerå’ŒScheduledExecutorServiceã€‚å‰è€…æ˜¯åœ¨java.utilåŒ…ä¸­ï¼Œä»1.3ç‰ˆæœ¬å¼€å§‹ï¼Œå±äºæ¯”è¾ƒè€çš„å·¥å…·ç±»äº†ã€‚è€ŒScheduledExecutorServiceå±äºjava.util.concurrentåŒ…ï¼Œä½œè€…æ˜¯è€çˆ·å­Doug Leaï¼Œ1.5ç‰ˆæœ¬å¼€å§‹æ‰æœ‰ã€‚è™½ç„¶ç°åœ¨å¤§å¤šä½¿ç”¨ScheduledExecutorServiceï¼Œä½†æ˜¯æˆ‘è§‰å¾—å¾ˆæœ‰å¿…è¦å¯¹å…¶â€œåŒå®—â€Timerçš„å®ç°è¿›è¡Œè§£è¯»ã€‚</p>
<h4 id="ä¸¾ä¸ªæ —å­"><a href="#ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h4><p>å®˜æ–¹æ–‡æ¡£ä¸­çš„è§£é‡Šæ˜¯è¿™æ ·çš„ï¼š</p>
<blockquote>
<p>A facility for threads to schedule tasks for future execution in a background thread. Tasks may be scheduled for one-time execution, or for repeated execution at regular intervals.</p>
</blockquote>
<p>çº¿ç¨‹çš„å·¥å…·ï¼Œç”¨äºåœ¨åå°çº¿ç¨‹ä¸­å®‰æ’å°†æ¥æ‰§è¡Œçš„ä»»åŠ¡ã€‚ å¯ä»¥å®‰æ’ä¸€æ¬¡æ€§æ‰§è¡Œä»»åŠ¡ï¼Œæˆ–å®šæœŸé‡å¤æ‰§è¡Œä»»åŠ¡ã€‚</p>
<blockquote>
<p>This class is thread-safe: multiple threads can share a single Timer object without the need for external synchronization.<br>This class does not offer real-time guarantees: it schedules tasks using the Object.wait(long) method.<br>Java 5.0 introduced the java.util.concurrent package and one of the concurrency utilities therein is the ScheduledThreadPoolExecutor which is a thread pool for repeatedly executing tasks at a given rate or delay. It is effectively a more versatile replacement for the Timer/TimerTask combination, as it allows multiple service threads, accepts various time units, and doesnâ€™t require subclassing TimerTask (just implement Runnable). Configuring ScheduledThreadPoolExecutor with one thread makes it equivalent to Timer.</p>
</blockquote>
<p>è¿™ä¸ªç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†ä¸èƒ½ä¿è¯æ˜¯å®æ—¶çš„ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯waitæ–¹æ³•æ¥è°ƒåº¦ä»»åŠ¡ã€‚æ–‡æ¡£è¿˜è¯´äº†å»ºè®®ä½¿ç”¨JUCä¸‹çš„ScheduledThreadPoolExecutorï¼ˆScheduledExecutorServiceçš„å®ç°ï¼‰ç±»æ¥å¤„ç†å®šæ—¶ä»»åŠ¡ï¼Œè¿™ä¸ªç±»æä¾›çš„åŠŸèƒ½æ›´å¤šï¼Œå‚æ•°æ›´çµæ´»ï¼Œè€Œä¸”æ˜¯å¤šçº¿ç¨‹çš„ã€‚å½“çº¿ç¨‹æ± sizeæŒ‡å®šä¸ºä¸€é‚£å°±å’ŒTimerä¸€ä¸ªæ ·äº†ã€‚</p>
<p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªdemoæ¥å±•ç¤ºä¸€ä¸‹ç›¸å…³apiçš„ç”¨æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkTimerDemo</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Timer timer = <span class="keyword">new</span> Timer(<span class="string">"timer-demo"</span>);</div><div class="line">        MyTask[] tasks = <span class="keyword">new</span> MyTask[<span class="number">20</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tasks.length; i++) &#123;</div><div class="line">            tasks[i] = <span class="keyword">new</span> MyTask(i);</div><div class="line">            System.out.println(<span class="string">"time no "</span> + i + <span class="string">" task start at "</span> + <span class="keyword">new</span> Date());</div><div class="line">            timer.schedule(tasks[i], <span class="number">2</span> * <span class="number">1000</span>, <span class="number">3</span> * <span class="number">1000</span>);</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"timer started at: "</span> + <span class="keyword">new</span> Date());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> timeNo;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyTask</span><span class="params">(<span class="keyword">int</span> timeNo)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.timeNo = timeNo;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * å¦‚æœä»»åŠ¡å‡ºç°å¼‚å¸¸ä¸è¢«æ•è·ï¼Œå…¶ä»–ä»»åŠ¡ä¸ä¼šè¢«æ‰§è¡Œ</div><div class="line">         */</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (timeNo == <span class="number">8</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"boom"</span>);</div><div class="line">            &#125;</div><div class="line">            System.out.println(<span class="string">"time no "</span> + timeNo);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªdemoå±•ç¤ºä¸€ä¸ªTimerçš„å¼Šç«¯ã€‚å½“ä»»åŠ¡ä¸­å‡ºç°æœªè¢«æ•è·çš„å¼‚å¸¸ï¼Œæ¥ä¸‹æ¥çš„ä»»åŠ¡éƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼Œå®šæ—¶å™¨crashæ‰ã€‚è¿™ä¸ªdemoä¸­å®šä¹‰äº†20ä¸ªtaskäº¤ç»™timerè°ƒåº¦ï¼Œtimerå¯åŠ¨2ç§’åå¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼Œæ¯éš”3ç§’æ‰§è¡Œä¸€æ¬¡ã€‚æ¥ä¸‹æ¥å°±è·Ÿç€demoä¸€æ­¥ä¸€æ­¥çœ‹çœ‹å…¶ä¸­çš„å®ç°åŸç†ã€‚</p>
<h4 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h4><p>é¦–å…ˆçœ‹çœ‹æ„é€ å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Timer</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    thread.setName(name);</div><div class="line">    thread.start();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Timer</span><span class="params">(String name, <span class="keyword">boolean</span> isDaemon)</span> </span>&#123;</div><div class="line">    thread.setName(name);</div><div class="line">    thread.setDaemon(isDaemon);</div><div class="line">    thread.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ„é€ å™¨çš„å‚æ•°ä»£è¡¨ç€timerçš„åå­—å’Œè¿™ä¸ªtimeræ˜¯å¦æ˜¯åå°è¿è¡Œçš„ï¼ˆtimeræœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼‰ã€‚ä¸€æ—¦å®ä¾‹åŒ–å°±å°†è¿™ä¸ªçº¿ç¨‹ç»™å¯åŠ¨äº†ã€‚è¿™ä¸ªçº¿ç¨‹æ˜¯æ ¸å¿ƒã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> TimerThread thread = <span class="keyword">new</span> TimerThread(queue);</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæˆå‘˜å±æ€§TimerThreadå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªqueueã€‚è¿™ä¸ªqueueä¸Šä»€ä¹ˆç¨åå†è®²ã€‚</p>
<p>å®ä¾‹åŒ–ç»“æŸåå°±å¾—è°ƒç”¨å®ƒçš„scheduleæ–¹æ³•äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">(TimerTask task, <span class="keyword">long</span> delay, <span class="keyword">long</span> period)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (delay &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Negative delay."</span>);</div><div class="line">    <span class="keyword">if</span> (period &lt;= <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Non-positive period."</span>);</div><div class="line">    sched(task, System.currentTimeMillis()+delay, -period);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// æ ¸å¿ƒçš„æ˜¯è¿™æ®µé€»è¾‘</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sched</span><span class="params">(TimerTask task, <span class="keyword">long</span> time, <span class="keyword">long</span> period)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (time &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal execution time."</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Constrain value of period sufficiently to prevent numeric</span></div><div class="line">    <span class="comment">// overflow while still being effectively infinitely large.</span></div><div class="line">    <span class="comment">// é˜²æ­¢æº¢å‡º å¦‚æœå‘¨æœŸæ¯”æœ€å¤§å€¼çš„ä¸€åŠè¿˜å¤§ é‚£å°±å°†å…¶é™¤ä»¥2 é“ç†ä½•åœ¨ï¼Ÿ</span></div><div class="line">    <span class="keyword">if</span> (Math.abs(period) &gt; (Long.MAX_VALUE &gt;&gt; <span class="number">1</span>))</div><div class="line">        period &gt;&gt;= <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span>(queue) &#123;</div><div class="line">        <span class="keyword">if</span> (!thread.newTasksMayBeScheduled)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Timer already cancelled."</span>);</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span>(task.lock) &#123;</div><div class="line">            <span class="comment">// å¦‚æœä»»åŠ¡çŠ¶æ€ä¸ä¸ºæ–°åˆ›å»ºçš„ ç›´æ¥æŠ›å¼‚å¸¸</span></div><div class="line">            <span class="keyword">if</span> (task.state != TimerTask.VIRGIN)</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</div><div class="line">                    <span class="string">"Task already scheduled or cancelled"</span>);</div><div class="line">            <span class="comment">// è®¾ç½®ä»»åŠ¡ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ æ‰§è¡Œå‘¨æœŸ ä»¥åŠ çŠ¶æ€</span></div><div class="line">            task.nextExecutionTime = time;</div><div class="line">            task.period = period;</div><div class="line">            task.state = TimerTask.SCHEDULED;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">		  <span class="comment">// ä»»åŠ¡å®é™…ä¸Šæ˜¯æ”¾åœ¨é˜Ÿåˆ—ä¸­ å¹¶ä¸æ˜¯ç›´æ¥æ‰§è¡Œçš„ </span></div><div class="line">        queue.add(task);</div><div class="line">        <span class="comment">// ä¸ºä»€ä¹ˆéœ€è¦queue.getMin() == taskæ—¶æ‰è°ƒç”¨notifyæ–¹æ³•å‘¢ï¼Ÿ</span></div><div class="line">        <span class="keyword">if</span> (queue.getMin() == task)</div><div class="line">            queue.notify();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç çœ‹ä¼¼ç®€å•ï¼Œä½†ä¹Ÿæ˜¯æœ‰ç‚¹é—¨é“çš„ã€‚åœ¨è®¾ç½®ä»»åŠ¡å±æ€§çš„æ—¶å€™é‡‡ç”¨åŠ é”ï¼Œé¿å…å¹¶å‘ä¸‹æŠŠä¸åŒä»»åŠ¡çš„æ‰§è¡Œå‘¨æœŸç­‰å‚æ•°ææ··ä¹±äº†ã€‚æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—ä¸­ä¹Ÿä½¿ç”¨äº†åŠ é”ï¼Œå®é™…ä¸Šæ˜¯é’ˆå¯¹addæ–¹æ³•åŠ çš„é”ã€‚ä¿è¯addä»»åŠ¡ä¸å‡ºä¹±ï¼ˆè¿™ä¸ªé˜Ÿåˆ—ä¸æ˜¯å®‰å…¨çš„é˜Ÿåˆ—ï¼‰ã€‚æœ€åæœ‰ä¸ªåˆ¤æ–­ï¼Œä¸ºä»€ä¹ˆéœ€è¦queue.getMin() == taskæ—¶æ‰è°ƒç”¨notifyæ–¹æ³•å‘¢ï¼Ÿå› ä¸ºåªæœ‰æ–°åŠ å…¥çš„taskæ˜¯æ‰€æœ‰Taskä¸­è¦è¢«æœ€æ—©æ‰§è¡Œçš„taskæ—¶ï¼Œæ‰ä¼šéœ€è¦æ‰“æ–­TimeThreadçš„ç­‰å¾…çŠ¶æ€ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå½“å‰é˜Ÿåˆ—ä¸­æœ‰ä¸¤ä¸ªtaskï¼Œåˆ†åˆ«æ˜¯Aï¼ˆ3åˆ†é’Ÿååˆ°æ—¶é—´ï¼‰ã€Bï¼ˆ5åˆ†é’Ÿååˆ°æ—¶é—´ï¼‰ï¼Œæ­¤æ—¶TimerThreadæ­£åœ¨ç­‰å¾…Açš„æ—¶é—´åˆ°æ¥ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨queue.wait(3min)ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œé˜Ÿåˆ—ä¸­æ–°å¢ä¸€ä¸ªä»»åŠ¡Cï¼ˆ1åˆ†é’Ÿååˆ°æ—¶ï¼‰ï¼Œå¦‚æœä¸æ‰“æ–­queue.wait(3min)ï¼Œé‚£å½“wait(3min)è‡ªç„¶ç»“æŸæ—¶ï¼ŒCä»»åŠ¡å·²ç»è¿‡æœŸäº†â€¦ ä½†æ˜¯å¦‚æœæ–°åŠ å…¥çš„Cä»»åŠ¡æ˜¯éœ€è¦åœ¨4åˆ†é’Ÿåæ‰§è¡Œï¼Œé‚£å°±æ²¡å¿…è¦æ‰“æ–­wait(3min)çš„çŠ¶æ€ï¼Œå› ä¸ºå°±ç®—wait(3min)è‡ªç„¶ç»“æŸæ—¶ï¼ŒCä¹Ÿè¿˜æ²¡åˆ°æ—¶é—´.</p>
<h5 id="ä»»åŠ¡æ˜¯ä»€ä¹ˆ"><a href="#ä»»åŠ¡æ˜¯ä»€ä¹ˆ" class="headerlink" title="ä»»åŠ¡æ˜¯ä»€ä¹ˆ"></a>ä»»åŠ¡æ˜¯ä»€ä¹ˆ</h5><p>è¯´äº†è¿™ä¹ˆä¹…ï¼Œè¿˜æ²¡å¼„æ¸…æ¥šè¿™ä¸ªä»»åŠ¡æ˜¯ä¸ªä»€ä¹ˆç©æ„ï¼ŸæŒ‰ç…§ç›´è§‰è¯´åˆ°ä»»åŠ¡ç¬¬ä¸€æƒ³åˆ°å°±æ˜¯Runnableå¯¹è±¡ï¼Œä½†æ˜¯ä¹Ÿæœ‰å…¶ä»–æƒ…å†µä¸‹ä¸æ˜¯è¿™æ ·çš„ã€‚ç„¶è€Œè¿™ä¸ªä»»åŠ¡ç¡®å®æ˜¯ä¸ªRunnableå¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TimerTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="comment">// å¯¹è±¡é”</span></div><div class="line">    <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</div><div class="line">   </div><div class="line">    <span class="comment">// ä»»åŠ¡çŠ¶æ€ æ–°å»º å·²è°ƒåº¦ å·²æ‰§è¡Œ å·²å–æ¶ˆ</span></div><div class="line">    <span class="comment">// é»˜è®¤æ˜¯æ–°å»º</span></div><div class="line">    <span class="keyword">int</span> state = VIRGIN;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VIRGIN = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SCHEDULED   = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXECUTED    = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED   = <span class="number">3</span>;</div><div class="line">	 <span class="comment">// ä¸‹æ¬¡æ‰§è¡Œçš„æ—¶é—´</span></div><div class="line">    <span class="keyword">long</span> nextExecutionTime;</div><div class="line">	 <span class="comment">// å‘¨æœŸ</span></div><div class="line">    <span class="keyword">long</span> period = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">TimerTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span>(lock) &#123;</div><div class="line">            <span class="keyword">boolean</span> result = (state == SCHEDULED);</div><div class="line">            state = CANCELLED;</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">scheduledExecutionTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span>(lock) &#123;</div><div class="line">            <span class="keyword">return</span> (period &lt; <span class="number">0</span> ? nextExecutionTime + period</div><div class="line">                               : nextExecutionTime - period);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>TimeTaskå¯¹Runnableè¿›è¡Œç®€å•å°è£…ã€‚æš´éœ²å‡ºæŠ½è±¡çš„runæ–¹æ³•è®©ç”¨æˆ·çš„å…·ä½“å®ç°ç±»å»å®Œæˆã€‚åŒæ—¶æä¾›äº†å–æ¶ˆä»»åŠ¡çš„æ–¹æ³•ã€‚å’ŒJUCä¸­ä¸åŒçš„æ˜¯è¿™é‡ŒçŠ¶æ€çš„è½¬åŒ–éå¸¸ç®€å•ï¼Œæ²¡æœ‰JUCä¸­åŠ¨ä¸åŠ¨å°±ç”¨CASçš„éªšæ“ä½œã€‚è€ç‰ˆæœ¬çš„ä»£ç å°±æ˜¯å¥½ç†è§£äº›ã€‚</p>
<h5 id="ä»»åŠ¡çš„è°ƒåº¦ï¼ˆå®šæ—¶å™¨çš„æ ¸å¿ƒï¼‰"><a href="#ä»»åŠ¡çš„è°ƒåº¦ï¼ˆå®šæ—¶å™¨çš„æ ¸å¿ƒï¼‰" class="headerlink" title="ä»»åŠ¡çš„è°ƒåº¦ï¼ˆå®šæ—¶å™¨çš„æ ¸å¿ƒï¼‰"></a>ä»»åŠ¡çš„è°ƒåº¦ï¼ˆå®šæ—¶å™¨çš„æ ¸å¿ƒï¼‰</h5><p>æ—¢ç„¶éƒ½çŸ¥é“ä»»åŠ¡æ˜¯ä»€ä¹ˆäº†ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ˜¯æ€ä¹ˆè¢«å–å‡ºæ¥å’Œæ‰§è¡Œçš„ã€‚é¦–å…ˆå¾—çœ‹çœ‹è¿™ä¸ªçº¿ç¨‹æ˜¯ä¸ªä»€ä¹ˆæ ·å­çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">    <span class="comment">// æ ‡è®°è¿™ä¸ªçº¿ç¨‹æ˜¯ä¸æ˜¯è¦è¢«æŒ‚èµ·</span></div><div class="line">    <span class="keyword">boolean</span> newTasksMayBeScheduled = <span class="keyword">true</span>;</div><div class="line">	 <span class="comment">// ç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ— ç”¨äºå­˜æ”¾ä»»åŠ¡çš„é˜Ÿåˆ—</span></div><div class="line">    <span class="keyword">private</span> TaskQueue queue;</div><div class="line"></div><div class="line">    TimerThread(TaskQueue queue) &#123;</div><div class="line">        <span class="keyword">this</span>.queue = queue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mainLoop();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="comment">// Someone killed this Thread, behave as if Timer cancelled</span></div><div class="line">            <span class="keyword">synchronized</span>(queue) &#123;</div><div class="line">                newTasksMayBeScheduled = <span class="keyword">false</span>;</div><div class="line">                queue.clear();  <span class="comment">// Eliminate obsolete references</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// å…·ä½“æ‰§è¡Œæ ¸å¿ƒé€»è¾‘ å¼€æ­»å¾ªç¯è·‘</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mainLoop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                TimerTask task;</div><div class="line">                <span class="keyword">boolean</span> taskFired;</div><div class="line">                <span class="keyword">synchronized</span>(queue) &#123;</div><div class="line">                    <span class="comment">// Wait for queue to become non-empty</span></div><div class="line">                    <span class="comment">// å¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡ï¼Œè€Œä¸”å®šæ—¶å™¨æ²¡æœ‰è¢«å–æ¶ˆï¼ˆé»˜è®¤ä¸ºtrueï¼Œåªæœ‰å°†timerå–æ¶ˆcancelæ–¹æ³•è°ƒç”¨çš„æ—¶å€™å°†å…¶ç½®ä¸ºfalseï¼Œè¿˜æœ‰ä¸€ä¸ªåœ°æ–¹ï¼‰ å°±å¾—å°†è¿™ä¸ªçº¿ç¨‹æŒ‚èµ· ä¸ç„¶å°±é€ æˆäº†æ­»å¾ªç¯ cpuç›´æ¥ä¸Š100%</span></div><div class="line">                    <span class="comment">// è€Œå”¤èµ·çš„åœ°æ–¹åªæœ‰cancelæ–¹æ³•å’ŒthreadReaper</span></div><div class="line">                    <span class="keyword">while</span> (queue.isEmpty() &amp;&amp; newTasksMayBeScheduled)</div><div class="line">                        queue.wait();</div><div class="line">                    <span class="comment">// ä»»åŠ¡é˜Ÿåˆ—ç©ºäº† å®šæ—¶å™¨å–æ¶ˆäº† è·³å‡ºå¾ªç¯ çº¿ç¨‹ç»“æŸ</span></div><div class="line">                    <span class="keyword">if</span> (queue.isEmpty())</div><div class="line">                        <span class="keyword">break</span>; <span class="comment">// Queue is empty and will forever remain; die</span></div><div class="line"></div><div class="line">                    <span class="comment">// Queue nonempty; look at first evt and do the right thing</span></div><div class="line">                    <span class="keyword">long</span> currentTime, executionTime;</div><div class="line">                    <span class="comment">// ä»é˜Ÿåˆ—ä¸­å–å‡ºæœ€delayæ—¶é—´æœ€å°çš„ä»»åŠ¡ å¾—æœ€æ—©æ‰§è¡Œçš„ä»»åŠ¡</span></div><div class="line">                    task = queue.getMin();</div><div class="line">                    <span class="keyword">synchronized</span>(task.lock) &#123;</div><div class="line">                    	 <span class="comment">// ä»»åŠ¡å–æ¶ˆäº†ï¼Œå°†å…¶ç§»å‡ºé˜Ÿåˆ— ç»§ç»­å–ä¸‹ä¸€ä¸ª</span></div><div class="line">                        <span class="keyword">if</span> (task.state == TimerTask.CANCELLED) &#123;</div><div class="line">                            queue.removeMin();</div><div class="line">                            <span class="keyword">continue</span>;  <span class="comment">// No action required, poll queue again</span></div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">// currentTimeMillis()è¿”å›ä»¥æ¯«ç§’ä¸ºå•ä½çš„å½“å‰æ—¶é—´ï¼Œè¿”å›çš„æ˜¯å½“å‰æ—¶é—´ä¸1970 å¹´ 1 æœˆ 1 æ—¥åˆå¤œä¹‹é—´çš„æ—¶é—´å·®</span></div><div class="line">                        currentTime = System.currentTimeMillis();</div><div class="line">                        executionTime = task.nextExecutionTime;</div><div class="line">                        <span class="comment">// å¦‚æœç»™å®šçš„åˆ°æœŸæ—¶é—´å°äºå½“å‰æ—¶é—´ï¼ˆ1970-01-01åˆ°ç°åœ¨çš„å·®å€¼ï¼‰è¯´æ˜ä»»åŠ¡åˆ°æœŸäº† éœ€è¦è¢«æ‰§è¡Œ æŠŠtaskFiredç½®ä¸ºtrue</span></div><div class="line">                        <span class="keyword">if</span> (taskFired = (executionTime&lt;=currentTime)) &#123;</div><div class="line">                            <span class="keyword">if</span> (task.period == <span class="number">0</span>) &#123; <span class="comment">// Non-repeating, remove</span></div><div class="line">                            	  <span class="comment">// ä¸æ˜¯å‘¨æœŸæ‰§è¡Œçš„ä»»åŠ¡ ç›´æ¥ä»é˜Ÿåˆ—ä¸­ç§»é™¤æ‰ å°†ä»»åŠ¡çŠ¶æ€ç½®ä¸ºå·²æ‰§è¡Œ</span></div><div class="line">                                queue.removeMin();</div><div class="line">                                task.state = TimerTask.EXECUTED;</div><div class="line">                            &#125; <span class="keyword">else</span> &#123; <span class="comment">// Repeating task, reschedule</span></div><div class="line">                                <span class="comment">// æ˜¯å‘¨æœŸä»»åŠ¡ é‡æ–°è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œçš„æ—¶é—´ å³å½“å‰æ—¶é—´+é—´éš”æ—¶é—´ä¸ºä¸‹æ¬¡ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´</span></div><div class="line">                                <span class="comment">// è¿™é‡Œæ˜¯â–å› ä¸ºä¹‹å‰ä¼ è¿›æ¥çš„æ˜¯ä¸€ä¸ªè´Ÿå€¼</span></div><div class="line">                                queue.rescheduleMin(</div><div class="line">                                  task.period&lt;<span class="number">0</span> ? currentTime   - task.period</div><div class="line">                                                : executionTime + task.period);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// å¦‚æœæ²¡åˆ°æœŸ å°±ç­‰ä¸€ä¸ªdelayé•¿çš„æ—¶é—´</span></div><div class="line">                    <span class="comment">// executionTime  = System.currentTimeMillis()+delay</span></div><div class="line">                    <span class="keyword">if</span> (!taskFired) <span class="comment">// Task hasn't yet fired; wait</span></div><div class="line">                        queue.wait(executionTime - currentTime);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// ä»»åŠ¡å¯åŠ¨ æ‰§è¡Œä¸šåŠ¡é€»è¾‘</span></div><div class="line">                <span class="keyword">if</span> (taskFired)  <span class="comment">// Task fired; run it, holding no locks</span></div><div class="line">                    task.run();</div><div class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="å°ç–‘æƒ‘"><a href="#å°ç–‘æƒ‘" class="headerlink" title="å°ç–‘æƒ‘"></a>å°ç–‘æƒ‘</h5><p>æ•´ä¸ªå®šæ—¶å™¨çš„æ ¸å¿ƒé€»è¾‘åœ¨ä»£ç æ³¨é‡Šä¸­éƒ½ä¸€ä¸€è§£é‡Šäº†ã€‚å…¶ä¸­ä¸€ä¸ªç»†èŠ‚ï¼šå˜é‡newTasksMayBeScheduledç”¨æ¥åšä»€ä¹ˆçš„ã€‚<br>é¦–å…ˆå¾—çœ‹çœ‹å®ƒçš„å€¼è¢«ç½®ä¸ºfalseçš„æƒ…å½¢åœ¨å“ªäº›åœ°æ–¹å‡ºç°ã€‚</p>
<ul>
<li>Timer#cancelæ–¹æ³•</li>
<li>TimerThreadçš„mainloopæ‰§è¡Œå®Œäº†finallyå—ä¸­</li>
<li>Timerçš„æˆå‘˜å±æ€§threadReaperçš„finalizeæ–¹æ³•ä¸­</li>
</ul>
<p>å‰ä¸¤è€…éƒ½ä¸å¿…å¤šè§£é‡Šï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯æœ€åä¸€ç§æƒ…å†µã€‚è¿™ç§å†™æ³•æˆ‘è¿˜æ˜¯ç¬¬ä¸€æ¬¡è§ï¼Œè¿˜ä¸æ˜ç™½å…¶ä¸­çš„ç„æœºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * This object causes the timer's task execution thread to exit</div><div class="line"> * gracefully when there are no live references to the Timer object and no</div><div class="line"> * tasks in the timer queue.  It is used in preference to a finalizer on</div><div class="line"> * Timer as such a finalizer would be susceptible to a subclass's</div><div class="line"> * finalizer forgetting to call it.</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object threadReaper = <span class="keyword">new</span> Object() &#123;</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span>(queue) &#123;</div><div class="line">            thread.newTasksMayBeScheduled = <span class="keyword">false</span>;</div><div class="line">            queue.notify(); <span class="comment">// In case queue is empty.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å½“queueä¸ºç©ºï¼Œå¹¶ä¸”æ²¡äººè°ƒç”¨addæˆ–cancelæ–¹æ³•æ—¶ï¼ŒTimerThreadæ°¸è¿œéƒ½ä¸ä¼šstopï¼Œé‚£ä¹ˆè¿˜æœ‰åˆ«çš„å¯èƒ½å—ï¼Ÿ</p>
<p>ä¸Šè¿°çš„åšæ³•å°±æä¾›äº†å¦å¤–çš„æ€è·¯ã€‚å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡çš„æ—¶å€™ï¼ŒTimerThreadä¼šwaitï¼Œå¦‚æœä¸æ‰‹åŠ¨è°ƒç”¨cancelè¿™ä¸ªçº¿ç¨‹ä¸€ç›´ä¼šæŒ‚èµ·ã€‚èªæ˜çš„jdkå°±æä¾›äº†ä¸Šè¿°çš„æ–¹æ³•ã€‚å½“åœ¨GCçš„æ—¶å€™ä¼šè§¦å‘finalizeæ–¹æ³•è°ƒç”¨ï¼Œé‚£ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘GCå‘¢ï¼Ÿå½“Timerå¯¹è±¡æ²¡æœ‰è¢«ä»»ä½•å¯¹è±¡å¼•ç”¨çš„æ—¶å€™å¦‚æœæœ‰GCé‚£ä¹ˆè¿™æ®µä»£ç è¢«è°ƒç”¨ï¼šnewTasksMayBeScheduledç½®ä¸ºfalseåŒæ—¶å°†æŒ‚èµ·çš„TimerThreadå”¤é†’ï¼Œè¿™æ—¶å€™mainloopæ­»å¾ªç¯å°±è·³å‡ºäº†ï¼ŒTimerThreadçº¿ç¨‹ç»“æŸï¼</p>
<p>å…·ä½“éªŒè¯å¯ä»¥ä½¿ç”¨Jprofileè¿™ä¸ªå·¥å…·ã€‚äº‹å®ä¸Šç¡®å®å¯è¡Œã€‚ä½†æ˜¯é€šè¿‡è¿™æ®µä»£ç è®©æˆ‘è”æƒ³åˆ°ä¸€ä¸ªè¿™ä¸ªå®šæ—¶å™¨çš„å¼Šç«¯ï¼šæ²¡åšåˆ°åƒExecutorServiceèƒ½å¤Ÿç­‰åˆ°ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæˆåå†å°†å…¶å…³é—­ã€‚æ‰‹åŠ¨å…³é—­åªèƒ½é€šè¿‡cancelè¿™ç§ç²—æš´çš„æ–¹å¼,è¿˜å¥½jdkå·¥ç¨‹å¸ˆæä¾›è¿™æ ·ä¸€ä¸ªâ€œåé—¨â€ï¼Œäº¤ç»™jvmæ¥ç®¡ç†ã€‚è¿™ä¹Ÿä¸å¤±ä¸ºä¸€ç§è¡¥æ•‘æªæ–½ï¼Œä½†æ˜¯å¯¹äºä¹‹åçš„JUCè€Œè¨€ï¼Œè¿™ç§åšæ³•æ˜¾å¾—æœ‰ç‚¹â€œå°å„¿ç§‘â€äº†ã€‚ä½†æ˜¯å¯¹äºå­¦ä¹ è€…è€Œè¨€ï¼Œè¿™ç§ä»£ç ç»„ç»‡æ˜¾å¾—æ›´å®¹æ˜“è¯»æ‡‚ï¼Œè®¾è®¡æ€æƒ³å¾ˆå®¹æ˜“å‘ˆç°åœ¨æˆ‘ä»¬é¢å‰ã€‚æ—¶ä»£ä¸æ–­è¿›æ­¥ï¼Œæ€»ä¼šæœ‰å¥½çš„è®¾è®¡æ¥å–ä»£è€çš„æ—§çš„ä¸œè¥¿ã€‚å¹¶ä¸æ˜¯æ„å‘³ç€è€çš„æ—§çš„çœŸæ­£è¢«å–ä»£ï¼Œè€Œæ˜¯ä»¥å¦å¤–ä¸€ç§ä»·å€¼å‘ˆç°åœ¨æˆ‘ä»¬åæ¥äººé¢å‰ã€‚é€šè¿‡æ¯”è¾ƒï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæ›´åŠ ç†è§£ä»€ä¹ˆæ˜¯å¥½çš„è®¾è®¡ã€‚</p>
<h5 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h5><p>æ•´ä¸ªTimerå®šæ—¶ä»»åŠ¡çš„æ ¸å¿ƒé€»è¾‘å°±æ¢³ç†å®Œäº†ã€‚å…¶ä¸­æœ‰ä¸€äº›ç»†èŠ‚è¢«å¿½ç•¥æ‰äº†ï¼Œæ¯”å¦‚è¿™ä¸ªä»»åŠ¡é˜Ÿåˆ—queueçš„å…·ä½“å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * This class represents a timer task queue: a priority queue of TimerTasks,</div><div class="line"> * ordered on nextExecutionTime.  Each Timer object has one of these, which it</div><div class="line"> * shares with its TimerThread.  Internally this class uses a heap, which</div><div class="line"> * offers log(n) performance for the add, removeMin and rescheduleMin</div><div class="line"> * operations, and constant time performance for the getMin operation.</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskQueue</span> </span>&#123;</div><div class="line">    <span class="comment">// ç»´æŠ¤ä¸€ä¸ªé•¿åº¦ä¸º128çš„æ•°ç»„</span></div><div class="line">    <span class="keyword">private</span> TimerTask[] queue = <span class="keyword">new</span> TimerTask[<span class="number">128</span>];</div><div class="line"></div><div class="line">    <span class="comment">// é˜Ÿåˆ—é•¿åº¦</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> size;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Adds a new task to the priority queue.</div><div class="line">     * å½“å‰é˜Ÿåˆ—é•¿åº¦ä¸ºæœ€å¤§é•¿åº¦-1çš„æ—¶å€™å°±è¿›è¡Œæ‰©å®¹ æ–°é˜Ÿåˆ—é•¿åº¦ä¸ºå½“å‰2å€</div><div class="line">     * ä¸ºä»€ä¹ˆè¦åœ¨æœ€å¤§é•¿åº¦-1çš„æ—¶å€™æ‰©å®¹å‘¢ï¼Ÿå› ä¸ºä¸æå‰æ‰©å®¹å½“å‰çš„å…ƒç´ åŠ ä¸è¿›å»ğŸ˜‚</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(TimerTask task)</span> </span>&#123;</div><div class="line">        <span class="comment">// Grow backing store if necessary</span></div><div class="line">        <span class="keyword">if</span> (size + <span class="number">1</span> == queue.length)</div><div class="line">            queue = Arrays.copyOf(queue, <span class="number">2</span>*queue.length);</div><div class="line"></div><div class="line">        queue[++size] = task;</div><div class="line">        fixUp(size);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–ç¬¬ä¸€ä¸ªå…ƒç´  åˆ°æœŸæ—¶é—´æœ€è¿‘çš„</div><div class="line">     */</div><div class="line">    <span class="function">TimerTask <span class="title">getMin</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> queue[<span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ä¸‹æ ‡ä»1å¼€å§‹å–</span></div><div class="line">    <span class="function">TimerTask <span class="title">get</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> queue[i];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** </span></div><div class="line">     * ç§»é™¤ç¬¬ä¸€ä¸ªå…ƒç´  åˆ°æœŸæ—¶é—´æœ€è¿‘çš„</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removeMin</span><span class="params">()</span> </span>&#123;</div><div class="line">        queue[<span class="number">1</span>] = queue[size];</div><div class="line">        queue[size--] = <span class="keyword">null</span>;  <span class="comment">// Drop extra reference to prevent memory leak</span></div><div class="line">        fixDown(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">quickRemove</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        <span class="keyword">assert</span> i &lt;= size;</div><div class="line"></div><div class="line">        queue[i] = queue[size];</div><div class="line">        queue[size--] = <span class="keyword">null</span>;  <span class="comment">// Drop extra ref to prevent memory leak</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// æ”¹ç¬¬ä¸€ä¸ªå…ƒç´ çš„åˆ°æœŸæ—¶é—´å±æ€§</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rescheduleMin</span><span class="params">(<span class="keyword">long</span> newTime)</span> </span>&#123;</div><div class="line">        queue[<span class="number">1</span>].nextExecutionTime = newTime;</div><div class="line">        fixDown(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> size==<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Null out task references to prevent memory leak</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;=size; i++)</div><div class="line">            queue[i] = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        size = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Establishes the heap invariant (described above) assuming the heap</div><div class="line">     * satisfies the invariant except possibly for the leaf-node indexed by k</div><div class="line">     * (which may have a nextExecutionTime less than its parent's).</div><div class="line">     *</div><div class="line">     * This method functions by "promoting" queue[k] up the hierarchy</div><div class="line">     * (by swapping it with its parent) repeatedly until queue[k]'s</div><div class="line">     * nextExecutionTime is greater than or equal to that of its parent.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fixUp</span><span class="params">(<span class="keyword">int</span> k)</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (k &gt; <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">int</span> j = k &gt;&gt; <span class="number">1</span>;</div><div class="line">            <span class="keyword">if</span> (queue[j].nextExecutionTime &lt;= queue[k].nextExecutionTime)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            TimerTask tmp = queue[j];  queue[j] = queue[k]; queue[k] = tmp;</div><div class="line">            k = j;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Establishes the heap invariant (described above) in the subtree</div><div class="line">     * rooted at k, which is assumed to satisfy the heap invariant except</div><div class="line">     * possibly for node k itself (which may have a nextExecutionTime greater</div><div class="line">     * than its children's).</div><div class="line">     *</div><div class="line">     * This method functions by "demoting" queue[k] down the hierarchy</div><div class="line">     * (by swapping it with its smaller child) repeatedly until queue[k]'s</div><div class="line">     * nextExecutionTime is less than or equal to those of its children.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fixDown</span><span class="params">(<span class="keyword">int</span> k)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> j;</div><div class="line">        <span class="keyword">while</span> ((j = k &lt;&lt; <span class="number">1</span>) &lt;= size &amp;&amp; j &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (j &lt; size &amp;&amp;</div><div class="line">                queue[j].nextExecutionTime &gt; queue[j+<span class="number">1</span>].nextExecutionTime)</div><div class="line">                j++; <span class="comment">// j indexes smallest kid</span></div><div class="line">            <span class="keyword">if</span> (queue[k].nextExecutionTime &lt;= queue[j].nextExecutionTime)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            TimerTask tmp = queue[j];  queue[j] = queue[k]; queue[k] = tmp;</div><div class="line">            k = j;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Establishes the heap invariant (described above) in the entire tree,</div><div class="line">     * assuming nothing about the order of the elements prior to the call.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">heapify</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = size/<span class="number">2</span>; i &gt;= <span class="number">1</span>; i--)</div><div class="line">            fixDown(i);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªé˜Ÿåˆ—æ˜¯ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—ï¼Œä»¥taskçš„åˆ°æœŸæ—¶é—´æ¥æ’åºï¼Œæ—¶é—´è¶Šå°è¶Šé å‰ã€‚è¿™ä¸ªé˜Ÿåˆ—æ˜¯ç”¨å †ç»“æ„å®ç°çš„ï¼ˆåºŸè¯ï¼Œä¼˜å…ˆé˜Ÿåˆ—æœ¬èº«å°±æ˜¯å †ï¼‰ï¼Œå®é™…ä¸Šå †æœ¬è´¨ä¸Šå°±æ˜¯å®Œå…¨äºŒå‰æ ‘ã€‚å¯¹äºadd removeæ“ä½œçš„å¤æ‚åº¦ä¸ºlog(n)ã€‚æœ€æ ¸å¿ƒçš„æ“ä½œå°±æ˜¯fixDown fixUpã€‚å †ä¹Ÿåˆ†ä¸ºå¤§æ ¹å †å’Œå°æ ¹å †ï¼Œè¿™æ˜¯ä¸€ä¸ªå°æ ¹å †ï¼Œæœ€å°çš„æ”¾åˆ°æœ€ä¸Šé¢ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ ‡ä¸º1çš„ä½ç½®ï¼ˆåªæ˜¯Timerä¸­çš„å®ç°å°†ä¸‹æ ‡ä¸º0çš„ä½ç½®ç»™å¼ƒç”¨äº†ï¼‰ã€‚æ¯æ¬¡æ·»åŠ å…ƒç´ éƒ½å¾—è°ƒæ•´å †ç»“æ„ï¼ŒåŒç†ç§»é™¤çš„æ—¶å€™ä¹Ÿå¾—è¿™æ ·åšã€‚</p>
<p>æœ¬æ–‡ä¸­çš„<a href="https://github.com/Mr-Vincent/simple-rpc/blob/a570c16128062b14ac0f0fa75e769d76060d3ad2/simple-example/src/main/java/top/weidong/example/netty/nettyinpractice/timer/JdkTimerDemo.java#L95-L94" target="_blank" rel="external">demo</a>ã€‚</p>
<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><ul>
<li>æºç è¯»èµ·æ¥æ²¡é‚£ä¹ˆéš¾å—ï¼Œä»”ç»†æ¨æ•²è¿˜æ˜¯å¾ˆæœ‰æ„æ€çš„ã€‚</li>
<li>ç›¸æ¯”è€çˆ·å­Doug Leaçš„éªšä»£ç ï¼Œè¿™ç§ä¸­è§„ä¸­çŸ©çš„å†™æ³•çœ‹èµ·æ¥æ›´è®©äººå®¹æ˜“ç†è§£ã€‚</li>
<li>å»ºè®®ä½¿ç”¨ScheduledExecutorServiceï¼Œæ¯•ç«ŸTimerçš„é€‚ç”¨åœºæ™¯å¾ˆå±€é™ã€‚</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨jdkä¸­å¤„ç†å®šæ—¶ä»»åŠ¡å·¥å…·ç±»ä¸­æœ‰2ç§ï¼šTimerå’ŒScheduledExecutorServiceã€‚å‰è€…æ˜¯åœ¨java.utilåŒ…ä¸­ï¼Œä»1.3ç‰ˆæœ¬å¼€å§‹ï¼Œå±äºæ¯”è¾ƒè€çš„å·¥å…·ç±»äº†ã€‚è€ŒScheduledExecutorServiceå±äºjava.util.concurrentåŒ…ï¼Œä½œè€…
    
    </summary>
    
      <category term="JDK SOURCE" scheme="http://www.wei-dong.top/categories/JDK-SOURCE/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="JDK" scheme="http://www.wei-dong.top/tags/JDK/"/>
    
  </entry>
  
  <entry>
    <title>å†™ç»™2017</title>
    <link href="http://www.wei-dong.top/2017/12/31/my%202017/"/>
    <id>http://www.wei-dong.top/2017/12/31/my 2017/</id>
    <published>2017-12-31T09:42:35.000Z</published>
    <updated>2018-01-01T10:44:55.854Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©æ˜¯2018å¹´ä¸€æœˆä¸€å·ï¼Œ2018å¹´çš„ç¬¬ä¸€å¤©ã€‚èƒ¡æ–æ—©ä¸Šå»HKä¹°æ‰‹æœºåˆ°ç°åœ¨è¿˜æ²¡å›æ¥ï¼Œé˜¿ååˆšåˆšå‡ºå»çº¦ä¼šå»äº†ã€‚ç°åœ¨å°±å‰©ä¸‹æˆ‘ä¸€ä¸ªäººåœ¨å®¶ï¼Œååœ¨æ²™å‘ä¸Šæ€é‡ç€è¿™ç¯‡æ–‡ç« è¯¥æ€ä¹ˆå»å†™ã€‚å‚æ™šäº†ï¼Œä½™æ™–æ¸æ¸è¤ªã€‚å’Œå¾€å¸¸ä¸åŒçš„æ˜¯ä»Šå¤©çš„å¤©é™…çº¿è¾¹æ²¡æœ‰å¾€æ—¥é‚£æ ·çº¢äº†ã€‚æ›¾å‡ ä½•æ—¶ï¼Œå¤šå°‘ä¸ªé»„æ˜ååˆ†ï¼Œæˆ‘å°±ååœ¨æ²™å‘ä¸Šï¼Œé™é™ç­‰ç€ï¼Œç­‰ç€å¤ªé˜³è½å±±ï¼Œç­‰ç€æ™šéœæ˜ çº¢å¤©é™…çº¿ã€‚æ¯åˆ°é‚£ä¸ªç‚¹å„¿ï¼Œæ€»æœ‰é£æœºé£è¿‡ï¼Œåœ¨æ™šéœçš„æ˜ è¡¬ä¸‹ï¼Œç¼“ç¼“åœ°åˆ’è¿‡å»ï¼Œä¸€æ¶åˆä¸€æ¶ã€‚é‚£æ˜¯å»å¹´å¹´åº•çš„æ—¶å€™ã€‚</p>
<p>12æœˆä»½ï¼Œè¢«å…¬å¸åŠé€€ã€‚å½“æ—¶èµ°çš„æ—¶å€™å¿ƒé‡Œåˆ«æå¤šé«˜å…´äº†ï¼Œç»ˆäºå¯ä»¥ä¸ç”¨ä¸Šç­äº†ï¼Œç»ˆäºä¸ç”¨å¤©å¤©åšä¸€äº›æ— èŠåˆæ²¡æœ‰æ„ä¹‰çš„äº‹æƒ…äº†ã€‚æ²¡æœ‰é©¬ä¸Šå»æ‰¾å·¥ä½œï¼Œè€Œæ˜¯ä»€ä¹ˆéƒ½ä¸å¹²ï¼Œç©ä»–ä¹ˆ2ä¸ªæ˜ŸæœŸå†è¯´ã€‚æœçœŸç©äº†ä¸€ä¸ªæ˜ŸæœŸï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰å»æƒ³ï¼Œå®‰å®‰é™é™çš„çœ‹çœ‹ä¹¦ï¼Œçœ‹çœ‹ç”µè§†å‰§ï¼Œç¡ç¡è§‰ã€‚é‚£æ—¶å€™è§‰å¾—ä¸ç”¨å·¥ä½œçœŸçš„æ˜¯å¾ˆå¹¸ç¦çš„ä¸€ä»¶äº‹æƒ…ã€‚ç¬¬äºŒå‘¨æŠŠç®€å†éšä¾¿å†™äº†å†™ï¼Œåˆéšä¾¿æŠ•äº†æŠ•ï¼Œæ²¡ä»€ä¹ˆå›åº”ã€‚ä¹Ÿä¸åœ¨ä¹ï¼Œåæ­£ä¹Ÿä¸æƒ³ä¸Šç­ï¼Œç»§ç»­ç©å‘—ã€‚ä¹¦ä¹Ÿçœ‹çš„å·®ä¸å¤šäº†ï¼Œå¾—æ‰¾äº›æ›´åŠ æœ‰æ„æ€çš„äº‹æƒ…æ¥åšã€‚åœ¨ç½‘æ˜“äº‘è¯¾å ‚ä¸ŠæŠ¥äº†ä¸€ä¸ªç´ æç­ï¼Œå¼€å§‹å­¦ä¹ ç”»ç”»ã€‚è™½ç„¶ç°åœ¨éƒ½æ²¡æ€ä¹ˆåŠ¨ç¬”å»ç”»äº†ï¼Œä½†æ˜¯æˆ‘å¯¹ç´ æçš„çƒ­æƒ…è¿˜æ˜¯æ²¡æœ‰è¤ªå»ã€‚ä¹°äº†å¥½å‡ æœ¬ä¹¦è¿˜æ²¡å¼€å§‹çœ‹ï¼Œæˆ‘çŸ¥é“æ€»ä¼šçœ‹çš„ï¼Œæ€»ä¼šå»åšæŒä¸‹å»ï¼Œæ€»ä¼šå®è·µå‡ºæ¥ã€‚ä»”ç»†å›æƒ³è¿‡å»ï¼Œå¯¹äºæ¯å¤©çš„æ¯ç‡¥æ— èŠçš„codingå’ŒåŠ ç­ï¼Œæ˜¯æ—¶å€™è¯¥é—®é—®è‡ªå·±åˆ°åº•æƒ³è¦ä»€ä¹ˆï¼Œæƒ³è¾¾åˆ°ä¸€ä¸ªä»€ä¹ˆæ ·çš„å±‚æ¬¡ã€‚åŸ¹å…»ä¸€ç§å…´è¶£çˆ±å¥½å¯¹äºæˆ‘ä»¬è¿™ç§ç”Ÿæ´»å•è°ƒæ— èŠçš„äººæ¥è¯´å¾ˆé‡è¦ã€‚ä¸å…‰ä»…ä»…å­¦ç´ æï¼Œè¿˜æ—¶ä¸æ—¶å»è°ˆè°ˆå‰ä»–ï¼Œè™½ç„¶æ‰‹ä¸Šçš„èŒ§éƒ½æ¶ˆåœ°å·®ä¸å¤šäº†ï¼Œä½†æ˜¯çƒ­æƒ…è¿˜åœ¨ã€‚</p>
<p>æ²¡ä¸Šç­çš„æ—¥å­æˆ‘æƒ³è¿‡å¾ˆå¤šã€‚ç›®å‰è¿™ä¸ªèŒä¸šæˆ‘æƒ³æˆ‘ä¸ä¼šä¸€ç›´èµ°ä¸‹å»ï¼Œä¸‡ä¸€èµ°ä¸ä¸‹å»äº†æˆ‘å¾—ç»™è‡ªå·±æ‰¾æ¡åè·¯ã€‚ä½†ä¸è®ºæ€ä¹ˆè¯´ï¼Œç›®å‰è¿˜æ˜¯å¾—èµ°ä¸‹å»ï¼Œè¿˜æ˜¯å¾—ä¸æ–­å»å­¦ä¹ ã€‚</p>
<p>æ€»è§‰å¾—æœ‰å¾ˆå¤šæ—¶å€™ï¼Œèƒ½ä¸€ä¸ªäººç‹¬å¤„æ˜¯ä¸€ä»¶å¤šä¹ˆæ„‰å¿«çš„äº‹æƒ…ã€‚å±‹å­é‡Œå°±æˆ‘ä¸€ä¸ªäººï¼Œå¿ƒæ²¡æœ‰é‚£ä¹ˆæµ®èºã€‚ä¸ä¼šå»çœ‹é˜¿åæ‰“æ¸¸æˆï¼Œä¸ä¼šæ‰¾èƒ¡æ–æ‰¯æ·¡ã€‚å¯ä»¥çœ‹ä¹¦ï¼Œå¯ä»¥å†™ç‚¹ä¸œè¥¿â€¦</p>
<p>æ€»æ˜¯å°†çœ‹ä¹¦ä½œä¸ºä¸€ä»¶å¾ˆé‡è¦çš„äº‹æƒ…ã€‚ç¦»å¼€æ ¡å›­ï¼Œè¸å…¥ç¤¾ä¼šå‚åŠ å·¥ä½œï¼Œå¯èƒ½æ²¡æœ‰æœºä¼šå»ç¢°ä¹¦ã€‚å› æ­¤è¯»ä¹¦å°±æ˜¾å¾—ååˆ†å¯è´µã€‚æ„Ÿè§¦æœ€æ˜æ˜¾çš„æ—¶å€™å°±æ˜¯å’Œåˆ«äººäº¤æµçš„æ—¶å€™ï¼Œæœ‰æ—¶å€™è§‰å¾—å¯¹æ–¹è¯´çš„è‡ªå·±éƒ½æ²¡åŠæ³•æ¥ã€‚å»å¹´æˆ‘ä¹Ÿè¯»äº†éƒ¨åˆ†ä¹¦ï¼Œä»…ä»…åªæ˜¯è¯»è¿‡ï¼Œè¿˜æ²¡æœ‰ä»€ä¹ˆæ·±åˆ»è®¤è¯†ã€‚å°è±¡ä¸­è€—æ—¶æœ€é•¿çš„æ˜¯ã€Šç™½é¹¿åŸã€‹ã€‚ä»¥å‰ä¸Šä¸‹ç­åœ¨åœ°é“ä¸Šå°±æ‹¿ç€æ‰‹æœºçœ‹ï¼Œæ¯å¤©éƒ½èƒ½çœ‹ä¸€ç‚¹ã€‚ç°åœ¨æ²¡æœ‰é‚£ä¹ˆå¤šå¤§æŠŠå¤§æŠŠçš„æ—¶é—´äº†ã€‚é›¶ç¢çš„æ—¶é—´ä¹Ÿä¸çŸ¥é“è¯¥æ€ä¹ˆåˆ©ç”¨ã€‚æ”¶è·æœ€å¤§çš„ä¸€æœ¬ä¹¦æ˜¯ã€ŠHow Tomcat Worksã€‹ã€‚è¿™æœ¬ä¹¦æœ¬èº«å°±å†™å¾—ä¸é”™ï¼Œæµ…æ˜¾æ˜“æ‡‚ã€‚å¾ˆä¹…ä»¥æ¥ï¼Œæˆ‘è¯»ä¹¦éƒ½æ²¡æœ‰è®°ç¬”è®°çš„ä¹ æƒ¯ã€‚ä½†æ˜¯è¯»è¿™æœ¬ä¹¦æˆ‘ç”¨çº¸ç¬”å°†å…¶ä¸­æœ‰æ„æ€çš„å†…å®¹è®°ä¸‹æ¥äº†ã€‚ä»¥å‰ä¸€ç›´è®¤ä¸ºä¸ä¼šçš„æˆ–è€…å¿˜è®°äº†çš„å»ç™¾åº¦è°·æ­Œå°±å¥½äº†ã€‚ç°åœ¨åˆ™æ˜¯è§‰å¾—æœ‰å¿…è¦å°±å¯ä»¥ç”¨ç¬”è®°ä¸‹æ¥ï¼Œç”»ä¸€ä¸‹ä¹Ÿè¡Œï¼Œè¿™æ ·å®¹æ˜“å¸®åŠ©ç†è§£å’Œè®°å¿†ã€‚è™½ç„¶ç°åœ¨çš„å„ç§è½¯ä»¶APPéƒ½å¾ˆå¤šå¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯æœ‰æ—¶å€™å°±æ˜¯è®°ä¸‹æ¥å°±å¾ˆå°‘å»çœ‹äº†ã€‚èµ°è¿‡ä¸€é­ï¼Œæ€»å¾—ç•™ä¸‹ç‚¹ä»€ä¹ˆå§ã€‚</p>
<p>å‰äº›æ—¥å­ï¼ŒæŠŠç©äº†å·®ä¸å¤š2å¹´çš„æ¸¸æˆç‹è€…å†œè¯å¸è½½äº†ã€‚ä»¥åä¸å†è¿™ä¸Šé¢æµªè´¹æ—¶é—´äº†ã€‚ç„¶è€Œå¯è€»çš„æ˜¯å¼€å§‹äº†åƒé¸¡ã€‚æˆ‘æƒ³æˆ‘ä¹Ÿä¸ä¼šæ²‰è¿·äºåƒé¸¡å¤ªä¹…ï¼Œæ¯”è¾ƒä¸€ä¸ªäººç©ä¹Ÿæ²¡å¤šå¤§æ„æ€ã€‚ç©ç€ç©ç€å¯èƒ½å°±æ— èŠäº†ã€‚å¯èƒ½ä¼šå°†æ³¨æ„åŠ›è½¬ç§»åˆ°å†™ä½œæˆ–è€…ç´ æä¸Šæ¥ã€‚å»å¹´å±¯çš„ä¹¦ä¹Ÿè¿˜ä¸€æœ¬æ²¡çœ‹å®Œï¼Œæ€»å¾—ç»™è‡ªå·±ä¸€ç‚¹äº¤ä»£å§ã€‚</p>
<p>å‡ºæ¥å·¥ä½œè¿™ä¹ˆä¹…äº†ï¼Œéš¾è¿‡çš„æ˜¯ä¸€ä¸ªæ–°æœ‹å‹éƒ½æ²¡æœ‰äº¤åˆ°ã€‚å¾ˆå¤šè€æœ‹å‹å´æ²¡ä»€ä¹ˆè”ç³»äº†ã€‚æœ‰æ—¶å€™å°±è§‰å¾—äººæƒ…è–„å¦‚çº¸ã€‚åœˆå­ä¸åŒäº†ï¼Œå¯èƒ½è®¤çŸ¥ä¹Ÿä¸å¤ªä¸€æ ·äº†ã€‚ä»…ä»…åªæ˜¯æˆ‘è¿˜åœ¨åŸåœ°è¸æ­¥è€Œå·²ï¼Œå´æ€»æš—ç¤ºè‡ªå·±è¦å‘å‰èµ°ã€‚å³ä½¿å¦‚æ­¤é‚£åˆæ€æ ·ï¼Ÿæˆ‘åˆå¿ƒä¸æ”¹ï¼Œæˆ‘ä¾æ—§æ˜¯é‚£ä¸ªæˆ‘ã€‚è™½ä¸å­¤ç‹¬ä¸ºä¼´ï¼Œä½†æ˜¯å†…å¿ƒä¾æ—§ä¸°å¯Œã€‚ä»æ­¤å†ä¹Ÿä¸å§”å±ˆè‡ªå·±ï¼Œä¸å†çƒ­è„¸è´´å†·å±è‚¡ã€‚æˆ‘ä¹Ÿæœ‰æˆ‘è‡ªå·±çš„ä¸–ç•Œã€‚</p>
<p>æ¯å½“å›é¦–è¿‡å»çš„æ—¶å€™ï¼Œæ€»æ˜¯è§‰å¾—è®¸å¤šæ—¥å­éƒ½è™šåº¦äº†ã€‚æœ‰äº›äº‹æƒ…ï¼Œåšå¥½è§„åˆ’è¿˜æ˜¯å¾ˆæœ‰å¿…è¦ï¼Œå‰ææ˜¯å‘€æœ‰è¶³å¤Ÿçš„è‡ªå¾‹ï¼Œå¦åˆ™å…¶ä»–éƒ½æ˜¯çæ‰¯æ·¡ã€‚</p>
<p>ä¸è®ºè¿‡å»æœ‰æ€æ ·çš„æ‡Šæ‚”å’Œä¸æ»¡ï¼Œè·¯è¿˜é•¿ï¼Œæ€»å¾—å¾€å‰èµ°ã€‚åªå¸Œæœ›åœ¨ä¸‹ä¸ªè·¯æ ‡å›å¤´çš„æ—¶å€™ï¼Œæˆ‘èƒ½ä¾ç„¶è®°å¾—æ­¤æ—¶çš„æˆ‘å¯¹è‡ªå·±çš„æœŸè®¸ã€‚</p>
<p>2018ï¼Œæˆ‘å·²å‡†å¤‡å¥½ï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»Šå¤©æ˜¯2018å¹´ä¸€æœˆä¸€å·ï¼Œ2018å¹´çš„ç¬¬ä¸€å¤©ã€‚èƒ¡æ–æ—©ä¸Šå»HKä¹°æ‰‹æœºåˆ°ç°åœ¨è¿˜æ²¡å›æ¥ï¼Œé˜¿ååˆšåˆšå‡ºå»çº¦ä¼šå»äº†ã€‚ç°åœ¨å°±å‰©ä¸‹æˆ‘ä¸€ä¸ªäººåœ¨å®¶ï¼Œååœ¨æ²™å‘ä¸Šæ€é‡ç€è¿™ç¯‡æ–‡ç« è¯¥æ€ä¹ˆå»å†™ã€‚å‚æ™šäº†ï¼Œä½™æ™–æ¸æ¸è¤ªã€‚å’Œå¾€å¸¸ä¸åŒçš„æ˜¯ä»Šå¤©çš„å¤©é™…çº¿è¾¹æ²¡æœ‰å¾€æ—¥é‚£æ ·çº¢äº†ã€‚æ›¾å‡ ä½•æ—¶ï¼Œå¤šå°‘ä¸ªé»„æ˜ååˆ†ï¼Œæˆ‘å°±ååœ¨æ²™å‘ä¸Šï¼Œé™
    
    </summary>
    
      <category term="beyound coding" scheme="http://www.wei-dong.top/categories/beyound-coding/"/>
    
    
      <category term="æ‰€æƒ³" scheme="http://www.wei-dong.top/tags/%E6%89%80%E6%83%B3/"/>
    
  </entry>
  
  <entry>
    <title>ã€ŠHow Tomcat Worksã€‹è¯»ä¹¦ç¬”è®°</title>
    <link href="http://www.wei-dong.top/2017/12/06/%E3%80%8AHow%20Tomcat%20Works%E3%80%8B%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    <id>http://www.wei-dong.top/2017/12/06/ã€ŠHow Tomcat Worksã€‹è¯»ä¹¦ç¬”è®°/</id>
    <published>2017-12-06T04:37:23.000Z</published>
    <updated>2017-12-06T04:39:19.177Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™æœ¬ä¹¦çœ‹äº†è¿™ä¹ˆä¹…ï¼Œå·®ä¸å¤šå¯ä»¥ç®—æ˜¯çœ‹å®Œäº†ã€‚å‡†ç¡®æ¥è®²æ˜¯è¿˜å‰©ä¸¤ä¸ªç« èŠ‚æ²¡æœ‰è¯»å®Œã€‚æœ€åé‚£ä¸¤ä¸ªç« èŠ‚çš„çš„ç¡®ç¡®æ˜¯å¾ˆä¸å¾—åŠ²ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯è‡ªå·±å¼€å§‹æµ®èºèµ·æ¥äº†ã€‚æˆ‘çœ‹çš„æ˜¯ä¸­æ–‡ç¿»è¯‘çš„ï¼Œå¯æ°”çš„æ˜¯ä¸­æ–‡ç¿»è¯‘å¾ˆå¤šé”™åˆ«å­—ä¸è¯´ï¼Œå±…ç„¶æœ‰äº›åœ°æ–¹æ ¹æœ¬å°±æ²¡æœ‰ç¿»è¯‘åˆ°ï¼Œâ€œç¼ºæ–¤å°‘ä¸¤â€å¾ˆå¯æ°”ã€‚ç„¶ååˆæ‰¾åŸç‰ˆå¯¹ç…§ç€çœ‹ï¼Œé¿å…è¢«â€œè¯¯å…¥æ­§é€”â€ã€‚<br><a id="more"></a><br>å·®ä¸å¤šâ€œè¯»å®Œâ€åï¼Œæœ‰é‚£ä¹ˆä¸€ç‚¹å°æ”¶è·ï¼š</p>
<ul>
<li>è§‚å¯Ÿè€…æ¨¡å¼</li>
<li>è´£ä»»é“¾æ¨¡å¼</li>
<li>é—¨é¢æ¨¡å¼</li>
<li>æƒ³åˆ°äº†å†å†™</li>
</ul>
<h3 id="è§‚å¯Ÿè€…æ¨¡å¼"><a href="#è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h3><p>è¿™ä¸ªæ¨¡å¼æ˜¯æˆ‘å°è±¡æœ€æ·±åˆ»çš„ï¼Œä¹Ÿæ˜¯æˆ‘æœ€æƒ³å­¦ä¹ çš„ã€‚å°¤å…¶æ˜¯çœ‹åˆ°äº†Tomcatæºç ä¸­çš„é‚£äº›éªšæ“ä½œã€‚å½“ç„¶ä¸ä»…ä»…æ˜¯åœ¨Tomcatä¸­æœ‰è¿™ç§è®¾è®¡ï¼Œ<br>æˆ‘åœ¨çœ‹Springæºç çš„æ—¶å€™ä¹Ÿç•™æ„åˆ°äº†ä¹Ÿæœ‰è¿™ç§è®¾è®¡æ€æƒ³ï¼Œå†…å¿ƒä¸ç¦å‘å‡ºä¸€ä¸ªä¿¡å·ï¼šæ•™ç»ƒæˆ‘ä¹Ÿæƒ³å­¦ã€‚</p>
<p>æ¥ä¸‹æ¥å°±é’ˆå¯¹Tomcatä¸­çš„æºç æ¥å¯¹è§‚å¯Ÿè€…æ¨¡å¼è¿›è¡Œç®€å•çš„æ•´ç†ã€‚Tomcatä¸­è®¸å¤šç»„ä»¶éƒ½æœ‰ç”Ÿå‘½å‘¨æœŸï¼Œå…¶å®ä¸æ­¢Tomcatï¼Œå¾ˆå¤šå…¶ä»–åœ°æ–¹ä¹Ÿæœ‰ç”Ÿå‘½å‘¨æœŸçš„æ¦‚å¿µï¼šSpringç”Ÿå‘½å‘¨æœŸï¼ŒServletç”Ÿå‘½å‘¨æœŸç­‰ç­‰ã€‚ç”Ÿå‘½å‘¨æœŸå°±æ˜¯è§‚å¯Ÿè€…æ¨¡å¼æœ€å¥½çš„ä½“ç°ã€‚ä¸¾ä¸ªæ —å­ï¼ŒServiceç»„ä»¶ï¼š<code>StandardService</code>å°±æœ‰ç”Ÿå‘½å‘¨æœŸï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">StandardService</span></span></div><div class="line">    <span class="keyword">implements</span> <span class="title">Lifecycle</span>, <span class="title">Service</span> &#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The set of Connectors associated with this Service.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Connector connectors[] = <span class="keyword">new</span> Connector[<span class="number">0</span>];</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The Container associated with this Service.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Container container = <span class="keyword">null</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The debugging detail level for this component.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> debug = <span class="number">0</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Descriptive information about this component implementation.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String info =</div><div class="line">        <span class="string">"org.apache.catalina.core.StandardService/1.0"</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Has this component been initialized?</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> initialized = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The name of this service.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String name = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The lifecycle event support for this component.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> LifecycleSupport lifecycle = <span class="keyword">new</span> LifecycleSupport(<span class="keyword">this</span>);</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The string manager for this package.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> StringManager sm =</div><div class="line">        StringManager.getManager(Constants.Package);</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The &lt;code&gt;Server&lt;/code&gt; that owns this Service, if any.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Server server = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Has this component been started?</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The property change support for this component.</div><div class="line">     */</div><div class="line">    <span class="keyword">protected</span> PropertyChangeSupport support = <span class="keyword">new</span> PropertyChangeSupport(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="comment">// ------------------------------------------------------ Lifecycle Methods</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Add a LifecycleEvent listener to this component.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> listener The listener to add</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</div><div class="line"></div><div class="line">        lifecycle.addLifecycleListener(listener);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Get the lifecycle listeners associated with this lifecycle. If this </div><div class="line">     * Lifecycle has no listeners registered, a zero-length array is returned.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> LifecycleListener[] findLifecycleListeners() &#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> lifecycle.findLifecycleListeners();</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Remove a LifecycleEvent listener from this component.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> listener The listener to remove</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</div><div class="line"></div><div class="line">        lifecycle.removeLifecycleListener(listener);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Prepare for the beginning of active use of the public methods of this</div><div class="line">     * component.  This method should be called before any of the public</div><div class="line">     * methods of this component are utilized.  It should also send a</div><div class="line">     * LifecycleEvent of type START_EVENT to any registered listeners.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</div><div class="line">     *  that prevents this component from being used</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// Validate and update our current component state</span></div><div class="line">        <span class="keyword">if</span> (started) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException</div><div class="line">                (sm.getString(<span class="string">"standardService.start.started"</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Notify our interested LifecycleListeners</span></div><div class="line">        lifecycle.fireLifecycleEvent(BEFORE_START_EVENT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        System.out.println</div><div class="line">            (sm.getString(<span class="string">"standardService.start.name"</span>, <span class="keyword">this</span>.name));</div><div class="line">        lifecycle.fireLifecycleEvent(START_EVENT, <span class="keyword">null</span>);</div><div class="line">        started = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Start our defined Container first</span></div><div class="line">        <span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (container) &#123;</div><div class="line">                <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Lifecycle) &#123;</div><div class="line">                    ((Lifecycle) container).start();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Start our defined Connectors second</span></div><div class="line">        <span class="keyword">synchronized</span> (connectors) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; connectors.length; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (connectors[i] <span class="keyword">instanceof</span> Lifecycle)</div><div class="line">                    ((Lifecycle) connectors[i]).start();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Notify our interested LifecycleListeners</span></div><div class="line">        lifecycle.fireLifecycleEvent(AFTER_START_EVENT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Gracefully terminate the active use of the public methods of this</div><div class="line">     * component.  This method should be the last one called on a given</div><div class="line">     * instance of this component.  It should also send a LifecycleEvent</div><div class="line">     * of type STOP_EVENT to any registered listeners.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</div><div class="line">     *  that needs to be reported</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// Validate and update our current component state</span></div><div class="line">        <span class="keyword">if</span> (!started) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException</div><div class="line">                (sm.getString(<span class="string">"standardService.stop.notStarted"</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Notify our interested LifecycleListeners</span></div><div class="line">        lifecycle.fireLifecycleEvent(BEFORE_STOP_EVENT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        lifecycle.fireLifecycleEvent(STOP_EVENT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        System.out.println</div><div class="line">            (sm.getString(<span class="string">"standardService.stop.name"</span>, <span class="keyword">this</span>.name));</div><div class="line">        started = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Stop our defined Connectors first</span></div><div class="line">        <span class="keyword">synchronized</span> (connectors) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; connectors.length; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (connectors[i] <span class="keyword">instanceof</span> Lifecycle)</div><div class="line">                    ((Lifecycle) connectors[i]).stop();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Stop our defined Container second</span></div><div class="line">        <span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (container) &#123;</div><div class="line">                <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Lifecycle) &#123;</div><div class="line">                    ((Lifecycle) container).stop();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Notify our interested LifecycleListeners</span></div><div class="line">        lifecycle.fireLifecycleEvent(AFTER_STOP_EVENT, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Invoke a pre-startup initialization. This is used to allow connectors</div><div class="line">     * to bind to restricted ports under Unix operating environments.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span></span></div><div class="line">    <span class="keyword">throws</span> LifecycleException &#123;</div><div class="line">        <span class="keyword">if</span> (initialized)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException (</div><div class="line">                sm.getString(<span class="string">"standardService.initialize.initialized"</span>));</div><div class="line">        initialized = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Initialize our defined Connectors</span></div><div class="line">        <span class="keyword">synchronized</span> (connectors) &#123;</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; connectors.length; i++) &#123;</div><div class="line">                    connectors[i].initialize();</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­åªä¿ç•™äº†æœ‰å…³<code>Lifecycle</code>æ¥å£çš„æ–¹æ³•å®ç°ã€‚çœ‹çœ‹<code>Lifecycle</code>æ¥å£çš„å®šä¹‰ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Lifecycle</span> </span>&#123;</div><div class="line">    <span class="comment">// ----------------------------------------------------- Manifest Constants</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The LifecycleEvent type for the "component start" event.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String START_EVENT = <span class="string">"start"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The LifecycleEvent type for the "component before start" event.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEFORE_START_EVENT = <span class="string">"before_start"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The LifecycleEvent type for the "component after start" event.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AFTER_START_EVENT = <span class="string">"after_start"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The LifecycleEvent type for the "component stop" event.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String STOP_EVENT = <span class="string">"stop"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The LifecycleEvent type for the "component before stop" event.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEFORE_STOP_EVENT = <span class="string">"before_stop"</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The LifecycleEvent type for the "component after stop" event.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AFTER_STOP_EVENT = <span class="string">"after_stop"</span>;</div><div class="line">    <span class="comment">// --------------------------------------------------------- Public Methods</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Add a LifecycleEvent listener to this component.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> listener The listener to add</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLifecycleListener</span><span class="params">(LifecycleListener listener)</span></span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Get the lifecycle listeners associated with this lifecycle. If this </div><div class="line">     * Lifecycle has no listeners registered, a zero-length array is returned.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> LifecycleListener[] findLifecycleListeners();</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Remove a LifecycleEvent listener from this component.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> listener The listener to remove</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeLifecycleListener</span><span class="params">(LifecycleListener listener)</span></span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Prepare for the beginning of active use of the public methods of this</div><div class="line">     * component.  This method should be called before any of the public</div><div class="line">     * methods of this component are utilized.  It should also send a</div><div class="line">     * LifecycleEvent of type START_EVENT to any registered listeners.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</div><div class="line">     *  that prevents this component from being used</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException</span>;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Gracefully terminate the active use of the public methods of this</div><div class="line">     * component.  This method should be the last one called on a given</div><div class="line">     * instance of this component.  It should also send a LifecycleEvent</div><div class="line">     * of type STOP_EVENT to any registered listeners.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</div><div class="line">     *  that needs to be reported</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>é™¤äº†å®šä¹‰ä¸¤ä¸ªåŠ¨ä½œ<code>start</code>å’Œ<code>stop</code>å¤–ï¼Œè¿˜å®šä¹‰äº†ä¸€ç³»åˆ—å¸¸é‡ã€‚å½“ç„¶è¿˜æœ‰å¯¹ç›‘å¬å™¨çš„æ“ä½œï¼šæ·»åŠ ã€æŸ¥æ‰¾å’Œç§»é™¤ã€‚ç›‘å¬å™¨å¯ä»¥è¯´æ˜¯è§‚å¯Ÿè€…æ¨¡å¼ä¸­çš„è®¢é˜…è€…ï¼Œå®ƒå‘æ„Ÿå…´è¶£çš„äº‹ä»¶æ³¨å†Œï¼Œç­‰äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™å®ƒè·å¾—é€šçŸ¥ã€‚è¿™ä¸ªæ¨¡å‹åœ¨Tomcatä¸­å¯ä»¥è¿™æ ·è§£é‡Šï¼šæŸä¸ªç›‘å¬å™¨å¯¹<code>start</code>äº‹ä»¶æ„Ÿå…´è¶£ï¼Œå› æ­¤å¯¹æŸä¸ªç”Ÿå‘½å‘¨æœŸç»„ä»¶æ³¨å†Œäº†ï¼Œå½“<code>start</code>äº‹ä»¶å‘ç”Ÿäº†ï¼Œè¿™ä¸ªç›‘å¬å™¨è·å¾—é€šçŸ¥ï¼Œå“åº”çš„ä»£ç è¢«æ‰§è¡Œã€‚å¯èƒ½ç”¨è¯­è¨€ä¸å¥½è§£é‡Šæ¸…æ¥šï¼Œçœ‹ä»£ç æ˜¯æœ€å¥½ç†è§£çš„äº†ã€‚<br>å•ç‹¬å»çœ‹çœ‹<code>StandardService</code>ä¸­çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•<code>start()</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Prepare for the beginning of active use of the public methods of this</div><div class="line">     * component.  This method should be called before any of the public</div><div class="line">     * methods of this component are utilized.  It should also send a</div><div class="line">     * LifecycleEvent of type START_EVENT to any registered listeners.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@exception</span> LifecycleException if this component detects a fatal error</div><div class="line">     *  that prevents this component from being used</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> LifecycleException </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// Validate and update our current component state</span></div><div class="line">        <span class="keyword">if</span> (started) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LifecycleException</div><div class="line">                (sm.getString(<span class="string">"standardService.start.started"</span>));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Notify our interested LifecycleListeners</span></div><div class="line">        lifecycle.fireLifecycleEvent(BEFORE_START_EVENT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        System.out.println</div><div class="line">            (sm.getString(<span class="string">"standardService.start.name"</span>, <span class="keyword">this</span>.name));</div><div class="line">        lifecycle.fireLifecycleEvent(START_EVENT, <span class="keyword">null</span>);</div><div class="line">        started = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Start our defined Container first</span></div><div class="line">        <span class="comment">// è°ƒç”¨å­ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•</span></div><div class="line">        <span class="keyword">if</span> (container != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (container) &#123;</div><div class="line">                <span class="keyword">if</span> (container <span class="keyword">instanceof</span> Lifecycle) &#123;</div><div class="line">                    ((Lifecycle) container).start();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Start our defined Connectors second</span></div><div class="line">        <span class="keyword">synchronized</span> (connectors) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; connectors.length; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (connectors[i] <span class="keyword">instanceof</span> Lifecycle)</div><div class="line">                    ((Lifecycle) connectors[i]).start();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Notify our interested LifecycleListeners</span></div><div class="line">        lifecycle.fireLifecycleEvent(AFTER_START_EVENT, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>æˆ‘æƒ³è¿™æ®µä»£ç ä¸­æœ€æƒ¹äººæ³¨æ„çš„åœ°æ–¹è‚¯å®šæ˜¯<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">lifecycle.fireLifecycleEvent(BEFORE_START_EVENT, <span class="keyword">null</span>);</div><div class="line">lifecycle.fireLifecycleEvent(START_EVENT, <span class="keyword">null</span>);</div><div class="line">lifecycle.fireLifecycleEvent(AFTER_START_EVENT, <span class="keyword">null</span>);</div></pre></td></tr></table></figure></p>
<p>æˆ‘è§‰å¾—å…¶ä»–çš„éƒ½å¯ä»¥å¿½ç•¥ï¼Œä»…ä»…å…³å¿ƒè¿™ä¸‰è¡Œå°±å¤Ÿäº†ã€‚æ­£å¦‚<code>Lifecycle</code>æ¥å£ä¸­å¸¸é‡æè¿°çš„ä¸€æ ·ï¼Œ<code>start</code>å¯¹åº”å¼€å§‹å‰ï¼Œå¼€å§‹å’Œå¼€å§‹åä¸‰ä¸ªçŠ¶æ€ã€‚å› æ­¤åœ¨è°ƒç”¨<code>start</code>çš„æ—¶å€™å°†è¿™ä¸ªä¸‰ä¸ªäº‹ä»¶é¡ºåºè§¦å‘ï¼Œé‚£ä¹ˆè°å»æ¥æ”¶è¿™å‡ ä¸ªäº‹ä»¶å‘¢ï¼Ÿè¿™å°±å¾—é—®é—®æˆ‘ä»¬ä¹‹å‰è¯´çš„ç›‘å¬å™¨äº†ã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªç»†èŠ‚å€¼å¾—æ³¨æ„ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> LifecycleSupport lifecycle = <span class="keyword">new</span> LifecycleSupport(<span class="keyword">this</span>);</div></pre></td></tr></table></figure></p>
<p>è¿™ä¹Ÿæ˜¯ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„ç›´æ¥è°ƒç”¨è€…ã€‚ç”±æ­¤å¼•å‡ºä¸€ä¸ªé—®é¢˜ï¼šæˆ‘ç›´æ¥å®ç°äº†<code>Lifecycle</code>æ¥å£ä¸å°±å®Œäº†ï¼Œé‡Œé¢çš„æ–¹æ³•è‡ªå·±å®ç°å°±è¡Œäº†ï¼Œå¹²å˜›è¿˜å¾—å¼•å…¥è¿™ä¸ªä¸œè¥¿å†å»è°ƒç”¨ä¸€æ¬¡ï¼Ÿè¿™ä¸ªå°±ä½“ç°ä¸€ç§è®¾è®¡æ€æƒ³ï¼šè®¾æƒ³ä¸€ä¸‹ï¼ŒåŠ å…¥æ¯ä¸ªç»„ä»¶éƒ½è‡ªå·±å»å®ç°ä¸€æ¬¡ï¼Œä½†æ˜¯å¾ˆå¤šä»£ç éƒ½æ˜¯ç±»ä¼¼çš„ï¼Œè¿™æ ·å°±é€ æˆäº†å¾ˆå¤šå†—ä½™ä»£ç ï¼Œç»´æŠ¤èµ·æ¥å¾ˆè¦å‘½ã€‚ä¸ä¿¡å¯ä»¥çœ‹çœ‹è¿™ä¸ª<code>LifecycleSupport</code>å…·ä½“å®ç°ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleSupport</span> </span>&#123;</div><div class="line">    <span class="comment">// ----------------------------------------------------------- Constructors</span></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Construct a new LifecycleSupport object associated with the specified</div><div class="line">     * Lifecycle component.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> lifecycle The Lifecycle component that will be the source</div><div class="line">     *  of events that we fire</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LifecycleSupport</span><span class="params">(Lifecycle lifecycle)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        <span class="keyword">this</span>.lifecycle = lifecycle;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ----------------------------------------------------- Instance Variables</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The source component for lifecycle events that we will fire.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Lifecycle lifecycle = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The set of registered LifecycleListeners for event notifications.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> LifecycleListener listeners[] = <span class="keyword">new</span> LifecycleListener[<span class="number">0</span>];</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// --------------------------------------------------------- Public Methods</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Add a lifecycle event listener to this component.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> listener The listener to add</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</div><div class="line"></div><div class="line">      <span class="keyword">synchronized</span> (listeners) &#123;</div><div class="line">          LifecycleListener results[] =</div><div class="line">            <span class="keyword">new</span> LifecycleListener[listeners.length + <span class="number">1</span>];</div><div class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; listeners.length; i++)</div><div class="line">              results[i] = listeners[i];</div><div class="line">          results[listeners.length] = listener;</div><div class="line">          listeners = results;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Get the lifecycle listeners associated with this lifecycle. If this </div><div class="line">     * Lifecycle has no listeners registered, a zero-length array is returned.</div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> LifecycleListener[] findLifecycleListeners() &#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> listeners;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Notify all lifecycle event listeners that a particular event has</div><div class="line">     * occurred for this Container.  The default implementation performs</div><div class="line">     * this notification synchronously using the calling thread.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> type Event type</div><div class="line">     * <span class="doctag">@param</span> data Event data</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireLifecycleEvent</span><span class="params">(String type, Object data)</span> </span>&#123;</div><div class="line"></div><div class="line">        LifecycleEvent event = <span class="keyword">new</span> LifecycleEvent(lifecycle, type, data);</div><div class="line">        LifecycleListener interested[] = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">synchronized</span> (listeners) &#123;</div><div class="line">            interested = (LifecycleListener[]) listeners.clone();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interested.length; i++)</div><div class="line">            interested[i].lifecycleEvent(event);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Remove a lifecycle event listener from this component.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> listener The listener to remove</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span> (listeners) &#123;</div><div class="line">            <span class="keyword">int</span> n = -<span class="number">1</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (listeners[i] == listener) &#123;</div><div class="line">                    n = i;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (n &lt; <span class="number">0</span>)</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            LifecycleListener results[] =</div><div class="line">              <span class="keyword">new</span> LifecycleListener[listeners.length - <span class="number">1</span>];</div><div class="line">            <span class="keyword">int</span> j = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (i != n)</div><div class="line">                    results[j++] = listeners[i];</div><div class="line">            &#125;</div><div class="line">            listeners = results;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¹Ÿå°±æ˜¯å¯¹<code>Lifecycle</code>çš„éƒ¨åˆ†æ–¹æ³•çš„å®ç°ï¼Œè¿™äº›æ–¹æ³•ä¸€èˆ¬æ˜¯ä¸ä¼šå˜åŒ–çš„ï¼Œå› æ­¤å•ç‹¬æŠ½ç¦»å‡ºæ¥ï¼Œå‡å¦‚ä»¥åæƒ³æ”¹åŠ¨ä¹Ÿä»…ä»…å¯¹è¿™ä¸ªç±»å»æ”¹ï¼Œè€Œä¸æ˜¯é’ˆå¯¹æ¯ä¸ªç”Ÿå‘½å‘¨æœŸç»„ä»¶å»æ”¹ã€‚</p>
<p>æˆ‘è§‰å¾—æœ‰ä¸ªåœ°æ–¹å¾ˆå€¼å¾—å€Ÿé‰´ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addLifecycleListener</span><span class="params">(LifecycleListener listener)</span> </span>&#123;</div><div class="line">      <span class="keyword">synchronized</span> (listeners) &#123;</div><div class="line">          LifecycleListener results[] =</div><div class="line">            <span class="keyword">new</span> LifecycleListener[listeners.length + <span class="number">1</span>];</div><div class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; listeners.length; i++)</div><div class="line">              results[i] = listeners[i];</div><div class="line">          results[listeners.length] = listener;</div><div class="line">          listeners = results;</div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å‡å¦‚æ˜¯æˆ‘å»å†™è¿™ä¸ªæ¥å£æˆ‘é¦–å…ˆä¸ä¼šæƒ³åˆ°ç”¨æ•°ç»„å»è£…<code>listeners</code>ï¼Œæˆ‘å¯èƒ½ä¼šä½¿ç”¨ä¸€ä¸ª<code>list</code>å»å­˜ï¼Œè¿™æ ·è¿›è¡Œæ·»åŠ çš„æ—¶å€™ä¸ä¼šæœ‰è¿™ä¹ˆå¤æ‚çš„æ“ä½œã€‚ä½†æ˜¯è¿™é‡Œä½¿ç”¨çš„æ˜¯æ•°ç»„æ¥å¤„ç†ï¼Œå´è¾¾åˆ°äº†åŒæ ·çš„æ•ˆæœã€‚ä¸å¾—ä¸ä½©æœåº•å±‚ä»£ç å¯¹è¿™äº›ç»†èŠ‚çš„è€ƒè™‘ã€‚</p>
<p>ç»§ç»­æ¥ç€é‚£ä¸‰è¡Œä»£ç ï¼Œçœ‹çœ‹å…·ä½“å®ç°ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireLifecycleEvent</span><span class="params">(String type, Object data)</span> </span>&#123;</div><div class="line"></div><div class="line">        LifecycleEvent event = <span class="keyword">new</span> LifecycleEvent(lifecycle, type, data);</div><div class="line">        LifecycleListener interested[] = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">synchronized</span> (listeners) &#123;</div><div class="line">            interested = (LifecycleListener[]) listeners.clone();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; interested.length; i++)</div><div class="line">            interested[i].lifecycleEvent(event);</div><div class="line"></div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>ä¸€çœ¼å¾€å»ï¼Œæ— éå°±æ˜¯è§¦å‘ç›‘å¬å™¨æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œè€Œä¸”æ˜¯æŒ¨ä¸ªæ¥ã€‚è¿™é‡Œæœ‰ä¸€ä¸ª<code>LifecycleEvent</code>ç±»ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LifecycleEvent</span></span></div><div class="line">    <span class="keyword">extends</span> <span class="title">EventObject</span> &#123;</div><div class="line">    <span class="comment">// ----------------------------------------------------------- Constructors</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Construct a new LifecycleEvent with the specified parameters.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> lifecycle Component on which this event occurred</div><div class="line">     * <span class="doctag">@param</span> type Event type (required)</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LifecycleEvent</span><span class="params">(Lifecycle lifecycle, String type)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">this</span>(lifecycle, type, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Construct a new LifecycleEvent with the specified parameters.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> lifecycle Component on which this event occurred</div><div class="line">     * <span class="doctag">@param</span> type Event type (required)</div><div class="line">     * <span class="doctag">@param</span> data Event data (if any)</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LifecycleEvent</span><span class="params">(Lifecycle lifecycle, String type, Object data)</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">super</span>(lifecycle);</div><div class="line">        <span class="keyword">this</span>.lifecycle = lifecycle;</div><div class="line">        <span class="keyword">this</span>.type = type;</div><div class="line">        <span class="keyword">this</span>.data = data;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ----------------------------------------------------- Instance Variables</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The event data associated with this event.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Object data = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The Lifecycle on which this event occurred.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> Lifecycle lifecycle = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * The event type this instance represents.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> String type = <span class="keyword">null</span>;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// ------------------------------------------------------------- Properties</span></div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Return the event data of this event.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getData</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.data);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Return the Lifecycle on which this event occurred.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Lifecycle <span class="title">getLifecycle</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.lifecycle);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Return the event type of this event.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.type);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªç±»ç»§æ‰¿äº†JDKä¸­çš„<code>EventObject</code>ï¼Œä¸ç”¨å»ç®¡å®ƒã€‚ä»æ„é€ å™¨ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªå‚æ•°ï¼šç”Ÿå‘½å‘¨æœŸå¯¹è±¡ï¼Œç±»å‹ä»¥åŠæ•°æ®ã€‚æœ‰äº†è¿™å‡ ä¸ªå±æ€§ï¼Œè¿™ä¸ªç”Ÿå‘½å‘¨æœŸäº‹ä»¶å¯¹è±¡å¯ä»¥æ”¾å¿ƒå»ç©äº†ã€‚å…·ä½“æ€ä¹ˆå»ç©å‘¢ï¼Œå’Œè°ä¸€èµ·ç©å‘¢ï¼Ÿè¿™ä¸ªå¾—é—®é—®ç›‘å¬å™¨äº†ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LifecycleListener</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Acknowledge the occurrence of the specified event.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> event LifecycleEvent that has occurred</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨<code>fireLifecycleEvent(String type, Object data)</code>æ–¹æ³•ä¸­æœ‰è¿™ä¹ˆä¸ªè°ƒç”¨ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">LifecycleListener interested[] = <span class="keyword">null</span>;</div><div class="line">...</div><div class="line">interested[i].lifecycleEvent(event);</div></pre></td></tr></table></figure></p>
<p>äº‹ä»¶ä¼ ç»™ç›‘å¬å™¨äº†ï¼<br>ç›‘å¬å™¨æ‹¿åˆ°ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œç”±äºäº‹ä»¶ä¸­çš„æ•°æ®å…¨éƒ½æœ‰ï¼šå½“å‰ç”Ÿå‘½å‘¨æœŸå¯¹è±¡ã€ç”Ÿå‘½å‘¨æœŸç±»å‹åŠæºå¸¦çš„æ•°æ®ï¼Œå› æ­¤ç›‘å¬å™¨å¯ä»¥æƒ³æ€ä¹ˆç©å°±æ€ä¹ˆç©ã€‚æ¼”ç¤ºä¸€ä¸‹æ€ä¹ˆç©ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleContextConfig</span> <span class="keyword">implements</span> <span class="title">LifecycleListener</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (Lifecycle.START_EVENT.equals(event.getType())) &#123;</div><div class="line">    	System.out.println(<span class="string">"==============START_EVENT================="</span>);</div><div class="line">      Context context = (Context) event.getLifecycle();</div><div class="line">      context.setConfigured(<span class="keyword">true</span>);</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (Lifecycle.BEFORE_START_EVENT.equals(event.getType())) &#123;</div><div class="line">    	System.out.println(<span class="string">"==============BEFORE_START_EVENT================="</span>);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(Lifecycle.BEFORE_STOP_EVENT.equals(event.getType())) &#123;</div><div class="line">    	System.out.println(<span class="string">"==============BEFORE_STOP_EVENT=================="</span>);</div><div class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(Lifecycle.STOP_EVENT.equals(event.getType())) &#123;</div><div class="line">    	System.out.println(<span class="string">"==============STOP_EVENT=================="</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¯ä»¥è¯´æ˜¯ç®€å•åˆ°æ— èŠã€‚<br>å¿˜äº†ä¸€ç‚¹ï¼Œäº‹ä»¶ç›‘å¬å¾—æ³¨å†Œä¸Šå»ï¼Œä¸ç„¶äº‹ä»¶å‘ç”Ÿäº†æ²¡æ³•å“åº”ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LifecycleListener listener = <span class="keyword">new</span> ContextConfig();</div><div class="line">((Lifecycle) context).addLifecycleListener(listener);</div></pre></td></tr></table></figure></p>
<p>å¤šæ·»åŠ å‡ ä¸ªä¹Ÿæ— å¦¨ï¼Œåªè¦ä½ æƒ³ã€‚<br>Tomcatä¸­ç»™æˆ‘å°è±¡æœ€æ·±åˆ»çš„ä¹Ÿå°±æ˜¯Lifecycleè§‚å¯Ÿè€…æ¨¡å¼ã€‚ç›¸æ¯”å»æ‰¾ä¸€äº›è®¾è®¡æ¨¡å¼çš„æ —å­å»å­¦ä¹ ï¼Œæˆ‘è§‰å¾—é˜…è¯»ä¼˜ç§€çš„æºç è¦ç†è§£åœ°æ›´é€å½»ä¸€äº›ã€‚é™¤äº†è§‚å¯Ÿè€…æ¨¡å¼è¿˜æœ‰å…¶ä»–çš„è®¾è®¡æ€æƒ³ä¹Ÿå€¼å¾—å­¦ä¹ ï¼Œæ…¢æ…¢æ€»ç»“ï¼Œä¸æ–­æ›´æ–°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™æœ¬ä¹¦çœ‹äº†è¿™ä¹ˆä¹…ï¼Œå·®ä¸å¤šå¯ä»¥ç®—æ˜¯çœ‹å®Œäº†ã€‚å‡†ç¡®æ¥è®²æ˜¯è¿˜å‰©ä¸¤ä¸ªç« èŠ‚æ²¡æœ‰è¯»å®Œã€‚æœ€åé‚£ä¸¤ä¸ªç« èŠ‚çš„çš„ç¡®ç¡®æ˜¯å¾ˆä¸å¾—åŠ²ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯è‡ªå·±å¼€å§‹æµ®èºèµ·æ¥äº†ã€‚æˆ‘çœ‹çš„æ˜¯ä¸­æ–‡ç¿»è¯‘çš„ï¼Œå¯æ°”çš„æ˜¯ä¸­æ–‡ç¿»è¯‘å¾ˆå¤šé”™åˆ«å­—ä¸è¯´ï¼Œå±…ç„¶æœ‰äº›åœ°æ–¹æ ¹æœ¬å°±æ²¡æœ‰ç¿»è¯‘åˆ°ï¼Œâ€œç¼ºæ–¤å°‘ä¸¤â€å¾ˆå¯æ°”ã€‚ç„¶ååˆæ‰¾åŸç‰ˆå¯¹ç…§ç€çœ‹ï¼Œé¿å…è¢«â€œè¯¯å…¥æ­§é€”â€ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Tomcat ç¬”è®°" scheme="http://www.wei-dong.top/categories/Tomcat-%E7%AC%94%E8%AE%B0/"/>
    
    
      <category term="Tomcat" scheme="http://www.wei-dong.top/tags/Tomcat/"/>
    
      <category term="è¯»ä¹¦ç¬”è®°" scheme="http://www.wei-dong.top/tags/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
  </entry>
  
  <entry>
    <title>Securing Web Applications with Apache Shiro[è¯‘]</title>
    <link href="http://www.wei-dong.top/2017/10/26/Securing%20Web%20Applications%20with%20Apache%20Shiro%5B%E8%AF%91%5D/"/>
    <id>http://www.wei-dong.top/2017/10/26/Securing Web Applications with Apache Shiro[è¯‘]/</id>
    <published>2017-10-26T12:41:23.000Z</published>
    <updated>2017-10-26T12:49:08.000Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« æ˜¯ä»‹ç»ä½¿ç”¨Shiroä¸€æ­¥ä¸€æ­¥ä¿æŠ¤ä½ çš„webåº”ç”¨çš„æ•™ç¨‹ã€‚å®ƒåŒ…å«äº†Shiroçš„çŸ¥è¯†ï¼Œä»¥åŠå’Œæœ€è¿‘ä¸¤ç¯‡æ–‡ç« å¾ˆç›¸ä¼¼ï¼š</p>
<ul>
<li><a href="https://www.infoq.com/articles/apache-shiro" target="_blank" rel="external">Application Security with Apache Shiro</a></li>
<li><a href="http://shiro.apache.org/10-minute-tutorial.html" target="_blank" rel="external">Apache Shiro 10 Minute Tutorial</a><br>è¿™ä¸ªå…¥é—¨æ•™ç¨‹ä¼šèŠ±è´¹å¤§çº¦45åˆ†é’Ÿåˆ°ä¸€ä¸ªå°æ—¶ã€‚å½“ä½ è¯»å®Œåï¼Œä½ å°±ä¼šçŸ¥é“Shiroåœ¨webåº”ç”¨ä¸­æ€ä¹ˆå·¥ä½œäº†çš„ã€‚<a id="more"></a>
<h3 id="ç›®å½•"><a href="#ç›®å½•" class="headerlink" title="ç›®å½•"></a>ç›®å½•</h3></li>
<li>æ¦‚æ‹¬</li>
<li>è®¾ç½®</li>
<li>ç¬¬ä¸€æ­¥ï¼šå¼€å¯Shiro</li>
<li>ç¬¬äºŒæ­¥ï¼šè¿æ¥åˆ°ç”¨æˆ·å­˜å‚¨</li>
<li>ç¬¬ä¸‰æ­¥ï¼šå¼€å¯ç™»å½•å’Œç™»å‡º</li>
<li>ç¬¬å››æ­¥ï¼šæ”¹å˜ç”¨æˆ·æŒ‡å®šUI</li>
<li>ç¬¬äº”æ­¥ï¼šä»…ä»…å…è®¸è®¤è¯ç”¨æˆ·è®¿é—®</li>
<li>ç¬¬å…­æ­¥ï¼šåŸºäºè§’è‰²è®¿é—®æ§åˆ¶</li>
<li>ç¬¬ä¸ƒæ­¥ï¼šåŸºäºæƒé™è®¿é—®æ§åˆ¶</li>
</ul>
<h3 id="æ¦‚æ‹¬"><a href="#æ¦‚æ‹¬" class="headerlink" title="æ¦‚æ‹¬"></a>æ¦‚æ‹¬</h3><p>è™½ç„¶Shiroè®¾è®¡çš„æ ¸å¿ƒç›®æ ‡å¯ä»¥ç”¨äºä¿æŠ¤ä»»ä½•åŸºäºJVMçš„åº”ç”¨ï¼Œä¾‹å¦‚å‘½ä»¤è¡Œåº”ç”¨ï¼Œåå°æœåŠ¡ï¼Œç½‘é¡µåº”ç”¨ç­‰ã€‚è¿™ç¯‡æ–‡ç« ä¸“æ³¨æœ€å¸¸è§çš„åº”ç”¨ï¼šä¿æŠ¤è·‘åœ¨Servletå®¹å™¨ä¸Šçš„webåº”ç”¨ï¼Œä¾‹å¦‚Tomcaæˆ–è€…Jettyã€‚</p>
<h4 id="å…ˆå†³æ¡ä»¶"><a href="#å…ˆå†³æ¡ä»¶" class="headerlink" title="å…ˆå†³æ¡ä»¶"></a>å…ˆå†³æ¡ä»¶</h4><p>ä¸‹é¢çš„å·¥å…·æ˜¯è¦å®‰è£…åˆ°ä½ æœ¬åœ°å¼€å‘æœºå™¨ä¸Šçš„ï¼Œä»¥ä¾¿éµå¾ªæœ¬æ•™ç¨‹ã€‚</p>
<ul>
<li>Git (tested w/ 1.7)</li>
<li>Java SDK 7</li>
<li>Maven 3</li>
<li>ä½ è‡ªå·±å–œæ¬¢çš„ç¼–è¾‘å™¨ï¼ŒIDEAæˆ–è€…Eclipseéƒ½è¡Œï¼Œç”šè‡³æ–‡æœ¬ç¼–è¾‘å™¨ä¹Ÿè¡Œã€‚</li>
</ul>
<h4 id="æ•™ç¨‹æ ¼å¼"><a href="#æ•™ç¨‹æ ¼å¼" class="headerlink" title="æ•™ç¨‹æ ¼å¼"></a>æ•™ç¨‹æ ¼å¼</h4><p>è¿™æ˜¯ä¸€æ­¥æ¥ç€ä¸€æ­¥çš„æ•™ç¨‹ã€‚è¯¥æ•™ç¨‹å’Œæ‰€æœ‰æ­¥éª¤éƒ½åœ¨GITä»“åº“ä¸­å­˜ç€ã€‚å½“ä½ clone gitä»“åº“ï¼Œmasteråˆ†æ”¯å°±æ˜¯ä½ çš„èµ·ç‚¹ã€‚åœ¨è¿™ä¸ªæ•™ç¨‹ä¸­çš„æ¯ä¸ªæ­¥éª¤éƒ½æ˜¯å•ç‹¬çš„åˆ†æ”¯ã€‚ä½ å¯ä»¥é€šè¿‡æ£€å‡ºä½ æ­£åœ¨çœ‹çš„æ•™ç¨‹æ­¥éª¤çš„gitåˆ†æ”¯æ¥è¯»è¿™ä¸ªæ•™ç¨‹ï¼ˆå°±æ˜¯è¾¹çœ‹ä»£ç è¾¹è¯»è¿™ä¸ªæ•™ç¨‹çš„æ„æ€ï¼‰ã€‚</p>
<h4 id="åº”ç”¨"><a href="#åº”ç”¨" class="headerlink" title="åº”ç”¨"></a>åº”ç”¨</h4><p>æˆ‘ä»¬å°†æ„å»ºçš„Webåº”ç”¨ç¨‹åºæ˜¯ä¸€ä¸ªè¶…çº§webappï¼Œå¯ä»¥ä½œä¸ºä½ è‡ªå·±çš„åº”ç”¨ç¨‹åºçš„èµ·ç‚¹ã€‚å®ƒå°†æ¼”ç¤ºç”¨æˆ·ç™»å½•ï¼Œæ³¨é”€ï¼Œç”¨æˆ·ç‰¹å®šçš„æ¬¢è¿æ¶ˆæ¯ï¼Œå¯¹Webåº”ç”¨ç¨‹åºçš„æŸäº›éƒ¨åˆ†çš„è®¿é—®æ§åˆ¶ä»¥åŠä¸å¯æ’æ‹”å®‰å…¨æ•°æ®å­˜å‚¨çš„é›†æˆã€‚</p>
<p>æˆ‘ä»¬å°†é¦–å…ˆè®¾ç½®é¡¹ç›®ï¼ŒåŒ…æ‹¬æ„å»ºå·¥å…·å’Œå£°æ˜ä¾èµ–å…³ç³»ï¼Œä»¥åŠé…ç½®servlet web.xmlæ–‡ä»¶ä»¥å¯åŠ¨Webåº”ç”¨ç¨‹åºå’ŒShiroç¯å¢ƒã€‚</p>
<p>å®Œæˆè®¾ç½®åï¼Œæˆ‘ä»¬å°†åˆ†å±‚å•ç‹¬çš„åŠŸèƒ½ï¼ŒåŒ…æ‹¬ä¸å®‰å…¨æ•°æ®å­˜å‚¨é›†æˆï¼Œç„¶åå¯ç”¨ç”¨æˆ·ç™»å½•ï¼Œæ³¨é”€å’Œè®¿é—®æ§åˆ¶ã€‚</p>
<h3 id="è®¾ç½®"><a href="#è®¾ç½®" class="headerlink" title="è®¾ç½®"></a>è®¾ç½®</h3><p>æˆ‘ä»¬å·²ç»åœ¨gitä»“åº“ä¸­è®¾ç½®å®Œæˆäº†ï¼Œå› æ­¤ä½ ä¸å¿…æ‰‹åŠ¨å»è®¾ç½®ç›®å½•ç»“æ„åˆå§‹åŒ–æ–‡ä»¶ç­‰ã€‚</p>
<h4 id="1-Fork-the-tutorial-project"><a href="#1-Fork-the-tutorial-project" class="headerlink" title="1. Fork the tutorial project"></a>1. Fork the tutorial project</h4><p>åœ¨githubä¸­è®¿é—®<a href="https://github.com/lhazlewood/apache-shiro-tutorial-webapp" target="_blank" rel="external">è¿™ä¸ª</a>ï¼Œç‚¹å‡»<code>fork</code>æŒ‰é’®ã€‚</p>
<h4 id="2-Clone-your-tutorial-repository"><a href="#2-Clone-your-tutorial-repository" class="headerlink" title="2. Clone your tutorial repository"></a>2. Clone your tutorial repository</h4><p>ç°åœ¨ä½ æŠŠé‚£ä¸ªä»“åº“forkåˆ°ä½ è‡ªå·±çš„è´¦å·ä¸­å»äº†ï¼Œcloneåˆ°ä½ è‡ªå·±çš„æœºå™¨ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">clone</span> git@github.com:<span class="variable">$YOUR_GITHUB_USERNAME</span>/apache-shiro-tutorial-webapp.git</div></pre></td></tr></table></figure></p>
<h4 id="3-Review-project-structure"><a href="#3-Review-project-structure" class="headerlink" title="3. Review project structure"></a>3. Review project structure</h4><p>å®Œæˆcloneåï¼Œä½ å½“å‰çš„<code>master</code>åˆ†æ”¯å°†æœ‰ä¸‹é¢çš„ç»“æ„ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">apache-shiro-tutorial-webapp/</div><div class="line">     |-- src/</div><div class="line">     |  |-- main/</div><div class="line">     |    |-- resources/</div><div class="line">     |      |-- logback.xml</div><div class="line">     |    |-- webapp/</div><div class="line">     |      |-- WEB-INF/</div><div class="line">     |        |-- web.xml</div><div class="line">     |      |-- home.jsp</div><div class="line">     |      |-- include.jsp</div><div class="line">     |      |-- index.jsp</div><div class="line">     |-- .gitignore</div><div class="line">     |-- .travis.yml</div><div class="line">     |-- LICENSE</div><div class="line">     |-- README.md</div><div class="line">     |-- pom.xml</div></pre></td></tr></table></figure></p>
<p>è¿™äº›æ˜¯æ¯ä¸ªæ–‡ä»¶è¡¨ç¤ºçš„å«ä¹‰ï¼š</p>
<ul>
<li>pom.xml ä¸è§£é‡Š</li>
<li>README.md æè¿°æ–‡ä»¶</li>
<li>LICENSE è¯ä¹¦</li>
<li>.travis.yml CIçš„é…ç½®æ–‡ä»¶ï¼Œå‡å¦‚ä½ æƒ³æŒç»­é›†æˆ</li>
<li>.gitignore å¿½ç•¥æ–‡ä»¶ï¼ŒåŒ…å«åç¼€ã€‚ä½ ä¸æƒ³åŠ å…¥ç‰ˆæœ¬æ§åˆ¶çš„éƒ½èƒ½å†™è¿™é‡Œ</li>
<li>src/main/resources/logback.xml ç®€å•çš„Logbacké…ç½®æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©SELF4Jä½œä¸ºæ—¥å¿—APIï¼ŒLogbackä½œä¸ºå®ç°ã€‚è¿™ä¸ªæ¯”Log4Jå’ŒJULç®€å•ã€‚</li>
<li>src/main/webapp/WEB-INF/web.xml webé…ç½®æ–‡ä»¶</li>
<li>src/main/webapp/include.jsp  å…¬ç”¨çš„JSPæ–‡ä»¶ï¼Œç”¨äºå¯¼å…¥å’Œå£°æ˜ã€‚æ–¹ä¾¿åœ¨ä¸€ä¸ªåœ°æ–¹ç®¡ç†ã€‚</li>
<li>src/main/webapp/home.jsp é»˜è®¤çš„homepage</li>
<li>src/main/webapp/index.jsp é»˜è®¤ä¸»é¡µï¼Œä»…ä»…æ˜¯å°†è¯·æ±‚æŒ‡å‘home.jsp</li>
</ul>
<h4 id="4-Run-the-webapp"><a href="#4-Run-the-webapp" class="headerlink" title="4. Run the webapp"></a>4. Run the webapp</h4><p>ç°åœ¨ä½ å°†å·¥ç¨‹å…‹éš†åˆ°æœ¬åœ°äº†ï¼Œä½ å¯ä»¥é€šè¿‡ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤æ¥è·‘è¿™ä¸ªwebåº”ç”¨ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mvn jetty:run</div></pre></td></tr></table></figure></p>
<p>ç„¶åæ‰“å¼€ä½ çš„æµè§ˆå™¨ï¼Œè¾“å…¥ localhost:8080 ä½ å¯ä»¥çœ‹åˆ°ä¸»é¡µæ˜¾ç¤ºçš„Helloï¼ŒWorldï¼æŒ‰ctl-cåœæ­¢webã€‚</p>
<h3 id="Step-1-Enable-Shiro"><a href="#Step-1-Enable-Shiro" class="headerlink" title="Step 1: Enable Shiro"></a>Step 1: Enable Shiro</h3><p>æˆ‘ä»¬åˆå§‹åŒ–ä»“åº“masteråˆ†æ”¯ä»…ä»…æ˜¯ä¸€ä¸ªç®€å•é€šç”¨çš„å¯ç”¨äºä»»ä½•åº”ç”¨çš„æ¨¡æ¿çš„webåº”ç”¨ã€‚Letâ€™s add the bare minimum to enable Shiro in the web app next(è¿™å¥è¯ä¸çŸ¥é“æ€ä¹ˆç¿»è¯‘)ã€‚</p>
<p>æ‰§è¡Œä¸‹é¢çš„gitæ£€å‡ºå‘½ä»¤åŠ è½½step1çš„åˆ†æ”¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step1</div></pre></td></tr></table></figure></p>
<p>æ£€å‡ºåä½ ä¼šå‘ç°ä¸¤ä¸ªå˜åŒ–ï¼š</p>
<ol>
<li>å¤šäº†<code>src/main/webapp/WEB-INF/shiro.ini</code>è¿™ä¸ªæ–‡ä»¶</li>
<li><code>src/main/webapp/WEB-INF/web.xml</code>è¢«æ”¹äº†</li>
</ol>
<h4 id="æ·»åŠ shiro-iniæ–‡ä»¶"><a href="#æ·»åŠ shiro-iniæ–‡ä»¶" class="headerlink" title="æ·»åŠ shiro.iniæ–‡ä»¶"></a>æ·»åŠ shiro.iniæ–‡ä»¶</h4><p>åœ¨webåº”ç”¨ä¸­æ²¹å¾ˆå¤šç§æ–¹å¼é…ç½®Shiroï¼Œè¿™å–å†³äºä½ ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆwebæ¡†æ¶ã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥é€šè¿‡Springã€Guiceã€Tapestryç­‰é…ç½®Shiroã€‚</p>
<p>ç°åœ¨ä¸ºäº†æ–¹ä¾¿ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨Shiroé»˜è®¤çš„é…ç½®,<a href="http://shiro.apache.org/configuration.html" target="_blank" rel="external">åŸºäºiniçš„é…ç½®</a>ã€‚</p>
<p>å¦‚æœä½ æ£€å‡ºäº†step1çš„åˆ†æ”¯ï¼Œä½ å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ–°çš„é…ç½®æ–‡ä»¶<code>src/main/webapp/WEB-INF/shiro.ini</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[main]</div><div class="line"></div><div class="line"># Let&apos;s use some in-memory caching to reduce the number of runtime lookups against a remote user store.</div><div class="line"># A real application might want to use a more robust caching solution (e.g. ehcache or a</div><div class="line"># distributed cache).  When using such caches, be aware of your cache TTL settings: too high</div><div class="line"># a TTL and the cache won&apos;t reflect any potential changes in Stormpath fast enough.  Too low</div><div class="line"># and the cache could evict too often, reducing performance.</div><div class="line">cacheManager = org.apache.shiro.cache.MemoryConstrainedCacheManager</div><div class="line">securityManager.cacheManager = $cacheManager</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªinié…ç½®æ–‡ä»¶åŒ…å«ä¸€ä¸ª<code>[main]</code>çš„æœ€å°é…ç½®ã€‚</p>
<ul>
<li>å®šä¹‰äº†ä¸€ä¸ª<code>cacheManager</code>å®ä¾‹ã€‚ç¼“å­˜åœ¨Shiroæ¶æ„ä¸­æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„éƒ¨åˆ†ã€‚å®ƒå‡å°‘äº†é‡å¤çš„æ•°æ®äº¤äº’ã€‚è¿™ä¸ªä¾‹å­ä½¿ç”¨<code>MemoryConstrainedCacheManager</code>ï¼Œä»…ä»…å¯¹å•ä¸ªJVMåº”ç”¨å¾ˆæ£’ã€‚å¦‚æœä½ çš„åº”ç”¨éƒ¨ç½²åœ¨å¤šä¸ªä¸»æœºï¼Œä½ æœ€å¥½ä½¿ç”¨é›†ç¾¤çš„CacheManager å®ç°ã€‚</li>
<li>å®ƒåœ¨Shiro securityManagerä¸Šé…ç½®æ–°çš„cacheManagerå®ä¾‹ã€‚Shiro SecurityManagerå®ä¾‹å§‹ç»ˆå­˜åœ¨ï¼Œå› æ­¤ä¸éœ€è¦æ˜ç¡®å®šä¹‰ã€‚</li>
</ul>
<h4 id="åœ¨web-xmlä¸­å¼€å¯Shiro"><a href="#åœ¨web-xmlä¸­å¼€å¯Shiro" class="headerlink" title="åœ¨web.xmlä¸­å¼€å¯Shiro"></a>åœ¨web.xmlä¸­å¼€å¯Shiro</h4><p>è™½ç„¶æˆ‘ä»¬æœ‰shiro.inié…ç½®æ–‡ä»¶ï¼Œä½†æ˜¯æˆ‘ä»¬ç¡®å®éœ€è¦æŠŠå®ƒåŠ è½½è¿›å»ç„¶åå¼€å¯Shiroç¯å¢ƒè®©webåº”ç”¨èƒ½å¤Ÿä½¿ç”¨å®ƒã€‚</p>
<p>æˆ‘ä»¬åœ¨<code>src/main/webapp/WEB-INF/web.xml</code>é…ç½®æ–‡ä»¶ä¸­æ·»åŠ è¿™äº›ä¸œè¥¿ï¼š<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.apache.shiro.web.env.EnvironmentLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ShiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.shiro.web.servlet.ShiroFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ShiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>REQUEST<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>FORWARD<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>INCLUDE<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>&lt;listener&gt;</code>å£°æ˜å®šä¹‰äº†ä¸€ä¸ª<code>ServletContextListener</code>ç”¨äºåœ¨webç”¨äºå¯åŠ¨çš„æ—¶å€™åˆ›å»ºä¸€ä¸ªShiroç¯å¢ƒã€‚é»˜è®¤è¿™ä¸ªlistenerä¼šå»è‡ªåŠ¨æ‰¾<code>WEB-INF/shiro.ini</code>é…ç½®æ–‡ä»¶ã€‚</li>
<li><code>&lt;filter&gt;</code>å®šä¹‰äº†ä¸€ä¸ªä¸»è¦çš„<code>ShiroFilter</code>ã€‚è¿™ä¸ªè¿‡æ»¤å™¨ä¼šå»è¿‡æ»¤æ‰€æœ‰çš„è¯·æ±‚ï¼Œè¿™æ ·Shiroèƒ½å¤Ÿåœ¨å…è®¸è¯·æ±‚åˆ°è¾¾åº”ç”¨ç¨‹åºä¹‹å‰æ‰§è¡Œå¿…è¦çš„èº«ä»½å’Œè®¿é—®æ§åˆ¶æ“ä½œã€‚</li>
</ul>
<h4 id="è·‘èµ·æ¥"><a href="#è·‘èµ·æ¥" class="headerlink" title="è·‘èµ·æ¥"></a>è·‘èµ·æ¥</h4><p>æ‹‰å»äº†åˆ†æ”¯åï¼Œç»§ç»­è·‘èµ·æ¥ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mvn jetty:run</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªæ—¶å€™ï¼Œä½ ä¼šçœ‹åˆ°ä¸‹é¢ç†Ÿæ‚‰çš„è¾“å‡ºï¼Œè¿™è¡¨ç¤ºShiroç¡®å®åœ¨ä½ çš„webåº”ç”¨ä¸­è·‘èµ·æ¥äº†ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">16:04:19.807 [main] INFO  o.a.shiro.web.env.EnvironmentLoader - Starting Shiro environment initialization.</div><div class="line">16:04:19.904 [main] INFO  o.a.shiro.web.env.EnvironmentLoader - Shiro environment initialized in 95 ms.</div></pre></td></tr></table></figure></p>
<h3 id="Step-2-Connect-to-a-User-Store"><a href="#Step-2-Connect-to-a-User-Store" class="headerlink" title="Step 2: Connect to a User Store"></a>Step 2: Connect to a User Store</h3><p>æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æ£€å‡ºstep2çš„ä»£ç ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step2</div></pre></td></tr></table></figure></p>
<p>ç°åœ¨æˆ‘ä»¬å°†Shiroé›†æˆå¹¶è¿è¡Œåœ¨webappä¸­.ä½†æ˜¯æˆ‘ä»¬è¿˜æ²¡æœ‰å‘Šè¯‰Shiroè¦åšä»€ä¹ˆäº‹æƒ…ã€‚</p>
<p>åœ¨æˆ‘ä»¬ç™»å½•ï¼Œé€€å‡ºæˆ–æ‰§è¡ŒåŸºäºè§’è‰²æˆ–æƒé™çš„è®¿é—®æ§åˆ¶æˆ–ä»»ä½•å…¶ä»–å®‰å…¨ç›¸å…³ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç”¨æˆ·ï¼</p>
<p>æˆ‘ä»¬éœ€è¦é…ç½®Shiroæ¥è®¿é—®æŸç§ç±»å‹çš„ç”¨æˆ·å­˜å‚¨ï¼Œè¿™æ ·å®ƒå¯ä»¥æŸ¥æ‰¾ç”¨æˆ·åšç™»å½•æ“ä½œæˆ–è€…æ£€æŸ¥è§’è‰²ç­‰ç­‰ã€‚æœ‰è®¸å¤šç±»å‹çš„ç”¨æˆ·å­˜å‚¨ï¼Œä»»ä½•åº”ç”¨ç¨‹åºå¯èƒ½éœ€è¦è®¿é—®ï¼šä¹Ÿè®¸ä½ å°†ç”¨æˆ·å­˜åœ¨MySqlæ•°æ®åº“ä¸­ï¼Œæˆ–è€…MongoDBï¼Œæˆ–è€…LDAPï¼Œæˆ–è€…Active Directoryï¼Œæˆ–è€…ç®€å•çš„æ–‡ä»¶ä¸­ã€‚</p>
<p>Shiroå°†è¿™å«åš<code>Realm</code>.æ¥è‡ªShiroçš„æ–‡æ¡£ï¼š</p>
<blockquote>
<p>Realms act as the â€˜bridgeâ€™ or â€˜connectorâ€™ between Shiro and your applicationâ€™s security data. When it comes time to actually interact with security-related data like user accounts to perform authentication (login) and authorization (access control), Shiro looks up many of these things from one or more Realms configured for an application.<br>In this sense a Realm is essentially a security-specific DAO: it encapsulates connection details for data sources and makes the associated data available to Shiro as needed. When configuring Shiro, you must specify at least one Realm to use for authentication and/or authorization. The SecurityManager may be configured with multiple Realms, but at least one is required.<br>Shiro provides out-of-the-box Realms to connect to a number of security data sources (aka directories) such as LDAP, relational databases (JDBC), text configuration sources like INI and properties files, and more. You can plug-in your own Realm implementations to represent custom data sources if the default Realms do not meet your needs.</p>
</blockquote>
<p>å› æ­¤æˆ‘ä»¬éœ€è¦é…ç½®ä¸€ä¸ª<code>realm</code>è¿™æ ·æˆ‘ä»¬å°±èƒ½å¤Ÿå¾—åˆ°ç”¨æˆ·äº†ã€‚</p>
<h4 id="Set-up-Stormpath"><a href="#Set-up-Stormpath" class="headerlink" title="Set up Stormpath"></a>Set up Stormpath</h4><p>æœ¬ç€è¶Šç®€å•è¶Šå¥½çš„åŸåˆ™ï¼Œæ²¡æœ‰ä»‹ç»Shiroçš„å¤æ‚æ€§ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªæœ€ç®€å•çš„realmçš„å®ç°ï¼šStormpath realmã€‚</p>
<p>Stormpath æ˜¯ä¸€ä¸ªäº‘å¹³å°ä¸Šçš„ç”¨æˆ·ç®¡ç†æœåŠ¡ã€‚å¯¹å¼€å‘è€…å…è´¹ã€‚è¿™æ„å‘³ç€ä½¿ç”¨äº†Stormpathä»¥åï¼Œå¸®ä½ åšäº†åšä»¥ä¸‹çš„äº‹æƒ…ï¼š</p>
<ul>
<li>ä¸€ä¸ªç”¨äºç®¡ç†åº”ç”¨ï¼Œç›®å½•ã€è´¦æˆ·ã€å’Œç»„çš„æ¥å£ã€‚Shiroæ ¹æœ¬ä¸æä¾›è¿™äº›ä¸œè¥¿ï¼Œå› æ­¤å½“ä½ æµè§ˆè¿™ç¯‡æ•™ç¨‹çš„æ—¶å€™èƒ½å¤ŸèŠ‚çº¦æ—¶é—´ï¼Œè¿™æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚</li>
<li>ä¸€ä¸ªä¸ºç”¨æˆ·å­˜å‚¨å¯†ç çš„å®‰å…¨æœºåˆ¶ã€‚ä½ çš„åº”ç”¨ä¸å¿…æ‹…å¿ƒå¯†ç å®‰å…¨ï¼Œå¯†ç æ¯”è¾ƒæˆ–å­˜å‚¨å¯†ç ã€‚è™½ç„¶Shiroèƒ½åšè¿™äº›äº‹æƒ…ï¼Œä½†æ˜¯ä½ æœ‰å¿…è¦å»é…ç½®ä¸€ä¸‹ï¼Œç„¶åæ³¨æ„ä¸€ä¸‹åŠ å¯†çš„æ¦‚å¿µã€‚ Stormpathè‡ªåŠ¨çš„å¯¹å¯†ç è¿›è¡Œä¿æŠ¤ï¼Œå› æ­¤ä½ ä¸å¿…æ‹…å¿ƒè¿™äº›ä¸œè¥¿ã€‚</li>
<li>å®‰å…¨çš„å·¥ä½œæµï¼Œç±»ä¼¼äºé‚®ç®±éªŒè¯å¯†ç é‡ç½®ã€‚Shiroå¯¹æ­¤æ²¡æœ‰ä»»ä½•æ”¯æŒï¼Œå› ä¸ºè¿™æ˜¯åº”ç”¨ç¨‹åºæ¥æŠŠæ§çš„ã€‚</li>
<li>ä¸»æœºæ‰˜ç®¡æ€»æ˜¯åœ¨åŸºç¡€è®¾æ–½ä¸Šçš„ï¼ˆäº‘å¹³å°ï¼‰ï¼Œä½ æ²¡æœ‰å¿…è¦æ¥ç»´æŠ¤è¿™äº›ä¸œè¥¿ã€‚</li>
</ul>
<p>ä¸ºäº†æœ¬æ•™ç¨‹çš„ç›®çš„ï¼ŒStormpathæ¯”è®¾ç½®å•ç‹¬çš„RDBMSæœåŠ¡å™¨è¦ç®€å•å¾—å¤šï¼Œå¹¶ä¸”æ‹…å¿ƒSQLæˆ–å¯†ç åŠ å¯†é—®é¢˜ã€‚</p>
<p>å½“ç„¶ï¼ŒStormpathåªæ˜¯Shiroå¯ä»¥è¿›è¡Œæ²Ÿé€šçš„è®¸å¤šåç«¯æ•°æ®å­˜å‚¨ä¹‹ä¸€ã€‚ ç¨åå°†ä»‹ç»æ›´å¤æ‚çš„æ•°æ®å­˜å‚¨å’Œåº”ç”¨ç¨‹åºç‰¹å®šçš„é…ç½®ã€‚</p>
<h5 id="Sign-up-for-Stormpath"><a href="#Sign-up-for-Stormpath" class="headerlink" title="Sign up for Stormpath"></a>Sign up for Stormpath</h5><p>blablaâ€¦..</p>
<h5 id="Get-a-Stormpath-API-Key"><a href="#Get-a-Stormpath-API-Key" class="headerlink" title="Get a Stormpath API Key"></a>Get a Stormpath API Key</h5><p>Stormpath API Keyå¯¹äºStormpathæ¥è¯´æ˜¯å¿…é¡»çš„ã€‚å¯ä»¥è¿™æ ·è·å–ï¼š</p>
<ol>
<li>ç™»å½•åˆ°Stormpathä¸­ï¼ˆè¿™ä¸ªç½‘ç«™å…³äº†ï¼Œåˆå¹¶åˆ°oktaï¼‰ã€‚</li>
<li>é¡µé¢çš„å³è¾¹ï¼Œè®¿é—®API KEYï¼šManage API KEY</li>
<li><p>åœ¨è´¦å·è¯¦æƒ…é¡µé¢ï¼Œç‚¹å‡»Create API Keyã€‚æ­¤æ—¶ä¼šç”Ÿæˆä½ çš„API keyï¼Œç„¶åä¸‹è½½åˆ°ä½ çš„ç”µè„‘ã€‚å¦‚æœä½ æ‰“å¼€çœ‹çœ‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">apiKey.id = 144JVZINOF5EBNCMG9EXAMPLE</div><div class="line">apiKey.secret = lWxOiKqKPNwJmSldbiSkEbkNjgh2uRSNAb+AEXAMPLE</div></pre></td></tr></table></figure>
</li>
<li><p>ä¿å­˜åˆ°ä¸€ä¸ªå®‰å…¨çš„åœ°æ–¹ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$HOME/.stormpath/apiKey.properties</div></pre></td></tr></table></figure>
</li>
<li><p>å½“ç„¶ä¹Ÿå¯ä»¥æ”¹ä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶çš„æƒé™ã€‚ä¾‹å¦‚åœ¨*nixä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ chmod go-rwx <span class="variable">$HOME</span>/.stormpath/apiKey.properties</div><div class="line">$ chmod u-w <span class="variable">$HOME</span>/.stormpath/apiKey.properties</div></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="Retrieve-the-default-Stormpath-Application"><a href="#Retrieve-the-default-Stormpath-Application" class="headerlink" title="Retrieve the default Stormpath Application"></a>Retrieve the default Stormpath Application</h5><p>å½“ä½ ç™»å½•åˆ°Stormpathï¼Œè‡ªåŠ¨çš„åˆ›å»ºäº†ä¸€ä¸ªç©ºçš„åº”ç”¨ï¼Œåå­—å«åšï¼š<code>My Application</code></p>
<p>æˆ‘ä»¬å¿…é¡»ä½¿ç”¨Strompathæ³¨å†Œæˆ‘ä»¬çš„webåº”ç”¨ï¼Œè¿™æ ·å°±èƒ½ä½¿ç”¨Strompathæ¥ç®¡ç†æˆ‘ä»¬çš„ç”¨æˆ·å’Œå¯¹ç”¨æˆ·æˆæƒã€‚ä¸ºäº†ä½¿ç”¨æˆ‘çš„åº”ç”¨ç¨‹åºStormpathåº”ç”¨ç¨‹åºæ³¨å†Œæˆ‘ä»¬çš„Webåº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬éœ€è¦äº†è§£ä¸€äº›ä¿¡æ¯ã€‚å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Stormpath APIæ¥æ£€ç´¢è¿™äº›ä¿¡æ¯ã€‚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -i --user <span class="variable">$YOUR_API_KEY_ID</span>:<span class="variable">$YOUR_API_KEY_SECRET</span> \</div><div class="line"><span class="string">'https://api.stormpath.com/v1/tenants/current'</span></div></pre></td></tr></table></figure></p>
<p>ä½ èƒ½å¾—åˆ°è¿™äº›è¿”å›ä¿¡æ¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 302 Found</div><div class="line">Date: Fri, 28 Aug 2015 18:34:51 GMT</div><div class="line">Location: https://api.stormpath.com/v1/tenants/sOmELoNgRaNDoMIdHeRe</div><div class="line">Server: Apache</div><div class="line">Set-Cookie: rememberMe=deleteMe; Path=/; Max-Age=0; Expires=Thu, 27-Aug-2015 18:34:52 GMT</div><div class="line">Strict-Transport-Security: max-age=31536000; includeSubDomains; preload</div><div class="line">Content-Length: 0</div><div class="line">Connection: keep-alive</div></pre></td></tr></table></figure></p>
<p>æ³¨æ„åˆ°<code>Location</code>ï¼Œè¿™ä¸ªå°±æ˜¯ä½ çš„Stormpath tenant.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl -u <span class="variable">$API_KEY_ID</span>:<span class="variable">$API_KEY_SECRET</span> \</div><div class="line">     -H <span class="string">"Accept: application/json"</span> \</div><div class="line">     <span class="string">'$TENANT_HREF/applications?name=My%20Application'</span></div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªå›åº”æœ‰å¾ˆå¤šçš„ä¿¡æ¯ã€‚ è¿™æ˜¯ä¸€ä¸ªä»å“åº”ä¸­æ‘˜å½•çš„ä¾‹å­.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    "href": "https://api.stormpath.com/v1/applications/aLoNGrAnDoMAppIdHeRe",</div><div class="line">    "name": "My Application",</div><div class="line">    "description": "This application was automatically created for you in Stormpath for use with our Quickstart guides(https://docs.stormpath.com). It does apply to your subscription's number of reserved applications and can be renamed or reused for your own purposes.",</div><div class="line">    "status": "ENABLED",</div><div class="line">    "tenant": &#123;</div><div class="line">        "href": "https://api.stormpath.com/v1/tenants/sOmELoNgRaNDoMIdHeRe"</div><div class="line">    &#125;,</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»ä¸Šé¢æ³¨æ„ä½ çš„æœ€ä¸Šé¢çš„<code>href</code>ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†åœ¨shiro.inié…ç½®ä¸­ä½¿ç”¨è¿™ä¸ª<code>href</code>ã€‚</p>
<h5 id="Create-an-application-test-user-account"><a href="#Create-an-application-test-user-account" class="headerlink" title="Create an application test user account"></a>Create an application test user account</h5><p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œæˆ‘ä»¬å°†è¦ä¸ºè¯¥åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªç¤ºä¾‹/æµ‹è¯•ç”¨æˆ·ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">curl --request POST --user <span class="variable">$YOUR_API_KEY_ID</span>:<span class="variable">$YOUR_API_KEY_SECRET</span> \</div><div class="line">    -H <span class="string">"Accept: application/json"</span> \</div><div class="line">    -H <span class="string">"Content-Type: application/json"</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'&#123;</span></div><div class="line">           "givenName": "Jean-Luc",</div><div class="line">           "surname": "Picard",</div><div class="line">           "username": "jlpicard",</div><div class="line">           "email": "capt@enterprise.com",</div><div class="line">           "password":"Changeme1"</div><div class="line">        &#125;' \</div><div class="line"> <span class="string">"<span class="variable">$YOUR_APPLICATION_HREF</span>/accounts"</span></div></pre></td></tr></table></figure></p>
<h4 id="Configure-the-Realm-in-shiro-ini"><a href="#Configure-the-Realm-in-shiro-ini" class="headerlink" title="Configure the Realm in shiro.ini"></a>Configure the Realm in shiro.ini</h4><p>æŒ‰ç…§Shiroçš„è¦æ±‚ï¼Œä½ é€‰æ‹©è‡³å°‘ä¸€ä¸ªç”¨æˆ·å­˜å‚¨çš„è¿æ¥ï¼Œæˆ‘ä»¬å°†éœ€è¦é…ç½®ä¸€ä¸ªè¡¨ç¤ºè¯¥æ•°æ®å­˜å‚¨çš„åŸŸï¼Œç„¶åå‘Šè¯‰Shiro SecurityManagerã€‚</p>
<p>å¦‚æœä½ æ£€å‡ºstep2çš„åˆ†æ”¯ï¼Œä½ ä¼šçœ‹åˆ°<code>src/main/webapp/WEB-INF/shiro.ini</code>ä¸­çš„[main]éƒ¨åˆ†ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># Configure a Realm to connect to a user datastore.  In this simple tutorial, we&apos;ll just point to Stormpath since it</div><div class="line"># takes 5 minutes to set up:</div><div class="line">stormpathClient = com.stormpath.shiro.client.ClientFactory</div><div class="line">stormpathClient.cacheManager = $cacheManager</div><div class="line"></div><div class="line"># (Optional) If you put your apiKey.properties in the non-default location, you set the location here</div><div class="line">#stormpathClient.apiKeyFileLocation = $HOME/.stormpath/apiKey.properties</div><div class="line"></div><div class="line">stormpathRealm = com.stormpath.shiro.realm.ApplicationRealm</div><div class="line">stormpathRealm.client = $stormpathClient</div><div class="line"></div><div class="line"># Find this URL in your Stormpath console for an application you create:</div><div class="line"># Applications -&gt; (choose application name) --&gt; Details --&gt; REST URL</div><div class="line"># (Optional) If you only have one Application</div><div class="line">#stormpathRealm.applicationRestUrl = https://api.stormpath.com/v1/applications/$STORMPATH_APPLICATION_ID</div><div class="line"></div><div class="line">stormpathRealm.groupRoleResolver.modeNames = name</div><div class="line">securityManager.realm = $stormpathRealm</div></pre></td></tr></table></figure></p>
<p>æ³¨æ„çœ‹å¯é€‰çš„é‚£è¡Œï¼š</p>
<ul>
<li>å¦‚æœä½ å·²ç»ä½¿ç”¨Stormpathä¸€æ®µæ—¶é—´ï¼Œå¹¶ä¸”ä½ æœ‰æ›´å¤šçš„Stormpathåº”ç”¨ç¨‹åºï¼Œ<code>stormpathRealm.applicationRestUrl</code>è¿™ä¸ªå±æ€§å¿…é¡»è¢«è®¾ç½®ã€‚</li>
</ul>
<h4 id="Run-the-webapp"><a href="#Run-the-webapp" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>åœ¨å®Œæˆä¸Šé¢çš„æ”¹åŠ¨åï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥è·‘ä¸€ä¸‹ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mvn jetty:run</div></pre></td></tr></table></figure></p>
<p>è¿™æ—¶å€™å°±ä¼šçœ‹åˆ°ç†Ÿæ‚‰çš„è¾“å‡ºï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">16:08:25.466 [main] INFO  o.a.shiro.web.env.EnvironmentLoader - Starting Shiro environment initialization.</div><div class="line">16:08:26.201 [main] INFO  o.a.s.c.IniSecurityManagerFactory - Realms have been explicitly set on the SecurityManager instance - auto-setting of realms will not occur.</div><div class="line">16:08:26.201 [main] INFO  o.a.shiro.web.env.EnvironmentLoader - Shiro environment initialized in 731 ms.</div></pre></td></tr></table></figure></p>
<h3 id="Step-3-Enable-Login-and-Logout"><a href="#Step-3-Enable-Login-and-Logout" class="headerlink" title="Step 3: Enable Login and Logout"></a>Step 3: Enable Login and Logout</h3><p>ç°åœ¨æˆ‘ä»¬æœ‰ç”¨æˆ·ï¼Œè€Œä¸”æˆ‘ä»¬èƒ½å¾ˆå®¹æ˜“çš„æ·»åŠ ï¼Œç§»é™¤å’Œç¦ç”¨ä»–ä»¬ã€‚ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­å¼€å§‹å¯ç”¨ç™»å½•/æ³¨é”€å’Œè®¿é—®æ§åˆ¶ç­‰åŠŸèƒ½ã€‚</p>
<p>æ£€å‡ºstep3çš„åˆ†æ”¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step3</div></pre></td></tr></table></figure></p>
<p>æ·»åŠ äº†2ä¸ªä¸œè¥¿:</p>
<ul>
<li><code>src/main/webapp/login.jsp</code>ä¸­åŠ äº†ä¸€ä¸ªç®€å•çš„ç™»å½•è¡¨å•ï¼Œæˆ‘ä»¬ä½¿ç”¨å®ƒç™»å½•ã€‚</li>
<li><code>shiro.ini</code>æ–‡ä»¶å·²æ›´æ–°ï¼Œä»¥æ”¯æŒWebï¼ˆURLï¼‰ç‰¹å®šåŠŸèƒ½ã€‚</li>
</ul>
<h4 id="Enable-Shiro-form-login-and-logout-support"><a href="#Enable-Shiro-form-login-and-logout-support" class="headerlink" title="Enable Shiro form login and logout support"></a>Enable Shiro form login and logout support</h4><p>step3ä¸­<code>src/main/webapp/WEB-INF/shiro.ini</code>æ·»åŠ äº†ä¸‹é¢2ä¸ªä¸œè¥¿ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[main]</div><div class="line"></div><div class="line">shiro.loginUrl = /login.jsp</div><div class="line"></div><div class="line"># Stuff we&apos;ve configured here previously is omitted for brevity</div><div class="line"></div><div class="line">[urls]</div><div class="line">/login.jsp = authc</div><div class="line">/logout = logout</div></pre></td></tr></table></figure></p>
<p>åœ¨[main]è¿™ä¸ªéƒ¨åˆ†å¤šäº†ä¸€è¡Œï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shiro.loginUrl = /login.jsp</div></pre></td></tr></table></figure></p>
<p>è¿™æ˜¯ä¸€ä¸ªå‘Šè¯‰Shiroçš„ç‰¹æ®Šé…ç½®æŒ‡ä»¤:â€å¯¹äºä»»ä½•å…·æœ‰loginUrlå±æ€§çš„Shiroçš„é»˜è®¤è¿‡æ»¤å™¨ï¼Œæˆ‘å¸Œæœ›è¯¥å±æ€§å€¼è®¾ç½®ä¸º/login.jspã€‚â€</p>
<p>è¿™ä¸ªå°±æ˜¯è®©Shiroçš„é»˜è®¤è®¤è¯è¿‡æ»¤å™¨ï¼ˆé»˜è®¤çš„æ˜¯FormAuthenticationFilterï¼‰çŸ¥é“ç™»å½•é¡µé¢æ˜¯å“ªä¸ªã€‚è¿™ä¸ªè®©FormAuthenticationFilteræ­£ç¡®çš„å·¥ä½œæ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚</p>
<p>[urls]éƒ¨åˆ†å…è®¸ä½ ä½¿ç”¨éå¸¸ç®€æ´çš„é”®å€¼å¯¹è¯­æ³•æ¥å‘Šè¯‰Shiroæ€ä¹ˆæ ·å»è¿‡æ»¤ç»™å®šçš„urlè¯·æ±‚ã€‚urlsä¸­çš„æ‰€æœ‰è·¯å¾„éƒ½æ˜¯ç›¸å¯¹äºWebåº”ç”¨ç¨‹åºçš„HttpServletRequest.getContextPath()çš„å€¼.</p>
<p>è¿™äº›é”®å€¼å¯¹æä¾›ä¸€ä¸ªæå…¶å¼ºå¤§çš„æ–¹å¼æ¥è¿‡æ»¤è¯·æ±‚ï¼Œå…è®¸å„ç§å„æ ·çš„å®‰å…¨è§„åˆ™ã€‚URLå’Œè¿‡æ»¤å™¨é“¾çš„æ›´æ·±å…¥çš„è¦†ç›–èŒƒå›´è¶…å‡ºäº†æœ¬æ–‡æ¡£çš„èŒƒå›´ï¼Œä½†å¦‚æœä½ æœ‰å…´è¶£ï¼Œè¯·è¯¦ç»†é˜…è¯»ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/login.jsp = authc</div><div class="line">/logout = logout</div></pre></td></tr></table></figure>
<ul>
<li>ç¬¬ä¸€è¡ŒæŒ‡å‡ºä¸è®ºShiroä»€ä¹ˆæ—¶å€™é‡åˆ°è¯·æ±‚<code>/login.jsp</code>çš„urlï¼Œåœ¨è¯·æ±‚ä¸­å¼€å¯authcè¿‡æ»¤å™¨ã€‚</li>
<li>ç¬¬äºŒè¡Œè¡¨ç¤ºä¸è®ºShiroé‡åˆ°<code>/login.jsp</code>çš„urlï¼Œåœ¨è¯·æ±‚ä¸­å¼€å¯logout è¿‡æ»¤å™¨ã€‚</li>
</ul>
<p>è¿™ä¸¤ä¸ªè¿‡æ»¤å™¨éƒ½æœ‰ä¸€ç‚¹ç‰¹æ®Šçš„åœ°æ–¹ï¼Œä»–ä»¬éƒ½ä¸éœ€è¦åœ¨èƒŒåè¿›è¡Œé¢å¤–çš„å¤„ç†ã€‚å®ƒä»¬å®é™…ä¸Šåªæ˜¯å®Œå…¨å¤„ç†è¯·æ±‚ï¼Œè€Œä¸æ˜¯è¿‡æ»¤ã€‚è¿™æ„å‘³ç€ä½ å¯¹è¿™äº›URLçš„è¯·æ±‚æ²¡æœ‰ä»»ä½•è¦æ±‚ï¼Œä¸éœ€è¦å†™ä»»ä½•controllerã€‚Shiroå°†æ ¹æ®éœ€è¦å¤„ç†è¿™äº›è¯·æ±‚ã€‚</p>
<h4 id="Add-a-login-page"><a href="#Add-a-login-page" class="headerlink" title="Add a login page"></a>Add a login page</h4><p>åœ¨ä¸Šä¸ªæ­¥éª¤ä¸­æˆ‘ä»¬å¼€å¯äº†å¯¹ç™»å½•å’Œç™»å‡ºçš„æ”¯æŒã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦ä¿è¯æœ‰ä¸€ä¸ª<code>/login.jsp</code>é¡µé¢æ¥æ˜¾ç¤ºç™»å½•è¡¨å•ã€‚</p>
<p>step3çš„åˆ†æ”¯ä¸­åŒ…å«<code>src/main/webapp/login.jsp</code>é¡µé¢ã€‚è¿™æ˜¯ä¸€ä¸ªç®€å•çš„bootstrapä¸»é¢˜çš„ç™»å½•é¡µé¢ï¼Œä½†æ˜¯ä¾æ—§æœ‰å››ç‚¹éœ€è¦æ³¨æ„ï¼š</p>
<ul>
<li>è¿™ä¸ªè¡¨å•çš„<code>action</code>å€¼æ˜¯ç©ºçš„å­—ç¬¦ä¸²ã€‚å½“è¡¨å•ä¸­æ²¡æœ‰<code>action</code>å€¼ï¼Œæµè§ˆå™¨å°†æäº¤è¯·æ±‚åˆ°åŒä¸€ä¸ªURLã€‚è¿™å¾ˆå¥½ï¼Œå› ä¸ºæˆ‘ä»¬ä¼šå‘Šè¯‰Shiroé‚£ä¸ªURLå¾ˆçŸ­ï¼Œæ‰€ä»¥Shiroå¯ä»¥è‡ªåŠ¨å¤„ç†ä»»ä½•ç™»å½•æäº¤ã€‚<code>/login.jsp = authc</code>è¿™è¡Œæ˜¯å‘Šè¯‰authcè¿‡æ»¤å™¨å¤„ç†è¿™ä¸ªæäº¤ã€‚</li>
<li>æœ‰ä¸€ä¸ª<code>username</code>å­—æ®µï¼ŒShiro authcè¿‡æ»¤å™¨å°†åœ¨ç™»å½•æäº¤æœŸé—´è‡ªåŠ¨æŸ¥æ‰¾ç”¨æˆ·åè¯·æ±‚å‚æ•°ï¼Œå¹¶å°†å…¶ç”¨ä½œç™»å½•æœŸé—´çš„å€¼ï¼ˆè®¸å¤šåŸŸå…è®¸æ­¤ä¸ºç”µå­é‚®ä»¶æˆ–ç”¨æˆ·åï¼‰ã€‚</li>
<li>æœ‰ä¸€ä¸ª<code>password</code>å­—æ®µï¼ŒShiro authcè¿‡æ»¤å™¨å°†åœ¨ç™»å½•æäº¤æœŸé—´è‡ªåŠ¨æŸ¥æ‰¾å¯†ç è¯·æ±‚å‚æ•°ã€‚</li>
<li>æœ‰ä¸€ä¸ªrememberMeå¤é€‰æ¡†ï¼Œå…¶â€œcheckedâ€çŠ¶æ€å¯ä»¥æ˜¯â€œtrueâ€å€¼ï¼ˆtrueï¼Œtï¼Œ1ï¼Œenabledï¼Œyï¼Œyesæˆ–onï¼‰ã€‚</li>
</ul>
<p>æˆ‘ä»¬çš„login.jspè¡¨å•åªä½¿ç”¨é»˜è®¤çš„ç”¨æˆ·åï¼Œå¯†ç å’ŒrememberMeè¡¨å•å­—æ®µåç§°ã€‚ å¦‚æœæ‚¨æƒ³æ›´æ”¹è¿™äº›åç§°ï¼Œè¿™äº›åç§°æ˜¯å¯é…ç½®çš„ã€‚å‚è§<a href="http://shiro.apache.org/static/1.3.2/apidocs/org/apache/shiro/web/filter/authc/FormAuthenticationFilter.html" target="_blank" rel="external">FormAuthenticationFilter</a>.</p>
<h4 id="Run-the-webapp-1"><a href="#Run-the-webapp-1" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>å†è·‘ä¸€æ¬¡ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mvn jetty:run</div></pre></td></tr></table></figure></p>
<h4 id="Try-to-Login"><a href="#Try-to-Login" class="headerlink" title="Try to Login"></a>Try to Login</h4><p>ä½¿ç”¨æ‚¨çš„Webæµè§ˆå™¨ï¼Œå¯¼èˆªåˆ°localhostï¼š8080 / login.jspï¼Œæ‚¨å°†çœ‹åˆ°æˆ‘ä»¬æ–°çš„ç™»å½•è¡¨å•ã€‚</p>
<p>è¾“å…¥ä½ åœ¨æ­¥éª¤2ç»“æŸæ—¶åˆ›å»ºçš„å¸æˆ·çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œç„¶åç‚¹å‡»â€œç™»å½•â€ã€‚ å¦‚æœç™»å½•æˆåŠŸï¼Œä½ å°†è¢«å¼•å¯¼åˆ°ä¸»é¡µï¼ å¦‚æœç™»å½•å¤±è´¥ï¼Œä½ å°†å†æ¬¡æ˜¾ç¤ºç™»å½•é¡µé¢ã€‚</p>
<p>æç¤ºï¼šå¦‚æœä½ å¸Œæœ›æˆåŠŸç™»å½•å°†ç”¨æˆ·é‡å®šå‘åˆ°ä¸»é¡µï¼ˆä¸Šä¸‹æ–‡è·¯å¾„/ï¼‰ä»¥å¤–çš„å…¶ä»–é¡µé¢ï¼Œåˆ™å¯ä»¥åœ¨INIçš„mainéƒ¨åˆ†ä¸­è®¾ç½®authc.successUrl = / anyã€‚</p>
<h3 id="Step-4-User-specific-UI-changes"><a href="#Step-4-User-specific-UI-changes" class="headerlink" title="Step 4: User-specific UI changes"></a>Step 4: User-specific UI changes</h3><p>é€šå¸¸éœ€è¦æ ¹æ®ç”¨æˆ·æ˜¯è°æ¥æ›´æ”¹webç”¨æˆ·ç•Œé¢ã€‚æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°åšåˆ°è¿™ä¸€ç‚¹ï¼Œå› ä¸ºShiroæ”¯æŒJSPæ ‡ç­¾åº“æ ¹æ®å½“å‰ç™»å½•çš„Subjectï¼ˆç”¨æˆ·ï¼‰è¿›è¡Œæ“ä½œã€‚</p>
<p>æ£€å‡ºstep4çš„åˆ†æ”¯ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step4</div></pre></td></tr></table></figure></p>
<p>åœ¨<code>home.jsp</code>é¡µé¢ä¸­æ–°å¢äº†ï¼š</p>
<ul>
<li>å½“æµè§ˆè¯¥é¡µé¢çš„å½“å‰ç”¨æˆ·æœªç™»å½•æ—¶ï¼Œä»–ä»¬å°†çœ‹åˆ°ä¸€ä¸ªâ€œæ¬¢è¿è®¿å®¢â€æ¶ˆæ¯ï¼Œå¹¶æŸ¥çœ‹ç™»å½•é¡µé¢çš„é“¾æ¥ã€‚</li>
<li>å½“æµè§ˆè¯¥é¡µé¢çš„å½“å‰ç”¨æˆ·ç™»å½•åï¼Œä»–ä»¬å°†çœ‹åˆ°è‡ªå·±çš„åå­—â€œæ¬¢è¿xxxâ€å’Œä¸€ä¸ªé“¾æ¥ä»¥æ³¨é”€ã€‚</li>
</ul>
<p>è¿™ç§ç±»å‹çš„UIå®šåˆ¶å¯¹äºå¯¼èˆªæ æ˜¯éå¸¸å¸¸è§çš„ï¼Œç”¨æˆ·æ§ä»¶ä½äºå±å¹•çš„å³ä¸Šæ–¹ã€‚</p>
<h4 id="Add-the-Shiro-Tag-Library-Declaration"><a href="#Add-the-Shiro-Tag-Library-Declaration" class="headerlink" title="Add the Shiro Tag Library Declaration"></a>Add the Shiro Tag Library Declaration</h4><p>åœ¨<code>home.jsp</code>é¡¶éƒ¨åŒ…å«äº†è¿™ä¸¤è¡Œï¼š<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">taglib</span> <span class="attr">prefix</span>=<span class="string">"shiro"</span> <span class="attr">uri</span>=<span class="string">"http://shiro.apache.org/tags"</span> %&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">taglib</span> <span class="attr">prefix</span>=<span class="string">"c"</span> <span class="attr">uri</span>=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;</span></div></pre></td></tr></table></figure></p>
<p>è¿™ä¸¤ä¸ªJSPé¡µé¢æŒ‡ä»¤å…è®¸é¡µé¢ä¸­çš„Coreï¼ˆc )å’ŒShiroï¼ˆshiro )æ ‡ç­¾åº“ã€‚</p>
<h4 id="Add-Shiro-Guest-and-User-tags"><a href="#Add-Shiro-Guest-and-User-tags" class="headerlink" title="Add Shiro Guest and User tags"></a>Add Shiro Guest and User tags</h4><p><code>home.jsp</code>æ–‡ä»¶è¿›ä¸€æ­¥ä¿®æ”¹äº†bodyé‡Œçš„å†…å®¹ï¼Œä»¥åŒ…å«<shiroï¼šguest>å’Œ<shiroï¼šuser>æ ‡ç­¾ã€‚<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Hi <span class="tag">&lt;<span class="name">shiro:guest</span>&gt;</span>Guest<span class="tag">&lt;/<span class="name">shiro:guest</span>&gt;</span><span class="tag">&lt;<span class="name">shiro:user</span>&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">%</span></span></div><div class="line">    //<span class="attr">This</span> <span class="attr">should</span> <span class="attr">never</span> <span class="attr">be</span> <span class="attr">done</span> <span class="attr">in</span> <span class="attr">a</span> <span class="attr">normal</span> <span class="attr">page</span> <span class="attr">and</span> <span class="attr">should</span> <span class="attr">exist</span> <span class="attr">in</span> <span class="attr">a</span> <span class="attr">proper</span> <span class="attr">MVC</span> <span class="attr">controller</span> <span class="attr">of</span> <span class="attr">some</span> <span class="attr">sort</span>, <span class="attr">but</span> <span class="attr">for</span> <span class="attr">this</span></div><div class="line">    //<span class="attr">tutorial</span>, <span class="attr">we</span>'<span class="attr">ll</span> <span class="attr">just</span> <span class="attr">pull</span> <span class="attr">out</span> <span class="attr">Stormpath</span> <span class="attr">Account</span> <span class="attr">data</span> <span class="attr">from</span> <span class="attr">Shiro</span>'<span class="attr">s</span> <span class="attr">PrincipalCollection</span> <span class="attr">to</span> <span class="attr">reference</span> <span class="attr">in</span> <span class="attr">the</span></div><div class="line">    //&lt;<span class="attr">c:out</span>/&gt; tag next:</div><div class="line"></div><div class="line">    request.setAttribute("account", org.apache.shiro.SecurityUtils.getSubject().getPrincipals().oneByType(java.util.Map.class));</div><div class="line"></div><div class="line">%&gt;</div><div class="line"><span class="tag">&lt;<span class="name">c:out</span> <span class="attr">value</span>=<span class="string">"$&#123;account.givenName&#125;"</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:user</span>&gt;</span>!</div><div class="line">    ( <span class="tag">&lt;<span class="name">shiro:user</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;c:url value="</span>/<span class="attr">logout</span>"/&gt;</span>"&gt;Log out<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">shiro:user</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:guest</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;c:url value="</span>/<span class="attr">login.jsp</span>"/&gt;</span>"&gt;Log in<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">shiro:guest</span>&gt;</span> )</div><div class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div></pre></td></tr></table></figure></shiroï¼šuser></shiroï¼šguest></p>
<p>ç»™å®šçš„æ ¼å¼æœ‰ç‚¹éš¾ä»¥é˜…è¯»ï¼Œä½†æ˜¯åœ¨è¿™é‡Œä½¿ç”¨äº†ä¸¤ä¸ªæ ‡ç­¾ï¼š</p>
<ul>
<li><code>&lt;shiro:guest&gt;</code>è¿™ä¸ªæ ‡ç­¾ä»…ä»…æ˜¾ç¤ºå®ƒå†…éƒ¨çš„å†…å®¹ï¼Œå‡å¦‚å½“å‰çš„subjectæ˜¯ä¸€ä¸ªè®¿å®¢çš„è¯ã€‚Shiroå°†guestå®šä¹‰ä¸ºæœªç™»å½•åˆ°åº”ç”¨ç¨‹åºçš„ä»»ä½•Subjectï¼Œæˆ–è€…åœ¨ä¹‹å‰ç™»å½•æ²¡æœ‰è¢«è®°ä½çš„ç”¨æˆ·ã€‚</li>
<li><code>&lt;shiro:user&gt;</code>Shiroå°†ç”¨æˆ·å®šä¹‰ä¸ºå½“å‰ç™»å½•åˆ°ï¼ˆè®¤è¯ï¼‰åº”ç”¨ç¨‹åºæˆ–ä»å…ˆå‰ç™»å½•è®°å½•çš„ä¸»é¢˜çš„ä»»ä½•ä¸»é¢˜ã€‚</li>
</ul>
<p>å¦‚æœsubjectæ˜¯è®¿å®¢ï¼Œä¸Šè¿°ä»£ç æ®µå°†å‘ˆç°ä»¥ä¸‹ä»£ç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Hi Guest! (Log in)</div></pre></td></tr></table></figure></p>
<p>å¦‚æœsubjectæ˜¯â€œç”¨æˆ·â€ï¼Œå®ƒå°†å‘ˆç°ä»¥ä¸‹å†…å®¹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Hi jsmith! (Log out)</div></pre></td></tr></table></figure></p>
<p>ä½ å¯ä»¥çœ‹åˆ°ï¼Œæ‚¨å¯ä»¥å…³é—­æ•´ä¸ªé¡µé¢éƒ¨åˆ†ï¼ŒåŠŸèƒ½å’ŒUIç»„ä»¶ã€‚<br>é™¤äº†è¿™ä¸¤ä¸ªæ ‡ç­¾ï¼ŒShiroè¿˜æä¾›å…¶ä»–æ ‡ç­¾ä¾›ä½ æ¥å®šåˆ¶ä½ è‡ªå·±çš„UIã€‚</p>
<h4 id="Run-the-webapp-2"><a href="#Run-the-webapp-2" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>è·‘å§ï¼</p>
<h3 id="Step-5-Allow-Access-to-Only-Authenticated-Users"><a href="#Step-5-Allow-Access-to-Only-Authenticated-Users" class="headerlink" title="Step 5: Allow Access to Only Authenticated Users"></a>Step 5: Allow Access to Only Authenticated Users</h3><p>è™½ç„¶ä½ å¯ä»¥æ ¹æ®subjectçš„çŠ¶æ€æ¥æ”¹å˜å†…å®¹ï¼Œä½†æ˜¯é€šå¸¸æƒ…å†µä¸‹ï¼Œä½ å°†è¦é™åˆ¶webappçš„æ•´ä¸ªéƒ¨åˆ†ï¼Œè¿™å–å†³äºæœ‰äººåœ¨å½“å‰ä¸Webåº”ç”¨ç¨‹åºçš„äº’åŠ¨è¿‡ç¨‹ä¸­æ˜¯å¦å·²è¯æ˜å…¶èº«ä»½ï¼ˆå·²éªŒè¯ï¼‰ã€‚</p>
<p>å¦‚æœwebappçš„ç”¨æˆ·ä¸“åŒºéƒ¨åˆ†æ˜¾ç¤ºæ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¸å•æ˜ç»†æˆ–æ§åˆ¶å…¶ä»–ç”¨æˆ·çš„èƒ½åŠ›ï¼‰ï¼Œè¿™ä¸€ç‚¹å°¤ä¸ºé‡è¦ã€‚</p>
<p>æ£€å‡ºstep5ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step5</div></pre></td></tr></table></figure></p>
<p>Step 5æœ‰3ä¸ªæ›´æ–°ï¼š</p>
<ul>
<li>æ·»åŠ äº†ä¸€ä¸ªæ–°çš„éƒ¨åˆ†ï¼ˆurl pathï¼‰ï¼Œæˆ‘ä»¬è¦é™åˆ¶åªæœ‰ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ã€‚</li>
<li>æˆ‘ä»¬æ›´æ”¹äº†shiro.iniï¼Œä»¥å‘Šè¯‰Shiroåªå…è®¸ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·è®¿é—®è¯¥Webåº”ç”¨ç¨‹åºçš„è¯¥éƒ¨åˆ†ã€‚</li>
<li>æˆ‘ä»¬ä¿®æ”¹äº†ä¸»é¡µï¼Œæ ¹æ®å½“å‰çš„ä¸»é¢˜æ˜¯å¦è¢«è®¤è¯æ¥æ›´æ”¹å…¶è¾“å‡ºã€‚</li>
</ul>
<h4 id="Add-a-new-restricted-section"><a href="#Add-a-new-restricted-section" class="headerlink" title="Add a new restricted section"></a>Add a new restricted section</h4><p><code>src/main/webapp/account</code>ç›®å½•è¢«æ·»åŠ è¿›æ¥äº†ã€‚æ­¤ç›®å½•ï¼ˆåŠå…¶ä¸‹æ–¹çš„æ‰€æœ‰è·¯å¾„ï¼‰ä¼šæ¨¡æ‹Ÿç½‘ç«™çš„â€œç§æœ‰â€æˆ–â€œä»…éªŒè¯â€éƒ¨åˆ†ï¼Œä½ å¯èƒ½å¸Œæœ›å°†å…¶é™åˆ¶ä¸ºåªèƒ½ç™»å½•ç”¨æˆ·ã€‚<code>src/main/webapp/account/index.jsp</code>æ–‡ä»¶åªæ˜¯æ¨¡æ‹Ÿâ€œä¸»é¡µâ€é¡µé¢çš„å ä½ç¬¦ã€‚</p>
<h4 id="Configure-shiro-ini"><a href="#Configure-shiro-ini" class="headerlink" title="Configure shiro.ini"></a>Configure shiro.ini</h4><p>åœ¨<code>shiro.ini</code>çš„<code>[urls]</code>è¿™ä¸ªç« èŠ‚çš„ç»“å°¾ï¼Œæ·»åŠ äº†ä¸‹é¢çš„ä¸€è¡Œ:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/account/** = authc</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªShiroè¿‡æ»¤å™¨é“¾å®šä¹‰æ„å‘³ç€â€œå¯¹/ accountï¼ˆæˆ–å…¶ä»»ä½•å­è·¯å¾„ï¼‰çš„ä»»ä½•è¯·æ±‚å¿…é¡»è¢«è®¤è¯â€ã€‚<br>ä½†æ˜¯ï¼Œå¦‚æœæœ‰äººå°è¯•è®¿é—®è¯¥è·¯å¾„æˆ–å…¶ä»»ä½•å­è·¯å¾„ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ<br>ä½ è¿˜è®°å¾—åœ¨æ­¥éª¤3ä¸­,å½“æˆ‘ä»¬å°†ä»¥ä¸‹è¡Œæ·»åŠ åˆ°mainéƒ¨åˆ†å—ï¼Ÿ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shiro.loginUrl = /login.jsp</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸€è¡Œè‡ªåŠ¨ä½¿ç”¨æˆ‘ä»¬çš„webappç™»å½•URLé…ç½®authcè¿‡æ»¤å™¨ã€‚<br>åŸºäºè¿™ä¸€è¡Œé…ç½®ï¼Œauthcè¿‡æ»¤å™¨ç°åœ¨è¶³å¤Ÿèªæ˜ï¼Œå¯ä»¥çŸ¥é“å½“è®¿é—®/å¸æˆ·å½“å‰ä¸»é¢˜æœªè¢«éªŒè¯æ—¶ï¼Œå®ƒå°†è‡ªåŠ¨å°†ä¸»é¢˜é‡å®šå‘åˆ°/login.jspé¡µé¢ã€‚æˆåŠŸç™»å½•åï¼Œå®ƒå°†è‡ªåŠ¨å°†ç”¨æˆ·é‡å®šå‘åˆ°ä»–ä»¬è¯•å›¾è®¿é—®çš„é¡µé¢ï¼ˆ/å¸æˆ·ï¼‰ã€‚ å¾ˆæ–¹ä¾¿ï¼</p>
<h4 id="Update-our-home-page"><a href="#Update-our-home-page" class="headerlink" title="Update our home page"></a>Update our home page</h4><p>æ­¥éª¤5çš„æœ€ç»ˆæ›´æ”¹æ˜¯æ›´æ–°/home.jspé¡µé¢ï¼Œè®©ç”¨æˆ·çŸ¥é“ä»–ä»¬å¯ä»¥è®¿é—®ç½‘ç«™çš„æ–°éƒ¨åˆ†ã€‚è¿™äº›è¡Œè¢«æ·»åŠ åˆ°æ¬¢è¿æ¶ˆæ¯ä¸‹:<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">shiro:authenticated</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>Visit your <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;c:url value="</span>/<span class="attr">account</span>"/&gt;</span>"&gt;account page<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">shiro:authenticated</span>&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">shiro:notAuthenticated</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>If you want to access the authenticated-only <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;c:url value="</span>/<span class="attr">account</span>"/&gt;</span>"&gt;account page<span class="tag">&lt;/<span class="name">a</span>&gt;</span>, you will need to log-in first.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">shiro:notAuthenticated</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>å¦‚æœå½“å‰çš„Subjectåœ¨å½“å‰ä¼šè¯æœŸé—´å·²ç»ç™»å½•ï¼ˆè®¤è¯ï¼‰ï¼Œåˆ™<shiroï¼šauthenticated>æ ‡ç­¾å†…çš„å†…å®¹è¢«æ˜¾ç¤ºã€‚è¿™æ˜¯SubjectçŸ¥é“ä»–ä»¬å¯ä»¥å»è®¿é—®ç½‘ç«™çš„æ–°éƒ¨åˆ†ã€‚<br>å¦‚æœå½“å‰Subjectåœ¨å½“å‰ä¼šè¯æœŸé—´å°šæœªéªŒè¯ï¼Œåˆ™<shiroï¼šnotauthenticated>æ ‡ç­¾å†…çš„å†…å®¹è¢«æ˜¾ç¤ºã€‚<br>ä½†æ˜¯ä½ æ³¨æ„åˆ°äº†å—ï¼Œæœªç»èº«ä»½éªŒè¯çš„å†…å®¹ä»ç„¶å…·æœ‰/ accountéƒ¨åˆ†çš„URLï¼Ÿæ²¡å…³ç³» - æˆ‘ä»¬çš„authcè¿‡æ»¤å™¨å°†å¦‚ä¸Šæ‰€è¿°å¤„ç†login-and-then-redirectæµç¨‹ã€‚<br>ç”¨æ–°çš„æ›´æ”¹å¯åŠ¨webappå¹¶å°è¯•ä¸€ä¸‹ï¼</shiroï¼šnotauthenticated></shiroï¼šauthenticated></p>
<h4 id="Run-the-webapp-3"><a href="#Run-the-webapp-3" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>è·‘ä¸€ä¸‹å§ã€‚</p>
<h3 id="Step-6-Role-Based-Access-Control"><a href="#Step-6-Role-Based-Access-Control" class="headerlink" title="Step 6: Role-Based Access Control"></a>Step 6: Role-Based Access Control</h3><p>é™¤äº†åŸºäºèº«ä»½éªŒè¯æ§åˆ¶è®¿é—®ä¹‹å¤–ï¼Œè¿˜ç»å¸¸éœ€è¦æ ¹æ®åˆ†é…ç»™å½“å‰ä¸»ä½“çš„è§’è‰²æ¥é™åˆ¶å¯¹åº”ç”¨ç¨‹åºæŸäº›éƒ¨åˆ†çš„è®¿é—®ã€‚<br>æ£€å‡ºä»£ç ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step6</div></pre></td></tr></table></figure></p>
<h4 id="Add-Roles"><a href="#Add-Roles" class="headerlink" title="Add Roles"></a>Add Roles</h4><p>ä¸ºäº†æ‰§è¡ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œæˆ‘ä»¬éœ€è¦æœ‰è§’è‰²ã€‚<br>åœ¨æœ¬æ•™ç¨‹ä¸­æœ€å¿«çš„æ–¹æ³•æ˜¯åœ¨Stormpathä¸­æ·»åŠ ä¸€äº›ç»„ã€‚è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œç™»å½•åˆ°UIå¹¶å¯¼èˆªå¦‚ä¸‹ï¼š<br><strong>Directories &gt; My Application Directory &gt; Groups</strong><br>æ·»åŠ ä¸‹é¢ä¸‰ä¸ªç»„ï¼š</p>
<ul>
<li>Captains</li>
<li>Officers</li>
<li>Enlisted</li>
</ul>
<p>åˆ›å»ºç»„åï¼Œå°†Jean-Luc Picardå¸æˆ·æ·»åŠ åˆ°Captainså’ŒOfficersç»„ã€‚æ‚¨å¯èƒ½éœ€è¦åˆ›å»ºä¸€äº›ä¸´æ—¶å¸æˆ·ï¼Œå¹¶å°†å®ƒä»¬æ·»åŠ åˆ°æ‚¨å–œæ¬¢çš„ä»»ä½•ç»„ï¼›ç¡®ä¿æŸäº›å¸æˆ·ä¸é‡å ç»„ï¼Œå› æ­¤ä½ å¯ä»¥åŸºäºåˆ†é…ç»™ç”¨æˆ·å¸æˆ·çš„å•ç‹¬ç»„æŸ¥çœ‹å˜æ›´ã€‚</p>
<h4 id="Role-Based-Access-Control-RBAC-Tags"><a href="#Role-Based-Access-Control-RBAC-Tags" class="headerlink" title="Role Based Access Control (RBAC) Tags"></a>Role Based Access Control (RBAC) Tags</h4><p>æˆ‘ä»¬æ›´æ–°/home.jspé¡µé¢ï¼Œè®©ç”¨æˆ·çŸ¥é“ä»–ä»¬æœ‰ä»€ä¹ˆè§’è‰²ï¼Œå“ªäº›è§’è‰²æ²¡æœ‰ã€‚è¿™äº›æ¶ˆæ¯å°†æ·»åŠ åˆ°ä¸»é¡µçš„æ–°çš„<code>&lt;h2&gt;</code>è§’è‰²<code>&lt;/ h2&gt;</code>éƒ¨åˆ†:<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Roles<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Here are the roles you have and don't have. Log out and log back in under different user</div><div class="line">    accounts to see different roles.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>Roles you have:<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:hasRole</span> <span class="attr">name</span>=<span class="string">"Captains"</span>&gt;</span>Captains<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:hasRole</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:hasRole</span> <span class="attr">name</span>=<span class="string">"Officers"</span>&gt;</span>Bad Guys<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:hasRole</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:hasRole</span> <span class="attr">name</span>=<span class="string">"Enlisted"</span>&gt;</span>Enlisted<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:hasRole</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>Roles you DON'T have:<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:lacksRole</span> <span class="attr">name</span>=<span class="string">"Captains"</span>&gt;</span>Captains<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:lacksRole</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:lacksRole</span> <span class="attr">name</span>=<span class="string">"Officers"</span>&gt;</span>Officers<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:lacksRole</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:lacksRole</span> <span class="attr">name</span>=<span class="string">"Enlisted"</span>&gt;</span>Enlisted<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:lacksRole</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>å¦‚æœå½“å‰ä¸»ä½“è¢«åˆ†é…äº†æŒ‡å®šçš„è§’è‰²ï¼Œ<shiroï¼šhasrole>æ ‡ç­¾å°†æ˜¾ç¤ºå…¶ä¸­çš„å†…å®¹ã€‚<shiroï¼šlacksrole>æ ‡ç­¾åªä¼šåœ¨å½“å‰ä¸»ä½“æœªåˆ†é…æŒ‡å®šè§’è‰²æ—¶æ˜¾ç¤ºå…¶ä¸­çš„å†…å®¹ã€‚</shiroï¼šlacksrole></shiroï¼šhasrole></p>
<h4 id="RBAC-filter-chains"><a href="#RBAC-filter-chains" class="headerlink" title="RBAC filter chains"></a>RBAC filter chains</h4><p>å‘è¯»è€…ç•™ä¸‹çš„ä¸€ä¸ªç»ƒä¹ ï¼ˆä¸æ˜¯ä¸€ä¸ªå®šä¹‰çš„æ­¥éª¤ï¼‰æ˜¯æ ¹æ®åˆ†é…ç»™å½“å‰ç”¨æˆ·çš„è§’è‰²ï¼Œåˆ›å»ºç½‘ç«™çš„ä¸€ä¸ªæ–°çš„éƒ¨åˆ†ï¼Œå¹¶é™åˆ¶URLè®¿é—®è¯¥ç½‘ç«™çš„è¯¥éƒ¨åˆ†ã€‚<br>æç¤ºï¼šä½¿ç”¨ <code>filter chain definition</code>ä¸ºwebappçš„æ–°éƒ¨åˆ†åˆ›å»ºè¿‡æ»¤å™¨é“¾å®šä¹‰ã€‚</p>
<h4 id="Run-the-webapp-4"><a href="#Run-the-webapp-4" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>runä¸€ä¸‹å’¯</p>
<h3 id="Step-7-Permission-Based-Access-Control"><a href="#Step-7-Permission-Based-Access-Control" class="headerlink" title="Step 7: Permission-Based Access Control"></a>Step 7: Permission-Based Access Control</h3><p>åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶å¯¹äºè®¸å¤šæƒ…å†µæ˜¯è¡Œå¾—é€šçš„ï¼Œä½†æ˜¯å®ƒå­˜åœ¨ä¸€ä¸ªä¸»è¦é—®é¢˜ï¼šä½ ä¸èƒ½åœ¨è¿è¡Œæ—¶æ·»åŠ æˆ–åˆ é™¤è§’è‰²ã€‚è§’è‰²æ£€æŸ¥ä½¿ç”¨è§’è‰²åç§°è¿›è¡Œç¡¬ç¼–ç ï¼Œæ‰€ä»¥å¦‚æœä½ æ”¹å˜äº†è§’è‰²åç§°æˆ–è§’è‰²é…ç½®ï¼Œæˆ–æ·»åŠ æˆ–åˆ é™¤è§’è‰²ï¼Œä½ å¿…é¡»å›å»æ›´æ”¹ä»£ç ï¼<br>å› æ­¤ï¼ŒShiroå…·æœ‰å¼ºå¤§çš„åŠŸèƒ½ï¼šå†…ç½®çš„æƒé™æ”¯æŒã€‚<br>åœ¨Shiroï¼Œæƒé™æ˜¯ä¸€ä¸ªåŸå§‹çš„åŠŸèƒ½è¯´æ˜ï¼Œä¾‹å¦‚â€œæ‰“å¼€é—¨â€ï¼Œåˆ›å»ºåšå®¢æ¡ç›®â€œï¼Œâ€åˆ é™¤jsmithç”¨æˆ·â€œç­‰ã€‚æƒé™åæ˜ äº†æ‚¨çš„åº”ç”¨ç¨‹åºçš„åŸå§‹åŠŸèƒ½ï¼Œæ‰€ä»¥åœ¨æ›´æ”¹åº”ç”¨ç¨‹åºçš„åŠŸèƒ½æ—¶ï¼Œæ‚¨åªéœ€è¦æ›´æ”¹æƒé™æ£€æŸ¥ï¼Œè€Œä¸æ˜¯è¦æ›´æ”¹è§’è‰²æˆ–ç”¨æˆ·æ¨¡å‹ã€‚<br>ä¸ºäº†æ¼”ç¤ºè¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€äº›æƒé™å¹¶å°†å…¶åˆ†é…ç»™ç”¨æˆ·ï¼Œç„¶åæ ¹æ®ç”¨æˆ·çš„æˆæƒï¼ˆæƒé™ï¼‰è‡ªå®šä¹‰æˆ‘ä»¬çš„Web UIã€‚</p>
<h4 id="Add-Permissions"><a href="#Add-Permissions" class="headerlink" title="Add Permissions"></a>Add Permissions</h4><p>Shiroçš„Realmæ˜¯åªè¯»ç»„ä»¶:æ¯ä¸ªæ•°æ®å­˜å‚¨æ¨¡å‹çš„è§’è‰²ï¼Œç»„ï¼Œæƒé™ï¼Œå¸æˆ·å’Œä»–ä»¬çš„å…³ç³»ä¸åŒ,æ‰€ä»¥Shiroæ²¡æœ‰ä¸€ä¸ªâ€™writeâ€™APIæ¥ä¿®æ”¹è¿™äº›èµ„æºã€‚è¦ä¿®æ”¹æ¨¡å‹å¯¹è±¡çš„åº•å±‚ï¼Œä½ åªéœ€é€šè¿‡ä»»ä½•æ‚¨æƒ³è¦çš„APIç›´æ¥ä¿®æ”¹å®ƒä»¬ã€‚ä½ çš„Shiroçš„Realmç„¶åçŸ¥é“å¦‚ä½•é˜…è¯»è¿™äº›ä¿¡æ¯ï¼Œå¹¶ä»¥Shiroç†è§£çš„æ ¼å¼è¡¨ç¤ºå®ƒã€‚<br>å› æ­¤ï¼Œç”±äºæˆ‘ä»¬åœ¨æ­¤ç¤ºä¾‹åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨Stormpathï¼Œå› æ­¤æˆ‘ä»¬å°†ä»¥ç‰¹å®šäºStormpath APIçš„æ–¹å¼ä¸ºå¸æˆ·å’Œç»„åˆ†é…æƒé™ã€‚<br>è®©æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªcURLè¯·æ±‚ï¼Œä¸ºä»¥å‰åˆ›å»ºçš„Jean-Luc Picardå¸æˆ·æ·»åŠ ä¸€äº›æƒé™ã€‚ ä½¿ç”¨è¯¥å¸æˆ·çš„href URLï¼Œæˆ‘ä»¬å°†é€šè¿‡è‡ªå®šä¹‰æ•°æ®å°†ä¸€äº›apacheShiroPermissionså‘å¸ƒåˆ°è¯¥å¸æˆ·ï¼š<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">curl -X POST --user <span class="variable">$YOUR_API_KEY_ID</span>:<span class="variable">$YOUR_API_KEY_SECRET</span> \</div><div class="line">    -H <span class="string">"Accept: application/json"</span> \</div><div class="line">    -H <span class="string">"Content-Type: application/json"</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'&#123;</span></div><div class="line">            "apacheShiroPermissions": [</div><div class="line">                "ship:NCC-1701-D:command",</div><div class="line">                "user:jlpicard:edit"</div><div class="line">            ]</div><div class="line">        &#125;' \</div><div class="line"><span class="string">"https://api.stormpath.com/v1/accounts/<span class="variable">$JLPICARD_ACCOUNT_ID</span>/customData"</span></div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­$ JLPICARD_ACCOUNT_IDä¸ä½ åœ¨æœ¬æ•™ç¨‹å¼€å¤´åˆ›å»ºçš„Jean-Luc Picardçš„æ’æ§½ç›¸åŒ¹é…ã€‚<br>è¿™å°†ç›´æ¥å‘Stormpathå¸æˆ·æ·»åŠ ä¸¤ä¸ªæƒé™ï¼š</p>
<ul>
<li>ship:NCC-1701-D:command</li>
<li>user:jlpicard:edit</li>
</ul>
<p>è¿™äº›ä½¿ç”¨Shiroçš„WildcardPermissionè¯­æ³•ã€‚<br>ç¬¬ä¸€ä¸ªåŸºæœ¬ä¸Šæ˜¯æŒ‡ç”¨â€œNCC-1701-Dâ€æ ‡è¯†ç¬¦æ¥â€œå‘½ä»¤â€â€™èˆ¹â€™çš„èƒ½åŠ›ã€‚è¿™æ˜¯å®ä¾‹çº§æƒé™çš„ä¸€ä¸ªç¤ºä¾‹ï¼šæ§åˆ¶å¯¹èµ„æºèˆ¹çš„ç‰¹å®šå®ä¾‹NCC-1701-Dçš„è®¿é—®ã€‚ç¬¬äºŒä¸ªä¹Ÿæ˜¯ä¸€ä¸ªå®ä¾‹çº§æƒé™ï¼ŒæŒ‡å‡ºä½¿ç”¨æ ‡è¯†ç¬¦jlpicardç¼–è¾‘ç”¨æˆ·çš„èƒ½åŠ›ã€‚<br>å¦‚ä½•åœ¨Stormpathä¸­å­˜å‚¨æƒé™ï¼Œä»¥åŠå¦‚ä½•åœ¨Stormpathä¸­è‡ªå®šä¹‰å­˜å‚¨å’Œè®¿é—®é€‰é¡¹è¶…å‡ºæœ¬æ–‡æ¡£çš„èŒƒå›´ï¼Œä½†è¿™æ˜¯åœ¨Shiro Stormpathæ’ä»¶æ–‡æ¡£ä¸­è§£é‡Šçš„ã€‚</p>
<h4 id="Permission-Tags"><a href="#Permission-Tags" class="headerlink" title="Permission Tags"></a>Permission Tags</h4><p>å°±åƒæˆ‘ä»¬æœ‰ç”¨äºè§’è‰²æ£€æŸ¥çš„JSPæ ‡ç­¾ä¸€æ ·ï¼Œè¿˜æœ‰åŒæ ·ç”¨äºæƒé™æ£€æŸ¥çš„æ ‡ç­¾ã€‚æˆ‘ä»¬æ›´æ–°/home.jspé¡µé¢ï¼Œè®©ç”¨æˆ·çŸ¥é“æ˜¯å¦å…è®¸ä½ æ ¹æ®åˆ†é…ç»™ä»–ä»¬çš„æƒé™æ‰§è¡ŒæŸäº›æ“ä½œã€‚è¿™äº›æ¶ˆæ¯å°†æ·»åŠ åˆ°ä¸»é¡µçš„æ–°çš„<code>&lt;h2&gt;</code>æƒé™<code>&lt;/ h2&gt;</code>éƒ¨åˆ†ï¼š<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Permissions<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>You may <span class="tag">&lt;<span class="name">shiro:lacksPermission</span> <span class="attr">name</span>=<span class="string">"ship:NCC-1701-D:command"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>NOT<span class="tag">&lt;/<span class="name">b</span>&gt;</span> <span class="tag">&lt;/<span class="name">shiro:lacksPermission</span>&gt;</span> command the <span class="tag">&lt;<span class="name">code</span>&gt;</span>NCC-1701-D<span class="tag">&lt;/<span class="name">code</span>&gt;</span> Starship!<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>You may <span class="tag">&lt;<span class="name">shiro:lacksPermission</span> <span class="attr">name</span>=<span class="string">"user:$&#123;account.username&#125;:edit"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>NOT<span class="tag">&lt;/<span class="name">b</span>&gt;</span> <span class="tag">&lt;/<span class="name">shiro:lacksPermission</span>&gt;</span> edit the $&#123;account.username&#125; user!<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>å½“ä½ ç¬¬ä¸€æ¬¡è®¿é—®ä¸»é¡µæ—¶ï¼Œåœ¨ç™»å½•ä¹‹å‰ï¼Œä½ å°†çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">You may NOT command the NCC-1701-D Starship!</div><div class="line">You may NOT edit the user!</div></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯ï¼Œåœ¨ä½ ä½¿ç”¨Jean-Luc Picardå¸æˆ·ç™»å½•åï¼Œä½ å°†çœ‹åˆ°è¿™ä¸€ç‚¹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">You may command the NCC-1701-D Starship!</div><div class="line">You may edit the user!</div></pre></td></tr></table></figure></p>
<p>ä½ å¯ä»¥çœ‹åˆ°Shiroè§£å†³äº†ç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·å…·æœ‰æƒé™ï¼Œå¹¶ä»¥é€‚å½“çš„æ–¹å¼å‘ˆç°è¾“å‡ºã€‚<br>æ‚¨è¿˜å¯ä»¥ä½¿ç”¨<shiroï¼šhaspermission>æ ‡ç­¾è¿›è¡Œè‚¯å®šæƒé™æ£€æŸ¥ã€‚<br>æœ€åï¼Œæˆ‘ä»¬å°†æ³¨æ„åˆ°æå…¶å¼ºå¤§çš„æƒé™æ£€æŸ¥åŠŸèƒ½ã€‚ ä½ èƒ½çœ‹åˆ°ç¬¬äºŒä¸ªæƒé™æ£€æŸ¥å¦‚ä½•ä½¿ç”¨è¿è¡Œæ—¶ç”Ÿæˆçš„æƒé™å€¼å—ï¼Ÿ<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">shiro:lacksPermission</span> <span class="attr">name</span>=<span class="string">"user:$&#123;account.username&#125;:edit"</span>&gt;</span> ...</div></pre></td></tr></table></figure></shiroï¼šhaspermission></p>
<p><code>${account.username}</code>åœ¨è¿è¡Œçš„æ—¶å€™å°†<code>user:aUsername:edit</code>çš„å€¼ç»„è£…èµ·æ¥ï¼Œæœ€åè¿™ä¸ªæœ€ç»ˆçš„å€¼è¢«ç”¨æ¥æƒé™æ£€æŸ¥ã€‚<br>è¿™ç§è¿è¡Œæ—¶çš„æƒé™æ£€æŸ¥æœºåˆ¶æ˜¯ç”¨æ¥æ„å»ºé«˜åº¦å®šåˆ¶åŒ–å’Œå®‰å…¨çš„åº”ç”¨çš„å¸¸è§„æŠ€æœ¯ã€‚</p>
<h4 id="Run-the-webapp-5"><a href="#Run-the-webapp-5" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>runä¸€runå’¯</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>æˆ‘ä»¬å¸Œæœ›è¿™ç¯‡æŒ‡å—èƒ½å¯¹ä½ ä½¿ç”¨Shiroæ„å»ºwebappæœ‰å¸®åŠ©ã€‚åœ¨ä¸‹ä¸ªç‰ˆæœ¬æˆ‘ä»¬å°†æ¨å‡ºè¿™äº›å†…å®¹ï¼š</p>
<ul>
<li>ä¸åŒç”¨æˆ·æ•°æ®çš„å­˜å‚¨æ’ä»¶ï¼ŒåƒRDBMSæˆ–è€…NoSQLä¹‹ç±»çš„ã€‚</li>
</ul>
<p>åŸæ–‡<a href="http://shiro.apache.org/webapp-tutorial.html" target="_blank" rel="external">Securing Web Applications with Apache Shiro</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;è¿™ç¯‡æ–‡ç« æ˜¯ä»‹ç»ä½¿ç”¨Shiroä¸€æ­¥ä¸€æ­¥ä¿æŠ¤ä½ çš„webåº”ç”¨çš„æ•™ç¨‹ã€‚å®ƒåŒ…å«äº†Shiroçš„çŸ¥è¯†ï¼Œä»¥åŠå’Œæœ€è¿‘ä¸¤ç¯‡æ–‡ç« å¾ˆç›¸ä¼¼ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.infoq.com/articles/apache-shiro&quot;&gt;Application Security with Apache Shiro&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://shiro.apache.org/10-minute-tutorial.html&quot;&gt;Apache Shiro 10 Minute Tutorial&lt;/a&gt;&lt;br&gt;è¿™ä¸ªå…¥é—¨æ•™ç¨‹ä¼šèŠ±è´¹å¤§çº¦45åˆ†é’Ÿåˆ°ä¸€ä¸ªå°æ—¶ã€‚å½“ä½ è¯»å®Œåï¼Œä½ å°±ä¼šçŸ¥é“Shiroåœ¨webåº”ç”¨ä¸­æ€ä¹ˆå·¥ä½œäº†çš„ã€‚
    
    </summary>
    
      <category term="Apache" scheme="http://www.wei-dong.top/categories/Apache/"/>
    
    
      <category term="Apache Shiro" scheme="http://www.wei-dong.top/tags/Apache-Shiro/"/>
    
      <category term="ç¿»è¯‘" scheme="http://www.wei-dong.top/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>Java Authorization Guide with Apache Shiro[è¯‘]</title>
    <link href="http://www.wei-dong.top/2017/09/25/Java%20Authorization%20Guide%20with%20Apache%20Shiro%5B%E8%AF%91%5D/"/>
    <id>http://www.wei-dong.top/2017/09/25/Java Authorization Guide with Apache Shiro[è¯‘]/</id>
    <published>2017-09-25T12:05:23.000Z</published>
    <updated>2017-09-25T12:09:26.000Z</updated>
    
    <content type="html"><![CDATA[<p>æˆæƒæˆ–è€…è¯´è®¿é—®æ§åˆ¶æŒ‡çš„æ˜¯ä¸ºèµ„æºåˆ†é…è®¿é—®æƒé™ã€‚æ¢å¥è¯è¯´å°±æ˜¯è°èƒ½å¹²ä»€ä¹ˆã€‚</p>
<p>ä¸¾ä¸ªæˆæƒçš„æ —å­ï¼šç”¨æˆ·å…è®¸çœ‹ç½‘é¡µã€æ”¹æ•°æ®ã€çœ‹æŒ‰é’®æˆ–è€…æ‰“å°å—ï¼Ÿè¿™äº›éƒ½èƒ½å†³å®šç”¨æˆ·èƒ½ä¸èƒ½åšä»€ä¹ˆã€‚<br><a id="more"></a></p>
<h3 id="Elements-of-Authorization"><a href="#Elements-of-Authorization" class="headerlink" title="Elements of Authorization"></a>Elements of Authorization</h3><p>æˆæƒæœ‰ä¸‰ä¸ªæˆ‘ä»¬åœ¨Shiroä¸­ä½¿ç”¨å¾ˆå¤šçš„æ ¸å¿ƒå…ƒç´ â€“æƒé™ã€è§’è‰²å’Œç”¨æˆ·ã€‚</p>
<h3 id="Permissions-Defined"><a href="#Permissions-Defined" class="headerlink" title="Permissions Defined"></a>Permissions Defined</h3><p>æƒé™æ˜¯å®‰å…¨ç­–ç•¥çš„æœ€åŸå­çº§åˆ«ï¼Œå®ƒä»¬æ˜¯åŠŸèƒ½è¯­å¥ã€‚æƒé™å°±æ˜¯åœ¨ä½ çš„åº”ç”¨ä¸­èƒ½åšä»€ä¹ˆã€‚æƒé™æè¿°äº†èµ„æºç±»å‹ä»¥åŠå½“ä½ ä¸è¿™äº›èµ„æºè¿›è¡Œäº¤äº’æ—¶å¯èƒ½é‡‡å–çš„æ“ä½œã€‚ä½ èƒ½å¼€é—¨å—ï¼Ÿä½ èƒ½è¯»å–æ–‡ä»¶å—ï¼Ÿä½ èƒ½åˆ é™¤å®¢æˆ·è®°å½•å—ï¼Ÿä½ èƒ½æŒ‰æŒ‰é’®å—ï¼Ÿ</p>
<p>æ•°æ®ç›¸å…³èµ„æºçš„å¸¸è§æ“ä½œæ˜¯åˆ›å»ºï¼Œè¯»å–ï¼Œæ›´æ–°å’Œåˆ é™¤ï¼Œé€šå¸¸ç§°ä¸ºCRUDã€‚</p>
<p>é‡è¦çš„æ˜¯è¦æ˜ç™½ï¼Œæƒé™ä¸æ˜¯è°èƒ½æ‰§è¡Œçš„æ“ä½œ - å®ƒä»¬åªæ˜¯å¯ä»¥æ‰§è¡Œå“ªäº›æ“ä½œçš„è¯­å¥ã€‚</p>
<h4 id="Levels-of-permission-granularity"><a href="#Levels-of-permission-granularity" class="headerlink" title="Levels of permission granularity"></a>Levels of permission granularity</h4><p>ä»¥ä¸Šæƒé™éƒ½æŒ‡å®šèµ„æºï¼ˆé—¨ï¼Œæ–‡ä»¶ï¼Œå®¢æˆ·è®°å½•ç­‰ï¼‰ä¸Šçš„æ“ä½œï¼ˆæ‰“å¼€ï¼Œè¯»å–ï¼Œåˆ é™¤ç­‰ï¼‰ã€‚åœ¨Shiroï¼Œæ‚¨å¯ä»¥å®šä¹‰ä»»ä½•æ‚¨å–œæ¬¢çš„ç²’åº¦çš„æƒé™ã€‚ä»¥ä¸‹æ˜¯ç²’åº¦é¡ºåºçš„å‡ ä¸ªå¸¸è§æƒé™çº§åˆ«ã€‚</p>
<ul>
<li>èµ„æºçº§åˆ« - è¿™æœ€å¹¿æ³›æœ€ç®€å•æ„å»ºã€‚ ç”¨æˆ·å¯ä»¥ç¼–è¾‘å®¢æˆ·è®°å½•æˆ–æ‰“å¼€é—¨ã€‚ èµ„æºè¢«æŒ‡å®šï¼Œä½†ä¸æ˜¯è¯¥èµ„æºçš„ç‰¹å®šå®ä¾‹ã€‚</li>
<li>å®ä¾‹çº§åˆ« - æƒé™å¯ä»¥æŒ‡å®šèµ„æºçš„å®ä¾‹ã€‚ ç”¨æˆ·å¯ä»¥ç¼–è¾‘IBMçš„å®¢æˆ·è®°å½•æˆ–æ‰“å¼€å¨æˆ¿é—¨ã€‚</li>
<li>å±æ€§çº§åˆ« - æƒé™ç°åœ¨å¯ä»¥æŒ‡å®šå®ä¾‹æˆ–èµ„æºçš„å±æ€§ã€‚ ç”¨æˆ·å¯ä»¥ç¼–è¾‘IBMå®¢æˆ·è®°å½•ä¸Šçš„åœ°å€ã€‚</li>
</ul>
<p>è·å–æ›´å¤šä¿¡æ¯:<a href="http://shiro.apache.org/permissions.html" target="_blank" rel="external">Permissions Documentation</a></p>
<h3 id="Roles-Defined"><a href="#Roles-Defined" class="headerlink" title="Roles Defined"></a>Roles Defined</h3><p>åœ¨æˆæƒçš„ä¸Šä¸‹æ–‡ä¸­ï¼Œè§’è‰²å®é™…ä¸Šæ˜¯ç”¨äºç®€åŒ–æƒé™å’Œç”¨æˆ·ç®¡ç†çš„æƒé™é›†åˆã€‚å› æ­¤ï¼Œç”¨æˆ·å¯ä»¥åˆ†é…è§’è‰²ï¼Œè€Œä¸æ˜¯ç›´æ¥åˆ†é…æƒé™ï¼Œè¿™å¯èƒ½ä¼šä½¿è¾ƒå¤§çš„ç”¨æˆ·åŸºç¡€å’Œæ›´å¤æ‚çš„åº”ç”¨ç¨‹åºå˜å¾—å¤æ‚ã€‚å› æ­¤ï¼Œä¾‹å¦‚ï¼Œé“¶è¡Œåº”ç”¨ç¨‹åºå¯èƒ½å…·æœ‰ç®¡ç†å‘˜è§’è‰²æˆ–é“¶è¡Œå‡ºçº³å‘˜è§’è‰²ã€‚</p>
<p>æœ‰2ä¸­ç±»å‹çš„è§’è‰²ä½ éœ€è¦çŸ¥é“ï¼ŒShiroåŒæ—¶ä¹Ÿæ”¯æŒã€‚</p>
<h4 id="Implicit-Rolesï¼ˆéšå¼çš„è§’è‰²ï¼‰"><a href="#Implicit-Rolesï¼ˆéšå¼çš„è§’è‰²ï¼‰" class="headerlink" title="Implicit Rolesï¼ˆéšå¼çš„è§’è‰²ï¼‰"></a>Implicit Rolesï¼ˆéšå¼çš„è§’è‰²ï¼‰</h4><p>ä»£ç ä¸­çš„è§’è‰²æ£€æŸ¥é€šå¸¸æ˜¯éšå«è§’è‰²çš„åæ˜ ã€‚ä½ å¯ä»¥æŸ¥çœ‹æ‚£è€…æ•°æ®ï¼Œå› ä¸ºä½ å…·æœ‰ç®¡ç†å‘˜è§’è‰²ã€‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªå¸æˆ·ï¼Œå› ä¸ºä½ æœ‰é“¶è¡Œå‡ºçº³å‘˜è§’è‰²ã€‚äº‹å®ä¸Šè¿™äº›åå­—çš„å­˜åœ¨å’Œè½¯ä»¶å…·ä½“èƒ½åšçš„æ²¡æœ‰ä»»ä½•å…³ç³»ã€‚å¤§å¤šæ•°äººä»¥è¿™ç§æ–¹å¼ä½¿ç”¨è§’è‰²ã€‚è¿™æ˜¯æœ€ç®€å•çš„ï¼Œä½†å®ƒå¯ä»¥ä¸ºæ‰€æœ‰ä½†æœ€ç®€å•çš„åº”ç”¨ç¨‹åºé€ æˆå¤§é‡çš„ç»´æŠ¤å’Œç®¡ç†é—®é¢˜ã€‚</p>
<h4 id="Explicit-Rolesï¼ˆæ˜¾å¼çš„è§’è‰²ï¼‰"><a href="#Explicit-Rolesï¼ˆæ˜¾å¼çš„è§’è‰²ï¼‰" class="headerlink" title="Explicit Rolesï¼ˆæ˜¾å¼çš„è§’è‰²ï¼‰"></a>Explicit Rolesï¼ˆæ˜¾å¼çš„è§’è‰²ï¼‰</h4><p>æ˜¾å¼è§’è‰²å…·æœ‰æ˜ç¡®åˆ†é…ç»™å®ƒçš„æƒé™ï¼Œå› æ­¤æ˜¯æ˜ç¡®çš„æƒé™é›†åˆã€‚ä»£ç ä¸­çš„æƒé™æ£€æŸ¥åæ˜ äº†æ˜ç¡®çš„è§’è‰²ã€‚ä½ å¯ä»¥æŸ¥çœ‹æ‚£è€…çš„æ•°æ®ï¼Œå› ä¸ºä½ å°†æ‚£è€…æ•°æ®è§†å›¾è§†ä¸ºç®¡ç†å‘˜è§’è‰²çš„ä¸€éƒ¨åˆ†ã€‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªå¸æˆ·ï¼Œå› ä¸ºä½ æœ‰åˆ›å»ºå¸æˆ·æƒé™ä½œä¸ºä½ çš„é“¶è¡ŒæŸœå‘˜è§’è‰²çš„ä¸€éƒ¨åˆ†ã€‚ä½ å¯ä»¥æ‰§è¡Œè¿™äº›æ“ä½œï¼Œè€Œä¸æ˜¯å› ä¸ºåŸºäºå­—ç¬¦ä¸²çš„ä¸€äº›éšå¼è§’è‰²åç§°ï¼Œè€Œæ˜¯å› ä¸ºç›¸åº”æƒé™è¢«æ˜ç¡®åˆ†é…ç»™ä½ çš„è§’è‰²ã€‚</p>
<p>æ˜ç¡®è§’è‰²çš„æœ€å¤§å¥½å¤„æ˜¯æ˜“äºç®¡ç†ï¼Œé™ä½äº†åº”ç”¨ç¨‹åºçš„ç»´æŠ¤ã€‚å¦‚æœä½ éœ€è¦æ·»åŠ ï¼Œåˆ é™¤æˆ–æ›´æ”¹è§’è‰²ï¼Œåˆ™å¯ä»¥åœ¨ä¸è§¦æ‘¸æºä»£ç çš„æƒ…å†µä¸‹æ‰§è¡Œæ­¤æ“ä½œã€‚åœ¨Shiroä¸­ï¼Œä½ è¿˜å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€æ·»åŠ ï¼Œåˆ é™¤æˆ–æ›´æ”¹è§’è‰²ï¼Œå¹¶ä¸”ä½ çš„æˆæƒæ£€æŸ¥å°†å§‹ç»ˆå…·æœ‰æœ€æ–°å€¼ã€‚è¿™æ„å‘³ç€ä½ ä¸å¿…å¼ºåˆ¶ç”¨æˆ·æ³¨é”€å¹¶é‡æ–°ç™»å½•ä»¥è·å–ä»–ä»¬çš„æ–°æƒé™ã€‚</p>
<h3 id="Users-Defined"><a href="#Users-Defined" class="headerlink" title="Users Defined"></a>Users Defined</h3><p>ç”¨æˆ·å°±æ˜¯è°åœ¨ç”¨è¿™ä¸ªåº”ç”¨ç¨‹åºã€‚ç„¶è€Œï¼Œåœ¨Shiroï¼Œç”¨æˆ·çš„æ¦‚å¿µå®é™…ä¸Šæ˜¯Subjectå®ä¾‹ã€‚æˆ‘ä»¬ä½¿ç”¨Subjectè¿™ä¸ªè¯è€Œä¸æ˜¯ç”¨æˆ·ï¼Œå› ä¸ºç”¨æˆ·é€šå¸¸æ„å‘³ç€äººç±»ï¼Œè€Œåœ¨Shiroä¸­ï¼ŒSubjectå¯ä»¥ä¸ä½ çš„åº”ç”¨ç¨‹åºè¿›è¡Œä»»ä½•äº¤äº’ - æ— è®ºæ˜¯äººç±»è¿˜æ˜¯æœåŠ¡ã€‚</p>
<p>ç”¨æˆ·å°±æ˜¯å…è®¸åœ¨ä½ çš„åº”ç”¨ç¨‹åºä¸­é€šè¿‡è§’è‰²æˆ–è€…æƒé™çš„å…³è”æ‰§è¡ŒæŸäº›åŠ¨ä½œã€‚å› æ­¤ä½ å¯ä»¥æ‰“å¼€ä¸€ä¸ªå®¢æˆ·çš„è®°å½•ï¼Œå› ä¸ºä½ å·²ç»è¢«åˆ†é…äº†æ‰“å¼€å®¢æˆ·è®°å½•çš„æƒé™ï¼Œæˆ–è€…ä½ è¢«åˆ†é…äº†å¸¦æœ‰æƒé™çš„è§’è‰²ã€‚</p>
<h3 id="How-to-perform-Authorization-in-Java-with-Shiro"><a href="#How-to-perform-Authorization-in-Java-with-Shiro" class="headerlink" title="How to perform Authorization in Java with Shiro"></a>How to perform Authorization in Java with Shiro</h3><p>åœ¨Shiroä¸­æˆæƒæœ‰å››ç§ï¼š</p>
<ul>
<li>ä»¥ç¼–ç¨‹æ–¹å¼ - ä½ å¯ä»¥åœ¨javaä»£ç ä¸­æ‰§è¡Œæˆæƒæ£€æŸ¥ï¼Œå…¶ç»“æ„å¦‚ifå’Œelseã€‚</li>
<li>JDKæ³¨è§£ - ä½ å¯ä»¥å°†æˆæƒæ³¨è§£é™„åŠ åˆ°Javaæ–¹æ³•ã€‚</li>
<li>JSP / GSP TagLibs  - ä½ å¯ä»¥æ ¹æ®è§’è‰²å’Œæƒé™æ¥æ§åˆ¶jspæˆ–gspé¡µé¢è¾“å‡º</li>
</ul>
<h4 id="Programmatic-Authorization"><a href="#Programmatic-Authorization" class="headerlink" title="Programmatic Authorization"></a>Programmatic Authorization</h4><p>æ£€æŸ¥è§’è‰²å’Œæƒé™ï¼Œåœ¨ä½ çš„ä»£ç ä¸­ä½¿ç”¨ç¼–ç¨‹æ–¹å¼æ˜¯ä¸€ç§ä¼ ç»Ÿæ–¹å¼æ¥å¤„ç†æˆæƒã€‚</p>
<h5 id="Role-Check"><a href="#Role-Check" class="headerlink" title="Role Check"></a>Role Check</h5><p>è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨ç¼–ç¨‹æ–¹å¼æ¥æ£€æŸ¥è§’è‰²çš„æ —å­ã€‚æˆ‘ä»¬æƒ³æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰ç®¡ç†å‘˜è§’è‰²ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†æ˜¾ç¤ºä¸€ä¸ªç‰¹æ®Šçš„æŒ‰é’®ï¼Œå¦åˆ™æˆ‘ä»¬ä¸ä¼šæ˜¾ç¤ºå®ƒã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬å¾—åˆ°å½“å‰ç”¨æˆ·ï¼Œä¹Ÿå°±æ˜¯Subjectã€‚ç„¶åæˆ‘ä»¬å°†adminä¼ ç»™Subjectçš„<code>hasRole()</code>æ–¹æ³•ã€‚å®ƒä¼šè¿”å›<code>TRUE</code>æˆ–è€… <code>FALSE</code>ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//get the current Subject </span></div><div class="line">Subject currentUser = SecurityUtils.getSubject();</div><div class="line"></div><div class="line"><span class="keyword">if</span> (currentUser.hasRole(<span class="string">"administrator"</span>)) &#123;</div><div class="line">    <span class="comment">//show a special buttonâ€</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">//donâ€™t show the button?)â€</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ç°åœ¨ï¼ŒåŸºäºè§’è‰²çš„æ£€æŸ¥æ˜¯å¿«é€Ÿå’Œå®¹æ˜“å®ç°çš„ï¼Œä½†å®ƒå…·æœ‰ä¸»è¦çš„ç¼ºç‚¹ã€‚ è¿™æ˜¯éšå¼çš„ã€‚</p>
<p>å¦‚æœä½ åªæƒ³ç¨åæ·»åŠ ï¼Œåˆ é™¤æˆ–é‡æ–°å®šä¹‰è§’è‰²æ€ä¹ˆåŠï¼Ÿä½ å¿…é¡»æ‰“å¼€æºä»£ç ï¼Œå¹¶æ›´æ”¹æ‰€æœ‰è§’è‰²æ£€æŸ¥ä»¥åæ˜ ä½ çš„å®‰å…¨æ¨¡å‹çš„å˜åŒ–ã€‚ä½ å¿…é¡»å…³é—­åº”ç”¨ç¨‹åºï¼Œç ´è§£ä»£ç ï¼Œæµ‹è¯•å®ƒï¼Œç„¶åé‡æ–°å¯åŠ¨å®ƒã€‚</p>
<p>åœ¨éå¸¸ç®€å•çš„åº”ç”¨ç¨‹åºä¸­ï¼Œè¿™å¯èƒ½è¶³å¤Ÿå¥½ï¼Œä½†å¯¹äºè¾ƒå¤§çš„åº”ç”¨ç¨‹åºï¼Œè¿™å¯èƒ½æ˜¯åº”ç”¨ç¨‹åºçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­çš„ä¸»è¦é—®é¢˜ï¼Œå¹¶ä¸ºä½ çš„è½¯ä»¶å¸¦æ¥å¤§é‡ç»´æŠ¤æˆæœ¬ã€‚</p>
<h5 id="Permission-Check"><a href="#Permission-Check" class="headerlink" title="Permission Check"></a>Permission Check</h5><p>è¿™æ˜¯ä½ å¦‚ä½•é€šè¿‡æƒé™è¿›è¡Œå®‰å…¨æ£€æŸ¥çš„ç¤ºä¾‹ã€‚æˆ‘ä»¬æƒ³æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒæ‰“å°åˆ°laserjet3000nï¼Œå¦‚æœæ˜¯è¿™æ ·ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†æ˜¾ç¤ºæ‰“å°æŒ‰é’®ï¼Œå¦åˆ™æˆ‘ä»¬ä¸ä¼šæ˜¾ç¤ºã€‚è¿™æ˜¯ä¸€ä¸ªå®ä¾‹çº§æƒé™æˆ–å®ä¾‹çº§æˆæƒçš„ç¤ºä¾‹ã€‚</p>
<p>å†æ¬¡ï¼Œé¦–å…ˆä½ å¯ä»¥è®¿é—®å½“å‰çš„ç”¨æˆ·ï¼ŒSubjectã€‚ç„¶åæ„é€ ä¸€ä¸ªPermissionå¯¹è±¡æˆ–è€…å®ä¾‹æ¥è¡¨ç¤ºä¸€ä¸ªåŠ¨ä½œæˆ–è€…èµ„æºã€‚åœ¨è¿™ä¸ªæ —å­ä¸­è¿™ä¸ªå®ä¾‹å¯ä»¥å‘½åä¸ºprintPermission,èµ„æºæ˜¯laserjet3000nï¼ŒåŠ¨ä½œæ˜¯æ‰“å°ã€‚ç„¶åæˆ‘ä»¬å°†printPermissionä¼ ç»™Subjectçš„<code>.isPermitted()</code>æ–¹æ³•ã€‚å®ƒè¿”å›trueæˆ–è€…falseã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Subject currentUser = SecurityUtils.getSubject();</div><div class="line"></div><div class="line">Permission printPermission = <span class="keyword">new</span> PrinterPermission(<span class="string">"laserjet3000n"</span>,<span class="string">"print"</span>);</div><div class="line"></div><div class="line">If (currentUser.isPermitted(printPermission)) &#123;</div><div class="line">    <span class="comment">//do one thing (show the print button?)â€</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">//donâ€™t show the button?</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="Permission-Check-String-based"><a href="#Permission-Check-String-based" class="headerlink" title="Permission Check (String-based)"></a>Permission Check (String-based)</h5><p>ä½ ä¹Ÿå¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„å­—ç¬¦ä¸²è€Œä¸æ˜¯permissionç±»åšæƒé™æ£€æŸ¥ã€‚</p>
<p>å› æ­¤ï¼Œå¦‚æœä½ ä¸æƒ³å®ç°æˆ‘ä»¬permission æ¥å£ï¼Œä½ ä»…ä»…ä¼ ä¸€ä¸ªstringå­—ç¬¦ä¸²å°±è¡Œäº†ã€‚åœ¨è¿™ä¸ªæ —å­ä¸­ï¼Œæˆ‘ä»¬ä¼ <code>.isPermitted()</code>ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">String perm = <span class="string">"printer:print:laserjet4400n"</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span>(currentUser.isPermitted(perm))&#123;</div><div class="line">    <span class="comment">//show the print button?</span></div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">//donâ€™t show the button?</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>åªè¦ä½ çš„åŸŸçŸ¥é“å¦‚ä½•ä½¿ç”¨å®ƒï¼Œä½ å¯ä»¥æŒ‰ç…§ä½ æƒ³è¦çš„æ–¹å¼æ„å»ºæƒé™å­—ç¬¦ä¸²ã€‚åœ¨è¿™ä¸ªæ —å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Shiroçš„å¯é€‰çš„æƒé™è¯­æ³•ï¼Œ<a href="http://shiro.apache.org/permissions.html" target="_blank" rel="external"> WildCardPermissions</a>.WildCardPermissionsåŠŸèƒ½å¼ºå¤§ç›´è§‚ã€‚</p>
<p>é€šè¿‡ä½¿ç”¨åŸºäºå­—ç¬¦ä¸²çš„æƒé™æ£€æŸ¥ï¼Œä½ å¯ä»¥è·å¾—çš„åŠŸèƒ½å’Œä¹‹å‰çš„æ —å­æ˜¯ä¸€æ ·çš„ã€‚å¥½å¤„æ˜¯ä½ ä¸å¿…å¼ºåˆ¶å®ç°æƒé™æ¥å£ï¼Œä½ å¯ä»¥é€šè¿‡ç®€å•çš„å­—ç¬¦ä¸²æ„é€ æƒé™ã€‚ç¼ºç‚¹æ˜¯ä½ æ²¡æœ‰ç±»å‹å®‰å…¨ï¼Œå¦‚æœä½ éœ€è¦æ›´å¤æ‚çš„è®¸å¯æƒé™ï¼Œè¿™äº›æƒé™è¶…å‡ºäº†è¿™ä¸ªå¤„ç†çš„èŒƒå›´ã€‚æ¥ä¸‹æ¥è®²å¦‚ä½•åŸºäºPermissionæ¥å£å®ç°æƒé™å¯¹è±¡ã€‚</p>
<h4 id="Annotation-Authorization"><a href="#Annotation-Authorization" class="headerlink" title="Annotation Authorization"></a>Annotation Authorization</h4><p>å¦‚æœä½ ä¸æƒ³åœ¨ä»£ç å±‚åšæƒé™æ§åˆ¶ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨Javaæ³¨è§£ã€‚Shiroæä¾›å¾ˆå¤šæ³¨è§£å¯ä»¥è®©ä½ æ”¾åœ¨æ–¹æ³•ä¸Šé¢ã€‚</p>
<h5 id="Enabling-Annotation-Support"><a href="#Enabling-Annotation-Support" class="headerlink" title="Enabling Annotation Support"></a>Enabling Annotation Support</h5><p>åœ¨ä½ ä½¿ç”¨Javaæ³¨è§£ä¹‹å‰ï¼Œä½ éœ€è¦åœ¨ä½ çš„åº”ç”¨ä¸­å¼€å¯AOPæ”¯æŒã€‚æœ‰å¾ˆå¤šä¸åŒçš„AOPæ¡†æ¶ï¼Œå› æ­¤ä¸å¹¸çš„æ˜¯ï¼Œåœ¨åº”ç”¨ä¸­æ²¡æœ‰ä¸€ä¸ªæ ‡å‡†çš„æ–¹å¼å¼€å¯AOPã€‚</p>
<p>å¯¹AspectJè€Œè¨€ï¼Œçœ‹æ —å­<a href="https://github.com/apache/shiro/tree/master/samples/aspectj" target="_blank" rel="external">AspectJ sample application</a></p>
<p>å¯¹Springè€Œè¨€ï¼Œçœ‹æ —å­<a href="http://shiro.apache.org/spring.html" target="_blank" rel="external"> Spring Integration </a></p>
<p>å¯¹Guiceè€Œè¨€ï¼Œçœ‹æ —å­<a href="http://shiro.apache.org/guice.html" target="_blank" rel="external"> Guice Integration</a></p>
<h5 id="Permission-Check-1"><a href="#Permission-Check-1" class="headerlink" title="Permission Check"></a>Permission Check</h5><p>åœ¨è¿™ä¸ªæ —å­ä¸­ï¼Œæˆ‘ä»¬æƒ³æ£€æŸ¥ä¸€ä¸ªç”¨æˆ·åœ¨è°ƒç”¨<code>openAccount</code>æ–¹æ³•ä¹‹å‰æ˜¯å¦æœ‰<code>account:create</code>æƒé™ã€‚å¦‚æœæœ‰ï¼ŒæŒ‰ç…§æœŸæœ›çš„è°ƒç”¨ï¼Œå¦‚æœæ²¡å¾—ï¼Œé‚£å°±æŠ›å¼‚å¸¸ã€‚</p>
<p>å’Œé€šè¿‡ç¼–ç¨‹æ–¹å¼æ£€æŸ¥æƒé™ä¸€æ ·ï¼Œä½ å¯ä»¥ä½¿ç”¨Permissionå¯¹è±¡æˆ–è€…ç®€å•çš„å­—ç¬¦ä¸²æ–¹å¼ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Will throw an AuthorizationException if none</span></div><div class="line"><span class="comment">//of the callerâ€™s roles imply the Account</span></div><div class="line"><span class="comment">//'create' permission</span></div><div class="line"><span class="meta">@RequiresPermissions</span>(<span class="string">"account:create"</span>)â€</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openAccount</span><span class="params">( Account acct )</span> </span>&#123;</div><div class="line">    <span class="comment">//create the account</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="Role-Check-1"><a href="#Role-Check-1" class="headerlink" title="Role Check"></a>Role Check</h5><p>åœ¨è¿™ä¸ªæ —å­ä¸­ï¼Œæˆ‘ä»¬æƒ³æ£€æŸ¥ä¸€ä¸ªç”¨æˆ·åœ¨æ‰§è¡Œ<code>openAccount</code>æ–¹æ³•å‰æ˜¯å¦æœ‰<code>teller</code>è§’è‰²ã€‚å¦‚æœæœ‰å°±æŒ‰ç…§æœŸæœ›çš„èµ°ä¸‹å»ï¼Œæ²¡æœ‰å°±æŠ›å¼‚å¸¸ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Throws an AuthorizationException if the caller</span></div><div class="line"><span class="comment">//doesnâ€™t have the â€˜tellerâ€™ role:</span></div><div class="line"><span class="meta">@RequiresRoles</span>( <span class="string">"teller"</span> )</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">openAccount</span><span class="params">( Account acct )</span> </span>&#123;</div><div class="line">    <span class="comment">//do something in here that only a teller</span></div><div class="line">    <span class="comment">//should do</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="JSP-TagLib-Authorization"><a href="#JSP-TagLib-Authorization" class="headerlink" title="JSP TagLib Authorization"></a>JSP TagLib Authorization</h4><p>å¯¹äºåŸºäºJSP / GSPçš„Webåº”ç”¨ç¨‹åºï¼ŒShiroè¿˜æä¾›äº†ä¸€ä¸ªæ ‡ç­¾åº“ä¾›æ‚¨ä½¿ç”¨ã€‚</p>
<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†å‘ç”¨æˆ·æ˜¾ç¤ºuser:manageæƒé™,ä¸€ä¸ªæŒ‡å‘â€œç®¡ç†ç”¨æˆ·â€é¡µé¢çš„é“¾æ¥ã€‚å¦‚æœä»–ä»¬æ²¡æœ‰æƒé™ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šç»™ä»–ä»¬ä¸€ä¸ªå‹å¥½çš„æ¶ˆæ¯æç¤ºã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å°†Shiro taglibæ·»åŠ åˆ°æˆ‘ä»¬çš„Webåº”ç”¨ç¨‹åºä¸­ã€‚æ¥ç€æˆ‘ä»¬ä¸ºuser:manageæƒé™æ·»åŠ <shiro:haspermission>æ ‡ç­¾ã€‚åœ¨<shiroï¼šhaspermission>æ ‡ç­¾ä¸­ï¼Œå¦‚æœç”¨æˆ·å…·æœ‰æˆ‘ä»¬æ­£åœ¨æ£€æŸ¥çš„æƒé™ï¼Œæˆ‘ä»¬å°±æ”¾ç½®è¦æ‰§è¡Œçš„ä»£ç ã€‚å¦‚æœæˆ‘ä»¬è¦æ‰§è¡Œä¸€ä¸ªåŠ¨ä½œå‡å¦‚è¿™ä¸ªç”¨æˆ·ç¼ºå°‘æƒé™ï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ <shiro:lackspermission> æ ‡ç­¾ï¼Œå†æ¬¡æ£€æŸ¥users:manageæƒé™ã€‚å¦‚æœç”¨æˆ·ç¼ºå°‘æƒé™ï¼Œæˆ‘ä»¬æƒ³è¦æ‰§è¡Œçš„ä»»ä½•ä»£ç éƒ½éœ€è¦æ”¾åœ¨<shiroï¼šlackspermission>æ ‡ç­¾ä¸­ã€‚<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">taglib</span> <span class="attr">prefix</span>=<span class="string">"shiro"</span> <span class="attr">uri</span>=<span class="string">http://shiro.apache.org/tags</span> %&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:hasPermission</span> <span class="attr">name</span>=<span class="string">"users:manage"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"manageUsers.jsp"</span>&gt;</span></div><div class="line">            Click here to manage users</div><div class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">shiro:hasPermission</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:lacksPermission</span> <span class="attr">name</span>=<span class="string">"users:manage"</span>&gt;</span></div><div class="line">        No user management for you!</div><div class="line">    <span class="tag">&lt;/<span class="name">shiro:lacksPermission</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure></shiroï¼šlackspermission></shiro:lackspermission></shiroï¼šhaspermission></shiro:haspermission></p>
<p>å½“ç„¶ï¼Œè¿˜æœ‰ç”¨äºæ£€æŸ¥è§’è‰²å’Œå…¶ä»–ç”¨æˆ·æ•°æ®å’ŒçŠ¶æ€çš„æ ‡ç­¾ã€‚</p>
<p>æœ‰å…³JSP / GSPæ ‡ç­¾çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹JSPæ ‡ç­¾åº“ï¼Œä»¥åŠæœ‰å…³å°†åº”ç”¨ç¨‹åºé›†æˆåˆ°Webåº”ç”¨ç¨‹åºä¸­çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»<a href="http://shiro.apache.org/web.html" target="_blank" rel="external">Webé›†æˆæ–‡æ¡£</a>.</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æˆæƒæˆ–è€…è¯´è®¿é—®æ§åˆ¶æŒ‡çš„æ˜¯ä¸ºèµ„æºåˆ†é…è®¿é—®æƒé™ã€‚æ¢å¥è¯è¯´å°±æ˜¯è°èƒ½å¹²ä»€ä¹ˆã€‚&lt;/p&gt;
&lt;p&gt;ä¸¾ä¸ªæˆæƒçš„æ —å­ï¼šç”¨æˆ·å…è®¸çœ‹ç½‘é¡µã€æ”¹æ•°æ®ã€çœ‹æŒ‰é’®æˆ–è€…æ‰“å°å—ï¼Ÿè¿™äº›éƒ½èƒ½å†³å®šç”¨æˆ·èƒ½ä¸èƒ½åšä»€ä¹ˆã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Apache" scheme="http://www.wei-dong.top/categories/Apache/"/>
    
    
      <category term="Apache Shiro" scheme="http://www.wei-dong.top/tags/Apache-Shiro/"/>
    
      <category term="ç¿»è¯‘" scheme="http://www.wei-dong.top/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>Application Security With Apache Shiro[è¯‘]</title>
    <link href="http://www.wei-dong.top/2017/09/21/Application%20Security%20With%20Apache%20Shiro%5B%E8%AF%91%5D/"/>
    <id>http://www.wei-dong.top/2017/09/21/Application Security With Apache Shiro[è¯‘]/</id>
    <published>2017-09-21T04:41:23.000Z</published>
    <updated>2017-09-21T04:46:02.000Z</updated>
    
    <content type="html"><![CDATA[<p>å½“ä½ ä¸ºä½ çš„åº”ç”¨æ·»åŠ å®‰å…¨æªæ–½çš„æ—¶å€™æœ‰æ²¡æœ‰è§‰å¾—å¾ˆå—æŒ«ï¼Ÿä½ æœ‰æ²¡æœ‰è§‰å¾—Javaåœ¨å®‰å…¨è¿™ä¸€å—çš„è§£å†³æ–¹æ¡ˆç”¨èµ·æ¥å¾ˆéš¾ï¼Œè®©ä½ æ›´åŠ è§‰å¾—å›°æƒ‘ï¼Ÿè¿™ç¯‡æ–‡ç« ä»‹ç»<a href="http://shiro.apache.org/" target="_blank" rel="external">Apache Shiro</a>,ä¸€ä¸ªç®€å•åˆå¼ºå¤§ä¸ºä½ åº”ç”¨æä¾›å®‰å…¨çš„Javaæ¡†æ¶ã€‚æœ¬æ–‡å¯¹Apache Shiroçš„æ„¿æ™¯ã€æ¶æ„è®¾è®¡åŠæ€æ ·å»ä½¿ç”¨Shiroæ¥ä¿æŠ¤ä½ çš„åº”ç”¨è¿›è¡Œè§£é‡Šã€‚</p>
<h3 id="Apache-Shiroæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Apache-Shiroæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Apache Shiroæ˜¯ä»€ä¹ˆï¼Ÿ"></a>Apache Shiroæ˜¯ä»€ä¹ˆï¼Ÿ</h3><p>Apache Shiroï¼ˆå‘éŸ³ä¸ºâ€œæ­‡è‚‰â€ï¼Œåœ¨æ—¥æœ¬çš„å‘éŸ³æ˜¯åŸå ¡çš„æ„æ€ï¼‰æ˜¯ä¸€ä¸ªå¼ºå¤§åˆå¥½ç”¨çš„Javaå®‰å…¨æ¡†æ¶ï¼Œå®ƒæä¾›è®¤è¯ã€æˆæƒã€åŠ å¯†å’Œä¼šè¯ç®¡ç†ï¼Œå®ƒå¯ä»¥è¢«ç”¨åœ¨ä¿æŠ¤ä»»ä½•åº”ç”¨â€“ä»å‘½ä»¤è¡Œåº”ç”¨ã€ç§»åŠ¨åº”ç”¨åˆ°å¤§å‹çš„webä¼ä¸šçº§åº”ç”¨ã€‚</p>
<p>Shiroä¸ºä»¥ä¸‹å‡ ä¸ªæ–¹é¢æä¾›åº”ç”¨å®‰å…¨çš„APIã€‚</p>
<ul>
<li>è®¤è¯-è¯æ˜ç”¨æˆ·èº«ä»½ï¼Œé€šå¸¸å«åšç™»å½•</li>
<li>æˆæƒ-è®¿é—®æ§åˆ¶</li>
<li>åŠ å¯†-ä¿æŠ¤æˆ–éšè—æ•°æ®ä¸è¢«çª¥è§†</li>
<li>ä¼šè¯ç®¡ç†-æ¯ä¸ªç”¨æˆ·çš„çŠ¶æ€æ˜¯å¯¹æ—¶é—´æ•æ„Ÿçš„</li>
</ul>
<p>Shiroè¿˜æä¾›è¾…åŠ©çš„ç‰¹æ€§ï¼Œæ¯”å¦‚è¯´webå®‰å…¨ï¼Œå•å…ƒæµ‹è¯•ï¼Œå’Œå¤šçº¿ç¨‹çš„æ”¯æŒã€‚è¿™äº›éƒ½æ˜¯ä¸ºäº†åŠ å¼ºä¸Šé¢æåˆ°çš„å‡ ä¸ªç‰¹æ€§ã€‚</p>
<h3 id="Apache-Shiroä¸ºä»€ä¹ˆè¢«å‘æ˜ï¼Ÿ"><a href="#Apache-Shiroä¸ºä»€ä¹ˆè¢«å‘æ˜ï¼Ÿ" class="headerlink" title="Apache Shiroä¸ºä»€ä¹ˆè¢«å‘æ˜ï¼Ÿ"></a>Apache Shiroä¸ºä»€ä¹ˆè¢«å‘æ˜ï¼Ÿ</h3><p>å¯¹äºä¸€ä¸ªæ¡†æ¶è€Œè¨€ï¼Œå®ƒå­˜åœ¨çš„æ„ä¹‰å°±æ˜¯å®ƒæ»¡è¶³ä½ çš„éœ€æ±‚è€Œæ‰¾ä¸åˆ°å…¶ä»–çš„æ›¿ä»£æ–¹æ¡ˆã€‚ä¸ºäº†ç†è§£è¿™äº›ä¸œè¥¿ï¼Œæˆ‘ä»¬æœ‰å¿…è¦ç¿»ä¸€ç•ªShiroçš„å†å²ä»¥åŠå½“æ—¶çš„æ›¿ä»£å“ã€‚</p>
<p>åœ¨2008å¹´åŠ å…¥ASFä¹‹å‰ï¼ŒShiroéƒ½5å²äº†ï¼Œè€Œä¸”å’Œæ—©åœ¨2003å¹´å¼€å§‹çš„JSecurityä¸€æ ·æœ‰åäº†ã€‚åœ¨2003å¹´ï¼Œæ²¡æœ‰å¤ªå¤šä¸ºJavaå¼€å‘è€…æä¾›å¯é€‰çš„å®‰å…¨æ–¹æ¡ˆã€‚æˆ‘ä»¬åšæŒä½¿ç”¨Javaè®¤è¯å’ŒJavaæˆæƒæœåŠ¡ï¼Œç§°ä½œJAASã€‚ç„¶è€ŒJASSæœ‰å¾ˆå¤šç¼ºç‚¹å½“ç„¶è®¤è¯èƒ½åŠ›æ˜¯å¯ä»¥æ¥å—çš„ï¼Œæˆæƒæ–¹é¢è®©äººç”¨èµ·æ¥è§‰å¾—å¾ˆå´©æºƒã€‚JAASå’ŒJVMçº§åˆ«çš„å®‰å…¨å¯†åˆ‡ç›¸å…³ï¼Œæ¯”æ–¹è¯´å†³å®šä¸€ä¸ªclassè¯¥ä¸è¯¥è¢«åŠ è½½åˆ°JVMã€‚ä½œä¸ºä¸€ä¸ªåº”ç”¨å¼€å‘è€…ï¼Œæˆ‘æ›´å…³å¿ƒçš„æ˜¯åº”ç”¨ç¨‹åºç”¨æˆ·èƒ½åšä»€ä¹ˆï¼Œè€Œä¸æ˜¯æˆ‘çš„ä»£ç åœ¨JVMé‡Œèƒ½åšä»€ä¹ˆã€‚</p>
<p>ç”±äºæˆ‘å½“æ—¶ç€æ‰‹çš„å·¥ä½œï¼Œæˆ‘éœ€è¦ä¸€ä¸ªå¹²å‡€çš„å’Œå®¹å™¨æ— å…³çš„ä¼šè¯æœºåˆ¶ã€‚å½“æ—¶åœ¨æ¸¸æˆï¼ˆæˆ‘çŒœä½œè€…çš„å·¥ä½œå°±æ˜¯å†™æ¸¸æˆï¼‰ä¸­å”¯ä¸€çš„é€‰æ‹©å°±æ˜¯HttpSessionï¼Œè¿™ä¸ªç©æ„éœ€è¦ä¸€ä¸ªwebå®¹å™¨æˆ–è€…EJBå®¹å™¨ã€‚æˆ‘éœ€è¦çš„æ˜¯èƒ½å¤Ÿä»å®¹å™¨ä¸­è§£è€¦ï¼Œè€Œä¸”åœ¨ä»»ä½•ç¯å¢ƒä¸‹éƒ½å¥½ç”¨çš„ã€‚</p>
<p>æœ€åæœ‰ä¸€ä¸ªå¯†ç çš„é—®é¢˜ã€‚æœ‰å¾ˆå¤šæƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦åŠ å¯†æ•°æ®ï¼Œä½†æ˜¯JavaåŠ å¯†æ¶æ„é™¤äº†å¯†ç ä¸“å®¶å¤–æ™®é€šäººå¾ˆéš¾ç†è§£ã€‚å®ƒçš„APIåˆ°å¤„éƒ½æ˜¯å¼‚å¸¸æ£€æŸ¥ï¼Œç”¨èµ·æ¥æ„Ÿè§‰å¾ˆç¬¨é‡ã€‚æˆ‘è¿«åˆ‡å¸Œæœ›ä¸€ä¸ªå¹²å‡€çš„å¼€ç®±å³ç”¨çš„å¯ä»¥æ»¡è¶³æˆ‘çš„éœ€æ±‚çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<p>çœ‹äº†ä¸€ä¸‹åœ¨2003å¹´æ—©æœŸçš„å®‰å…¨æ¦‚å†µï¼Œä½ èƒ½å¾ˆå¿«çš„æ„è¯†åˆ°æ²¡æœ‰ä¸€æ¬¾å•ä¸€çš„æ¡†æ¶èƒ½å¤Ÿæ»¡è¶³è¿™äº›éœ€æ±‚ã€‚æ­£å› ä¸ºå¦‚æ­¤ï¼ŒJSecurityè¿˜æœ‰åæ¥çš„Shiroè¯ç”Ÿäº†ã€‚</p>
<h3 id="å¦‚ä»Šä½ ä¸ºä½•ç”¨Apache-Shiro"><a href="#å¦‚ä»Šä½ ä¸ºä½•ç”¨Apache-Shiro" class="headerlink" title="å¦‚ä»Šä½ ä¸ºä½•ç”¨Apache Shiro?"></a>å¦‚ä»Šä½ ä¸ºä½•ç”¨Apache Shiro?</h3><p>è‡ª2003å¹´æ¥ï¼Œæ¡†æ¶çš„æ ¼å±€å‘ç”Ÿäº†å¾ˆå¤§çš„å˜åŒ–ï¼Œå› æ­¤ç°åœ¨æœ‰ä¸€ä¸ªè®©äººä¿¡æœçš„ç†ç”±æ¥ä½¿ç”¨Shiroã€‚ç†ç”±å¦‚ä¸‹ï¼š</p>
<ul>
<li>å¥½ç”¨â€“å¥½ç”¨æ˜¯ä¸€ä¸ªé¡¹ç›®æœ€å…³é”®çš„ç›®æ ‡ã€‚åº”ç”¨å®‰å…¨å¯èƒ½æ˜¯éå¸¸è®©äººæ²®ä¸§å’Œå›°æƒ‘ï¼Œå› æ­¤è¢«ç§°ä½œâ€œå¿…è¦çš„ç½ªæ¶â€ã€‚å‡å¦‚ä½ è®©å®ƒå˜å¾—æ–°æ‰‹ç¨‹åºå‘˜éƒ½å®¹æ˜“ä½¿ç”¨ï¼Œé‚£å°±ä¸é‚£ä¹ˆç—›è‹¦äº†ã€‚</li>
<li>å…¨é¢â€“æ²¡æœ‰æ¯”Shiroæ›´å¹¿æ³›çš„å®‰å…¨æ¡†æ¶äº†ï¼Œå› æ­¤å®ƒå¯ä»¥ä¸€ç«™å¼æ»¡è¶³ä½ å¯¹å®‰å…¨çš„éœ€è¦ã€‚</li>
<li>çµæ´»â€“Shiroèƒ½åœ¨ä»»ä½•ç¯å¢ƒä¸‹å·¥ä½œã€‚è™½ç„¶å®ƒåœ¨webã€EJBã€å’ŒioCå®¹å™¨ä¸­å·¥ä½œï¼Œä½†æ˜¯å®ƒä¸ä¾èµ–ä»–ä»¬ã€‚Shiroæ²¡æœ‰å¤ªå¤šçš„è§„å®šï¼Œä¹Ÿæ²¡æœ‰å¤ªå¤šçš„ä¾èµ–ã€‚</li>
<li>æ”¯æŒwebâ€“Shiroå¯¹webåº”ç”¨æœ‰å…¨é¢çš„æ”¯æŒï¼Œä½ å¯ä»¥åˆ›å»ºåŸºäºwebåè®®å’Œurlçš„çµæ´»çš„å®‰å…¨ç­–ç•¥ï¼ŒåŒæ—¶æä¾›ä¸€å¥—æ§åˆ¶é¡µé¢è¾“å‡ºçš„JSPåº“ã€‚</li>
<li>å¯æ’æ‹”â€“Shiroå¹²å‡€çš„APIï¼ˆå¹²å‡€å¯ä»¥ç¿»è¯‘ä¸ºç®€æ´ï¼‰å’Œè®¾è®¡æ€æƒ³å¯ä»¥è®©ä½ å¾ˆå®¹æ˜“åœ°é›†æˆåˆ°å…¶ä»–æ¡†æ¶å’Œåº”ç”¨ã€‚ä½ å¯ä»¥çœ‹åˆ°Shiroå’ŒSpringã€Grailsç­‰æ¡†æ¶æ— ç¼é›†æˆã€‚</li>
<li>æ”¯æŒâ€“Shiroæ˜¯ASFçš„ä¸€éƒ¨åˆ†ã€‚è¿™ä¸ªé¡¹ç›®çš„å¼€å‘å’Œç”¨æˆ·ç¾¤ä¼šå‹å¥½çš„æä¾›å¸®åŠ©ã€‚å¦‚æœéœ€è¦ï¼Œåƒ<a href="https://stormpath.com/" target="_blank" rel="external">Katasoft</a>å•†ä¸šå…¬å¸ä¹Ÿä¼šæä¾›ä¸“ä¸šçš„æ”¯æŒå’ŒæœåŠ¡ã€‚</li>
</ul>
<h3 id="è°åœ¨ç”¨Shiroï¼Ÿ"><a href="#è°åœ¨ç”¨Shiroï¼Ÿ" class="headerlink" title="è°åœ¨ç”¨Shiroï¼Ÿ"></a>è°åœ¨ç”¨Shiroï¼Ÿ</h3><p>Shiroå’Œå®ƒçš„å…ˆé©±JSecurityåœ¨å¾ˆå¤šè¡Œä¸šå¾ˆå¤šå…¬å¸çš„é¡¹ç›®ä¸­ç”¨äº†å¾ˆå¤šå¹´ã€‚åœ¨æˆä¸ºASFé¡¶çº§é¡¹ç›®ä¹‹åï¼Œå®ƒçš„ç½‘ç«™æµé‡å’Œä½¿ç”¨ç‡å¤§å¢ã€‚ä¹Ÿæœ‰è®¸å¤šå¼€æºçš„ç»„ç»‡ä½¿ç”¨Shiroï¼Œæ¯”æ–¹è¯´Spring, Grails, Wicket, Tapestry, Tynamo, Mule, å’Œ Vaadinã€‚</p>
<p>å•†ä¸šå…¬å¸åƒKatasoftã€Sonatypeã€MuleSoftç­‰ä¹Ÿä½¿ç”¨Shiroæ¥ä¿æŠ¤ä»–ä»¬çš„å•†ä¸šè½¯ä»¶å’Œç½‘ç«™ã€‚</p>
<h3 id="æ ¸å¿ƒæ¦‚å¿µï¼šä¸»ä½“ï¼Œå®‰å…¨ç®¡ç†å™¨ï¼ŒåŸŸ"><a href="#æ ¸å¿ƒæ¦‚å¿µï¼šä¸»ä½“ï¼Œå®‰å…¨ç®¡ç†å™¨ï¼ŒåŸŸ" class="headerlink" title="æ ¸å¿ƒæ¦‚å¿µï¼šä¸»ä½“ï¼Œå®‰å…¨ç®¡ç†å™¨ï¼ŒåŸŸ"></a>æ ¸å¿ƒæ¦‚å¿µï¼šä¸»ä½“ï¼Œå®‰å…¨ç®¡ç†å™¨ï¼ŒåŸŸ</h3><p>ç›®å‰æˆ‘ä»¬è®²äº†Shiroçš„ä¼˜ç‚¹ï¼Œæˆ‘ä»¬ç›´æ¥æ¥çœ‹çœ‹å®ƒçš„APIï¼Œè®©ä½ ç›´æ¥æ„Ÿå—å®ƒã€‚Shiroçš„æ¶æ„æœ‰3ä¸ªæ ¸å¿ƒçš„æ¦‚å¿µâ€“ä¸»ä½“ã€å®‰å…¨ç®¡ç†å™¨å’ŒåŸŸã€‚</p>
<h4 id="Subject-ä¸»ä½“"><a href="#Subject-ä¸»ä½“" class="headerlink" title="Subject(ä¸»ä½“)"></a>Subject(ä¸»ä½“)</h4><p>å½“ä½ è¦å¯¹ä½ çš„åº”ç”¨è¿›è¡Œä¿æŠ¤çš„æ—¶å€™ï¼Œä½ æœ€å¤§çš„å¯èƒ½è¦é—®çš„é—®é¢˜å°±æ˜¯â€œå½“å‰ç”¨æˆ·æ˜¯è°ï¼Ÿâ€æˆ–è€…â€œå½“å‰ç”¨æˆ·å…è®¸åšè¿™ä»¶äº‹å—ï¼Ÿâ€ï¼Œæˆ‘ä»¬é—®è‡ªå·±è¿™äº›é—®é¢˜æ˜¯å¾ˆæ­£å¸¸çš„ï¼Œå°±åƒæˆ‘ä»¬åœ¨å†™ä»£ç æˆ–è€…è®¾è®¡æ¥å£ä¸€æ ·ã€‚åº”ç”¨ç¨‹åºé€šå¸¸æ˜¯åŸºäºç”¨æˆ·æ•…äº‹æ¥æ„å»ºï¼Œè€Œä¸”ä½ æƒ³åŸºäºæ¯ä¸ªç”¨æˆ·æ¥æ„å»ºä½ çš„åŠŸèƒ½ã€‚å› æ­¤ï¼Œä½ è€ƒè™‘åœ¨ä½ åº”ç”¨å®‰å…¨æœ€å¸¸è§„çš„æ€è·¯å°±æ˜¯åŸºäºå½“å‰ç”¨æˆ·ã€‚Shiro APIä¸­çš„ä¸»ä½“æ¦‚å¿µåŸºæœ¬ä¸Šä½“ç°äº†è¿™ç§æ€è·¯ã€‚</p>
<p>ä¸»ä½“æ˜¯å®‰å…¨æœ¯è¯­ä¸­çš„ä¸€ä¸ªåè¯ï¼Œä»£è¡¨çš„æ˜¯å½“å‰æ‰§è¡Œçš„ç”¨æˆ·ã€‚ä¸èƒ½ä»…ä»…åªç§°ä½œâ€œç”¨æˆ·â€å› ä¸ºâ€œç”¨æˆ·â€è¿™ä¸ªè¯é€šå¸¸å’Œäººç±»å…³è”èµ·æ¥ã€‚åœ¨å®‰å…¨é¢†åŸŸï¼Œä¸»ä½“è¿™ä¸ªè¯å¯ä»¥ä»£è¡¨ä¸€ä¸ªäººï¼Œä¹Ÿå¯ä»¥ä»£è¡¨ç¬¬ä¸‰æ–¹è¿›ç¨‹ã€ä¸€ä¸ªåå°è´¦å·æˆ–è€…ç±»ä¼¼çš„ä¸œè¥¿ã€‚ç®€å•æ¥è®²ï¼Œå°±æ˜¯å’Œå½“å‰è½¯ä»¶äº¤äº’çš„ä¸œè¥¿ã€‚ç„¶è€Œå¯¹äºå¤§å¤šæ•°ç›®çš„å’Œç”¨é€”ï¼Œä½ å¯ä»¥æŠŠå®ƒå½“åšShiroç”¨æˆ·çš„æ¦‚å¿µã€‚ä½ èƒ½å¾ˆå®¹æ˜“åœ°åœ¨ä½ çš„ä»£ç ä¸­è·å–Shiroçš„ä¸»ä½“ï¼Œä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">import org.apache.shiro.subject.Subject;</div><div class="line">import org.apache.shiro.SecurityUtils;</div><div class="line">...</div><div class="line">Subject currentUser = SecurityUtils.getSubject();</div></pre></td></tr></table></figure></p>
<p>ä¸€æ—¦ä½ è·å–äº†ä¸»ä½“ï¼Œä½ å°±èƒ½ä½¿ç”¨Shiroä¸ºå½“å‰ç”¨æˆ·æ‹¿åˆ°90%çš„è®¿é—®æƒé™ï¼Œæ¯”å¦‚ç™»å½•ï¼Œé€€å‡ºç™»å½•ï¼Œè·å–sessionï¼Œæ‰§è¡Œæƒé™æ£€æŸ¥ç­‰ã€‚è¿™é‡Œå…³é”®ç‚¹æ˜¯Shiroçš„APIå¤§ä½“ä¸Šæ˜¯å¾ˆç›´è§‚çš„ï¼Œä»ä¸­å¯ä»¥ä½“ç°å¼€å‘è€…åœ¨é’ˆå¯¹æ¯ä¸ªç”¨æˆ·çš„å®‰å…¨æ§åˆ¶ä¸­çš„æ€è·¯ï¼ˆè¿™å¥è¯å®åœ¨æ˜¯ä¸çŸ¥é“æ€ä¹ˆç¿»è¯‘ï¼‰ã€‚åœ¨ä»£ç ä¸­ä»»ä½•åœ°æ–¹è·å–ä¸»ä½“å¾ˆå®¹æ˜“ï¼Œåœ¨éœ€è¦è¿›è¡Œå®‰å…¨æ“ä½œçš„åœ°æ–¹è¿›è¡Œæ§åˆ¶ä¹Ÿå¾ˆå®¹æ˜“ã€‚</p>
<h4 id="SecurityManager-å®‰å…¨ç®¡ç†å™¨"><a href="#SecurityManager-å®‰å…¨ç®¡ç†å™¨" class="headerlink" title="SecurityManager(å®‰å…¨ç®¡ç†å™¨)"></a>SecurityManager(å®‰å…¨ç®¡ç†å™¨)</h4><p>åœ¨ä¸»ä½“èƒŒååä¸ä¹‹é…å¯¹çš„æ˜¯å®‰å…¨ç®¡ç†å™¨ã€‚ä¸»ä½“æä¾›å½“å‰ç”¨æˆ·çš„å®‰å…¨æ“ä½œï¼Œç„¶è€Œå®‰å…¨ç®¡ç†å™¨ä¸ºæ‰€æœ‰ç”¨æˆ·ç®¡ç†ç€å®‰å…¨æ“ä½œã€‚è¿™æ˜¯Shiroæ¶æ„çš„æ ¸å¿ƒï¼Œæœ‰ç±»ä¼¼äºå¾ˆå¤šâ€œä¼â€çš„ä½œç”¨ã€‚è¿™äº›ä¼å†…éƒ¨å¼•ç”¨äº†å¾ˆå¤šåµŒå¥—çš„å®‰å…¨ç»„ä»¶è€Œå½¢æˆä¸€ä¸ªä¼å›¾ï¼ˆç¿»è¯‘å¾ˆæ™¦æ¶©ï¼Œæ„æ€å°±æ˜¯å¾ˆå¤šç»„ä»¶ç»„åˆè€Œæˆï¼‰ã€‚ç„¶è€Œï¼Œä¸€æ—¦å®‰å…¨ç®¡ç†å™¨åŠå†…éƒ¨çš„â€œä¼å›¾â€é…ç½®å¥½äº†ï¼Œåº”ç”¨å¼€å‘è€…å‡ ä¹å°†æ‰€æœ‰æ—¶é—´éƒ½èŠ±åœ¨äº†ä¸»ä½“APIä¸Šï¼Œé€šå¸¸è¿™ä¸ªå®‰å…¨ç®¡ç†å™¨æ˜¯ç‹¬ç«‹çš„ã€‚</p>
<p>åœ¨æ¯ä¸€ä¸ªåº”ç”¨ä¸­æ€»æœ‰ä¸€ä¸ªå®‰å…¨ç®¡ç†å™¨å®ä¾‹ã€‚æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå•ä¾‹åº”ç”¨ï¼ˆè™½ç„¶ä¸å¿…æ˜¯é™æ€å•ä¾‹ï¼‰ã€‚åƒShiroä¸­å…¶ä»–ä¸œè¥¿ä¸€æ ·ï¼Œé»˜è®¤çš„å®‰å…¨ç®¡ç†å™¨çš„å®ç°æ˜¯POJOï¼Œå¯ä»¥é€šè¿‡ä»»ä½•ä¸POJOå…¼å®¹çš„é…ç½®æœºåˆ¶â€“æ™®é€šçš„Javaä»£ç ã€Spring XMLã€YAMLã€.propertieså’Œiniæ–‡ä»¶ç­‰ç­‰ã€‚é€šå¸¸æ¥è®²ï¼Œèƒ½å¤Ÿè¢«å®ä¾‹åŒ–çš„ç±»å’Œèƒ½å¤Ÿè°ƒç”¨JavaBeanå…¼å®¹æ–¹æ³•çš„éƒ½å¯ä»¥ä½¿ç”¨ã€‚</p>
<p>ä¸ºæ­¤ï¼ŒShiroå€ŸåŠ©åŸºäºæ–‡æœ¬çš„INIé…ç½®æä¾›äº†ä¸€ä¸ªç¼ºçœçš„â€œå…¬å…±â€è§£å†³æ–¹æ¡ˆã€‚INIè¯»èµ·æ¥å¾ˆå®¹æ˜“ï¼Œç”¨èµ·æ¥å¾ˆç®€å•ï¼Œè€Œä¸”ä¾èµ–çš„ä¸œè¥¿ä¹Ÿå¾ˆå°‘ã€‚ä½ å¯ä»¥çœ‹åˆ°ï¼Œé€šè¿‡ç®€å•äº†è§£å¯¹è±¡å›¾å¯¼èˆªï¼ŒINIå¯ä»¥å¾ˆé«˜æ•ˆçš„é…ç½®ç®€å•çš„å¯¹è±¡å›¾,åƒSecurityManagerã€‚æ³¨æ„Shiroä¹Ÿæ”¯æŒSpring XMLé…ç½®åˆå…¶ä»–æ›¿ä»£å“ã€‚æˆ‘ä»¬è¿™é‡Œåªè°ˆINIã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[main]</div><div class="line">cm = org.apache.shiro.authc.credential.HashedCredentialsMatcher</div><div class="line">cm.hashAlgorithm = SHA-512</div><div class="line">cm.hashIterations = 1024</div><div class="line">#Base64 encoding (less text):</div><div class="line">cm.storedCredentialsHexEncoded = false</div><div class="line">iniRealm.credentialsMatcher = $cm</div><div class="line">[users]</div><div class="line">jdoe = TWFuIGlzIGRpc3Rpbmd1aXNoZWQsIG5vdCBvbmx5IGJpcyByZWFzb2</div><div class="line">asmith = IHNpbmd1bGFyIHBhc3Npb24gZnJvbSBvdGhlciBhbXNoZWQsIG5vdCB</div></pre></td></tr></table></figure></p>
<p>åœ¨ä¸Šé¢çš„INIé…ç½®ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°é…ç½®SecurityManager å®ä¾‹ã€‚åœ¨INIé…ç½®ä¸­æœ‰2ä¸ªéƒ¨åˆ†ï¼š[main]å’Œ[users].</p>
<p>[main]éƒ¨åˆ†ç”¨äºé…ç½®SecurityManagerå¯¹è±¡æˆ–è€…è¢«SecurityManager ä½¿ç”¨çš„ä»»ä½•å¯¹è±¡ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†ä¸¤ä¸ªå¯¹è±¡è¢«é…ç½®ï¼š</p>
<ol>
<li>cmå¯¹è±¡ï¼ŒShiroä¸­çš„HashedCredentialsMatcher ç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚ä½ èƒ½çœ‹åˆ°ï¼Œå¾ˆå¤šcmçš„å±æ€§é€šè¿‡åµŒå¥—çš„ç‚¹çš„è¯­æ³•è¢«é…ç½®ã€‚æ¸…å•3æ‰€ç¤ºçš„IniSecurityManagerFactoryä½¿ç”¨çš„çº¦å®šæ¥è¡¨ç¤ºå¯¹è±¡å›¾å½¢å¯¼èˆªå’Œå±æ€§è®¾ç½®ã€‚</li>
<li>iniRealmå¯¹è±¡ï¼Œå®ƒæ˜¯SecurityManagerç”¨äºè¡¨ç¤ºä»¥INIæ ¼å¼å®šä¹‰çš„ç”¨æˆ·å¸æˆ·çš„ç»„ä»¶ã€‚</li>
</ol>
<p>åœ¨[users]è¿™éƒ¨åˆ†ä¸­ä½ å¯ä»¥æŒ‡å®šä¸€ä¸ªé™æ€çš„ç”¨æˆ·åˆ—è¡¨ï¼Œå¯¹äºç®€å•çš„åº”ç”¨æ˜¯å¾ˆæ–¹ä¾¿æ¥æµ‹è¯•çš„ã€‚</p>
<p>ä»‹ç»è¿™äº›çš„ç›®çš„ä¸æ˜¯å»ç†è§£æ¯ä¸ªéƒ¨åˆ†çš„å¤æ‚æ€§ï¼Œè€Œæ˜¯INIé…ç½®æ–¹å¼æ˜¯ä¸€ç§ç®€å•çš„Shiroé…ç½®ã€‚æ›´å¤šå…³äºINIé…ç½®çš„ç»†èŠ‚ï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒ<a href="http://shiro.apache.org/documentation.html" target="_blank" rel="external">Shiroæ–‡æ¡£</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">import org.apache.shiro.SecurityUtils;</div><div class="line">import org.apache.shiro.config.IniSecurityManagerFactory;</div><div class="line">import org.apache.shiro.mgt.SecurityManager;</div><div class="line">import org.apache.shiro.util.Factory;</div><div class="line">...</div><div class="line">//1. Load the INI configuration</div><div class="line">Factory&lt;SecurityManager&gt; factory = new IniSecurityManagerFactory(&quot;classpath:shiro.ini&quot;);</div><div class="line">//2. Create the SecurityManager SecurityManager securityManager = factory.getInstance();</div><div class="line">//3. Make it accessible</div><div class="line">SecurityUtils.setSecurityManager(securityManager);</div></pre></td></tr></table></figure></p>
<p>åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æœ‰3ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>åŠ è½½é…ç½®SecurityManageråŠå…¶ç»„ä»¶çš„INIé…ç½®æ–‡ä»¶ã€‚</li>
<li>åŸºäºè¿™ä¸ªé…ç½®åˆ›å»ºSecurityManagerå®ä¾‹(ä½¿ç”¨Shiroçš„å·¥å‚æ¦‚å¿µ)ã€‚</li>
<li>æŠŠSecurityManagerå˜æˆå•ä¾‹ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬å°†å®ƒè®¾ç½®æˆVMé™æ€å•ä¾‹ï¼Œä½†æ˜¯è¿™ä¸æ˜¯å¿…é¡»çš„ã€‚ä½ çš„åº”ç”¨é…ç½®æœºåˆ¶å¯ä»¥å†³å®šä½ è¦ä¸è¦ä½¿ç”¨é™æ€å†…å­˜(è¿™æ®µç¿»è¯‘çœŸçš„ä¸€ç‚¹éƒ½ä¸å®¹æ˜“ç†è§£)ã€‚</li>
</ol>
<h4 id="Realms-åŸŸ"><a href="#Realms-åŸŸ" class="headerlink" title="Realms(åŸŸ)"></a>Realms(åŸŸ)</h4><p>Shiroä¸­ç¬¬ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µå°±æ˜¯åŸŸã€‚åŸŸåœ¨ä½ çš„åº”ç”¨æ•°æ®å’ŒShiroä¸­æ‰¿æ‹…ä¸€ä¸ªæ¡¥æ¢æˆ–è€…è¯´æ˜¯è¿æ¥å™¨çš„è§’è‰²ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å’Œå®‰å…¨ç›¸å…³çš„æ•°æ®äº¤äº’ï¼Œæ¯”æ–¹è¯´è®¤è¯ï¼ˆç™»å½•ï¼‰å’Œæˆæƒï¼ˆè®¿é—®æ§åˆ¶ï¼‰æ—¶ï¼ŒShiroä»ä¸ºåº”ç”¨é…ç½®çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªåŸŸé…ç½®ä¸­å»æ‰¾è¿™äº›ä¸œè¥¿ã€‚</p>
<p>åœ¨æŸç§æ„ä¹‰ä¸Šï¼Œä¸€ä¸ªåŸŸæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå®‰å…¨çš„DAOï¼šå®ƒä¸ºæ•°æ®æºå°è£…äº†è¿æ¥ç»†èŠ‚ä»¥åŠåœ¨éœ€è¦çš„æ—¶å€™è®©Shiroèƒ½å¤Ÿè®¿é—®å…³è”çš„æ•°æ®ã€‚å½“åœ¨é…ç½®Shiroçš„æ—¶å€™ï¼Œä½ å¿…é¡»æŒ‡å®šè‡³å°‘ä¸€ä¸ªåŸŸç”¨æ¥åšè®¤è¯æˆ–è€…æˆæƒã€‚å¯ä»¥é…ç½®å¤šä¸ªï¼Œä½†è‡³å°‘è¦æœ‰ä¸€ä¸ªã€‚</p>
<p>Shiroæä¾›å¼€ç®±å³ç”¨çš„åŸŸæ¥è¿æ¥å„ç§å®‰å…¨çš„æ•°æ®æºï¼Œæ¯”æ–¹è¯´LDAPã€æ•°æ®åº“ç›¸å…³çš„ï¼ˆJDBCï¼‰ã€æ–‡æœ¬æ–‡ä»¶é…ç½®ç±»ä¼¼INIæ–‡ä»¶å’Œpropertiesé…ç½®æ–‡ä»¶ç­‰ã€‚å¦‚æœé»˜è®¤çš„åŸŸä¸èƒ½æ»¡è¶³ä½ çš„éœ€æ±‚ï¼Œä½ ä¹Ÿå¯ä»¥å°†ä½ è‡ªå·±å®ç°çš„åŸŸæ’å…¥åˆ°å…¶ä¸­ã€‚ä¸‹é¢é€šè¿‡INIé…ç½®Shiroçš„ä¾‹å­å°±æ˜¯ç”¨LDAPæ¥ä½œä¸ºåº”ç”¨çš„ä¸€ä¸ªåŸŸå®ç°ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[main]</div><div class="line">ldapRealm = org.apache.shiro.realm.ldap.JndiLdapRealm</div><div class="line">ldapRealm.userDnTemplate = uid=&#123;0&#125;,ou=users,dc=mycompany,dc=com</div><div class="line">ldapRealm.contextFactory.url = ldap://ldapHost:389</div><div class="line">ldapRealm.contextFactory.authenticationMechanism = DIGEST-MD5</div></pre></td></tr></table></figure></p>
<p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†æ€ä¹ˆé…ç½®ä¸€ä¸ªåŸºç¡€çš„Shiroç¯å¢ƒï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¸€èµ·è®¨è®ºä½œä¸ºä¸€ä¸ªå¼€å‘è€…ä½ æ”¹æ€ä¹ˆä½¿ç”¨è¿™ä¸ªæ¡†æ¶ã€‚</p>
<h4 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h4><p>è®¤è¯æ˜¯éªŒè¯ç”¨æˆ·çš„å”¯ä¸€æ€§çš„è¿‡ç¨‹ã€‚å°±æ˜¯è¯´ï¼Œå½“ç”¨æˆ·ä½¿ç”¨åº”ç”¨è¿›è¡Œè®¤è¯çš„æ—¶å€™ï¼Œä»–ä»¬åœ¨è¯æ˜ä»–ä»¬ç¡®å®æ˜¯ä»–ä»¬æ‰€è¯´çš„é‚£ä¸ªäººã€‚é€šå¸¸æœ‰æ—¶å€™æˆ‘ä»¬æŠŠå®ƒç§°ä½œç™»å½•ã€‚å…¸å‹çš„ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>æ”¶é›†ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œä¹Ÿå«ä½œprincipalsï¼Œå¹¶æ”¯æŒèº«ä»½è¯æ˜ï¼Œç§°ä¸ºcredentialsã€‚</li>
<li>æäº¤principalså’Œcredentialsåˆ°ç³»ç»Ÿã€‚</li>
<li>å¦‚æœæäº¤çš„credentialså’Œç³»ç»ŸæœŸæœ›è¯¥ç”¨æˆ·èº«ä»½åŒ¹é…ï¼Œè¿™ä¸ªç”¨æˆ·å°±å¯ä»¥è®¤ä¸ºè®¤è¯é€šè¿‡ã€‚å¦‚æœä¸åŒ¹é…ï¼Œé‚£å°±æ˜¯è®¤è¯ä¸é€šè¿‡ã€‚</li>
</ol>
<p>æ¯ä¸ªäººéƒ½ç†Ÿæ‚‰çš„æœ€å¸¸è§çš„ä¾‹å­å°±æ˜¯ç”¨æˆ·åå’Œå¯†ç çš„ç»„åˆã€‚å½“ç”¨æˆ·ç™»å½•åˆ°ç³»ç»Ÿï¼Œä»–ä»¬é€šå¸¸æä¾›ä»–çš„ç”¨æˆ·åï¼ˆprincipalï¼‰å’Œå¯†ç ï¼ˆcredentialï¼‰ã€‚å¦‚æœå­˜å‚¨åœ¨ç³»ç»Ÿä¸­çš„ å¯†ç å’Œç”¨æˆ·æä¾›çš„ä¸€è‡´ï¼Œä»–å°±è¢«è®¤è¯æˆåŠŸã€‚</p>
<p>Shiroä»¥ç®€å•ç›´è§‚çš„æ–¹å¼æ”¯æŒç±»ä¼¼çš„æµç¨‹ã€‚æ­£å¦‚æˆ‘ä»¬è¯´çš„ï¼ŒShiroæœ‰ä¸€å¥—ä»¥ä¸»ä½“ä¸ºä¸­å¿ƒçš„APIâ€“å‡ ä¹æ‰€æœ‰åœ¨è¿è¡Œæ—¶ä½ å’ŒShiroå…³å¿ƒçš„éƒ½æ˜¯é€šè¿‡ä¸å½“å‰æ‰§è¡Œçš„ä¸»ä½“äº¤äº’å®ç°çš„ã€‚å› æ­¤ï¼Œè¦ç™»å½•ä¸€ä¸ªä¸»ä½“ï¼Œä½ åªéœ€è¦è°ƒç”¨å®ƒçš„ç™»å½•æ–¹æ³•ï¼Œä¼ ä¸€ä¸ªå¸¦æœ‰principals å’Œcredentialsçš„AuthenticationTokenå®ä¾‹ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">//1. Acquire submitted principals and credentials:</div><div class="line"> AuthenticationToken token = new UsernamePasswordToken(username,password);</div><div class="line">//2. Get the current Subject:</div><div class="line">Subject currentUser = SecurityUtils.getSubject();</div><div class="line"> //3. Login:</div><div class="line"> currentUser.login(token);</div></pre></td></tr></table></figure></p>
<p>å¦‚ä½ æ‰€è§ï¼ŒShiroçš„APiå¾ˆç®€å•çš„è¡¨ç¤ºäº†è¿™ä¸ªæµç¨‹ã€‚ä½ å¯ä»¥å°†è¿™ç§å¯¹æ‰€æœ‰ä¸»ä½“æ“ä½œçš„ç®€å•æ€§ä½œä¸ºä¸€ç§ç‰¹è‰²ã€‚å½“ç™»å½•æ–¹æ³•è¢«è°ƒç”¨ï¼ŒSecurityManagerå°†æ¥æ”¶AuthenticationTokenç„¶åå°†å…¶åˆ†å‘åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªé…ç½®å¥½çš„åŸŸä¸­ç”¨æ¥åšè®¤è¯ã€‚æ¯ä¸ªåŸŸéƒ½æœ‰èƒ½åŠ›æ ¹æ®éœ€è¦å¯¹æäº¤çš„AuthenticationTokenè¿›è¡Œå¤„ç†ã€‚ä½†æ˜¯å‡å¦‚ç™»å½•å¤±è´¥äº†ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿå‡å¦‚ç”¨æˆ·çš„å¯†ç è¾“é”™äº†å‘¢ï¼Ÿä½ å¯ä»¥é€šè¿‡è¿è¡Œæ—¶çš„AuthenticationException æ¥å¤„ç†è¿™äº›å¤±è´¥ï¼Œä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">//3. Login:</div><div class="line">try &#123;</div><div class="line">    currentUser.login(token);</div><div class="line">&#125; catch (IncorrectCredentialsException ice) &#123; â€¦</div><div class="line">&#125; catch (LockedAccountException lae) &#123; â€¦</div><div class="line">&#125;</div><div class="line">â€¦</div><div class="line">catch (AuthenticationException ae) &#123;â€¦</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä½ å¯ä»¥é€‰æ‹©æ•è·AuthenticationExceptionçš„ä¸€ä¸ªå­ç±»æ¥è¿›è¡Œå…·ä½“çš„å¤„ç†ï¼Œæˆ–è€…ç»Ÿä¸€å¤„ç†ä»»ä½•AuthenticationExceptionï¼ˆæ¯”å¦‚è¯´ï¼Œé€šå¸¸æ˜¾ç¤ºâ€œç”¨æˆ·åæˆ–è€…å¯†ç é”™è¯¯â€æ¶ˆæ¯ï¼‰ã€‚è¿™æ˜¯æ ¹æ®ä½ åº”ç”¨çš„éœ€æ±‚æ¥é€‰æ‹©çš„ã€‚</p>
<p>ä¸€ä¸ªä¸»ä½“ç™»å½•æˆåŠŸåï¼Œä»–ä»¬è¢«è®¤ä¸ºè®¤è¯é€šè¿‡ï¼Œé€šå¸¸ä½ å…è®¸ä»–ä»¬ä½¿ç”¨ä½ çš„åº”ç”¨ã€‚ä½†æ˜¯ï¼Œç”±äºç”¨æˆ·ä»…è¯æ˜äº†è‡ªå·±çš„èº«ä»½ä¸ä»£è¡¨ä»–ä»¬åœ¨åº”ç”¨ä¸­èƒ½åšä»»ä½•ä»–ä»¬æƒ³åšçš„äº‹æƒ…ã€‚è¿™å°±æå‡ºäº†ä¸‹ä¸€ä¸ªé—®é¢˜ï¼šâ€œæˆ‘å¦‚ä½•æ§åˆ¶ç”¨æˆ·è¢«å…è®¸åšä»€ä¹ˆï¼Ÿâ€å†³å®šç”¨æˆ·å…è®¸åšä»€ä¹ˆå«åšæˆæƒã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è®¨è®ºShiroæ€ä¹ˆå¯ç”¨æˆæƒã€‚</p>
<h4 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h4><p>æˆæƒæ˜¯åŸºæœ¬çš„è®¿é—®æ§åˆ¶â€“æ§åˆ¶ä½ çš„ç”¨æˆ·åœ¨ä½ çš„åº”ç”¨ä¸­å¯ä»¥è®¿é—®ä»€ä¹ˆï¼Œæ¯”æ–¹è¯´èµ„æºã€webé¡µé¢ç­‰ç­‰ã€‚å¤§å¤šæ•°ç”¨æˆ·é€šè¿‡ä½¿ç”¨è§’è‰²å’Œæƒé™ç­‰æ¦‚å¿µæ¥æ‰§è¡Œè®¿é—®æ§åˆ¶ã€‚å°±æ˜¯è¯´ï¼Œä¸€ä¸ªç”¨æˆ·é€šå¸¸å…è®¸åšä»€ä¹ˆäº‹æˆ–è€…ä¸å…è®¸åšä»€ä¹ˆäº‹æ˜¯åŸºäºä»–ä»¬åˆ†é…çš„è§’è‰²æˆ–è€…æƒé™çš„ã€‚ç„¶åï¼Œä½ çš„åº”ç”¨ç¨‹åºå¯ä»¥æ ¹æ®å¯¹è¿™äº›è§’è‰²å’Œæƒé™çš„æ£€æŸ¥æ¥æ§åˆ¶æ˜¾ç¤ºå“ªäº›åŠŸèƒ½ã€‚æ­£å¦‚ä½ æœŸæœ›çš„ï¼Œä¸»ä½“APIå…è®¸ä½ éå¸¸å®¹æ˜“çš„æ‰§è¡Œæƒé™å’Œè§’è‰²æ£€æŸ¥ã€‚ä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if ( subject.hasRole(â€œadministratorâ€) ) &#123;</div><div class="line">    //show the â€˜Create Userâ€™ button</div><div class="line">&#125; else &#123;</div><div class="line">    //grey-out the button?</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å¦‚ä½ æ‰€è§ï¼Œä½ çš„åº”ç”¨å¯ä»¥åŸºäºè®¿é—®æ§åˆ¶å¼€å¯æˆ–è€…å…³é—­åŠŸèƒ½ã€‚</p>
<p>æƒé™æ£€æŸ¥æ˜¯å¦ä¸€ç§æ‰§è¡Œæˆæƒçš„æ–¹å¼ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­æ£€æŸ¥æƒé™æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ç¼ºé™·ï¼šä½ ä¸èƒ½å†è¿è¡Œçš„æ—¶å€™æ·»åŠ æˆ–è€…åˆ é™¤è§’è‰²ã€‚ä½ çš„ä»£ç æ˜¯å’Œè§’è‰²åå­—ç¡¬ç¼–ç è¿›å»çš„ï¼Œå› æ­¤å‡å¦‚ä½ æ”¹å˜äº†è§’è‰²åæˆ–è€…é…ç½®ï¼Œä½ çš„ä»£ç å°†ä¼šçˆ†ç‚¸ï¼å‡å¦‚ä½ éœ€è¦å¯ä»¥åœ¨è¿è¡Œæ—¶æ”¹å˜è§’è‰²çš„å«ä¹‰ï¼Œæˆ–è€…æ ¹æ®éœ€è¦æ·»åŠ åˆ é™¤è§’è‰²ï¼Œé‚£ä¹ˆä½ å°±å¿…é¡»ä¾é åˆ«çš„ä¸œè¥¿äº†ã€‚</p>
<p>ä¸ºæ­¤ï¼ŒShiroæ”¯æŒæƒé™çš„æ¦‚å¿µã€‚æƒé™æ˜¯åŸå§‹åŠŸèƒ½çš„è¯´æ˜ï¼Œä¸¾ä¸ªæ —å­ï¼Œâ€˜å¼€é—¨â€™ã€â€˜åˆ›å»ºåšå®¢å®ä½“â€™ã€â€˜åˆ é™¤xxç”¨æˆ·â€™ç­‰ç­‰ã€‚æœ‰æƒé™ä»£è¡¨ä½ æœ‰åº”ç”¨çš„åŸå§‹åŠŸèƒ½ï¼Œå½“ä½ æ›´æ”¹åº”ç”¨ç¨‹åºçš„åŠŸèƒ½æ—¶ï¼Œä½ åªéœ€è¦æ›´æ”¹æƒé™æ£€æŸ¥ã€‚åè¿‡æ¥ï¼Œåœ¨è¿è¡Œæ—¶å¿…è¦çš„æ—¶å€™ä½ å¯ä»¥åˆ†é…æƒé™åˆ°è§’è‰²æˆ–è€…ç”¨æˆ·ã€‚ä¸‹é¢çš„ä»£ç ä½¿ç”¨æƒé™æ£€æŸ¥ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if ( subject.isPermitted(â€œuser:createâ€) ) &#123;</div><div class="line">    //show the â€˜Create Userâ€™ button</div><div class="line">&#125; else &#123;</div><div class="line">    //grey-out the button?</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™æ ·ï¼Œä»»ä½•åˆ†é…äº†â€œuserï¼šcreateâ€æƒé™çš„è§’è‰²æˆ–ç”¨æˆ·å¯ä»¥å•å‡»â€œåˆ›å»ºç”¨æˆ·â€æŒ‰é’®,è€Œä¸”è¿™äº›è§’è‰²å’Œåˆ†é…ç”šè‡³å¯ä»¥åœ¨è¿è¡Œæ—¶æ›´æ”¹ï¼Œç»™ä½ æä¾›äº†ä¸€ç§éå¸¸çµæ´»çš„å®‰å…¨æ¨¡å‹ã€‚</p>
<p>â€œuserï¼šcreateâ€å­—ç¬¦ä¸²æ˜¯éµå®ˆæŸäº›è§£æçº¦å®šçš„æƒé™å­—ç¬¦ä¸²çš„ç¤ºä¾‹ã€‚Shiroé€šè¿‡å…¶WildcardPermissionæ”¯æŒè¿™ä¸ªå¼€ç®±å³ç”¨çš„çº¦å®šã€‚è™½ç„¶è¶…å‡ºæœ¬å¯¼è¨€æ–‡ç« çš„èŒƒå›´ï¼Œä½ å°†çœ‹åˆ°WildcardPermissionåœ¨åˆ›å»ºå®‰å…¨ç­–ç•¥æ—¶å¯ä»¥éå¸¸çµæ´»ï¼Œç”šè‡³æ”¯æŒè¯¸å¦‚å®ä¾‹çº§è®¿é—®æ§åˆ¶ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if ( subject.isPermitted(â€œuser:delete:jsmithâ€) ) &#123;</div><div class="line">    //delete the â€˜jsmithâ€™ user</div><div class="line">&#125; else &#123;</div><div class="line">    //donâ€™t delete â€˜jsmithâ€™</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªä¾‹å­å±•ç¤ºäº†ä½ èƒ½æ§åˆ¶ï¼Œç”šè‡³å¯ä»¥ç»†åŒ–åˆ°æ›´ç»†ç²’åº¦çš„çº§åˆ«ï¼Œå¦‚æœæœ‰éœ€è¦å¯ä»¥è®¿é—®å•ä¸ªèµ„æºã€‚å¦‚æœä½ æƒ³çš„è¯ä½ ä¹Ÿå¯ä»¥å‘æ˜è‡ªå·±çš„æƒé™è¯­æ³•ã€‚å‚è€ƒ<a href="http://shiro.apache.org/permissions.html" target="_blank" rel="external">Shiro Permission</a>è·å–æ›´å¤šè¯¦æƒ…ã€‚æœ€åï¼Œå°±åƒèº«ä»½éªŒè¯ä¸€æ ·ï¼Œä¸Šé¢çš„è°ƒç”¨æœ€ç»ˆä¹Ÿè¿›å…¥äº†SecurityManagerï¼ŒSecurityManagerå°†ä¼šæŸ¥è¯¢ä¸€ä¸ªæˆ–å¤šä¸ªåŸŸï¼Œä»¥ä½œå‡ºè®¿é—®æ§åˆ¶å†³å®šã€‚è¿™å…è®¸é¢†åŸŸæ ¹æ®éœ€è¦å¯¹è®¤è¯å’Œæˆæƒæ“ä½œè¿›è¡Œå“åº”ã€‚</p>
<p>åˆ°æ­¤å°±æ˜¯ä¸€ä¸ªé˜ŸShiroæˆæƒåŠŸèƒ½çš„ä¸€ä¸ªç®€è¦æ¦‚è¿°ã€‚å¾ˆå¤šå®‰å…¨æ¡†æ¶åœ¨è®¤è¯å’Œæˆæƒé¢å‰åœäº†ä¸‹æ¥ï¼Œè€ŒShiroä¸æ­¢äºæ­¤ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¦è®¨è®ºShiroçš„é«˜çº§ä¼šè¯ç®¡ç†åŠŸèƒ½ã€‚</p>
<h4 id="Session-Management"><a href="#Session-Management" class="headerlink" title="Session Management"></a>Session Management</h4><p>Shiroæä¾›å®‰å…¨æ¡†æ¶é‡Œç‹¬ä¸€æ— äºŒçš„ï¼šå¯ç”¨äºä»»ä½•åº”ç”¨å’Œä»»ä½•ç»“æ„å±‚ä¸€è‡´çš„ä¼šè¯APIã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒShiroä¸ºä»»ä½•åº”ç”¨ç¨‹åºå¯ç”¨äº†ä¼šè¯ç¼–ç¨‹èŒƒä¾‹â€“ä»å°çš„åå°åº”ç”¨åˆ°å¤§å‹é›†ç¾¤webåº”ç”¨ã€‚è¿™æ„å‘³ç€å¸Œæœ›ä½¿ç”¨ä¼šè¯çš„åº”ç”¨ç¨‹åºå¼€å‘äººå‘˜ä¸å†å¼ºåˆ¶ä½¿ç”¨Servletæˆ–EJBå®¹å™¨ã€‚æˆ–è€…ï¼Œå¦‚æœä½¿ç”¨è¿™äº›å®¹å™¨ï¼Œå¼€å‘äººå‘˜ç°åœ¨å¯ä»¥é€‰æ‹©åœ¨ä»»ä½•å±‚ä¸­ä½¿ç”¨ç»Ÿä¸€å’Œä¸€è‡´çš„ä¼šè¯APIï¼Œè€Œä¸æ˜¯ä½¿ç”¨servletæˆ–EJBç‰¹å®šçš„æœºåˆ¶ã€‚</p>
<p>ä½†æ˜¯æˆ–è®¸ä¸€ä¸ªæœ€é‡è¦çš„å¥½å¤„æ˜¯Shiroä¼šè¯æ˜¯ç‹¬ç«‹äºå®¹å™¨çš„ã€‚è¿™å…·æœ‰å¾®å¦™ä½†éå¸¸å¼ºå¤§çš„å«ä¹‰ã€‚ä¾‹å¦‚æˆ‘ä»¬è€ƒè™‘ä¼šè¯é›†ç¾¤ã€‚æœ‰å¤šå°‘ä»¥æŒ‡å®šå®¹å™¨çš„æ–¹å¼æ¥é›†ç¾¤ä¼šè¯ä»¥è¿›è¡Œå®¹é”™å’Œæ•…éšœè½¬ç§»ï¼ŸTomcatå’ŒJettyåšçš„ä¸ä¸€æ ·ï¼Œå’ŒWebsphereä¹Ÿä¸ä¸€æ ·ã€‚ä½†æ˜¯ä½¿ç”¨Shiro sessionï¼Œä½ å¯ä»¥è·å¾—ä¸€ä¸ªå®¹å™¨æ— å…³çš„é›†ç¾¤è§£å†³æ–¹æ¡ˆã€‚Shiroçš„æ¶æ„å…è®¸å¯æ’æ‹”çš„ä¼šè¯æ•°æ®å­˜å‚¨ï¼Œä¾‹å¦‚ä¼ä¸šçº§ç¼“å­˜ï¼Œå…³ç³»å‹æ•°æ®åº“ã€‚NoSQLç­‰ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ä¸€æ¬¡é…ç½®ä¼šè¯ç¾¤é›†ï¼Œå¹¶ä¸”æ— è®ºä½ çš„éƒ¨ç½²ç¯å¢ƒå¦‚ä½•ï¼Œå®ƒéƒ½å°†ä»¥ç›¸åŒçš„æ–¹å¼å·¥ä½œâ€“Tomcatã€Jettyã€JEE Serveræˆ–è€…ç‹¬ç«‹çš„åº”ç”¨ã€‚å®åœ¨æ˜¯æ²¡ç”¨å¿…è¦æ ¹æ®ä½ æ€ä¹ˆéƒ¨ç½²ä½ çš„åº”ç”¨æ¥é‡æ–°é…ç½®ä½ çš„åº”ç”¨ã€‚</p>
<p>å¦ä¸€ä¸ªShiro sessionçš„å¥½å¤„æ˜¯sessionæ•°æ®å¦‚æœéœ€è¦å¯ä»¥è·¨å®¢æˆ·ç«¯å…±äº«ã€‚ä¸¾ä¸ªæ —å­ï¼Œå¦‚æœéœ€è¦ï¼ŒSwingæ¡Œé¢å®¢æˆ·ç«¯å¯ä»¥å‚ä¸ç›¸åŒçš„Webåº”ç”¨ç¨‹åºä¼šè¯â€“å¦‚æœç»ˆç«¯ç”¨æˆ·åŒæ—¶ä½¿ç”¨ä¸¤è€…ï¼Œåˆ™å¾ˆæœ‰ç”¨ã€‚å› æ­¤ä½ æ€æ ·åœ¨ä»»ä½•ç¯å¢ƒä¸‹è®¿é—®ä¸»ä½“çš„sessionï¼Ÿä¸‹é¢çš„ä»£ç ä¸»ä½“çš„2ä¸ªæ–¹æ³•ä¼šå±•ç¤ºå‡ºæ¥ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Session session = subject.getSession();</div><div class="line">Session session = subject.getSession(boolean create);</div></pre></td></tr></table></figure></p>
<p>å¦‚ä½ æ‰€è§ï¼Œè¿™äº›æ–¹æ³•åœ¨æ¦‚å¿µä¸Šä¸HttpServletRequest APIç›¸åŒã€‚ç¬¬ä¸€ä¸ªæ–¹æ³•å°†ä¼šè¿”å›ä¸»ä½“å­˜åœ¨çš„sessionï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£å°±åˆ›å»ºä¸€ä¸ªå†è¿”å›ã€‚ç¬¬äºŒä¸ªæ–¹æ³•æ¥æ”¶ä¸€ä¸ªboolå‚æ•°ï¼Œè¿™ä¸ªå‚æ•°å†³å®šæ˜¯å¦åœ¨sessionä¸å­˜åœ¨çš„æ—¶å€™åˆ›å»ºæ–°çš„sessionã€‚ä¸€æ—¦ä½ è¯·æ±‚ä¸»ä½“çš„sessionï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒå’Œå‡ ä¹ä½¿ç”¨HttpSessionä¸€æ ·ã€‚Shiroå›¢é˜Ÿè€ƒè™‘åˆ°HTTPSessionå¯¹Javaå¼€å‘äººå‘˜å¾ˆå‹å¥½ï¼Œå› æ­¤æˆ‘ä»¬æœ‰è¿™ç§æ„Ÿè§‰ã€‚æœ€å¤§çš„åŒºåˆ«å°±æ˜¯ä½ å¯ä»¥åœ¨ä»»ä½•åº”ç”¨ä¸­ä½¿ç”¨Shiro Sessionï¼Œä¸ä»…é™äºwebåº”ç”¨ã€‚ä¸‹é¢çš„ä»£ç å±•ç¤ºäº†å…¶ç›¸åŒä¹‹å¤„ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Session session = subject.getSession();</div><div class="line">session.getAttribute(â€œkeyâ€, someValue);</div><div class="line">Date start = session.getStartTimestamp();</div><div class="line">Date timestamp = session.getLastAccessTime();</div><div class="line">session.setTimeout(millis);</div></pre></td></tr></table></figure></p>
<h4 id="Cryptography"><a href="#Cryptography" class="headerlink" title="Cryptography"></a>Cryptography</h4><p>å¯†ç å­¦æ˜¯éšè—æˆ–æ··æ·†æ•°æ®çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥çª¥æ¢çœ¼ç›æ— æ³•ç†è§£å®ƒã€‚Shiroåœ¨å¯†ç å­¦ä¸­çš„ç›®æ ‡æ˜¯ç®€åŒ–å’Œä½¿ç”¨JDKçš„åŠ å¯†æ”¯æŒã€‚è¦æ³¨æ„çš„æ˜¯ï¼Œä¸€èˆ¬æ¥è¯´å¯†ç å­¦å¯¹äºä¸»ä½“æ¥è¯´ä¸æ˜¯ç‰¹å®šçš„ï¼Œæ‰€ä»¥å®ƒæ˜¯Shiro APIçš„ä¸€ä¸ªé¢†åŸŸï¼Œå’Œä¸»ä½“æ— å…³ã€‚ä½ å¯ä»¥ä½¿ç”¨Shiroçš„åŠ å¯†ç”¨åœ¨ä»»ä½•åœ°æ–¹ï¼Œå³ä½¿ä¸»ä½“æ²¡æœ‰ä½¿ç”¨ã€‚ShiroçœŸæ­£å…³æ³¨çš„ä¸¤ä¸ªé¢†åŸŸä¸€ä¸ªæ˜¯å“ˆå¸ŒåŠ å¯†å’Œå¯†ç åŠ å¯†ã€‚</p>
<h5 id="Hashing"><a href="#Hashing" class="headerlink" title="Hashing"></a>Hashing</h5><p>å¦‚æœä½ ç”¨è¿‡JDKçš„MessageDigestç±»ï¼Œä½ å¾ˆå¿«ä¼šå‘ç°ç”¨èµ·æ¥æœ‰ä¸€ç‚¹ç¬¨é‡ã€‚å®ƒæœ‰ä¸€å¥—åŸºäºå·¥å‚çš„ç¬¨é‡çš„é™æ€æ–¹æ³•APIï¼Œè€Œä¸æ˜¯é¢å‘å¯¹è±¡çš„ï¼Œè€Œä¸”ä½ è¢«è¿«æ•è·é‚£äº›æ°¸è¿œä¸ä¼šè¢«æ•è·çš„å¼‚å¸¸ã€‚å‡å¦‚ä½ éœ€è¦16è¿›åˆ¶æˆ–è€…base64ç¼–ç æ¶ˆæ¯æ‘˜è¦çš„è¾“å‡ºï¼Œä½ å¾—è‡ªå·±å†™â€“æ²¡æœ‰æ ‡å‡†çš„JDKå®ç°ã€‚Shiroä»¥å¹²å‡€ç›´è§‚çš„æ•£åˆ—APIè§£å†³äº†è¿™äº›é—®é¢˜ã€‚</p>
<p>æ‰“ä¸ªæ¯”æ–¹ï¼Œæˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹æ¯”è¾ƒå¸¸è§çš„MD5æ•£åˆ—æ–‡ä»¶å¹¶ç¡®å®šè¯¥å“ˆå¸Œå€¼çš„åå…­è¿›åˆ¶å€¼çš„æƒ…å†µã€‚â€œæ ¡éªŒå’Œâ€ï¼Œè¿™æ˜¯åœ¨æä¾›æ–‡ä»¶ä¸‹è½½æ—¶ç»å¸¸ä½¿ç”¨çš„ - ç”¨æˆ·å¯ä»¥åœ¨ä¸‹è½½çš„æ–‡ä»¶ä¸Šæ‰§è¡Œè‡ªå·±çš„MD5å“ˆå¸Œï¼Œå¹¶å£°æ˜å…¶æ ¡éªŒå’Œä¸ä¸‹è½½ç«™ç‚¹çš„æ ¡éªŒå’ŒåŒ¹é…ã€‚å‡å¦‚åŒ¹é…ï¼Œç”¨æˆ·å¯ä»¥å……åˆ†åœ°å‡è®¾è¯¥æ–‡ä»¶åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ²¡æœ‰è¢«ç¯¡æ”¹ã€‚</p>
<p>åœ¨ä¸ä½¿ç”¨Shiroæƒ…å†µä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼š</p>
<ol>
<li>å°†æ–‡ä»¶è½¬åŒ–ä¸ºå­—èŠ‚æ•°ç»„ã€‚JDKä¸èƒ½å¸®ä½ å®Œæˆï¼Œå› æ­¤ä½ å¾—è‡ªå·±åˆ›å»ºä¸€ä¸ªæ‰“å¼€FileInputStreamçš„æ–¹æ³•ï¼Œä½¿ç”¨å­—èŠ‚ç¼“å†²ï¼Œç„¶åæŠ›å‡ºå¯èƒ½çš„å¼‚å¸¸ç­‰ç­‰ã€‚</li>
<li>ç”¨MessageDigestç±»æ¥å¯¹å­—èŠ‚æ•°ç»„æ±‚å“ˆå¸Œï¼Œå¤„ç†å¼‚å¸¸ã€‚</li>
<li>å¯¹å“ˆå¸Œåçš„å­—èŠ‚æ•°ç»„ç¼–ç æˆ16è¿›åˆ¶ã€‚JDKä¸­ä¹Ÿæ²¡æœ‰ç°æˆçš„å¸®ä½ å®Œæˆï¼Œå› æ­¤ä½ å¾—åˆ›å»ºå¦ä¸€ä¸ªå¸®åŠ©ç±»ï¼Œå¹¶ä¸”å¯èƒ½åœ¨ä½ çš„å®ç°ä¸­ä½¿ç”¨æŒ‰ä½æ“ä½œå’Œä½ç§»ã€‚</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">try &#123;</div><div class="line">    MessageDigest md = MessageDigest.getInstance(&quot;MD5&quot;);</div><div class="line">    md.digest(bytes);</div><div class="line">    byte[] hashed = md.digest();</div><div class="line">&#125; catch (NoSuchAlgorithmException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹äºè¿™ä¹ˆç®€å•å’Œç›¸å¯¹æ™®éçš„äº‹æƒ…æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆç¹ççš„å·¥ä½œã€‚<br>çœ‹çœ‹Shiroæ€ä¹ˆåšç›¸åŒçš„äº‹æƒ…çš„ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">String hex = new Md5Hash(myFile).toHex();</div></pre></td></tr></table></figure></p>
<p>å½“ä½ ä½¿ç”¨Shiroæ¥ç®€åŒ–æ‰€æœ‰è¿™äº›å·¥ä½œæ—¶ï¼Œè¿™æ˜¯éå¸¸ç®€å•å’Œå®¹æ˜“ç†è§£çš„ã€‚  SHA-512æ•£åˆ—å’ŒBase64ç¼–ç çš„å¯†ç åŒæ ·ç®€å•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">String encodedPassword =</div><div class="line">    new Sha512Hash(password, salt, count).toBase64();</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°åœ¨å“ˆå¸Œå’Œç¼–ç ä¸ŠShiroå¸®ä½ ç®€åŒ–äº†å¤šå°‘ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­èŠ‚çœäº†ä½ ä¸å°‘æ—¶é—´ã€‚</p>
<h5 id="Ciphers"><a href="#Ciphers" class="headerlink" title="Ciphers"></a>Ciphers</h5><p>å¯†ç æ˜¯å¯ä»¥ä½¿ç”¨å¯†é’¥å¯é€†åœ°è½¬æ¢æ•°æ®çš„åŠ å¯†ç®—æ³•ã€‚æˆ‘ä»¬é€šå¸¸ç”¨ä½œä¿æŠ¤æ•°æ®å®‰å…¨ï¼Œç‰¹åˆ«åœ¨ä¼ è¾“æˆ–è€…å­˜å‚¨æ•°æ®çš„æ—¶å€™ï¼Œæ•°æ®ç‰¹åˆ«å®¹æ˜“è¢«çª¥æ¢ã€‚</p>
<p>å¦‚æœä½ æ›¾ç»ä½¿ç”¨è¿‡JDKåŠ å¯†APIï¼Œç‰¹åˆ«æ˜¯ javax.crypto.Cipherç±»ï¼Œä½ çŸ¥é“è¿™å¯ä»¥æ˜¯ä¸€ä¸ªéš¾ä»¥ç½®ä¿¡çš„å¤æ‚é‡å…½é©¯æœï¼ˆç¿»è¯‘ä¸ºè¿™æ˜¯ä¸€ä¸ªå¾ˆå›°éš¾çš„è¿‡ç¨‹ï¼‰ã€‚å¯¹äºå…¥é—¨è€…è€Œè¨€ï¼Œæ¯ä¸ªå¯†ç é…ç½®å§‹ç»ˆç”±javax.crypto.Cipherçš„ä¸€ä¸ªå®ä¾‹è¡¨ç¤ºã€‚éœ€è¦å…¬é’¥/ç§é’¥åŠ å¯†å—ï¼Ÿ</p>
<p>ç„¶è€Œæ€ä¹ˆåˆ›å»ºä½ éœ€è¦çš„Cipher å®ä¾‹ï¼Ÿä½ åˆ›å»ºä¸€ä¸ªå¤æ‚çš„ï¼Œéç›´è§‚çš„ä»¤ç‰Œåˆ†éš”çš„å¯†ç é€‰é¡¹å­—ç¬¦ä¸²ï¼Œç§°ä¸ºâ€œè½¬æ¢å­—ç¬¦ä¸²â€ï¼Œå¹¶å°†æ­¤å­—ç¬¦ä¸²ä¼ é€’ç»™Cipher.getInstanceé™æ€å·¥å‚æ–¹æ³•ã€‚ä½¿ç”¨è¿™ç§å¯†ç é€‰é¡¹Stringæ–¹æ³•ï¼Œæ²¡æœ‰ç±»å‹å®‰å…¨æ€§æ¥ç¡®ä¿ä½ ä½¿ç”¨æœ‰æ•ˆçš„é€‰é¡¹ã€‚è¿™ä¹Ÿéšå«æ„å‘³ç€æ²¡æœ‰JavaDocå¸®åŠ©ä½ äº†è§£ç›¸å…³é€‰é¡¹ã€‚è€Œä¸”æ‚¨è¿˜éœ€è¦å¤„ç†æ£€æŸ¥çš„å¼‚å¸¸æƒ…å†µï¼Œä»¥é˜²ä½ çš„Stringé…ç½®ä¸æ­£ç¡®ï¼Œå³ä½¿ä½ çŸ¥é“é…ç½®æ­£ç¡®ã€‚æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œä½¿ç”¨JDKå¯†ç æ˜¯ä¸€é¡¹ç›¸å½“éº»çƒ¦çš„ä»»åŠ¡ã€‚è¿™äº›æŠ€æœ¯æ›¾ç»æ˜¯Java APIåœ¨å¾ˆä¹…ä»¥å‰çš„æ ‡å‡†ï¼Œä½†æ—¶ä»£å·²ç»æ”¹å˜ï¼Œæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªæ›´ç®€å•çš„æ–¹æ³•ã€‚</p>
<p>Shiroå°è¯•é€šè¿‡å¼•å…¥å…¶CipherService APIæ¥ç®€åŒ–åŠ å¯†å¯†ç çš„æ•´ä¸ªæ¦‚å¿µã€‚CipherServiceæ˜¯å¤§å¤šæ•°å¼€å‘äººå‘˜åœ¨ä¿æŠ¤æ•°æ®æ—¶æ‰€éœ€è¦çš„ï¼šä¸€ç§ç®€å•ï¼Œæ— çŠ¶æ€ï¼Œçº¿ç¨‹å®‰å…¨çš„APIï¼Œå¯ä»¥åœ¨ä¸€ä¸ªæ–¹æ³•è°ƒç”¨ä¸­å¯¹æ•°æ®è¿›è¡Œå…¨é¢åŠ å¯†æˆ–è§£å¯†ã€‚æ‰€æœ‰ä½ éœ€è¦åšçš„æ˜¯æä¾›ä½ çš„å¯†é’¥ï¼Œå¯ä»¥æ ¹æ®éœ€è¦è¿›è¡ŒåŠ å¯†æˆ–è§£å¯†ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨256ä½AESåŠ å¯†ï¼š</p>
<blockquote>
<p>AesCipherService cipherService = new AesCipherService();<br>cipherService.setKeySize(256);<br>//create a test key:<br>byte[] testKey = cipherService.generateNewKey();<br>//encrypt a fileâ€™s bytes:<br>byte[] encrypted =<br>    cipherService.encrypt(fileBytes, testKey);</p>
</blockquote>
<p>ä¸JDKçš„Cipher APIç›¸æ¯”ï¼ŒShiroç¤ºä¾‹æ›´ç®€å•:</p>
<ul>
<li>ä½ å¯ä»¥ç›´æ¥å®ä¾‹åŒ–CipherService  - æ²¡æœ‰å¥‡æ€ªæˆ–æ··ä¹±çš„å·¥å‚æ–¹æ³•ã€‚</li>
<li>å¯†ç é…ç½®é€‰é¡¹è¡¨ç¤ºä¸ºä¸JavaBeanså…¼å®¹çš„getterå’Œsetter  - æ²¡æœ‰å¥‡æ€ªå’Œéš¾ä»¥ç†è§£çš„â€œè½¬æ¢å­—ç¬¦ä¸²â€ã€‚</li>
<li>åŠ å¯†å’Œè§£å¯†åœ¨å•ä¸€æ–¹æ³•è°ƒç”¨ä¸­æ‰§è¡Œã€‚</li>
<li>æ²¡æœ‰å¼ºåˆ¶æ£€æŸ¥å¼‚å¸¸ã€‚ å¦‚æœä½ æƒ³è¦çš„è¯ï¼Œå¯ä»¥æ•è·Shiroçš„CryptoExceptionã€‚</li>
</ul>
<p>Shiroçš„CipherService APIè¿˜æœ‰å…¶ä»–ä¼˜ç‚¹ï¼Œä¾‹å¦‚æ”¯æŒåŸºäºå­—èŠ‚æ•°ç»„çš„åŠ å¯†/è§£å¯†ï¼ˆç§°ä¸ºâ€œå—â€æ“ä½œï¼‰ä»¥åŠåŸºäºæµçš„åŠ å¯†/è§£å¯†ï¼ˆä¾‹å¦‚ï¼ŒåŠ å¯†éŸ³é¢‘æˆ–è§†é¢‘ï¼‰çš„èƒ½åŠ›ã€‚</p>
<p>JavaåŠ å¯†æŠ€æœ¯ä¸å¿…å¦‚æ­¤éš¾å—ã€‚<br>Shiroå¯¹å¯†ç çš„æ”¯æŒæ—¨åœ¨ç®€åŒ–ä½ ä¿æŠ¤æ•°æ®å®‰å…¨çš„ä»˜å‡ºã€‚</p>
<h4 id="Web-Support"><a href="#Web-Support" class="headerlink" title="Web Support"></a>Web Support</h4><p>æœ€åï¼Œä½†ä¸æ˜¯ä¸é‡è¦çš„ï¼Œæˆ‘ä»¬ç®€è¦ä»‹ç»Shiroå¯¹webçš„æ”¯æŒã€‚Shiroæ‹¥æœ‰å¼ºå¤§çš„webæ”¯æŒæ¨¡å—ï¼Œæ¥ä¿æŠ¤webåº”ç”¨å®‰å…¨ã€‚ä¸ºä¸€ä¸ªwebåº”ç”¨è®¾ç½®Shiroæ˜¯å¾ˆç®€å•çš„ã€‚ä»…éœ€è¦åœ¨web.xmlä¸­å®šä¹‰ä¸€ä¸ªShiro Servlet Filterã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">    &lt;filter-name&gt;ShiroFilter&lt;/filter-name&gt;</div><div class="line">    &lt;filter-class&gt;</div><div class="line">        org.apache.shiro.web.servlet.IniShiroFilter</div><div class="line">    &lt;/filter-class&gt;</div><div class="line">    &lt;!-- no init-param means load the INI config</div><div class="line">        from classpath:shiro.ini --&gt; </div><div class="line">&lt;/filter&gt;</div><div class="line">&lt;filter-mapping&gt;</div><div class="line">     &lt;filter-name&gt;ShiroFilter&lt;/filter-name&gt;</div><div class="line">     &lt;url-pattern&gt;/*&lt;/url-pattern&gt;</div><div class="line">&lt;/filter-mapping&gt;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªè¿‡æ»¤å™¨èƒ½å¤Ÿè¯»ä¹‹å‰çš„shiro.inié…ç½®æ–‡ä»¶ï¼Œå› æ­¤æ— è®ºåœ¨ä»€ä¹ˆæ ·çš„éƒ¨ç½²ç¯å¢ƒä¸‹ï¼Œé…ç½®éƒ½æ˜¯ä¸€æ ·çš„ã€‚ä¸€æ—¦é…ç½®å¥½äº†ï¼ŒShiro filterå°±ä¼šè¿‡æ»¤ä¸€åˆ‡è¯·æ±‚ï¼Œå¹¶ç¡®ä¿åœ¨è¯·æ±‚æœŸé—´ç‰¹å®šçš„è¯·æ±‚ä¸»ä½“å¯è¢«è®¿é—®ã€‚ç”±äºè¿‡æ»¤æ‰€æœ‰è¯·æ±‚ï¼Œä½ å¯ä»¥æ‰§è¡ŒæŒ‡å®šå®‰å…¨çš„é€»è¾‘ä»£ç ï¼Œä»¥ç¡®ä¿ä»…å…è®¸ç¬¦åˆç‰¹å®šæ¡ä»¶çš„è¯·æ±‚ã€‚</p>
<h4 id="URL-Specific-Filter-Chains"><a href="#URL-Specific-Filter-Chains" class="headerlink" title="URL-Specific Filter Chains"></a>URL-Specific Filter Chains</h4><p>Shiroé€šè¿‡å®ƒç‰¹æœ‰çš„URLé“¾æ¥æ”¯æŒå®‰å…¨çš„è¿‡æ»¤è§„åˆ™ã€‚å®ƒå…è®¸ä½ ä¸ºä»»ä½•åŒ¹é…çš„URLæ¨¡å¼æŒ‡å®šç‰¹æ®Šè¿‡æ»¤å™¨é“¾ã€‚è¿™æ„å‘³ç€åœ¨ä½¿ç”¨Shiroè¿‡æ»¤æœºåˆ¶çš„æ—¶å€™ä½ æœ‰å¾ˆå¤§çš„çµæ´»æ€§â€“æ¯”åœ¨web.xmlä¸­å®šä¹‰çš„è¿‡æ»¤å™¨å¥½å¾ˆå¤šã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[urls]</div><div class="line">/assets/** = anon</div><div class="line">/user/signup = anon</div><div class="line">/user/** = user</div><div class="line">/rpc/rest/** = perms[rpc:invoke], authc</div><div class="line">/** = authc</div></pre></td></tr></table></figure></p>
<p>å¦‚ä½ æ‰€è§ï¼Œæœ‰ä¸€ä¸ªç”¨äºwebåº”ç”¨çš„[urls]éƒ¨åˆ†ã€‚æ¯ä¸€è¡Œç­‰å·çš„å·¦è¾¹è¡¨ç¤ºä¸€ä¸ªä¸Šä¸‹æ–‡ç›¸å…³çš„webåº”ç”¨è·¯å¾„ã€‚ç­‰å·å³è¾¹å®šä¹‰äº†ä¸€ä¸ªè¿‡æ»¤å™¨é“¾â€“æœ‰åºçš„ã€é€—å·åˆ†éš”çš„ä¸ºæŒ‡å®šè·¯å¾„æ‰§è¡Œservletè¿‡æ»¤å™¨åˆ—è¡¨ã€‚æ¯ä¸€ä¸ªè¿‡æ»¤å™¨æ˜¯ä¸€ä¸ªservlet filterï¼Œä½†æ˜¯ä½ åœ¨ä¸Šè¿°çœ‹åˆ°çš„è¿‡æ»¤å™¨æ˜¯ç‰¹æ®Šçš„ï¼Œæ˜¯ä¸å®‰å…¨ç›¸å…³çš„ç”±Shiroæä¾›å¼€ç®±å³ç”¨çš„è¿‡æ»¤å™¨ã€‚ä½ å¯ä»¥ç»„åˆå’ŒåŒ¹é…è¿™äº›å®‰å…¨è¿‡æ»¤å™¨ï¼Œä»¥åˆ›å»ºè‡ªå®šä¹‰çš„å®‰å…¨ä½“éªŒã€‚ä½ è¿˜å¯ä»¥æŒ‡å®šä»»ä½•å…¶ä»–ç°æœ‰çš„å¯èƒ½æ‹¥æœ‰çš„Servletè¿‡æ»¤å™¨ã€‚</p>
<p>ä½¿ç”¨Shiroï¼Œæ›´å®¹æ˜“çœ‹å‡ºä¸ºç»™å®šçš„åŒ¹é…è·¯å¾„æ‰§è¡Œçš„è¿‡æ»¤å™¨é“¾ã€‚åªè¦ä½ æƒ³ï¼Œä½ å¯ä»¥åªåœ¨web.xmlä¸­å®šä¹‰Shiro filterç„¶ååœ¨inié…ç½®æ–‡ä»¶ä¸­å®šä¹‰å…¶ä»–è¿‡æ»¤å™¨å’Œè¿‡æ»¤å™¨é“¾ï¼Œè¿™æ ·æ¯”web.xmlæ›´ç®€æ´ï¼Œæ˜“äºç†è§£çš„è¿‡æ»¤å™¨é“¾å®šä¹‰æœºåˆ¶ã€‚å³ä½¿ä½ æ²¡æœ‰ä½¿ç”¨ä»»ä½•Shiroçš„å®‰å…¨ç‰¹æ€§ï¼Œè¿™ä¸ªå°å°çš„æ–¹ä¾¿è®©Shiroå€¼å¾—ä½¿ç”¨ã€‚</p>
<h4 id="JSP-Tag-Library"><a href="#JSP-Tag-Library" class="headerlink" title="JSP Tag Library"></a>JSP Tag Library</h4><p>Shiroè¿˜æä¾›ä¸€å¥—JSPæ ‡ç­¾æ¥å…è®¸ä½ åŸºäºå½“å‰ä¸»ä½“çš„çŠ¶æ€æ§åˆ¶é¡µé¢è¾“å‡ºã€‚ä¸€ä¸ªå¸¸è§æœ‰ç”¨çš„ä¾‹å­å°±æ˜¯å½“ä¸€ä¸ªç”¨æˆ·ç™»å½•åæ˜¾ç¤ºâ€˜Hello <username>â€™æ–‡æœ¬ã€‚ä½†æ˜¯å‡å¦‚ä»–ä»¬æ˜¯åŒ¿åçš„ï¼Œä½ å°±å¾—æ˜¾ç¤ºç‚¹åˆ«çš„ï¼Œåƒâ€œHello! Register Today!â€ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;%@ taglib prefix=&quot;shiro&quot;</div><div class="line">    uri=&quot;http://shiro.apache.org/tags&quot; %&gt;</div><div class="line">...</div><div class="line">&lt;p&gt;Hello</div><div class="line">&lt;shiro:user&gt;</div><div class="line">    &lt;!-- shiro:principal prints out the Subjectâ€™s main</div><div class="line">        principal - in this case, a username: --&gt;</div><div class="line">    &lt;shiro:principal/&gt;!</div><div class="line">&lt;/shiro:user&gt;</div><div class="line">&lt;shiro:guest&gt;</div><div class="line">    &lt;!-- not logged in - considered a guest. Show</div><div class="line">        the register link: --&gt;</div><div class="line">    ! &lt;a href=â€register.jspâ€&gt;Register today!&lt;/a&gt;</div><div class="line">&lt;/shiro:guest&gt;</div><div class="line">&lt;/p&gt;</div></pre></td></tr></table></figure></username></p>
<p>è¿˜æœ‰å…¶ä»–æ ‡ç­¾åŸºäºç”¨æˆ·æœ‰å“ªäº›è§’è‰²æˆ–è€…æ²¡æœ‰å“ªäº›è§’è‰²ï¼Œåˆ†é…äº†å“ªäº›æƒé™ï¼Œæœ‰æ²¡æœ‰è¢«è®¤è¯ï¼Œâ€œè®°ä½æˆ‘â€äº†çš„ï¼Œæˆ–è€…ä¸€ä¸ªåŒ¿åç”¨æˆ·æ¥å…è®¸ä½ è¾“å‡ºã€‚<br>Shiroæ”¯æŒå¾ˆå¤šwebç‰¹æœ‰çš„featureï¼Œåƒè®°ä½æˆ‘ï¼ŒRESTå’ŒBASICè®¤è¯ï¼Œå½“ç„¶ï¼Œå¦‚æœä½ å¸Œæœ›ä½¿ç”¨Shiroçš„æœ¬åœ°ä¼ä¸šä¼šè¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨é€æ˜çš„HttpSessionæ”¯æŒã€‚å‚è§<a href="http://shiro.apache.org/web.html" target="_blank" rel="external">Apache Shiro web documentation</a></p>
<h4 id="Web-Session-Management"><a href="#Web-Session-Management" class="headerlink" title="Web Session Management"></a>Web Session Management</h4><p>æœ€åï¼Œæœ‰è¶£çš„æ˜¯æ¢è®¨Shiroåœ¨webç¯å¢ƒä¸­å¯¹sessionçš„æ”¯æŒã€‚</p>
<h5 id="Default-Http-Sessions"><a href="#Default-Http-Sessions" class="headerlink" title="Default Http Sessions"></a>Default Http Sessions</h5><p>å¯¹webåº”ç”¨è€Œè¨€ï¼ŒShiroé»˜è®¤çš„sessionæ¶æ„æ˜¯æˆ‘ä»¬ç°æœ‰å¸¸ä½¿ç”¨çš„Servlet Containerã€‚å½“ä½ è°ƒç”¨<code>subject.getSession()</code>å’Œ<code>subject.getSession(boolean)</code>æ–¹æ³•çš„æ—¶å€™ï¼ŒShiroä¼šè¿”å›ä¸€ä¸ªç”±Servlet å®¹å™¨æ”¯æŒçš„sessionå®ä¾‹ã€‚è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯è°ƒç”¨subject.getSessionï¼ˆï¼‰çš„ä¸šåŠ¡å±‚ä»£ç ä¸Shiro Sessionå®ä¾‹è¿›è¡Œäº¤äº’â€“å®ƒå¹¶ä¸çŸ¥é“æ˜¯å’Œä¸€ä¸ªåŸºäºwebçš„HTTPSessionå¯¹è±¡ä¸€èµ·å·¥ä½œçš„ã€‚åˆ†å±‚æ¶æ„ä¿æŒä»£ç æ•´æ´æ˜¯å¾ˆå¥½çš„åšæ³•ã€‚</p>
<h5 id="Shiroâ€™s-Native-Sessions-in-the-Web-Tier"><a href="#Shiroâ€™s-Native-Sessions-in-the-Web-Tier" class="headerlink" title="Shiroâ€™s Native Sessions in the Web Tier"></a>Shiroâ€™s Native Sessions in the Web Tier</h5><p>å‡å¦‚ä½ åœ¨webåº”ç”¨ä¸­å¼€å¯äº†Shiroçš„æœ¬åœ°sessionç®¡ç†ï¼Œä½ éœ€è¦Shiroçš„ä¼ä¸šsessionç‰¹æ€§ï¼ˆç±»ä¼¼ç‹¬ç«‹äºå®¹å™¨çš„é›†ç¾¤ï¼‰ï¼Œå½“ç„¶ä½ æƒ³<code>HttpServletRequest.getSession()</code> å’Œ<code>HttpSession</code> APIå’Œæœ¬åœ°sessionä¸€èµ·ä½¿ç”¨è€Œä¸æ˜¯servletå®¹å™¨çš„sessionã€‚å¦‚æœä½ è¦é‡æ„ä»»ä½•ä½¿ç”¨HttpServletRequestå’ŒHttpSession APIçš„ä»£ç ï¼Œè€Œä¸æ˜¯ä½¿ç”¨Shiroçš„Session APIï¼Œé‚£å°†æ˜¯éå¸¸ä»¤äººæ²®ä¸§çš„ã€‚Shiroæ°¸è¿œä¸æœŸæœ›ä½ è¿™æ ·åšã€‚ç›¸åï¼ŒShiroå®Œå…¨å®ç°äº†Servletè§„èŒƒçš„Sessionéƒ¨åˆ†ï¼Œä»¥æ”¯æŒWebåº”ç”¨ç¨‹åºä¸­çš„æœ¬æœºä¼šè¯ã€‚è¿™æ„å‘³ç€æ¯å½“ä½ è°ƒç”¨ç›¸åº”çš„HttpServletRequestæˆ–HttpSessionæ–¹æ³•è°ƒç”¨æ—¶ï¼ŒShiroä¼šå°†è¿™äº›è°ƒç”¨å§”æ‰˜ç»™å…¶å†…éƒ¨æœ¬åœ°Session APIã€‚ç»“æœå°±æ˜¯ä½ ä¸éœ€è¦å»æ”¹åŠ¨ä½ çš„ä»£ç ï¼Œå³ä½¿ä½ ä½¿ç”¨Shiroæœ¬åœ°ä¼šè¯ç®¡ç†â€“å®é™…ä¸Šæ˜¯ä¸€ä¸ªéå¸¸æ–¹ä¾¿å’Œå¿…è¦çš„ç‰¹æ€§ã€‚</p>
<h3 id="Additional-Features"><a href="#Additional-Features" class="headerlink" title="Additional Features"></a>Additional Features</h3><p>åœ¨Shiroæ¡†æ¶ä¸­å…¶ä»–ç”¨äºè®©Javaåº”ç”¨å®‰å…¨çš„ç‰¹æ€§ï¼Œä¾‹å¦‚ï¼ˆä¸­æ–‡ç¿»è¯‘å¤ªæ™¦æ¶©ï¼Œè¿˜æ˜¯ç›´æ¥è´´åŸæ–‡çš„ï¼‰ï¼š</p>
<ul>
<li>Threading and Concurrency support for maintaining Subjects across threads (Executor and ExecutorService support)</li>
<li>Callable and Runnable support for executing logic as a specific Subject</li>
<li>â€œRun Asâ€ support for assuming the identity of another Subject (e.g. useful in administrative applications)</li>
<li>Test harness support, making it very easy to have full testing of Shiro secured-code in unit and integration tests</li>
</ul>
<h3 id="Framework-Limitations"><a href="#Framework-Limitations" class="headerlink" title="Framework Limitations"></a>Framework Limitations</h3><p>å°±åƒæˆ‘ä»¬æƒ³è¦çš„é‚£æ ·ï¼ŒApache Shiroä¸æ˜¯ä¸€ä¸ªâ€œé“¶å¼¹â€â€“å®ƒä¸ä¼šè½»æ˜“è§£å†³æ‰€æœ‰å®‰å…¨é—®é¢˜ã€‚Shiroæ²¡æœ‰è§£å†³è¿™äº›äº‹æƒ…:</p>
<ul>
<li>è™šæ‹Ÿæœºçº§åˆ«çš„è€ƒè™‘ï¼šå½“å‰Shiroæ²¡æœ‰è€ƒè™‘è™šæ‹Ÿæœºçº§åˆ«çš„å®‰å…¨ï¼Œæ¯”å¦‚åŸºäºè®¿é—®æ§åˆ¶ç­–ç•¥çš„é˜»æ­¢ç‰¹å®šçš„classåŠ è½½åˆ°ç±»åŠ è½½å™¨ä¸­ã€‚ç„¶è€ŒShiroå’Œç°æœ‰çš„JVMå®‰å…¨æ“ä½œæ•´åˆèµ·æ¥æ˜¯ä¸å¯æ€è®®çš„â€“åªæ˜¯æ²¡æœ‰äººå»ä¸ºè¿™ä¸ªé¡¹ç›®åšè¿™ä»¶äº‹ç½¢äº†ã€‚</li>
<li>å¤šé˜¶æ®µè®¤è¯ï¼šShiroå½“å‰ä¸æ”¯æŒâ€˜å¤šé˜¶æ®µâ€™è®¤è¯ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ä¸€ç§æœºåˆ¶ç™»å½•ï¼Œåªèƒ½è¢«è¦æ±‚ä½¿ç”¨ä¸åŒçš„æœºåˆ¶å†æ¬¡ç™»å½•ã€‚è¿™å·²ç»åœ¨åŸºäºShiroçš„åº”ç”¨ç¨‹åºä¸­å®Œæˆï¼Œä½†åº”ç”¨ç¨‹åºé€šè¿‡åº”ç”¨ç¨‹åºæ”¶é›†æ‰€æœ‰å¿…éœ€çš„ä¿¡æ¯ï¼Œç„¶åä¸Shiroè¿›è¡Œäº¤äº’ã€‚å¾ˆå¯èƒ½åœ¨æœªæ¥çš„ç‰ˆæœ¬ä¸­ä¼šæœ‰è¿™ç§æ”¯æŒã€‚</li>
<li>å†™åŸŸæ“ä½œï¼šå½“å‰æ‰€æœ‰çš„åŸŸå®ç°æ”¯æŒè¯»æ“ä½œæ¥è·å–è®¤è¯å’Œæˆæƒæ•°æ®ç”¨æ¥æ‰§è¡Œç™»å½•å’Œè®¿é—®æ§åˆ¶ã€‚å†™æ“ä½œï¼Œåƒåˆ›å»ºç”¨æˆ·ï¼Œç»„å’Œè§’è‰²æˆ–è€…å°†ç”¨æˆ·å’Œè§’è‰²ç»„åŠæƒé™å…³è”èµ·æ¥éƒ½æ˜¯ä¸æ”¯æŒçš„ã€‚è¿™æ˜¯å› ä¸ºæ”¯æŒè¿™äº›æ“ä½œçš„æ•°æ®æ¨¡å‹åœ¨åº”ç”¨ç¨‹åºä¸­æœ‰å¾ˆå¤§å·®å¼‚ï¼Œæ‰€ä»¥åœ¨æ‰€æœ‰Shiroç”¨æˆ·ä¸Šæ‰§è¡Œâ€œå†™å…¥â€APIå°†æ˜¯å›°éš¾çš„ã€‚</li>
</ul>
<h3 id="Upcoming-Features"><a href="#Upcoming-Features" class="headerlink" title="Upcoming Features"></a>Upcoming Features</h3><p>Shiroçš„ç¤¾åŒºæ¯å¤©éƒ½å¾ˆæ´»è·ƒï¼ŒShiroçš„ç‰¹æ€§ä¹Ÿåœ¨å˜å¤šã€‚åœ¨æ¥ä¸‹æ¥çš„ç‰ˆæœ¬ä¸­ä½ å°†çœ‹åˆ°:</p>
<ul>
<li>ç®€æ´çš„web filteræœºåˆ¶ï¼Œå…è®¸æ›´å¤šçš„å¯æ’æ‹”çš„è¿‡æ»¤å™¨æ”¯æŒï¼Œè€Œä¸æ˜¯é€šè¿‡å­ç±»ã€‚</li>
<li>æ›´å¤šå¯æ’æ‹”çš„é»˜è®¤æœ‰åˆ©äºç»„åˆç»§æ‰¿çš„åŸŸå®ç°ã€‚ä½ å°†èƒ½å¤Ÿæ’æ‹”æŸ¥æ‰¾èº«ä»½éªŒè¯å’Œæˆæƒæ•°æ®çš„ç»„ä»¶ï¼Œè€Œä¸æ˜¯è¦æ±‚ä½ å¯¹Shiro Realmå®ç°è¿›è¡Œå­ç±»å®ç°ã€‚</li>
<li>å¼ºå¤§çš„OpenIDå’ŒOAuthï¼ˆæˆ–è€…éƒ½æœ‰ï¼‰å®¢æˆ·ç«¯æ”¯æŒ</li>
<li>éªŒè¯ç æ”¯æŒ</li>
<li>100ï¼…æ— çŠ¶æ€åº”ç”¨ç¨‹åºï¼ˆä¾‹å¦‚è®¸å¤šRESTç¯å¢ƒï¼‰æ›´å®¹æ˜“é…ç½®ã€‚</li>
<li>é€šè¿‡è¯·æ±‚/å“åº”åè®®è¿›è¡Œå¤šçº§è®¤è¯ã€‚</li>
<li>é€šè¿‡AuthorizationRequestè¿›è¡Œç²—ç²’åº¦æˆæƒã€‚</li>
<li><a href="http://www.antlr.org/" target="_blank" rel="external">ANTLR</a>è¯­æ³•ç”¨äºå®‰å…¨æ–­è¨€æŸ¥è¯¢ï¼ˆä¾‹å¦‚ï¼ˆâ€™roleï¼ˆadminï¼‰&amp;&amp;ï¼ˆguest ||ï¼groupï¼ˆdeveloperï¼‰ï¼‰â€™ï¼‰</li>
</ul>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>Apache Shiroæ˜¯ä¸€ä¸ªåŠŸèƒ½é½å…¨ï¼ŒåŠŸèƒ½å¼ºå¤§ä¸”é€šç”¨çš„Javaå®‰å…¨æ¡†æ¶ï¼Œå¯ç”¨äºä¿æŠ¤ä½ çš„åº”ç”¨ç¨‹åºã€‚é€šè¿‡ç®€åŒ–åº”ç”¨å®‰å…¨æ€§çš„å››ä¸ªæ–¹é¢ï¼Œå³è®¤è¯ï¼Œæˆæƒï¼Œä¼šè¯ç®¡ç†å’Œå¯†ç ï¼Œåº”ç”¨å®‰å…¨æ€§åœ¨å®é™…åº”ç”¨ä¸­æ›´å®¹æ˜“ç†è§£å’Œå®ç°ã€‚Shiroçš„ç®€å•æ¶æ„å’ŒJavaBeanså…¼å®¹æ€§å…è®¸åœ¨å‡ ä¹ä»»ä½•ç¯å¢ƒä¸­è¿›è¡Œé…ç½®å’Œä½¿ç”¨ã€‚é¢å¤–çš„ç½‘ç»œæ”¯æŒå’Œè¾…åŠ©åŠŸèƒ½ï¼Œå¦‚å¯¹å¤šçº¿ç¨‹å’Œæµ‹è¯•çš„æ”¯æŒï¼Œæ•´åˆæ¡†æ¶ï¼Œä¸ºåº”ç”¨ç¨‹åºå®‰å…¨æ€§æä¾›å¯èƒ½æ˜¯ä½ çš„â€œä¸€ç«™å¼â€æœåŠ¡ã€‚Apache Shiroçš„å¼€å‘å›¢é˜Ÿç»§ç»­å‰è¿›ï¼Œæ”¹è¿›ä»£ç åº“å¹¶æ”¯æŒç¤¾åŒºã€‚éšç€å¼€æºä»£ç å’Œå•†ä¸šåŒ–çš„é‡‡ç”¨ï¼ŒShiroåªä¼šè¶Šæ¥è¶Šå¼ºã€‚</p>
<h3 id="About-the-Author"><a href="#About-the-Author" class="headerlink" title="About the Author"></a>About the Author</h3><p>Les Hazlewoodæ˜¯Shiro PMCä¸»å¸­ï¼ŒKatasoftçš„è”åˆåˆ›å§‹äººå…¼é¦–å¸­æŠ€æœ¯å®˜ï¼Œä¸“æ³¨äºåº”ç”¨ç¨‹åºå®‰å…¨äº§å“å’Œå¯¹Apache Shiroçš„æ”¯æŒã€‚Lesæ‹¥æœ‰10å¹´çš„Javaå¼€å‘å’Œä¼ä¸šæ¶æ„å¸ˆç»éªŒï¼Œæ›¾åœ¨Bloomberg, Delta Airlines, å’Œ JBossæ‹…ä»»è¿‡é«˜çº§èŒåŠ¡ã€‚Lesä¸€ç›´åœ¨ç§¯æå‚ä¸å¼€æºå¼€å‘9å¹´ä»¥ä¸Šï¼Œä¸ºSpring Frameworkï¼ŒHibernateï¼ŒJBossï¼ŒOpenSpacesä»¥åŠApache Shiroçš„å‰èº«JSecurityç­‰é¡¹ç›®æäº¤æˆ–è´¡çŒ®è¿‡ä»£ç ã€‚Lesç›®å‰ä½åœ¨åŠ å·åœ£é©¬ç‰¹å¥¥ï¼Œå¹¶ä¸”åœ¨ä¸ç¼–ç¨‹çš„æ—¶å€™ç»ƒä¹ å‰‘é“å’Œç ”ç©¶æ—¥è¯­ã€‚</p>
<p>æŸ¥çœ‹è‹±æ–‡åŸæ–‡ï¼š <a href="https://www.infoq.com/articles/apache-shiro" target="_blank" rel="external">Application Security With Apache Shiro</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å½“ä½ ä¸ºä½ çš„åº”ç”¨æ·»åŠ å®‰å…¨æªæ–½çš„æ—¶å€™æœ‰æ²¡æœ‰è§‰å¾—å¾ˆå—æŒ«ï¼Ÿä½ æœ‰æ²¡æœ‰è§‰å¾—Javaåœ¨å®‰å…¨è¿™ä¸€å—çš„è§£å†³æ–¹æ¡ˆç”¨èµ·æ¥å¾ˆéš¾ï¼Œè®©ä½ æ›´åŠ è§‰å¾—å›°æƒ‘ï¼Ÿè¿™ç¯‡æ–‡ç« ä»‹ç»&lt;a href=&quot;http://shiro.apache.org/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Apac
    
    </summary>
    
      <category term="Apache" scheme="http://www.wei-dong.top/categories/Apache/"/>
    
    
      <category term="Apache Shiro" scheme="http://www.wei-dong.top/tags/Apache-Shiro/"/>
    
      <category term="ç¿»è¯‘" scheme="http://www.wei-dong.top/tags/%E7%BF%BB%E8%AF%91/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot Featuresï¼ˆPart â…¡ï¼‰</title>
    <link href="http://www.wei-dong.top/2017/08/10/spring-boot-fatures-2/"/>
    <id>http://www.wei-dong.top/2017/08/10/spring-boot-fatures-2/</id>
    <published>2017-08-10T13:58:23.000Z</published>
    <updated>2017-08-10T13:59:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬ç¯‡ç»§ç»­é’ˆå¯¹ä¸Šä¸€ç¯‡æ–‡ç« å¯¹spring boot æœªä»‹ç»å®Œçš„featureè¿›è¡Œè¡¥å……ã€‚<br><a id="more"></a> </p>
<h3 id="Profiles"><a href="#Profiles" class="headerlink" title="Profiles"></a>Profiles</h3><p>ç”¨è¿‡mavenéƒ½çŸ¥é“ï¼Œmavenä¸­æœ‰ä¸ªprofilesçš„è®¾ç½®ã€‚</p>
<blockquote>
<p>profileä¸€ä¸ªéå¸¸é‡è¦çš„ç‰¹æ€§å°±æ˜¯å®ƒå¯ä»¥æ ¹æ®ä¸åŒçš„ç¯å¢ƒæ¥æ¿€æ´»ï¼Œæ¯”å¦‚è¯´æ ¹æ®æ“ä½œç³»ç»Ÿçš„ä¸åŒæ¿€æ´»ä¸åŒçš„profileï¼Œä¹Ÿå¯ä»¥æ ¹æ®jdkç‰ˆæœ¬çš„ä¸åŒæ¿€æ´»ä¸åŒçš„profile.<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span>  </div><div class="line">       <span class="tag">&lt;<span class="name">profile</span>&gt;</span>  </div><div class="line">              <span class="tag">&lt;<span class="name">id</span>&gt;</span>profileTest1<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </div><div class="line">              <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>1.5<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span>  </div><div class="line">       <span class="tag">&lt;/<span class="name">profile</span>&gt;</span>  </div><div class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></div></pre></td></tr></table></figure></p>
</blockquote>
<p>ä¸Šé¢çš„é…ç½®å°±æ˜¯å½“JDKç‰ˆæœ¬ä¸º1.5çš„æ—¶å€™æ¿€æ´»profileTest1ã€‚<br>spring bootä¹Ÿæä¾›è¿™ä¹ˆä¸€ç§æœºåˆ¶ã€‚åœ¨ç‰¹å®šçš„ç¯å¢ƒä¸‹ä½¿ç”¨ç‰¹å®šçš„é…ç½®ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Configuration</span></div><div class="line"><span class="meta">@Profile</span>(<span class="string">"production"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductionConfiguration</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„é…ç½®å°±æ˜¯åœ¨productionç¯å¢ƒä¸‹ç”Ÿæ•ˆã€‚é€šå¸¸åœ¨<code>application.properties</code>è¿™ä¸ªæ–‡ä»¶ä¸‹é…ç½®<code>spring.profiles.active=xxx</code>å±æ€§æ¥æŒ‡å®šä¸åŒçš„profileã€‚å½“ç„¶ä½¿ç”¨å‘½ä»¤è¡Œä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<p>å…¶å®è¿™ä¸ªfeatureä¸ç®—ä»€ä¹ˆç‰¹æ€§ï¼Œå¾ˆä¸€èˆ¬ã€‚</p>
<h3 id="Logging"><a href="#Logging" class="headerlink" title="Logging"></a>Logging</h3><p>spring boot å†…éƒ¨çš„æ—¥å¿—æ˜¯ä½¿ç”¨çš„Common Loggingï¼Œä½†æ˜¯ä¹Ÿæä¾›å¾ˆå¤šå…¶ä»–çš„å®ç°ã€‚é»˜è®¤è¿˜æä¾›JULã€Log4Jå’ŒLogbackã€‚</p>
<p>æ—¥å¿—è¾“å‡ºæ–‡æœ¬çš„é¢œè‰²æ˜¯å¯ä»¥è®¾ç½®çš„ï¼Œå‡å¦‚æ§åˆ¶å°æ”¯æŒANSIçš„è¯ï¼Œç„¶è€Œæˆ‘è§‰å¾—å¹¶æ²¡åµç”¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ—¥å¿—åªä¼šè¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œä¸ä¼šè¾“å‡ºåˆ°æ–‡ä»¶ã€‚åŠ å…¥è¦è¾“å‡ºåˆ°æ–‡ä»¶å°±éœ€è¦åœ¨åŒæ ·åœ¨<code>application.properties</code>æ–‡ä»¶ä¸­é…ç½®ä¸€ä¸‹è¿™å‡ ä¸ªå±æ€§äº†ï¼š<code>logging.file</code> <code>logging.path</code>ã€‚æ–‡ä»¶åä¸å†™çš„è¯é»˜è®¤ä¸º<code>spring.log</code>ï¼Œè·¯å¾„ä¸å†™çš„è¯é»˜è®¤åœ¨å½“å‰è·¯å¾„ä¸‹ã€‚æ—¥å¿—æ–‡ä»¶åˆ°10mçš„æ—¶å€™å°±å›é‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„æ–‡ä»¶ã€‚</p>
<p>ç»™æ—¥å¿—è®¾ç½®çº§åˆ«å°±ä¸å¤šæäº†ï¼Œéƒ½æ˜¯å¾ˆè€æ‰ç‰™çš„ä¸œè¥¿äº†ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">logging.level.root=WARN</div><div class="line">logging.level.org.springframework.web=DEBUG</div><div class="line">logging.level.org.hibernate=ERROR</div></pre></td></tr></table></figure></p>
<p>è‡ªå®šä¹‰æ—¥å¿—ç»„ä»¶ä¹Ÿæ˜¯æ¯”è¾ƒæ–¹ä¾¿çš„ï¼Œæ¯ä¸ªæ—¥å¿—æ¡†æ¶éƒ½æœ‰æ‰€ä¸åŒå˜›ã€‚spring bootæä¾›è¿™ç§çƒ­æ’æ‹”å¼çš„é…ç½®ã€‚åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®š<code>logging.config</code>çš„å€¼å³å¯ã€‚è¿™ä¸ªå±æ€§ä»£è¡¨ç€æ—¥å¿—é…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚ä¸åŒçš„æ—¥å¿—ç³»ç»Ÿæœ‰ä¸åŒçš„é…ç½®æ–‡ä»¶ã€‚</p>
<ul>
<li><code>logback-spring.xml</code>, <code>logback-spring.groovy</code>, <code>logback.xml</code> or <code>logback.groovy</code>æ˜¯logbackçš„ã€‚</li>
<li><code>log4j2-spring.xml</code>, <code>log4j2.xml</code>æ˜¯log4j2çš„ã€‚</li>
<li><code>logging.properties</code>æ˜¯JULçš„ã€‚<br>æ—¥å¿—ç³»ç»Ÿæ²¡ä»€ä¹ˆå¯è¯´çš„ï¼Œå¯¹æˆ‘è€Œè¨€ï¼Œä½¿ç”¨é»˜è®¤çš„å°±å®Œäº‹å„¿äº†ã€‚</li>
</ul>
<p>åŸºæœ¬ä¸Šæ ¸å¿ƒfeatureå…¨éƒ¨æ¢³ç†å®Œäº†ã€‚æ¥ä¸‹æ¥çœ‹çœ‹Web Applications Featuresã€‚</p>
<h3 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h3><p>spring bootä¹Ÿé€‚åˆwebå¼€å‘ï¼Œä½¿ç”¨<code>spring-boot-starter-web</code>æ¨¡å—å¾ˆå¿«å°±èƒ½æ­å»ºä¸€ä¸ªHTTPåº”ç”¨ã€‚<br>ä½¿ç”¨è¿‡Spring MVCçš„å¼€å‘è€…æ¥è®²ï¼Œè¿™ä¸ªfeatureä¸€ç‚¹éƒ½ä¸æ–°é²œã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RestController</span></div><div class="line"><span class="meta">@RequestMapping</span>(value=<span class="string">"/users"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRestController</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;user&#125;"</span>, method=RequestMethod.GET)</div><div class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(@PathVariable Long user)</span> </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;user&#125;/customers"</span>, method=RequestMethod.GET)</div><div class="line">    <span class="function">List&lt;Customer&gt; <span class="title">getUserCustomers</span><span class="params">(@PathVariable Long user)</span> </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@RequestMapping</span>(value=<span class="string">"/&#123;user&#125;"</span>, method=RequestMethod.DELETE)</div><div class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">deleteUser</span><span class="params">(@PathVariable Long user)</span> </span>&#123;</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªæ —å­ä½¿ç”¨<code>@RestController</code>æ³¨è§£æ¥è¿”å›JSONæ•°æ®ã€‚<br>è¿˜æœ‰å¾ˆå¤šæ›´è¯¦ç»†çš„å†…å®¹ï¼Œå¯ä»¥å‚è§<a href="http://docs.spring.io/spring/docs/4.3.10.RELEASE/spring-framework-reference/htmlsingle/#mvc" target="_blank" rel="external">spring framework å®˜æ–¹æ–‡æ¡£</a></p>
<h3 id="Working-with-SQL-databases"><a href="#Working-with-SQL-databases" class="headerlink" title="Working with SQL databases"></a>Working with SQL databases</h3><p>spring bootä¸­å¯¹æ•°æ®åº“çš„æ”¯æŒå¯ä»¥è¯´æ˜¯çˆ½ç¿»å¤©ã€‚</p>
<p>é¦–å…ˆå¾—åˆ›å»ºä¸€ä¸ªæ•°æ®æºï¼ŒåºŸè¯ä¸å¤šè¯´ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Bean</span></div><div class="line"><span class="meta">@ConfigurationProperties</span>(prefix=<span class="string">"app.datasource"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FancyDataSource();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app.datasource.url=jdbc:h2:mem:mydb</div><div class="line">app.datasource.username=sa</div><div class="line">app.datasource.pool-size=30</div></pre></td></tr></table></figure>
<p>æ„æ€å°±æ˜¯è¿™ä¹ˆä¸ªæ„æ€ï¼Œé…ç½®æ–¹å¼å¤šç§å¤šæ ·ã€‚ä¸ä»…ä»…å¯ä»¥æ”¯æŒå¤–éƒ¨æ•°æ®åº“ï¼Œå†…å­˜æ•°æ®åº“ä¹Ÿæ˜¯æ”¯æŒçš„ã€‚ä¾‹å¦‚H2ã€HSQLå’ŒDerbyï¼Œåœ¨spring bootä¸­åªéœ€è¦æä¾›ä¸€ä¸ªä¾èµ–å¥¹å°±èƒ½è‡ªåŠ¨é…ç½®ï¼Œå°±æ˜¯è¿™ä¹ˆå‰å®³ã€‚<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hsqldb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hsqldb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>åœ¨å¯¹å¤–éƒ¨æ•°æ®åº“çš„è¿æ¥ç®¡ç†ä¸­ï¼Œspring bootä½¿ç”¨çš„æ˜¯æ± åŒ–çš„æ•°æ®æºã€‚å¯¹äºä½¿ç”¨ä½•ç§æ± åŒ–æ–¹å¼ï¼Œç­–ç•¥æ˜¯è¿™æ ·çš„ï¼šTomcatçš„è¿æ¥æ± &gt;HikariCP&gt;DBCP(ä¸æ¨èï¼Œå› ä¸ºæ²¡äººå»ç»´æŠ¤äº†)&gt;DBCP2ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">spring.datasource.url=jdbc:mysql://localhost/test</div><div class="line">spring.datasource.username=dbuser</div><div class="line">spring.datasource.password=dbpass</div><div class="line">spring.datasource.driver-class-name=com.mysql.jdbc.Driver</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­çš„urlæ˜¯ä¸€å®šè¦å†™çš„ï¼Œä¸ç„¶çš„è¯spring bootå»è‡ªåŠ¨å»é…ç½®å†…åµŒçš„æ•°æ®åº“äº†ã€‚driverå¯ä»¥ä¸æŒ‡å®šï¼Œå› ä¸ºå¯ä»¥é€šè¿‡urlå»åˆ¤æ–­driverã€‚</p>
<p>è¯´å®Œæ•°æ®æºï¼Œå†èŠèŠJdbcTemplateã€‚è¿™ä¸ªä¸œè¥¿åœ¨spring bootä¸­ç”¨èµ·æ¥æ˜¯éå¸¸çˆ½ï¼Œç›´æ¥å°±èƒ½ç”¨ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBean</span><span class="params">(JdbcTemplate jdbcTemplate)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jdbcTemplate = jdbcTemplate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä»…æ­¤è€Œå·²ï¼</p>
<p>å…³äºspring dataå’ŒJPA çš„ä»‹ç»ä¹Ÿæ²¡æœ‰å¤šè§£é‡Šï¼Œæ–‡æ¡£è¯´å¾ˆå¤šç»†èŠ‚è®©æˆ‘ä»¬å»<a href="https://spring.io/guides/gs/accessing-data-jpa/" target="_blank" rel="external">è¿™é‡Œ</a>çœ‹çœ‹ï¼Œçœ‹æ¥è¿˜æ˜¯æ¯”è¾ƒå¤æ‚ã€‚</p>
<p>åœ¨ä¼ ç»Ÿçš„JPAä¸­entityéœ€è¦åœ¨<code>persistence.xml</code>ä¸­å®šä¹‰ã€‚ä½†åœ¨spring bootä¸­ä¸éœ€è¦è¿™ä¹ˆéº»çƒ¦ï¼Œå› ä¸ºå¥¹èƒ½å¸®ä½ æ‰«æåˆ°ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Entity</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">City</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Id</span></div><div class="line">    <span class="meta">@GeneratedValue</span></div><div class="line">    <span class="keyword">private</span> Long id;</div><div class="line"></div><div class="line">    <span class="meta">@Column</span>(nullable = <span class="keyword">false</span>)</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="meta">@Column</span>(nullable = <span class="keyword">false</span>)</div><div class="line">    <span class="keyword">private</span> String state;</div><div class="line"></div><div class="line">    <span class="comment">// ... additional members, often include @OneToMany mappings</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">City</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// no-args constructor required by JPA spec</span></div><div class="line">        <span class="comment">// this one is protected since it shouldn't be used directly</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">City</span><span class="params">(String name, String state)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.country = country;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getState</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.state;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ... etc</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Spring Data JPA Repositoriesæ˜¯ä¸€ä¸ªå¥½ä¸œè¥¿ï¼ŒJPAæŸ¥è¯¢å¯ä»¥æ ¹æ®ä½ æ–¹æ³•çš„åå­—æ¥ã€‚ä¸¾ä¸ªæ —å­ï¼Œ<code>CityRepository</code>æ¥å£å®šä¹‰ä¸€ä¸ª<code>findAllByState(String state)</code>æ–¹æ³•ï¼Œä½ ä¼ ä¸€ä¸ªstateæ¡ä»¶å®ƒå°±èƒ½æŸ¥å‡ºæ¥ã€‚</p>
<p>ç„¶è€Œè¿™ä»…ä»…åªæ˜¯ä¸€å°éƒ¨åˆ†ï¼Œæ–‡æ¡£æœ‰å¥è¯ç»†æ€ææï¼š</p>
<blockquote>
<p>We have barely scratched the surface of Spring Data JPA.</p>
</blockquote>
<p>spring bootå¯¹NoSQLä¹Ÿæœ‰æ”¯æŒã€‚åƒMongoBDã€Neo4Jã€Elasticsearchã€Solrã€Redisã€ Gemfireã€Cassandraã€Couchbase å’ŒLDAPã€‚</p>
<p>Redis:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> StringRedisTemplate template;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBean</span><span class="params">(StringRedisTemplate template)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.template = template;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä½¿ç”¨redisé™¤äº†æ·»åŠ <code>spring-boot-starter-data-redis</code>ä¾èµ–å¤–ï¼Œæƒ³ç”¨çš„è¯å¦‚ä¸Šé¢ä»£ç ä¸€æ ·ç®€å•ã€‚</p>
<p>MongoDBï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MongoDbFactory mongo;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBean</span><span class="params">(MongoDbFactory mongo)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mongo = mongo;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">example</span><span class="params">()</span> </span>&#123;</div><div class="line">        DB db = mongo.getDb();</div><div class="line">        <span class="comment">// ...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>mongodbåŒæ ·ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå‡å¦‚ä½ çš„mongoDBé‡‡ç”¨åˆ†ç‰‡çš„è¯ï¼Œè¿™æ ·æŒ‡å®šurlå°±è¡Œï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">spring.data.mongodb.uri=mongodb://user:secret@mongo1.example.com:12345,mongo2.example.com:23456/test</div></pre></td></tr></table></figure></p>
<p>å¦‚æœä½¿ç”¨çš„æ˜¯2.xçš„ç‰ˆæœ¬ï¼Œè¿™æ ·å»é…ç½®ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">spring.data.mongodb.host=mongoserver</div><div class="line">spring.data.mongodb.port=27017</div></pre></td></tr></table></figure></p>
<p>MongoTemplateç”¨èµ·æ¥æ›´åŠ æ–¹ä¾¿ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MongoTemplate mongoTemplate;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBean</span><span class="params">(MongoTemplate mongoTemplate)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.mongoTemplate = mongoTemplate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä»–çš„æ–‡æ¡£ä¸­ä¹Ÿæ²¡å¤šå»è§£é‡Šï¼Œä¸¢äº†ä¸ªé“¾æ¥è®©è¯»è€…è‡ªå·±å»çœ‹ã€‚æ‰€ä»¥è¿™é‡Œä¹Ÿä¸å¤šå»å…³æ³¨äº†ã€‚éœ€è¦çš„æ—¶å€™å†æ•´ç†ã€‚</p>
<p>spring bootä¹Ÿæä¾›å¯¹JMSçš„æ”¯æŒï¼Œè¿™ä¹Ÿç®—æ˜¯ä¸€ä¸ªfeatureå§ã€‚</p>
<p>JMSåœ¨Javaä¸­åªå®šä¹‰äº†ä¸€äº›æ¥å£ï¼Œå…·ä½“å®ç°è¿˜æ˜¯ä¾èµ–å„ä¸ªå‚å•†ã€‚å…¶ä¸­ActiveMQå°±æ˜¯ä¸€ä¸ªJMSçš„æ ‡å‡†å®ç°ï¼Œspring bootå¯¹å…¶æœ‰æ¯”è¾ƒå¥½çš„æ”¯æŒã€‚</p>
<p>åŒæ ·çš„ï¼Œåªéœ€è¦æ·»åŠ <code>spring-boot-starter-activemq</code>ä¾èµ–ï¼Œspring bootå°±èƒ½å¸®ä½ è‡ªåŠ¨å»é…ç½®ï¼Œå½“ç„¶å°‘ä¸äº†æœ€åŸºæœ¬çš„é…ç½®ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">spring.activemq.broker-url=tcp://192.168.1.210:9876</div><div class="line">spring.activemq.user=admin</div><div class="line">spring.activemq.password=secret</div></pre></td></tr></table></figure></p>
<p>å½“ç„¶ä½¿ç”¨è¿æ¥æ± ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œæ·»åŠ è¿™ä¸ªä¾èµ–å³å¯ï¼š<code>org.apache.activemq:activemq-pool</code>ï¼ŒåŒæ—¶åšå¦‚ä¸‹é…ç½®ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">spring.activemq.pool.enabled=true</div><div class="line">spring.activemq.pool.max-connections=50</div></pre></td></tr></table></figure></p>
<p>è‡³äºå…·ä½“æ€ä¹ˆå»ä½¿ç”¨è¿™é‡Œä¸å†è¯¦ç»†æè¿°ï¼Œä½¿ç”¨åˆ°çš„æ—¶å€™å†å»<a href="http://docs.spring.io/spring-boot/docs/1.5.6.RELEASE/reference/htmlsingle/#boot-features-jms" target="_blank" rel="external">è¿™é‡Œ</a>ç¿»ç¿»æ–‡æ¡£çœ‹çœ‹ã€‚</p>
<h3 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h3><p>å¯¹äºä¸€ä¸ªæ¡†æ¶æ¥è®²ï¼Œæµ‹è¯•ä¸€å®šæ˜¯å°‘ä¸äº†çš„ã€‚spring bootæä¾›äº†å¾ˆå¤šå·¥å…·è€Œæ³¨è§£æ¥å¸®åŠ©å¼€å‘è€…æµ‹è¯•ä»£ç ã€‚æœ‰ä¸¤ä¸ªæ¨¡å—éœ€è¦ä¾èµ–ï¼š<code>spring-boot-test</code>å’Œ<code>spring-boot-test-autoconfigure</code>ã€‚å‰è€…æä¾›åŸºç¡€æ”¯æŒï¼Œåè€…æä¾›è‡ªåŠ¨é…ç½®ã€‚è®¸å¤šå¼€å‘è€…åªä¼šé€‰æ‹©å‰è€…ï¼Œå‰è€…æä¾›JUnitã€AssertJã€HamcreståŠå…¶ä»–æœ‰ç”¨çš„å·¥å…·åŒ…ã€‚</p>
<p>å½“ä½ æ·»åŠ <code>spring-boot-starter-test</code>ä¾èµ–æ—¶ï¼Œä½ ä¼šå‘ç°å¾ˆå¤šåº“è¢«æ·»åŠ è¿›æ¥äº†ï¼š</p>
<ul>
<li>JUnit</li>
<li>Spring Test</li>
<li>AssertJ</li>
<li>Hamcrest</li>
<li>Mockito</li>
<li>JSONassert</li>
<li>JsonPath<br>ä¾èµ–æ³¨å…¥çš„ä¸€ä¸ªæœ€å¤§çš„å¥½å¤„å°±æ˜¯è®©å•å…ƒæµ‹è¯•å˜å¾—æ›´ç®€å•ã€‚åœ¨spring frameworkçš„æµ‹è¯•æ¡†æ¶ä¸­ï¼Œå¸¸å¸¸ä½¿ç”¨<code>@ContextConfiguration(classes=â€¦â€‹)</code>è¿™æ ·çš„é…ç½®ï¼Œæˆ–è€…åœ¨ä½ çš„æµ‹è¯•ä¸­ä½¿ç”¨åµŒå¥—çš„<code>@Configuration</code>ç±»ã€‚åœ¨spring bootä¸­ä¸éœ€è¦è¿™ä¹ˆéº»çƒ¦ï¼Œ<code>@*Test</code>ä¼šè‡ªåŠ¨å»æ‰¾ä½ çš„é…ç½®ã€‚</li>
</ul>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦è‡ªåŠ¨å»æ‰¾æµ‹è¯•çš„é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ‰‹åŠ¨æŒ‡å®šé…ç½®ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</div><div class="line"><span class="meta">@SpringBootTest</span></div><div class="line"><span class="meta">@Import</span>(MyTestsConfiguration.class)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTests</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Test</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exampleTest</span><span class="params">()</span> </span>&#123;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è‡³äºå…¶ä»–å†…å®¹éƒ½æ²¡ä»€ä¹ˆå¯è®²çš„ï¼Œæ— éå°±æ˜¯ä¸€äº›annotationçš„ä½¿ç”¨ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>spring bootçš„ä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„featureåŸºæœ¬ä¸Šéƒ½æ¢³ç†ä¸€éäº†ï¼Œå½“ç„¶ä¹Ÿæœ‰è®¸å¤šæ²¡æœ‰å¾ˆå…·ä½“æè¿°çš„åœ°æ–¹ã€‚æ•´ä¸ªç¯‡å¹…å¤ªé•¿å¤ªå¤šï¼Œå¾ˆå¤šç»†èŠ‚çš„åœ°æ–¹ä¹Ÿæ²¡æœ‰å¾ˆæ³¨æ„åˆ°ï¼Œæœ‰äº›è¡¨è¿°å’Œæ–‡å­—ç»„ç»‡è¿˜æ˜¯éå¸¸æ¬ ç¼ºï¼Œè¿™éƒ½æ˜¯è‡ªå·±å¯¹è‹±æ–‡ç‰ˆçš„æŠ€æœ¯æ–‡æ¡£æ‹¿æä¸æ˜¯å¾ˆå‡†é€ æˆçš„ã€‚æˆ‘æƒ³æˆ‘æ•´ç†çš„ä¸œè¥¿ä¹Ÿåªæœ‰æˆ‘è‡ªå·±èƒ½çœ‹æ‡‚äº†ã€‚å½“ç„¶ç›®å‰åªæ˜¯ä¸€ä¸ªprofileï¼Œå¾ˆå¤šå‘è¿˜éœ€è¦è‡ªå·±å»è¸©çš„ï¼Œåªèƒ½åœ¨ä»¥åçš„å·¥ä½œåŠå­¦ä¹ ä¸­æ…¢æ…¢æ€»ç»“ï¼Œæˆ‘æƒ³æ²¡æœ‰è°æ˜¯ä»…ä»…é€šè¿‡çœ‹äº†ä¸€ä¸‹æ–‡æ¡£å°±èƒ½å†™å‡ºæ¼‚äº®çš„ä»£ç æ¥å§ã€‚</p>
<p>æ¥ä¸‹æ¥spring bootç³»åˆ—å†…å®¹å¯èƒ½å°±æ›´å…¨é¢ï¼Œå…·ä½“æ•´ç†å“ªäº›ä¸œè¥¿ä»¥åæƒ³åˆ°åœ¨è¯´ã€‚æ¯•ç«Ÿè¿™æ¬¡çš„featureåªæ˜¯è¯•è¯•æ°´ã€‚æˆ‘ä¹Ÿå¸Œæœ›æˆ‘å¯¹è‹±æ–‡æŠ€æœ¯æ–‡æ¡£çš„ç†è§£æœ‰æ›´åŠ è´¨çš„æå‡ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ¬ç¯‡ç»§ç»­é’ˆå¯¹ä¸Šä¸€ç¯‡æ–‡ç« å¯¹spring boot æœªä»‹ç»å®Œçš„featureè¿›è¡Œè¡¥å……ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Spring Framework" scheme="http://www.wei-dong.top/categories/Spring-Framework/"/>
    
    
      <category term="Spring Boot" scheme="http://www.wei-dong.top/tags/Spring-Boot/"/>
    
      <category term="ç¿»è¯‘&amp;æ•´ç†" scheme="http://www.wei-dong.top/tags/%E7%BF%BB%E8%AF%91-%E6%95%B4%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>Spring Boot Featuresï¼ˆPart Iï¼‰</title>
    <link href="http://www.wei-dong.top/2017/08/05/spring-boot-fatures/"/>
    <id>http://www.wei-dong.top/2017/08/05/spring-boot-fatures/</id>
    <published>2017-08-05T08:59:23.000Z</published>
    <updated>2017-08-05T09:07:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨spring bootå®˜æ–¹æ–‡æ¡£ä¸­ä»‹ç»äº†ä¸å°‘featureï¼Œæˆ‘è§‰å¾—æœ‰å¿…è¦æ•´ç†ä¸€ä¸‹ï¼Œè¿˜æ˜¯æŒºæœ‰æ„æ€çš„ã€‚<br><a id="more"></a> </p>
<p>æ–‡æ¡£ä¸­æ ¹æ®åŠŸèƒ½ä½œå‡ºäº†ä»¥ä¸‹åŒºåˆ†ï¼š</p>
<ul>
<li>Core Featureï¼š SpringApplicationï¼ˆSpringåº”ç”¨ï¼‰| Externalized Configurationï¼ˆå¤–éƒ¨é…ç½®ï¼‰| Profilesï¼ˆè½®å»“ï¼‰| Loggingï¼ˆæ—¥å¿—ï¼‰ </li>
<li>Web Applicationsï¼š MVCï¼ˆä¸è§£é‡Šï¼‰| Embedded Containersï¼ˆå†…åµŒçš„å®¹å™¨ï¼‰</li>
<li>Working with dataï¼šSQL | NO-SQL</li>
<li>Messaging: JMSï¼ˆJavaæ¶ˆæ¯æœåŠ¡ï¼‰</li>
<li>Testing: Boot Applications | Utils ï¼ˆæµ‹è¯•ç›¸å…³ï¼‰</li>
<li>Extending: Auto-configuration | @Conditions ï¼ˆæ‹“å±•ï¼‰</li>
</ul>
<p>ä»¥ä¸Šçš„featureç”¨ä¸­æ–‡ç¿»è¯‘èµ·æ¥å¾ˆä¸å®¹æ˜“ç†è§£ï¼Œè¿™äº›ä¸“ä¸šæœ¯è¯­ç”¨è‹±æ–‡è¡¨ç¤ºæ›´è®©äººè§‰å¾—ç†Ÿæ‚‰ã€‚ç°åœ¨å°±é’ˆå¯¹æŸä¸ªfeatureå•ç‹¬å»ç†è§£ã€‚</p>
<h3 id="SpringApplication"><a href="#SpringApplication" class="headerlink" title="SpringApplication"></a>SpringApplication</h3><p>è¿™ä¸ªç‰¹æ€§å¯ä»¥è¯´æ˜¯spring bootçš„åˆ›æ–°ã€‚åœ¨ä»¥å¾€çš„webç¨‹åºå¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸å°†è‡ªå·±çš„ç¨‹åºéƒ¨ç½²åœ¨tomcatæˆ–è€…weblogicç±»ä¼¼çš„ä¸­é—´ä»¶ä¸Šçš„ï¼Œä½†ä½¿ç”¨spring bootä¸éœ€è¦ä¾è€è¿™æ ·çš„ä¸­é—´ä»¶ã€‚ä½¿ç”¨spring bootå¯åŠ¨ä½ çš„åº”ç”¨å°±åƒå¯åŠ¨ä¸€ä¸ªç®€å•çš„ç¨‹åºä¸€æ ·ï¼Œç±»ä¼¼æˆ‘ä»¬åˆšæ¥è§¦Javaå†™çš„ä¸€ä¸ªä¸ªçš„mainå‡½æ•°ä¸€æ ·ã€‚å®ƒåªéœ€è¦è¿™æ ·çš„ä»£ç å°±èƒ½å¯åŠ¨ä¸€ä¸ªwebåº”ç”¨äº†ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    SpringApplication.run(MySpringConfiguration.class, args);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ­£å¸¸å¯åŠ¨è‚¯å®šæ˜¯æ²¡ä»€ä¹ˆå¯è®²çš„ï¼Œé—®é¢˜æ˜¯å‡ºäº†é—®é¢˜å°±å¾ˆéš¾å—äº†ã€‚æ²¡å…³ç³»ï¼Œspring bootåŒæ ·ä¸ºå¼€å‘è€…æä¾›äº†å¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚spring bootæä¾›<code>FailureAnalyzers</code>å¸®åŠ©ä½ ä¿®å¤é—®é¢˜ã€‚æ¯”æ–¹è¯´ï¼Œå‡å¦‚ä½ åœ¨8080ç«¯å£ä¸Šå¯åŠ¨webåº”ç”¨ï¼Œç„¶è€Œè¿™ä¸ªç«¯å£è¢«å ç”¨äº†ï¼Œè¿™æ—¶å€™æ§åˆ¶å°ä¼šæŠ¥å‡ºè¿™æ ·çš„é”™è¯¯ä¿¡æ¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">***************************</div><div class="line">APPLICATION FAILED TO START</div><div class="line">***************************</div><div class="line"></div><div class="line">Description:</div><div class="line"></div><div class="line">Embedded servlet container failed to start. Port 8080 was already in use.</div><div class="line"></div><div class="line">Action:</div><div class="line"></div><div class="line">Identify and stop the process that&apos;s listening on port 8080 or configure this application to listen on another port.</div></pre></td></tr></table></figure></p>
<p>é€šè¿‡æ§åˆ¶å°æ‰“å°å‡ºçš„é”™è¯¯ä¿¡æ¯ï¼Œå¾ˆå®¹æ˜“çŸ¥é“é—®é¢˜å‡ºå“ªé‡Œäº†ï¼ˆè‹±æ–‡æ°´å¹³ä¸è¦å¤ªlowï¼‰ã€‚å½“ç„¶è¿™æ˜¯ä½¿ç”¨é»˜è®¤çš„<code>FailureAnalyzers</code>ï¼Œspring boot ä¹Ÿæä¾›è‡ªå·±å®šä¹‰çš„<code>FailureAnalyzers</code>ã€‚åœ¨<code>META-INF/spring.factories</code>è¿™ä¸ªæ–‡ä»¶ä¸­æœ‰è¿™æ ·çš„å®šä¹‰ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># Failure Analyzers</div><div class="line">org.springframework.boot.diagnostics.FailureAnalyzer=\</div><div class="line">org.springframework.boot.diagnostics.analyzer.BeanCurrentlyInCreationFailureAnalyzer,\</div><div class="line">org.springframework.boot.diagnostics.analyzer.BeanNotOfRequiredTypeFailureAnalyzer,\</div><div class="line">org.springframework.boot.diagnostics.analyzer.BindFailureAnalyzer,\</div><div class="line">org.springframework.boot.diagnostics.analyzer.ConnectorStartFailureAnalyzer,\</div><div class="line">org.springframework.boot.diagnostics.analyzer.NoUniqueBeanDefinitionFailureAnalyzer,\</div><div class="line">org.springframework.boot.diagnostics.analyzer.PortInUseFailureAnalyzer,\</div><div class="line">org.springframework.boot.diagnostics.analyzer.ValidationExceptionFailureAnalyzer</div></pre></td></tr></table></figure></p>
<p>å‘ç°äº†è¿™ä¸ª<code>PortInUseFailureAnalyzer</code>ç±»å—ï¼Ÿè¿™ä¸ªå°±æ˜¯å¤„ç†ç«¯å£ç»‘å®šå¤±è´¥çš„Analyzerã€‚æˆ‘ä»¬å¦‚æœè¦è‡ªå·±å®šä¹‰ä¸€ä¸ªè¿™æ ·çš„Analyzerå¾ˆç®€å•ã€‚åˆ›å»ºä¸€ä¸ªç±»ï¼Œç»§æ‰¿<code>AbstractFailureAnalyzer</code>ï¼Œå…¶ä¸­çš„æ³›å‹å¯ä»¥æ˜¯ä»»ä½•å¼‚å¸¸ã€‚é‡å†™å…¶<code>analyze</code>æ–¹æ³•ï¼Œæ ¹æ®ä¼ å…¥çš„å‚æ•°è¿›è¡Œå¤„ç†ï¼Œå¦‚æœæ²¡åŠæ³•å¤„ç†é‚£å°±è¿”å›ä¸€ä¸ª<code>null</code>,è¿™æ—¶å€™å°†ç”±ä¸‹ä¸€ä¸ªAnalyzerå»å¤„ç†ã€‚å¦‚æœå¯ä»¥å¤„ç†ï¼Œç›´æ¥è¿”å›ä¸€ä¸ª<code>FailureAnalysis</code>å¯¹è±¡å³å¯ã€‚è¿™ä¸ªå¯¹è±¡å’Œ<code>Execption</code>å¾ˆç±»ä¼¼ï¼Œæ— éå°±æ˜¯ä¸€äº›é”™è¯¯ä¿¡æ¯ç½¢äº†ã€‚è¿™ä¸ªæ˜¯æˆ‘å®šä¹‰çš„ä¸€ä¸ªAnalyzerï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SimpleFailureAnalyzer</span> <span class="keyword">extends</span> <span class="title">AbstractFailureAnalyzer</span>&lt;<span class="title">NullPointerException</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SimpleFailureAnalyzer</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        System.out.println(<span class="string">"æˆ‘æ˜¯è‡ªå®šä¹‰çš„FailureAnalyzerï¼Œæˆ‘å¼€å§‹æäº‹æƒ…äº†ï¼"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> FailureAnalysis <span class="title">analyze</span><span class="params">(Throwable rootFailure, NullPointerException cause)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"æ­£åœ¨æäº‹æƒ…ã€‚ã€‚ã€‚"</span>);</div><div class="line">        System.out.println(<span class="string">"è·å–è¿™ä¸ªå¼‚å¸¸:"</span>);</div><div class="line">        String message = cause.getMessage();</div><div class="line">        System.out.println(message);</div><div class="line">        System.out.println(<span class="string">"äº‹æƒ…æå®Œäº†ï¼Œä½†æ˜¯ä¸æƒ³å¤„ç†"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å®šä¹‰è¿™ä¸ªç±»è¿˜æ²¡ç»“æŸï¼Œè¿˜è¦åˆ›å»ºä¸€ä¸ª<code>META-INF/spring.factories</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">org.springframework.boot.diagnostics.FailureAnalyzer=\</div><div class="line">com.dw.simpledemo.failureanalyzer.SimpleFailureAnalyzer</div></pre></td></tr></table></figure></p>
<p>é™¤äº†è¿™ç§æ–¹å¼è¯Šæ–­é—®é¢˜ä¹‹å¤–ï¼Œè¿˜å¯ä»¥è¿™æ ·å»å‘ç°é—®é¢˜ã€‚å¯ä»¥è®¾ç½®æ—¥å¿—çš„çº§åˆ«ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">logging:</div><div class="line">  level:</div><div class="line">    root: WARN</div><div class="line">    org.springframework: DEBUG</div><div class="line">    org.hibernate: ERROR</div></pre></td></tr></table></figure></p>
<p>å‡å¦‚ä½ ä½¿ç”¨çš„æ˜¯Javaå‘½ä»¤è¡Œçš„æ–¹å¼å»å¯åŠ¨ä½ çš„appå¯ä»¥åœ¨å‘½ä»¤ååŠ è¿™æ ·çš„å‚æ•°<code>java -jar myproject-0.0.1-SNAPSHOT.jar --debug</code>ï¼Œä»¥debugçš„æ–¹å¼å»å¯åŠ¨ã€‚ï¼ˆæˆ‘ç›¸ä¿¡è¿™ç§æ–¹å¼ä¼šè®©ä½ çš„æ§åˆ¶å°çˆ†ç‚¸ï¼Œæ»¡å±éƒ½æ˜¯æ—¥å¿—ï¼Œ2333333ã€‚ï¼‰<br>å¯åŠ¨å¤±è´¥çš„é—®é¢˜åˆ†ææˆ‘è§‰å¾—ä¸ç®—ç‰¹åˆ«æœ‰åˆ›æ–°çš„featureï¼Œæ¯•ç«Ÿä¸€èˆ¬æƒ…å†µä¸‹é€šè¿‡æŠ¥é”™ä¹Ÿèƒ½æ‰¾åˆ°é—®é¢˜å‡ºå“ªé‡Œäº†ã€‚</p>
<p>è¿™ä¸ªfeatureæˆ‘è§‰å¾—ç®—æ˜¯ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„ï¼Œè™½ç„¶æˆ‘è§‰å¾—æ²¡ä»€ä¹ˆå±Œç”¨ï¼Œåªèƒ½ç®—ä¸ªå½©è›‹å§23333.<br>åœ¨æˆ‘ä»¬ç‚¹å‡»<code>run</code>çš„æ—¶å€™æ§åˆ¶å°ä¼šæ‰“å°ä¸€ä¸ªASCIIçš„å­—ç¬¦ç”»ã€‚å¼€å§‹ä»¥ä¸ºè¿™ä¸ªæ˜¯spring bootè‡ªå¸¦çš„ï¼Œå…¶å®è¿™ä¸ªä¹Ÿå¯ä»¥è‡ªå®šä¹‰çš„ã€‚<br>åœ¨ç±»è·¯å¾„ä¸‹åˆ›å»ºä¸€ä¸ªbanner.txtæ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">$&#123;AnsiColor.BRIGHT_YELLOW&#125;</div><div class="line">////////////////////////////////////////////////////////////////////</div><div class="line">//                          _ooOoo_                               //</div><div class="line">//                         o8888888o                              //</div><div class="line">//                         88&quot; . &quot;88                              //</div><div class="line">//                         (| ^_^ |)                              //</div><div class="line">//                         O\  =  /O                              //</div><div class="line">//                      ____/`---&apos;\____                           //</div><div class="line">//                    .&apos;  \\|     |//  `.                         //</div><div class="line">//                   /  \\|||  :  |||//  \                        //</div><div class="line">//                  /  _||||| -:- |||||-  \                       //</div><div class="line">//                  |   | \\\  -  /// |   |                       //</div><div class="line">//                  | \_|  &apos;&apos;\---/&apos;&apos;  |   |                       //</div><div class="line">//                  \  .-\__  `-`  ___/-. /                       //</div><div class="line">//                ___`. .&apos;  /--.--\  `. . ___                     //</div><div class="line">//              .&quot;&quot; &apos;&lt;  `.___\_&lt;|&gt;_/___.&apos;  &gt;&apos;&quot;&quot;.                  //</div><div class="line">//            | | :  `- \`.;`\ _ /`;.`/ - ` : | |                 //</div><div class="line">//            \  \ `-.   \_ __\ /__ _/   .-` /  /                 //</div><div class="line">//      ========`-.____`-.___\_____/___.-`____.-&apos;========         //</div><div class="line">//                           `=---=&apos;                              //</div><div class="line">//      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^        //</div><div class="line">//            ä½›ç¥–ä¿ä½‘       æ°¸ä¸å®•æœº     æ°¸æ— BUG                  //</div><div class="line">////////////////////////////////////////////////////////////////////</div></pre></td></tr></table></figure></p>
<p>è¿™æ ·ä½ çš„appåœ¨å¯åŠ¨çš„æ—¶å€™å°±ä¼šæ‰“å°è¿™æ ·çš„å­—ç¬¦ç”»äº†ã€‚ä¸ªäººè§‰å¾—é™¤äº†è£…bæ²¡æœ‰ä»»ä½•åµç”¨ã€‚è‡ªå·±å»å®šä¹‰è¿™äº›å­—ç¬¦ç”»çš„ç”Ÿæˆç¨‹åºä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œ<code>org.springframework.boot.Banner</code>è¿™ä¸ªæ¥å£å°±æ˜¯å®šä¹‰æ€ä¹ˆå»å®ç°bannerçš„æ‰“å°çš„ï¼Œå…·ä½“æ€ä¹ˆå¤„ç†å¯ä»¥çœ‹çœ‹å®ƒçš„å®ç°ç±»ã€‚é—²çš„æ²¡äº‹å¯ä»¥å»æŠ˜è…¾è¿™äº›ç©æ„å„¿ï¼å½“ç„¶ä¸æƒ³çœ‹åˆ°è¿™äº›ä¸œè¥¿ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚åœ¨ymlæ–‡ä»¶ä¸­è¿™æ ·é…ç½®ä¸€ä¸‹å°±å®Œäº‹å„¿äº†ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">spring:</div><div class="line">    main:</div><div class="line">        banner-mode: &quot;off&quot;</div></pre></td></tr></table></figure></p>
<p>åŒæ ·çš„é…ç½®å†™æˆ<code>application.properties</code>ä¹Ÿæ˜¯OKçš„ã€‚<br>ç„¶é¹…ï¼Œç¡¬ç¼–ç ä¹Ÿæ˜¯å¯ä»¥çš„ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    SpringApplication app = <span class="keyword">new</span> SpringApplication(MySpringConfiguration.class);</div><div class="line">    app.setBannerMode(Banner.Mode.OFF);</div><div class="line">    app.run(args);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ¥ä¸‹æ¥çš„è¿™ä¸ªfeatureå°±æ¯”è¾ƒå®ç”¨äº†ã€‚æˆ‘ä»¬ç”¨çš„æ˜¯spring bootå½“ç„¶å°‘ä¸äº†æ ¸å¿ƒçš„springçš„ç‰¹æ€§å‘€ï¼Œæ¯•ç«Ÿéƒ½å§“springå˜›2333ï¼</p>
<p>æˆ‘ä»¬æœ‰æ—¶å€™éœ€è¦åœ¨springå®¹å™¨å¯åŠ¨çš„æ—¶å€™æä¸€äº›äº‹æƒ…ï¼Œspring frameworkä¹Ÿæä¾›äº†è¿™æ ·çš„ä¸€ç§æœºåˆ¶å»å¸®åŠ©æˆ‘ä»¬å®Œæˆã€‚å®ƒå®šä¹‰äº†å¾ˆå¤šäº‹ä»¶æ¥æŠ½è±¡å‡ºè¿™äº›æ“ä½œï¼Œæ¯”å¦‚è¯´<code>ContextRefreshedEvent</code>è¿™ä¸ªäº‹ä»¶å°±æ˜¯å½“å®¹å™¨åˆå§‹åŒ–æˆ–è€…è¢«åˆ·æ–°äº†ä¼šè§¦å‘ã€‚</p>
<p>æˆ‘ä»¬æ³¨å†Œä¸€ä¸ªbeanå¯ä»¥é€šè¿‡<code>@Bean</code>å»å®Œæˆï¼Œbeançš„æ³¨å†Œéœ€è¦ä¾èµ–å®¹å™¨è¢«åˆ›å»ºï¼Œä½†æ˜¯åˆ›å»ºä¹‹å‰çš„ä¸€äº›æ“ä½œæˆ‘ä»¬æ²¡åŠæ³•é€šè¿‡<code>@Bean</code>æ¥å®Œæˆã€‚spring bootä¸­å¯ä»¥è¿™æ ·å»è®¾ç½®<code>SpringApplication.addListeners(â€¦â€‹)</code>æˆ–è€…<code>SpringApplicationBuilder.listeners(â€¦â€‹)</code>å»æ·»åŠ ä½ å…³å¿ƒçš„äº‹ä»¶.å½“ç„¶è¿™ç§æ–¹å¼æ˜¯ä½¿ç”¨ç¡¬ç¼–ç å®Œæˆçš„ï¼Œä¸å¤Ÿæ•äº®ä¸å¤Ÿspringã€‚å¯ä»¥åœ¨<code>META-INF/spring.factories</code>æ–‡ä»¶ä¸­å»æŒ‡å®šã€‚è¿™æ˜¯é»˜è®¤é…ç½®ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># Application Listeners</div><div class="line">org.springframework.context.ApplicationListener=\</div><div class="line">org.springframework.boot.ClearCachesApplicationListener,\</div><div class="line">org.springframework.boot.builder.ParentContextCloserApplicationListener,\</div><div class="line">org.springframework.boot.context.FileEncodingApplicationListener,\</div><div class="line">org.springframework.boot.context.config.AnsiOutputApplicationListener,\</div><div class="line">org.springframework.boot.context.config.ConfigFileApplicationListener,\</div><div class="line">org.springframework.boot.context.config.DelegatingApplicationListener,\</div><div class="line">org.springframework.boot.liquibase.LiquibaseServiceLocatorApplicationListener,\</div><div class="line">org.springframework.boot.logging.ClasspathLoggingApplicationListener,\</div><div class="line">org.springframework.boot.logging.LoggingApplicationListener</div></pre></td></tr></table></figure></p>
<p>åŒæ ·ï¼Œè‡ªå·±å»æŒ‰ç…§è¿™æ ·çš„å†™æ³•å»æ•´ä¸€ä¸ªè‡ªå·±å®šä¹‰çš„listenerä¹Ÿæ˜¯okçš„ï¼Œè¿™å¾ˆspringï¼æ–‡æ¡£ä¸­ç»™äº†ä¸€æ®µè¯ï¼šæˆ‘ä»¬é€šå¸¸å¾ˆå°‘å»ç”¨è¿™ä¸ªapplication eventï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“ä»–ä»¬å­˜åœ¨æ˜¯å¾ˆæœ‰å¿…è¦çš„ã€‚spring boot é€šè¿‡ä»–ä»¬å®Œæˆå¾ˆå¤šä»»åŠ¡ã€‚å…¶å®åœ¨åšæŠ€æœ¯çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿæ˜¯è¿™ä¸ªé“ç†ï¼Œå¾ˆå¤šæ—¶å€™æœ‰äº›ä¸œè¥¿æˆ‘ä»¬ä¸å¸¸ç”¨ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»çŸ¥é“æœ‰è¿™ä¹ˆä¸ªä¸œè¥¿ï¼Œè¯´ä¸å®šåœ¨ä»€ä¹ˆæ—¶å€™å°±æ´¾ä¸Šç”¨åœºäº†ã€‚</p>
<p>è¿™ä¸ªfeatureæˆ‘è§‰å¾—æ²¡å¤ªå¤šç”¨å¤„ï¼Œæ¯•ç«Ÿæˆ‘ç›®å‰æ¥è§¦åˆ°spring bootä¸æ˜¯å¾ˆæ·±å…¥ã€‚spring bootå¯åŠ¨å…¥å£æ˜¯é€šè¿‡<code>main</code>å‡½æ•°ï¼Œå…¶ä¸­æœ‰<code>String[] args</code>ä½œä¸ºå‚æ•°ä¼ è¿›æ¥ã€‚spring bootæä¾›<code>ApplicationArguments</code>æ¥å£è®©æˆ‘ä»¬ç›´æ¥è·å–ä¼ å…¥çš„å‚æ•°ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyBean</span><span class="params">(ApplicationArguments args)</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> debug = args.containsOption(<span class="string">"debug"</span>);</div><div class="line">        List&lt;String&gt; files = args.getNonOptionArgs();</div><div class="line">        <span class="comment">// if run with "--debug logfile.txt" debug=true, files=["logfile.txt"]</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ä¸ªäººè§‰å¾—ä½¿ç”¨è¿™ç§æ–¹å¼å¾ˆlowï¼Œå°†å‚æ•°ç›´æ¥å†™åˆ°é…ç½®æ–‡ä»¶ä¸­å»ï¼Œè®©appå¯åŠ¨æ—¶å€™å»è¯»é…ç½®ä¸å®Œäº†ï¼Ÿ</p>
<p>å¦‚æœä½ éœ€è¦åœ¨SpringApplicationå¯åŠ¨å‰å»åšç‚¹åˆ«çš„äº‹æƒ…ï¼Œspring bootåŒæ ·èƒ½å¤Ÿå®ç°ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</div><div class="line">        <span class="comment">// Do something...</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å®ç°<code>ApplicationRunner</code>æ¥å£åŒæ ·ä¹Ÿèƒ½è¾¾åˆ°æ•ˆæœã€‚è¿™ä¸ªæ¥å£ä¸­çš„<code>run</code>æ–¹æ³•å‚æ•°å°±æ˜¯ä¸Šé¢æåˆ°çš„<code>ApplicationArguments</code>ç”¨æ¥è·å–å¯åŠ¨å‚æ•°çš„ã€‚åŒºåˆ«å°±åœ¨äºä¸€ä¸ªåªèƒ½è·å–<code>String</code>æ•°ç»„ç±»å‹çš„å‚æ•°ï¼Œä¸€ä¸ªèƒ½è·å–<code>ApplicationArguments</code>ç±»å‹çš„å‚æ•°ã€‚</p>
<p>è‡³æ­¤ï¼Œå…³äºCore Features: SpringApplication çš„å†…å®¹éƒ½æ¢³ç†å®Œäº†ã€‚ä¸‹ä¸€ä¸ªfeatureè¦è®²çš„æ˜¯Core Features: External Configurationã€‚</p>
<h3 id="Externalized-Configuration"><a href="#Externalized-Configuration" class="headerlink" title="Externalized Configuration"></a>Externalized Configuration</h3><p>è¯´å®è¯ï¼Œè¿™ä¸ªè¯ä¸­æ–‡ç¿»è¯‘çœŸçš„å¾ˆéš¾è¡¨è¾¾å®ƒæƒ³ä¼ è¾¾å‡ºçš„æ„æ€ã€‚ä½œä¸ºåè¯çš„ç›´è¯‘å°±æ˜¯å¤–éƒ¨é…ç½®ï¼Œä½œä¸ºåŠ¨è¯ç¿»è¯‘è¿‡æ¥å°±æ˜¯å¤–éƒ¨åŒ–é…ç½®ã€‚çœŸçš„è®©äººæ‘¸ä¸åˆ°å¤´è„‘ã€‚</p>
<p>ä»”ç»†å»è¯»è¯»å†…å®¹ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ä¸€ä¸ªå…³é”®è¯ï¼šé…ç½®ã€‚é€šè¿‡é…ç½®ï¼Œå¯ä»¥è®©ä½ çš„åº”ç”¨åœ¨ä¸åŒç¯å¢ƒä¸­è·‘åŒä¸€å¥—ä»£ç ã€‚å¯ä»¥ä½¿ç”¨propertiesæ–‡ä»¶ã€YAMLæ–‡ä»¶ã€environmentå˜é‡ã€åŠå‘½ä»¤è¡Œå‚æ•°å»ä½¿ä½ çš„å‚æ•°ç”Ÿæ•ˆã€‚é…ç½®å‚æ•°å¯ä»¥é€šè¿‡ä½¿ç”¨<code>@Value</code>æ³¨è§£ç›´æ¥æ³¨å…¥åˆ°ä½ çš„beanä¸­ã€‚spring bootä¸­çš„é…ç½®å±æ€§æ˜¯éµå¾ªä¸€ä¸ªä¼˜å…ˆçº§çš„ï¼š</p>
<ol>
<li>å…¨å±€é…ç½®ï¼ˆå½“devtoolsç”Ÿæ•ˆçš„æ—¶å€™ ~/.spring-boot-devtools.propertiesæ–‡ä»¶ä½œä¸ºå…¨å±€é…ç½®æ–‡ä»¶ï¼‰ã€‚</li>
<li><code>@TestPropertySource</code>æ³¨è§£é…ç½®åœ¨ä½ çš„æµ‹è¯•ç”¨ä¾‹ä¸­ã€‚</li>
<li><code>@SpringBootTest#properties</code>æ³¨è§£å±æ€§å€¼è¢«è®¾ç½®åœ¨ä½ çš„æµ‹è¯•ç”¨ä¾‹ä¸­ã€‚</li>
<li>å‘½ä»¤è¡Œå‚æ•°ã€‚</li>
<li>environment variable(å¯åŠ¨æ—¶å€™å¯ä»¥è®¾ç½®çš„å‚æ•°ï¼Œç±»ä¼¼äºprogram arguments)æˆ–è€…ç³»ç»Ÿå‚æ•°ã€‚</li>
<li><code>ServletConfig</code>åˆå§‹åŒ–å‚æ•°ã€‚</li>
<li><code>ServletContext</code>åˆå§‹åŒ–å‚æ•°ã€‚</li>
<li><code>java:comp/env</code>JNDIå‚æ•°ã€‚</li>
<li>Java System properties(System.getProperties()).</li>
<li>OS environment variables.</li>
<li>A <code>RandomValuePropertySource</code> that only has properties in random.*.(å•¥å•¥å•¥ï¼Œè¯´å•¥å‘¢)</li>
<li>jaråŒ…å¤–çš„<code>application-{profile}.properties</code>é…ç½®æ–‡ä»¶æˆ–è€…YAMLæ–‡ä»¶ã€‚</li>
<li>jaråŒ…å†…çš„â€¦(åŒä¸Š)ã€‚</li>
<li>jaråŒ…å¤–çš„<code>application.properties</code>æ–‡ä»¶æˆ–è€…YAMLæ–‡ä»¶ã€‚</li>
<li>jaråŒ…å†…çš„â€¦(åŒä¸Š)ã€‚</li>
<li>åœ¨<code>@Configuration</code>æ³¨è§£è¿‡çš„ç±»ä¸Šçš„<code>@PropertySource</code>å±æ€§ï¼ˆè²Œä¼¼è¯»ä¸é€šï¼‰ã€‚</li>
<li>é»˜è®¤å±æ€§ã€‚<br>ä¸€ä¸ªæ —å­ï¼š<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;name&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="comment">// ...</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p><code>application.properties</code>ä¸­æœ‰nameè¿™ä¸ªå±æ€§å°±ä¼šè¢«è‡ªåŠ¨èµ‹å€¼ç»™nameå­—æ®µã€‚<code>java -jar app.jar --name=&quot;Spring&quot;</code>è¿™ç§æ–¹å¼nameå°±æ˜¯ä»å‘½ä»¤è¡Œä¸­å»è¯»å–ã€‚</p>
<p>æˆ‘ä»¬çš„é…ç½®æ–‡ä»¶é™¤äº†<code>application.properties</code>è¿˜æœ‰è¿™ç§å½¢å¼çš„ï¼š<code>application-{profile}.properties</code>è¿™ä¸ªprofileå†³å®šä½ ä»£ç è¿è¡Œçš„ç¯å¢ƒã€‚å¯ä»¥æ˜¯devã€prodç­‰ç­‰ã€‚å…·ä½“å»åŠ è½½å“ªä¸ªé…ç½®æ–‡ä»¶å–å†³äº<code>spring.profiles.active</code>è¿™ä¸ªå±æ€§åˆ°åº•æ˜¯ä»€ä¹ˆã€‚ä¸ä¹‹å¯¹åº”å³å¯ã€‚å¦‚æœæœ‰å¤šä¸ª<code>application-{profile}.properties</code>æ–‡ä»¶å‡ºç°ï¼Œæœ€åå‡ºç°çš„ç”Ÿæ•ˆã€‚</p>
<p>springæ¨èä½¿ç”¨YMALä½œä¸ºé…ç½®æ–‡ä»¶ã€‚å®ƒæ˜¯JSONçš„è¶…é›†ã€‚spring frameworkæä¾›äº†2ä¸ªæ–¹ä¾¿çš„ç±»åŠ è½½YMALæ–‡ä»¶ï¼š<code>YamlPropertiesFactoryBean</code>å’Œ<code>YamlMapFactoryBean</code>ã€‚å‰è€…åŠ è½½æˆä¸€ä¸ª<code>Properties</code>ï¼Œåè€…åŠ è½½æˆä¸€ä¸ª<code>Map</code>ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">my:</div><div class="line">   servers:</div><div class="line">       - dev.bar.com</div><div class="line">       - foo.bar.com</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@ConfigurationProperties</span>(prefix=<span class="string">"my"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> List&lt;String&gt; servers = <span class="keyword">new</span> ArrayList&lt;String&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getServers</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.servers;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœ‹ä¸Šå»æœ‰ç§å¾ˆé…¸çˆ½çš„æ„Ÿè§‰ã€‚</p>
<p>åœ¨ä¸€ä¸ªYMALæ–‡ä»¶ä¸­ä¹Ÿå¯ä»¥æŒ‡å®šä¸åŒçš„profileçš„ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">server:</div><div class="line">    address: 192.168.1.100</div><div class="line">---</div><div class="line">spring:</div><div class="line">    profiles: development</div><div class="line">server:</div><div class="line">    address: 127.0.0.1</div><div class="line">---</div><div class="line">spring:</div><div class="line">    profiles: production</div><div class="line">server:</div><div class="line">    address: 192.168.1.120</div></pre></td></tr></table></figure></p>
<p><code>server.address</code>å±æ€§åœ¨ä¸åŒçš„profileä¸­æ˜¯ä¸åŒçš„ã€‚<code>development</code>è¢«æ¿€æ´»äº†ï¼Œå°±ä½¿ç”¨<code>127.0.0.1</code>.å…¶ä»–ç±»ä¼¼ã€‚éƒ½æ²¡æ¿€æ´»å°±ä½¿ç”¨é»˜è®¤çš„<code>192.168.1.100</code>.<br>ç„¶è€Œè¿™ç§æ–¹å¼æœ‰ç¼ºç‚¹ï¼Œä¸èƒ½é€šè¿‡<code>@PropertySource</code>æ³¨è§£ç›´æ¥æ³¨å…¥åˆ°beanå±æ€§ä¸­ã€‚</p>
<p>springé’ˆå¯¹<code>@Value(&quot;${property}&quot;)</code>è¿™ç§æ–¹å¼å»æ³¨å…¥å±æ€§æä¾›ä¸€ä¸ªæ›¿æ¢ã€‚é‚£å°±æ˜¯ä½¿ç”¨<code>@ConfigurationProperties(&quot;foo&quot;)</code>æ¥æ”¾åˆ°ä½ è¦æ³¨å…¥çš„ç±»ä¸­ã€‚å­—æ®µåå¯¹åº”å³å¯ï¼Œå³ä½¿æœ‰é‚£ç§ç»§æ‰¿ç»“æ„ä¹Ÿæ²¡å…³ç³»ã€‚YMALæœ¬èº«å¯¹è¿™ç§ç»§æ‰¿ç»“æ„æ”¯æŒçš„å¾ˆå¥½ã€‚</p>
<p>å…³äºExternalized Configurationçš„æ¢³ç†ä¹Ÿå·®ä¸å¤šäº†ã€‚å„ç§ç‚«é…·å±Œç‚¸å¤©ã€‚</p>
<p>å‰©ä¸‹çš„åœ¨ä»¥åå‡ ç¯‡æ–‡ç« ä¸­ç»§ç»­æ•´ç†ã€‚è¶Šæ¥è¶Šæœ‰è¶£äº†ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨spring bootå®˜æ–¹æ–‡æ¡£ä¸­ä»‹ç»äº†ä¸å°‘featureï¼Œæˆ‘è§‰å¾—æœ‰å¿…è¦æ•´ç†ä¸€ä¸‹ï¼Œè¿˜æ˜¯æŒºæœ‰æ„æ€çš„ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Spring Framework" scheme="http://www.wei-dong.top/categories/Spring-Framework/"/>
    
    
      <category term="Spring Boot" scheme="http://www.wei-dong.top/tags/Spring-Boot/"/>
    
      <category term="ç¿»è¯‘&amp;æ•´ç†" scheme="http://www.wei-dong.top/tags/%E7%BF%BB%E8%AF%91-%E6%95%B4%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>åŠ¨æ€ä»£ç†ç•ªå¤–ç¯‡</title>
    <link href="http://www.wei-dong.top/2017/07/16/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E7%95%AA%E5%A4%96%E7%AF%87/"/>
    <id>http://www.wei-dong.top/2017/07/16/åŠ¨æ€ä»£ç†ç•ªå¤–ç¯‡/</id>
    <published>2017-07-16T06:55:23.000Z</published>
    <updated>2017-07-16T06:59:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è¯´åˆ°åŠ¨æ€ä»£ç†çš„å®ç°é™¤äº†JDKè¿˜æœ‰ç¬¬ä¸‰æ–¹çš„å®ç°ã€‚ç°åœ¨å°±æ¥ç§ç§JDKä¹‹å¤–çš„åŠ¨æ€ä»£ç†çš„å®ç°ã€‚<a id="more"></a> </p>
<h2 id="Cglib"><a href="#Cglib" class="headerlink" title="Cglib"></a>Cglib</h2><p>è¿™ä¸ªåº“åœ¨Githubä¸Šæœ‰1390é¢—æ˜Ÿæ˜Ÿï¼Œä¸‹é¢æ˜¯å¯¹Cglibçš„æè¿°ã€‚</p>
<blockquote>
<p>cglib is a powerful, high performance and quality Code Generation Library, It is used to extend JAVA classes and implements interfaces at runtime. </p>
</blockquote>
<p>è¯´åˆ°ä½¿ç”¨è¿™ä¸ªåº“çš„æ¡†æ¶ï¼Œå…¶ä¸­å¤§åé¼é¼çš„Hibernateå°±ç”¨åˆ°äº†ï¼Œå½“ç„¶è¿˜æœ‰Springã€‚ Springçš„AOPé»˜è®¤ä½¿ç”¨JDKProxyï¼Œå¦‚æœè¢«ä»£ç†çš„ç±»æ²¡æœ‰å®ç°æ¥å£å°±ä½¿ç”¨Cglibå»ç”ŸæˆåŠ¨æ€ä»£ç†ç±»ã€‚</p>
<p>å®ƒçš„å‡ºç°æ˜¯ä¸ºäº†å¼¥è¡¥JDKåŠ¨æ€ä»£ç†ä¸­ä¸èƒ½å¯¹æœªå®ç°æ¥å£çš„ç±»è¿›è¡Œä»£ç†ã€‚å…¶åŸç†ä¹Ÿå¯æƒ³è€ŒçŸ¥äº†ï¼Œæ— éå°±æ˜¯åŠ¨æ€ç”Ÿæˆä¸€ä¸ªå­ç±»ï¼Œè¿™ä¸ªå­ç±»ç»§æ‰¿äº†è¦ä»£ç†çš„ç±»ï¼Œç„¶åå»é‡å†™çˆ¶ç±»ï¼ˆéœ€è¦ä»£ç†çš„ç±»ï¼‰çš„æ–¹æ³•ã€‚è¿™æ ·çš„è¯ï¼Œä»£ç†ç±»å°±ä¸€å®šä¸èƒ½æ˜¯finalç±»å‹äº†ï¼Œéœ€è¦ä»£ç†çš„æ–¹æ³•ä¹Ÿä¸èƒ½æ˜¯finalã€‚å› ä¸ºJavaä¸å…è®¸ç»§æ‰¿finalç±»ï¼Œä¸å…è®¸é‡å†™finalæ–¹æ³•ã€‚<br>ä¸‹é¢é€šè¿‡ä¸€ä¸ªå®ä¾‹æ¥ä»‹ç»Cglibå®ç°åŠ¨æ€ä»£ç†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * éœ€è¦è¢«ä»£ç†çš„ç›®æ ‡ç±»</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TargetClass</span>  </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(String name)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"hello ,"</span>+ name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"TargetClass&#123;&#125;"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * ç›®æ ‡å¯¹è±¡æ‹¦æˆªå™¨ï¼Œå®ç°MethodInterceptor</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TargetIncerceptor</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * é‡å†™æ–¹æ³•æ‹¦æˆªåœ¨æ–¹æ³•å‰å’Œæ–¹æ³•ååŠ å…¥ä¸šåŠ¡</div><div class="line">     * <span class="doctag">@param</span> o ä¸ºç›®æ ‡å¯¹è±¡</div><div class="line">     * <span class="doctag">@param</span> method ä¸ºç›®æ ‡æ–¹æ³•</div><div class="line">     * <span class="doctag">@param</span> objects ä¸ºå‚æ•°</div><div class="line">     * <span class="doctag">@param</span> methodProxy CGlibæ–¹æ³•ä»£ç†å¯¹è±¡ </div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@throws</span> Throwable</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] objects, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"è°ƒç”¨å‰"</span>);</div><div class="line">        Object result = methodProxy.invokeSuper(o, objects);</div><div class="line">        System.out.println(<span class="string">" è°ƒç”¨å"</span>+result);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibCase</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Enhancer enhancer = <span class="keyword">new</span> Enhancer();</div><div class="line">        enhancer.setSuperclass(TargetClass.class);</div><div class="line">        enhancer.setCallback(<span class="keyword">new</span> TargetIncerceptor());</div><div class="line">        TargetClass targetClass = (TargetClass) enhancer.create();</div><div class="line"></div><div class="line">        String hello = targetClass.hello(<span class="string">"dw"</span>);</div><div class="line">        System.out.println(hello);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä»è¡¨é¢ä¸Šæ¥çœ‹å’ŒJDKçš„ä½¿ç”¨è¿˜æ˜¯æœ‰ç±»ä¼¼çš„åœ°æ–¹çš„ã€‚Cglibä½¿ç”¨<code>Enhancer</code>æ¥å»è£…è½½çˆ¶ç±»ï¼Œå°†æ–¹æ³•æ‹¦æˆªå™¨æ¤å…¥åˆ°ç”Ÿæˆçš„å­ç±»å­—èŠ‚ç ä¸­ï¼Œæœ€ååˆ›å»ºå¯¹è±¡ã€‚Cgilbä¾èµ–ASMå­—èŠ‚ç æ¡†æ¶å»åŠ¨æ€ç”Ÿæˆå­—èŠ‚ç ï¼Œå…·ä½“ç”Ÿæˆå‡ºæ¥çš„å­—èŠ‚ç æ–‡ä»¶å’ŒJDKåŠ¨æ€ä»£ç†ç”Ÿæˆå‡ºæ¥çš„å·®åˆ«å¾ˆå¤§ï¼ŒåŒºåˆ«å°±åœ¨äºCglibç”Ÿæˆçš„ä»£ç†ç±»æ²¡æœ‰ä½¿ç”¨åå°„å»è°ƒç”¨è¦è¢«ä»£ç†çš„æ–¹æ³•ã€‚ä»è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºCglibåœ¨æ‰§è¡Œæ•ˆç‡ä¸Šè¦æ¯”JDKåŠ¨æ€ä»£ç†è¦é«˜ï¼Œæ¯•ç«Ÿåå°„æ•ˆç‡æ˜¯å¾ˆä½çš„ã€‚</p>
<h2 id="Byte-Buddy"><a href="#Byte-Buddy" class="headerlink" title="Byte Buddy"></a>Byte Buddy</h2><p>è¿™ä¸ªç±»åº“æ˜¯æœ€è¿‘çœ‹ä¸€ä¸ªRPCæ¡†æ¶ä»£ç çš„æ—¶å€™å‘ç°çš„ã€‚èµ·å› æ˜¯è‡ªå·±æƒ³å°è¯•ç€å†™ä¸€ä¸ªç®€å•çš„è¿œç¨‹æ–¹æ³•è°ƒç”¨çš„æ ·ä¾‹ç¨‹åºï¼Œåœ¨Githubä¸Šæ‰¾åˆ°äº†ä¸€ä¸ªç®€å•çš„åŸºäºNettyçš„å®ç°ï¼Œå…¶ä¸­åœ¨å¤„ç†åŠ¨æ€ä»£ç†çš„æ—¶å€™é™¤äº†ä½¿ç”¨JDKçš„å®ç°è¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„å®ç°ï¼Œé‚£å°±æ˜¯Byte Buddyã€‚ç„¶åç¨å¾®ç ”ç©¶äº†ä¸€ç•ªï¼Œå‘ç°ä½¿ç”¨è¿™ä¸ªç±»åº“å†™åŠ¨æ€ä»£ç†ç¡®å®å¾ˆæ–¹ä¾¿ã€‚</p>
<p>åºŸè¯ä¸å¤šè®²ï¼Œå…ˆç®€å•çš„çœ‹ä»£ç å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å®šä¹‰æ¥å£</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Hello</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">sayHi</span><span class="params">(String name)</span></span>;</div><div class="line">    <span class="function">String <span class="title">sayHi</span><span class="params">(String name,<span class="keyword">int</span> time)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sayHi</span><span class="params">(<span class="keyword">int</span> i)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å®ç°ç±»</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloImpl</span> <span class="keyword">implements</span> <span class="title">Hello</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHi</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"Hello "</span>+name;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHi</span><span class="params">(String name, <span class="keyword">int</span> time)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> time+<span class="string">" Hello "</span>+name ;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHi</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"nothing"</span>+i);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteBuddyProxy</span> </span>&#123;</div><div class="line">	<span class="comment">//åˆ›å»ºä»£ç†å¯¹è±¡</span></div><div class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getInstance</span><span class="params">(Class&lt;T&gt; clazz,Object handler)</span></span>&#123;</div><div class="line"></div><div class="line">        Class&lt;? extends T&gt; cls = <span class="keyword">new</span> ByteBuddy()</div><div class="line">                .subclass(clazz)</div><div class="line">                .method(ElementMatchers.isDeclaredBy(clazz))</div><div class="line">                .intercept(MethodDelegation.to(handler))</div><div class="line">                .make()</div><div class="line">                .load(clazz.getClassLoader(), ClassLoadingStrategy.Default.INJECTION)</div><div class="line">                .getLoaded();</div><div class="line"></div><div class="line">        T t = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">           t = cls.newInstance();</div><div class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> t;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        ByteBuddyProxy proxy = <span class="keyword">new</span> ByteBuddyProxy();</div><div class="line">        Hello hello = proxy.getInstance(Hello.class, <span class="keyword">new</span> Invoker(HelloImpl.class));</div><div class="line">        hello.sayHi(<span class="number">1</span>);</div><div class="line">        String sayHi = hello.sayHi(<span class="string">"dongwei"</span>,<span class="number">9</span>);</div><div class="line">        System.out.println(sayHi);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//æš‚æ—¶ç†è§£ä¸ºå’ŒJDK Proxyä¸­çš„InvocationHandlerä¸€æ ·çš„ä¸œè¥¿å§</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Invoker</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> Class&lt;?&gt; clazz;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Invoker</span><span class="params">(Class&lt;?&gt; clazz)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.clazz = clazz;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@RuntimeType</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(@Origin Method method, @AllArguments @RuntimeType Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        Object result = method.invoke(clazz.newInstance(),args);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™åªæ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„å°æ —å­ï¼Œè¿˜æœ‰å¾ˆå¤šå¤æ‚çš„ç‰¹æ€§æ²¡æœ‰æ·±å…¥ç ”ç©¶ã€‚æˆ‘åªèƒ½å¯¹å†™è¿™ä¸ªåº“çš„ä½œè€…è¡¨ç¤ºå¾ˆå´‡é«˜çš„æ•¬ä½©ï¼</p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>å½“ç„¶é™¤äº†æ–‡ç« ä¸­æ‰€ä»‹ç»çš„ç”ŸæˆåŠ¨æ€ä»£ç†çš„å·¥å…·è¿˜æœ‰å¾ˆå¤šæ²¡æœ‰æåŠï¼Œæ¯”æ–¹è¯´javaassitç­‰ã€‚å…¶åŸç†å¤§è‡´ç±»ä¼¼ï¼Œæ— éå°±æ˜¯åœ¨JVMåŠ è½½å­—èŠ‚ç çš„æ—¶å€™å°†å­—èŠ‚ç ç»™æ›¿æ¢äº†æˆ–è€…æ”¹æ‰äº†ï¼Œå¾ˆå¤šéƒ½ä¾èµ–äºASMåº“ï¼Œå¦‚æœå¯¹classå­—èŠ‚ç è§„èŒƒå¾ˆç†Ÿæ‚‰çš„è¯è‡ªå·±ä¹Ÿå¯ä»¥ä½¿ç”¨ASMæ¥å†™ä¸€ä¸ªå­—èŠ‚ç ç”Ÿæˆå·¥å…·ã€‚<br>ä»é˜…è¯»åˆ«äººå†™çš„RPCæ¡†æ¶çš„æºç ä¸­å‘ç°äº†å¾ˆå¤šæœ‰æ„æ€çš„ä¸œè¥¿ï¼Œä»å…¶ä¸­çš„åŠ¨æ€ä»£ç†å¯ä»¥äº†è§£åˆ°å­—èŠ‚ç ç”ŸæˆåŠ è½½ã€‚æ…¢æ…¢æ‰å‘ç°å†™ä»£ç çœŸçš„ä¸æ˜¯æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•çš„ï¼Œå˜åŒ–çš„ä¸œè¥¿å¤ªå¤šäº†ï¼Œä¹Ÿåªæœ‰æ—¶åˆ»ä¿æŒç€å­¦ä¹ çš„æ€åº¦ä¹Ÿæ‰å¯èƒ½è·Ÿå¾—ä¸ŠèŠ‚å¥ï¼Œæ‰ä¸ä¼šè¢«æ·˜æ±°ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è¯´åˆ°åŠ¨æ€ä»£ç†çš„å®ç°é™¤äº†JDKè¿˜æœ‰ç¬¬ä¸‰æ–¹çš„å®ç°ã€‚ç°åœ¨å°±æ¥ç§ç§JDKä¹‹å¤–çš„åŠ¨æ€ä»£ç†çš„å®ç°ã€‚
    
    </summary>
    
      <category term="OPEN SOURCE" scheme="http://www.wei-dong.top/categories/OPEN-SOURCE/"/>
    
    
      <category term="å­—èŠ‚ç å·¥å…·" scheme="http://www.wei-dong.top/tags/%E5%AD%97%E8%8A%82%E7%A0%81%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>åŠ¨æ€ä»£ç†ä¹‹JDKå®ç°</title>
    <link href="http://www.wei-dong.top/2017/07/09/%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E4%B9%8BJDK%E5%AE%9E%E7%8E%B0/"/>
    <id>http://www.wei-dong.top/2017/07/09/åŠ¨æ€ä»£ç†ä¹‹JDKå®ç°/</id>
    <published>2017-07-09T02:29:23.000Z</published>
    <updated>2017-07-09T02:32:52.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å‘¢ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªå¼€æºçš„PRC FRAMEWORKï¼Œå½“ç„¶ä¸æ˜¯Dubboã€‚ç„¶åæƒ³å»äº†è§£ä¸€ä¸‹RPCåˆ°åº•æ˜¯æ€ä¹ˆå»å®ç°çš„ã€‚äºæ˜¯ä¹å°±äº†è§£äº†ä¸€ç•ªï¼Œå‘ç°å…¶çµé­‚åœ¨äºåŠ¨æ€ä»£ç†å’Œåå°„ã€‚<a id="more"></a> </p>
<h5 id="Whatâ€™s-Dynamic-Proxy"><a href="#Whatâ€™s-Dynamic-Proxy" class="headerlink" title="Whatâ€™s Dynamic Proxy ?"></a>Whatâ€™s Dynamic Proxy ?</h5><p>åœ¨è®²ä»€ä¹ˆæ˜¯åŠ¨æ€ä»£ç†å‰å…ˆå¾—æ˜ç™½ä»€ä¹ˆæ˜¯ä»£ç†ã€‚åœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­çš„ä»£ç†å…¶å®å°±æ˜¯å§”æ‰˜çš„æ„æ€ã€‚å°†äº‹æƒ…äº¤ä»£ç»™å§”æ‰˜å¯¹è±¡å»åšï¼Œè¿™å°±æ˜¯ä»£ç†ã€‚ç¨‹åºä¸­çš„ä»£ç†æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿè¿™é‡Œæ›´å‡†ç¡®çš„è§£é‡Šåº”è¯¥æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼â€“ä»£ç†æ¨¡å¼ï¼ˆProxy)<br><img src="http://img.my.csdn.net/uploads/201211/29/1354197582_1664.PNG" alt="Proxy"><br>ä¸‹é¢ç»™å‡ºä¸€ä¸ªç®€å•çš„å…³äºä»£ç†çš„Javaå®ç°ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Sourceable</span> </span>&#123;  </div><div class="line">	<span class="comment">//ä¸»é¢˜æ¥å£</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span></span>;  </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Source</span> <span class="keyword">implements</span> <span class="title">Sourceable</span> </span>&#123;  </div><div class="line">	<span class="comment">//æ¥å£å®ç°</span></div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;  </div><div class="line">        System.out.println(<span class="string">"the original method!"</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä»£ç†ç±»</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Sourceable</span> </span>&#123;  </div><div class="line">	</div><div class="line">    <span class="keyword">private</span> Source source;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Proxy</span><span class="params">()</span></span>&#123;  </div><div class="line">        <span class="keyword">super</span>();  </div><div class="line">        <span class="keyword">this</span>.source = <span class="keyword">new</span> Source();  </div><div class="line">    &#125;  </div><div class="line">    <span class="meta">@Override</span>  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;  </div><div class="line">        before();  </div><div class="line">        source.method();  </div><div class="line">        atfer();  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">atfer</span><span class="params">()</span> </span>&#123;  </div><div class="line">        System.out.println(<span class="string">"after proxy!"</span>);  </div><div class="line">    &#125;  </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;  </div><div class="line">        System.out.println(<span class="string">"before proxy!"</span>);  </div><div class="line">    &#125;  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//è°ƒç”¨å®¢æˆ·ç«¯</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProxyTest</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </div><div class="line">        Sourceable source = <span class="keyword">new</span> Proxy();  </div><div class="line">        source.method();  </div><div class="line">    &#125; </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­ä»£ç†ç±»ä¸­å¯¹ä¸»é¢˜æ¥å£è¿›è¡Œäº†å¢å¼ºâ€”åœ¨ä¸»é¢˜æ–¹æ³•è°ƒç”¨å‰åè°ƒç”¨äº†<code>before</code>å’Œ<code>after</code> ã€‚Spring AOPä¸­çš„æ€æƒ³æ­£æ˜¯å¦‚æ­¤ã€‚<br>è¿™å°±æ˜¯Javaä¸­çš„ä»£ç†æ¨¡å¼ï¼Œåªä¸è¿‡ä¸Šé¢çš„ä»£ç å®ç°æ˜¯åŸºäºç¡¬ç¼–ç çš„ï¼Œä¹Ÿå°±æ˜¯æ‰€è¯´çš„<strong>é™æ€ä»£ç†</strong>ã€‚é‚£ä¹ˆåŒºåˆ«äºé™æ€ä»£ç†ï¼Œé‚£å°±ä¸€å®šæœ‰<strong>åŠ¨æ€ä»£ç†äº†</strong>ã€‚<br>é€šè¿‡ä»¥ä¸Šçš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œé™æ€ä»£ç†å°†ä»£ç å†™æ­»ï¼Œæ˜¯åœ¨ç¼–è¯‘é˜¶æ®µå®Œæˆçš„å…·ä½“ä»£ç†ç±»çš„ç»‘å®šã€‚ä½†æ˜¯åŠ¨æ€ä»£ç†ä¸æ˜¯è¿™ä¹ˆåšçš„ï¼Œè€Œæ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶å®Œæˆçš„è¿™æ“ä½œã€‚ä¸‹é¢ä½¿ç”¨åŠ¨æ€ä»£ç†æ–¹å¼å®ç°ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ä½¿ç”¨jdkåŠ¨æ€ä»£ç†å®ç°éœ€è¦å®ç°æ¥å£InvocationHandler</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkProxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Object targrt;<span class="comment">//ä»£ç†çš„çœŸå®å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æ¥å£çš„å®ç°ç±»</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JdkProxy</span><span class="params">(Object targrt)</span></span>&#123;</div><div class="line">        <span class="keyword">this</span>.targrt = targrt;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     *</div><div class="line">     * è¯¥æ–¹æ³•è´Ÿè´£é›†ä¸­å¤„ç†åŠ¨æ€ä»£ç†ç±»ä¸Šçš„æ‰€æœ‰æ–¹æ³•è°ƒç”¨ã€‚</div><div class="line">     * è°ƒç”¨å¤„ç†å™¨æ ¹æ®è¿™ä¸‰ä¸ªå‚æ•°è¿›è¡Œé¢„å¤„ç†æˆ–åˆ†æ´¾åˆ°å§”æ‰˜ç±»å®ä¾‹ä¸Šåå°„æ‰§è¡Œ</div><div class="line">     * <span class="doctag">@param</span> proxy ä»£ç†ç±»å®ä¾‹</div><div class="line">     * <span class="doctag">@param</span> method è¢«è°ƒç”¨çš„æ–¹æ³•å¯¹è±¡</div><div class="line">     * <span class="doctag">@param</span> args è°ƒç”¨å‚æ•°</div><div class="line">     * <span class="doctag">@return</span></div><div class="line">     * <span class="doctag">@throws</span> Throwable</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="comment">//è¿™é‡Œæ¥å¤„ç†ä»£ç†çš„å…·ä½“å·¥ä½œ</span></div><div class="line">        <span class="comment">//å‡è®¾åœ¨æ‰§è¡Œå‰è¿›è¡Œä¸€ä¸ªæ‰“å°æ—¥å¿—çš„å¤„ç†</span></div><div class="line">        before();</div><div class="line">        Object result = method.invoke(targrt, args);</div><div class="line">        <span class="comment">//å‡è®¾æ‰§è¡Œç»“æŸåæ‰“å°ä¸€ä¸ªæ‰§è¡Œå®Œæˆçš„é€šçŸ¥</span></div><div class="line">        atfer();</div><div class="line">        <span class="comment">//å°†æ‰§è¡Œç»“æœè¿”å›å¦‚æœæœ‰çš„è¯</span></div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">atfer</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"after proxy!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"before proxy!"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getProxy</span><span class="params">(Class[] interfaceClass)</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),</div><div class="line">                                        interfaceClass,<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å®¢æˆ·ç«¯</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkProxyCase</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Sourceable s = <span class="keyword">new</span> Source();</div><div class="line"></div><div class="line">        JdkProxy proxy = <span class="keyword">new</span> JdkProxy(s);</div><div class="line"></div><div class="line">        Sourceable hello = (Sourceable) proxy.getProxy(<span class="keyword">new</span> Class[]&#123;Sourceable.class&#125;);</div><div class="line">        </div><div class="line">        hello.method();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç”±æ­¤å¯è§ï¼Œæˆ‘ä»¬å¯¹ä¸»é¢˜å¯¹è±¡æ‰€æœ‰çš„æ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šå˜æˆå¯¹<code>invoke</code>æ–¹æ³•çš„è°ƒç”¨ï¼Œè€Œæˆ‘ä»¬å¯ä»¥åœ¨è¿™ä¸ªæ–¹æ³•ä¸­æ·»åŠ ç»Ÿä¸€çš„é€»è¾‘å¤„ç†ã€‚<br>æ‰€ä»¥å¯ä»¥çœ‹å‡ºï¼ŒåŠ¨æ€ä»£ç†çš„å‡ ä¸ªå¥½å¤„ï¼š</p>
<ul>
<li>æ˜“äºç»´æŠ¤ã€‚ç›¸å¯¹äºé™æ€ä»£ç†æ¥è¯´ï¼Œåªè¦åœ¨Proxyç±»ä¸­å›ºå®šå¥½å¤„ç†é€»è¾‘è€Œä¸ç”¨é’ˆå¯¹æ¯ä¸ªæ–¹æ³•å»ç¼–å†™ä»£ç äº†ã€‚æ§åˆ¶äº†ä»£ç é‡ï¼Œä¾¿äºç»´æŠ¤ã€‚</li>
<li>ä½¿AOPç¼–ç¨‹æ›´åŠ å®¹æ˜“ã€‚åœ¨Springçš„å¸®åŠ©ä¸‹è½»æ¾æ·»åŠ ã€ç§»é™¤åŠ¨æ€ä»£ç†ï¼Œä¸”å¯¹æºä»£ç æ²¡æœ‰ä»»ä½•å½±å“ã€‚</li>
<li>è§£è€¦ã€‚å¯ä»¥é€šè¿‡å‚æ•°å°±èƒ½åˆ¤æ–­å…·ä½“å®ç°ç±»ï¼Œä¸éœ€è¦äº‹å…ˆå®ä¾‹åŒ–ï¼Œæ›´åŠ çµæ´»å¤šå˜ã€‚<h5 id="The-Mechanism-of-Dynamic-Proxy"><a href="#The-Mechanism-of-Dynamic-Proxy" class="headerlink" title="The Mechanism of Dynamic Proxy"></a>The Mechanism of Dynamic Proxy</h5>è°ˆå®Œäº†ä»€ä¹ˆæ˜¯åŠ¨æ€ä»£ç†ï¼Œç°åœ¨å°±å¯ä»¥æ¥äº†è§£ä¸€ä¸‹åŠ¨æ€ä»£ç†æ˜¯æ€ä¹ˆå®ç°çš„äº†ã€‚è¦å»çŸ¥é“JdkåŠ¨æ€ä»£ç†æ˜¯æ€ä¹ˆå®ç°çš„è¿˜å¾—å»æºç ä¸­æ‰¾ã€‚<br>çœ‹çœ‹<code>Proxy#newProxyInstance</code>çš„å®ç°ã€‚<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">newProxyInstance</span><span class="params">(ClassLoader loader,Class&lt;?&gt;[] interfaces,InvocationHandler h)</span></span></div><div class="line">        <span class="keyword">throws</span> IllegalArgumentException</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (h == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> SecurityManager sm = System.getSecurityManager();</div><div class="line">        <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</div><div class="line">            checkProxyAccess(Reflection.getCallerClass(), loader, interfaces);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * æ‰¾ç¼“å­˜é‡Œæœ‰æ²¡æœ‰Proxyå¯¹è±¡ï¼Œæ²¡æœ‰å°±ç”Ÿæˆä¸€ä¸ª.</div><div class="line">         */</div><div class="line">        Class&lt;?&gt; cl = getProxyClass0(loader, interfaces);</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Invoke its constructor with the designated invocation handler.</div><div class="line">         * ç”¨æŒ‡å®šçš„handleræ¥è°ƒç”¨æ„é€ æ–¹æ³•</div><div class="line">         */</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">final</span> Constructor&lt;?&gt; cons = cl.getConstructor(constructorParams);</div><div class="line">            <span class="keyword">final</span> InvocationHandler ih = h;</div><div class="line">            <span class="keyword">if</span> (sm != <span class="keyword">null</span> &amp;&amp; ProxyAccessHelper.needsNewInstanceCheck(cl)) &#123;</div><div class="line">                <span class="comment">// create proxy instance with doPrivilege as the proxy class may</span></div><div class="line">                <span class="comment">// implement non-public interfaces that requires a special permission</span></div><div class="line">                <span class="keyword">return</span> AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Object&gt;() &#123;</div><div class="line">                    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        <span class="keyword">return</span> newInstance(cons, ih);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> newInstance(cons, ih);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(e.toString());</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>ä»ä¸Šé¢çš„ä»£ç ä¸­ä¸éš¾çœ‹å‡ºå…¶æ ¸å¿ƒåœ¨äºè·å–ä¸€ä¸ªä»£ç†ç±»å¯¹è±¡ã€‚å¾—åˆ°ç±»å¯¹è±¡åå†é€šè¿‡åå°„å»åˆ›å»ºä»£ç†å¯¹è±¡å®ä¾‹ã€‚çœ‹çœ‹<code>getProxyClass0</code>æ€ä¹ˆå®ç°çš„ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Generate a proxy class.  Must call the checkProxyAccess method</div><div class="line">     * to perform permission checks before calling this.</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Class&lt;?&gt; getProxyClass0(ClassLoader loader,</div><div class="line">                                           Class&lt;?&gt;... interfaces) &#123;</div><div class="line">        <span class="keyword">if</span> (interfaces.length &gt; <span class="number">65535</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"interface limit exceeded"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// If the proxy class defined by the given loader implementing</span></div><div class="line">        <span class="comment">// the given interfaces exists, this will simply return the cached copy;</span></div><div class="line">        <span class="comment">// otherwise, it will create the proxy class via the ProxyClassFactory</span></div><div class="line">        <span class="keyword">return</span> proxyClassCache.get(loader, interfaces);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å‘ƒâ€¦å¥½å§ï¼è¿™ä¸ªæ–¹æ³•æ˜¯ä»ä¸€ä¸ªcacheå¯¹è±¡ä¸­å»æ‹¿Proxyç±»å¯¹è±¡çš„ã€‚æ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯ä¸çŸ¥é“ä»£ç†ç±»å¯¹è±¡æ˜¯æ€ä¹ˆäº§ç”Ÿçš„ã€‚ä¸è¿‡è¿™é‡Œæœ‰ä¸€ç‚¹æœ‰ç‚¹æ„æ€ï¼Œå°±æ˜¯ä»£ç†ç±»å®ç°çš„æ¥å£æ•°ä¸èƒ½è¶…è¿‡65535ä¸ªã€‚çœ‹åˆ°è¿™ä¸ªæ•°å­—æ˜¯å¦å¾ˆæƒŠå–œæˆ–è€…ä¹Ÿæœ‰ç‚¹æ„å¤–ï¼Ÿå…³äº65535æˆ‘ç‰¹æ„å»æŸ¥äº†ä¸€ä¸‹<a href="https://en.wikipedia.org/wiki/65535_(number" target="_blank" rel="external">Wiki</a>)ã€‚è¿™æ˜¯Javaè¯­è¨€æœºåˆ¶å¯¼è‡´çš„ã€‚å½“ç„¶æ²¡æœ‰å“ªä¸ªå˜æ€å»å®ç°è¿™ä¹ˆå¤šä¸ªæ¥å£å§ã€‚<br>æ—¢ç„¶ä»cacheä¸­å»æ‰¾ï¼Œé‚£ä¹ˆçœ‹çœ‹è¿™ä¸ªcacheåˆ°åº•æ˜¯ä½•æ–¹ç¥åœ£ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * a cache of proxy classes</div><div class="line">     */</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> WeakCache&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;</div><div class="line">        proxyClassCache = <span class="keyword">new</span> WeakCache&lt;&gt;(<span class="keyword">new</span> KeyFactory(), <span class="keyword">new</span> ProxyClassFactory());</div></pre></td></tr></table></figure></p>
<p>å…·ä½“åˆ°è¿™ä¸ªcacheæ˜¯æ€ä¹ˆå®ç°çš„å°±ä¸å»çº ç»“äº†ï¼Œå› ä¸ºçº ç»“ä¹Ÿæ²¡ç”¨ï¼ˆAPIæ–‡æ¡£ä¸­æ²¡æœ‰è¿™ä¸ªç±»çš„è§£é‡Šï¼Œå› ä¸ºè¿™ä¸ªç±»çš„ä¿®é¥°æ˜¯package-privateçš„è€Œä¸æ˜¯publicï¼‰ã€‚ä»”ç»†ä»¥çœ‹æœ‰ä¸€ä¸ª<code>ProxyClassFactory</code>å¯¹è±¡ä½œä¸ºå‚æ•°ä¼ ç»™è¿™ä¸ªcacheäº†ã€‚è¿™ä¸‹è‡ªè²Œä¼¼æœ‰æå¤´äº†ã€‚çœ‹çœ‹è¿™ä¸ªç±»çš„åå­—å°±å¾ˆçˆ½â€”ä»£ç†ç±»å·¥å‚å˜›ã€‚å®é™…ä¸Šè¿™æ˜¯Proxyçš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»ã€‚<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line">private static final class ProxyClassFactory</div><div class="line">        implements BiFunction&lt;ClassLoader, Class&lt;?&gt;[], Class&lt;?&gt;&gt;</div><div class="line">    &#123;</div><div class="line">        // ç”Ÿæˆä»£ç†ç±»åç§°çš„å‰ç¼€</div><div class="line">        private static final String proxyClassNamePrefix = "$Proxy";</div><div class="line"></div><div class="line">        // ç”¨äºç”Ÿæˆä»£ç†ç±»åå­—çš„è®¡æ•°å™¨ </div><div class="line">        private static final AtomicLong nextUniqueNumber = new AtomicLong();</div><div class="line"></div><div class="line">        @Override</div><div class="line">        public Class&lt;?&gt; apply(ClassLoader loader, Class&lt;?&gt;[] interfaces) &#123;</div><div class="line">			//å„ç§éªŒè¯</div><div class="line">            Map&lt;Class&lt;?&gt;, Boolean&gt; interfaceSet = new IdentityHashMap&lt;&gt;(interfaces.length);</div><div class="line">            for (Class&lt;?&gt; intf : interfaces) &#123;</div><div class="line">                /*</div><div class="line">                 * Verify that the class loader resolves the name of this</div><div class="line">                 * interface to the same Class object.</div><div class="line">                 */</div><div class="line">                Class&lt;?&gt; interfaceClass = null;</div><div class="line">                try &#123;</div><div class="line">                    interfaceClass = Class.forName(intf.getName(), false, loader);</div><div class="line">                &#125; catch (ClassNotFoundException e) &#123;</div><div class="line">                &#125;</div><div class="line">                if (interfaceClass != intf) &#123;</div><div class="line">                    throw new IllegalArgumentException(</div><div class="line">                        intf + " is not visible from class loader");</div><div class="line">                &#125;</div><div class="line">                /*</div><div class="line">                 * Verify that the Class object actually represents an</div><div class="line">                 * interface.</div><div class="line">                 */</div><div class="line">                if (!interfaceClass.isInterface()) &#123;</div><div class="line">                    throw new IllegalArgumentException(</div><div class="line">                        interfaceClass.getName() + " is not an interface");</div><div class="line">                &#125;</div><div class="line">                /*</div><div class="line">                 * Verify that this interface is not a duplicate.</div><div class="line">                 */</div><div class="line">                if (interfaceSet.put(interfaceClass, Boolean.TRUE) != null) &#123;</div><div class="line">                    throw new IllegalArgumentException(</div><div class="line">                        "repeated interface: " + interfaceClass.getName());</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">			//ä»£ç†ç±»çš„åŒ…å</div><div class="line">            String proxyPkg = null;     // package to define proxy class in</div><div class="line"></div><div class="line">            //å¯¹äºä¸æ˜¯publicä¿®é¥°çš„æ¥å£ï¼Œä»£ç†ç±»çš„åŒ…åå’Œæ¥å£åŒ…åä¸€è‡´</div><div class="line">            for (Class&lt;?&gt; intf : interfaces) &#123;</div><div class="line">                int flags = intf.getModifiers();</div><div class="line">                if (!Modifier.isPublic(flags)) &#123;</div><div class="line">                    String name = intf.getName();</div><div class="line">                    int n = name.lastIndexOf('.');</div><div class="line">                    String pkg = ((n == -1) ? "" : name.substring(0, n + 1));</div><div class="line">                    if (proxyPkg == null) &#123;</div><div class="line">                        proxyPkg = pkg;</div><div class="line">                    &#125; else if (!pkg.equals(proxyPkg)) &#123;</div><div class="line">                        throw new IllegalArgumentException(</div><div class="line">                            "non-public interfaces from different packages");</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">			//publicä¿®é¥°çš„æ¥å£ åŒ…åç»Ÿä¸€ä¸ºcom.sun.proxy</div><div class="line">            if (proxyPkg == null) &#123;</div><div class="line">                // if no non-public proxy interfaces, use com.sun.proxy package</div><div class="line">                proxyPkg = ReflectUtil.PROXY_PACKAGE + ".";</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            /*</div><div class="line">             * Choose a name for the proxy class to generate.</div><div class="line">             */</div><div class="line">            long num = nextUniqueNumber.getAndIncrement();</div><div class="line">            // é»˜è®¤æƒ…å†µä¸‹ï¼Œä»£ç†ç±»çš„å®Œå…¨é™å®šåä¸ºï¼šcom.sun.proxy.$Proxy0ï¼Œcom.sun.proxy.$Proxy1â€¦â€¦ä¾æ¬¡é€’å¢  </div><div class="line">            String proxyName = proxyPkg + proxyClassNamePrefix + num;</div><div class="line"></div><div class="line">            // è¿™é‡Œæ‰æ˜¯çœŸæ­£çš„ç”Ÿæˆä»£ç†ç±»çš„å­—èŠ‚ç çš„åœ°æ–¹  </div><div class="line">            byte[] proxyClassFile = ProxyGenerator.generateProxyClass(</div><div class="line">                proxyName, interfaces);</div><div class="line">            try &#123;</div><div class="line">	            // æ ¹æ®äºŒè¿›åˆ¶å­—èŠ‚ç è¿”å›ç›¸åº”çš„Classå®ä¾‹  </div><div class="line">                return defineClass0(loader, proxyName,</div><div class="line">                                    proxyClassFile, 0, proxyClassFile.length);</div><div class="line">            &#125; catch (ClassFormatError e) &#123;</div><div class="line">                /*</div><div class="line">                 * A ClassFormatError here means that (barring bugs in the</div><div class="line">                 * proxy class generation code) there was some other</div><div class="line">                 * invalid aspect of the arguments supplied to the proxy</div><div class="line">                 * class creation (such as virtual machine limitations</div><div class="line">                 * exceeded).</div><div class="line">                 */</div><div class="line">                throw new IllegalArgumentException(e.toString());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å”‰ï¼Œæ„Ÿè§‰çœ‹äº†åŠå¤©å‘ç°åˆè¢«ç»•è¿›å»äº†ã€‚æ²¡åŠæ³•ï¼Œç»§ç»­çœ‹çœ‹<code>ProxyGenerator</code>è¿™ä¸ªç±»æ€ä¹ˆå»å®ç°çš„ã€‚è¿™ä¸ªæ˜¯Jdkç§æœ‰çš„ï¼Œä½†æ˜¯å¯ä»¥åç¼–è¯‘æŸ¥çœ‹ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] generateProxyClass(<span class="keyword">final</span> String var0, Class[] var1) &#123;</div><div class="line">        ProxyGenerator var2 = <span class="keyword">new</span> ProxyGenerator(var0, var1);</div><div class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] var3 = var2.generateClassFile();</div><div class="line">        <span class="comment">// è¿™é‡Œæ ¹æ®å‚æ•°é…ç½®ï¼Œå†³å®šæ˜¯å¦æŠŠç”Ÿæˆçš„å­—èŠ‚ç ï¼ˆ.classæ–‡ä»¶ï¼‰ä¿å­˜åˆ°æœ¬åœ°ç£ç›˜ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŠŠç›¸åº”çš„classæ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°ï¼Œå†åç¼–è¯‘æ¥çœ‹çœ‹å…·ä½“çš„å®ç°ï¼Œè¿™æ ·æ›´ç›´è§‚  </span></div><div class="line">        <span class="keyword">if</span>(saveGeneratedFiles) &#123;</div><div class="line">            AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction() &#123;</div><div class="line">                <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        FileOutputStream var1 = <span class="keyword">new</span> FileOutputStream(ProxyGenerator.dotToSlash(var0) + <span class="string">".class"</span>);</div><div class="line">                        var1.write(var3);</div><div class="line">                        var1.close();</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException var2) &#123;</div><div class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> InternalError(<span class="string">"I/O exception saving generated file: "</span> + var2);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> var3;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­ï¼Œè¿™ä¸ªå‚æ•°çš„å®šä¹‰æ˜¯é…±ç´«çš„ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> saveGeneratedFiles = ((Boolean)AccessController.doPrivileged(<span class="keyword">new</span> GetBooleanAction(<span class="string">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span>))).booleanValue();</div></pre></td></tr></table></figure></p>
<p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è®¾ç½®sun.misc.ProxyGenerator.saveGeneratedFilesè¿™ä¸ªç³»ç»Ÿå±æ€§ä¸ºtrueæ¥æŠŠç”Ÿæˆçš„classä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶æ¥æŸ¥çœ‹ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.getProperties().put(<span class="string">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span>, <span class="string">"true"</span>);</div></pre></td></tr></table></figure></p>
<p>åŠ ä¸Šè¿™æ®µä»£ç åæ‰§è¡Œ<code>main</code>ä¼šæŠ¥è¿™æ ·çš„é”™ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">Exception in thread &quot;main&quot; java.lang.InternalError: I/O exception saving generated file: java.io.FileNotFoundException: com/sun/proxy/$Proxy0.class (No such file or directory)</div><div class="line">	at sun.misc.ProxyGenerator$1.run(ProxyGenerator.java:336)</div><div class="line">	at sun.misc.ProxyGenerator$1.run(ProxyGenerator.java:327)</div><div class="line">	at java.security.AccessController.doPrivileged(Native Method)</div><div class="line">	at sun.misc.ProxyGenerator.generateProxyClass(ProxyGenerator.java:326)</div><div class="line">	at java.lang.reflect.Proxy$ProxyClassFactory.apply(Proxy.java:671)</div><div class="line">	at java.lang.reflect.Proxy$ProxyClassFactory.apply(Proxy.java:591)</div><div class="line">	at java.lang.reflect.WeakCache$Factory.get(WeakCache.java:244)</div><div class="line">	at java.lang.reflect.WeakCache.get(WeakCache.java:141)</div><div class="line">	at java.lang.reflect.Proxy.getProxyClass0(Proxy.java:454)</div><div class="line">	at java.lang.reflect.Proxy.newProxyInstance(Proxy.java:736)</div><div class="line">	at com.dw.test.JdkProxy.getProxy(JdkProxy.java:45)</div><div class="line">	at com.dw.test.JdkProxyCase.main(JdkProxyCase.java:19)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</div><div class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)</div><div class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)</div><div class="line">	at java.lang.reflect.Method.invoke(Method.java:606)</div><div class="line">	at com.intellij.rt.execution.application.AppMain.main(AppMain.java:147)</div></pre></td></tr></table></figure></p>
<p>è§£å†³åŠæ³•æ˜¯åœ¨å·¥ç¨‹æ ¹è·¯å¾„ä¸‹åˆ›å»ºcom/sun/proxyç›®å½•ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª$Proxy0.classæ–‡ä»¶ï¼Œæ‰èƒ½å¤Ÿæ­£å¸¸è¿è¡Œå¹¶ä¿å­˜classæ–‡ä»¶å†…å®¹ã€‚<br>çœ‹çœ‹åç¼–è¯‘åçš„ä»£ç ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> $<span class="title">Proxy0</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Hello</span></span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> $Proxy0(InvocationHandler var1) <span class="keyword">throws</span>  &#123;</div><div class="line">        <span class="keyword">super</span>(var1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object var1)</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> ((Boolean)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m1, <span class="keyword">new</span> Object[]&#123;var1&#125;)).booleanValue();</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</div><div class="line">            <span class="keyword">throw</span> var3;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">sayHello</span><span class="params">(String var1)</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">	        <span class="comment">//è°ƒç”¨çˆ¶ç±»çš„handlerçš„invokeæ–¹æ³• å®é™…ä¸Šå°±æ˜¯è°ƒç”¨æˆ‘ä»¬å®ç°InvocationHandleræ¥å£çš„ç±»çš„invoke æˆ‘ä»¬çš„é€»è¾‘åœ¨è¿™é‡Œå¤„ç†</span></div><div class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m3, <span class="keyword">new</span> Object[]&#123;var1&#125;);</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</div><div class="line">            <span class="keyword">throw</span> var3;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> ((Integer)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m0, (Object[])<span class="keyword">null</span>)).intValue();</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</div><div class="line">            <span class="keyword">throw</span> var2;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m2, (Object[])<span class="keyword">null</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</div><div class="line">            <span class="keyword">throw</span> var2;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            m1 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"equals"</span>, <span class="keyword">new</span> Class[]&#123;Class.forName(<span class="string">"java.lang.Object"</span>)&#125;);</div><div class="line">            m3 = Class.forName(<span class="string">"com.dw.service_api.Hello"</span>).getMethod(<span class="string">"sayHello"</span>, <span class="keyword">new</span> Class[]&#123;Class.forName(<span class="string">"java.lang.String"</span>)&#125;);</div><div class="line">            m0 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"hashCode"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</div><div class="line">            m2 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"toString"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var2) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(var2.getMessage());</div><div class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoClassDefFoundError(var3.getMessage());</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>ä»ç”Ÿæˆå‡ºæ¥çš„è¿™ä¸ªç±»ä¸­å¯ä»¥çœ‹åˆ°</p>
<ol>
<li>è¿™ä¸ªç±»ç»§æ‰¿è‡ª<code>Proxy</code>å®ç°äº†ä»£ç†æ¥å£ã€‚æ‰€ä»¥JDKåŠ¨æ€ä»£ç†åªèƒ½å¯¹æ¥å£è¿›è¡Œä»£ç†ï¼Œè€Œä¸èƒ½å¯¹å®ç°ç±»è¿›è¡Œä»£ç†ã€‚è¿™æ˜¯Javaè¯­è¨€ä¸èƒ½å¤šç»§æ‰¿å¯¼è‡´çš„ã€‚</li>
<li>æ„é€ æ–¹æ³•çš„å‚æ•°æ˜¯<code>InvocationHandler</code>ã€‚è¿™ä¸ªå‚æ•°æ˜¯ç”±æˆ‘ä»¬è°ƒç”¨<code>Proxy#newProxyInstance</code>æ–¹æ³•ä¼ è¿›å»çš„ã€‚</li>
<li>é‡å†™äº†Objectç±»çš„<code>equals</code>ã€<code>hashCode</code>ã€<code>toString</code>ï¼Œå®ƒä»¬éƒ½åªæ˜¯ç®€å•çš„è°ƒç”¨äº†<code>InvocationHandler</code>çš„<code>invoke</code>æ–¹æ³•ï¼Œå³å¯ä»¥å¯¹å…¶è¿›è¡Œç‰¹æ®Šçš„æ“ä½œï¼Œä¹Ÿå°±æ˜¯è¯´JDKçš„åŠ¨æ€ä»£ç†è¿˜å¯ä»¥ä»£ç†ä¸Šè¿°ä¸‰ä¸ªæ–¹æ³•ã€‚<br>ä»è¿™é‡Œå¯ä»¥è”æƒ³åˆ°Spring AOPçš„æœºåˆ¶å’Œè¿™ä¸ªåŸç†å…¶å®æ˜¯ä¸€æ ·çš„ï¼Œå¯èƒ½å®ç°ä¼šæ¯”è¿™ä¸ªå¤æ‚çš„å¤šã€‚<h5 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h5></li>
<li>ä½¿ç”¨JDKå®ç°åŠ¨æ€ä»£ç†éœ€è¦å®ç°<code>InvacationHandler</code>æ¥å£ï¼Œä½¿ç”¨<code>Proxy#newProxyInstacne</code>è¿”å›ä»£ç†å¯¹è±¡ã€‚</li>
<li>JDKåŠ¨æ€ä»£ç†çš„æœºåˆ¶æ˜¯é€šè¿‡åœ¨ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€åœ°å»ç”Ÿæˆå­—èŠ‚ç æ–‡ä»¶ï¼Œç„¶ååŠ è½½åˆ°å†…å­˜ç”Ÿæˆå®ä¾‹ã€‚</li>
<li>JDKåŠ¨æ€ä»£ç†åªèƒ½å¯¹æ¥å£è¿›è¡Œä»£ç†ï¼Œä¸èƒ½å¯¹å®ç°ç±»ä»£ç†ã€‚å› ä¸ºJavaè¯­è¨€ä¸æ”¯æŒå¤šç»§æ‰¿ã€‚è¦æƒ³å¯¹å®ç°ç±»è¿›è¡Œä»£ç†å¯ä»¥ä½¿ç”¨Cglibæ¥å®ç°ã€‚</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘å‘¢ï¼Œçœ‹åˆ°äº†ä¸€ä¸ªå¼€æºçš„PRC FRAMEWORKï¼Œå½“ç„¶ä¸æ˜¯Dubboã€‚ç„¶åæƒ³å»äº†è§£ä¸€ä¸‹RPCåˆ°åº•æ˜¯æ€ä¹ˆå»å®ç°çš„ã€‚äºæ˜¯ä¹å°±äº†è§£äº†ä¸€ç•ªï¼Œå‘ç°å…¶çµé­‚åœ¨äºåŠ¨æ€ä»£ç†å’Œåå°„ã€‚
    
    </summary>
    
      <category term="JDK SOURCE" scheme="http://www.wei-dong.top/categories/JDK-SOURCE/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="JDK" scheme="http://www.wei-dong.top/tags/JDK/"/>
    
  </entry>
  
  <entry>
    <title>è‡ªå®šä¹‰Spring Schema</title>
    <link href="http://www.wei-dong.top/2017/07/01/spring%20schema/"/>
    <id>http://www.wei-dong.top/2017/07/01/spring schema/</id>
    <published>2017-07-01T14:18:23.000Z</published>
    <updated>2017-07-01T14:28:27.000Z</updated>
    
    <content type="html"><![CDATA[<h5 id="Whatâ€™s-schema"><a href="#Whatâ€™s-schema" class="headerlink" title="Whatâ€™s schema"></a>Whatâ€™s schema</h5><p>schemaä¸­æ–‡ç¿»è¯‘æ˜¯æ¦‚è¦ã€è®¡åˆ’ã€å›¾è¡¨ã€‚è¿™é‡Œçš„schemaæŒ‡çš„æ˜¯xml schemaï¼Œä¹Ÿå°±æ˜¯å¯¹xmlçš„çº¦æŸã€‚åœ¨xml schemaä¹‹å‰ï¼Œå¯¹xmlè¿›è¡Œçº¦æŸçš„æ˜¯DTDã€‚ç°åœ¨xml schemaå æ®äº†ä¸»æµã€‚å…¶ä¸­spring frameworkä¸­xmlé…ç½®æ–‡ä»¶å°±æ˜¯ä½¿ç”¨çš„æ˜¯xml schemaï¼Œåç¼€åä¸ºxsdã€‚<br><a id="more"></a> </p>
<h5 id="How-to-define-a-xml-schema"><a href="#How-to-define-a-xml-schema" class="headerlink" title="How to define a xml schema"></a>How to define a xml schema</h5><p>åœ¨spring frameworkä¸­çš„applicationContext.xmlæ–‡ä»¶ä¸­è§åˆ°æœ€å¤šçš„å°±æ˜¯<code>&lt;bean&gt;</code>æ ‡ç­¾ã€‚æœ‰æ—¶å€™æƒ³è‡ªå·±ä¹Ÿæ•´ä¸€ä¸ªæ ‡ç­¾æ»¡è¶³è‡ªå·±çš„éœ€æ±‚ï¼ˆè£…é€¼orçœŸçš„æ˜¯éœ€è¦è‡ªå·±å®ç°ï¼‰é‚£å°±å¾—è‡ªå·±å»æŒ‰ç…§springçš„æ ‡å‡†å»å®ç°äº†ï¼Œå°±å¥½æ¯”JDKä¸­çš„SPIæœºåˆ¶ï¼Œè¦æŒ‰ç…§JDKçš„è§„èŒƒå»åšã€‚Springæ˜¯æ€ä¹ˆè¦æ±‚çš„å‘¢ï¼Ÿ<br>ä»¥mavenå·¥ç¨‹ä¸ºä¾‹ï¼Œåœ¨resourcesç›®å½•ä¸‹çš„META_INFä¸‹éœ€è¦è‡ªå·±å®šä¹‰ä¸€ä¸ª.xsdæ–‡ä»¶ã€‚è¿™é‡Œæˆ‘å®šä¹‰äº†ä¸€ä¸ªä»¥dongweiä¸ºåçš„dongwei.xsdæ–‡ä»¶ï¼š<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">xsd:schema</span> <span class="attr">xmlns</span>=<span class="string">"http://www.dongwei.com/schema/dongwei"</span></span></div><div class="line">            <span class="attr">xmlns:xsd</span>=<span class="string">"http://www.w3.org/2001/XMLSchema"</span></div><div class="line">            <span class="attr">xmlns:tool</span>=<span class="string">"http://www.springframework.org/schema/tool"</span></div><div class="line">            <span class="attr">xmlns:beans</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></div><div class="line">            <span class="attr">targetNamespace</span>=<span class="string">"http://www.dongwei.com/schema/dongwei"</span>&gt;</div><div class="line">	<span class="comment">&lt;!-- è¿™é‡Œimportæœ‰å¥½å‡ ä¸ªschema å¯åŒæ—¶å»çº¦æŸè¢«çº¦æŸçš„xml --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsd:import</span> <span class="attr">namespace</span>=<span class="string">"http://www.w3.org/XML/1998/namespace"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsd:import</span> <span class="attr">namespace</span>=<span class="string">"http://www.springframework.org/schema/tool"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">xsd:import</span> <span class="attr">namespace</span>=<span class="string">"http://www.springframework.org/schema/beans"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">xsd:element</span> <span class="attr">name</span>=<span class="string">"user"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">xsd:complexType</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">xsd:complexContent</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">xsd:extension</span> <span class="attr">base</span>=<span class="string">"beans:identifiedType"</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">xsd:attribute</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">type</span>=<span class="string">"xsd:string"</span>&gt;</span></div><div class="line">						<span class="tag">&lt;<span class="name">xsd:annotation</span>&gt;</span></div><div class="line">							<span class="tag">&lt;<span class="name">xsd:documentation</span>&gt;</span>å§“å<span class="tag">&lt;/<span class="name">xsd:documentation</span>&gt;</span></div><div class="line">						<span class="tag">&lt;/<span class="name">xsd:annotation</span>&gt;</span></div><div class="line">					<span class="tag">&lt;/<span class="name">xsd:attribute</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">xsd:extension</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">xsd:complexContent</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">xsd:complexType</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">xsd:element</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">xsd:schema</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>ä¸Šé¢çš„xsdæ–‡ä»¶å°±å®šä¹‰äº†ä¸€ä¸ªçº¦æŸã€‚æ¥ä¸‹æ¥è¿˜éœ€è¦åœ¨resources/META_INFä¸‹æ–°å»ºä¸¤ä¸ªæ–‡ä»¶<code>spring.handlers</code>å’Œ<code>spring.schemas</code> å†…å®¹åˆ†åˆ«æ˜¯è¿™æ ·çš„<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http\://www.dongwei.com/schema/dongwei=com.hnisi.springscheme.schema.DongweiNamespaceHandler</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http\://www.dongwei.com/schema/dongwei/dongwei.xsd=META-INF/dongwei.xsd</div></pre></td></tr></table></figure>
<p>handlersçš„å†…å®¹å¯ä»¥æ˜¯å¤šæ¡ï¼Œè¡¨ç¤ºå¯¹è¿™ä¸ªæ ‡ç­¾çš„å¤„ç†å™¨ã€‚schemaè¡¨ç¤ºçš„æ˜¯xsdçš„æ–‡ä»¶ä½ç½®ï¼Œåœ¨urlä¸èƒ½è®¿é—®çš„æ—¶å€™ï¼ˆæ–­ç½‘ï¼‰ç¨‹åºå¯ä»¥å»æœ¬åœ°æ‰¾schemaã€‚</p>
<h5 id="schema-handlers"><a href="#schema-handlers" class="headerlink" title="schema handlers"></a>schema handlers</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DongweiNamespaceHandler</span>  <span class="keyword">extends</span> <span class="title">NamespaceHandlerSupport</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">		registerBeanDefinitionParser(<span class="string">"user"</span>, <span class="keyword">new</span> UserBeanDefinitionParser());		</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è‡ªå®šä¹‰çš„handlerå°±æ˜¯é…±ç´«ï¼Œéœ€å®ç°çˆ¶ç±»çš„<code>init</code>æ–¹æ³•ã€‚ä»–å»è°ƒç”¨äº†<code>registerBeanDefinitionParser</code>å»æ³¨å†Œæ ‡ç­¾ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ ‡ç­¾åï¼Œç¬¬äºŒä¸ªæ˜¯å¯¹è¿™ä¸ªæ ‡ç­¾çš„è§£æã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserBeanDefinitionParser</span> <span class="keyword">extends</span>  <span class="title">AbstractSingleBeanDefinitionParser</span>  </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doParse</span><span class="params">(Element element, BeanDefinitionBuilder builder)</span> </span>&#123;</div><div class="line">		String id = element.getAttribute(<span class="string">"id"</span>);</div><div class="line">		String name = element.getAttribute(<span class="string">"name"</span>);</div><div class="line">		</div><div class="line">		builder.addPropertyValue(<span class="string">"id"</span>, id);</div><div class="line">		builder.addPropertyValue(<span class="string">"name"</span>, name);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="keyword">protected</span> Class&lt;?&gt; getBeanClass(Element element) &#123;</div><div class="line">		<span class="keyword">return</span> User.class;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªè§£æå™¨é‡å†™äº†çˆ¶ç±»çš„<code>doParse</code>å’Œ<code>getBeanClass</code>  å…¶ä¸­<code>doParse</code>å¤„ç†çš„å°±æ˜¯xsdä¸­å®šä¹‰çš„å±æ€§ã€‚<br>å½“ç„¶ï¼Œä¹Ÿä¸èƒ½å°‘äº†æˆ‘ä»¬è¦å®šä¹‰çš„æ ‡ç­¾bean<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">	 <span class="keyword">private</span> String id;</div><div class="line">	 <span class="keyword">private</span> String name;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> id;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.id = id;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> name;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"User [id="</span> + id + <span class="string">", name="</span> + name + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line">	 </div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å®é™…ä¸Šè¿™å°±æ˜¯ä¸€ä¸ªbeanï¼Œå’Œåœ¨applicationContext.xmlä¸­é…ç½®çš„<code>&lt;bean&gt;</code>æ˜¯ä¸€ä¸ªæ„æ€ã€‚è¿™æ ·å®šä¹‰æ ‡ç­¾å»å¤„ç†ä¸ªäººè§‰å¾—æ˜¯ä¸ºäº†æ›´åŠ çµæ´»ï¼Œå¯ä»¥åœ¨xmlæ–‡ä»¶ä¸­å»é…ç½®beançš„å±æ€§ï¼Œæƒ³æ”¹å°±æ”¹ã€‚</p>
<h5 id="How-to-use"><a href="#How-to-use" class="headerlink" title="How to use"></a>How to use</h5><p>å†æ¥çœ‹çœ‹applicationContext.xmlä¸­æ€ä¹ˆä½¿ç”¨<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line">&lt;beans xmlns="http://www.springframework.org/schema/beans"</div><div class="line">    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" </div><div class="line">    xmlns:dongwei="http://www.dongwei.com/schema/dongwei"</div><div class="line">    xsi:schemaLocation="http://www.springframework.org/schema/beans </div><div class="line">    http://www.springframework.org/schema/beans/spring-beans-3.1.xsd    </div><div class="line">    http://www.dongwei.com/schema/dongwei</div><div class="line">    http://www.dongwei.com/schema/dongwei/dongwei.xsd"&gt;</div><div class="line">    </div><div class="line">    &lt;dongwei:user id="eric" name="123"/&gt;</div><div class="line">    </div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œçš„dongweiæ˜¯namespaceã€‚æœ¬è´¨ä¸Šæ¥è®²è¿™å°±æ˜¯ä¸€ä¸ªbeanã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestSpringSchema</span> </span>&#123;</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSchame</span><span class="params">()</span></span>&#123;</div><div class="line">		ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"classpath:applicationContext.xml"</span>);</div><div class="line">		User bean = context.getBean(User.class);</div><div class="line">		System.out.println(bean);</div><div class="line">		</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="Last-summary"><a href="#Last-summary" class="headerlink" title="Last summary"></a>Last summary</h5><p>è¿™æ˜¯æˆ‘çœ‹åˆ°SOAæ¡†æ¶çš„æ—¶å€™å‘ç°é…ç½®æ–‡ä»¶ä¸­æœ‰å¾ˆå¤šç±»ä¼¼<code>&lt;mango:registry protocol=&quot;zookeeper&quot; address=&quot;localhost:2181&quot; connect-timeout=&quot;5000&quot; /&gt;</code>çš„ä¸œè¥¿ï¼Œçªç„¶è§‰å¾—å¥½å¥‡ç„¶åå»äº†è§£äº†ä¸€ä¸‹ã€‚ä¸ä»…ç¬¬ä¸‰æ–¹æ¡†æ¶ä¸­æœ‰è¿™æ ·çš„è‡ªå®šä¹‰æ ‡ç­¾ï¼Œspring frameworkä¹Ÿæœ‰ï¼š<code>&lt;context:annotation-config/&gt;</code> è¿™å’Œæˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„<code>&lt;bean&gt;</code>é•¿å¾—è¿˜æ˜¯æœ‰ç‚¹ä¸ä¸€æ ·çš„ã€‚ç„¶åå»çœ‹äº†çœ‹æ€ä¹ˆå»è‡ªå®šä¹‰ä¸€ä¸ªè¿™æ ·çš„ä¸œè¥¿ã€‚è¿™åªæ˜¯ä¸€ä¸ªæœ€ç®€å•çš„å®ç°ï¼Œå®é™…ä¸ŠåŠŸèƒ½å¥å…¨çš„å®ç°æ˜¯å¾ˆå¤æ‚çš„ã€‚ä¹Ÿå¯ä»¥æƒ³è±¡spring frameworkæƒ³å¾—è¿˜æ˜¯å¾ˆå‘¨åˆ°çš„ï¼Œæ°´ä¹Ÿå¾ˆæ·±ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;h5 id=&quot;Whatâ€™s-schema&quot;&gt;&lt;a href=&quot;#Whatâ€™s-schema&quot; class=&quot;headerlink&quot; title=&quot;Whatâ€™s schema&quot;&gt;&lt;/a&gt;Whatâ€™s schema&lt;/h5&gt;&lt;p&gt;schemaä¸­æ–‡ç¿»è¯‘æ˜¯æ¦‚è¦ã€è®¡åˆ’ã€å›¾è¡¨ã€‚è¿™é‡Œçš„schemaæŒ‡çš„æ˜¯xml schemaï¼Œä¹Ÿå°±æ˜¯å¯¹xmlçš„çº¦æŸã€‚åœ¨xml schemaä¹‹å‰ï¼Œå¯¹xmlè¿›è¡Œçº¦æŸçš„æ˜¯DTDã€‚ç°åœ¨xml schemaå æ®äº†ä¸»æµã€‚å…¶ä¸­spring frameworkä¸­xmlé…ç½®æ–‡ä»¶å°±æ˜¯ä½¿ç”¨çš„æ˜¯xml schemaï¼Œåç¼€åä¸ºxsdã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Spring Framework" scheme="http://www.wei-dong.top/categories/Spring-Framework/"/>
    
    
      <category term="Spring" scheme="http://www.wei-dong.top/tags/Spring/"/>
    
      <category term="XML" scheme="http://www.wei-dong.top/tags/XML/"/>
    
  </entry>
  
  <entry>
    <title>JUCç³»åˆ—ä¹‹BlockingQueue</title>
    <link href="http://www.wei-dong.top/2017/07/01/juc_LinkedBlockingQueue/"/>
    <id>http://www.wei-dong.top/2017/07/01/juc_LinkedBlockingQueue/</id>
    <published>2017-07-01T14:16:23.000Z</published>
    <updated>2017-07-01T14:28:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>JUCæ˜¯jdk1.5ä¹‹åä¸€å¼ºå¤§çš„å·¥å…·åŒ…ã€‚å…¶ä¸­å¯¹JAVAçš„å¹¶å‘åšäº†å¾ˆå¥½çš„æ”¯æŒã€‚ä»”ç»†é˜…è¯»æºç ä½ ä¼šå‘ç°å¾ˆå¤šä»£ç çš„ä½œè€…æ˜¯<a href="https://en.wikipedia.org/wiki/Doug_Lea" target="_blank" rel="external">Doug Lea</a>ã€‚æ‰€ä»¥ç°åœ¨å¼€å§‹ç»†ç»†ç¢ç£¨è¿™ä½å¤§ç¥çš„é¬¼æ–§ç¥å·¥ã€‚<br><a id="more"></a> </p>
<h4 id="ç»§æ‰¿ç»“æ„"><a href="#ç»§æ‰¿ç»“æ„" class="headerlink" title="ç»§æ‰¿ç»“æ„"></a>ç»§æ‰¿ç»“æ„</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BlockingQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">Queue</span>&lt;<span class="title">E</span>&gt;</span></div></pre></td></tr></table></figure>
<p>è¿™ä¸ªç±»ç»§æ‰¿äº†æ¥å£Queueï¼ŒQueueç»§æ‰¿äº†Collectionæ¥å£ï¼Œä»–ä»¬éƒ½æ˜¯äº²æˆšã€‚äº²æˆšå…³ç³»å¾ˆåºå¤§ï¼Œåå°å¾ˆç¡¬ã€‚ç›´æ¥å®ç°è¿™ä¸ªæ¥å£çš„ç±»æ²¡å¤šå°‘ä¸ªï¼š</p>
<ul>
<li>ArrayBlockingQueue </li>
<li>DelayQueue</li>
<li>LinkedBlockingDeque</li>
<li>LinkedBlockingQueue</li>
<li>LinkedTransferQueue</li>
<li>PriorityBlockingQueue</li>
<li>SynchronousQueue<h4 id="LinkedBlockingQueue"><a href="#LinkedBlockingQueue" class="headerlink" title="LinkedBlockingQueue"></a>LinkedBlockingQueue</h4>é‚£å°±æ‹¿æœ€ç®€å•çš„å®ç°å¼€åˆ€ã€‚é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªQueueæ˜¯åŸºäºé“¾è¡¨çš„ã€‚çœ‹çœ‹æºç æ–‡æ¡£æ˜¯æ€ä¹ˆå»æè¿°çš„ï¼š<blockquote>
<p>An optionally-bounded blocking queue based on linked nodes. This queue orders elements FIFO (first-in-first-out). The head of the queue is that element that has been on the queue the longest time. The tail of the queue is that element that has been on the queue the shortest time. New elements are inserted at the tail of the queue, and the queue retrieval operations obtain elements at the head of the queue. Linked queues typically have higher throughput than array-based queues but less predictable performance in most concurrent applications.<br>è¿™æ˜¯ä¸€ä¸ªè¾¹ç•Œå¯é€‰çš„åŸºäºé“¾è¡¨çš„é˜»å¡é˜Ÿåˆ—ã€‚è¿™ä¸ªé˜Ÿåˆ—æŒ‰ç…§å…ˆè¿›å…ˆå‡ºçš„è§„åˆ™é˜»æ­¢å…ƒç´ ã€‚å¤´èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­çš„æ—¶é—´æœ€é•¿ï¼Œå°¾èŠ‚ç‚¹åœ¨é˜Ÿåˆ—æ—¶é—´æœ€çŸ­ã€‚æ–°æ·»åŠ çš„å…ƒç´ ä¼šè¢«æ”¾åˆ°å°¾éƒ¨ï¼Œå–å…ƒç´ å°†åœ¨é˜Ÿåˆ—çš„å¤´éƒ¨å–ã€‚åŸºäºé“¾è¡¨çš„é˜Ÿåˆ—çš„ååé‡é€šå¸¸è¦æ¯”åŸºäºæ•°ç»„çš„é«˜ï¼Œä½†æ˜¯åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹æ€§èƒ½æ²¡æœ‰é‚£ä¹ˆå¯è§‚ã€‚<br>The optional capacity bound constructor argument serves as a way to prevent excessive queue expansion. The capacity, if unspecified, is equal to Integer.MAX_VALUE. Linked nodes are dynamically created upon each insertion unless this would bring the queue above capacity.<br>å¯é€‰çš„å®¹é‡å‚æ•°æ˜¯ä¸ºäº†é˜²æ­¢é˜Ÿåˆ—æ•°é‡è†¨èƒ€ï¼Œå‡è®¾æ²¡æœ‰å»æŒ‡å®šè¿™ä¸ªå‚æ•°é‚£ä¹ˆå°†æŒ‡å®šä¸ºintçš„æœ€å¤§å€¼ã€‚åœ¨ä¸è¶…è¿‡å®¹é‡çš„å‰æä¸‹èŠ‚ç‚¹ä¹Ÿä¼šåœ¨æ¯æ¬¡æ’å…¥çš„æ—¶å€™åŠ¨æ€çš„åˆ›å»ºã€‚ </p>
</blockquote>
</li>
</ul>
<p>å…ˆçœ‹çœ‹è¿™ä¸ªç±»çš„å†…éƒ¨ç±»ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Node</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">        E item;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * One of:</div><div class="line">         * - the real successor Node</div><div class="line">         * - this Node, meaning the successor is head.next</div><div class="line">         * - null, meaning there is no successor (this is the last node)</div><div class="line">         */</div><div class="line">        Node&lt;E&gt; next;</div><div class="line"></div><div class="line">        Node(E x) &#123; item = x; &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Itr</span> <span class="keyword">implements</span> <span class="title">Iterator</span>&lt;<span class="title">E</span>&gt; </span>&#123;</div><div class="line">	<span class="comment">//çœç•¥å®ç°</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¸€ä¸ªnodeå†…éƒ¨ç±»ä»¥åŠä¸€ä¸ªitrçš„å®ç°ï¼Œéå¸¸ç®€å•ã€‚åœ¨JAVAé›†åˆä¸­ç»å¸¸çœ‹åˆ°å†…éƒ¨å®ç°Itrçš„ï¼Œè§æ€ªä¸æ€ªäº†ã€‚<br>æ¥ä¸‹æ¥å°±å¼€å§‹æ­£é¤äº†ï¼Œå¯¹å‡ ä¸ªæ ¸å¿ƒæ–¹æ³•è¿›è¡Œæ¢³ç†ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        E x;</div><div class="line">        <span class="keyword">int</span> c = -<span class="number">1</span>;</div><div class="line">        <span class="comment">//countè®°å½•å½“å‰é˜Ÿåˆ—çš„å…ƒç´ æ•°é‡</span></div><div class="line">        <span class="keyword">final</span> AtomicInteger count = <span class="keyword">this</span>.count;</div><div class="line">        <span class="keyword">final</span> ReentrantLock takeLock = <span class="keyword">this</span>.takeLock;</div><div class="line">        takeLock.lockInterruptibly();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">	        <span class="comment">//å½“å½“å‰å…ƒç´ çš„æ•°é‡ä¸º0çš„æ—¶å€™çº¿ç¨‹é˜»å¡ ç›´åˆ°æ¥åˆ°é€šçŸ¥é˜Ÿåˆ—æœ‰å…ƒç´ äº†æ‰ç»§ç»­æ‰§è¡Œ</span></div><div class="line">            <span class="keyword">while</span> (count.get() == <span class="number">0</span>) &#123;</div><div class="line">                notEmpty.await();</div><div class="line">            &#125;</div><div class="line">            x = dequeue();</div><div class="line">            <span class="comment">//å¤´èŠ‚ç‚¹å‡ºé˜Ÿäº† å…ƒç´ æ•°é‡å‡å»1 è¿”å›å€¼ä¸ºå‡1å‰çš„å€¼ å¦‚æœé˜Ÿåˆ—å…ƒç´ ä¸º1å‡ºé˜Ÿåé˜Ÿåˆ—æ²¡å…ƒç´ äº†cä¾æ—§ä¸º1</span></div><div class="line">            c = count.getAndDecrement();</div><div class="line">            <span class="keyword">if</span> (c &gt; <span class="number">1</span>)</div><div class="line">	            <span class="comment">//å¦‚æœé˜Ÿåˆ—ä¸­è¿˜æœ‰å…ƒç´  é‚£ä¹ˆé€šçŸ¥é˜»å¡çš„çº¿ç¨‹å¯ä»¥å–äº†</span></div><div class="line">                notEmpty.signal();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            takeLock.unlock();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (c == capacity)</div><div class="line">	        <span class="comment">//è¿™ä¸ªåˆ¤æ–­å¾ˆæœ‰æ„æ€ï¼Œæƒ³äº†å¥½ä¹…ã€‚</span></div><div class="line">	        <span class="comment">//è¿™ç§æƒ…å†µä»€ä¹ˆæ—¶å€™å‘ç”Ÿå‘¢ï¼Ÿå½“å‘é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´  é˜Ÿåˆ—å®¹é‡æœ‰é™æ¯”å¦‚è¯´10ä¸ª æˆ‘æ·»åŠ äº†20ä¸ª é‚£ä¹ˆçº¿ç¨‹ä¼šé˜»å¡æ‰ï¼Œçº¿ç¨‹è¢«é˜»å¡äº†å¿…é¡»ç”±åˆ«çš„çº¿ç¨‹æ¥å”¤é†’ä¸èƒ½è‡ªå·±å”¤é†’è‡ªå·±ã€‚å½“æŸä¸ªçº¿ç¨‹æ‰§è¡Œtakeçš„æ—¶å€™ï¼Œç¬¬ä¸€æ¬¡è¿›æ¥è¿™ä¸ªæ–¹æ³•å‡ºé˜Ÿäº†ä¸€ä¸ªå…ƒç´  è¿™æ—¶å€™cçš„å€¼ä¾æ—§æ˜¯10ï¼ˆè¿”å›çš„æ˜¯æ—§å€¼ï¼‰é‚£ä¹ˆå°±æ‰§è¡Œè¿™ä¸ªæ“ä½œäº†ï¼šå°†å…¥é˜Ÿçš„é˜»å¡çº¿ç¨‹å”¤é†’ è¿™æ—¶å€™å‰©ä¸‹çš„10ä¸ªå…ƒç´ å¯ä»¥ç»§ç»­å¾€é˜Ÿåˆ—ä¸­é€äº†ï¼ˆåªèƒ½å†é€ä¸€ä¸ªï¼Œå› ä¸ºæ»¡äº†ä¾æ—§ä¼šé˜»å¡ï¼‰ã€‚åŸåˆ™åªæœ‰ä¸€ä¸ªï¼šæ»¡äº†å°±é€šçŸ¥ã€‚è¿™ä¸ªç”»é¢å°±å®¹æ˜“æƒ³åˆ°äº†ï¼šæˆ‘å‡ºä¸€ä¸ªä½ æ‰èƒ½è¿›ä¸€ä¸ªï¼Œä¸å­˜åœ¨æˆ‘å…ˆå‡º2ä¸ªä½ å†è¡¥2ä¸ªè¿›æ¥çš„ï¼Œå¿…é¡»æ˜¯è½®æ¢çš„æ¥ï¼Œä¸€äººä¸€ä¸‹ã€‚</span></div><div class="line">            signalNotFull();</div><div class="line">        <span class="keyword">return</span> x;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>è‡ªå·±å†™äº†ä¸ªå°ç¤ºä¾‹ç¨‹åºæ¥æ§åˆ¶å‡ºé˜Ÿå’Œå…¥é˜Ÿï¼Œå†™å‡ºæ¥æ–¹ä¾¿ç†è§£ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueueCase</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        BlockingQueue&lt;String&gt; queue = <span class="keyword">new</span> LinkedBlockingQueue&lt;String&gt;(<span class="number">3</span>);</div><div class="line"></div><div class="line">        Thread put = <span class="keyword">new</span> Thread(<span class="keyword">new</span> F(queue));</div><div class="line">        put.start();</div><div class="line"></div><div class="line">        Thread take = <span class="keyword">new</span> Thread(<span class="keyword">new</span> T(queue));</div><div class="line">        take.start();</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">F</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line">        BlockingQueue&lt;String&gt; queue;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">F</span><span class="params">(BlockingQueue&lt;String&gt; queue)</span></span>&#123;</div><div class="line">            <span class="keyword">this</span>.queue = queue;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                    queue.put(<span class="string">""</span>+i);</div><div class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                    e.printStackTrace();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">T</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line">        BlockingQueue&lt;String&gt; queue;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">T</span><span class="params">(BlockingQueue&lt;String&gt; queue)</span></span>&#123;</div><div class="line">            <span class="keyword">this</span>.queue = queue;</div><div class="line">        &#125;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</div><div class="line">            <span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</div><div class="line">                System.out.println(<span class="string">"è¯·è¾“å…¥è¦å–å‡ºçš„æ•°é‡ï¼š"</span>);</div><div class="line">                <span class="keyword">int</span> t = scanner.nextInt();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; t; i++) &#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        String take = queue.take();</div><div class="line">                        System.out.println(Thread.currentThread().getName()+<span class="string">"å–å‡ºäº†å…ƒç´ ï¼š"</span>+take);</div><div class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªå°DEMOä¸­æœ‰2ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ«å»å¯¹é˜»å¡é˜Ÿåˆ—å­˜å…ƒç´ å’Œå–å…ƒç´ ã€‚é˜»å¡é˜Ÿåˆ—å®¹é‡æˆ‘åªç»™äº†3ä¸ªï¼Œåœ¨å­˜å…ƒç´ çš„çº¿ç¨‹ä¸­ç»™äº†10ä¸ªå…ƒç´ è®©å®ƒå»å…¥é˜Ÿï¼Œé‚£ä¹ˆåœ¨å­˜åˆ°ç¬¬å››ä¸ªçš„æ—¶å€™è¿™ä¸ªçº¿ç¨‹å°±é˜»å¡äº†ï¼Œç›´åˆ°å…¶ä»–çº¿ç¨‹è¢«å”¤é†’ã€‚è€Œå‡ºé˜Ÿçº¿ç¨‹å‘¢ä¼šæ¥å—ä¸€ä¸ªæ•°ï¼Œè¿™ä¸ªæ•°ä»£è¡¨ç€ä»é˜Ÿåˆ—ä¸­è¦å‡ºçš„å…ƒç´ æ•°é‡ã€‚å½“è¾“å…¥ä¸º10 ï¼Œåˆ™é˜Ÿåˆ—ä¸­å…ƒç´ å…¨éƒ¨è¢«æ‰“å°å‡ºæ¥äº†ã€‚è¿™ä¸ªè¿‡ç¨‹è¿™æ ·æè¿°ï¼šçº¿ç¨‹çš„æ‰§è¡Œæ˜¯æ²¡æœ‰å…ˆåçš„ï¼ˆä¸€èˆ¬æƒ…å†µï¼‰ï¼Œå› ä¸ºå‡ºé˜Ÿçº¿ç¨‹ä¸­æœ‰æ¥å—æ§åˆ¶å°è¾“å…¥ï¼Œä¼šè¢«é˜»å¡ã€‚å…¥é˜Ÿçº¿ç¨‹ä¸€å®šä¼šæ‰§è¡Œåˆ°å°†10ä¸ªå…ƒç´ ä¸­çš„3ä¸ªæ”¾å…¥é˜Ÿåˆ—ï¼ˆå¡æ»¡äº†ï¼Œå®¹é‡åªæœ‰3ï¼‰ï¼Œè¿™æ—¶å€™ä¸¤ä¸ªçº¿ç¨‹éƒ½è¢«é˜»å¡æ‰äº†ã€‚å½“æ§åˆ¶å°æ¥å—è¾“å…¥äº†ï¼Œå‡ºé˜Ÿçº¿ç¨‹æ‰§è¡Œåˆ°<code>take</code>æ–¹æ³•ï¼Œè¿›è¡Œå‡ºé˜Ÿæ“ä½œï¼Œæ‰§è¡Œåˆ°<code>if (c == capacity)</code>çš„æ—¶å€™å”¤é†’å…¥é˜Ÿçº¿ç¨‹å¯ä»¥ç»§ç»­æ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡å»è°ƒç”¨<code>take</code>æ–¹æ³•å‡ºé˜Ÿçš„æ—¶å€™éƒ½ä¼šå»æ£€æŸ¥é˜Ÿåˆ—æœ‰æ²¡æœ‰æ»¡ï¼Œæ»¡äº†å°±é€šçŸ¥è¢«é˜»å¡çš„çº¿ç¨‹å¯ä»¥å¾€é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ äº†ï¼ˆä¹Ÿåªæœ‰é˜Ÿåˆ—æ»¡äº†æ‰ä¼šè¢«é˜»å¡æ‰ï¼‰ã€‚<br>åœ¨çœ‹çœ‹å…¥é˜Ÿçš„æ–¹æ³•<code>put</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (e == <span class="keyword">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">        <span class="comment">// Note: convention in all put/take/etc is to preset local var</span></div><div class="line">        <span class="comment">// holding count negative to indicate failure unless set.</span></div><div class="line">        <span class="keyword">int</span> c = -<span class="number">1</span>;</div><div class="line">        Node&lt;E&gt; node = <span class="keyword">new</span> Node(e);</div><div class="line">        <span class="keyword">final</span> ReentrantLock putLock = <span class="keyword">this</span>.putLock;</div><div class="line">        <span class="keyword">final</span> AtomicInteger count = <span class="keyword">this</span>.count;</div><div class="line">        putLock.lockInterruptibly();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Note that count is used in wait guard even though it is</div><div class="line">             * not protected by lock. This works because count can</div><div class="line">             * only decrease at this point (all other puts are shut</div><div class="line">             * out by lock), and we (or some other waiting put) are</div><div class="line">             * signalled if it ever changes from capacity. Similarly</div><div class="line">             * for all other uses of count in other wait guards.</div><div class="line">             */</div><div class="line">            <span class="keyword">while</span> (count.get() == capacity) &#123;</div><div class="line">                notFull.await();</div><div class="line">            &#125;</div><div class="line">            enqueue(node);</div><div class="line">            c = count.getAndIncrement();</div><div class="line">            <span class="comment">//å¦‚æœå…¥é˜Ÿä¸€ä¸ªå…ƒç´ é˜Ÿåˆ—è¿˜æœ‰ä½ç½®çš„è¯å”¤é†’è¢«é˜»å¡çš„çº¿ç¨‹å¯ä»¥å¾€é˜Ÿåˆ—ä¸­æ·»åŠ å…ƒç´ äº†</span></div><div class="line">            <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</div><div class="line">                notFull.signal();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            putLock.unlock();</div><div class="line">        &#125;</div><div class="line">        <span class="comment">//åªæœ‰ç¬¬ä¸€æ¬¡putçš„æ—¶å€™æ‰ä¼šæ‰§è¡Œè¿™æ®µä»£ç  é˜Ÿåˆ—åˆå§‹åŒ–çš„æ—¶å€™æ²¡æœ‰å…ƒç´  countä¸º0 ç¬¬ä¸€æ¬¡æ‰§è¡Œputè™½ç„¶åŠ 1äº†ä½†æ˜¯è¿”å›çš„æ˜¯æ—§å€¼0 è¿™æ—¶å€™é˜Ÿåˆ—ä¸­æœ‰ä¸€ä¸ªå…ƒç´  é€šçŸ¥å› ä¸ºé˜Ÿåˆ—ä¸ºç©ºçš„å‡ºé˜Ÿçº¿ç¨‹å¯ä»¥å–å…ƒç´ äº†</span></div><div class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>)</div><div class="line">            signalNotEmpty();</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„å‡ºé˜Ÿå…¥é˜Ÿæ–¹æ³•ç±»ä¼¼<code>offer</code> <code>peek</code>ç­‰å°±ä¸ä¸€ä¸€è¯´æ˜äº†ï¼Œå…¶ä¸­çš„åŸç†éƒ½æ˜¯ä¸€æ ·çš„ã€‚åªä¸è¿‡æœ‰äº›æ–¹æ³•ä¸æ˜¯é˜»å¡çš„ï¼Œå‡ºé˜Ÿçš„æ—¶å€™é˜Ÿç©ºäº†å°±è¿”å›falseæˆ–è€…nullæˆ–è€…æŠ›å¼‚å¸¸ï¼Œå…¥é˜ŸåŒç†ã€‚</p>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>è‡³æ­¤ï¼Œå…³äºJUCä¸­çš„<code>BlockingQueue</code>çš„ä¸€ä¸ªå®ç° <code>LinkedBlockingQueue</code>ä¸»è¦å†…å®¹å°±åˆ°æ­¤ä¸ºæ­¢ï¼Œå…¶ä¸­å¾ˆå¤šJUCçš„ä¸œè¥¿è¿˜æ˜¯å¾ˆå€¼å¾—å»æ·±å…¥ç¢ç£¨çš„ã€‚æ¯”æ–¹è¯´<code>ReentrantLock</code>ã€‚å¯¹äºå¹¶å‘ç¼–ç¨‹è¿™ä¸€å—ï¼Œè¿˜æœ‰å¾ˆå¤šä¸œè¥¿éœ€è¦å»å­¦ä¹ çš„ã€‚æˆ‘æƒ³è¯´è¿™é‡Œé¢æ°´å¤ªæ·±äº†ï¼Œè¿™ä¸ªè¡Œä¸šçœŸçš„æ˜¯è¦æ±‚æ— æ—¶æ— åˆ»å»å­¦ä¹ ï¼</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;JUCæ˜¯jdk1.5ä¹‹åä¸€å¼ºå¤§çš„å·¥å…·åŒ…ã€‚å…¶ä¸­å¯¹JAVAçš„å¹¶å‘åšäº†å¾ˆå¥½çš„æ”¯æŒã€‚ä»”ç»†é˜…è¯»æºç ä½ ä¼šå‘ç°å¾ˆå¤šä»£ç çš„ä½œè€…æ˜¯&lt;a href=&quot;https://en.wikipedia.org/wiki/Doug_Lea&quot;&gt;Doug Lea&lt;/a&gt;ã€‚æ‰€ä»¥ç°åœ¨å¼€å§‹ç»†ç»†ç¢ç£¨è¿™ä½å¤§ç¥çš„é¬¼æ–§ç¥å·¥ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="JDK SOURCE" scheme="http://www.wei-dong.top/categories/JDK-SOURCE/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="JDK" scheme="http://www.wei-dong.top/tags/JDK/"/>
    
  </entry>
  
  <entry>
    <title>JUCä¹‹CyclicBarrier</title>
    <link href="http://www.wei-dong.top/2017/07/01/juc_CyclicBarrier/"/>
    <id>http://www.wei-dong.top/2017/07/01/juc_CyclicBarrier/</id>
    <published>2017-07-01T14:14:41.000Z</published>
    <updated>2017-07-01T14:28:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä»è¿™ä¸ªåå­—æ¥ç†è§£è¿™ä¸ªä¸œè¥¿å«åšå¾ªç¯æ …æ ã€‚ä¹Ÿè®¸è¿™æ ·ç¿»è¯‘å¾ˆç”Ÿç¡¬ï¼Œä½†æ˜¯å…·ä½“ä»€ä¹ˆæ„æ€å¤§æ¦‚å¯ä»¥å¾ˆæ¸…æ¥šåœ°æ˜ç™½äº†ã€‚</p>
<blockquote>
<p>A synchronization aid that allows a set of threads to all wait for each other to reach a common barrier point. CyclicBarriers are useful in programs involving a fixed sized party of threads that must occasionally wait for each other. The barrier is called cyclic because it can be re-used after the waiting threads are released.<br><a id="more"></a><br>JDKæ–‡æ¡£çš„è§£é‡Šæ˜¯è¿™æ ·çš„ï¼šCyclicBarrieræ˜¯ä¸€ä¸ªåŒæ­¥è¾…åŠ©ç±»ï¼Œå…è®¸ä¸€ç»„çº¿ç¨‹äº’ç›¸ç­‰å¾…ï¼Œç›´åˆ°åˆ°è¾¾æŸä¸ªå…¬å…±å±éšœç‚¹ (common barrier point)ã€‚å› ä¸ºè¯¥ barrier åœ¨é‡Šæ”¾ç­‰å¾…çº¿ç¨‹åå¯ä»¥é‡ç”¨ï¼Œæ‰€ä»¥ç§°å®ƒä¸ºå¾ªç¯ çš„ barrierã€‚<br>çœ‹ä¸ªDEMOå…ˆï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">public class CyclicBarrierTest1 &#123;</div><div class="line"></div><div class="line">    private static int SIZE = 5;</div><div class="line">    private static CyclicBarrier cb;</div><div class="line">    public static void main(String[] args) &#123;</div><div class="line"></div><div class="line">        cb = new CyclicBarrier(SIZE);</div><div class="line"></div><div class="line">        // æ–°å»º5ä¸ªä»»åŠ¡</div><div class="line">        for(int i=0; i&lt;SIZE; i++)</div><div class="line">            new InnerThread().start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    static class InnerThread extends Thread&#123;</div><div class="line">        public void run() &#123;</div><div class="line">            try &#123;</div><div class="line">                System.out.println(Thread.currentThread().getName() + &quot; wait for CyclicBarrier.&quot;);</div><div class="line"></div><div class="line">                // å°†cbçš„å‚ä¸è€…æ•°é‡åŠ 1</div><div class="line">                cb.await();</div><div class="line"></div><div class="line">                // cbçš„å‚ä¸è€…æ•°é‡ç­‰äº5æ—¶ï¼Œæ‰ç»§ç»­å¾€åæ‰§è¡Œ</div><div class="line">                System.out.println(Thread.currentThread().getName() + &quot; continued.&quot;);</div><div class="line">            &#125; catch (BrokenBarrierException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125; catch (InterruptedException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>æ‰§è¡Œç»“æœï¼š<br><code>Thread-1 wait for CyclicBarrier.
Thread-2 wait for CyclicBarrier.
Thread-3 wait for CyclicBarrier.
Thread-4 wait for CyclicBarrier.
Thread-0 wait for CyclicBarrier.
Thread-0 continued.
Thread-4 continued.
Thread-2 continued.
Thread-3 continued.
Thread-1 continued.</code></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»è¿™ä¸ªåå­—æ¥ç†è§£è¿™ä¸ªä¸œè¥¿å«åšå¾ªç¯æ …æ ã€‚ä¹Ÿè®¸è¿™æ ·ç¿»è¯‘å¾ˆç”Ÿç¡¬ï¼Œä½†æ˜¯å…·ä½“ä»€ä¹ˆæ„æ€å¤§æ¦‚å¯ä»¥å¾ˆæ¸…æ¥šåœ°æ˜ç™½äº†ã€‚&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;A synchronization aid that allows a set of threads to all wait for each other to reach a common barrier point. CyclicBarriers are useful in programs involving a fixed sized party of threads that must occasionally wait for each other. The barrier is called cyclic because it can be re-used after the waiting threads are released.&lt;br&gt;
    
    </summary>
    
      <category term="JDK SOURCE" scheme="http://www.wei-dong.top/categories/JDK-SOURCE/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="JDK" scheme="http://www.wei-dong.top/tags/JDK/"/>
    
  </entry>
  
  <entry>
    <title>XMPP Server Vysper ï¼ˆâ… ï¼‰</title>
    <link href="http://www.wei-dong.top/2017/05/20/xmpp-vysper-1-md/"/>
    <id>http://www.wei-dong.top/2017/05/20/xmpp-vysper-1-md/</id>
    <published>2017-05-20T10:40:04.000Z</published>
    <updated>2017-05-20T10:43:17.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="èµ·å› "><a href="#èµ·å› " class="headerlink" title="èµ·å› "></a>èµ·å› </h1><p>åœ¨å˜€å—’æ¸…å•é‡Œåˆ—å‡ºäº†è®¸å¤šè®¡åˆ’ã€‚æœ‰é˜…è¯»è®¡åˆ’ï¼Œæœ‰å­¦ä¹ è®¡åˆ’ï¼Œè¿˜æœ‰å…¶ä»–çš„è®¡åˆ’ã€‚å…¶ä¸­é˜…è¯»è®¡åˆ’é‡Œå°±åŒ…æ‹¬åº”ç”¨å±‚åè®®ï¼Œç±»ä¼¼HTTPåè®®ï¼ŒMQTTï¼ŒXMPPç­‰ã€‚é˜…è¯»åè®®æœ€é‡è¦çš„ç›®çš„å°±æ˜¯ç†è§£è®¾è®¡è€…è®¾è®¡çš„åˆè¡·å’Œæ€æƒ³ã€‚ä¸ªäººè®¤ä¸ºè¿™äº›æ€æƒ³è¿œè¿œæ¯”å®ç°çš„æ‰‹æ®µæœ‰è¶£ã€‚å¾ˆå´‡æ‹œé‚£äº›å®šåˆ¶åè®®çš„äººï¼Œä»¥åŠå®šåˆ¶æ ‡å‡†çš„é‚£äº›å·¨å¤´ï¼Œä¾‹å¦‚Googleç­‰ã€‚<a id="more"></a>å»çœ‹é‚£äº›è‰æ¡ˆï¼ŒRFCæ–‡æ¡£æ˜¯ä¸€ä»¶å¾ˆæ¯ç‡¥çš„äº‹æƒ…ï¼Œæ‹¿ä¸€ä¸ªæ ‡å‡†å®ç°å¯¹ç€æ–‡æ¡£æ¥åˆ†æå¯ä»¥è®©è¿™ä¸ªè¿‡ç¨‹å˜å¾—æœ‰è¶£çš„å¤šã€‚ä¹‹å‰è¯»è¿‡FTPçš„åè®®ï¼Œçœ‹ç€çœ‹ç€å°±çœ‹ä¸ä¸‹å»äº†ã€‚è™½ç„¶æ²¡å¤šå°‘å†…å®¹ï¼Œä½†æ˜¯è¦å»è¯»ä¸‹å»å®åœ¨æ˜¯ç´¢ç„¶æ— å‘³ã€‚äºæ˜¯æ‹¿äº†ä¸€ä¸ªæ ‡å‡†å®ç°å»åˆ†æï¼ŒFtpServerå°±æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„å…¥é—¨ã€‚ç°åœ¨å¼€å§‹å»äº†è§£XMPPï¼Œäºæ˜¯æ‹¿äº†ä¸€ä¸ªå¼€æºserver Vysperæ¥å­¦ä¹ ã€‚ </p>
<h1 id="XMPP"><a href="#XMPP" class="headerlink" title="XMPP"></a>XMPP</h1><p>ç¬¬ä¸€ä¸ªxä»£è¡¨çš„æ˜¯Extensibleï¼Œmä»£è¡¨çš„æ˜¯Messageingï¼Œç¬¬ä¸€ä¸ªpæ˜¯Presenceã€‚è¿™ä¸ªåè®®çš„å‰ç”Ÿæ˜¯Jabberï¼Œå…·ä½“çš„æ²¡æœ‰å»ç ”ç©¶ã€‚è¿™ä¸ªåè®®æ˜¯åŸºäºXMLçš„ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡XMLæ ¼å¼å»ä¼ è¾“æ•°æ®ã€‚å…¶å®æˆ‘è§‰å¾—ï¼Œåº”ç”¨å±‚çš„åè®®æ— éä¸¤ç§ä¼ è¾“æ–¹å¼ï¼ŒåŸºäºæ–‡æœ¬å’ŒåŸºäºäºŒè¿›åˆ¶ã€‚æœ¬è´¨ä¸Šæ¥è¯´éƒ½æ˜¯åŸºäºäºŒè¿›åˆ¶ï¼šå¯¹äºè®¡ç®—æœºè€Œè¨€æ‰€æœ‰çš„æ•°æ®å…¨æ˜¯0101ï¼Œæ²¡ä»€ä¹ˆæ¯›ç—…ã€‚HTTPå°±æ˜¯åŸºäºæ–‡æœ¬ï¼Œæ™®é€šäººéƒ½èƒ½å»é˜…è¯»HTTPé‡Œçš„æ•°æ®ã€‚è€ŒXMPPæ˜¯åŸºäºXMLï¼Œä¹Ÿå°±æ˜¯åŸºäºæ–‡æœ¬ã€‚</p>
<h1 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h1><p>å¯¹äºä¸€ä¸ªé™Œç”Ÿçš„åè®®ï¼Œåˆæ²¡è€å¿ƒå»çœ‹RFCæ–‡æ¡£ï¼ˆä¸»è¦æ˜¯çœ‹ä¸æ‡‚è‹±æ–‡ï¼‰ï¼Œæ€ä¹ˆå»äº†è§£è¿™ä¸ªåè®®æ˜¯æ€ä¹ˆå·¥ä½œçš„å‘¢ï¼Ÿæˆ‘çš„ç†è§£å°±æ˜¯è‡ªå·±å»æŠ“åŒ…çœ‹å†…å®¹ã€‚ç±»æ¯”HTTPå¯ä»¥é€šè¿‡æµè§ˆå™¨å»æŸ¥çœ‹è¯·æ±‚å¤´ä»¥åŠå„ç§å±æ€§ï¼ŒåŒæ ·çš„XMPPä¸€æ ·ä¹Ÿå¯ä»¥é€šè¿‡æŠ“åŒ…åˆ†æå…¶æŒ‡ä»¤åŠæ•°æ®æ ¼å¼ã€‚é¦–å…ˆå»APACHEå°†Vysperä¸‹è½½ä¸‹æ¥ï¼ˆdistå’Œsrcï¼‰ç„¶åè‡ªå·±æœ¬åœ°å°†æœåŠ¡å™¨è·‘èµ·æ¥ã€‚æ‰¾å‡ ä¸ªXMPPå®¢æˆ·ç«¯ç›¸äº’é€šä¿¡é€šè¿‡æŠ“åŒ…å·¥å…·æ¥å°†XMPPåè®®çš„è¿‡æ»¤å‡ºæ¥ï¼Œå¯¹æ¯æ¡è¯·æ±‚å’Œå“åº”å…·ä½“åˆ†æã€‚okï¼Œæ•´ä¸ªæ€è·¯å°±æ˜¯è¿™æ ·äº†ã€‚æŠ“åŒ…å·¥å…·ä½¿ç”¨wiresharkå¾ˆæ–¹ä¾¿ã€‚å®¢æˆ·ç«¯æœ‰å¾ˆå¤šï¼Œpcä¸Šä½¿ç”¨sparkï¼ˆwinï¼‰ï¼Œaduimï¼ˆmacï¼‰ï¼›æ‰‹æœºä¸Šä½¿ç”¨brunoã€‚openfireä¹Ÿæ˜¯ä¸€ä¸ªå¾ˆä¸é”™çš„æœåŠ¡å™¨ï¼Œæä¾›webç®¡ç†é¡µé¢ï¼Œä½¿ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ã€‚</p>
<h1 id="Vysper"><a href="#Vysper" class="headerlink" title="Vysper"></a>Vysper</h1><p>Vysperçš„å‘éŸ³å’ŒWhisperæ˜¯ä¸€æ ·çš„ï¼Œæ˜¯æ‚„æ‚„è¯çš„æ„æ€ã€‚åœ¨apacheçš„vysperå®˜æ–¹æ–‡æ¡£ä¸­å®ƒå®ç°çš„æ ‡å‡†æ˜¯ RFC3920ï¼ˆç°åœ¨çš„æ ‡å‡†æ˜¯RFC6120ï¼Œå…·ä½“å¯è§<a href="http://wiki.jabbercn.org/RFC6120" target="_blank" rel="external">RFC6120</a>ï¼‰å’Œ RFC3921ï¼ˆåªå®ç°äº†80%ï¼‰ã€‚å…¶ä»–çš„éƒ½æ˜¯äº›æ‹“å±•åè®®äº†ã€‚æ ¹æ®æ–‡æ¡£ä»‹ç»ï¼Œvysperçš„ç»“æ„åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š<a href="http://mina.apache.org/vysper-project/xml_processing.html" target="_blank" rel="external">XML Processing</a>ã€<a href="http://mina.apache.org/vysper-project/stanza_processing_layer.html" target="_blank" rel="external">Stanza Processing</a>å’Œ<a href="http://mina.apache.org/vysper-project/user_mgmt.html" target="_blank" rel="external">User Management</a>.<br>ç›®å‰æœ€æ–°çš„ç‰ˆæœ¬æ˜¯0.7ï¼Œæ‰“å¼€ä¸‹è½½çš„æºç ï¼Œå…¶å¯¹åº”çš„æ¨¡å—æœ‰è¿™å‡ ä¸ªéƒ¨åˆ†ï¼šdistã€examplesã€nbxmlã€serverå’Œspeccomplianceã€‚å…¶ä¸­serverä¸‹åˆæœ‰å¥½å‡ ä¸ªæ¨¡å—ã€‚</p>
<h2 id="dist"><a href="#dist" class="headerlink" title="dist"></a>dist</h2><p>é€šè¿‡åå­—å¯ä»¥çœ‹å‡ºæ¥æ˜¯ç”¨æ¥æ‰“åŒ…å‘å¸ƒçš„ã€‚å› ä¸ºvysperæ˜¯ç”¨mavenç®¡ç†çš„ï¼Œè¿™ä¸ªæ¨¡å—å°†å…¶ä»–çš„æ¨¡å—å¼•å…¥è¿›æ¥ï¼Œé€šè¿‡é…ç½®ç”Ÿæˆå¯åŠ¨è„šæœ¬ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">&lt;plugin&gt;</div><div class="line">        &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;</div><div class="line">        &lt;artifactId&gt;appassembler-maven-plugin&lt;/artifactId&gt;</div><div class="line">        &lt;version&gt;1.0&lt;/version&gt;</div><div class="line">        &lt;configuration&gt;</div><div class="line">          &lt;includeConfigurationDirectoryInClasspath&gt;true&lt;/includeConfigurationDirectoryInClasspath&gt;</div><div class="line">          &lt;configurationDirectory&gt;config&lt;/configurationDirectory&gt;</div><div class="line">          &lt;target&gt;$&#123;project.build.directory&#125;/appassembler&lt;/target&gt;</div><div class="line">          &lt;repositoryLayout&gt;flat&lt;/repositoryLayout&gt;</div><div class="line">		  &lt;repositoryName&gt;lib&lt;/repositoryName&gt;</div><div class="line">          &lt;environmentSetupFileName&gt;setenv&lt;/environmentSetupFileName&gt;</div><div class="line">          &lt;!-- Generate bin scripts for windows and unix per default --&gt;</div><div class="line">          &lt;platforms&gt;</div><div class="line">            &lt;platform&gt;windows&lt;/platform&gt;</div><div class="line">            &lt;platform&gt;unix&lt;/platform&gt;</div><div class="line">          &lt;/platforms&gt;</div><div class="line">          &lt;programs&gt;</div><div class="line">            &lt;program&gt;</div><div class="line">              &lt;mainClass&gt;org.apache.vysper.spring.ServerMain&lt;/mainClass&gt;</div><div class="line">              &lt;!-- call it only run because appassemble will add .bat by default on windows --&gt;              </div><div class="line">              &lt;name&gt;run&lt;/name&gt;</div><div class="line">              &lt;!-- Only generate windows bat script for this application --&gt;</div><div class="line">              &lt;platforms&gt;</div><div class="line">                &lt;platform&gt;windows&lt;/platform&gt;</div><div class="line">              &lt;/platforms&gt;</div><div class="line">            &lt;/program&gt;</div><div class="line">            &lt;program&gt;</div><div class="line">              &lt;mainClass&gt;org.apache.vysper.spring.ServerMain&lt;/mainClass&gt;</div><div class="line">              &lt;name&gt;run.sh&lt;/name&gt;</div><div class="line">              &lt;!-- Only generate unix shell script for this application --&gt;</div><div class="line">              &lt;platforms&gt;</div><div class="line">             &lt;platform&gt;unix&lt;/platform&gt;</div><div class="line">              &lt;/platforms&gt;</div><div class="line">            &lt;/program&gt;</div><div class="line">          &lt;/programs&gt;</div><div class="line">        &lt;/configuration&gt;</div><div class="line">        &lt;executions&gt;</div><div class="line">          &lt;execution&gt;</div><div class="line">          &lt;id&gt;make-appassemble&lt;/id&gt;</div><div class="line">            &lt;phase&gt;package&lt;/phase&gt;</div><div class="line">            &lt;goals&gt;</div><div class="line">              &lt;goal&gt;assemble&lt;/goal&gt;</div><div class="line">            &lt;/goals&gt;</div><div class="line">          &lt;/execution&gt;</div><div class="line">        &lt;/executions&gt;</div><div class="line">&lt;/plugin&gt;</div></pre></td></tr></table></figure></p>
<h2 id="examples"><a href="#examples" class="headerlink" title="examples"></a>examples</h2><p>è¿™ä¸ªæ¨¡å—ä¸‹æœ‰ä¸¤ä¸ªå­æ¨¡å—ï¼šembedded-warå’Œpubsub-client.åˆ†åˆ«æ˜¯ç”¨ä½œåµŒå…¥åˆ°webå®¹å™¨é‡Œå’Œguiå®¢æˆ·ç«¯çš„æ —å­ã€‚ç®€è¨€ä¹‹å°±æ˜¯å°†ç¼–è¯‘å¥½çš„server-coreæ‹¿æ¥è°ƒç”¨äº†ä¸€æŠŠè€Œå·²ã€‚å¯ä»¥é€šè¿‡jettyæˆ–è€…tomcatå¯åŠ¨å®ƒéƒ½æ˜¯æ²¡é—®é¢˜çš„ã€‚è€Œpubsub-clientè¿™ä¸ªæ¨¡å—åˆ™æ˜¯ä¸€ä¸ªguiçš„ç¨‹åºï¼Œé€šè¿‡pomçš„é…ç½®çœ‹åˆ°äº†æœ‰smackçš„å¼•ç”¨ï¼Œå…·ä½“çš„åç»­ä¼šæ…¢æ…¢ç ”ç©¶ã€‚</p>
<h2 id="nbxml"><a href="#nbxml" class="headerlink" title="nbxml"></a>nbxml</h2><p>è¿™ä¸ªæ¨¡å—å¾ˆå¥‡æ€ªï¼Œåå­—å«åšnbxmlã€‚æˆ‘æƒ³è¿™ä¸ªé¡¹ç›®ä¸æ˜¯å¤–å›½äººå†™çš„å—ï¼Œä¸ºä½•å«ç‰›é€¼xmlã€‚çœŸçš„æ˜¯è¿™æ ·å—ï¼Ÿå¹¶ä¸æ˜¯çš„ã€‚å…¨åå«åšNon-blocking XMLï¼Œéé˜»å¡çš„xmlè§£æå™¨ã€‚æ— éå°±æ˜¯å®ç°äº†org.xml.sax çš„ä¸€äº›æ¥å£è€Œå·²ã€‚è‡ªå®šä¹‰äº†ä¸€å¥—è§£æè§„åˆ™ã€‚</p>
<h2 id="server"><a href="#server" class="headerlink" title="server"></a>server</h2><p>è¿™ä¸ªæ¨¡å—ä¸‹æœ‰å¾ˆå¤šå­æ¨¡å—ã€‚è¿™ä¹Ÿæ˜¯vysperçš„æ ¸å¿ƒæ¨¡å—äº†ã€‚</p>
<h3 id="admin-config"><a href="#admin-config" class="headerlink" title="admin-config"></a>admin-config</h3><p>è¿™ä¸ªæ¨¡å—æ˜¯ä¸€ä¸ªwebåº”ç”¨ï¼Œå’Œopenfireçš„webç®¡ç†æ˜¯ä¸€æ ·çš„ã€‚å…¶ä¸­ä½¿ç”¨åˆ°äº†velocityå’Œspringmvc</p>
<h3 id="core"><a href="#core" class="headerlink" title="core"></a>core</h3><p>è¿™ä¸ªæ¨¡å—æœ€é‡è¦çš„å°±æ˜¯å¯¹xmppåè®®çš„å®ç°äº†ã€‚å½“ç„¶æœ€é‡è¦çš„è¿˜æ˜¯ç¦»ä¸å¼€minaï¼Œæ¯•ç«Ÿæ˜¯minaçš„å­é¡¹ç›®ã€‚</p>
<h3 id="extensions"><a href="#extensions" class="headerlink" title="extensions"></a>extensions</h3><p>è¿™ä¸ªæ¨¡å—ä¹ŸåŒ…å«å¾ˆå¤šå­æ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—éƒ½æ˜¯å¯¹xmppæ‹“å±•åè®®çš„å®ç°ï¼Œæ¯”å¦‚boshï¼Œmcuç­‰ã€‚æˆ‘å‘ç°ä½¿ç”¨mavenåˆ†æ¨¡å—æ¥ç®¡ç†è¿™ç§æ–¹å¼çœŸçš„å¾ˆèªæ˜ã€‚</p>
<h3 id="storage"><a href="#storage" class="headerlink" title="storage"></a>storage</h3><p>é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªæ¨¡å—æ˜¯ç”¨æ¥å­˜å‚¨çš„ã€‚å…¶ä¸­æœ‰ä¸ªjcrå’Œhbaseã€‚ä¸ç¦è®©æˆ‘æƒ³åˆ°äº†hadoopã€‚æ²¡é”™å…¶ä¸­çœŸçš„è¿˜å¼•å…¥äº†hadoopçš„åŒ…ã€‚æˆ‘ç†è§£çš„æ˜¯è¿™ä¸ªæ¨¡å—ç”¨äºæ–‡æ¡£å­˜å‚¨çš„ã€‚å…·ä½“æ˜¯å­˜å‚¨ä»€ä¹ˆæˆ‘è§‰å¾—å¤§æ¦‚æ˜¯ç”¨æˆ·ä¿¡æ¯ï¼Œè”ç³»äººç­‰ã€‚openfireä½¿ç”¨çš„æ˜¯mysqlæ•°æ®åº“æ¥ç®¡ç†çš„ã€‚å…·ä½“æ€ä¹ˆå®ç°çš„åç»­ä¼šç»§ç»­åˆ†æã€‚</p>
<h2 id="speccompliance"><a href="#speccompliance" class="headerlink" title="speccompliance"></a>speccompliance</h2><p>è¿™ä¸ªæ¨¡å—å¾ˆç¥ç§˜ï¼Œæˆ‘çœ‹pomæ–‡ä»¶ä¸­åªé…ç½®äº†ä¸€ä¸ªjdkçš„jaråŒ…ï¼Œè¿™ä¸ªjaråŒ…åœ¨1.8ä¸­æ˜¯æ²¡æœ‰çš„ã€‚å½“åˆç¼–è¯‘æºç çš„æ—¶å€™è¿˜é‡åˆ°äº†ä¸€ç‚¹å‘ï¼Œå°†jdkæ¢ä¸º1.7æ‰ç¼–è¯‘é€šè¿‡ã€‚è¯´ä»€ä¹ˆä½¿ç”¨äº†aptçš„apiã€‚å…·ä½“çš„æ˜¯å¹²å˜›çš„å¯è§<a href="http://www.javacui.com/Theory/367.html" target="_blank" rel="external">JDKå·¥å…· APT</a>ã€‚ç®€å•ç†è§£å°±æ˜¯å¯ä»¥å¸®æˆ‘ä»¬å°‘å†™ä»£ç ã€‚</p>
<h1 id="ç»“å°¾è¯­"><a href="#ç»“å°¾è¯­" class="headerlink" title="ç»“å°¾è¯­"></a>ç»“å°¾è¯­</h1><p>æœ¬æ–‡ç®€è¦ä»‹ç»äº†XMPPåè®®ä»¥åŠå¦‚ä½•å»å­¦ä¹ å’Œåˆ†æä¸€ä¸ªåè®®å¦‚ä½•å®ç°çš„ã€‚é€šè¿‡å¼€æºé¡¹ç›®Vysperæ¥å­¦ä¹ XMPPæ˜¯ä¸€ä¸ªä¸é”™çš„é€”å¾„ã€‚åŒæ—¶ä¹Ÿç®€å•åœ°å°†Vysperçš„ç»“æ„æ¦‚è¿°äº†ä¸€éã€‚æ¥ä¸‹æ¥å°†ä¼šé€šè¿‡åˆ†æå’Œè°ƒè¯•æºä»£ç ä»¥åŠç»“åˆé˜…è¯»RFCæ–‡æ¡£çš„æ–¹å¼æ¥å­¦ä¹ XMPPåè®®ã€‚<img src="http://7xsfwn.com1.z0.glb.clouddn.com/%E5%87%A4%E5%87%B0%E8%8A%B1.jpg" alt="å‡¤å‡°èŠ±"></p>
]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;èµ·å› &quot;&gt;&lt;a href=&quot;#èµ·å› &quot; class=&quot;headerlink&quot; title=&quot;èµ·å› &quot;&gt;&lt;/a&gt;èµ·å› &lt;/h1&gt;&lt;p&gt;åœ¨å˜€å—’æ¸…å•é‡Œåˆ—å‡ºäº†è®¸å¤šè®¡åˆ’ã€‚æœ‰é˜…è¯»è®¡åˆ’ï¼Œæœ‰å­¦ä¹ è®¡åˆ’ï¼Œè¿˜æœ‰å…¶ä»–çš„è®¡åˆ’ã€‚å…¶ä¸­é˜…è¯»è®¡åˆ’é‡Œå°±åŒ…æ‹¬åº”ç”¨å±‚åè®®ï¼Œç±»ä¼¼HTTPåè®®ï¼ŒMQTTï¼ŒXMPPç­‰ã€‚é˜…è¯»åè®®æœ€é‡è¦çš„ç›®çš„å°±æ˜¯ç†è§£è®¾è®¡è€…è®¾è®¡çš„åˆè¡·å’Œæ€æƒ³ã€‚ä¸ªäººè®¤ä¸ºè¿™äº›æ€æƒ³è¿œè¿œæ¯”å®ç°çš„æ‰‹æ®µæœ‰è¶£ã€‚å¾ˆå´‡æ‹œé‚£äº›å®šåˆ¶åè®®çš„äººï¼Œä»¥åŠå®šåˆ¶æ ‡å‡†çš„é‚£äº›å·¨å¤´ï¼Œä¾‹å¦‚Googleç­‰ã€‚
    
    </summary>
    
      <category term="Apache Open Project" scheme="http://www.wei-dong.top/categories/Apache-Open-Project/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="Apache" scheme="http://www.wei-dong.top/tags/Apache/"/>
    
  </entry>
  
  <entry>
    <title>ftpserverï¼ˆâ…£ï¼‰</title>
    <link href="http://www.wei-dong.top/2017/04/10/ftpserver4/"/>
    <id>http://www.wei-dong.top/2017/04/10/ftpserver4/</id>
    <published>2017-04-10T14:29:59.000Z</published>
    <updated>2017-04-10T14:31:22.000Z</updated>
    
    <content type="html"><![CDATA[<p>ä»Šå¤©å°±æ¥è°ˆè°ˆFtpServerä¸­çš„çº¿ç¨‹æ¨¡å‹ï¼Œå‡†ç¡®æ¥è®²æ˜¯MINAä¸­çš„çº¿ç¨‹æ¨¡å‹ã€‚ä¹‹å‰ä¸€ç›´å…³æ³¨äºFtpServerçš„å®ç°é€»è¾‘ï¼Œå´æ²¡å»åœ¨æ„NIOåº•å±‚çš„è¿™äº›è®¾è®¡ã€‚<br><a id="more"></a><br>å…ˆçœ‹çœ‹æˆ‘ä»¬ç”¨MINAç®€å•å®ç°ä¸€ä¸ªserver<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">public static void main(String[] args) throws IOException &#123;</div><div class="line"></div><div class="line">        SocketAcceptor socketAcceptor = new NioSocketAcceptor();</div><div class="line"></div><div class="line">        //åŠ ä¸Šä¸€ä¸ªç¼–ç è¿‡æ»¤å™¨ï¼Œä¸ç„¶å®¢æˆ·ç«¯è¾“å…¥çš„ä»€ä¹ˆæœåŠ¡ç«¯çœ‹åˆ°çš„éƒ½æ˜¯buf</div><div class="line">        socketAcceptor.getFilterChain().addLast(&quot;codec&quot;, new ProtocolCodecFilter(new MyCodecFactory()));</div><div class="line">        socketAcceptor.getFilterChain().addLast(&quot;log&quot;, new LoggingFilter());</div><div class="line"></div><div class="line">        socketAcceptor.setHandler(new MyHandler());</div><div class="line"></div><div class="line">        socketAcceptor.bind(new InetSocketAddress(&quot;localhost&quot;,9090));</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>ä¸Šè¿°ä»£ç ä¸­åªåŠ å…¥äº†logè¿‡æ»¤å™¨å’Œç¼–ç è¿‡æ»¤å™¨ï¼Œå®é™…ä¸Šä»€ä¹ˆéƒ½ä¸åŠ ä¹Ÿæ˜¯å¯ä»¥å®Œæˆå¯åŠ¨æœåŠ¡å™¨ç›‘å¬çš„ã€‚ç„¶åå¯åŠ¨æœåŠ¡å™¨æˆ‘ä»¬ç”¨telnetå‘½ä»¤å»è¿æ¥å®ƒï¼Œå¤šç”¨å‡ ä¸ªå‘½ä»¤çª—å£å»è¿æ¥ï¼Œåœ¨æ§åˆ¶å°ä¸Šå¯ä»¥çœ‹åˆ°è¿™æ ·çš„  </p>
<blockquote>
<p>[NioProcessor-2][FTP]21:31:35,053 INFO [LoggingFilter.log]:186 - CREATED<br>created<br>[NioProcessor-2][FTP]21:31:35,058 INFO [LoggingFilter.log]:186 - OPENED</p>
</blockquote>
<p>è¿™é‡Œæˆ‘ä»¬è®¾ç½®äº†æ—¥å¿—çš„æ ¼å¼ï¼Œå°†æœ€å‰é¢çš„ç½®ä¸ºå½“å‰çº¿ç¨‹çš„åç§°ã€‚æˆ‘ä»¬å†å¯åŠ¨ä¸€ä¸ªå®¢æˆ·ç«¯å»è¿æ¥ï¼š</p>
<blockquote>
<p>[NioProcessor-3][FTP]21:33:14,655 DEBUG [ProtocolCodecFilter.messageReceived]:211 - Processing a MESSAGE_RECEIVED for session 2<br>[NioProcessor-3][FTP]21:33:14,657 INFO [LoggingFilter.log]:157 - RECEIVED: dada  </p>
</blockquote>
<p>å¾ˆæ˜æ˜¾å¯ä»¥çœ‹åˆ°NioProcessorå˜äº†ã€‚å¦‚æ­¤å¾€å¤ï¼Œä¸æ–­å»å¯åŠ¨å‘½ä»¤è¡Œå®¢æˆ·ç«¯å»è¿ï¼Œä¼šå‘ç°NioProcessoråçš„ç¼–å·åªä¼šä»1åˆ°5ã€‚ä¹Ÿè®¸ä½ ä¼šè§‰å¾—å¥‡æ€ªï¼Œéš¾é“ç”¨äºå¤„ç†è¿æ¥çš„çº¿ç¨‹æ•°åªæœ‰5ä¸ªå—ï¼Ÿæ²¡é”™ï¼Œå¦‚æœä¸å¯¹å…¶è¿›è¡Œè®¾ç½®é»˜è®¤å°±æ˜¯è¿™ä¹ˆå¤šä¸ªï¼šcpuæ ¸æ•°åŠ 1ä¸ªã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/** The default pool size, when no size is provided. */</div><div class="line">private static final int DEFAULT_SIZE = Runtime.getRuntime().availableProcessors() + 1;</div></pre></td></tr></table></figure></p>
<p>è¿™å°±å¯ä»¥èŠåˆ°MINAä¸­çš„çº¿ç¨‹æ¨¡å‹äº†ã€‚å®ƒç”¨äºå¤„ç†IOç”¨NioProcessoræ¥ï¼Œå¤„ç†handlerç”¨å…¶ä»–çš„çº¿ç¨‹æ¥ã€‚åˆ°åº•æ€ä¹ˆå»ç”¨å‘¢ï¼Ÿ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public static void main(String[] args) throws IOException &#123;</div><div class="line"></div><div class="line">        SocketAcceptor socketAcceptor = new NioSocketAcceptor();</div><div class="line"></div><div class="line">        //åŠ ä¸Šä¸€ä¸ªç¼–ç è¿‡æ»¤å™¨ï¼Œä¸ç„¶å®¢æˆ·ç«¯è¾“å…¥çš„ä»€ä¹ˆæœåŠ¡ç«¯çœ‹åˆ°çš„éƒ½æ˜¯buf</div><div class="line">        socketAcceptor.getFilterChain().addLast(&quot;codec&quot;, new ProtocolCodecFilter(new MyCodecFactory()));</div><div class="line">        socketAcceptor.getFilterChain().addLast(&quot;log&quot;, new LoggingFilter());</div><div class="line">        //æ·»åŠ Executorè¿‡æ»¤å™¨ï¼Œè®©å…¶çº¿ç¨‹æ± å¤„ç†ä¸šåŠ¡é€»è¾‘</div><div class="line">        socketAcceptor.getFilterChain().addLast(&quot;threadPool&quot;, new ExecutorFilter(Executors.newCachedThreadPool()));</div><div class="line"></div><div class="line">        socketAcceptor.setHandler(new MyHandler());</div><div class="line"></div><div class="line">        socketAcceptor.bind(new InetSocketAddress(&quot;localhost&quot;,9090));</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>è¿™æ—¶å€™å†å¯åŠ¨telnetå®¢æˆ·ç«¯å»è®¿é—®æœåŠ¡å™¨ï¼Œæ§åˆ¶å°ä¸‹æ‰“å°çš„å°±æ˜¯è¿™æ ·äº†ï¼š</p>
<blockquote>
<p>[pool-3-thread-1][FTP]21:51:41,436 DEBUG [IoFilterEvent.fire]:117 - Event MESSAGE_RECEIVED has been fired for session 1</p>
</blockquote>
<p>å› æ­¤éªŒè¯äº†ä¸šåŠ¡é€»è¾‘çš„å¤„ç†çº¿ç¨‹ä¸å†åˆé‚£å¯æ€œå·´å·´çš„åªæœ‰5ä¸ªå¤„ç†IOè¿æ¥çš„æ¥åˆ†æ‹…äº†ï¼Œè€Œæ˜¯ç”±é¢å¤–çš„çº¿ç¨‹æ¥å¤„ç†ï¼Œè‡³äºè¿™äº›çº¿ç¨‹æ˜¯å¦å’Œå¤„ç†IOçº¿ç¨‹æ¥è‡ªåŒä¸€ä¸ªçº¿ç¨‹æ± æˆ‘æ²¡æœ‰ä»”ç»†å»ç ”ç©¶ã€‚åŒæ—¶ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªçº¿ç¨‹å€¼å¾—å…³æ³¨ï¼šNioSocketAcceptor-1ï¼ˆä½¿ç”¨jvisualvmå¯ä»¥çœ‹åˆ°æ‰€æœ‰çº¿ç¨‹ï¼‰è¿™ä¸ªç”¨äºç›‘å¬æ‰€æœ‰è¿æ¥äº‹ä»¶ï¼Œåªæœ‰ä¸€ä¸ªã€‚å…¶ä¸­æ¶‰åŠåˆ°äº†ä»€ä¹ˆselectoræ¨¡å‹ä»€ä¹ˆçš„å°±ä¸ç»§ç»­æ·±å…¥äº†ã€‚äº‹ä»¶åˆ°è¾¾åå°†å…¶å°è£…æˆIoSessionä¸¢ç»™IoProcessorå¤„ç†ï¼Œç„¶åç»§ç»­ç«™å²—ç›‘å¬ï¼Œå•¥å­éƒ½ä¸ç®¡äº†ï¼Œå°±åšè¿™ä¸€ä»¶äº‹æƒ…ã€‚<br>è¿™è®©æˆ‘ä¸ç¦æƒ³åˆ°ä¸€ä¸ªé—®é¢˜ï¼ŒNIoæ¨¡å‹ä¸­æ²¡æœ‰å¯¹æ¯ä¸ªè¿æ¥å¼€è¾Ÿçº¿ç¨‹å»å¤„ç†ï¼Œåªç”¨ä¸€ä¸ªçº¿ç¨‹å»å“åº”è¿æ¥äº‹ä»¶ï¼Œåç»­çš„éƒ½äº¤ç»™å…¶ä»–çº¿ç¨‹å»å¤„ç†ï¼Œé‚£ä¹ˆå¦‚æœè¿æ¥çš„æ•°é‡å¾ˆå¤šï¼Œå²‚ä¸æ˜¯ä¹Ÿéœ€è¦å¾ˆå¤šçº¿ç¨‹å»å¤„ç†è¿™äº›è¯·æ±‚äº†ï¼Ÿä¼˜åŠ¿åˆåœ¨å“ªé‡Œå‘¢ï¼Ÿ</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä»Šå¤©å°±æ¥è°ˆè°ˆFtpServerä¸­çš„çº¿ç¨‹æ¨¡å‹ï¼Œå‡†ç¡®æ¥è®²æ˜¯MINAä¸­çš„çº¿ç¨‹æ¨¡å‹ã€‚ä¹‹å‰ä¸€ç›´å…³æ³¨äºFtpServerçš„å®ç°é€»è¾‘ï¼Œå´æ²¡å»åœ¨æ„NIOåº•å±‚çš„è¿™äº›è®¾è®¡ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Apache Open Project" scheme="http://www.wei-dong.top/categories/Apache-Open-Project/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="Apache" scheme="http://www.wei-dong.top/tags/Apache/"/>
    
  </entry>
  
  <entry>
    <title>ç‰¢éªšä¸€ç¯‡</title>
    <link href="http://www.wei-dong.top/2017/04/09/%E7%89%A2%E9%AA%9A%E4%B8%80%E7%AF%87/"/>
    <id>http://www.wei-dong.top/2017/04/09/ç‰¢éªšä¸€ç¯‡/</id>
    <published>2017-04-09T03:56:18.000Z</published>
    <updated>2017-04-09T03:57:30.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote>
<p>ç”Ÿæ´»ä¸ä»…æœ‰çœ¼å‰çš„è‹Ÿä¸”ï¼Œè¿˜æœ‰è¯—å’Œè¿œã€‚</p>
</blockquote>
<p>åœ¨ä»¥å‰çœ‹åˆ°è¿™å¥è¯çš„æ—¶å€™ï¼Œè§‰å¾—å†™å¾—çœŸå¥½ï¼Œç»™äººä¸€ç§ç‰¹ç§¯æå‘ä¸Šçš„æ­£èƒ½é‡ã€‚<a id="more"></a>ç°åœ¨çœ‹æ¥æ— éå°±æ˜¯ä¸€ç§è‡ªæˆ‘æ¬ºéª—ã€‚æˆ–è®¸æ”¹ä¸ºâ€œç”Ÿæ´»ä¸ä»…æœ‰çœ¼å‰çš„è‹Ÿä¸”ï¼Œè¿˜æœ‰æ˜å¤©å’Œåå¤©çš„è‹Ÿä¸”â€ä¼šæ›´åŠ è´´è¿‘æˆ‘ç°åœ¨çš„ç”Ÿæ´»çŠ¶æ€ã€‚<br>æœ€è¿‘é™·å…¥äº†ä¸€ç§ç„¦è™‘çŠ¶æ€ï¼Œæ¯å¤©éƒ½å¾ˆæ‹…å¿ƒå®³æ€•ï¼Œä½†æ˜¯ä¹Ÿä¸çŸ¥é“å…·ä½“æ˜¯åœ¨æ‹…å¿ƒå®³æ€•ä»€ä¹ˆã€‚å…·ä½“è¡¨ç°å°±æ˜¯å‘¨æœ«æ‹…å¿ƒå‘¨ä¸€ï¼Œå¹³æ—¶æ‹…å¿ƒä¸‹ç­è¦åŠ ç­ï¼Œæ¯å¤©éƒ½æˆ˜æˆ˜å…¢å…¢çš„ï¼ŒåªæœŸæœ›æ—©ç‚¹è¿‡å®Œè¿™ä¸€å¤©ã€‚å‘¨æœ«åˆæ‹…å¿ƒä¸‹å‘¨ä¸€è¦å¿™çš„äº‹ã€‚çœŸæ˜¯éå¸¸éš¾å—ï¼Œè´Ÿèƒ½é‡æ»¡æ»¡ã€‚<br>å…·ä½“è¯´æ¥æˆ‘è§‰å¾—è¿˜æ˜¯å¯¹ç°çŠ¶ä¸æ˜¯å¾ˆæ»¡æ„ï¼Œæ¸´æœ›æ”¹å˜ï¼<br>å…¶å®è„‘è¢‹é‡Œå°±æ˜¯ä¸€ç‰‡æ··æµŠï¼Œè‡ªå·±åˆ°åº•æƒ³è¦ä»€ä¹ˆéƒ½æ²¡ææ˜ç™½ï¼Œå¯¹å‘¨å›´çš„äººå’Œäº‹çœŸçš„æ˜¯ä¸€ç‚¹éƒ½ä¸å…³å¿ƒï¼Œæˆ‘è§‰å¾—æˆ‘æ´»åœ¨è‡ªå·±çš„å°é—­çš„ä¸–ç•Œé‡Œï¼Œæ‰¾ä¸åˆ°å‡ºè·¯ã€‚æœ€ç›´è§‚çš„æ„Ÿå—å°±æ˜¯å¯¹å¾ˆå¤šäº‹æƒ…éƒ½æ²¡æœ‰ä»€ä¹ˆå…´è¶£äº†ï¼Œä»¥å‰è¿˜æƒ³ç€æ€ä¹ˆå‡ºå»èµ°èµ°ï¼Œå»æ—…è¡Œï¼Œå»åˆ«çš„åœ°æ–¹çœ‹çœ‹ã€‚ç°åœ¨å®Œå…¨æ²¡æœ‰è¿™æ ·çš„æƒ³æ³•ã€‚ä»¥å‰è¿˜ä¼šæƒ³ç€æ€ä¹ˆå»é‡è§é‚£äº›æœ‰è¶£çš„äººï¼Œæ€ä¹ˆå’Œä»–ä»¬åšæœ‹å‹ï¼Œç°åœ¨è§‰å¾—è‡ªå·±ä¸€ä¸ªäººå®‰å®‰é™é™å‘†ç€æŒºå¥½çš„ã€‚ä¹Ÿä¸æ„¿æ„å»ä¸»åŠ¨è”ç³»ä¸€äº›äººäº†ï¼Œä¹Ÿä¸ä¼šä¸»åŠ¨å»åˆ†äº«è‡ªå·±çš„ç”Ÿæ´»äº†ï¼Œæ¯å¤©éƒ½æ˜¯å¤©æ˜åœ°æš—çš„ç¨€é‡Œç³Šæ¶‚çš„åœ¨è¿‡ç€æ“è›‹çš„æ—¥å­ã€‚ä¸çŸ¥é“è¿˜è¦è¿‡å¤šä¹…æˆ‘æ‰ä¼šè¢«è¿™ç§ç”Ÿæ´»ç»™éº»ç—¹ï¼Œç„¶åå¤±å»çŸ¥è§‰å˜æˆä¸€åªå¦‚åŒè¡Œå°¸èµ°è‚‰çš„åƒµå°¸ä¸€èˆ¬è‹Ÿæ´»äºä¸–ã€‚<br>æˆ‘è§‰å¾—æˆ‘ä¾æ—§æ²¡å˜ï¼Œè‡³å°‘å†…å¿ƒçš„æƒ³æ³•æ²¡æœ‰å˜ï¼Œæˆ‘æ¯å¤©éƒ½åœ¨æƒ³ç€æ”¹å˜ï¼Œæ‘†è„±ç°åœ¨çš„ç¾ç»Šï¼ŒåŠªåŠ›å»æœ€æ±‚è‡ªå·±å†…å¿ƒæ‰€æƒ³çš„ä¸œè¥¿ï¼ŒåŠªåŠ›å»æˆä¸ºæœ€æƒ³æˆä¸ºçš„äººï¼Œä¸€æ­¥ä¸€æ­¥èµ°ä¸‹å»ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;ç”Ÿæ´»ä¸ä»…æœ‰çœ¼å‰çš„è‹Ÿä¸”ï¼Œè¿˜æœ‰è¯—å’Œè¿œã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;åœ¨ä»¥å‰çœ‹åˆ°è¿™å¥è¯çš„æ—¶å€™ï¼Œè§‰å¾—å†™å¾—çœŸå¥½ï¼Œç»™äººä¸€ç§ç‰¹ç§¯æå‘ä¸Šçš„æ­£èƒ½é‡ã€‚
    
    </summary>
    
      <category term="æƒ³æ³•" scheme="http://www.wei-dong.top/categories/%E6%83%B3%E6%B3%95/"/>
    
    
      <category term="ç”Ÿæ´»ï¼Œæ‰¯æ·¡" scheme="http://www.wei-dong.top/tags/%E7%94%9F%E6%B4%BB%EF%BC%8C%E6%89%AF%E6%B7%A1/"/>
    
  </entry>
  
  <entry>
    <title>ftpserver(â…¢)</title>
    <link href="http://www.wei-dong.top/2017/04/04/ftpserver3/"/>
    <id>http://www.wei-dong.top/2017/04/04/ftpserver3/</id>
    <published>2017-04-04T03:09:41.000Z</published>
    <updated>2017-04-04T03:10:54.000Z</updated>
    
    <content type="html"><![CDATA[<p>æ­¤ç¯‡æ–‡ç« æ¥è§£è¯»ftpserverä¸­çš„æ ¸å¿ƒç»„ä»¶â€“FtpServerContext<br>åœ¨å¾ˆå¤šç±»ä¸­éƒ½æœ‰çœ‹åˆ°è¿™ä¸ªä¸œè¥¿ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ä¸Šä¸‹æ–‡ã€‚æ ¹æ®ä»¥å¾€çš„åœ¨java webä¸­çš„servlet contextçš„ç†è§£ï¼Œå­—é¢æ„æ€å°±æ˜¯ä¸Šä¸‹æ–‡ã€‚<a id="more"></a>æˆ‘è§‰å¾—è¿™ä¸ªç¿»è¯‘ä¸æ˜¯å¾ˆå¥½ï¼Œé€šè¿‡å­—é¢æ„æ€çœŸçš„å¾ˆéš¾å»ç†è§£è¿™ä¸ªâ€œä¸Šä¸‹æ–‡â€æ˜¯ä»€ä¹ˆã€‚åè€Œä¹…è€Œä¹…ä¹‹æ‡‚å…¶ä¸­çš„å«ä¹‰äº†ï¼Œå´éš¾ä»¥ç”¨è¯­è¨€æè¿°å‡ºæ¥ã€‚æ‰€ä»¥è¯´ç¿»è¯‘ä¸å‡†ç¡®å¾ˆå®³äººå•Šã€‚æœ€ç®€å•ç²—æš´çš„æ–¹æ³•å°±æ˜¯å»çœ‹æ–‡æ¡£æ³¨é‡Šï¼Œæ‹’ç»äºŒæ‰‹è§£é‡Šã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/**</div><div class="line"> * </div><div class="line"> * This is basically &lt;code&gt;org.apache.ftpserver.ftplet.FtpletContext&lt;/code&gt; with</div><div class="line"> * added connection manager, message resource functionalities.</div><div class="line"> *</div><div class="line"> */</div><div class="line">public interface FtpServerContext extends FtpletContext &#123;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * </div><div class="line"> * FTP server configuration implementation. It holds all the components used.</div><div class="line"> */</div><div class="line">public class DefaultFtpServerContext implements FtpServerContext &#123;</div></pre></td></tr></table></figure>
<p>çœ‹äº†æ–‡æ¡£çš„æ³¨é‡Šå°±å¾ˆå®¹æ˜“å»è¯»æ‡‚è¿™ä¸ªâ€contextâ€æ˜¯ä»€ä¹ˆç©æ„å„¿äº†ã€‚æ— éå°±æ˜¯ä¸€äº›é…ç½®è€Œå·²ã€‚â€œä¸Šä¸‹æ–‡â€ä¹Ÿå¯ä»¥è§£é‡Šä¸ºâ€œè¿è¡Œç¯å¢ƒâ€å§ã€‚æˆ‘ä¸ªäººç†è§£æ˜¯è¿™ä¸ªç¨‹åºåœ¨è·‘çš„è¿‡ç¨‹ä¸­çš„æ‰€éœ€è¦çš„ææ–™ã€‚ç±»æ¯”servletä¸­ï¼Œé€šè¿‡ä¸Šä¸‹æ–‡å¯ä»¥æ‹¿åˆ°requestã€responseå¯¹è±¡ã€‚é‚£ä¹Ÿå°±å¯ä»¥è¯´reqã€respæ˜¯å±äºservletè¿è¡Œçš„ææ–™ã€‚<br>FtpServerContextæ˜¯ä¸€ä¸ªæ¥å£ï¼Œé»˜è®¤å®ç°ç±»æ˜¯DefaultFtpServerContextï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">public class DefaultFtpServerContext implements FtpServerContext &#123;</div><div class="line"></div><div class="line">    private final Logger LOG = LoggerFactory</div><div class="line">            .getLogger(DefaultFtpServerContext.class);</div><div class="line"></div><div class="line">    private MessageResource messageResource = new MessageResourceFactory().createMessageResource();</div><div class="line"></div><div class="line">    private UserManager userManager = new PropertiesUserManagerFactory().createUserManager();</div><div class="line"></div><div class="line">    private FileSystemFactory fileSystemManager = new NativeFileSystemFactory();</div><div class="line"></div><div class="line">    private FtpletContainer ftpletContainer = new DefaultFtpletContainer();</div><div class="line"></div><div class="line">    private FtpStatistics statistics = new DefaultFtpStatistics();</div><div class="line"></div><div class="line">    private CommandFactory commandFactory = new CommandFactoryFactory().createCommandFactory();</div><div class="line"></div><div class="line">    private ConnectionConfig connectionConfig = new ConnectionConfigFactory().createConnectionConfig();</div><div class="line"></div><div class="line">    private Map&lt;String, Listener&gt; listeners = new HashMap&lt;String, Listener&gt;();</div><div class="line"></div><div class="line">    private static final List&lt;Authority&gt; ADMIN_AUTHORITIES = new ArrayList&lt;Authority&gt;();</div><div class="line">    private static final List&lt;Authority&gt; ANON_AUTHORITIES = new ArrayList&lt;Authority&gt;();</div><div class="line">    </div><div class="line">    /**</div><div class="line">     * The thread pool executor to be used by the server using this context</div><div class="line">     */</div><div class="line">    private ThreadPoolExecutor threadPoolExecutor = null;</div><div class="line">    </div><div class="line">    static &#123;</div><div class="line">        ADMIN_AUTHORITIES.add(new WritePermission());</div><div class="line">        </div><div class="line">        ANON_AUTHORITIES.add(new ConcurrentLoginPermission(20, 2));</div><div class="line">        ANON_AUTHORITIES.add(new TransferRatePermission(4800, 4800));</div><div class="line">    &#125;</div><div class="line">    //...çœç•¥...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªç±»ä¸­åŒ…å«äº†æœ‰å¾ˆå¤šæˆå‘˜å˜é‡ï¼Œæœ‰æ¶ˆæ¯èµ„æºçš„MessageResourceï¼Œè¿™ä¸ªä¸»è¦æ˜¯ç”¨äºè¯»å–ftpserverä¸­é…ç½®çš„èµ„æºï¼Œç±»ä¼¼äºftpå“åº”502å¯¹åº”çš„æ–‡å­—æè¿°è¿™æ ·çš„ã€‚å¹¶æ²¡æœ‰å°†è¿™äº›ä¸œè¥¿ç¡¬ç¼–ç ï¼Œè€Œæ˜¯æŠ½è±¡æˆèµ„æºï¼Œé€šè¿‡æ–‡æœ¬æ–‡ä»¶å»é…ç½®ã€‚UserManagerç”¨äºå¯¹ç”¨æˆ·çš„ç®¡ç†ï¼Œæ¯”æ–¹è¯´å“ªäº›ç”¨æˆ·æœ‰è®¿é—®çš„æƒé™ç­‰ã€‚FileSystemFactoryæ˜¯ç®¡ç†æ–‡ä»¶çš„ï¼Œä¸åŒç”¨æˆ·çš„æƒé™å¯èƒ½æ˜¯ä¸åŒçš„ï¼Œçœ‹åˆ°çš„ç›®å½•ä¹Ÿæœ‰å¯èƒ½æ˜¯ä¸åŒçš„ã€‚FtpletContainerè¿™ä¸ªè¯´ä¸æ¸…æ¥šï¼Œæš‚æ—¶åˆ«å»ç®¡è¿™ä¸ªï¼Œåé¢å†è¯´ã€‚FtpStatisticsè¿™ä¸ªç±»ä¸»è¦æ˜¯è®°å½•å„ç§æ•°æ®ï¼Œæ¯”å¦‚å½“å‰è¿æ¥æ•°ï¼Œç™»å½•ç”¨æˆ·æ•°ç­‰ã€‚CommandFactoryè¿™ä¸ªå¾ˆå®¹æ˜“è¯´äº†ï¼Œå‘½ä»¤å·¥å‚ï¼Œä¸Šç¯‡æ–‡ç« ä¸­è¯´åˆ°æ ¹æ®å®¢æˆ·ç«¯æŒ‡ä»¤ä¸åŒåˆ›å»ºå„ç§å‘½ä»¤å®ä¾‹æ¥åˆ†åˆ«å¤„ç†ã€‚ConnectionConfigç”¨äºå¯¹socketçš„è¿æ¥ç®¡ç†ã€‚<br>é™¤äº†è¿™äº›è¿˜æœ‰ä¸€ä¸ªmapå’Œ2ä¸ªlistï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">private Map&lt;String, Listener&gt; listeners = new HashMap&lt;String, Listener&gt;();</div><div class="line">private static final List&lt;Authority&gt; ADMIN_AUTHORITIES = new ArrayList&lt;Authority&gt;();</div><div class="line">private static final List&lt;Authority&gt; ANON_AUTHORITIES = new ArrayList&lt;Authority&gt;();</div></pre></td></tr></table></figure></p>
<p>listenersåœ¨contextåˆå§‹åŒ–çš„æ—¶å€™æ”¾è¿›å»ä¸€ä¸ªdefaultçš„listenerï¼Œä¹Ÿå°±æ˜¯NioListenerçš„å®ä¾‹ã€‚åªæ˜¯é€šè¿‡å·¥å‚æ–¹å¼å»åˆ›å»ºçš„ã€‚è€Œå…¶ä»–2ä¸ªliståˆ™æ˜¯ç”¨æ¥è£…adminçš„æƒé™å’Œanonçš„æƒé™ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">static &#123;</div><div class="line">        ADMIN_AUTHORITIES.add(new WritePermission());</div><div class="line">        </div><div class="line">        ANON_AUTHORITIES.add(new ConcurrentLoginPermission(20, 2));</div><div class="line">        ANON_AUTHORITIES.add(new TransferRatePermission(4800, 4800));</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>åœ¨ç±»è£…è½½çš„æ—¶å€™å°±å°†æƒé™åŠ è¿›å»äº†ï¼Œadminæœ‰å†™æƒé™ï¼Œanonæœ‰å¹¶å‘ç™»å½•æƒé™ï¼Œå…¶ä¸­è¿˜å¯¹anonè¿›è¡Œäº†ä¸€ä¸ªä¼ è¾“é€Ÿç‡çš„é…ç½®ã€‚<br>è‡³æ­¤ï¼Œè¿™ä¸ªâ€œç¥ç§˜â€çš„contextå°±åŸºæœ¬ä¸Šæ¢³ç†å®Œäº†ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ­¤ç¯‡æ–‡ç« æ¥è§£è¯»ftpserverä¸­çš„æ ¸å¿ƒç»„ä»¶â€“FtpServerContext&lt;br&gt;åœ¨å¾ˆå¤šç±»ä¸­éƒ½æœ‰çœ‹åˆ°è¿™ä¸ªä¸œè¥¿ï¼Œé¡¾åæ€ä¹‰å°±æ˜¯ä¸Šä¸‹æ–‡ã€‚æ ¹æ®ä»¥å¾€çš„åœ¨java webä¸­çš„servlet contextçš„ç†è§£ï¼Œå­—é¢æ„æ€å°±æ˜¯ä¸Šä¸‹æ–‡ã€‚
    
    </summary>
    
      <category term="Apache Open Project" scheme="http://www.wei-dong.top/categories/Apache-Open-Project/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="Apache" scheme="http://www.wei-dong.top/tags/Apache/"/>
    
  </entry>
  
  <entry>
    <title>FtpServer(â…¡)</title>
    <link href="http://www.wei-dong.top/2017/03/26/ftpserver2-md/"/>
    <id>http://www.wei-dong.top/2017/03/26/ftpserver2-md/</id>
    <published>2017-03-26T08:27:41.000Z</published>
    <updated>2017-03-26T08:36:33.000Z</updated>
    
    <content type="html"><![CDATA[<p>æœ‰äº†ä¹‹å‰çš„æ€»ä½“å°çª¥åï¼Œç°åœ¨å¼€å§‹ç»†ç»†æŠŠç©å…¶ä¸­çš„æ·±é‚ƒä¹‹å¤„äº†ã€‚<br>å…¶ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸å°‘çš„factoryï¼Œæ¯”å¦‚FtpServerFactoryã€ListenerFactoryç­‰ã€‚é€šè¿‡åå­—å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œè¿™äº›éƒ½æ˜¯ç”¨æ¥äº§ç”Ÿå®ä¾‹çš„å·¥å‚ã€‚<br><a id="more"></a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">public Listener createListener() &#123;</div><div class="line">        try &#123;</div><div class="line">            InetAddress.getByName(serverAddress);</div><div class="line">        &#125; catch (UnknownHostException e) &#123;</div><div class="line">            throw new FtpServerConfigurationException(&quot;Unknown host&quot;, e);</div><div class="line">        &#125;</div><div class="line">        // Deal with the old style black list and new session Filter here.</div><div class="line">        if (sessionFilter != null) &#123;</div><div class="line">            if (blockedAddresses != null || blockedSubnets != null) &#123;</div><div class="line">                throw new IllegalStateException(</div><div class="line">                        &quot;Usage of SessionFilter in combination with blockedAddesses/subnets is not supported. &quot;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        if (blockedAddresses != null || blockedSubnets != null) &#123;</div><div class="line">            return new NioListener(serverAddress, port, implicitSsl, ssl,</div><div class="line">                    dataConnectionConfig, idleTimeout, blockedAddresses,</div><div class="line">                    blockedSubnets);</div><div class="line">        &#125; else &#123;</div><div class="line">            return new NioListener(serverAddress, port, implicitSsl, ssl,</div><div class="line">                    dataConnectionConfig, idleTimeout, sessionFilter);</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªlistenerfactoryé€šè¿‡createListeneråˆ›å»ºlistenerã€‚åŒç†serverFactoryä¹Ÿæ˜¯ä¸€æ ·ã€‚<br>å…ˆçœ‹çœ‹listenerå·¥åœºæœ‰å“ªäº›æˆå‘˜å˜é‡ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">private String serverAddress;</div><div class="line">    //ç«¯å£é»˜è®¤æ˜¯21ï¼Œæœ¬åœ°éƒ¨ç½²ä¼šæœ‰æƒé™å†²çª</div><div class="line">    private int port = 21;</div><div class="line">    //åŠ å¯†é…ç½®ï¼Œæš‚æ—¶ä¸ç®¡</div><div class="line">    private SslConfiguration ssl;</div><div class="line"></div><div class="line">    private boolean implicitSsl = false;</div><div class="line"></div><div class="line">    private DataConnectionConfiguration dataConnectionConfig = new DataConnectionConfigurationFactory()</div><div class="line">            .createDataConnectionConfiguration();</div><div class="line"></div><div class="line">    private int idleTimeout = 300;</div><div class="line">    //é»‘åå•</div><div class="line">    private List&lt;InetAddress&gt; blockedAddresses;</div><div class="line">    private List&lt;Subnet&gt; blockedSubnets;</div><div class="line">    </div><div class="line">    /**</div><div class="line">     * The Session filter</div><div class="line">     * è¿‡æ»¤å™¨</div><div class="line">     */</div><div class="line">    private SessionFilter sessionFilter = null;</div></pre></td></tr></table></figure></p>
<p>æœ€é‡è¦çš„è¿˜æ˜¯å“ªä¸ªcreateListeneræ–¹æ³•ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">return new NioListener(serverAddress, port, implicitSsl, ssl,</div><div class="line">                    dataConnectionConfig, idleTimeout, sessionFilter);</div></pre></td></tr></table></figure></p>
<p>æœ€åè¿”å›çš„æ˜¯ä¸€ä¸ªNioListenerã€‚è¿™ä¸ªå·¥å‚åªåˆ›å»ºNiolistenerã€‚<br>å…·ä½“åˆ°NioListenerå°±æ¶‰åŠåˆ°MINAäº†<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">public class NioListener extends AbstractListener</div></pre></td></tr></table></figure></p>
<p>è¿™é‡Œæœ‰ä¸ªé‡è¦çš„æ¥å£å°±æ˜¯Listenerï¼ŒAbstractListenerå®ç°äº†è¿™ä¸ªæ¥å£ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">void start(FtpServerContext serverContext);</div><div class="line">void stop();</div><div class="line">boolean isStopped();</div><div class="line">void suspend();</div><div class="line">void resume();</div><div class="line">boolean isSuspended();</div><div class="line">Set&lt;FtpIoSession&gt; getActiveSessions();</div><div class="line">boolean isImplicitSsl();</div><div class="line">SslConfiguration getSslConfiguration();</div><div class="line">int getPort();</div><div class="line">String getServerAddress();</div><div class="line">DataConnectionConfiguration getDataConnectionConfiguration();</div><div class="line">int getIdleTimeout();</div><div class="line">@Deprecated</div><div class="line">List&lt;InetAddress&gt; getBlockedAddresses();</div><div class="line"></div><div class="line">@Deprecated</div><div class="line">List&lt;Subnet&gt; getBlockedSubnets();</div><div class="line"></div><div class="line"></div><div class="line">SessionFilter getSessionFilter();</div></pre></td></tr></table></figure></p>
<p>æ— éå°±æ˜¯å®šä¹‰äº†ä¸€äº›å…³äºæœåŠ¡å™¨ç›‘å¬çŠ¶æ€çš„æ§åˆ¶ã€‚<br>å†çœ‹çœ‹Niolistenreä¸­çš„æ ¸å¿ƒæ–¹æ³•start<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line">public synchronized void start(FtpServerContext context) &#123;</div><div class="line">        if(!isStopped()) &#123;</div><div class="line">            // listener already started, don&apos;t allow</div><div class="line">            throw new IllegalStateException(&quot;Listener already started&quot;);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        try &#123;</div><div class="line">            </div><div class="line">            this.context = context;</div><div class="line"></div><div class="line">            //åˆ›å»ºä¸€ä¸ªacceptorï¼Œç”¨æ¥ç›‘å¬è¿æ¥</div><div class="line">            acceptor = new NioSocketAcceptor(Runtime.getRuntime()</div><div class="line">                    .availableProcessors());</div><div class="line">    </div><div class="line">            if (getServerAddress() != null) &#123;</div><div class="line">                address = new InetSocketAddress(getServerAddress(), getPort());</div><div class="line">            &#125; else &#123;</div><div class="line">                address = new InetSocketAddress(getPort());</div><div class="line">            &#125;</div><div class="line">    </div><div class="line">            acceptor.setReuseAddress(true);</div><div class="line">            acceptor.getSessionConfig().setReadBufferSize(2048);</div><div class="line">            acceptor.getSessionConfig().setIdleTime(IdleStatus.BOTH_IDLE,</div><div class="line">                    getIdleTimeout());</div><div class="line">            // Decrease the default receiver buffer size</div><div class="line">            acceptor.getSessionConfig().setReceiveBufferSize(512);</div><div class="line">    </div><div class="line">            MdcInjectionFilter mdcFilter = new MdcInjectionFilter();</div><div class="line"></div><div class="line">            //æ·»åŠ ä¸€ç³»åˆ—è¿‡æ»¤å™¨é“¾</div><div class="line">            acceptor.getFilterChain().addLast(&quot;mdcFilter&quot;, mdcFilter);</div><div class="line"></div><div class="line">            SessionFilter sessionFilter = getSessionFilter();</div><div class="line">            if (sessionFilter != null) &#123;</div><div class="line">                // add and IP filter to the filter chain.</div><div class="line">                acceptor.getFilterChain().addLast(&quot;sessionFilter&quot;,</div><div class="line">                        new MinaSessionFilter(sessionFilter));</div><div class="line">            &#125;</div><div class="line">    </div><div class="line">            acceptor.getFilterChain().addLast(&quot;threadPool&quot;,</div><div class="line">                    new ExecutorFilter(context.getThreadPoolExecutor()));</div><div class="line">            acceptor.getFilterChain().addLast(&quot;codec&quot;,</div><div class="line">                    new ProtocolCodecFilter(new FtpServerProtocolCodecFactory()));</div><div class="line">            acceptor.getFilterChain().addLast(&quot;mdcFilter2&quot;, mdcFilter);</div><div class="line">            acceptor.getFilterChain().addLast(&quot;logger&quot;, new FtpLoggingFilter());</div><div class="line"></div><div class="line">            //å¯¹sslçš„æ”¯æŒ</div><div class="line">            if (isImplicitSsl()) &#123;</div><div class="line">                SslConfiguration ssl = getSslConfiguration();</div><div class="line">                SslFilter sslFilter;</div><div class="line">                try &#123;</div><div class="line">                    sslFilter = new SslFilter(ssl.getSSLContext());</div><div class="line">                &#125; catch (GeneralSecurityException e) &#123;</div><div class="line">                    throw new FtpServerConfigurationException(&quot;SSL could not be initialized, check configuration&quot;);</div><div class="line">                &#125;</div><div class="line">    </div><div class="line">                if (ssl.getClientAuth() == ClientAuth.NEED) &#123;</div><div class="line">                    sslFilter.setNeedClientAuth(true);</div><div class="line">                &#125; else if (ssl.getClientAuth() == ClientAuth.WANT) &#123;</div><div class="line">                    sslFilter.setWantClientAuth(true);</div><div class="line">                &#125;</div><div class="line">    </div><div class="line">                if (ssl.getEnabledCipherSuites() != null) &#123;</div><div class="line">                    sslFilter.setEnabledCipherSuites(ssl.getEnabledCipherSuites());</div><div class="line">                &#125;</div><div class="line">    </div><div class="line">                acceptor.getFilterChain().addFirst(&quot;sslFilter&quot;, sslFilter);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            //è¿™é‡Œæ‰æ˜¯æ­£çœŸçš„æ ¸å¿ƒäº†ï¼Œç”¨äºå¤„ç†æ¶ˆæ¯äº‹ä»¶</div><div class="line">            handler.init(context, this);</div><div class="line">            acceptor.setHandler(new FtpHandlerAdapter(context, handler));</div><div class="line">    </div><div class="line">            try &#123;</div><div class="line">                //ç»‘å®šåœ°å€ç«¯å£ï¼Œç„¶åå°±å¼€å§‹ç›‘å¬äº‹ä»¶äº†</div><div class="line">                acceptor.bind(address);</div><div class="line">            &#125; catch (IOException e) &#123;</div><div class="line">                throw new FtpServerConfigurationException(&quot;Failed to bind to address &quot; + address + &quot;, check configuration&quot;, e);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            updatePort();</div><div class="line">    </div><div class="line">        &#125; catch(RuntimeException e) &#123;</div><div class="line">            // clean up if we fail to start</div><div class="line">            stop();</div><div class="line">            </div><div class="line">            throw e;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­ä½¿ç”¨åˆ°çš„MINAçš„ç±»NioSocketAcceptorç”¨äºåˆ›å»ºä¸€ä¸ªsocketç›‘å¬ï¼Œè¯´ç™½äº†å°±æ˜¯å¯åŠ¨æœåŠ¡å™¨ã€‚é™¤äº†æ¯”è¾ƒå…³é”®çš„filterä¹‹å¤–å°±å±handleräº†ã€‚<br>çœ‹çœ‹å…¶ä¸­çš„ä¸€ä¸ªcodecè¿‡æ»¤å™¨ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public class FtpServerProtocolCodecFactory implements ProtocolCodecFactory &#123;</div><div class="line">    private final ProtocolDecoder decoder = new TextLineDecoder(Charset</div><div class="line">            .forName(&quot;UTF-8&quot;));</div><div class="line"></div><div class="line">    private final ProtocolEncoder encoder = new FtpResponseEncoder();</div><div class="line"></div><div class="line">    public ProtocolDecoder getDecoder(IoSession session) throws Exception &#123;</div><div class="line">        return decoder;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public ProtocolEncoder getEncoder(IoSession session) throws Exception &#123;</div><div class="line">        return encoder;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>decodeæ˜¯è§£ç ï¼Œencodeæ˜¯ç¼–ç ã€‚æ‰€è°“è§£ç å°±æ˜¯æœåŠ¡å™¨ç›¸å¯¹å®¢æˆ·ç«¯æ¥è¯´ï¼Œå®¢æˆ·è¾“å…¥çš„ä¸œè¥¿æˆ‘ä»¬æ¥è§£æï¼Œç›¸åæˆ‘ä»¬æœåŠ¡å™¨ä¼ ç»™å®¢æˆ·ç«¯çš„å°±å«ç¼–ç äº†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè§£ç ä½¿ç”¨çš„æ˜¯MINAé»˜è®¤çš„æ–‡æœ¬è§£ç å™¨ï¼Œftpå®¢æˆ·ç«¯è¾“å…¥çš„ä¹Ÿåªæ˜¯ä¸€äº›æ–‡æœ¬å‘½ä»¤ç½¢äº†ã€‚æˆ‘ä»¬æœåŠ¡ç«¯çš„ç¼–ç åˆ™è‡ªå·±å®šä¹‰äº†ä¸€ä¸ªFtpResponseEncoderï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public class FtpResponseEncoder extends ProtocolEncoderAdapter &#123;</div><div class="line">    private static final CharsetEncoder ENCODER = Charset.forName(&quot;UTF-8&quot;)</div><div class="line">            .newEncoder();</div><div class="line"></div><div class="line">    public void encode(IoSession session, Object message,</div><div class="line">            ProtocolEncoderOutput out) throws Exception &#123;</div><div class="line">        String value = message.toString();</div><div class="line"></div><div class="line">        IoBuffer buf = IoBuffer.allocate(value.length()).setAutoExpand(true);</div><div class="line"></div><div class="line">        buf.putString(value, ENCODER);</div><div class="line"></div><div class="line">        buf.flip();</div><div class="line">        out.write(buf);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æˆ‘ä¸ªäººè§‰å¾—è¿™ä¸ªå®ç°å’ŒMINAä¸­çš„TextLineEncoderå®ç°åŒºåˆ«ä¸æ˜¯å¾ˆå¤§ï¼Œä¸ºä»€ä¹ˆè¦è‡ªå·±å®šä¹‰ä¸€ä¸ªè¿™æ ·çš„å®ç°ï¼Ÿ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">public void encode(IoSession session, Object message, ProtocolEncoderOutput out) throws Exception &#123;</div><div class="line">        CharsetEncoder encoder = (CharsetEncoder) session.getAttribute(ENCODER);</div><div class="line"></div><div class="line">        if (encoder == null) &#123;</div><div class="line">            encoder = charset.newEncoder();</div><div class="line">            session.setAttribute(ENCODER, encoder);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String value = (message == null ? &quot;&quot; : message.toString());</div><div class="line">        IoBuffer buf = IoBuffer.allocate(value.length()).setAutoExpand(true);</div><div class="line">        buf.putString(value, encoder);</div><div class="line"></div><div class="line">        if (buf.position() &gt; maxLineLength) &#123;</div><div class="line">            throw new IllegalArgumentException(&quot;Line length: &quot; + buf.position());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        buf.putString(delimiter.getValue(), encoder);</div><div class="line">        buf.flip();</div><div class="line">        out.write(buf);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>åˆ«çš„filterå°±ä¸ä¸€ä¸€ç»†è¯´äº†ã€‚æ¥ä¸‹æ¥çœ‹çœ‹çœŸæ­£æ ¸å¿ƒçš„handlerâ€“FtpHandlerï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">public interface FtpHandler &#123;</div><div class="line"></div><div class="line">    void init(FtpServerContext context, Listener listener);</div><div class="line"></div><div class="line">    </div><div class="line">    void sessionCreated(FtpIoSession session) throws Exception;</div><div class="line"></div><div class="line">    </div><div class="line">    void sessionOpened(FtpIoSession session) throws Exception;</div><div class="line"></div><div class="line">    </div><div class="line">    void sessionClosed(FtpIoSession session) throws Exception;</div><div class="line"></div><div class="line">    void sessionIdle(FtpIoSession session, IdleStatus status) throws Exception;</div><div class="line"></div><div class="line">    void exceptionCaught(FtpIoSession session, Throwable cause)</div><div class="line">            throws Exception;</div><div class="line"></div><div class="line">    void messageReceived(FtpIoSession session, FtpRequest request)</div><div class="line">            throws Exception;</div><div class="line"></div><div class="line">    void messageSent(FtpIoSession session, FtpReply reply) throws Exception;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®šä¹‰äº†å¾ˆå¤šçœ‹ä¼¼å’ŒMINAä¸­çš„IoHandlerä¸­çš„å¾ˆå¤šæ¥å£æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ï¼Œåªæ˜¯å‚æ•°ä¸åŒï¼Œä¸€ä¸ªæ˜¯IoSession ä¸€ä¸ªæ˜¯FtpIoSessionï¼Œæœ¬è´¨ä¸ŠFtpIoSessionä¹Ÿæ˜¯å®ç°äº†IoSessionæ¥å£çš„ï¼Œå¯ä»¥è¯´æ˜¯ä¸€æ ·çš„ã€‚<br>ç„¶è€Œï¼Œacceptorçš„setHandleræ¥å—çš„å‚æ•°æ˜¯</p>
<blockquote>
<p>setHandler(org.apache.mina.core.service.IoHandler handler)  </p>
</blockquote>
<p>MINAä¸­çš„IoHandlerï¼Œè¿™é‡Œæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„ä¸€ä¸ªHandleræ˜¯ä¸å¯ä»¥æ”¾è¿›å»çš„ã€‚äºæ˜¯ç”¨äº†ä¸€ä¸ªadapteræ¥è½¬æ¥ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line">public class FtpHandlerAdapter extends IoHandlerAdapter &#123;</div><div class="line">    private final FtpServerContext context;</div><div class="line"></div><div class="line">    private FtpHandler ftpHandler;</div><div class="line"></div><div class="line">    public FtpHandlerAdapter(FtpServerContext context, FtpHandler ftpHandler) &#123;</div><div class="line">        this.context = context;</div><div class="line">        this.ftpHandler = ftpHandler;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void exceptionCaught(IoSession session, Throwable cause)</div><div class="line">            throws Exception &#123;</div><div class="line">        //å‘ç”Ÿå¼‚å¸¸ï¼Œè¿™é‡Œå°†Iosessioné‡æ–°åŒ…è£…äº†ä¸€ä¸‹ï¼Œå«åšftpIoSessionï¼Œå®é™…ä¸Šå°±æ˜¯å®ç°äº†IoSessionè€Œå·²</div><div class="line">        FtpIoSession ftpSession = new FtpIoSession(session, context);</div><div class="line">//        ç„¶åè¿™ä¸ªftpHandlerå°±å¯¹åŒ…è£…åçš„sessionè¿›è¡Œå¤„ç†ï¼Œä¸‹åŒ</div><div class="line">        ftpHandler.exceptionCaught(ftpSession, cause);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void messageReceived(IoSession session, Object message)</div><div class="line">            throws Exception &#123;</div><div class="line">        FtpIoSession ftpSession = new FtpIoSession(session, context);</div><div class="line">        //å°†å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤æŠ½è±¡æˆFtpRequestï¼Œå°†messageä¼ è¿›å»åŒ…è£…æˆrequestå¯¹è±¡</div><div class="line">        FtpRequest request = new DefaultFtpRequest(message.toString());</div><div class="line">        //å¤„ç†æ¥å—æ¶ˆæ¯äº‹ä»¶</div><div class="line">        ftpHandler.messageReceived(ftpSession, request);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void messageSent(IoSession session, Object message) throws Exception &#123;</div><div class="line">        FtpIoSession ftpSession = new FtpIoSession(session, context);</div><div class="line">        //å¤„ç†æ¶ˆæ¯å‘é€äº‹ä»¶</div><div class="line">        ftpHandler.messageSent(ftpSession, (FtpReply) message);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void sessionClosed(IoSession session) throws Exception &#123;</div><div class="line">        FtpIoSession ftpSession = new FtpIoSession(session, context);</div><div class="line">        //sessionå…³é—­æ—¶</div><div class="line">        ftpHandler.sessionClosed(ftpSession);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void sessionCreated(IoSession session) throws Exception &#123;</div><div class="line">        FtpIoSession ftpSession = new FtpIoSession(session, context);</div><div class="line">        MdcInjectionFilter.setProperty(session, &quot;session&quot;, ftpSession.getSessionId().toString());</div><div class="line">        //sessionåˆ›å»ºæ—¶ï¼Œå…ˆä¸åˆ›å»ºå†æœ‰æ‰“å¼€</div><div class="line">        ftpHandler.sessionCreated(ftpSession);</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void sessionIdle(IoSession session, IdleStatus status)</div><div class="line">            throws Exception &#123;</div><div class="line">        FtpIoSession ftpSession = new FtpIoSession(session, context);</div><div class="line">        //sessionç©ºé—²</div><div class="line">        ftpHandler.sessionIdle(ftpSession, status);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void sessionOpened(IoSession session) throws Exception &#123;</div><div class="line">        FtpIoSession ftpSession = new FtpIoSession(session, context);</div><div class="line">        //sessionæ‰“å¼€ï¼Œä¹Ÿå°±æ˜¯è¿æ¥æ‰“å¼€çš„æ—¶å€™</div><div class="line">        ftpHandler.sessionOpened(ftpSession);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public FtpHandler getFtpHandler() &#123;</div><div class="line">        return ftpHandler;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    public void setFtpHandler(FtpHandler handler) &#123;</div><div class="line">        this.ftpHandler = handler;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>æ­£çœŸå¤„ç†sessionçš„ä¾æ—§æ˜¯æˆ‘ä»¬å®šä¹‰çš„DefaultFtpHandlerã€‚è¿™æ ·è®¾è®¡çš„æ„ä¹‰ä½•åœ¨ï¼Ÿï¼Ÿæˆ‘è§‰å¾—æ˜¯ä¸è¦è¿‡åº¦ä¾èµ–äºMINAçš„apiå§ã€‚æˆ–è€…ä¸ºäº†è£…é€¼ã€‚<br>æ¥ä¸‹æ¥çœ‹çœ‹å¤„ç†sessionçš„é€»è¾‘ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public void messageReceived(IoSession session, Object message)</div><div class="line">        throws Exception &#123;</div><div class="line">    FtpIoSession ftpSession = new FtpIoSession(session, context);</div><div class="line">    //å°†å®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤æŠ½è±¡æˆFtpRequestï¼Œå°†messageä¼ è¿›å»åŒ…è£…æˆrequestå¯¹è±¡</div><div class="line">    FtpRequest request = new DefaultFtpRequest(message.toString());</div><div class="line">    //å¤„ç†æ¥å—æ¶ˆæ¯äº‹ä»¶</div><div class="line">    ftpHandler.messageReceived(ftpSession, request);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line">public void messageReceived(final FtpIoSession session,</div><div class="line">        final FtpRequest request) throws Exception &#123;</div><div class="line">    try &#123;</div><div class="line">        session.updateLastAccessTime();</div><div class="line">        //å°†å®¢æˆ·ç«¯è¾“å…¥å‘½ä»¤å°è£…æˆcommandå¯¹è±¡</div><div class="line">        String commandName = request.getCommand();</div><div class="line">        //è¿™ä¸ªfactoryå¾ˆæœ‰æ„æ€ï¼Œæ˜¯é€šè¿‡factoryæ¥åˆ›å»ºçš„</div><div class="line">        //private CommandFactory commandFactory = new CommandFactoryFactory().createCommandFactory();</div><div class="line">        CommandFactory commandFactory = context.getCommandFactory();</div><div class="line">        //è¿™é‡Œè·å¾—çš„commandæ ¹æ®å‘½ä»¤ä¸åŒè·å–çš„cmdå¯¹è±¡ä¸åŒ</div><div class="line">        Command command = commandFactory.getCommand(commandName);</div><div class="line"></div><div class="line">        // make sure the user is authenticated before he issues commands</div><div class="line">        if (!session.isLoggedIn()</div><div class="line">                &amp;&amp; !isCommandOkWithoutAuthentication(commandName)) &#123;</div><div class="line">            session.write(LocalizedFtpReply.translate(session, request,</div><div class="line">                    context, FtpReply.REPLY_530_NOT_LOGGED_IN,</div><div class="line">                    &quot;permission&quot;, null));</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        FtpletContainer ftplets = context.getFtpletContainer();</div><div class="line"></div><div class="line">        FtpletResult ftpletRet;</div><div class="line">        try &#123;</div><div class="line">            ftpletRet = ftplets.beforeCommand(session.getFtpletSession(),</div><div class="line">                    request);</div><div class="line">        &#125; catch (Exception e) &#123;</div><div class="line">            LOG.debug(&quot;Ftplet container threw exception&quot;, e);</div><div class="line">            ftpletRet = FtpletResult.DISCONNECT;</div><div class="line">        &#125;</div><div class="line">        if (ftpletRet == FtpletResult.DISCONNECT) &#123;</div><div class="line">            LOG.debug(&quot;Ftplet returned DISCONNECT, session will be closed&quot;);</div><div class="line">            session.close(false).awaitUninterruptibly(10000);</div><div class="line">            return;</div><div class="line">        &#125; else if (ftpletRet != FtpletResult.SKIP) &#123;</div><div class="line"></div><div class="line">            if (command != null) &#123;</div><div class="line">                synchronized (session) &#123;</div><div class="line">                    command.execute(session, context, request);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                session.write(LocalizedFtpReply.translate(session, request,</div><div class="line">                        context,</div><div class="line">                        FtpReply.REPLY_502_COMMAND_NOT_IMPLEMENTED,</div><div class="line">                        &quot;not.implemented&quot;, null));</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            try &#123;</div><div class="line">                ftpletRet = ftplets.afterCommand(</div><div class="line">                        session.getFtpletSession(), request, session</div><div class="line">                                .getLastReply());</div><div class="line">            &#125; catch (Exception e) &#123;</div><div class="line">                LOG.debug(&quot;Ftplet container threw exception&quot;, e);</div><div class="line">                ftpletRet = FtpletResult.DISCONNECT;</div><div class="line">            &#125;</div><div class="line">            if (ftpletRet == FtpletResult.DISCONNECT) &#123;</div><div class="line">                LOG.debug(&quot;Ftplet returned DISCONNECT, session will be closed&quot;);</div><div class="line"></div><div class="line">                session.close(false).awaitUninterruptibly(10000);</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125; catch (Exception ex) &#123;</div><div class="line"></div><div class="line">        // send error reply</div><div class="line">        try &#123;</div><div class="line">            session.write(LocalizedFtpReply.translate(session, request,</div><div class="line">                    context, FtpReply.REPLY_550_REQUESTED_ACTION_NOT_TAKEN,</div><div class="line">                    null, null));</div><div class="line">        &#125; catch (Exception ex1) &#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (ex instanceof java.io.IOException) &#123;</div><div class="line">            throw (IOException) ex;</div><div class="line">        &#125; else &#123;</div><div class="line">            LOG.warn(&quot;RequestHandler.service()&quot;, ex);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹åº”çš„ä¸€äº›ftpå‘½ä»¤ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">static &#123;</div><div class="line">        // first populate the default command list</div><div class="line">        DEFAULT_COMMAND_MAP.put(&quot;ABOR&quot;, new ABOR());</div><div class="line">        DEFAULT_COMMAND_MAP.put(&quot;ACCT&quot;, new ACCT());</div><div class="line">        DEFAULT_COMMAND_MAP.put(&quot;APPE&quot;, new APPE());</div><div class="line">        DEFAULT_COMMAND_MAP.put(&quot;AUTH&quot;, new AUTH());</div><div class="line">        /*çœç•¥éƒ¨åˆ†*/</div><div class="line">        DEFAULT_COMMAND_MAP.put(&quot;STOR&quot;, new STOR());</div><div class="line">        DEFAULT_COMMAND_MAP.put(&quot;STOU&quot;, new STOU());</div><div class="line">        DEFAULT_COMMAND_MAP.put(&quot;STRU&quot;, new STRU());</div><div class="line">        DEFAULT_COMMAND_MAP.put(&quot;SYST&quot;, new SYST());</div><div class="line">        DEFAULT_COMMAND_MAP.put(&quot;TYPE&quot;, new TYPE());</div><div class="line">        DEFAULT_COMMAND_MAP.put(&quot;USER&quot;, new USER());</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å†çœ‹çœ‹ä¸»è¦çš„é€»è¾‘ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">if (command != null) &#123;</div><div class="line">    synchronized (session) &#123;</div><div class="line">        command.execute(session, context, request);</div><div class="line">    &#125;</div><div class="line">&#125; else &#123;</div><div class="line">    session.write(LocalizedFtpReply.translate(session, request,</div><div class="line">            context,</div><div class="line">            FtpReply.REPLY_502_COMMAND_NOT_IMPLEMENTED,</div><div class="line">            &quot;not.implemented&quot;, null));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>å°†æ¯ä¸€ä¸ªsessionä½œä¸ºä¸€ä¸ªé”ï¼Œä¿è¯æ¯ä¸ªè¿æ¥çš„åŒæ­¥æ“ä½œã€‚å…·ä½“çš„executeåšäº†ä¸€äº›ä»€ä¹ˆæ“ä½œï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">void execute(FtpIoSession session, FtpServerContext context,</div><div class="line">            FtpRequest request) throws IOException, FtpException;</div></pre></td></tr></table></figure></p>
<p>è¿™æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…·ä½“çš„æ“ä½œæ˜¯ç”±è¿™ä¸ªcommandæ˜¯ä»€ä¹ˆå†³å®šçš„ã€‚æˆ‘ä»¬æŒ‘ä¸€ä¸ªæœ€ç®€å•çš„å®ç°PWDï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public class PWD extends AbstractCommand &#123;</div><div class="line"></div><div class="line">    /**</div><div class="line">     * Execute command</div><div class="line">     */</div><div class="line">    public void execute(final FtpIoSession session,</div><div class="line">            final FtpServerContext context, final FtpRequest request)</div><div class="line">            throws IOException, FtpException &#123;</div><div class="line">        session.resetState();</div><div class="line">        FileSystemView fsview = session.getFileSystemView();</div><div class="line">        String currDir = fsview.getWorkingDirectory().getAbsolutePath();</div><div class="line">        session.write(LocalizedFtpReply.translate(session, request, context,</div><div class="line">                FtpReply.REPLY_257_PATHNAME_CREATED, &quot;PWD&quot;, currDir));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>è¿™ä¸ªå‘½ä»¤ç”¨æ¥æ˜¾ç¤ºå½“å‰ç›®å½•ã€‚å¾ˆå®¹æ˜“ç†è§£ã€‚<br>è‡³æ­¤ï¼Œæ•´ä¸ªftpçš„å¯åŠ¨æµç¨‹éƒ½å…¨éƒ¨æ¢³ç†å®Œæ¯•ï¼Œä»æœåŠ¡å™¨å¯åŠ¨åˆ°æ¥å—å®¢æˆ·ç«¯å‘½ä»¤ï¼Œå…¶ä¸­çš„é€»è¾‘å®é™…ä¸Šä¸€ç‚¹éƒ½ä¸å¤æ‚ã€‚æ•´ä¸ªæœåŠ¡å¯åŠ¨åˆ°ä¸å®¢æˆ·ç«¯äº¤äº’IoSessionéƒ½ç©¿æ’å…¶ä¸­ï¼Œå¯¹minaçš„ä¾èµ–ä¹Ÿä¸æ˜¯å¾ˆæ˜æ˜¾ï¼Œå½“ç„¶è¿™æ˜¯ä½œè€…åˆ»æ„å°†è€¦åˆé™åˆ°æœ€ä½ï¼Œè¿™ç§è®¾è®¡æ€æƒ³å€¼å¾—å­¦ä¹ å€Ÿé‰´ã€‚<br>æ¥ä¸‹æ¥å°±å…·ä½“æ¢è®¨å„ä¸ªæ¨¡å—çš„å®ç°ç»†èŠ‚ã€‚</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ‰äº†ä¹‹å‰çš„æ€»ä½“å°çª¥åï¼Œç°åœ¨å¼€å§‹ç»†ç»†æŠŠç©å…¶ä¸­çš„æ·±é‚ƒä¹‹å¤„äº†ã€‚&lt;br&gt;å…¶ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸å°‘çš„factoryï¼Œæ¯”å¦‚FtpServerFactoryã€ListenerFactoryç­‰ã€‚é€šè¿‡åå­—å¯ä»¥çœ‹å¾—å‡ºæ¥ï¼Œè¿™äº›éƒ½æ˜¯ç”¨æ¥äº§ç”Ÿå®ä¾‹çš„å·¥å‚ã€‚&lt;br&gt;
    
    </summary>
    
      <category term="Apache Open Project" scheme="http://www.wei-dong.top/categories/Apache-Open-Project/"/>
    
    
      <category term="æºç è§£è¯»" scheme="http://www.wei-dong.top/tags/%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    
      <category term="Apache" scheme="http://www.wei-dong.top/tags/Apache/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://www.wei-dong.top/2017/01/08/hello-world/"/>
    <id>http://www.wei-dong.top/2017/01/08/hello-world/</id>
    <published>2017-01-08T13:53:01.000Z</published>
    <updated>2017-01-08T13:53:01.000Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
    
    </summary>
    
    
  </entry>
  
</feed>
