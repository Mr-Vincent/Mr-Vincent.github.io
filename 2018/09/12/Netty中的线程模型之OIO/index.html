<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="ä»¥æ¢¦ä¸ºé©¬ ä¸è´ŸéŸ¶å">
    

    <!--Author-->
    
        <meta name="author" content="Mr-Vincent">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Nettyä¸­çš„çº¿ç¨‹æ¨¡å‹ä¹‹OIO"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="ä»¥æ¢¦ä¸ºé©¬ ä¸è´ŸéŸ¶å" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="DongWei&#39;s Blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>Nettyä¸­çš„çº¿ç¨‹æ¨¡å‹ä¹‹OIO - DongWei&#39;s Blog</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../../../../css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    


    <!-- favicon -->
    
	
</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">DongWei's Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="../../../../index.html">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="../../../../archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/Mr-Vincent">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('https://images.unsplash.com/photo-1517503733723-8ea1cf616798?ixlib=rb-0.3.5&ixid=eyJhcHBfaWQiOjEyMDd9&s=9c80b35bc18dea5bfad8db2b17d347cb&auto=format&fit=crop&w=1500&q=80')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Nettyä¸­çš„çº¿ç¨‹æ¨¡å‹ä¹‹OIO</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2018-09-12
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/æºç è§£è¯»/">#æºç è§£è¯»</a> <a href="/tags/Netty/">#Netty</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                        

<a href="/categories/ä¸€èµ·è¯»æºç /">ä¸€èµ·è¯»æºç </a>

                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p>å’Œé«˜æ€§èƒ½NIOç›¸æ¯”ï¼Œä¸ªäººè®¤ä¸ºOIOçš„å®ç°ç›¸å¯¹è¦ç®€å•ä¸€ç‚¹ï¼Œé€‰æ‹©è¿™ä¸ªéš¾åº¦ç¨å¾®ä½ä¸€ç‚¹çš„å®ç°æ¥è‚¯å¯¹ç›®å‰çš„èœé¸¡æˆ‘è€Œè¨€æ›´ç°å®ã€‚</p>
<p>æœ¬è´¨ä¸Šè€Œè¨€ï¼Œeventloopgroupå°±æ˜¯çº¿ç¨‹æ± ã€‚</p>
<p><img src="http://7xsfwn.com1.z0.glb.clouddn.com/OioEventLoopGroup.png" alt="image"></p>
<p>Nettyé’ˆå¯¹JDKçš„å®ç°åšäº†è¿›ä¸€æ­¥çš„åŠ å¼ºã€‚</p>
<p>å¯¹äºOIOçš„ç¬¬ä¸€ååº”æ˜¯ã€Œé˜»å¡ã€ï¼Œã€Œæ€§èƒ½å·®ã€ï¼Œã€Œè€—èµ„æºã€ã€‚äº‹å®ä¸Šç¡®å®å¦‚æ­¤ï¼Œä½†ä¸ºä»€ä¹ˆè¿˜è¦å†™ä¸€ç¯‡æ–‡ç« ï¼ˆç¬”è®°ï¼‰æ¥å¯¹å®ƒè¿›è¡Œæè¿°å‘¢ï¼Ÿåœ¨ä¹‹å‰ï¼Œæˆ‘ä»¥ä¸ºNettyå¹¶æ²¡æœ‰æä¾›OIOçš„å®ç°ï¼Œå¤©çœŸçš„è®¤ä¸ºNettyä»…ä»…æ˜¯å¯¹NIOè¿›è¡Œäº†å°è£…ã€‚ç›´åˆ°æŸä¸€å¤©ä½¿ç”¨åˆ°äº†OIOï¼Œæƒ³å°†OIOçš„çº¿ç¨‹æ¨¡å‹å’ŒNettyä¸­çš„å®ç°ç±»ä¼¼ï¼šä¸€ä¸ªçº¿ç¨‹è´Ÿè´£è¿æ¥ï¼Œåˆ«çš„çº¿ç¨‹è´Ÿè´£IOã€‚æƒ³äº†è®¸ä¹…æ²¡æœ‰ä¸‹æ–‡ï¼Œæœºç¼˜å·§åˆçœ‹åˆ°äº†Nettyçš„æ–‡æ¡£ï¼Œå…¶ä¸­æœ‰å¯¹OIOçš„å°è£…ï¼Œæ°å¥½å’Œæˆ‘å¿ƒä¸­æƒ³çš„ä¸€æ¨¡ä¸€æ ·ï¼Œè€Œä¸”å¯¹å¤–æä¾›çš„APIä¸å˜ã€‚è¿™ç§æŠ½è±¡è®¾è®¡è®©æˆ‘æƒ³æ·±å…¥å…¶ä¸­ï¼Œçœ‹çœ‹åˆ°åº•æ˜¯å¦‚ä½•åšåˆ°çš„ã€‚æˆ‘æƒ³å€Ÿé‰´å…¶ä¸­çš„è®¾è®¡æ¥å®ç°ä¸€ä¸ªæ¯”è¾ƒç®€å•å¯¹OIOçš„å°è£…ã€‚</p>
<blockquote>
<p>EventLoopGroup which is used to handle OIO Channelâ€™s. Each Channel will be handled by its own EventLoop to not block others.</p>
</blockquote>
<p>æ–‡æ¡£ä¸­çš„è§£é‡Šå¾ˆç®€å•ï¼ŒEventLoopGroupç”¨æ¥å¤„ç†è¿æ¥ï¼Œæ¯ä¸ªè¿æ¥ç”±å®ƒè‡ªå·±çš„EventLoopå¤„ç†ã€‚</p>
<p>è¿™æ®µè§£é‡Šä¸ç¦è”æƒ³åˆ°äº†é’ˆå¯¹OIOçš„ç¼–ç¨‹ï¼šæ¯ä¸ªè¿æ¥ç”±æ–°å¼€çš„çº¿ç¨‹å¤„ç†ï¼Œæœ‰å¤šå°‘ä¸ªè¿æ¥å°±æœ‰å¤šå°‘ä¸ªçº¿ç¨‹ã€‚è¿™é‡Œçš„Channelå°±æ˜¯è¿æ¥çš„æŠ½è±¡ï¼ŒEventLoopå¯ä»¥ç†è§£ä¸ºçº¿ç¨‹ã€‚</p>
<h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">OioEventLoopGroup</span><span class="params">(<span class="keyword">int</span> maxChannels, ThreadFactory threadFactory)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(maxChannels, threadFactory);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">ThreadPerChannelEventLoopGroup</span><span class="params">(<span class="keyword">int</span> maxChannels, ThreadFactory threadFactory, Object... args)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>(maxChannels, <span class="keyword">new</span> ThreadPerTaskExecutor(threadFactory), args);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPerTaskExecutor</span> <span class="keyword">implements</span> <span class="title">Executor</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadFactory threadFactory;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadPerTaskExecutor</span><span class="params">(ThreadFactory threadFactory)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (threadFactory == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"threadFactory"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.threadFactory = threadFactory;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable command)</span> </span>&#123;</div><div class="line">        threadFactory.newThread(command).start();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ„é€ å™¨ä¸­ä¸¤ä¸ªå‚æ•°ï¼ŒmaxChannelsä¸ºæœ€å¤§è¿æ¥æ•°ã€‚æ³¨æ„ï¼Œè¿™ä¸ªæ˜¯æ¯”è¾ƒè®²ç©¶çš„ï¼Œåœ¨Nettyçº¿ç¨‹æ¨¡å‹ä¸­æœ‰bosså’Œworkerçº¿ç¨‹ä¹‹åˆ†ã€‚å¦‚æœåªæŒ‡å®šä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯bosså°±æ˜¯workeré‚£ä¹ˆè¿™ä¸ªå€¼å¦‚æœä¸º1é‚£ä¹ˆä»»ä½•å®¢æˆ·ç«¯æ— æ³•è¿è¿›æ¥ï¼Œå¦‚æœä¸º2åˆ™åªå…è®¸1ä¸ªå®¢æˆ·ç«¯è¿è¿›æ¥ï¼Œä¾æ¬¡ç±»æ¨ã€‚é»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…è®¸æ— é™å¤šå®¢æˆ·ç«¯æ¥å…¥ï¼ˆç†è®ºä¸Šï¼‰ã€‚å½“æœ‰workerçš„æ—¶å€™ï¼Œbossçš„maxChannelsæŒ‡å®šå¤šå°‘æ— æ‰€è°“ï¼Œworkerä¸­çš„maxChannelså€¼ä¸ºå¤šå°‘å°±æ„å‘³ç€å…è®¸å¤šå°‘å®¢æˆ·ç«¯æ¥å…¥ï¼ŒåŒç†0ä»£è¡¨æ— é™å¤šã€‚ç¬¬äºŒä¸ªå‚æ•°ä¸ºçº¿ç¨‹å·¥å‚ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯JDKçš„é»˜è®¤å®ç°ï¼šExecutors.defaultThreadFactory()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="title">ThreadPerChannelEventLoopGroup</span><span class="params">(<span class="keyword">int</span> maxChannels, Executor executor, Object... args)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (maxChannels &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</div><div class="line">                <span class="string">"maxChannels: %d (expected: &gt;= 0)"</span>, maxChannels));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (executor == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"executor"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (args == <span class="keyword">null</span>) &#123;</div><div class="line">        childArgs = EmptyArrays.EMPTY_OBJECTS;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        childArgs = args.clone();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">this</span>.maxChannels = maxChannels;</div><div class="line">    <span class="keyword">this</span>.executor = executor;</div><div class="line"></div><div class="line">    tooManyChannels = ThrowableUtil.unknownStackTrace(</div><div class="line">            <span class="keyword">new</span> ChannelException(<span class="string">"too many channels (max: "</span> + maxChannels + <span class="string">')'</span>),</div><div class="line">            ThreadPerChannelEventLoopGroup.class, <span class="string">"nextChild()"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„ä¸€äº›æˆå‘˜å˜é‡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadPerChannelEventLoopGroup</span> <span class="keyword">extends</span> <span class="title">AbstractEventExecutorGroup</span> <span class="keyword">implements</span> <span class="title">EventLoopGroup</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] childArgs;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxChannels;</div><div class="line">    <span class="comment">// ä»»åŠ¡æ‰§è¡Œå™¨</span></div><div class="line">    <span class="keyword">final</span> Executor executor;</div><div class="line">    <span class="comment">// æ´»è·ƒçš„çº¿ç¨‹é›†åˆ</span></div><div class="line">    <span class="keyword">final</span> Set&lt;EventLoop&gt; activeChildren =</div><div class="line">            Collections.newSetFromMap(PlatformDependent.&lt;EventLoop, Boolean&gt;newConcurrentHashMap());</div><div class="line">    <span class="comment">// ç©ºé—²çš„çº¿ç¨‹é›†åˆ</span></div><div class="line">    <span class="keyword">final</span> Queue&lt;EventLoop&gt; idleChildren = <span class="keyword">new</span> ConcurrentLinkedQueue&lt;EventLoop&gt;();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelException tooManyChannels;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> shuttingDown;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Promise&lt;?&gt; terminationFuture = <span class="keyword">new</span> DefaultPromise&lt;Void&gt;(GlobalEventExecutor.INSTANCE);</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FutureListener&lt;Object&gt; childTerminationListener = <span class="keyword">new</span> FutureListener&lt;Object&gt;() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(Future&lt;Object&gt; future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            <span class="comment">// Inefficient, but works.</span></div><div class="line">            <span class="keyword">if</span> (isTerminated()) &#123;</div><div class="line">                terminationFuture.trySuccess(<span class="keyword">null</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>EventLoopGroupçš„åˆå§‹åŒ–å°±è¿™æ ·ç»“æŸäº†ã€‚ä½†æ˜¯è¦æ¢ç´¢å…¶ä¸­çš„å·¥ä½œæœºåˆ¶è¿˜å¾—ä»ä¸€ä¸ªServer çš„å¯åŠ¨å¼€å§‹ã€‚</p>
<h3 id="ServerBootstrapçš„å¯åŠ¨"><a href="#ServerBootstrapçš„å¯åŠ¨" class="headerlink" title="ServerBootstrapçš„å¯åŠ¨"></a>ServerBootstrapçš„å¯åŠ¨</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">        ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap(); <span class="comment">// (2)</span></div><div class="line">        b.group(bossGroup, workerGroup)</div><div class="line">         .channel(OioServerSocketChannel.class) <span class="comment">// (3)</span></div><div class="line">         .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123; <span class="comment">// (4)</span></div><div class="line">             <span class="meta">@Override</span></div><div class="line">             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                 ch.pipeline().addLast(<span class="keyword">new</span> DiscardServerHandler());</div><div class="line">             &#125;</div><div class="line">         &#125;)</div><div class="line">         .option(ChannelOption.SO_BACKLOG, <span class="number">128</span>)          <span class="comment">// (5)</span></div><div class="line">         .childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>); <span class="comment">// (6)</span></div><div class="line">    </div><div class="line">        <span class="comment">// Bind and start to accept incoming connections.</span></div><div class="line">        ChannelFuture f = b.bind(port).sync(); <span class="comment">// (7)</span></div><div class="line">    </div><div class="line">        <span class="comment">// Wait until the server socket is closed.</span></div><div class="line">        <span class="comment">// In this example, this does not happen, but you can do that to gracefully</span></div><div class="line">        <span class="comment">// shut down your server.</span></div><div class="line">        f.channel().closeFuture().sync();</div><div class="line">    &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        workerGroup.shutdownGracefully();</div><div class="line">        bossGroup.shutdownGracefully();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æœ€æ ¸å¿ƒçš„æ˜¯bindæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress)</span> </span>&#123;</div><div class="line">    validate();</div><div class="line">    <span class="keyword">if</span> (localAddress == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"localAddress"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> doBind(localAddress);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> ChannelFuture <span class="title">doBind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress)</span> </span>&#123;</div><div class="line">	 <span class="comment">// æ ¸å¿ƒæ˜¯regFutureçš„è·å–ï¼Œæœ‰äº†è¿™ä¸ªåé¢ä¸€åˆ‡éƒ½å¥½è¯´</span></div><div class="line">    <span class="keyword">final</span> ChannelFuture regFuture = initAndRegister();</div><div class="line">    <span class="keyword">final</span> Channel channel = regFuture.channel();</div><div class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> regFuture;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (regFuture.isDone()) &#123;</div><div class="line">        <span class="comment">// At this point we know that the registration was complete and successful.</span></div><div class="line">        ChannelPromise promise = channel.newPromise();</div><div class="line">        doBind0(regFuture, channel, localAddress, promise);</div><div class="line">        <span class="keyword">return</span> promise;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// Registration future is almost always fulfilled already, but just in case it's not.</span></div><div class="line">        <span class="keyword">final</span> PendingRegistrationPromise promise = <span class="keyword">new</span> PendingRegistrationPromise(channel);</div><div class="line">        regFuture.addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">                Throwable cause = future.cause();</div><div class="line">                <span class="keyword">if</span> (cause != <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="comment">// Registration on the EventLoop failed so fail the ChannelPromise directly to not cause an</span></div><div class="line">                    <span class="comment">// IllegalStateException once we try to access the EventLoop of the Channel.</span></div><div class="line">                    promise.setFailure(cause);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// Registration was successful, so set the correct executor to use.</span></div><div class="line">                    <span class="comment">// See https://github.com/netty/netty/issues/2586</span></div><div class="line">                    promise.registered();</div><div class="line"></div><div class="line">                    doBind0(regFuture, channel, localAddress, promise);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> promise;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">final</span> ChannelFuture <span class="title">initAndRegister</span><span class="params">()</span> </span>&#123;</div><div class="line">    Channel channel = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">    	 <span class="comment">// å®ä¾‹åŒ–OioServerSocketChannel</span></div><div class="line">        channel = channelFactory.newChannel();</div><div class="line">        init(channel);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        <span class="keyword">if</span> (channel != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">// channel can be null if newChannel crashed (eg SocketException("too many open files"))</span></div><div class="line">            channel.unsafe().closeForcibly();</div><div class="line">            <span class="comment">// as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> DefaultChannelPromise(channel, GlobalEventExecutor.INSTANCE).setFailure(t);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// as the Channel is not registered yet we need to force the usage of the GlobalEventExecutor</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DefaultChannelPromise(<span class="keyword">new</span> FailedChannel(), GlobalEventExecutor.INSTANCE).setFailure(t);</div><div class="line">    &#125;</div><div class="line">	 <span class="comment">// æ ¸å¿ƒæ˜¯è¿™æ®µé€»è¾‘config().group()è¿”å›çš„å°±æ˜¯æˆ‘ä»¬è®¾ç½®çš„bossï¼šOioEventLoopGroup</span></div><div class="line">    ChannelFuture regFuture = config().group().register(channel);</div><div class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (channel.isRegistered()) &#123;</div><div class="line">            channel.close();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            channel.unsafe().closeForcibly();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> regFuture;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¿½ç•¥æ‰æ— å…³çš„é€»è¾‘ï¼ˆå®åœ¨æ˜¯å¾ˆå¤æ‚ï¼‰ï¼Œå…³é”®ç‚¹åˆ°äº†è¿™ä¸ªOioEventLoopGroupçš„registeræ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">register</span><span class="params">(Channel channel)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (channel == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"channel"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        EventLoop l = nextChild();</div><div class="line">        <span class="comment">// å°†channelåŒ…è£…äº†ä¸€ä¸‹--&gt; DefaultChannelPromise</span></div><div class="line">        <span class="keyword">return</span> l.register(<span class="keyword">new</span> DefaultChannelPromise(channel, l));</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FailedChannelFuture(channel, GlobalEventExecutor.INSTANCE, t);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªChannelå°±æ˜¯OioServerSocketChannelï¼Œå¯¹åº”åœ¨OIOåŸç”ŸAPIä¸­å°±æ˜¯ServerSocketã€‚æ ¹æ®ä»£ç çš„å­—é¢æ„å¯ä»¥è¿™æ ·è§£é‡Šï¼šå°†OioServerSocketChannelæ³¨å†Œåˆ°EventLoopGroupã€‚</p>
<p>æœ€ç»ˆæ˜¯é€šè¿‡EventLoopå»æ³¨å†Œçš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> EventLoop <span class="title">nextChild</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (shuttingDown) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(<span class="string">"shutting down"</span>);</div><div class="line">    &#125;</div><div class="line">	 <span class="comment">// ä»ç©ºé—²é˜Ÿåˆ—ä¸­å–EventLoop</span></div><div class="line">    EventLoop loop = idleChildren.poll();</div><div class="line">    <span class="keyword">if</span> (loop == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (maxChannels &gt; <span class="number">0</span> &amp;&amp; activeChildren.size() &gt;= maxChannels) &#123;</div><div class="line">            <span class="keyword">throw</span> tooManyChannels;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// æ²¡æœ‰å°±æ–°å»ºä¸€ä¸ª å‚æ•°æ²¡ç”¨</span></div><div class="line">        loop = newChild(childArgs);</div><div class="line">        loop.terminationFuture().addListener(childTerminationListener);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// æ–°å»ºçš„æ”¾åˆ°æ´»è·ƒé˜Ÿåˆ—ä¸­</span></div><div class="line">    activeChildren.add(loop);</div><div class="line">    <span class="keyword">return</span> loop;</div><div class="line">&#125;</div><div class="line"><span class="comment">// æ–°å»ºçš„ä¸€ä¸ªEventLoopä¸ºThreadPerChannelEventLoopå®ä¾‹ï¼Œå‚æ•°ä¸ºEventLoopGroup ä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªEventLoopè¯´ç”±å“ªä¸ªgroupäº§ç”Ÿçš„</span></div><div class="line"><span class="function"><span class="keyword">protected</span> EventLoop <span class="title">newChild</span><span class="params">(@SuppressWarnings(<span class="string">"UnusedParameters"</span>)</span> Object... args) <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ThreadPerChannelEventLoop(<span class="keyword">this</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¹ˆä¸€æ¥ï¼ŒçœŸæ­£çš„æ³¨å†Œé€»è¾‘å°±äº¤ç»™äº†ThreadPerChannelEventLoopå»å®ç°äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPerChannelEventLoop</span><span class="params">(ThreadPerChannelEventLoopGroup parent)</span> </span>&#123;</div><div class="line">	 <span class="comment">// æ³¨æ„ è¿™é‡Œçš„parent.executorä¸ºThreadPerTaskExecutorå®ä¾‹</span></div><div class="line">    <span class="keyword">super</span>(parent, parent.executor, <span class="keyword">true</span>);</div><div class="line">    <span class="keyword">this</span>.parent = parent;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">register</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.register(promise).addListener(<span class="keyword">new</span> ChannelFutureListener() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">            <span class="keyword">if</span> (future.isSuccess()) &#123;</div><div class="line">                ch = future.channel();</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                deregister();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"><span class="comment">// çˆ¶ç±»çš„</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">register</span><span class="params">(<span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">    ObjectUtil.checkNotNull(promise, <span class="string">"promise"</span>);</div><div class="line">    promise.channel().unsafe().register(<span class="keyword">this</span>, promise);</div><div class="line">    <span class="keyword">return</span> promise;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç»ˆäºè¦çœ‹åˆ°å¸Œæœ›äº†ï¼Œè¿™ä¸€å±‚ä¸€å±‚çš„è°ƒç”¨å®åœ¨å¾ˆç¹çï¼Œä¼šæŠŠäººçœ‹æ™•ï¼Œå»ºè®®å¤šçœ‹å‡ éå°±ä¸æ™•äº†ğŸ˜‚ã€‚</p>
<p>promise.channel()è¿”å›çš„å°±æ˜¯æˆ‘ä»¬è®¾ç½®çš„OioServerSocketChannelã€‚è€Œunsafeæ–¹æ³•åˆ™æ˜¯ç»§æ‰¿è‡ªå®ƒçš„ã€Œå¤ªçˆ·çˆ·ã€ã€‚<br>å…¶å…·ä½“å®ç°åˆ™æ˜¯ç”±å®ƒã€Œçˆ·çˆ·ã€æ¥å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> AbstractUnsafe <span class="title">newUnsafe</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultOioUnsafe();</div><div class="line">&#125;</div><div class="line"><span class="comment">// è¿™æ˜¯å®ƒçš„ä¸€ä¸ªå†…éƒ¨ç±»</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultOioUnsafe</span> <span class="keyword">extends</span> <span class="title">AbstractUnsafe</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(</span></span></div><div class="line">            <span class="keyword">final</span> SocketAddress remoteAddress,</div><div class="line">            <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise) &#123;</div><div class="line">        <span class="keyword">if</span> (!promise.setUncancellable() || !ensureOpen(promise)) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">boolean</span> wasActive = isActive();</div><div class="line">            doConnect(remoteAddress, localAddress);</div><div class="line"></div><div class="line">            <span class="comment">// Get the state as trySuccess() may trigger an ChannelFutureListener that will close the Channel.</span></div><div class="line">            <span class="comment">// We still need to ensure we call fireChannelActive() in this case.</span></div><div class="line">            <span class="keyword">boolean</span> active = isActive();</div><div class="line"></div><div class="line">            safeSetSuccess(promise);</div><div class="line">            <span class="keyword">if</span> (!wasActive &amp;&amp; active) &#123;</div><div class="line">                pipeline().fireChannelActive();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            safeSetFailure(promise, annotateConnectException(t, remoteAddress));</div><div class="line">            closeIfClosed();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è™½ç„¶å¿«çœ‹åˆ°å¸Œæœ›çš„æ›™å…‰äº†ï¼Œä½†æ˜¯çœ¼å‰å´ä¾æ—§æ˜¯ä¸€ç‰‡é»‘æš—ã€‚ğŸ˜«ï¼ï¼ï¼äº²çˆ±çš„registerä½ åˆ°åº•åœ¨å“ªé‡Œï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// AbstractUnsafe ä¹Ÿæ˜¯å†…éƒ¨ç±» tmd nettyçœŸä¼šæŠ˜è…¾</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(EventLoop eventLoop, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (eventLoop == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"eventLoop"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (isRegistered()) &#123;</div><div class="line">        promise.setFailure(<span class="keyword">new</span> IllegalStateException(<span class="string">"registered to an event loop already"</span>));</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!isCompatible(eventLoop)) &#123;</div><div class="line">        promise.setFailure(</div><div class="line">                <span class="keyword">new</span> IllegalStateException(<span class="string">"incompatible event loop type: "</span> + eventLoop.getClass().getName()));</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    AbstractChannel.<span class="keyword">this</span>.eventLoop = eventLoop;</div><div class="line">	 <span class="comment">// å…³é”®ç‚¹ å…¶ä»–ä¸ç®¡ è¿™é‡Œä¸€å®šæ˜¯æœ€åä¸€æ­¥äº†</span></div><div class="line">    <span class="keyword">if</span> (eventLoop.inEventLoop()) &#123;</div><div class="line">        register0(promise);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">        	  <span class="comment">// è¿™é‡Œå¤§æœ‰ç„æœº</span></div><div class="line">            eventLoop.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    register0(promise);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            logger.warn(</div><div class="line">                    <span class="string">"Force-closing a channel whose registration task was not accepted by an event loop: &#123;&#125;"</span>,</div><div class="line">                    AbstractChannel.<span class="keyword">this</span>, t);</div><div class="line">            closeForcibly();</div><div class="line">            closeFuture.setClosed();</div><div class="line">            safeSetFailure(promise, t);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// è¿™æ®µä»£ç çœ‹ä¸æ‡‚ å…ˆæ”¾è¿™ä¸ªåœ°æ–¹ çœ‹æ‡‚äº†å†æ¥è§£è¯»</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">register0</span><span class="params">(ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// check if the channel is still open as it could be closed in the mean time when the register</span></div><div class="line">        <span class="comment">// call was outside of the eventLoop</span></div><div class="line">        <span class="keyword">if</span> (!promise.setUncancellable() || !ensureOpen(promise)) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">boolean</span> firstRegistration = neverRegistered;</div><div class="line">        <span class="comment">// OIOç‰ˆæœ¬ä¸­ä»€ä¹ˆéƒ½ä¸åš</span></div><div class="line">        doRegister();</div><div class="line">        neverRegistered = <span class="keyword">false</span>;</div><div class="line">        registered = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="comment">// Ensure we call handlerAdded(...) before we actually notify the promise. This is needed as the</span></div><div class="line">        <span class="comment">// user may already fire events through the pipeline in the ChannelFutureListener.</span></div><div class="line">        pipeline.invokeHandlerAddedIfNeeded();</div><div class="line"></div><div class="line">        safeSetSuccess(promise);</div><div class="line">        pipeline.fireChannelRegistered();</div><div class="line">        <span class="comment">// Only fire a channelActive if the channel has never been registered. This prevents firing</span></div><div class="line">        <span class="comment">// multiple channel actives if the channel is deregistered and re-registered.</span></div><div class="line">        <span class="keyword">if</span> (isActive()) &#123;</div><div class="line">            <span class="keyword">if</span> (firstRegistration) &#123;</div><div class="line">                pipeline.fireChannelActive();</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (config().isAutoRead()) &#123;</div><div class="line">                <span class="comment">// This channel was registered before and autoRead() is set. This means we need to begin read</span></div><div class="line">                <span class="comment">// again so that we process inbound data.</span></div><div class="line">                <span class="comment">//</span></div><div class="line">                <span class="comment">// See https://github.com/netty/netty/issues/4805</span></div><div class="line">                beginRead();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        <span class="comment">// Close the channel directly to avoid FD leak.</span></div><div class="line">        closeForcibly();</div><div class="line">        closeFuture.setClosed();</div><div class="line">        safeSetFailure(promise, t);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>eventLoop.executeæ–¹æ³•ä¸­ä¸ä»…ä»…åªæ‰§è¡Œä¸€ä¸ªRunnableå°±å®Œäº†ï¼Œå› ä¸ºNettyè¿™ä¸ªç‹—é€¼æ²¡æœ‰ä½¿ç”¨é»˜è®¤å®ç° è€Œæ˜¯è‡ªå·±å®ç°çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// SingleThreadEventExecutorçš„å®ç°</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Runnable task)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"task"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> inEventLoop = inEventLoop();</div><div class="line">    <span class="comment">// è¿™ä¸ªtaskå°±æ˜¯register0çš„å…·ä½“é€»è¾‘ è¿™ä¸ªé€»è¾‘æš‚æ—¶ä¸ç®¡ï¼ˆå› ä¸ºçœ‹ä¸æ‡‚ğŸ˜‚ï¼‰</span></div><div class="line">    <span class="keyword">if</span> (inEventLoop) &#123;</div><div class="line">    	  <span class="comment">// æ”¾åˆ°é˜Ÿåˆ—ä¸­</span></div><div class="line">        addTask(task);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">    	 <span class="comment">// ç»ˆäºéœ²å‡ºé©¬è„šäº† å¼€çº¿ç¨‹äº†å§</span></div><div class="line">        startThread();</div><div class="line">        addTask(task);</div><div class="line">        <span class="keyword">if</span> (isShutdown() &amp;&amp; removeTask(task)) &#123;</div><div class="line">            reject();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!addTaskWakesUp &amp;&amp; wakesUpForTask(task)) &#123;</div><div class="line">        wakeup(inEventLoop);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// å¼€ä¸ªçº¿ç¨‹éƒ½ç©è¿™ä¹ˆèŠ±</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startThread</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (state == ST_NOT_STARTED) &#123;</div><div class="line">        <span class="keyword">if</span> (STATE_UPDATER.compareAndSet(<span class="keyword">this</span>, ST_NOT_STARTED, ST_STARTED)) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                doStartThread();</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable cause) &#123;</div><div class="line">                STATE_UPDATER.set(<span class="keyword">this</span>, ST_NOT_STARTED);</div><div class="line">                PlatformDependent.throwException(cause);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doStartThread</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">assert</span> thread == <span class="keyword">null</span>;</div><div class="line">    <span class="comment">// è¿™ä¸ªexecutorå°±æ˜¯ThreadPerTaskExecutor </span></div><div class="line">    executor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            thread = Thread.currentThread();</div><div class="line">            <span class="keyword">if</span> (interrupted) &#123;</div><div class="line">                thread.interrupt();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</div><div class="line">            updateLastExecutionTime();</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">            		<span class="comment">// è¿™ä¸ªç‹—é€¼ç©çš„æ˜¯çœŸèŠ± è¿˜å»è°ƒåˆ«äººçš„run å®é™…ä¸Šæ˜¯ThreadPerChannelEventLoopçš„å®ç°</span></div><div class="line">                SingleThreadEventExecutor.<span class="keyword">this</span>.run();</div><div class="line">                success = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">                logger.warn(<span class="string">"Unexpected exception from an event executor: "</span>, t);</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            	<span class="comment">// å¤ªå¤š ä¸çœ‹äº†          </span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// ThreadPerChannelEventLoop</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">	 <span class="comment">// æ­»å¾ªç¯</span></div><div class="line">    <span class="keyword">for</span> (;;) &#123;</div><div class="line">    	 <span class="comment">// è¿™é‡Œçš„taskå°±æ˜¯AbstractUnsafe#register0çš„é€»è¾‘ å½“ç„¶ä¹Ÿæœ‰å¯èƒ½æ˜¯å…¶ä»–çš„</span></div><div class="line">        Runnable task = takeTask();</div><div class="line">        <span class="keyword">if</span> (task != <span class="keyword">null</span>) &#123;</div><div class="line">            task.run();</div><div class="line">            updateLastExecutionTime();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Channel ch = <span class="keyword">this</span>.ch;</div><div class="line">        <span class="keyword">if</span> (isShuttingDown()) &#123;</div><div class="line">            <span class="keyword">if</span> (ch != <span class="keyword">null</span>) &#123;</div><div class="line">                ch.unsafe().close(ch.unsafe().voidPromise());</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (confirmShutdown()) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (ch != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// Handle deregistration</span></div><div class="line">                <span class="keyword">if</span> (!ch.isRegistered()) &#123;</div><div class="line">                    runAllTasks();</div><div class="line">                    deregister();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ•´äº†è¿™ä¹ˆå¤šï¼Œä¾æ—§æ²¡æœ‰ææ˜ç™½è¿™ä¸ªregisteråˆ°åº•åœ¨åšä»€ä¹ˆã€‚ä½†æ˜¯æ˜ç™½äº†ä¸€ä»¶äº‹ï¼šæ‰¾åˆ°äº†å¯åŠ¨å…¥å£ã€‚</p>
<h3 id="æ³¨å†Œé€»è¾‘"><a href="#æ³¨å†Œé€»è¾‘" class="headerlink" title="æ³¨å†Œé€»è¾‘"></a>æ³¨å†Œé€»è¾‘</h3><p>åœ¨åŸç”ŸOIOç½‘ç»œç¼–ç¨‹ä¸­ï¼Œå®ç°ä¸€ä¸ªæœåŠ¡å™¨éœ€è¦åšè¿™å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li>åˆ›å»ºServerSocketå¯¹è±¡ç»‘å®šç›‘å¬ç«¯å£ã€‚</li>
<li>é€šè¿‡accept()æ–¹æ³•ç›‘å¬å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</li>
<li>å»ºç«‹è¿æ¥åï¼Œé€šè¿‡è¾“å…¥è¾“å‡ºæµè¯»å–å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚ä¿¡æ¯ã€‚</li>
<li>é€šè¿‡è¾“å‡ºæµå‘å®¢æˆ·ç«¯å‘é€è¯·æ±‚ä¿¡æ¯ã€‚</li>
<li>å…³é—­ç›¸å…³èµ„æºã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>&#123;</div><div class="line">    ServerSocket server=<span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span>&#123;</div><div class="line">        server=<span class="keyword">new</span> ServerSocket(<span class="number">5209</span>);</div><div class="line">        <span class="comment">//b)æŒ‡å®šç»‘å®šçš„ç«¯å£ï¼Œå¹¶ç›‘å¬æ­¤ç«¯å£ã€‚</span></div><div class="line">        System.out.println(<span class="string">"æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ"</span>);</div><div class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªServerSocketåœ¨ç«¯å£5209ç›‘å¬å®¢æˆ·è¯·æ±‚</span></div><div class="line">    &#125;<span class="keyword">catch</span>(Exception e) &#123;</div><div class="line">            System.out.println(<span class="string">"æ²¡æœ‰å¯åŠ¨ç›‘å¬ï¼š"</span>+e);</div><div class="line">            <span class="comment">//å‡ºé”™ï¼Œæ‰“å°å‡ºé”™ä¿¡æ¯</span></div><div class="line">    &#125;</div><div class="line">    Socket socket=<span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span>&#123;</div><div class="line">        socket=server.accept();</div><div class="line">        <span class="comment">//2ã€è°ƒç”¨accept()æ–¹æ³•å¼€å§‹ç›‘å¬ï¼Œç­‰å¾…å®¢æˆ·ç«¯çš„è¿æ¥ </span></div><div class="line">        <span class="comment">//ä½¿ç”¨accept()é˜»å¡ç­‰å¾…å®¢æˆ·è¯·æ±‚ï¼Œæœ‰å®¢æˆ·</span></div><div class="line">        <span class="comment">//è¯·æ±‚åˆ°æ¥åˆ™äº§ç”Ÿä¸€ä¸ªSocketå¯¹è±¡ï¼Œå¹¶ç»§ç»­æ‰§è¡Œ</span></div><div class="line">    &#125;<span class="keyword">catch</span>(Exception e) &#123;</div><div class="line">        System.out.println(<span class="string">"Error."</span>+e);</div><div class="line">        <span class="comment">//å‡ºé”™ï¼Œæ‰“å°å‡ºé”™ä¿¡æ¯</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>åœ¨Nettyä¸­çš„å®ç°åŸºæœ¬å¦‚æ­¤ï¼Œåªä¸è¿‡ä»£ç ç»“æ„æ¯”è¾ƒå¤æ‚ç½¢äº†ã€‚è¿™æ®µä»£ç åœ¨Nettyä¸­çš„çš„å®ç°åœ¨OioServerSocketChannelä¸­ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBind</span><span class="params">(SocketAddress localAddress)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    socket.bind(localAddress, config.getBacklog());</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doReadMessages</span><span class="params">(List&lt;Object&gt; buf)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (socket.isClosed()) &#123;</div><div class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Socket s = socket.accept();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            buf.add(<span class="keyword">new</span> OioSocketChannel(<span class="keyword">this</span>, s));</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            logger.warn(<span class="string">"Failed to create a new channel from an accepted socket."</span>, t);</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                s.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable t2) &#123;</div><div class="line">                logger.warn(<span class="string">"Failed to close a socket."</span>, t2);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (SocketTimeoutException e) &#123;</div><div class="line">        <span class="comment">// Expected</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…ˆç»‘å®šç«¯å£ï¼Œå†æ¥å—è¿æ¥ã€‚è¿™ä¸ªæ¥å—è¿æ¥æ˜¯ä¼ªéé˜»å¡çš„ã€‚å› ä¸ºç”¨äºè¿æ¥çš„çº¿ç¨‹åªæœ‰ä¸€ä¸ªï¼Œæ²¡æœ‰å®¢æˆ·ç«¯è¿è¿›æ¥çš„æ—¶å€™ä¸èƒ½å°†å…¶é˜»å¡è°ƒã€‚å®¢æˆ·ç«¯è¿è¿›æ¥äº†å°±å°†è¿™ä¸ªã€Œè¿æ¥ã€äº¤ç»™åˆ«çš„çº¿ç¨‹å¤„ç†ï¼Œæ¯ä¸ªè¿æ¥å¯¹åº”ä¸€ä¸ªçº¿ç¨‹ã€‚è¿™æ ·å°±åšåˆ°äº†è¿æ¥å’Œioå¤„ç†ä¸å†²çªã€‚</p>
<p>å½“ç„¶ï¼Œæœ€åçš„æ‰§è¡Œè‚¯å®šæ˜¯åˆ°è¿™ä¸€æ­¥ï¼Œä½†æ˜¯å…·ä½“çš„æ‰§è¡Œè°ƒç”¨è¿‡ç¨‹å¯ç§°å¾—ä¸Šå›°éš¾é‡é‡ã€‚ä»”ç»†å›å¤´çœ‹è¿™ä¸ªregister0çš„å¤„ç†é€»è¾‘ï¼Œå‘ç°å¥½åƒä»…ä»…å¯åŠ¨äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œç”¨äºä¸æ–­ä»é˜Ÿåˆ—ä¸­å–ä»»åŠ¡æ‰§è¡Œçš„æ­»å¾ªç¯è€Œå·²ã€‚ä¼¼ä¹æ²¡æœ‰ç›´æ¥è¡¨ç°å‡ºåƒç»‘å®šç«¯å£ï¼Œæ¥å—è¿æ¥çš„è¿¹è±¡ã€‚ä¸èƒ½æ…Œï¼Œè¿™ä¸ªè€béšè—å¾—å¾ˆæ·±ã€‚å›åˆ°æœ€å¼€å§‹çš„åœ°æ–¹ï¼Œè¿™ä¸ªä»…ä»…æ˜¯registerï¼Œå§‘ä¸”å°±åˆ°è¿™é‡Œï¼Œå…ˆç»§ç»­å¾€ä¸‹çœ‹ï¼Œçœ‹åˆ°åº•åˆæœ‰ä»€ä¹ˆæ–°å‘ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> ChannelFuture <span class="title">doBind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> ChannelFuture regFuture = initAndRegister();</div><div class="line">    <span class="keyword">final</span> Channel channel = regFuture.channel();</div><div class="line">    <span class="keyword">if</span> (regFuture.cause() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> regFuture;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (regFuture.isDone()) &#123;</div><div class="line">        <span class="comment">// At this point we know that the registration was complete and successful.</span></div><div class="line">        ChannelPromise promise = channel.newPromise();</div><div class="line">        doBind0(regFuture, channel, localAddress, promise);</div><div class="line">        <span class="keyword">return</span> promise;</div><div class="line">    &#125; </div><div class="line">    <span class="comment">// çœç•¥ã€‚ã€‚ã€‚</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>initAndRegisteræ–¹æ³•ç»å†åƒå±±ä¸‡æ°´ç»ˆäºå¯åŠ¨äº†ä¸€ä¸ªçº¿ç¨‹ï¼Œç›®çš„å°±æ˜¯è¿”å›ä¸€ä¸ªChannelFutureï¼Œå…ˆä¸ç®¡è¿™ä¸ªChannelFutureåˆ°åº•æ˜¯ä»€ä¹ˆé¬¼ï¼Œå…ˆå°†å…¶ç†è§£ä¸ºJDKä¸­çš„Futureçš„å¢å¼ºå®ç°ã€‚ä¸€æ—¦è¿™ä¸ªFutureå®Œæˆäº†ï¼Œè°ƒç”¨doBind0:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doBind0</span><span class="params">(</span></span></div><div class="line">            <span class="keyword">final</span> ChannelFuture regFuture, <span class="keyword">final</span> Channel channel,</div><div class="line">            <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise) &#123;</div><div class="line">    <span class="comment">// This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up</span></div><div class="line">    <span class="comment">// the pipeline in its channelRegistered() implementation.</span></div><div class="line">    channel.eventLoop().execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (regFuture.isSuccess()) &#123;</div><div class="line">                channel.bind(localAddress, promise).addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                promise.setFailure(regFuture.cause());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœ‹åˆ°äº†å§ï¼Œè¿™ä¸ªé¬¼åˆå‘é˜Ÿåˆ—ä¸­æ·»åŠ äº†ä¸€ä¸ªä»»åŠ¡ã€‚è¿™ä¸ªä»»åŠ¡æ ¸å¿ƒå°±æ˜¯å»ç»‘å®šã€‚æƒ³éƒ½ä¸ç”¨æƒ³ï¼Œè¿™ä¸ªç»‘å®šä¸€å®šæ˜¯AbstractChannelä¸­çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> pipeline.bind(localAddress, promise);</div><div class="line">&#125;</div><div class="line"><span class="comment">// pipelineçš„bindæœ‰æ˜¯å…¶é»˜è®¤å®ç°ç±»ä¸­çš„å­ç±»TailContextä¸­çš„å®ç°</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> tail.bind(localAddress, promise);</div><div class="line">&#125;</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="comment">// çœç•¥ã€‚ã€‚ã€‚</span></div><div class="line">    <span class="keyword">final</span> AbstractChannelHandlerContext next = findContextOutbound();</div><div class="line">    EventExecutor executor = next.executor();</div><div class="line">    <span class="keyword">if</span> (executor.inEventLoop()) &#123;</div><div class="line">        next.invokeBind(localAddress, promise);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        safeExecute(executor, <span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                next.invokeBind(localAddress, promise);</div><div class="line">            &#125;</div><div class="line">        &#125;, promise, <span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> promise;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€åçš„bindæ˜¯æœ€ç»ˆçš„æ ¸å¿ƒé€»è¾‘ã€‚å…ˆæ‰¾OutboundContextï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> AbstractChannelHandlerContext <span class="title">findContextOutbound</span><span class="params">()</span> </span>&#123;</div><div class="line">    AbstractChannelHandlerContext ctx = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        ctx = ctx.prev;</div><div class="line">    &#125; <span class="keyword">while</span> (!ctx.outbound);</div><div class="line">    <span class="keyword">return</span> ctx;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ˜¯tailï¼Œå…³äºpipelineçš„ç»“æ„æœ‰å¿…è¦äº†è§£ä¸€ä¸‹ã€‚<img src="https://segmentfault.com/img/bVEPxn?w=2387&amp;h=584" alt="image"></p>
<p>æˆ‘ä»¬åœ¨è¿™ä¸ªServeråˆå§‹åŒ–çš„æ—¶å€™æ·»åŠ äº†handlerï¼Œæ¯”å¦‚LoggingHandlerç­‰ã€‚è¿™äº›handleréƒ½ä¼šè¢«æ·»åŠ åˆ°tailå’Œheadä¹‹é—´ã€‚å³ä½¿ä½ ä¸æ·»åŠ ä»»ä½•handlerï¼Œnettyä¹Ÿä¼šæŠŠè‡ªå·±å†…éƒ¨çš„handleræ·»åŠ è¿›å»ã€‚handleråˆåˆ†ä¸ºinå’Œoutï¼Œåˆ†åˆ«ä»£è¡¨å…¥ç«™å’Œå‡ºç«™ã€‚è¿™æ®µä»£ç å°±æ˜¯æ‰¾å‡ºç«™çš„(åªæœ‰outçš„æ‰æœ‰bindæ–¹æ³•)ï¼Œä¸€ç›´å‘headæ–¹å‘æ‰¾ï¼ˆåºŸè¯ï¼Œè‡ªå·±éƒ½æ˜¯tailäº†åªèƒ½å¾€å‰æ‰¾ï¼Œåé¢æ²¡æœ‰äº†ï¼‰ã€‚æ‰¾åˆ°ä¸€ä¸ªå°±ç®—æ•°ï¼Œç›´æ¥è¿”å›è¿™ä¸ªcontextã€‚æ¥ç€å°±æ˜¯è°ƒç”¨invokeBindæ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeBind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (invokeHandler()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ((ChannelOutboundHandler) handler()).bind(<span class="keyword">this</span>, localAddress, promise);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            notifyOutboundHandlerException(t, promise);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        bind(localAddress, promise);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆçš„bindæ–¹æ³•åœ¨ifåˆ†æ”¯ä¸­ã€‚å…·ä½“çš„æ‰§è¡Œé€»è¾‘ä¸ºå®ç°äº†outçš„handlerï¼Œä¾‹å¦‚LoggingHandlerï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) &#123;</div><div class="line">        logger.log(internalLevel, format(ctx, <span class="string">"BIND"</span>, localAddress));</div><div class="line">    &#125;</div><div class="line">    ctx.bind(localAddress, promise);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ˜¾ç„¶è¿™ä¸ªhandlerä»…ä»…åªæ˜¯æ¥æ‰“å°logçš„ï¼Œå®Œäº‹ä¹‹ååˆäº¤ç»™çˆ¶ç±»å»æ‰§è¡Œã€‚è€Œçˆ¶ç±»ä¾ç„¶æ˜¯é‚£æ®µã€‚å› ä¸ºä¹‹å‰æ˜¯æ‰¾åˆ°ç¬¬ä¸€ä¸ªå®ç°outçš„handlerå°±ç®—æ•°ï¼Œè¿™é‡Œåˆå›åˆ°äº†è¿™ä¸ªpipelineä¸­ï¼Œç»§ç»­å¾€å‰æ‰¾ï¼Œæœ€ç»ˆä¼šæ‰¾åˆ°headï¼ˆheadä¸ä»…æ˜¯outè€Œä¸”è¿˜æ˜¯inï¼Œå°±æ˜¯è¿™ä¹ˆå±Œï¼‰ã€‚æœ€ç»ˆè°ƒç”¨çš„æ˜¯headcontextä¸­çš„bindï¼Œè€Œå®ƒçš„bindå´æ˜¯ä½¿ç”¨çš„æ˜¯unsafeçš„bindï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(</span></span></div><div class="line">        ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</div><div class="line">        <span class="keyword">throws</span> Exception &#123;</div><div class="line">    unsafe.bind(localAddress, promise);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>&#123;</div><div class="line">    assertEventLoop();</div><div class="line">    <span class="keyword">if</span> (!promise.setUncancellable() || !ensureOpen(promise)) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// See: https://github.com/netty/netty/issues/576</span></div><div class="line">    <span class="keyword">if</span> (Boolean.TRUE.equals(config().getOption(ChannelOption.SO_BROADCAST)) &amp;&amp;</div><div class="line">        localAddress <span class="keyword">instanceof</span> InetSocketAddress &amp;&amp;</div><div class="line">        !((InetSocketAddress) localAddress).getAddress().isAnyLocalAddress() &amp;&amp;</div><div class="line">        !PlatformDependent.isWindows() &amp;&amp; !PlatformDependent.maybeSuperUser()) &#123;</div><div class="line">        <span class="comment">// Warn a user about the fact that a non-root user can't receive a</span></div><div class="line">        <span class="comment">// broadcast packet on *nix if the socket is bound on non-wildcard address.</span></div><div class="line">        logger.warn(</div><div class="line">                <span class="string">"A non-root user can't receive a broadcast packet if the socket "</span> +</div><div class="line">                <span class="string">"is not bound to a wildcard address; binding to a non-wildcard "</span> +</div><div class="line">                <span class="string">"address ("</span> + localAddress + <span class="string">") anyway as requested."</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// è¿™ä¸ªé€»è¾‘æ˜¯æœ‰æ„æ€çš„ è¿”å›å€¼ä¸º !socket.isClosed()&amp;&amp; socket.isBound()</span></div><div class="line">    <span class="comment">// æ²¡å…³ä¸”ç»‘å®šäº†æ‰ä¸ºtrue è¿™é‡Œä¸€å®šä¸ºfalse å› ä¸ºè‚¯å®šæ²¡ç»‘å®š</span></div><div class="line">    <span class="keyword">boolean</span> wasActive = isActive();</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">    	 <span class="comment">// çœ‹åˆ°è¿™è¡Œä»£ç å°±å¤Ÿäº† å…¶ä»–ä¸ç®¡</span></div><div class="line">        doBind(localAddress);</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        safeSetFailure(promise, t);</div><div class="line">        closeIfClosed();</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">	 <span class="comment">// ç»‘å®šå®Œäº†isActive()è‚¯å®šä¸ºtrue</span></div><div class="line">    <span class="keyword">if</span> (!wasActive &amp;&amp; isActive()) &#123;</div><div class="line">        <span class="comment">// è¿™æ®µä»£ç ä¹Ÿå¾—çœ‹</span></div><div class="line">        invokeLater(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                pipeline.fireChannelActive();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    safeSetSuccess(promise);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœ‹åˆ°doBindå°±çŸ¥é“æ€ä¹ˆå›äº‹äº†ï¼Œè¿™å°±æ˜¯ä¹‹å‰æ‰€è¯´çš„OioServerSocketChannelçš„doBindã€‚ç»ˆäºå®Œæˆäº†ç¬¬ä¸€æ­¥ï¼šç»‘å®šç«¯å£ã€‚<br>æ¥ä¸‹æ¥å°±æ˜¯ç›‘å¬å®¢æˆ·ç«¯è¿æ¥ï¼Œåœ¨invokeLaterä¸­å°†å…¶å®ç°äº†ï¼Œä¸€æ¢ç©¶ç«Ÿï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeLater</span><span class="params">(Runnable task)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        eventLoop().execute(task);</div><div class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException e) &#123;</div><div class="line">        logger.warn(<span class="string">"Can't invoke task later as EventLoop rejected it"</span>, e);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœç„¶ï¼Œä¾æ—§æŠŠè¿™ä¸ªä»»åŠ¡æ”¾åˆ°çº¿ç¨‹ä¸­å»æ‰§è¡Œäº†ã€‚è¿™ä¸ªä»»åŠ¡åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œå¾ˆé‡è¦ã€‚ä»£ç ä¸­åªç»™äº†ä¸€æ®µ<code>pipeline.fireChannelActive()</code>.çœ‹çœ‹å…·ä½“å®ç°å§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">fireChannelActive</span><span class="params">()</span> </span>&#123;</div><div class="line">    AbstractChannelHandlerContext.invokeChannelActive(head);</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// contextä¸ºhead åˆäº¤ç»™äº†EventExecutorå»æ‰§è¡Œ</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeChannelActive</span><span class="params">(<span class="keyword">final</span> AbstractChannelHandlerContext next)</span> </span>&#123;</div><div class="line">    EventExecutor executor = next.executor();</div><div class="line">    <span class="keyword">if</span> (executor.inEventLoop()) &#123;</div><div class="line">        next.invokeChannelActive();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        executor.execute(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                next.invokeChannelActive();</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// è°ƒç”¨çš„æ˜¯headçš„å®ç°</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeChannelActive</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (invokeHandler()) &#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            ((ChannelInboundHandler) handler()).channelActive(<span class="keyword">this</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">            notifyHandlerException(t);</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        fireChannelActive();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// headçš„channelActive è¿™é‡Œçš„å¥—è·¯å’Œä¹‹å‰çš„ä¸€æ ·ï¼Œå…ˆè°ƒç”¨çˆ¶ç±»çš„ ç»§ç»­æ‰¾pipelineä¸­çš„handleråªä¸è¿‡æ–¹å‘ç›¸åï¼ˆä»headåˆ°tailï¼‰ ä¾æ¬¡ç±»æ¨ å¦‚æœæŸä¸ªhandlerä¸å»è°ƒç”¨ctxäº†ï¼Œé‚£ä¹ˆäº‹ä»¶å°±åˆ°æ­¤ä¸ºæ­¢ä¸ä¼šä¼ é€’ä¸‹å»äº†</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    ctx.fireChannelActive();</div><div class="line">	 <span class="comment">// è¿™æ®µä»£ç æ˜¯é‡ç‚¹</span></div><div class="line">    readIfIsAutoRead();</div><div class="line">&#125;</div><div class="line"><span class="comment">// çˆ¶ç±»çš„fireChannelActive</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelHandlerContext <span class="title">fireChannelActive</span><span class="params">()</span> </span>&#123;</div><div class="line">    invokeChannelActive(findContextInbound());</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆï¼Œä¸€å®šä¸€å®šæ˜¯è¦åšæˆ‘ä»¬åœ¨OIOåŸç”Ÿç¼–ç¨‹ä¸­çš„ç¬¬äºŒæ­¥äº†ï¼šæ¥å—è¿æ¥äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readIfIsAutoRead</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (channel.config().isAutoRead()) &#123;</div><div class="line">        channel.read();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// OioSocketChannelçš„read å®é™…ä¸Šæ˜¯çˆ¶ç±»çš„</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Channel <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line">    pipeline.read();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// è°ƒç”¨çš„æ˜¯pipelineçš„read</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line">    tail.read();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div><div class="line"><span class="comment">// tailçš„read</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> ChannelHandlerContext <span class="title">read</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> AbstractChannelHandlerContext next = findContextOutbound();</div><div class="line">    EventExecutor executor = next.executor();</div><div class="line">    <span class="keyword">if</span> (executor.inEventLoop()) &#123;</div><div class="line">        next.invokeRead();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Runnable task = next.invokeReadTask;</div><div class="line">        <span class="keyword">if</span> (task == <span class="keyword">null</span>) &#123;</div><div class="line">            next.invokeReadTask = task = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                    next.invokeRead();</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">        &#125;</div><div class="line">        executor.execute(task);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœ‹åˆ°è¿™é‡Œæˆ‘åˆæ‰“è„¸äº†ï¼Œè¿˜æœ‰è¿™ä¹ˆå¤šå±‚çš„è°ƒç”¨ï¼ä½†æ˜¯ä¸è¦æ…Œï¼Œå› ä¸ºé€»è¾‘æ˜¯ç±»ä¼¼çš„ã€‚éƒ½æ˜¯åœ¨pipelineè¿™æ¡é“¾ä¸Šæ‰¾handleræ¥è°ƒç”¨ï¼Œçˆ±è°ƒä¸è°ƒçš„æ€æƒ³ã€‚è¿™é‡Œçš„é¡ºåºæ˜¯ä»tailåˆ°headã€‚å¦‚æœè¿™ä¸ªé“¾ä¸­æœ‰å“ªä¸ªä¸é•¿çœ¼çš„æ²¡æœ‰å°†äº‹ä»¶ä¼ é€’ä¸‹å»ï¼Œé‚£ä¹ˆæœ€ç»ˆå°±åˆ°ä¸äº†headã€‚æ­£å¸¸æƒ…å†µä¸‹æ˜¯ä¸€å®šè¦åˆ°headçš„ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(ChannelHandlerContext ctx)</span> </span>&#123;</div><div class="line">    unsafe.beginRead();</div><div class="line">&#125;</div><div class="line"><span class="comment">// ä»€ä¹ˆéƒ½å¾—è€ƒunsafe</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">beginRead</span><span class="params">()</span> </span>&#123;</div><div class="line">    assertEventLoop();</div><div class="line">    <span class="keyword">if</span> (!isActive()) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        doBeginRead();</div><div class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</div><div class="line">        invokeLater(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                pipeline.fireExceptionCaught(e);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        close(voidPromise());</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// æœ€ç»ˆè¿˜æ˜¯å°†å…¶ä¸¢ç»™äº†eventLoopå»æ‰§è¡Œ readTaskæ˜¯æ ¸å¿ƒ</span></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doBeginRead</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">    <span class="keyword">if</span> (readPending) &#123;</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line">    readPending = <span class="keyword">true</span>;</div><div class="line">    eventLoop().execute(readTask);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªreadTaskå…ˆå°†å…¶å®šä¹‰å¥½äº†ï¼Œæ²¡æœ‰ç›´æ¥ä½¿ç”¨åŒ¿åå†…éƒ¨ç±»ã€‚ä¸€è‚¡æ¸…æµå•Šï¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable readTask = <span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        doRead();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªdoReadæœ‰2ä¸ªå®ç°AbstractOioByteChannelå’ŒAbstractOioMessageChannelçœ‹åå­—éƒ½èƒ½çŸ¥é“åŒºåˆ«ï¼Œä¸€ä¸ªæ˜¯è¯»å­—èŠ‚ä¸€ä¸ªæ˜¯è¯»å¯¹è±¡ã€‚æœ€å¤§çš„åŒºåˆ«æ˜¯OioByteStreamChannelæ˜¯OioSocketChannelçš„çˆ¶ç±»è€ŒAbstractOioMessageChannelæ˜¯OioServerSocketChannelçš„çˆ¶ç±»ã€‚è¿™é‡Œä½¿ç”¨çš„å®ç°ä¸ç”¨è¯´ä¹ŸçŸ¥é“äº†ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRead</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// å¤ªå¤šçœç•¥ä¸çœ‹</span></div><div class="line">    <span class="keyword">final</span> ChannelConfig config = config();</div><div class="line">    <span class="keyword">final</span> ChannelPipeline pipeline = pipeline();</div><div class="line">    <span class="keyword">final</span> RecvByteBufAllocator.Handle allocHandle = unsafe().recvBufAllocHandle();</div><div class="line">    allocHandle.reset(config);</div><div class="line">    <span class="keyword">boolean</span> closed = <span class="keyword">false</span>;</div><div class="line">    Throwable exception = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">do</span> &#123;</div><div class="line">            <span class="comment">// Perform a read. å…³é”®ç‚¹</span></div><div class="line">            <span class="keyword">int</span> localRead = doReadMessages(readBuf);</div><div class="line">            <span class="keyword">if</span> (localRead == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (localRead &lt; <span class="number">0</span>) &#123;</div><div class="line">                closed = <span class="keyword">true</span>;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            allocHandle.incMessagesRead(localRead);</div><div class="line">        &#125; <span class="keyword">while</span> (allocHandle.continueReading());</div><div class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        exception = t;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// ä¸çœ‹</span></div><div class="line">    <span class="comment">// è¿™é‡Œè¿˜çœç•¥äº†ä¸€ä¸ªå…³é”®ä»£ç  ä¸€ç›´æƒ³ä¸æ˜ç™½çš„ä¸€ä¸ªé—®é¢˜æ˜¯è¿™æ®µä»£ç æ˜¯æ€ä¹ˆèƒ½å¤Ÿä¸€åªrunä¸‹å»çš„</span></div><div class="line">    <span class="comment">// å› ä¸ºeventloopä¸­æœ‰ä¸ªæ­»å¾ªç¯ï¼Œå–çš„æ˜¯ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å»æ‰§è¡Œçš„ï¼Œå–çš„æ–¹å¼æ˜¯takeï¼Œä¹Ÿå°±æ˜¯å–å‡ºæ¥å°±ç§»é™¤æ‰</span></div><div class="line">    <span class="comment">// è€Œä¸‹é¢è¿™æ®µä»£ç åˆ™æ˜¯å°†å…¶ç»§ç»­åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œåªè¦æ²¡è¯»åˆ°æ•°æ®å°±ç»§ç»­å°†è¿™ä¸ªtaskæ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ— è¿™æ ·å°±èƒ½ä¸€ç›´æ­»å¾ªç¯ä¸‹å»</span></div><div class="line">    <span class="comment">// Reading 0 bytes could mean there is a SocketTimeout and no data was actually read, so we</span></div><div class="line">    <span class="comment">// should execute read() again because no data may have been read.</span></div><div class="line">    read();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€ç»ˆè¿™ä¸ªdoReadMessageså°±æ˜¯OioServerSocketChannelçš„å®ç°ã€‚å°†ç›‘å¬å®¢æˆ·ç«¯è¿æ¥ä¹Ÿæ”¾åˆ°äº†ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè®©çº¿ç¨‹å»è½®è¯¢ã€‚è‡³äºæ€ä¹ˆå»æŠŠæ¶ˆæ¯è¯»å‡ºæ¥ä»¥åŠè¿™ä¸ªè¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Œè¿™æ˜¯ä»¥åçš„äº‹æƒ…ã€‚å› ä¸ºè¿™æ¬¡åŸºæœ¬ä¸Šå°†æ•´ä¸ªnettyçš„æ ¸å¿ƒç»„ä»¶éƒ½æ¥è§¦åˆ°äº†ã€‚æ¥ä¸‹æ¥çš„æºç è§£è¯»ä¼šç¨å¾®è½»æ¾ç‚¹ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>NettyçœŸå±Œï¼Œä¸æ¥å—åé©³ğŸ˜‚ï¼</p>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    
    <hr />
    <h3>ç•™è¨€:</h3>
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>



                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/Mr-Vincent" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2021 Mr-Vincent<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->

<script type="text/javascript">
    var disqus_shortname = 'wei-dong';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>

</html>