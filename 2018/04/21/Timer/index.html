<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!--Description-->
    
        <meta name="description" content="ä»¥æ¢¦ä¸ºé©¬ ä¸è´ŸéŸ¶å">
    

    <!--Author-->
    
        <meta name="author" content="Mr-Vincent">
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="æµ…æJDKä¸­çš„å®šæ—¶å™¨Timerå®ç°"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="ä»¥æ¢¦ä¸ºé©¬ ä¸è´ŸéŸ¶å" />
    

    <!--Open Graph Site Name-->
    <meta property="og:site_name" content="DongWei&#39;s Blog"/>

    <!--Type page-->
    
        <meta property="og:type" content="article" />
    

    <!--Page Cover-->
    

        <meta name="twitter:card" content="summary" />
    

    <!-- Title -->
    
    <title>æµ…æJDKä¸­çš„å®šæ—¶å™¨Timerå®ç° - DongWei&#39;s Blog</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css">

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet" />

    <!-- Google Analytics -->
    


    <!-- favicon -->
    
	
</head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">DongWei's Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="/">
                            
                                Home
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="/archives">
                            
                                Archives
                            
                        </a>
                    </li>
                
                    <li>
                        <a href="https://github.com/Mr-Vincent">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/images/bg.jpeg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>æµ…æJDKä¸­çš„å®šæ—¶å™¨Timerå®ç°</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2018-04-21
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           
                <div class="col-lg-4 col-lg-offset-2 col-md-5 col-md-offset-1 post-tags">
                    
                        


<a href="/tags/æºç è§£è¯»/">#æºç è§£è¯»</a> <a href="/tags/JDK/">#JDK</a>


                    
                </div>
                <div class="col-lg-4 col-md-5 post-categories">
                    
                        

<a href="/categories/JDK-SOURCE/">JDK SOURCE</a>

                    
                </div>
            

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p>åœ¨jdkä¸­å¤„ç†å®šæ—¶ä»»åŠ¡å·¥å…·ç±»ä¸­æœ‰2ç§ï¼šTimerå’ŒScheduledExecutorServiceã€‚å‰è€…æ˜¯åœ¨java.utilåŒ…ä¸­ï¼Œä»1.3ç‰ˆæœ¬å¼€å§‹ï¼Œå±äºæ¯”è¾ƒè€çš„å·¥å…·ç±»äº†ã€‚è€ŒScheduledExecutorServiceå±äºjava.util.concurrentåŒ…ï¼Œä½œè€…æ˜¯è€çˆ·å­Doug Leaï¼Œ1.5ç‰ˆæœ¬å¼€å§‹æ‰æœ‰ã€‚è™½ç„¶ç°åœ¨å¤§å¤šä½¿ç”¨ScheduledExecutorServiceï¼Œä½†æ˜¯æˆ‘è§‰å¾—å¾ˆæœ‰å¿…è¦å¯¹å…¶â€œåŒå®—â€Timerçš„å®ç°è¿›è¡Œè§£è¯»ã€‚</p>
<h4 id="ä¸¾ä¸ªæ —å­"><a href="#ä¸¾ä¸ªæ —å­" class="headerlink" title="ä¸¾ä¸ªæ —å­"></a>ä¸¾ä¸ªæ —å­</h4><p>å®˜æ–¹æ–‡æ¡£ä¸­çš„è§£é‡Šæ˜¯è¿™æ ·çš„ï¼š</p>
<blockquote>
<p>A facility for threads to schedule tasks for future execution in a background thread. Tasks may be scheduled for one-time execution, or for repeated execution at regular intervals.</p>
</blockquote>
<p>çº¿ç¨‹çš„å·¥å…·ï¼Œç”¨äºåœ¨åå°çº¿ç¨‹ä¸­å®‰æ’å°†æ¥æ‰§è¡Œçš„ä»»åŠ¡ã€‚ å¯ä»¥å®‰æ’ä¸€æ¬¡æ€§æ‰§è¡Œä»»åŠ¡ï¼Œæˆ–å®šæœŸé‡å¤æ‰§è¡Œä»»åŠ¡ã€‚</p>
<blockquote>
<p>This class is thread-safe: multiple threads can share a single Timer object without the need for external synchronization.<br>This class does not offer real-time guarantees: it schedules tasks using the Object.wait(long) method.<br>Java 5.0 introduced the java.util.concurrent package and one of the concurrency utilities therein is the ScheduledThreadPoolExecutor which is a thread pool for repeatedly executing tasks at a given rate or delay. It is effectively a more versatile replacement for the Timer/TimerTask combination, as it allows multiple service threads, accepts various time units, and doesnâ€™t require subclassing TimerTask (just implement Runnable). Configuring ScheduledThreadPoolExecutor with one thread makes it equivalent to Timer.</p>
</blockquote>
<p>è¿™ä¸ªç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†ä¸èƒ½ä¿è¯æ˜¯å®æ—¶çš„ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯waitæ–¹æ³•æ¥è°ƒåº¦ä»»åŠ¡ã€‚æ–‡æ¡£è¿˜è¯´äº†å»ºè®®ä½¿ç”¨JUCä¸‹çš„ScheduledThreadPoolExecutorï¼ˆScheduledExecutorServiceçš„å®ç°ï¼‰ç±»æ¥å¤„ç†å®šæ—¶ä»»åŠ¡ï¼Œè¿™ä¸ªç±»æä¾›çš„åŠŸèƒ½æ›´å¤šï¼Œå‚æ•°æ›´çµæ´»ï¼Œè€Œä¸”æ˜¯å¤šçº¿ç¨‹çš„ã€‚å½“çº¿ç¨‹æ± sizeæŒ‡å®šä¸ºä¸€é‚£å°±å’ŒTimerä¸€ä¸ªæ ·äº†ã€‚</p>
<p>ä¸‹é¢é€šè¿‡ä¸€ä¸ªdemoæ¥å±•ç¤ºä¸€ä¸‹ç›¸å…³apiçš„ç”¨æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkTimerDemo</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        Timer timer = <span class="keyword">new</span> Timer(<span class="string">"timer-demo"</span>);</div><div class="line">        MyTask[] tasks = <span class="keyword">new</span> MyTask[<span class="number">20</span>];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tasks.length; i++) &#123;</div><div class="line">            tasks[i] = <span class="keyword">new</span> MyTask(i);</div><div class="line">            System.out.println(<span class="string">"time no "</span> + i + <span class="string">" task start at "</span> + <span class="keyword">new</span> Date());</div><div class="line">            timer.schedule(tasks[i], <span class="number">2</span> * <span class="number">1000</span>, <span class="number">3</span> * <span class="number">1000</span>);</div><div class="line">        &#125;</div><div class="line">        System.out.println(<span class="string">"timer started at: "</span> + <span class="keyword">new</span> Date());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyTask</span> <span class="keyword">extends</span> <span class="title">TimerTask</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> timeNo;</div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyTask</span><span class="params">(<span class="keyword">int</span> timeNo)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.timeNo = timeNo;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * å¦‚æœä»»åŠ¡å‡ºç°å¼‚å¸¸ä¸è¢«æ•è·ï¼Œå…¶ä»–ä»»åŠ¡ä¸ä¼šè¢«æ‰§è¡Œ</div><div class="line">         */</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (timeNo == <span class="number">8</span>) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"boom"</span>);</div><div class="line">            &#125;</div><div class="line">            System.out.println(<span class="string">"time no "</span> + timeNo);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªdemoå±•ç¤ºä¸€ä¸ªTimerçš„å¼Šç«¯ã€‚å½“ä»»åŠ¡ä¸­å‡ºç°æœªè¢«æ•è·çš„å¼‚å¸¸ï¼Œæ¥ä¸‹æ¥çš„ä»»åŠ¡éƒ½ä¸ä¼šè¢«æ‰§è¡Œï¼Œå®šæ—¶å™¨crashæ‰ã€‚è¿™ä¸ªdemoä¸­å®šä¹‰äº†20ä¸ªtaskäº¤ç»™timerè°ƒåº¦ï¼Œtimerå¯åŠ¨2ç§’åå¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼Œæ¯éš”3ç§’æ‰§è¡Œä¸€æ¬¡ã€‚æ¥ä¸‹æ¥å°±è·Ÿç€demoä¸€æ­¥ä¸€æ­¥çœ‹çœ‹å…¶ä¸­çš„å®ç°åŸç†ã€‚</p>
<h4 id="æºç "><a href="#æºç " class="headerlink" title="æºç "></a>æºç </h4><p>é¦–å…ˆçœ‹çœ‹æ„é€ å™¨ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Timer</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    thread.setName(name);</div><div class="line">    thread.start();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">Timer</span><span class="params">(String name, <span class="keyword">boolean</span> isDaemon)</span> </span>&#123;</div><div class="line">    thread.setName(name);</div><div class="line">    thread.setDaemon(isDaemon);</div><div class="line">    thread.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ„é€ å™¨çš„å‚æ•°ä»£è¡¨ç€timerçš„åå­—å’Œè¿™ä¸ªtimeræ˜¯å¦æ˜¯åå°è¿è¡Œçš„ï¼ˆtimeræœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼‰ã€‚ä¸€æ—¦å®ä¾‹åŒ–å°±å°†è¿™ä¸ªçº¿ç¨‹ç»™å¯åŠ¨äº†ã€‚è¿™ä¸ªçº¿ç¨‹æ˜¯æ ¸å¿ƒã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> TimerThread thread = <span class="keyword">new</span> TimerThread(queue);</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæˆå‘˜å±æ€§TimerThreadå†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªqueueã€‚è¿™ä¸ªqueueä¸Šä»€ä¹ˆç¨åå†è®²ã€‚</p>
<p>å®ä¾‹åŒ–ç»“æŸåå°±å¾—è°ƒç”¨å®ƒçš„scheduleæ–¹æ³•äº†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">(TimerTask task, <span class="keyword">long</span> delay, <span class="keyword">long</span> period)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (delay &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Negative delay."</span>);</div><div class="line">    <span class="keyword">if</span> (period &lt;= <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Non-positive period."</span>);</div><div class="line">    sched(task, System.currentTimeMillis()+delay, -period);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// æ ¸å¿ƒçš„æ˜¯è¿™æ®µé€»è¾‘</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sched</span><span class="params">(TimerTask task, <span class="keyword">long</span> time, <span class="keyword">long</span> period)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (time &lt; <span class="number">0</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal execution time."</span>);</div><div class="line"></div><div class="line">    <span class="comment">// Constrain value of period sufficiently to prevent numeric</span></div><div class="line">    <span class="comment">// overflow while still being effectively infinitely large.</span></div><div class="line">    <span class="comment">// é˜²æ­¢æº¢å‡º å¦‚æœå‘¨æœŸæ¯”æœ€å¤§å€¼çš„ä¸€åŠè¿˜å¤§ é‚£å°±å°†å…¶é™¤ä»¥2 é“ç†ä½•åœ¨ï¼Ÿ</span></div><div class="line">    <span class="keyword">if</span> (Math.abs(period) &gt; (Long.MAX_VALUE &gt;&gt; <span class="number">1</span>))</div><div class="line">        period &gt;&gt;= <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">synchronized</span>(queue) &#123;</div><div class="line">        <span class="keyword">if</span> (!thread.newTasksMayBeScheduled)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Timer already cancelled."</span>);</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span>(task.lock) &#123;</div><div class="line">            <span class="comment">// å¦‚æœä»»åŠ¡çŠ¶æ€ä¸ä¸ºæ–°åˆ›å»ºçš„ ç›´æ¥æŠ›å¼‚å¸¸</span></div><div class="line">            <span class="keyword">if</span> (task.state != TimerTask.VIRGIN)</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</div><div class="line">                    <span class="string">"Task already scheduled or cancelled"</span>);</div><div class="line">            <span class="comment">// è®¾ç½®ä»»åŠ¡ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ æ‰§è¡Œå‘¨æœŸ ä»¥åŠ çŠ¶æ€</span></div><div class="line">            task.nextExecutionTime = time;</div><div class="line">            task.period = period;</div><div class="line">            task.state = TimerTask.SCHEDULED;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">		  <span class="comment">// ä»»åŠ¡å®é™…ä¸Šæ˜¯æ”¾åœ¨é˜Ÿåˆ—ä¸­ å¹¶ä¸æ˜¯ç›´æ¥æ‰§è¡Œçš„ </span></div><div class="line">        queue.add(task);</div><div class="line">        <span class="comment">// ä¸ºä»€ä¹ˆéœ€è¦queue.getMin() == taskæ—¶æ‰è°ƒç”¨notifyæ–¹æ³•å‘¢ï¼Ÿ</span></div><div class="line">        <span class="keyword">if</span> (queue.getMin() == task)</div><div class="line">            queue.notify();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç çœ‹ä¼¼ç®€å•ï¼Œä½†ä¹Ÿæ˜¯æœ‰ç‚¹é—¨é“çš„ã€‚åœ¨è®¾ç½®ä»»åŠ¡å±æ€§çš„æ—¶å€™é‡‡ç”¨åŠ é”ï¼Œé¿å…å¹¶å‘ä¸‹æŠŠä¸åŒä»»åŠ¡çš„æ‰§è¡Œå‘¨æœŸç­‰å‚æ•°ææ··ä¹±äº†ã€‚æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—ä¸­ä¹Ÿä½¿ç”¨äº†åŠ é”ï¼Œå®é™…ä¸Šæ˜¯é’ˆå¯¹addæ–¹æ³•åŠ çš„é”ã€‚ä¿è¯addä»»åŠ¡ä¸å‡ºä¹±ï¼ˆè¿™ä¸ªé˜Ÿåˆ—ä¸æ˜¯å®‰å…¨çš„é˜Ÿåˆ—ï¼‰ã€‚æœ€åæœ‰ä¸ªåˆ¤æ–­ï¼Œä¸ºä»€ä¹ˆéœ€è¦queue.getMin() == taskæ—¶æ‰è°ƒç”¨notifyæ–¹æ³•å‘¢ï¼Ÿå› ä¸ºåªæœ‰æ–°åŠ å…¥çš„taskæ˜¯æ‰€æœ‰Taskä¸­è¦è¢«æœ€æ—©æ‰§è¡Œçš„taskæ—¶ï¼Œæ‰ä¼šéœ€è¦æ‰“æ–­TimeThreadçš„ç­‰å¾…çŠ¶æ€ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå½“å‰é˜Ÿåˆ—ä¸­æœ‰ä¸¤ä¸ªtaskï¼Œåˆ†åˆ«æ˜¯Aï¼ˆ3åˆ†é’Ÿååˆ°æ—¶é—´ï¼‰ã€Bï¼ˆ5åˆ†é’Ÿååˆ°æ—¶é—´ï¼‰ï¼Œæ­¤æ—¶TimerThreadæ­£åœ¨ç­‰å¾…Açš„æ—¶é—´åˆ°æ¥ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨queue.wait(3min)ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œé˜Ÿåˆ—ä¸­æ–°å¢ä¸€ä¸ªä»»åŠ¡Cï¼ˆ1åˆ†é’Ÿååˆ°æ—¶ï¼‰ï¼Œå¦‚æœä¸æ‰“æ–­queue.wait(3min)ï¼Œé‚£å½“wait(3min)è‡ªç„¶ç»“æŸæ—¶ï¼ŒCä»»åŠ¡å·²ç»è¿‡æœŸäº†â€¦ ä½†æ˜¯å¦‚æœæ–°åŠ å…¥çš„Cä»»åŠ¡æ˜¯éœ€è¦åœ¨4åˆ†é’Ÿåæ‰§è¡Œï¼Œé‚£å°±æ²¡å¿…è¦æ‰“æ–­wait(3min)çš„çŠ¶æ€ï¼Œå› ä¸ºå°±ç®—wait(3min)è‡ªç„¶ç»“æŸæ—¶ï¼ŒCä¹Ÿè¿˜æ²¡åˆ°æ—¶é—´.</p>
<h5 id="ä»»åŠ¡æ˜¯ä»€ä¹ˆ"><a href="#ä»»åŠ¡æ˜¯ä»€ä¹ˆ" class="headerlink" title="ä»»åŠ¡æ˜¯ä»€ä¹ˆ"></a>ä»»åŠ¡æ˜¯ä»€ä¹ˆ</h5><p>è¯´äº†è¿™ä¹ˆä¹…ï¼Œè¿˜æ²¡å¼„æ¸…æ¥šè¿™ä¸ªä»»åŠ¡æ˜¯ä¸ªä»€ä¹ˆç©æ„ï¼ŸæŒ‰ç…§ç›´è§‰è¯´åˆ°ä»»åŠ¡ç¬¬ä¸€æƒ³åˆ°å°±æ˜¯Runnableå¯¹è±¡ï¼Œä½†æ˜¯ä¹Ÿæœ‰å…¶ä»–æƒ…å†µä¸‹ä¸æ˜¯è¿™æ ·çš„ã€‚ç„¶è€Œè¿™ä¸ªä»»åŠ¡ç¡®å®æ˜¯ä¸ªRunnableå¯¹è±¡ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TimerTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="comment">// å¯¹è±¡é”</span></div><div class="line">    <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</div><div class="line">   </div><div class="line">    <span class="comment">// ä»»åŠ¡çŠ¶æ€ æ–°å»º å·²è°ƒåº¦ å·²æ‰§è¡Œ å·²å–æ¶ˆ</span></div><div class="line">    <span class="comment">// é»˜è®¤æ˜¯æ–°å»º</span></div><div class="line">    <span class="keyword">int</span> state = VIRGIN;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VIRGIN = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SCHEDULED   = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EXECUTED    = <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CANCELLED   = <span class="number">3</span>;</div><div class="line">	 <span class="comment">// ä¸‹æ¬¡æ‰§è¡Œçš„æ—¶é—´</span></div><div class="line">    <span class="keyword">long</span> nextExecutionTime;</div><div class="line">	 <span class="comment">// å‘¨æœŸ</span></div><div class="line">    <span class="keyword">long</span> period = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">TimerTask</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span>(lock) &#123;</div><div class="line">            <span class="keyword">boolean</span> result = (state == SCHEDULED);</div><div class="line">            state = CANCELLED;</div><div class="line">            <span class="keyword">return</span> result;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">scheduledExecutionTime</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span>(lock) &#123;</div><div class="line">            <span class="keyword">return</span> (period &lt; <span class="number">0</span> ? nextExecutionTime + period</div><div class="line">                               : nextExecutionTime - period);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>TimeTaskå¯¹Runnableè¿›è¡Œç®€å•å°è£…ã€‚æš´éœ²å‡ºæŠ½è±¡çš„runæ–¹æ³•è®©ç”¨æˆ·çš„å…·ä½“å®ç°ç±»å»å®Œæˆã€‚åŒæ—¶æä¾›äº†å–æ¶ˆä»»åŠ¡çš„æ–¹æ³•ã€‚å’ŒJUCä¸­ä¸åŒçš„æ˜¯è¿™é‡ŒçŠ¶æ€çš„è½¬åŒ–éå¸¸ç®€å•ï¼Œæ²¡æœ‰JUCä¸­åŠ¨ä¸åŠ¨å°±ç”¨CASçš„éªšæ“ä½œã€‚è€ç‰ˆæœ¬çš„ä»£ç å°±æ˜¯å¥½ç†è§£äº›ã€‚</p>
<h5 id="ä»»åŠ¡çš„è°ƒåº¦ï¼ˆå®šæ—¶å™¨çš„æ ¸å¿ƒï¼‰"><a href="#ä»»åŠ¡çš„è°ƒåº¦ï¼ˆå®šæ—¶å™¨çš„æ ¸å¿ƒï¼‰" class="headerlink" title="ä»»åŠ¡çš„è°ƒåº¦ï¼ˆå®šæ—¶å™¨çš„æ ¸å¿ƒï¼‰"></a>ä»»åŠ¡çš„è°ƒåº¦ï¼ˆå®šæ—¶å™¨çš„æ ¸å¿ƒï¼‰</h5><p>æ—¢ç„¶éƒ½çŸ¥é“ä»»åŠ¡æ˜¯ä»€ä¹ˆäº†ï¼Œæ¥ä¸‹æ¥çœ‹çœ‹é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ˜¯æ€ä¹ˆè¢«å–å‡ºæ¥å’Œæ‰§è¡Œçš„ã€‚é¦–å…ˆå¾—çœ‹çœ‹è¿™ä¸ªçº¿ç¨‹æ˜¯ä¸ªä»€ä¹ˆæ ·å­çš„ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">    <span class="comment">// æ ‡è®°è¿™ä¸ªçº¿ç¨‹æ˜¯ä¸æ˜¯è¦è¢«æŒ‚èµ·</span></div><div class="line">    <span class="keyword">boolean</span> newTasksMayBeScheduled = <span class="keyword">true</span>;</div><div class="line">	 <span class="comment">// ç»´æŠ¤ä¸€ä¸ªé˜Ÿåˆ— ç”¨äºå­˜æ”¾ä»»åŠ¡çš„é˜Ÿåˆ—</span></div><div class="line">    <span class="keyword">private</span> TaskQueue queue;</div><div class="line"></div><div class="line">    TimerThread(TaskQueue queue) &#123;</div><div class="line">        <span class="keyword">this</span>.queue = queue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mainLoop();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="comment">// Someone killed this Thread, behave as if Timer cancelled</span></div><div class="line">            <span class="keyword">synchronized</span>(queue) &#123;</div><div class="line">                newTasksMayBeScheduled = <span class="keyword">false</span>;</div><div class="line">                queue.clear();  <span class="comment">// Eliminate obsolete references</span></div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// å…·ä½“æ‰§è¡Œæ ¸å¿ƒé€»è¾‘ å¼€æ­»å¾ªç¯è·‘</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mainLoop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                TimerTask task;</div><div class="line">                <span class="keyword">boolean</span> taskFired;</div><div class="line">                <span class="keyword">synchronized</span>(queue) &#123;</div><div class="line">                    <span class="comment">// Wait for queue to become non-empty</span></div><div class="line">                    <span class="comment">// å¦‚æœé˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡ï¼Œè€Œä¸”å®šæ—¶å™¨æ²¡æœ‰è¢«å–æ¶ˆï¼ˆé»˜è®¤ä¸ºtrueï¼Œåªæœ‰å°†timerå–æ¶ˆcancelæ–¹æ³•è°ƒç”¨çš„æ—¶å€™å°†å…¶ç½®ä¸ºfalseï¼Œè¿˜æœ‰ä¸€ä¸ªåœ°æ–¹ï¼‰ å°±å¾—å°†è¿™ä¸ªçº¿ç¨‹æŒ‚èµ· ä¸ç„¶å°±é€ æˆäº†æ­»å¾ªç¯ cpuç›´æ¥ä¸Š100%</span></div><div class="line">                    <span class="comment">// è€Œå”¤èµ·çš„åœ°æ–¹åªæœ‰cancelæ–¹æ³•å’ŒthreadReaper</span></div><div class="line">                    <span class="keyword">while</span> (queue.isEmpty() &amp;&amp; newTasksMayBeScheduled)</div><div class="line">                        queue.wait();</div><div class="line">                    <span class="comment">// ä»»åŠ¡é˜Ÿåˆ—ç©ºäº† å®šæ—¶å™¨å–æ¶ˆäº† è·³å‡ºå¾ªç¯ çº¿ç¨‹ç»“æŸ</span></div><div class="line">                    <span class="keyword">if</span> (queue.isEmpty())</div><div class="line">                        <span class="keyword">break</span>; <span class="comment">// Queue is empty and will forever remain; die</span></div><div class="line"></div><div class="line">                    <span class="comment">// Queue nonempty; look at first evt and do the right thing</span></div><div class="line">                    <span class="keyword">long</span> currentTime, executionTime;</div><div class="line">                    <span class="comment">// ä»é˜Ÿåˆ—ä¸­å–å‡ºæœ€delayæ—¶é—´æœ€å°çš„ä»»åŠ¡ å¾—æœ€æ—©æ‰§è¡Œçš„ä»»åŠ¡</span></div><div class="line">                    task = queue.getMin();</div><div class="line">                    <span class="keyword">synchronized</span>(task.lock) &#123;</div><div class="line">                    	 <span class="comment">// ä»»åŠ¡å–æ¶ˆäº†ï¼Œå°†å…¶ç§»å‡ºé˜Ÿåˆ— ç»§ç»­å–ä¸‹ä¸€ä¸ª</span></div><div class="line">                        <span class="keyword">if</span> (task.state == TimerTask.CANCELLED) &#123;</div><div class="line">                            queue.removeMin();</div><div class="line">                            <span class="keyword">continue</span>;  <span class="comment">// No action required, poll queue again</span></div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">// currentTimeMillis()è¿”å›ä»¥æ¯«ç§’ä¸ºå•ä½çš„å½“å‰æ—¶é—´ï¼Œè¿”å›çš„æ˜¯å½“å‰æ—¶é—´ä¸1970 å¹´ 1 æœˆ 1 æ—¥åˆå¤œä¹‹é—´çš„æ—¶é—´å·®</span></div><div class="line">                        currentTime = System.currentTimeMillis();</div><div class="line">                        executionTime = task.nextExecutionTime;</div><div class="line">                        <span class="comment">// å¦‚æœç»™å®šçš„åˆ°æœŸæ—¶é—´å°äºå½“å‰æ—¶é—´ï¼ˆ1970-01-01åˆ°ç°åœ¨çš„å·®å€¼ï¼‰è¯´æ˜ä»»åŠ¡åˆ°æœŸäº† éœ€è¦è¢«æ‰§è¡Œ æŠŠtaskFiredç½®ä¸ºtrue</span></div><div class="line">                        <span class="keyword">if</span> (taskFired = (executionTime&lt;=currentTime)) &#123;</div><div class="line">                            <span class="keyword">if</span> (task.period == <span class="number">0</span>) &#123; <span class="comment">// Non-repeating, remove</span></div><div class="line">                            	  <span class="comment">// ä¸æ˜¯å‘¨æœŸæ‰§è¡Œçš„ä»»åŠ¡ ç›´æ¥ä»é˜Ÿåˆ—ä¸­ç§»é™¤æ‰ å°†ä»»åŠ¡çŠ¶æ€ç½®ä¸ºå·²æ‰§è¡Œ</span></div><div class="line">                                queue.removeMin();</div><div class="line">                                task.state = TimerTask.EXECUTED;</div><div class="line">                            &#125; <span class="keyword">else</span> &#123; <span class="comment">// Repeating task, reschedule</span></div><div class="line">                                <span class="comment">// æ˜¯å‘¨æœŸä»»åŠ¡ é‡æ–°è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œçš„æ—¶é—´ å³å½“å‰æ—¶é—´+é—´éš”æ—¶é—´ä¸ºä¸‹æ¬¡ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´</span></div><div class="line">                                <span class="comment">// è¿™é‡Œæ˜¯â–å› ä¸ºä¹‹å‰ä¼ è¿›æ¥çš„æ˜¯ä¸€ä¸ªè´Ÿå€¼</span></div><div class="line">                                queue.rescheduleMin(</div><div class="line">                                  task.period&lt;<span class="number">0</span> ? currentTime   - task.period</div><div class="line">                                                : executionTime + task.period);</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    <span class="comment">// å¦‚æœæ²¡åˆ°æœŸ å°±ç­‰ä¸€ä¸ªdelayé•¿çš„æ—¶é—´</span></div><div class="line">                    <span class="comment">// executionTime  = System.currentTimeMillis()+delay</span></div><div class="line">                    <span class="keyword">if</span> (!taskFired) <span class="comment">// Task hasn't yet fired; wait</span></div><div class="line">                        queue.wait(executionTime - currentTime);</div><div class="line">                &#125;</div><div class="line">                <span class="comment">// ä»»åŠ¡å¯åŠ¨ æ‰§è¡Œä¸šåŠ¡é€»è¾‘</span></div><div class="line">                <span class="keyword">if</span> (taskFired)  <span class="comment">// Task fired; run it, holding no locks</span></div><div class="line">                    task.run();</div><div class="line">            &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="å°ç–‘æƒ‘"><a href="#å°ç–‘æƒ‘" class="headerlink" title="å°ç–‘æƒ‘"></a>å°ç–‘æƒ‘</h5><p>æ•´ä¸ªå®šæ—¶å™¨çš„æ ¸å¿ƒé€»è¾‘åœ¨ä»£ç æ³¨é‡Šä¸­éƒ½ä¸€ä¸€è§£é‡Šäº†ã€‚å…¶ä¸­ä¸€ä¸ªç»†èŠ‚ï¼šå˜é‡newTasksMayBeScheduledç”¨æ¥åšä»€ä¹ˆçš„ã€‚<br>é¦–å…ˆå¾—çœ‹çœ‹å®ƒçš„å€¼è¢«ç½®ä¸ºfalseçš„æƒ…å½¢åœ¨å“ªäº›åœ°æ–¹å‡ºç°ã€‚</p>
<ul>
<li>Timer#cancelæ–¹æ³•</li>
<li>TimerThreadçš„mainloopæ‰§è¡Œå®Œäº†finallyå—ä¸­</li>
<li>Timerçš„æˆå‘˜å±æ€§threadReaperçš„finalizeæ–¹æ³•ä¸­</li>
</ul>
<p>å‰ä¸¤è€…éƒ½ä¸å¿…å¤šè§£é‡Šï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯æœ€åä¸€ç§æƒ…å†µã€‚è¿™ç§å†™æ³•æˆ‘è¿˜æ˜¯ç¬¬ä¸€æ¬¡è§ï¼Œè¿˜ä¸æ˜ç™½å…¶ä¸­çš„ç„æœºï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * This object causes the timer's task execution thread to exit</div><div class="line"> * gracefully when there are no live references to the Timer object and no</div><div class="line"> * tasks in the timer queue.  It is used in preference to a finalizer on</div><div class="line"> * Timer as such a finalizer would be susceptible to a subclass's</div><div class="line"> * finalizer forgetting to call it.</div><div class="line"> */</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> Object threadReaper = <span class="keyword">new</span> Object() &#123;</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span>(queue) &#123;</div><div class="line">            thread.newTasksMayBeScheduled = <span class="keyword">false</span>;</div><div class="line">            queue.notify(); <span class="comment">// In case queue is empty.</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å½“queueä¸ºç©ºï¼Œå¹¶ä¸”æ²¡äººè°ƒç”¨addæˆ–cancelæ–¹æ³•æ—¶ï¼ŒTimerThreadæ°¸è¿œéƒ½ä¸ä¼šstopï¼Œé‚£ä¹ˆè¿˜æœ‰åˆ«çš„å¯èƒ½å—ï¼Ÿ</p>
<p>ä¸Šè¿°çš„åšæ³•å°±æä¾›äº†å¦å¤–çš„æ€è·¯ã€‚å½“é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡çš„æ—¶å€™ï¼ŒTimerThreadä¼šwaitï¼Œå¦‚æœä¸æ‰‹åŠ¨è°ƒç”¨cancelè¿™ä¸ªçº¿ç¨‹ä¸€ç›´ä¼šæŒ‚èµ·ã€‚èªæ˜çš„jdkå°±æä¾›äº†ä¸Šè¿°çš„æ–¹æ³•ã€‚å½“åœ¨GCçš„æ—¶å€™ä¼šè§¦å‘finalizeæ–¹æ³•è°ƒç”¨ï¼Œé‚£ä»€ä¹ˆæ—¶å€™ä¼šè§¦å‘GCå‘¢ï¼Ÿå½“Timerå¯¹è±¡æ²¡æœ‰è¢«ä»»ä½•å¯¹è±¡å¼•ç”¨çš„æ—¶å€™å¦‚æœæœ‰GCé‚£ä¹ˆè¿™æ®µä»£ç è¢«è°ƒç”¨ï¼šnewTasksMayBeScheduledç½®ä¸ºfalseåŒæ—¶å°†æŒ‚èµ·çš„TimerThreadå”¤é†’ï¼Œè¿™æ—¶å€™mainloopæ­»å¾ªç¯å°±è·³å‡ºäº†ï¼ŒTimerThreadçº¿ç¨‹ç»“æŸï¼</p>
<p>å…·ä½“éªŒè¯å¯ä»¥ä½¿ç”¨Jprofileè¿™ä¸ªå·¥å…·ã€‚äº‹å®ä¸Šç¡®å®å¯è¡Œã€‚ä½†æ˜¯é€šè¿‡è¿™æ®µä»£ç è®©æˆ‘è”æƒ³åˆ°ä¸€ä¸ªè¿™ä¸ªå®šæ—¶å™¨çš„å¼Šç«¯ï¼šæ²¡åšåˆ°åƒExecutorServiceèƒ½å¤Ÿç­‰åˆ°ä»»åŠ¡å…¨éƒ¨æ‰§è¡Œå®Œæˆåå†å°†å…¶å…³é—­ã€‚æ‰‹åŠ¨å…³é—­åªèƒ½é€šè¿‡cancelè¿™ç§ç²—æš´çš„æ–¹å¼,è¿˜å¥½jdkå·¥ç¨‹å¸ˆæä¾›è¿™æ ·ä¸€ä¸ªâ€œåé—¨â€ï¼Œäº¤ç»™jvmæ¥ç®¡ç†ã€‚è¿™ä¹Ÿä¸å¤±ä¸ºä¸€ç§è¡¥æ•‘æªæ–½ï¼Œä½†æ˜¯å¯¹äºä¹‹åçš„JUCè€Œè¨€ï¼Œè¿™ç§åšæ³•æ˜¾å¾—æœ‰ç‚¹â€œå°å„¿ç§‘â€äº†ã€‚ä½†æ˜¯å¯¹äºå­¦ä¹ è€…è€Œè¨€ï¼Œè¿™ç§ä»£ç ç»„ç»‡æ˜¾å¾—æ›´å®¹æ˜“è¯»æ‡‚ï¼Œè®¾è®¡æ€æƒ³å¾ˆå®¹æ˜“å‘ˆç°åœ¨æˆ‘ä»¬é¢å‰ã€‚æ—¶ä»£ä¸æ–­è¿›æ­¥ï¼Œæ€»ä¼šæœ‰å¥½çš„è®¾è®¡æ¥å–ä»£è€çš„æ—§çš„ä¸œè¥¿ã€‚å¹¶ä¸æ˜¯æ„å‘³ç€è€çš„æ—§çš„çœŸæ­£è¢«å–ä»£ï¼Œè€Œæ˜¯ä»¥å¦å¤–ä¸€ç§ä»·å€¼å‘ˆç°åœ¨æˆ‘ä»¬åæ¥äººé¢å‰ã€‚é€šè¿‡æ¯”è¾ƒï¼Œæˆ‘ä»¬å¯èƒ½ä¼šæ›´åŠ ç†è§£ä»€ä¹ˆæ˜¯å¥½çš„è®¾è®¡ã€‚</p>
<h5 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h5><p>æ•´ä¸ªTimerå®šæ—¶ä»»åŠ¡çš„æ ¸å¿ƒé€»è¾‘å°±æ¢³ç†å®Œäº†ã€‚å…¶ä¸­æœ‰ä¸€äº›ç»†èŠ‚è¢«å¿½ç•¥æ‰äº†ï¼Œæ¯”å¦‚è¿™ä¸ªä»»åŠ¡é˜Ÿåˆ—queueçš„å…·ä½“å®ç°ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * This class represents a timer task queue: a priority queue of TimerTasks,</div><div class="line"> * ordered on nextExecutionTime.  Each Timer object has one of these, which it</div><div class="line"> * shares with its TimerThread.  Internally this class uses a heap, which</div><div class="line"> * offers log(n) performance for the add, removeMin and rescheduleMin</div><div class="line"> * operations, and constant time performance for the getMin operation.</div><div class="line"> */</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TaskQueue</span> </span>&#123;</div><div class="line">    <span class="comment">// ç»´æŠ¤ä¸€ä¸ªé•¿åº¦ä¸º128çš„æ•°ç»„</span></div><div class="line">    <span class="keyword">private</span> TimerTask[] queue = <span class="keyword">new</span> TimerTask[<span class="number">128</span>];</div><div class="line"></div><div class="line">    <span class="comment">// é˜Ÿåˆ—é•¿åº¦</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> size;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Adds a new task to the priority queue.</div><div class="line">     * å½“å‰é˜Ÿåˆ—é•¿åº¦ä¸ºæœ€å¤§é•¿åº¦-1çš„æ—¶å€™å°±è¿›è¡Œæ‰©å®¹ æ–°é˜Ÿåˆ—é•¿åº¦ä¸ºå½“å‰2å€</div><div class="line">     * ä¸ºä»€ä¹ˆè¦åœ¨æœ€å¤§é•¿åº¦-1çš„æ—¶å€™æ‰©å®¹å‘¢ï¼Ÿå› ä¸ºä¸æå‰æ‰©å®¹å½“å‰çš„å…ƒç´ åŠ ä¸è¿›å»ğŸ˜‚</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(TimerTask task)</span> </span>&#123;</div><div class="line">        <span class="comment">// Grow backing store if necessary</span></div><div class="line">        <span class="keyword">if</span> (size + <span class="number">1</span> == queue.length)</div><div class="line">            queue = Arrays.copyOf(queue, <span class="number">2</span>*queue.length);</div><div class="line"></div><div class="line">        queue[++size] = task;</div><div class="line">        fixUp(size);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * è·å–ç¬¬ä¸€ä¸ªå…ƒç´  åˆ°æœŸæ—¶é—´æœ€è¿‘çš„</div><div class="line">     */</div><div class="line">    <span class="function">TimerTask <span class="title">getMin</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> queue[<span class="number">1</span>];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// ä¸‹æ ‡ä»1å¼€å§‹å–</span></div><div class="line">    <span class="function">TimerTask <span class="title">get</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> queue[i];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/** </span></div><div class="line">     * ç§»é™¤ç¬¬ä¸€ä¸ªå…ƒç´  åˆ°æœŸæ—¶é—´æœ€è¿‘çš„</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">removeMin</span><span class="params">()</span> </span>&#123;</div><div class="line">        queue[<span class="number">1</span>] = queue[size];</div><div class="line">        queue[size--] = <span class="keyword">null</span>;  <span class="comment">// Drop extra reference to prevent memory leak</span></div><div class="line">        fixDown(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">quickRemove</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</div><div class="line">        <span class="keyword">assert</span> i &lt;= size;</div><div class="line"></div><div class="line">        queue[i] = queue[size];</div><div class="line">        queue[size--] = <span class="keyword">null</span>;  <span class="comment">// Drop extra ref to prevent memory leak</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// æ”¹ç¬¬ä¸€ä¸ªå…ƒç´ çš„åˆ°æœŸæ—¶é—´å±æ€§</span></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rescheduleMin</span><span class="params">(<span class="keyword">long</span> newTime)</span> </span>&#123;</div><div class="line">        queue[<span class="number">1</span>].nextExecutionTime = newTime;</div><div class="line">        fixDown(<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> size==<span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">// Null out task references to prevent memory leak</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;=size; i++)</div><div class="line">            queue[i] = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        size = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Establishes the heap invariant (described above) assuming the heap</div><div class="line">     * satisfies the invariant except possibly for the leaf-node indexed by k</div><div class="line">     * (which may have a nextExecutionTime less than its parent's).</div><div class="line">     *</div><div class="line">     * This method functions by "promoting" queue[k] up the hierarchy</div><div class="line">     * (by swapping it with its parent) repeatedly until queue[k]'s</div><div class="line">     * nextExecutionTime is greater than or equal to that of its parent.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fixUp</span><span class="params">(<span class="keyword">int</span> k)</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (k &gt; <span class="number">1</span>) &#123;</div><div class="line">            <span class="keyword">int</span> j = k &gt;&gt; <span class="number">1</span>;</div><div class="line">            <span class="keyword">if</span> (queue[j].nextExecutionTime &lt;= queue[k].nextExecutionTime)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            TimerTask tmp = queue[j];  queue[j] = queue[k]; queue[k] = tmp;</div><div class="line">            k = j;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Establishes the heap invariant (described above) in the subtree</div><div class="line">     * rooted at k, which is assumed to satisfy the heap invariant except</div><div class="line">     * possibly for node k itself (which may have a nextExecutionTime greater</div><div class="line">     * than its children's).</div><div class="line">     *</div><div class="line">     * This method functions by "demoting" queue[k] down the hierarchy</div><div class="line">     * (by swapping it with its smaller child) repeatedly until queue[k]'s</div><div class="line">     * nextExecutionTime is less than or equal to those of its children.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fixDown</span><span class="params">(<span class="keyword">int</span> k)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> j;</div><div class="line">        <span class="keyword">while</span> ((j = k &lt;&lt; <span class="number">1</span>) &lt;= size &amp;&amp; j &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (j &lt; size &amp;&amp;</div><div class="line">                queue[j].nextExecutionTime &gt; queue[j+<span class="number">1</span>].nextExecutionTime)</div><div class="line">                j++; <span class="comment">// j indexes smallest kid</span></div><div class="line">            <span class="keyword">if</span> (queue[k].nextExecutionTime &lt;= queue[j].nextExecutionTime)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            TimerTask tmp = queue[j];  queue[j] = queue[k]; queue[k] = tmp;</div><div class="line">            k = j;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Establishes the heap invariant (described above) in the entire tree,</div><div class="line">     * assuming nothing about the order of the elements prior to the call.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">heapify</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = size/<span class="number">2</span>; i &gt;= <span class="number">1</span>; i--)</div><div class="line">            fixDown(i);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªé˜Ÿåˆ—æ˜¯ä¸€ä¸ªä¼˜å…ˆé˜Ÿåˆ—ï¼Œä»¥taskçš„åˆ°æœŸæ—¶é—´æ¥æ’åºï¼Œæ—¶é—´è¶Šå°è¶Šé å‰ã€‚è¿™ä¸ªé˜Ÿåˆ—æ˜¯ç”¨å †ç»“æ„å®ç°çš„ï¼ˆåºŸè¯ï¼Œä¼˜å…ˆé˜Ÿåˆ—æœ¬èº«å°±æ˜¯å †ï¼‰ï¼Œå®é™…ä¸Šå †æœ¬è´¨ä¸Šå°±æ˜¯å®Œå…¨äºŒå‰æ ‘ã€‚å¯¹äºadd removeæ“ä½œçš„å¤æ‚åº¦ä¸ºlog(n)ã€‚æœ€æ ¸å¿ƒçš„æ“ä½œå°±æ˜¯fixDown fixUpã€‚å †ä¹Ÿåˆ†ä¸ºå¤§æ ¹å †å’Œå°æ ¹å †ï¼Œè¿™æ˜¯ä¸€ä¸ªå°æ ¹å †ï¼Œæœ€å°çš„æ”¾åˆ°æœ€ä¸Šé¢ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ ‡ä¸º1çš„ä½ç½®ï¼ˆåªæ˜¯Timerä¸­çš„å®ç°å°†ä¸‹æ ‡ä¸º0çš„ä½ç½®ç»™å¼ƒç”¨äº†ï¼‰ã€‚æ¯æ¬¡æ·»åŠ å…ƒç´ éƒ½å¾—è°ƒæ•´å †ç»“æ„ï¼ŒåŒç†ç§»é™¤çš„æ—¶å€™ä¹Ÿå¾—è¿™æ ·åšã€‚</p>
<p>æœ¬æ–‡ä¸­çš„<a href="https://github.com/Mr-Vincent/simple-rpc/blob/a570c16128062b14ac0f0fa75e769d76060d3ad2/simple-example/src/main/java/top/weidong/example/netty/nettyinpractice/timer/JdkTimerDemo.java#L95-L94" target="_blank" rel="external">demo</a>ã€‚</p>
<h4 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><ul>
<li>æºç è¯»èµ·æ¥æ²¡é‚£ä¹ˆéš¾å—ï¼Œä»”ç»†æ¨æ•²è¿˜æ˜¯å¾ˆæœ‰æ„æ€çš„ã€‚</li>
<li>ç›¸æ¯”è€çˆ·å­Doug Leaçš„éªšä»£ç ï¼Œè¿™ç§ä¸­è§„ä¸­çŸ©çš„å†™æ³•çœ‹èµ·æ¥æ›´è®©äººå®¹æ˜“ç†è§£ã€‚</li>
<li>å»ºè®®ä½¿ç”¨ScheduledExecutorServiceï¼Œæ¯•ç«ŸTimerçš„é€‚ç”¨åœºæ™¯å¾ˆå±€é™ã€‚</li>
</ul>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    
    <hr />
    <h3>ç•™è¨€:</h3>
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>



                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    
                        <li>
                            <a href="https://github.com/Mr-Vincent" target="_blank">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2019 Mr-Vincent<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->

<script type="text/javascript">
    var disqus_shortname = 'wei-dong';

    (function(){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



</body>

</html>