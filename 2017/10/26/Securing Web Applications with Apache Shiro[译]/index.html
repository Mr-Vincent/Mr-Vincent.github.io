<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="以梦为马 不负韶华"><title>Securing Web Applications with Apache Shiro[译] | DongWei's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Securing Web Applications with Apache Shiro[译]</h1><a id="logo" href="/.">DongWei's Blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> About</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Securing Web Applications with Apache Shiro[译]</h1><div class="post-meta">Oct 26, 2017<span> | </span><span class="category"><a href="/categories/Apache/">Apache</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>这篇文章是介绍使用Shiro一步一步保护你的web应用的教程。它包含了Shiro的知识，以及和最近两篇文章很相似：</p>
<ul>
<li><a href="https://www.infoq.com/articles/apache-shiro" target="_blank" rel="external">Application Security with Apache Shiro</a></li>
<li><a href="http://shiro.apache.org/10-minute-tutorial.html" target="_blank" rel="external">Apache Shiro 10 Minute Tutorial</a><br>这个入门教程会花费大约45分钟到一个小时。当你读完后，你就会知道Shiro在web应用中怎么工作了的。<a id="more"></a>
<h3 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h3></li>
<li>概括</li>
<li>设置</li>
<li>第一步：开启Shiro</li>
<li>第二步：连接到用户存储</li>
<li>第三步：开启登录和登出</li>
<li>第四步：改变用户指定UI</li>
<li>第五步：仅仅允许认证用户访问</li>
<li>第六步：基于角色访问控制</li>
<li>第七步：基于权限访问控制</li>
</ul>
<h3 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h3><p>虽然Shiro设计的核心目标可以用于保护任何基于JVM的应用，例如命令行应用，后台服务，网页应用等。这篇文章专注最常见的应用：保护跑在Servlet容器上的web应用，例如Tomca或者Jetty。</p>
<h4 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h4><p>下面的工具是要安装到你本地开发机器上的，以便遵循本教程。</p>
<ul>
<li>Git (tested w/ 1.7)</li>
<li>Java SDK 7</li>
<li>Maven 3</li>
<li>你自己喜欢的编辑器，IDEA或者Eclipse都行，甚至文本编辑器也行。</li>
</ul>
<h4 id="教程格式"><a href="#教程格式" class="headerlink" title="教程格式"></a>教程格式</h4><p>这是一步接着一步的教程。该教程和所有步骤都在GIT仓库中存着。当你clone git仓库，master分支就是你的起点。在这个教程中的每个步骤都是单独的分支。你可以通过检出你正在看的教程步骤的git分支来读这个教程（就是边看代码边读这个教程的意思）。</p>
<h4 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h4><p>我们将构建的Web应用程序是一个超级webapp，可以作为你自己的应用程序的起点。它将演示用户登录，注销，用户特定的欢迎消息，对Web应用程序的某些部分的访问控制以及与可插拔安全数据存储的集成。</p>
<p>我们将首先设置项目，包括构建工具和声明依赖关系，以及配置servlet web.xml文件以启动Web应用程序和Shiro环境。</p>
<p>完成设置后，我们将分层单独的功能，包括与安全数据存储集成，然后启用用户登录，注销和访问控制。</p>
<h3 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h3><p>我们已经在git仓库中设置完成了，因此你不必手动去设置目录结构初始化文件等。</p>
<h4 id="1-Fork-the-tutorial-project"><a href="#1-Fork-the-tutorial-project" class="headerlink" title="1. Fork the tutorial project"></a>1. Fork the tutorial project</h4><p>在github中访问<a href="https://github.com/lhazlewood/apache-shiro-tutorial-webapp" target="_blank" rel="external">这个</a>，点击<code>fork</code>按钮。</p>
<h4 id="2-Clone-your-tutorial-repository"><a href="#2-Clone-your-tutorial-repository" class="headerlink" title="2. Clone your tutorial repository"></a>2. Clone your tutorial repository</h4><p>现在你把那个仓库fork到你自己的账号中去了，clone到你自己的机器：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git <span class="built_in">clone</span> git@github.com:<span class="variable">$YOUR_GITHUB_USERNAME</span>/apache-shiro-tutorial-webapp.git</div></pre></td></tr></table></figure></p>
<h4 id="3-Review-project-structure"><a href="#3-Review-project-structure" class="headerlink" title="3. Review project structure"></a>3. Review project structure</h4><p>完成clone后，你当前的<code>master</code>分支将有下面的结构：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">apache-shiro-tutorial-webapp/</div><div class="line">     |-- src/</div><div class="line">     |  |-- main/</div><div class="line">     |    |-- resources/</div><div class="line">     |      |-- logback.xml</div><div class="line">     |    |-- webapp/</div><div class="line">     |      |-- WEB-INF/</div><div class="line">     |        |-- web.xml</div><div class="line">     |      |-- home.jsp</div><div class="line">     |      |-- include.jsp</div><div class="line">     |      |-- index.jsp</div><div class="line">     |-- .gitignore</div><div class="line">     |-- .travis.yml</div><div class="line">     |-- LICENSE</div><div class="line">     |-- README.md</div><div class="line">     |-- pom.xml</div></pre></td></tr></table></figure></p>
<p>这些是每个文件表示的含义：</p>
<ul>
<li>pom.xml 不解释</li>
<li>README.md 描述文件</li>
<li>LICENSE 证书</li>
<li>.travis.yml CI的配置文件，假如你想持续集成</li>
<li>.gitignore 忽略文件，包含后缀。你不想加入版本控制的都能写这里</li>
<li>src/main/resources/logback.xml 简单的Logback配置文件，在这个教程中，我们选择SELF4J作为日志API，Logback作为实现。这个比Log4J和JUL简单。</li>
<li>src/main/webapp/WEB-INF/web.xml web配置文件</li>
<li>src/main/webapp/include.jsp  公用的JSP文件，用于导入和声明。方便在一个地方管理。</li>
<li>src/main/webapp/home.jsp 默认的homepage</li>
<li>src/main/webapp/index.jsp 默认主页，仅仅是将请求指向home.jsp</li>
</ul>
<h4 id="4-Run-the-webapp"><a href="#4-Run-the-webapp" class="headerlink" title="4. Run the webapp"></a>4. Run the webapp</h4><p>现在你将工程克隆到本地了，你可以通过使用一下命令来跑这个web应用：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mvn jetty:run</div></pre></td></tr></table></figure></p>
<p>然后打开你的浏览器，输入 localhost:8080 你可以看到主页显示的Hello，World！按ctl-c停止web。</p>
<h3 id="Step-1-Enable-Shiro"><a href="#Step-1-Enable-Shiro" class="headerlink" title="Step 1: Enable Shiro"></a>Step 1: Enable Shiro</h3><p>我们初始化仓库master分支仅仅是一个简单通用的可用于任何应用的模板的web应用。Let’s add the bare minimum to enable Shiro in the web app next(这句话不知道怎么翻译)。</p>
<p>执行下面的git检出命令加载step1的分支：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step1</div></pre></td></tr></table></figure></p>
<p>检出后你会发现两个变化：</p>
<ol>
<li>多了<code>src/main/webapp/WEB-INF/shiro.ini</code>这个文件</li>
<li><code>src/main/webapp/WEB-INF/web.xml</code>被改了</li>
</ol>
<h4 id="添加shiro-ini文件"><a href="#添加shiro-ini文件" class="headerlink" title="添加shiro.ini文件"></a>添加shiro.ini文件</h4><p>在web应用中油很多种方式配置Shiro，这取决于你使用的是什么web框架。例如，你可以通过Spring、Guice、Tapestry等配置Shiro。</p>
<p>现在为了方便，我们将使用Shiro默认的配置,<a href="http://shiro.apache.org/configuration.html" target="_blank" rel="external">基于ini的配置</a>。</p>
<p>如果你检出了step1的分支，你可以看到这个新的配置文件<code>src/main/webapp/WEB-INF/shiro.ini</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[main]</div><div class="line"></div><div class="line"># Let&apos;s use some in-memory caching to reduce the number of runtime lookups against a remote user store.</div><div class="line"># A real application might want to use a more robust caching solution (e.g. ehcache or a</div><div class="line"># distributed cache).  When using such caches, be aware of your cache TTL settings: too high</div><div class="line"># a TTL and the cache won&apos;t reflect any potential changes in Stormpath fast enough.  Too low</div><div class="line"># and the cache could evict too often, reducing performance.</div><div class="line">cacheManager = org.apache.shiro.cache.MemoryConstrainedCacheManager</div><div class="line">securityManager.cacheManager = $cacheManager</div></pre></td></tr></table></figure></p>
<p>这个ini配置文件包含一个<code>[main]</code>的最小配置。</p>
<ul>
<li>定义了一个<code>cacheManager</code>实例。缓存在Shiro架构中是一个很重要的部分。它减少了重复的数据交互。这个例子使用<code>MemoryConstrainedCacheManager</code>，仅仅对单个JVM应用很棒。如果你的应用部署在多个主机，你最好使用集群的CacheManager 实现。</li>
<li>它在Shiro securityManager上配置新的cacheManager实例。Shiro SecurityManager实例始终存在，因此不需要明确定义。</li>
</ul>
<h4 id="在web-xml中开启Shiro"><a href="#在web-xml中开启Shiro" class="headerlink" title="在web.xml中开启Shiro"></a>在web.xml中开启Shiro</h4><p>虽然我们有shiro.ini配置文件，但是我们确实需要把它加载进去然后开启Shiro环境让web应用能够使用它。</p>
<p>我们在<code>src/main/webapp/WEB-INF/web.xml</code>配置文件中添加这些东西：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.apache.shiro.web.env.EnvironmentLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ShiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.shiro.web.servlet.ShiroFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>ShiroFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>REQUEST<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>FORWARD<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>INCLUDE<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">dispatcher</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">dispatcher</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure></p>
<ul>
<li><code>&lt;listener&gt;</code>声明定义了一个<code>ServletContextListener</code>用于在web用于启动的时候创建一个Shiro环境。默认这个listener会去自动找<code>WEB-INF/shiro.ini</code>配置文件。</li>
<li><code>&lt;filter&gt;</code>定义了一个主要的<code>ShiroFilter</code>。这个过滤器会去过滤所有的请求，这样Shiro能够在允许请求到达应用程序之前执行必要的身份和访问控制操作。</li>
</ul>
<h4 id="跑起来"><a href="#跑起来" class="headerlink" title="跑起来"></a>跑起来</h4><p>拉去了分支后，继续跑起来：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mvn jetty:run</div></pre></td></tr></table></figure></p>
<p>这个时候，你会看到下面熟悉的输出，这表示Shiro确实在你的web应用中跑起来了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">16:04:19.807 [main] INFO  o.a.shiro.web.env.EnvironmentLoader - Starting Shiro environment initialization.</div><div class="line">16:04:19.904 [main] INFO  o.a.shiro.web.env.EnvironmentLoader - Shiro environment initialized in 95 ms.</div></pre></td></tr></table></figure></p>
<h3 id="Step-2-Connect-to-a-User-Store"><a href="#Step-2-Connect-to-a-User-Store" class="headerlink" title="Step 2: Connect to a User Store"></a>Step 2: Connect to a User Store</h3><p>执行下面的命令检出step2的代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step2</div></pre></td></tr></table></figure></p>
<p>现在我们将Shiro集成并运行在webapp中.但是我们还没有告诉Shiro要做什么事情。</p>
<p>在我们登录，退出或执行基于角色或权限的访问控制或任何其他安全相关之前，我们需要用户！</p>
<p>我们需要配置Shiro来访问某种类型的用户存储，这样它可以查找用户做登录操作或者检查角色等等。有许多类型的用户存储，任何应用程序可能需要访问：也许你将用户存在MySql数据库中，或者MongoDB，或者LDAP，或者Active Directory，或者简单的文件中。</p>
<p>Shiro将这叫做<code>Realm</code>.来自Shiro的文档：</p>
<blockquote>
<p>Realms act as the ‘bridge’ or ‘connector’ between Shiro and your application’s security data. When it comes time to actually interact with security-related data like user accounts to perform authentication (login) and authorization (access control), Shiro looks up many of these things from one or more Realms configured for an application.<br>In this sense a Realm is essentially a security-specific DAO: it encapsulates connection details for data sources and makes the associated data available to Shiro as needed. When configuring Shiro, you must specify at least one Realm to use for authentication and/or authorization. The SecurityManager may be configured with multiple Realms, but at least one is required.<br>Shiro provides out-of-the-box Realms to connect to a number of security data sources (aka directories) such as LDAP, relational databases (JDBC), text configuration sources like INI and properties files, and more. You can plug-in your own Realm implementations to represent custom data sources if the default Realms do not meet your needs.</p>
</blockquote>
<p>因此我们需要配置一个<code>realm</code>这样我们就能够得到用户了。</p>
<h4 id="Set-up-Stormpath"><a href="#Set-up-Stormpath" class="headerlink" title="Set up Stormpath"></a>Set up Stormpath</h4><p>本着越简单越好的原则，没有介绍Shiro的复杂性，我们使用一个最简单的realm的实现：Stormpath realm。</p>
<p>Stormpath 是一个云平台上的用户管理服务。对开发者免费。这意味着使用了Stormpath以后，帮你做了做以下的事情：</p>
<ul>
<li>一个用于管理应用，目录、账户、和组的接口。Shiro根本不提供这些东西，因此当你浏览这篇教程的时候能够节约时间，这是很方便的。</li>
<li>一个为用户存储密码的安全机制。你的应用不必担心密码安全，密码比较或存储密码。虽然Shiro能做这些事情，但是你有必要去配置一下，然后注意一下加密的概念。 Stormpath自动的对密码进行保护，因此你不必担心这些东西。</li>
<li>安全的工作流，类似于邮箱验证密码重置。Shiro对此没有任何支持，因为这是应用程序来把控的。</li>
<li>主机托管总是在基础设施上的（云平台），你没有必要来维护这些东西。</li>
</ul>
<p>为了本教程的目的，Stormpath比设置单独的RDBMS服务器要简单得多，并且担心SQL或密码加密问题。</p>
<p>当然，Stormpath只是Shiro可以进行沟通的许多后端数据存储之一。 稍后将介绍更复杂的数据存储和应用程序特定的配置。</p>
<h5 id="Sign-up-for-Stormpath"><a href="#Sign-up-for-Stormpath" class="headerlink" title="Sign up for Stormpath"></a>Sign up for Stormpath</h5><p>blabla…..</p>
<h5 id="Get-a-Stormpath-API-Key"><a href="#Get-a-Stormpath-API-Key" class="headerlink" title="Get a Stormpath API Key"></a>Get a Stormpath API Key</h5><p>Stormpath API Key对于Stormpath来说是必须的。可以这样获取：</p>
<ol>
<li>登录到Stormpath中（这个网站关了，合并到okta）。</li>
<li>页面的右边，访问API KEY：Manage API KEY</li>
<li><p>在账号详情页面，点击Create API Key。此时会生成你的API key，然后下载到你的电脑。如果你打开看看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">apiKey.id = 144JVZINOF5EBNCMG9EXAMPLE</div><div class="line">apiKey.secret = lWxOiKqKPNwJmSldbiSkEbkNjgh2uRSNAb+AEXAMPLE</div></pre></td></tr></table></figure>
</li>
<li><p>保存到一个安全的地方，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$HOME/.stormpath/apiKey.properties</div></pre></td></tr></table></figure>
</li>
<li><p>当然也可以改一下这个文件的权限。例如在*nix下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ chmod go-rwx <span class="variable">$HOME</span>/.stormpath/apiKey.properties</div><div class="line">$ chmod u-w <span class="variable">$HOME</span>/.stormpath/apiKey.properties</div></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="Retrieve-the-default-Stormpath-Application"><a href="#Retrieve-the-default-Stormpath-Application" class="headerlink" title="Retrieve the default Stormpath Application"></a>Retrieve the default Stormpath Application</h5><p>当你登录到Stormpath，自动的创建了一个空的应用，名字叫做：<code>My Application</code></p>
<p>我们必须使用Strompath注册我们的web应用，这样就能使用Strompath来管理我们的用户和对用户授权。为了使用我的应用程序Stormpath应用程序注册我们的Web应用程序，我们需要了解一些信息。幸运的是，我们可以使用Stormpath API来检索这些信息。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -i --user <span class="variable">$YOUR_API_KEY_ID</span>:<span class="variable">$YOUR_API_KEY_SECRET</span> \</div><div class="line"><span class="string">'https://api.stormpath.com/v1/tenants/current'</span></div></pre></td></tr></table></figure></p>
<p>你能得到这些返回信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">HTTP/1.1 302 Found</div><div class="line">Date: Fri, 28 Aug 2015 18:34:51 GMT</div><div class="line">Location: https://api.stormpath.com/v1/tenants/sOmELoNgRaNDoMIdHeRe</div><div class="line">Server: Apache</div><div class="line">Set-Cookie: rememberMe=deleteMe; Path=/; Max-Age=0; Expires=Thu, 27-Aug-2015 18:34:52 GMT</div><div class="line">Strict-Transport-Security: max-age=31536000; includeSubDomains; preload</div><div class="line">Content-Length: 0</div><div class="line">Connection: keep-alive</div></pre></td></tr></table></figure></p>
<p>注意到<code>Location</code>，这个就是你的Stormpath tenant.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl -u <span class="variable">$API_KEY_ID</span>:<span class="variable">$API_KEY_SECRET</span> \</div><div class="line">     -H <span class="string">"Accept: application/json"</span> \</div><div class="line">     <span class="string">'$TENANT_HREF/applications?name=My%20Application'</span></div></pre></td></tr></table></figure></p>
<p>这个回应有很多的信息。 这是一个从响应中摘录的例子.<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    ...</div><div class="line">    "href": "https://api.stormpath.com/v1/applications/aLoNGrAnDoMAppIdHeRe",</div><div class="line">    "name": "My Application",</div><div class="line">    "description": "This application was automatically created for you in Stormpath for use with our Quickstart guides(https://docs.stormpath.com). It does apply to your subscription's number of reserved applications and can be renamed or reused for your own purposes.",</div><div class="line">    "status": "ENABLED",</div><div class="line">    "tenant": &#123;</div><div class="line">        "href": "https://api.stormpath.com/v1/tenants/sOmELoNgRaNDoMIdHeRe"</div><div class="line">    &#125;,</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>从上面注意你的最上面的<code>href</code>，接下来我们将在shiro.ini配置中使用这个<code>href</code>。</p>
<h5 id="Create-an-application-test-user-account"><a href="#Create-an-application-test-user-account" class="headerlink" title="Create an application test user account"></a>Create an application test user account</h5><p>现在我们有一个应用程序，我们将要为该应用程序创建一个示例/测试用户：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">curl --request POST --user <span class="variable">$YOUR_API_KEY_ID</span>:<span class="variable">$YOUR_API_KEY_SECRET</span> \</div><div class="line">    -H <span class="string">"Accept: application/json"</span> \</div><div class="line">    -H <span class="string">"Content-Type: application/json"</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'&#123;</span></div><div class="line">           "givenName": "Jean-Luc",</div><div class="line">           "surname": "Picard",</div><div class="line">           "username": "jlpicard",</div><div class="line">           "email": "capt@enterprise.com",</div><div class="line">           "password":"Changeme1"</div><div class="line">        &#125;' \</div><div class="line"> <span class="string">"<span class="variable">$YOUR_APPLICATION_HREF</span>/accounts"</span></div></pre></td></tr></table></figure></p>
<h4 id="Configure-the-Realm-in-shiro-ini"><a href="#Configure-the-Realm-in-shiro-ini" class="headerlink" title="Configure the Realm in shiro.ini"></a>Configure the Realm in shiro.ini</h4><p>按照Shiro的要求，你选择至少一个用户存储的连接，我们将需要配置一个表示该数据存储的域，然后告诉Shiro SecurityManager。</p>
<p>如果你检出step2的分支，你会看到<code>src/main/webapp/WEB-INF/shiro.ini</code>中的[main]部分：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># Configure a Realm to connect to a user datastore.  In this simple tutorial, we&apos;ll just point to Stormpath since it</div><div class="line"># takes 5 minutes to set up:</div><div class="line">stormpathClient = com.stormpath.shiro.client.ClientFactory</div><div class="line">stormpathClient.cacheManager = $cacheManager</div><div class="line"></div><div class="line"># (Optional) If you put your apiKey.properties in the non-default location, you set the location here</div><div class="line">#stormpathClient.apiKeyFileLocation = $HOME/.stormpath/apiKey.properties</div><div class="line"></div><div class="line">stormpathRealm = com.stormpath.shiro.realm.ApplicationRealm</div><div class="line">stormpathRealm.client = $stormpathClient</div><div class="line"></div><div class="line"># Find this URL in your Stormpath console for an application you create:</div><div class="line"># Applications -&gt; (choose application name) --&gt; Details --&gt; REST URL</div><div class="line"># (Optional) If you only have one Application</div><div class="line">#stormpathRealm.applicationRestUrl = https://api.stormpath.com/v1/applications/$STORMPATH_APPLICATION_ID</div><div class="line"></div><div class="line">stormpathRealm.groupRoleResolver.modeNames = name</div><div class="line">securityManager.realm = $stormpathRealm</div></pre></td></tr></table></figure></p>
<p>注意看可选的那行：</p>
<ul>
<li>如果你已经使用Stormpath一段时间，并且你有更多的Stormpath应用程序，<code>stormpathRealm.applicationRestUrl</code>这个属性必须被设置。</li>
</ul>
<h4 id="Run-the-webapp"><a href="#Run-the-webapp" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>在完成上面的改动后，使用下面的命令来跑一下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mvn jetty:run</div></pre></td></tr></table></figure></p>
<p>这时候就会看到熟悉的输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">16:08:25.466 [main] INFO  o.a.shiro.web.env.EnvironmentLoader - Starting Shiro environment initialization.</div><div class="line">16:08:26.201 [main] INFO  o.a.s.c.IniSecurityManagerFactory - Realms have been explicitly set on the SecurityManager instance - auto-setting of realms will not occur.</div><div class="line">16:08:26.201 [main] INFO  o.a.shiro.web.env.EnvironmentLoader - Shiro environment initialized in 731 ms.</div></pre></td></tr></table></figure></p>
<h3 id="Step-3-Enable-Login-and-Logout"><a href="#Step-3-Enable-Login-and-Logout" class="headerlink" title="Step 3: Enable Login and Logout"></a>Step 3: Enable Login and Logout</h3><p>现在我们有用户，而且我们能很容易的添加，移除和禁用他们。现在我们可以在我们的应用程序中开始启用登录/注销和访问控制等功能。</p>
<p>检出step3的分支：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step3</div></pre></td></tr></table></figure></p>
<p>添加了2个东西:</p>
<ul>
<li><code>src/main/webapp/login.jsp</code>中加了一个简单的登录表单，我们使用它登录。</li>
<li><code>shiro.ini</code>文件已更新，以支持Web（URL）特定功能。</li>
</ul>
<h4 id="Enable-Shiro-form-login-and-logout-support"><a href="#Enable-Shiro-form-login-and-logout-support" class="headerlink" title="Enable Shiro form login and logout support"></a>Enable Shiro form login and logout support</h4><p>step3中<code>src/main/webapp/WEB-INF/shiro.ini</code>添加了下面2个东西：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[main]</div><div class="line"></div><div class="line">shiro.loginUrl = /login.jsp</div><div class="line"></div><div class="line"># Stuff we&apos;ve configured here previously is omitted for brevity</div><div class="line"></div><div class="line">[urls]</div><div class="line">/login.jsp = authc</div><div class="line">/logout = logout</div></pre></td></tr></table></figure></p>
<p>在[main]这个部分多了一行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shiro.loginUrl = /login.jsp</div></pre></td></tr></table></figure></p>
<p>这是一个告诉Shiro的特殊配置指令:”对于任何具有loginUrl属性的Shiro的默认过滤器，我希望该属性值设置为/login.jsp。”</p>
<p>这个就是让Shiro的默认认证过滤器（默认的是FormAuthenticationFilter）知道登录页面是哪个。这个让FormAuthenticationFilter正确的工作是很有必要的。</p>
<p>[urls]部分允许你使用非常简洁的键值对语法来告诉Shiro怎么样去过滤给定的url请求。urls中的所有路径都是相对于Web应用程序的HttpServletRequest.getContextPath()的值.</p>
<p>这些键值对提供一个极其强大的方式来过滤请求，允许各种各样的安全规则。URL和过滤器链的更深入的覆盖范围超出了本文档的范围，但如果你有兴趣，请详细阅读。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/login.jsp = authc</div><div class="line">/logout = logout</div></pre></td></tr></table></figure>
<ul>
<li>第一行指出不论Shiro什么时候遇到请求<code>/login.jsp</code>的url，在请求中开启authc过滤器。</li>
<li>第二行表示不论Shiro遇到<code>/login.jsp</code>的url，在请求中开启logout 过滤器。</li>
</ul>
<p>这两个过滤器都有一点特殊的地方，他们都不需要在背后进行额外的处理。它们实际上只是完全处理请求，而不是过滤。这意味着你对这些URL的请求没有任何要求，不需要写任何controller。Shiro将根据需要处理这些请求。</p>
<h4 id="Add-a-login-page"><a href="#Add-a-login-page" class="headerlink" title="Add a login page"></a>Add a login page</h4><p>在上个步骤中我们开启了对登录和登出的支持。现在我们需要保证有一个<code>/login.jsp</code>页面来显示登录表单。</p>
<p>step3的分支中包含<code>src/main/webapp/login.jsp</code>页面。这是一个简单的bootstrap主题的登录页面，但是依旧有四点需要注意：</p>
<ul>
<li>这个表单的<code>action</code>值是空的字符串。当表单中没有<code>action</code>值，浏览器将提交请求到同一个URL。这很好，因为我们会告诉Shiro那个URL很短，所以Shiro可以自动处理任何登录提交。<code>/login.jsp = authc</code>这行是告诉authc过滤器处理这个提交。</li>
<li>有一个<code>username</code>字段，Shiro authc过滤器将在登录提交期间自动查找用户名请求参数，并将其用作登录期间的值（许多域允许此为电子邮件或用户名）。</li>
<li>有一个<code>password</code>字段，Shiro authc过滤器将在登录提交期间自动查找密码请求参数。</li>
<li>有一个rememberMe复选框，其“checked”状态可以是“true”值（true，t，1，enabled，y，yes或on）。</li>
</ul>
<p>我们的login.jsp表单只使用默认的用户名，密码和rememberMe表单字段名称。 如果您想更改这些名称，这些名称是可配置的。参见<a href="http://shiro.apache.org/static/1.3.2/apidocs/org/apache/shiro/web/filter/authc/FormAuthenticationFilter.html" target="_blank" rel="external">FormAuthenticationFilter</a>.</p>
<h4 id="Run-the-webapp-1"><a href="#Run-the-webapp-1" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>再跑一次：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ mvn jetty:run</div></pre></td></tr></table></figure></p>
<h4 id="Try-to-Login"><a href="#Try-to-Login" class="headerlink" title="Try to Login"></a>Try to Login</h4><p>使用您的Web浏览器，导航到localhost：8080 / login.jsp，您将看到我们新的登录表单。</p>
<p>输入你在步骤2结束时创建的帐户的用户名和密码，然后点击“登录”。 如果登录成功，你将被引导到主页！ 如果登录失败，你将再次显示登录页面。</p>
<p>提示：如果你希望成功登录将用户重定向到主页（上下文路径/）以外的其他页面，则可以在INI的main部分中设置authc.successUrl = / any。</p>
<h3 id="Step-4-User-specific-UI-changes"><a href="#Step-4-User-specific-UI-changes" class="headerlink" title="Step 4: User-specific UI changes"></a>Step 4: User-specific UI changes</h3><p>通常需要根据用户是谁来更改web用户界面。我们可以很容易地做到这一点，因为Shiro支持JSP标签库根据当前登录的Subject（用户）进行操作。</p>
<p>检出step4的分支：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step4</div></pre></td></tr></table></figure></p>
<p>在<code>home.jsp</code>页面中新增了：</p>
<ul>
<li>当浏览该页面的当前用户未登录时，他们将看到一个“欢迎访客”消息，并查看登录页面的链接。</li>
<li>当浏览该页面的当前用户登录后，他们将看到自己的名字“欢迎xxx”和一个链接以注销。</li>
</ul>
<p>这种类型的UI定制对于导航栏是非常常见的，用户控件位于屏幕的右上方。</p>
<h4 id="Add-the-Shiro-Tag-Library-Declaration"><a href="#Add-the-Shiro-Tag-Library-Declaration" class="headerlink" title="Add the Shiro Tag Library Declaration"></a>Add the Shiro Tag Library Declaration</h4><p>在<code>home.jsp</code>顶部包含了这两行：<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">taglib</span> <span class="attr">prefix</span>=<span class="string">"shiro"</span> <span class="attr">uri</span>=<span class="string">"http://shiro.apache.org/tags"</span> %&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">%@</span> <span class="attr">taglib</span> <span class="attr">prefix</span>=<span class="string">"c"</span> <span class="attr">uri</span>=<span class="string">"http://java.sun.com/jsp/jstl/core"</span> %&gt;</span></div></pre></td></tr></table></figure></p>
<p>这两个JSP页面指令允许页面中的Core（c )和Shiro（shiro )标签库。</p>
<h4 id="Add-Shiro-Guest-and-User-tags"><a href="#Add-Shiro-Guest-and-User-tags" class="headerlink" title="Add Shiro Guest and User tags"></a>Add Shiro Guest and User tags</h4><p><code>home.jsp</code>文件进一步修改了body里的内容，以包含<shiro：guest>和<shiro：user>标签。<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Hi <span class="tag">&lt;<span class="name">shiro:guest</span>&gt;</span>Guest<span class="tag">&lt;/<span class="name">shiro:guest</span>&gt;</span><span class="tag">&lt;<span class="name">shiro:user</span>&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">%</span></span></div><div class="line">    //<span class="attr">This</span> <span class="attr">should</span> <span class="attr">never</span> <span class="attr">be</span> <span class="attr">done</span> <span class="attr">in</span> <span class="attr">a</span> <span class="attr">normal</span> <span class="attr">page</span> <span class="attr">and</span> <span class="attr">should</span> <span class="attr">exist</span> <span class="attr">in</span> <span class="attr">a</span> <span class="attr">proper</span> <span class="attr">MVC</span> <span class="attr">controller</span> <span class="attr">of</span> <span class="attr">some</span> <span class="attr">sort</span>, <span class="attr">but</span> <span class="attr">for</span> <span class="attr">this</span></div><div class="line">    //<span class="attr">tutorial</span>, <span class="attr">we</span>'<span class="attr">ll</span> <span class="attr">just</span> <span class="attr">pull</span> <span class="attr">out</span> <span class="attr">Stormpath</span> <span class="attr">Account</span> <span class="attr">data</span> <span class="attr">from</span> <span class="attr">Shiro</span>'<span class="attr">s</span> <span class="attr">PrincipalCollection</span> <span class="attr">to</span> <span class="attr">reference</span> <span class="attr">in</span> <span class="attr">the</span></div><div class="line">    //&lt;<span class="attr">c:out</span>/&gt; tag next:</div><div class="line"></div><div class="line">    request.setAttribute("account", org.apache.shiro.SecurityUtils.getSubject().getPrincipals().oneByType(java.util.Map.class));</div><div class="line"></div><div class="line">%&gt;</div><div class="line"><span class="tag">&lt;<span class="name">c:out</span> <span class="attr">value</span>=<span class="string">"$&#123;account.givenName&#125;"</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:user</span>&gt;</span>!</div><div class="line">    ( <span class="tag">&lt;<span class="name">shiro:user</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;c:url value="</span>/<span class="attr">logout</span>"/&gt;</span>"&gt;Log out<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">shiro:user</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:guest</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;c:url value="</span>/<span class="attr">login.jsp</span>"/&gt;</span>"&gt;Log in<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">shiro:guest</span>&gt;</span> )</div><div class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div></pre></td></tr></table></figure></shiro：user></shiro：guest></p>
<p>给定的格式有点难以阅读，但是在这里使用了两个标签：</p>
<ul>
<li><code>&lt;shiro:guest&gt;</code>这个标签仅仅显示它内部的内容，假如当前的subject是一个访客的话。Shiro将guest定义为未登录到应用程序的任何Subject，或者在之前登录没有被记住的用户。</li>
<li><code>&lt;shiro:user&gt;</code>Shiro将用户定义为当前登录到（认证）应用程序或从先前登录记录的主题的任何主题。</li>
</ul>
<p>如果subject是访客，上述代码段将呈现以下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Hi Guest! (Log in)</div></pre></td></tr></table></figure></p>
<p>如果subject是“用户”，它将呈现以下内容:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Hi jsmith! (Log out)</div></pre></td></tr></table></figure></p>
<p>你可以看到，您可以关闭整个页面部分，功能和UI组件。<br>除了这两个标签，Shiro还提供其他标签供你来定制你自己的UI。</p>
<h4 id="Run-the-webapp-2"><a href="#Run-the-webapp-2" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>跑吧！</p>
<h3 id="Step-5-Allow-Access-to-Only-Authenticated-Users"><a href="#Step-5-Allow-Access-to-Only-Authenticated-Users" class="headerlink" title="Step 5: Allow Access to Only Authenticated Users"></a>Step 5: Allow Access to Only Authenticated Users</h3><p>虽然你可以根据subject的状态来改变内容，但是通常情况下，你将要限制webapp的整个部分，这取决于有人在当前与Web应用程序的互动过程中是否已证明其身份（已验证）。</p>
<p>如果webapp的用户专区部分显示敏感信息（如帐单明细或控制其他用户的能力），这一点尤为重要。</p>
<p>检出step5：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step5</div></pre></td></tr></table></figure></p>
<p>Step 5有3个更新：</p>
<ul>
<li>添加了一个新的部分（url path），我们要限制只有经过身份验证的用户。</li>
<li>我们更改了shiro.ini，以告诉Shiro只允许经过身份验证的用户访问该Web应用程序的该部分。</li>
<li>我们修改了主页，根据当前的主题是否被认证来更改其输出。</li>
</ul>
<h4 id="Add-a-new-restricted-section"><a href="#Add-a-new-restricted-section" class="headerlink" title="Add a new restricted section"></a>Add a new restricted section</h4><p><code>src/main/webapp/account</code>目录被添加进来了。此目录（及其下方的所有路径）会模拟网站的“私有”或“仅验证”部分，你可能希望将其限制为只能登录用户。<code>src/main/webapp/account/index.jsp</code>文件只是模拟“主页”页面的占位符。</p>
<h4 id="Configure-shiro-ini"><a href="#Configure-shiro-ini" class="headerlink" title="Configure shiro.ini"></a>Configure shiro.ini</h4><p>在<code>shiro.ini</code>的<code>[urls]</code>这个章节的结尾，添加了下面的一行:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/account/** = authc</div></pre></td></tr></table></figure></p>
<p>这个Shiro过滤器链定义意味着“对/ account（或其任何子路径）的任何请求必须被认证”。<br>但是，如果有人尝试访问该路径或其任何子路径，会发生什么？<br>你还记得在步骤3中,当我们将以下行添加到main部分吗？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">shiro.loginUrl = /login.jsp</div></pre></td></tr></table></figure></p>
<p>这一行自动使用我们的webapp登录URL配置authc过滤器。<br>基于这一行配置，authc过滤器现在足够聪明，可以知道当访问/帐户当前主题未被验证时，它将自动将主题重定向到/login.jsp页面。成功登录后，它将自动将用户重定向到他们试图访问的页面（/帐户）。 很方便！</p>
<h4 id="Update-our-home-page"><a href="#Update-our-home-page" class="headerlink" title="Update our home page"></a>Update our home page</h4><p>步骤5的最终更改是更新/home.jsp页面，让用户知道他们可以访问网站的新部分。这些行被添加到欢迎消息下:<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">shiro:authenticated</span>&gt;</span><span class="tag">&lt;<span class="name">p</span>&gt;</span>Visit your <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;c:url value="</span>/<span class="attr">account</span>"/&gt;</span>"&gt;account page<span class="tag">&lt;/<span class="name">a</span>&gt;</span>.<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">shiro:authenticated</span>&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">shiro:notAuthenticated</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span>If you want to access the authenticated-only <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&lt;c:url value="</span>/<span class="attr">account</span>"/&gt;</span>"&gt;account page<span class="tag">&lt;/<span class="name">a</span>&gt;</span>, you will need to log-in first.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">shiro:notAuthenticated</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>如果当前的Subject在当前会话期间已经登录（认证），则<shiro：authenticated>标签内的内容被显示。这是Subject知道他们可以去访问网站的新部分。<br>如果当前Subject在当前会话期间尚未验证，则<shiro：notauthenticated>标签内的内容被显示。<br>但是你注意到了吗，未经身份验证的内容仍然具有/ account部分的URL？没关系 - 我们的authc过滤器将如上所述处理login-and-then-redirect流程。<br>用新的更改启动webapp并尝试一下！</shiro：notauthenticated></shiro：authenticated></p>
<h4 id="Run-the-webapp-3"><a href="#Run-the-webapp-3" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>跑一下吧。</p>
<h3 id="Step-6-Role-Based-Access-Control"><a href="#Step-6-Role-Based-Access-Control" class="headerlink" title="Step 6: Role-Based Access Control"></a>Step 6: Role-Based Access Control</h3><p>除了基于身份验证控制访问之外，还经常需要根据分配给当前主体的角色来限制对应用程序某些部分的访问。<br>检出代码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout step6</div></pre></td></tr></table></figure></p>
<h4 id="Add-Roles"><a href="#Add-Roles" class="headerlink" title="Add Roles"></a>Add Roles</h4><p>为了执行基于角色的访问控制，我们需要有角色。<br>在本教程中最快的方法是在Stormpath中添加一些组。要做到这一点，登录到UI并导航如下：<br><strong>Directories &gt; My Application Directory &gt; Groups</strong><br>添加下面三个组：</p>
<ul>
<li>Captains</li>
<li>Officers</li>
<li>Enlisted</li>
</ul>
<p>创建组后，将Jean-Luc Picard帐户添加到Captains和Officers组。您可能需要创建一些临时帐户，并将它们添加到您喜欢的任何组；确保某些帐户不重叠组，因此你可以基于分配给用户帐户的单独组查看变更。</p>
<h4 id="Role-Based-Access-Control-RBAC-Tags"><a href="#Role-Based-Access-Control-RBAC-Tags" class="headerlink" title="Role Based Access Control (RBAC) Tags"></a>Role Based Access Control (RBAC) Tags</h4><p>我们更新/home.jsp页面，让用户知道他们有什么角色，哪些角色没有。这些消息将添加到主页的新的<code>&lt;h2&gt;</code>角色<code>&lt;/ h2&gt;</code>部分:<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Roles<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Here are the roles you have and don't have. Log out and log back in under different user</div><div class="line">    accounts to see different roles.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line">    </div><div class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>Roles you have:<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:hasRole</span> <span class="attr">name</span>=<span class="string">"Captains"</span>&gt;</span>Captains<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:hasRole</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:hasRole</span> <span class="attr">name</span>=<span class="string">"Officers"</span>&gt;</span>Bad Guys<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:hasRole</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:hasRole</span> <span class="attr">name</span>=<span class="string">"Enlisted"</span>&gt;</span>Enlisted<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:hasRole</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>Roles you DON'T have:<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:lacksRole</span> <span class="attr">name</span>=<span class="string">"Captains"</span>&gt;</span>Captains<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:lacksRole</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:lacksRole</span> <span class="attr">name</span>=<span class="string">"Officers"</span>&gt;</span>Officers<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:lacksRole</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">shiro:lacksRole</span> <span class="attr">name</span>=<span class="string">"Enlisted"</span>&gt;</span>Enlisted<span class="tag">&lt;<span class="name">br</span>/&gt;</span><span class="tag">&lt;/<span class="name">shiro:lacksRole</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>如果当前主体被分配了指定的角色，<shiro：hasrole>标签将显示其中的内容。<shiro：lacksrole>标签只会在当前主体未分配指定角色时显示其中的内容。</shiro：lacksrole></shiro：hasrole></p>
<h4 id="RBAC-filter-chains"><a href="#RBAC-filter-chains" class="headerlink" title="RBAC filter chains"></a>RBAC filter chains</h4><p>向读者留下的一个练习（不是一个定义的步骤）是根据分配给当前用户的角色，创建网站的一个新的部分，并限制URL访问该网站的该部分。<br>提示：使用 <code>filter chain definition</code>为webapp的新部分创建过滤器链定义。</p>
<h4 id="Run-the-webapp-4"><a href="#Run-the-webapp-4" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>run一下咯</p>
<h3 id="Step-7-Permission-Based-Access-Control"><a href="#Step-7-Permission-Based-Access-Control" class="headerlink" title="Step 7: Permission-Based Access Control"></a>Step 7: Permission-Based Access Control</h3><p>基于角色的访问控制对于许多情况是行得通的，但是它存在一个主要问题：你不能在运行时添加或删除角色。角色检查使用角色名称进行硬编码，所以如果你改变了角色名称或角色配置，或添加或删除角色，你必须回去更改代码！<br>因此，Shiro具有强大的功能：内置的权限支持。<br>在Shiro，权限是一个原始的功能说明，例如“打开门”，创建博客条目“，”删除jsmith用户“等。权限反映了您的应用程序的原始功能，所以在更改应用程序的功能时，您只需要更改权限检查，而不是要更改角色或用户模型。<br>为了演示这一点，我们将创建一些权限并将其分配给用户，然后根据用户的授权（权限）自定义我们的Web UI。</p>
<h4 id="Add-Permissions"><a href="#Add-Permissions" class="headerlink" title="Add Permissions"></a>Add Permissions</h4><p>Shiro的Realm是只读组件:每个数据存储模型的角色，组，权限，帐户和他们的关系不同,所以Shiro没有一个’write’API来修改这些资源。要修改模型对象的底层，你只需通过任何您想要的API直接修改它们。你的Shiro的Realm然后知道如何阅读这些信息，并以Shiro理解的格式表示它。<br>因此，由于我们在此示例应用程序中使用Stormpath，因此我们将以特定于Stormpath API的方式为帐户和组分配权限。<br>让我们执行一个cURL请求，为以前创建的Jean-Luc Picard帐户添加一些权限。 使用该帐户的href URL，我们将通过自定义数据将一些apacheShiroPermissions发布到该帐户：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">curl -X POST --user <span class="variable">$YOUR_API_KEY_ID</span>:<span class="variable">$YOUR_API_KEY_SECRET</span> \</div><div class="line">    -H <span class="string">"Accept: application/json"</span> \</div><div class="line">    -H <span class="string">"Content-Type: application/json"</span> \</div><div class="line">    <span class="_">-d</span> <span class="string">'&#123;</span></div><div class="line">            "apacheShiroPermissions": [</div><div class="line">                "ship:NCC-1701-D:command",</div><div class="line">                "user:jlpicard:edit"</div><div class="line">            ]</div><div class="line">        &#125;' \</div><div class="line"><span class="string">"https://api.stormpath.com/v1/accounts/<span class="variable">$JLPICARD_ACCOUNT_ID</span>/customData"</span></div></pre></td></tr></table></figure></p>
<p>其中$ JLPICARD_ACCOUNT_ID与你在本教程开头创建的Jean-Luc Picard的插槽相匹配。<br>这将直接向Stormpath帐户添加两个权限：</p>
<ul>
<li>ship:NCC-1701-D:command</li>
<li>user:jlpicard:edit</li>
</ul>
<p>这些使用Shiro的WildcardPermission语法。<br>第一个基本上是指用“NCC-1701-D”标识符来“命令”’船’的能力。这是实例级权限的一个示例：控制对资源船的特定实例NCC-1701-D的访问。第二个也是一个实例级权限，指出使用标识符jlpicard编辑用户的能力。<br>如何在Stormpath中存储权限，以及如何在Stormpath中自定义存储和访问选项超出本文档的范围，但这是在Shiro Stormpath插件文档中解释的。</p>
<h4 id="Permission-Tags"><a href="#Permission-Tags" class="headerlink" title="Permission Tags"></a>Permission Tags</h4><p>就像我们有用于角色检查的JSP标签一样，还有同样用于权限检查的标签。我们更新/home.jsp页面，让用户知道是否允许你根据分配给他们的权限执行某些操作。这些消息将添加到主页的新的<code>&lt;h2&gt;</code>权限<code>&lt;/ h2&gt;</code>部分：<br><figure class="highlight htmlbars"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="xml"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Permissions<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>You may <span class="tag">&lt;<span class="name">shiro:lacksPermission</span> <span class="attr">name</span>=<span class="string">"ship:NCC-1701-D:command"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>NOT<span class="tag">&lt;/<span class="name">b</span>&gt;</span> <span class="tag">&lt;/<span class="name">shiro:lacksPermission</span>&gt;</span> command the <span class="tag">&lt;<span class="name">code</span>&gt;</span>NCC-1701-D<span class="tag">&lt;/<span class="name">code</span>&gt;</span> Starship!<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>You may <span class="tag">&lt;<span class="name">shiro:lacksPermission</span> <span class="attr">name</span>=<span class="string">"user:$&#123;account.username&#125;:edit"</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>NOT<span class="tag">&lt;/<span class="name">b</span>&gt;</span> <span class="tag">&lt;/<span class="name">shiro:lacksPermission</span>&gt;</span> edit the $&#123;account.username&#125; user!<span class="tag">&lt;/<span class="name">li</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>当你第一次访问主页时，在登录之前，你将看到以下输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">You may NOT command the NCC-1701-D Starship!</div><div class="line">You may NOT edit the user!</div></pre></td></tr></table></figure></p>
<p>但是，在你使用Jean-Luc Picard帐户登录后，你将看到这一点:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">You may command the NCC-1701-D Starship!</div><div class="line">You may edit the user!</div></pre></td></tr></table></figure></p>
<p>你可以看到Shiro解决了经过身份验证的用户具有权限，并以适当的方式呈现输出。<br>您还可以使用<shiro：haspermission>标签进行肯定权限检查。<br>最后，我们将注意到极其强大的权限检查功能。 你能看到第二个权限检查如何使用运行时生成的权限值吗？<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">shiro:lacksPermission</span> <span class="attr">name</span>=<span class="string">"user:$&#123;account.username&#125;:edit"</span>&gt;</span> ...</div></pre></td></tr></table></figure></shiro：haspermission></p>
<p><code>${account.username}</code>在运行的时候将<code>user:aUsername:edit</code>的值组装起来，最后这个最终的值被用来权限检查。<br>这种运行时的权限检查机制是用来构建高度定制化和安全的应用的常规技术。</p>
<h4 id="Run-the-webapp-5"><a href="#Run-the-webapp-5" class="headerlink" title="Run the webapp"></a>Run the webapp</h4><p>run一run咯</p>
<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><p>我们希望这篇指南能对你使用Shiro构建webapp有帮助。在下个版本我们将推出这些内容：</p>
<ul>
<li>不同用户数据的存储插件，像RDBMS或者NoSQL之类的。</li>
</ul>
<p>原文<a href="http://shiro.apache.org/webapp-tutorial.html" target="_blank" rel="external">Securing Web Applications with Apache Shiro</a></p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://www.mr-dongw.site/2017/10/26/Securing Web Applications with Apache Shiro[译]/" data-id="cjg94esnw0005ac4okardlkn4" class="article-share-link">分享</a><div class="tags"><a href="/tags/Apache-Shiro/">Apache Shiro</a><a href="/tags/翻译/">翻译</a></div><div class="post-nav"><a href="/2017/12/06/《How Tomcat Works》读书笔记/" class="pre">《How Tomcat Works》读书笔记</a><a href="/2017/09/25/Java Authorization Guide with Apache Shiro[译]/" class="next">Java Authorization Guide with Apache Shiro[译]</a></div><div id="uyan_frame"></div><script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=2137815"></script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://www.mr-dongw.site"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Apache/">Apache</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Apache-Open-Project/">Apache Open Project</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JDK-SOURCE/">JDK SOURCE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OPEN-SOURCE/">OPEN SOURCE</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Framework/">Spring Framework</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat-笔记/">Tomcat 笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/beyound-coding/">beyound coding</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/想法/">想法</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/翻译-整理/" style="font-size: 15px;">翻译&整理</a> <a href="/tags/Apache-Shiro/" style="font-size: 15px;">Apache Shiro</a> <a href="/tags/源码解读/" style="font-size: 15px;">源码解读</a> <a href="/tags/Apache/" style="font-size: 15px;">Apache</a> <a href="/tags/所想/" style="font-size: 15px;">所想</a> <a href="/tags/JDK/" style="font-size: 15px;">JDK</a> <a href="/tags/Spring-Boot/" style="font-size: 15px;">Spring Boot</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/XML/" style="font-size: 15px;">XML</a> <a href="/tags/字节码工具/" style="font-size: 15px;">字节码工具</a> <a href="/tags/Tomcat/" style="font-size: 15px;">Tomcat</a> <a href="/tags/读书笔记/" style="font-size: 15px;">读书笔记</a> <a href="/tags/生活，扯淡/" style="font-size: 15px;">生活，扯淡</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/04/21/Timer/">浅析JDK中的定时器Timer实现</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/31/my 2017/">写给2017</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/12/06/《How Tomcat Works》读书笔记/">《How Tomcat Works》读书笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/10/26/Securing Web Applications with Apache Shiro[译]/">Securing Web Applications with Apache Shiro[译]</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/25/Java Authorization Guide with Apache Shiro[译]/">Java Authorization Guide with Apache Shiro[译]</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/09/21/Application Security With Apache Shiro[译]/">Application Security With Apache Shiro[译]</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/10/spring-boot-fatures-2/">Spring Boot Features（Part Ⅱ）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/05/spring-boot-fatures/">Spring Boot Features（Part I）</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/16/动态代理番外篇/">动态代理番外篇</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/07/09/动态代理之JDK实现/">动态代理之JDK实现</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.wangtianyi.top" title="王屌" target="_blank">王屌</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">DongWei's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>